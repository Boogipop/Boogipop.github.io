<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>CVE-2025-24813 Tomcat Session 反序列化组合拳 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="CVE-2025-24813 Tomcat Session 反序列化组合拳 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2025/03/13/CVE-2025-24813%20Tomcat%20Session%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%84%E5%90%88%E6%8B%B3/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2025-03-13T10:35:34.127Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>March</span>
            <span>13,</span>
            <span>2025</span>
        </div>
        

        <h2 class="title">CVE-2025-24813 Tomcat Session 反序列化组合拳</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>看到一篇文章就来复现一下，补充一些细节利用点。<br><a target="_blank" rel="noopener" href="https://forum.butian.net/article/674">https://forum.butian.net/article/674</a></p>
<h1 id="回顾历史"><a href="#回顾历史" class="headerlink" title="回顾历史"></a>回顾历史</h1><ul>
<li>CVE-2017-12615 Tomcat PUT 文件上传</li>
<li>CVE-2020-9484：Tomcat Session 反序列化漏洞</li>
<li>CVE-2024-50379 ：Tomcat PUT 条件竞争文件上传</li>
</ul>
<p>这三个漏洞是 Tomcat 历史一些相对比较严重的 RCE 漏洞，也算前世今生了。</p>
<h1 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h1><p>IDEA 部署 Tomcat 在新版有一些改变，主要是 AddFrameWork 按钮没了。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/32634994/1741862025848-eecb7ddd-eac7-4c93-83a3-7086da97dd21.png"><br>你得全局搜才搜的出来，创建一下基本框架，然后新建 lib 目录加入项目依赖<br><img src="https://cdn.nlark.com/yuque/0/2025/png/32634994/1741862031162-3412b1a4-99a8-4095-8ad6-8b4f8baa2829.png"><br>随后修改一下 Tomcat 里的 conf&#x2F;Context.xml 文件。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="comment">&lt;!--  </span></span><br><span class="line"><span class="comment">  Licensed to the Apache Software Foundation (ASF) under one or more  contributor license agreements.  See the NOTICE file distributed with  this work for additional information regarding copyright ownership.  The ASF licenses this file to You under the Apache License, Version 2.0  (the &quot;License&quot;); you may not use this file except in compliance with  the License.  You may obtain a copy of the License at  </span></span><br><span class="line"><span class="comment">      http://www.apache.org/licenses/LICENSE-2.0  </span></span><br><span class="line"><span class="comment">  Unless required by applicable law or agreed to in writing, software  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the License for the specific language governing permissions and  limitations under the License.--&gt;</span>  </span><br><span class="line"><span class="comment">&lt;!-- The contents of this file will be loaded for each web application --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">Context</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">&lt;!-- Default set of monitored resources. If one of these changes, the    --&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!-- web application will be reloaded.                                   --&gt;</span>    <span class="tag">&lt;<span class="name">WatchedResource</span>&gt;</span>WEB-INF/web.xml<span class="tag">&lt;/<span class="name">WatchedResource</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">WatchedResource</span>&gt;</span>WEB-INF/tomcat-web.xml<span class="tag">&lt;/<span class="name">WatchedResource</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">WatchedResource</span>&gt;</span>$&#123;catalina.base&#125;/conf/web.xml<span class="tag">&lt;/<span class="name">WatchedResource</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">&lt;!-- Uncomment this to disable session persistence across Tomcat restarts --&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!--    &lt;Manager pathname=&quot;&quot; /&gt;    --&gt;</span>  <span class="tag">&lt;<span class="name">Manager</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.session.PersistentManager&quot;</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">Store</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.session.FileStore&quot;</span>/&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;/<span class="name">Manager</span>&gt;</span>  <span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>主要是加入如下内容</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Manager</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.session.PersistentManager&quot;</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">Store</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.session.FileStore&quot;</span>/&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;/<span class="name">Manager</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这一步是开启 Tomcat 的 Session 储存功能。</p>
<p>随后配置 Web.xml，加入默认的 DefaultServlet</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span>  </span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>  </span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span>  </span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span>        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>defalut<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.catalina.servlets.DefaultServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span>            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>debug<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>0<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span>        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span>            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>readonly<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span>        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span>    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>defalut<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="DefaultServlet"><a href="#DefaultServlet" class="headerlink" title="DefaultServlet"></a>DefaultServlet</h1><p><img src="https://cdn.nlark.com/yuque/0/2025/png/32634994/1741862040347-591e0d3b-ee0e-4292-a200-3cd0ec665d11.png"><br>自带的一个 Servelet 会处理一些默认类型的请求，如 PUT、POST、GET。</p>
<p>CVE-2017-12615、CVE-2024-50379均涉及该方法，也就是 doPUT，其实逻辑很简单，节选一段核心代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPut</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.readOnly) &#123;  </span><br><span class="line">        <span class="built_in">this</span>.sendNotAllowed(req, resp);  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="built_in">this</span>.getRelativePath(req);  </span><br><span class="line">        <span class="type">WebResource</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="built_in">this</span>.resources.getResource(path);  </span><br><span class="line">        <span class="type">Range</span> <span class="variable">range</span> <span class="operator">=</span> <span class="built_in">this</span>.parseContentRange(req, resp);  </span><br><span class="line">        <span class="keyword">if</span> (range != <span class="literal">null</span>) &#123;  </span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">resourceInputStream</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                <span class="keyword">if</span> (range == IGNORE) &#123;  </span><br><span class="line">                    resourceInputStream = req.getInputStream();  </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                    <span class="type">File</span> <span class="variable">contentFile</span> <span class="operator">=</span> <span class="built_in">this</span>.executePartialPut(req, range, path);  </span><br><span class="line">                    resourceInputStream = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(contentFile);  </span><br><span class="line">                &#125;  </span><br><span class="line">  </span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.resources.write(path, (InputStream)resourceInputStream, <span class="literal">true</span>)) &#123;  </span><br><span class="line">                    <span class="keyword">if</span> (resource.exists()) &#123;  </span><br><span class="line">                        resp.setStatus(<span class="number">204</span>);  </span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                        resp.setStatus(<span class="number">201</span>);  </span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                    resp.sendError(<span class="number">409</span>);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">                <span class="keyword">if</span> (resourceInputStream != <span class="literal">null</span>) &#123;  </span><br><span class="line">                    <span class="keyword">try</span> &#123;  </span><br><span class="line">                        ((InputStream)resourceInputStream).close();  </span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException var13) &#123;  </span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125;  </span><br><span class="line">  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>WebResource oldResource &#x3D; this.resources.getResource(path)</li>
</ul>
<p>这里直接获取 Web 根目录了，然后将文件上传，这也是最开始的 PUT 文件上传漏洞点。而今天的漏洞点出自上述的 else 分支。</p>
<ul>
<li>executePartialPut</li>
</ul>
<p>Tomcat 在处理不完整的 PUT 请求有单独的逻辑。这个和请求头 Content-Range 有关</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Range <span class="title function_">parseContentRange</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">contentRangeHeader</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Content-Range&quot;</span>);  </span><br><span class="line">    <span class="keyword">if</span> (contentRangeHeader == <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> IGNORE;  </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">this</span>.allowPartialPut) &#123;  </span><br><span class="line">        response.sendError(<span class="number">400</span>);  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="type">ContentRange</span> <span class="variable">contentRange</span> <span class="operator">=</span> ContentRange.parse(<span class="keyword">new</span> <span class="title class_">StringReader</span>(contentRangeHeader));  </span><br><span class="line">        <span class="keyword">if</span> (contentRange == <span class="literal">null</span>) &#123;  </span><br><span class="line">            response.sendError(<span class="number">400</span>);  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!contentRange.getUnits().equals(<span class="string">&quot;bytes&quot;</span>)) &#123;  </span><br><span class="line">            response.sendError(<span class="number">400</span>);  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="type">Range</span> <span class="variable">range</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Range</span>();  </span><br><span class="line">            range.start = contentRange.getStart();  </span><br><span class="line">            range.end = contentRange.getEnd();  </span><br><span class="line">            range.length = contentRange.getLength();  </span><br><span class="line">            <span class="keyword">if</span> (!range.validate()) &#123;  </span><br><span class="line">                response.sendError(<span class="number">400</span>);  </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="keyword">return</span> range;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Range">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Range</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/32634994/1741862050069-91add098-c673-47d8-b870-0d6a282e9d61.png"></p>
<p>其实你可以理解为和分块差不多一个意思。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUT</span> <span class="string">/CVE_2025_24813_war_exploded/a/session</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8080</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>1000</span><br><span class="line"><span class="attribute">Content-Range</span><span class="punctuation">: </span>bytes 0-1000/1200  </span><br><span class="line"></span><br><span class="line"><span class="language-ebnf"><span class="attribute">testtesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttest</span></span></span><br><span class="line"><span class="language-ebnf"></span></span><br></pre></td></tr></table></figure>

<p>简单利用该方法上传一个session 文件，内容随意。我们主要是看看细节</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/32634994/1741862060692-fa317cc3-341c-4a9a-ba4f-b78f20842748.png"></p>
<p>start、end、length和请求头对应，随后会进入 executePartialPut 内。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/32634994/1741862067676-4e6b15ac-3923-4f46-bf5f-534ad72e71a8.png"></p>
<p>在这里会将斜杠替换为<code>.</code>,因此我们可以上传一个 xxx.session 文件。具体处理逻辑在底部</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/32634994/1741862073834-c323aae2-0024-436e-b859-5aafc269d32f.png"></p>
<p>核心逻辑在这里，以 <code>range.length</code>作为文件的长度，<code>range.start</code>作为起始点开始处理流，这也是为什么 length 必须要大于 body 的总长度，不然无法将内容完全上传。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/32634994/1741862080312-f1854388-38a5-4afa-8b3a-b73362d768ed.png"></p>
<p>之后会返回 409 错误，但此时文件已经上传</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/32634994/1741862090932-37281b8a-39dd-40b9-8e0c-8f5f48062ba6.png"><br>我们需要注意一点</p>
<ul>
<li>File tempDir &#x3D; (File)this.getServletContext().getAttribute(“javax.servlet.context.tempdir”);</li>
</ul>
<p>linux 系统下的缓存文件夹是&#x2F;tmp，这里我是 macos，因此会在一些偏僻的位置，想要复现的同学可以自行输出一下。</p>
<p>至此完成了文件上传分析的部分。</p>
<h1 id="FileStore-load"><a href="#FileStore-load" class="headerlink" title="FileStore#load"></a>FileStore#load</h1><p>这部分是反序列化触发点，CVE-2020-9484出自这里，所以不难看出这其实是一个组合漏洞，当时CVE-2020-9484是因为存在目录穿越问题所以可以穿越加载一个自定义的序列化文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Session <span class="title function_">load</span><span class="params">(String id)</span> <span class="keyword">throws</span> ClassNotFoundException, IOException &#123;  </span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="built_in">this</span>.file(id);  </span><br><span class="line">    <span class="keyword">if</span> (file != <span class="literal">null</span> &amp;&amp; file.exists()) &#123;  </span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> <span class="built_in">this</span>.getManager().getContext();  </span><br><span class="line">        <span class="type">Log</span> <span class="variable">contextLog</span> <span class="operator">=</span> context.getLogger();  </span><br><span class="line">        <span class="keyword">if</span> (contextLog.isTraceEnabled()) &#123;  </span><br><span class="line">            contextLog.trace(sm.getString(<span class="built_in">this</span>.getStoreName() + <span class="string">&quot;.loading&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;id, file.getAbsolutePath()&#125;));  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">oldThreadContextCL</span> <span class="operator">=</span> context.bind(Globals.IS_SECURITY_ENABLED, (ClassLoader)<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        ObjectInputStream ois;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file.getAbsolutePath());  </span><br><span class="line">  </span><br><span class="line">            StandardSession var9;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                ois = <span class="built_in">this</span>.getObjectInputStream(fis);  </span><br><span class="line">  </span><br><span class="line">                <span class="keyword">try</span> &#123;  </span><br><span class="line">                    <span class="type">StandardSession</span> <span class="variable">session</span> <span class="operator">=</span> (StandardSession)<span class="built_in">this</span>.manager.createEmptySession();  </span><br><span class="line">                    session.readObjectData(ois);  </span><br><span class="line">                    session.setManager(<span class="built_in">this</span>.manager);  </span><br><span class="line">                    var9 = session;  </span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var19) &#123;  </span><br><span class="line">                    <span class="keyword">if</span> (ois != <span class="literal">null</span>) &#123;  </span><br><span class="line">                        <span class="keyword">try</span> &#123;  </span><br><span class="line">                            ois.close();  </span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable var18) &#123;  </span><br><span class="line">                            var19.addSuppressed(var18);  </span><br><span class="line">                        &#125;  </span><br><span class="line">                    &#125;  </span><br><span class="line">  </span><br><span class="line">                    <span class="keyword">throw</span> var19;  </span><br><span class="line">                &#125;  </span><br><span class="line">  </span><br><span class="line">                <span class="keyword">if</span> (ois != <span class="literal">null</span>) &#123;  </span><br><span class="line">                    ois.close();  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var20) &#123;  </span><br><span class="line">                <span class="keyword">try</span> &#123;  </span><br><span class="line">                    fis.close();  </span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var17) &#123;  </span><br><span class="line">                    var20.addSuppressed(var17);  </span><br><span class="line">                &#125;  </span><br><span class="line">  </span><br><span class="line">                <span class="keyword">throw</span> var20;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            fis.close();  </span><br><span class="line">            <span class="keyword">return</span> var9;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException var21) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (contextLog.isDebugEnabled()) &#123;  </span><br><span class="line">                contextLog.debug(sm.getString(<span class="string">&quot;fileStore.noFile&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;id, file.getAbsolutePath()&#125;));  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            ois = <span class="literal">null</span>;  </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">            context.unbind(Globals.IS_SECURITY_ENABLED, oldThreadContextCL);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> ois;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>this.file(id); 内容如下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> File <span class="title function_">file</span><span class="params">(String id)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">    <span class="type">File</span> <span class="variable">storageDir</span> <span class="operator">=</span> <span class="built_in">this</span>.directory();  </span><br><span class="line">    <span class="keyword">if</span> (storageDir == <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> id + <span class="string">&quot;.session&quot;</span>;  </span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(storageDir, filename);  </span><br><span class="line">        <span class="type">File</span> <span class="variable">canonicalFile</span> <span class="operator">=</span> file.getCanonicalFile();  </span><br><span class="line">        <span class="keyword">if</span> (!canonicalFile.toPath().startsWith(storageDir.getCanonicalFile().toPath())) &#123;  </span><br><span class="line">            log.warn(sm.getString(<span class="string">&quot;fileStore.invalid&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;file.getPath(), id&#125;));  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="keyword">return</span> canonicalFile;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修复方式就是getCanonicalFile处理穿越问题。因此无法目录穿越了，只能加载缓存目录下的<code>.session</code>后缀文件并且将其反序列化。反序列化的触发点是没删除的。</p>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>写了一个 POC</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/32634994/1741862114294-e3fb27af-fd3b-415a-831b-f97469cefcbb.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/32634994/1741862123318-a6876c14-b10e-4df9-8ec3-2fe17fae00bd.png"></p>
<p>成功复现。</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/Java/" class="tag">#Java</a><a href="/tags/CVE/" class="tag">#CVE</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        <a class="next"></a>
        
        <a href="/2025/01/01/2024%20%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">2024 年终总结</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>