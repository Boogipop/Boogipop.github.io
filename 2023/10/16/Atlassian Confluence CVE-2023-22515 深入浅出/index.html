<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>Atlassian Confluence CVE-2023-22515 深入浅出 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="Atlassian Confluence CVE-2023-22515 深入浅出 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/10/16/Atlassian%20Confluence%20CVE-2023-22515%20%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-10-16T14:55:12.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>October</span>
            <span>16,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">Atlassian Confluence CVE-2023-22515 深入浅出</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p>参考：<br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/rIfYrO1i4LPpgCGyxSLHUg?ref=www.ctfiot.com">对 Confluence CVE-2023-22515 的一点分析</a><br><a target="_blank" rel="noopener" href="https://su18.org/post/struts2-5/#0x07-%E6%94%BB%E9%98%B2%E5%8E%86%E5%8F%B2">Struts2 系列漏洞调试总结 | 素十八</a><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697164081277-61ed1dd0-20d3-4401-b0bf-38a3b349aeae.png#averageHue=%23f4f4f4&clientId=u368ad77e-9555-4&from=paste&id=u9942094f&originHeight=1507&originWidth=1545&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=278409&status=done&style=none&taskId=ub6b91c4b-431d-4da9-982c-67f9407c6e8&title=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697164123791-fe36b4c4-8d04-4768-b64e-8850b08b5217.png#averageHue=%23e9e9c2&clientId=u368ad77e-9555-4&from=paste&id=u14201c10&originHeight=1009&originWidth=1737&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=275604&status=done&style=none&taskId=u76630dec-8615-4973-8914-1f846aeaa73&title=" alt="image.png"><br>先贴一张su18师傅总结的文章图片，建议熟读以及背诵</p>
<h1 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h1><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/rIfYrO1i4LPpgCGyxSLHUg?ref=www.ctfiot.com">对 Confluence CVE-2023-22515 的一点分析</a><br> pen4uin师傅在微信公众号已经发过一篇浅析文章，而我当时也是差一点就自己复现成功了，但由于对Xworks2这个框架的特性不熟悉，所以卡在最后一步。<br>这个漏洞是一个类似于变量覆盖的漏洞，我们可以覆盖系统是否已经完成安装的标识符吗，这样就可以让他重新安装设置一次管理员了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697464006785-b7897fa1-29ae-4c22-98da-9a9d902e1be7.png#averageHue=%23f4f1f1&clientId=u70310f22-cdba-4&from=paste&id=u6fa9c206&originHeight=537&originWidth=1080&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=uadad346d-ba82-4b58-8b0a-f3673f46b8d&title="><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697464066770-8c96d14f-e540-4aa2-b5ca-7917d151b6db.png#averageHue=%23f7f6f6&clientId=u70310f22-cdba-4&from=paste&id=u3415c28c&originHeight=456&originWidth=1080&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=u9f60970f-93e1-40bf-bd7f-c576bbc4757&title="><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697464071115-62f141a4-da1f-438b-8cd2-2ca45520d25d.png#averageHue=%23bfe4be&clientId=u70310f22-cdba-4&from=paste&id=ucf8d05e2&originHeight=626&originWidth=1080&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=ub14782b7-52ad-4da4-aa4d-f4e6d6e6f7b&title="><br>图都是偷的，因为我懒。根据diff不难发现对setter和getter进行了修复，然后再根据前言中的流程图，在拜读完su18师傅的stucts2全解析文章后，我对这个框架又有了一些理解，其中<code>ParametersInterceptor</code>就是我们心心念念的漏洞点了。我们现在只需要找到可以触发这个监听器的路由即可。<br>根据企鹅师傅的文章我们知道了个思路，就是寻找有<code>defaultstack</code>和<code>opensearch</code>这两个stack配置的action，这样即可触发上述的监听器。</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><h2 id="思路分层"><a href="#思路分层" class="headerlink" title="思路分层"></a>思路分层</h2><p>Xworks2 对于 interceptor的处理比较有特性，当我们传入一个参数时，他会通过action及其父类的setter或者getter方法对该属性进行赋值。action有一个setMember方法，我们在url只需要传入一个<code>uri?member=1</code>就可以对member属性进行赋值。个人认为这还是比较危险的。万一存在JNDI注入之类的呢。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697464626124-f8bb1700-75ac-4b15-8f82-3294fed665b1.png#averageHue=%23647165&clientId=u25d32a57-3797-4&from=paste&height=59&id=u5fee1bb3&originHeight=74&originWidth=536&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=36639&status=done&style=none&taskId=ue76d7cf6-4cea-47eb-909d-4d331de8cc2&title=&width=428.8" alt="image.png"><br>在这个包下有stucts.xml文件，我们直接CTRL+F搜索即可了。<img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697464682117-88321183-edf3-4d8d-a805-b1278462afa9.png#averageHue=%23555960&clientId=u25d32a57-3797-4&from=paste&height=178&id=u95d55cea&originHeight=223&originWidth=1101&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=275729&status=done&style=none&taskId=u64251ced-0da7-4444-8da9-b264236364d&title=&width=880.8" alt="image.png"><br>有很多action，我这里就随便选了一个<code>NotPermittedAction</code>当做分析了，那我们来捋一下思路。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697465045726-929c9c83-ddee-41f6-9638-6edaf5fa6553.png#averageHue=%23f9f9f9&clientId=u25d32a57-3797-4&from=paste&id=uf77c066f&originHeight=224&originWidth=1080&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=u403f6bb1-0cd1-4ab4-b3c8-f690ae1afbd&title="><br>企鹅师傅的思路在响应title之后可以逆推分析，最终需要污染setupComplte属性<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697465103456-f38ad8ec-fa56-46f6-a173-616a1a77332f.png#averageHue=%234a5353&clientId=u25d32a57-3797-4&from=paste&height=538&id=u0d037a2c&originHeight=673&originWidth=1735&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=949195&status=done&style=none&taskId=u2133986c-e4cc-4008-8504-b0924737cb9&title=&width=1388" alt="image.png"><br><code>setupComplete</code>在<code>com.atlassian.config.ApplicationConfiguration</code>类的属性里。那我们现在需要做的就是怎么得到config类，回想一下补丁中还有个<code>BootstrapStatusProviderImpl</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697465968844-0a51f21d-3b00-4f0d-8af6-68f08c78e2f1.png#averageHue=%234e545e&clientId=u25d32a57-3797-4&from=paste&height=392&id=u294e657b&originHeight=490&originWidth=1602&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=744807&status=done&style=none&taskId=u84d79a64-d14d-4c6a-96ff-00cbab28ae9&title=&width=1281.6" alt="image.png"><br>他又刚好有个getter可以获取config，那么我们还需要找个类<code>BootstrapStatusProvider</code>。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697466159865-a3e9d9c7-bcf2-44a1-936e-2ae44e344946.png#averageHue=%23545861&clientId=u25d32a57-3797-4&from=paste&height=112&id=uf90576f0&originHeight=140&originWidth=1116&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=139135&status=done&style=none&taskId=ubdafce4d-70a2-4824-a156-fe24a9a975c&title=&width=892.8" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697466168249-21d08837-71ae-43ff-8bbb-66e2075c1f7c.png#averageHue=%23555962&clientId=u25d32a57-3797-4&from=paste&height=77&id=u96d91822&originHeight=96&originWidth=693&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=65201&status=done&style=none&taskId=u8349bc97-591a-404a-8f69-b5a9365ed33&title=&width=554.4" alt="image.png"><br>此处省略一万次继承，最后到了<code>ConfluenceActionSupport</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697466230276-decd5491-7b38-4326-b57c-b4366ef24caa.png#averageHue=%234f555d&clientId=u25d32a57-3797-4&from=paste&height=463&id=u1211d44b&originHeight=579&originWidth=1768&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=905202&status=done&style=none&taskId=u2935470f-a031-4431-8232-a7d44662dff&title=&width=1414.4" alt="image.png"><br>这不就又刚好获取到了<code>BootstrapStatusProvider</code>吗。所以我觉得这就是妙处所在，但是我一开始是不知道Xworks2有关setter和getter的特新的，所以让我们好好调试一番。</p>
<h2 id="Xworks2特性分析"><a href="#Xworks2特性分析" class="headerlink" title="Xworks2特性分析"></a>Xworks2特性分析</h2><p>首先给出我们的payload<br><code>[http://localhost:8090/notpermitted.action?bootstrapStatusProvider.applicationConfig.setupComplete=false](http://localhost:8090/notpermitted.action?bootstrapStatusProvider.applicationConfig.setupComplete=false)</code><br>然后我们直接debug给在SafeParametersInterceptor的doIntercept方法上。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697466364982-f86ac44c-1315-4443-a6ea-4c8985ef8847.png#averageHue=%23545960&clientId=u25d32a57-3797-4&from=paste&height=154&id=ud294e5bb&originHeight=192&originWidth=913&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=201188&status=done&style=none&taskId=u3eb5488e-eb1e-4163-98eb-6ab5e6ef2fc&title=&width=730.4" alt="image.png"><br>然后访问payload开始操作。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697466702680-fea02d79-0122-4b17-9fdd-89084b67df8c.png#averageHue=%23636774&clientId=u25d32a57-3797-4&from=paste&height=122&id=ud402ac09&originHeight=153&originWidth=1249&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=209275&status=done&style=none&taskId=ue4e340a9-7690-4484-ac7c-d21f5b0c4cf&title=&width=999.2" alt="image.png"><br>进入方法内部<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697466724903-6227bdb5-2aff-4e9f-b0bb-a7ab8b1fd321.png#averageHue=%23474b52&clientId=u25d32a57-3797-4&from=paste&height=814&id=u22eb1cb2&originHeight=1018&originWidth=1913&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1594484&status=done&style=none&taskId=u4410ef11-5a33-4ee9-9e54-2d8c522f4f4&title=&width=1530.4" alt="image.png"><br>首先获取了当前路由所处的action，然后初始化stack，进入setParameters方法内部<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697466845558-2ea8046a-6ccc-4b39-b46a-0109898d2059.png#averageHue=%23595e68&clientId=u25d32a57-3797-4&from=paste&height=362&id=u90011292&originHeight=453&originWidth=1514&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=599400&status=done&style=none&taskId=u4207ac3a-e289-41c8-baef-824f2897d3f&title=&width=1211.2" alt="image.png"><br>首先会进行一个黑名单检测，这个<code>isAcceptableParameter</code>方法主要的功能是检测传入的参数的键的长度是否长于100，是否含有黑名单字符。我们这里只是单纯的变量污染所以很单纯不会被检测到。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697466913120-006f4a05-7138-46dc-b3f0-8dcac30f705e.png#averageHue=%23454a52&clientId=u25d32a57-3797-4&from=paste&height=720&id=u5e61cc27&originHeight=900&originWidth=1601&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1216955&status=done&style=none&taskId=u2a65db09-bd16-4b9e-bfe2-4bbb327d2d2&title=&width=1280.8" alt="image.png"><br>然后就进入newstack的setparam方法去了，这个newstack实际上就是一个Ognl对象。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697466968877-8f8ba0bd-abb1-454d-b2d8-112f803c454c.png#averageHue=%234a5057&clientId=u25d32a57-3797-4&from=paste&height=970&id=ub6f20b3e&originHeight=1212&originWidth=1876&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2148887&status=done&style=none&taskId=ue63ba49c-92a8-4d2a-9c1b-8d3b3b2e87e&title=&width=1500.8" alt="image.png"><br>OgnlValueStack.setValue<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697466980934-40c1431d-e370-41ad-81f9-53ac333d3280.png#averageHue=%235c606b&clientId=u25d32a57-3797-4&from=paste&height=232&id=u07c3e541&originHeight=290&originWidth=1195&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=385082&status=done&style=none&taskId=u336ee175-ef22-4d32-8e03-b46c08ad92a&title=&width=956" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697466990224-405fc312-a84d-4586-a22e-045e8d22ad66.png#averageHue=%23595c66&clientId=u25d32a57-3797-4&from=paste&height=173&id=u75ac064f&originHeight=216&originWidth=1916&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=385208&status=done&style=none&taskId=u9af7c4eb-c3a2-45ec-9a5c-3a41dee2167&title=&width=1532.8" alt="image.png"><br>在这里真正调用OgnlUtil的setvalue方法，假如这里没有上面的黑名单，那肯定存在一个OGNL的RCE漏洞了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697467051938-740178cd-8f90-4411-980b-850bf94a76a9.png#averageHue=%23494d55&clientId=u25d32a57-3797-4&from=paste&height=730&id=u1a2a2626&originHeight=912&originWidth=1670&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1273750&status=done&style=none&taskId=u19b51383-dadc-47a8-86eb-5b8c3a0e9bb&title=&width=1336" alt="image.png"><br>调用Ognl.setvalue，到这里就是纯粹的Ognl的AST语法了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697467097090-cb247b2b-3b12-4a14-ac92-11724837791a.png#averageHue=%2342464d&clientId=u25d32a57-3797-4&from=paste&height=762&id=ubffcae6e&originHeight=953&originWidth=1860&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1301105&status=done&style=none&taskId=ua0954a44-372c-4cf4-830a-2fc1dd1cdf3&title=&width=1488" alt="image.png"><br>从这里的setvalue来看已经有一点雏形了，这里root就是对应的action，value就是我们设置的那个setup属性。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697467148035-bdf3d557-d4e9-42c2-a9c5-2a10eed3c194.png#averageHue=%2341454c&clientId=u25d32a57-3797-4&from=paste&height=621&id=u827accad&originHeight=776&originWidth=1456&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=881509&status=done&style=none&taskId=u9b9d8546-0607-4b03-b3d4-52050756267&title=&width=1164.8" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697467168274-0148feb1-e0c8-499f-b4eb-1b3ac3bcf4d0.png#averageHue=%234a4e57&clientId=u25d32a57-3797-4&from=paste&height=737&id=u4d8b01d7&originHeight=921&originWidth=1578&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1215009&status=done&style=none&taskId=uf7db7852-0828-4a69-a0dd-7049962ca70&title=&width=1262.4" alt="image.png"><br>经过不断的迭代，在setValueBody方法内，我们会获取第一个属性bootstrapStatusProvider<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697467226385-c783fcb9-b9df-48c5-a85d-1e9de8467731.png#averageHue=%23494d55&clientId=u25d32a57-3797-4&from=paste&height=838&id=u3dba3ae5&originHeight=1048&originWidth=1536&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1270015&status=done&style=none&taskId=u2cd3a702-121e-4bdf-995b-cca50a58798&title=&width=1228.8" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697467249095-b2f4a02b-9189-429c-88d1-b086e4c2449c.png#averageHue=%234b4f58&clientId=u25d32a57-3797-4&from=paste&height=844&id=u8c7afa4c&originHeight=1055&originWidth=1327&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1197349&status=done&style=none&taskId=u350a25db-22f4-4365-9afc-05f8d3c3f3f&title=&width=1061.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697467265279-582dcfc5-7b50-474c-a944-a5c889a122ab.png#averageHue=%23595b67&clientId=u25d32a57-3797-4&from=paste&height=121&id=u7f23ff78&originHeight=151&originWidth=1802&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=252153&status=done&style=none&taskId=u4db2f806-c25e-48b2-855c-cd0bb2deebc&title=&width=1441.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697467276971-2f21cfff-9558-473d-b677-951956cc2114.png#averageHue=%234d515a&clientId=u25d32a57-3797-4&from=paste&height=674&id=u4c9edfbf&originHeight=843&originWidth=1453&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1106826&status=done&style=none&taskId=u662959f6-db9f-4388-8941-ffe242dca5b&title=&width=1162.4" alt="image.png"><br>然后此处省略一万步的迭代。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697467326376-c9d0e3dc-2558-46bf-8f77-ebc975f0ab43.png#averageHue=%234a4e56&clientId=u25d32a57-3797-4&from=paste&height=570&id=u5a5f49fb&originHeight=713&originWidth=1442&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=946971&status=done&style=none&taskId=ucab607cb-5079-4265-b5c5-fce68fa3adc&title=&width=1153.6" alt="image.png"><br>随之进入的是OgnlRuntime方法内部<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697467357785-1bca2fd6-86a9-4d0f-b884-144bbbd320d6.png#averageHue=%234d515a&clientId=u25d32a57-3797-4&from=paste&height=681&id=u220adc0f&originHeight=851&originWidth=1404&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1101747&status=done&style=none&taskId=uff4221b4-6f63-48d1-8952-ab0cb066e6d&title=&width=1123.2" alt="image.png"><br>getProperty<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697467389129-19f2b0eb-83ba-417f-a358-5fd1cdb763bb.png#averageHue=%23484b52&clientId=u25d32a57-3797-4&from=paste&height=776&id=u22370825&originHeight=970&originWidth=1537&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1192827&status=done&style=none&taskId=ua5bcb09d-4eae-491c-becf-ee8a36bb4ad&title=&width=1229.6" alt="image.png"><br>最后在<code>OgnlRuntime.getProperty</code>方法下获取到了BootStrap对象。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697467467219-b5912fe9-aa49-4aeb-bb0e-d6128cbc9e7e.png#averageHue=%23454b52&clientId=u25d32a57-3797-4&from=paste&height=991&id=u4585fa85&originHeight=1239&originWidth=2520&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2540478&status=done&style=none&taskId=ua8b64cc5-23ba-4df6-9cfd-0b8bddb18ef&title=&width=2016" alt="image.png"><br>反射调用getter方法获取到对象<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697467475598-d0383ec1-df93-4036-b737-8e857c08bdf1.png#averageHue=%235c606c&clientId=u25d32a57-3797-4&from=paste&height=184&id=ub08788ab&originHeight=230&originWidth=1262&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=319394&status=done&style=none&taskId=u2a1dc927-a3e0-4d61-a1db-51ce10f0676&title=&width=1009.6" alt="image.png"><br>之后的流程也就一模一样了。我就不继续跟进咯。</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>在输入完payload后，我们用burpsuite抓个包。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1697467671369-2b6f148d-9346-44f0-9770-31e875654bfa.png#averageHue=%23adbf8f&clientId=u25d32a57-3797-4&from=paste&height=546&id=u10aa509a&originHeight=683&originWidth=1008&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=99899&status=done&style=none&taskId=u1c7ced9c-5a17-484b-b84d-41fa65cd95a&title=&width=806.4" alt="image.png"></p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /setup/setupadministrator.action HTTP/1.1</span><br><span class="line">Host: localhost:8090</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/118.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: metabase.DEVICE=b4a0ad02-dacb-4b2a-a39d-cf6a2d613533; <span class="built_in">_</span>ga=GA1.1.1767171371.1694851001; JSESSIONID=7B51C7B9DC7C3C1811396FA7B0892617</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 0</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>已经可以在这个界面设置一个新的admin了。</p>
<h1 id="RCE？"><a href="#RCE？" class="headerlink" title="RCE？"></a>RCE？</h1><p>RCE思路目前是没发现，但是已经有授权后rce的漏洞暴露出来了，猜测还是OGNL注入，是一个需要登录的路由，在那没做过滤什么之类的。<br>不管了摆了，等解析放出来学一手呢</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>结合上述的调试分析，可以大致的了解OGNL中的AST树状调用，是如何一层层的去调用的。setter&#x2F;getter的特性还是挺耐人寻味的捏，所以stucts2也得找个时间跟su18师傅的文章过一遍，不然感觉一片雾</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/Java/" class="tag">#Java</a><a href="/tags/CVE/" class="tag">#CVE</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/10/31/ACTF%202023%20Web%20Writeup/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">ACTF 2023 Web Writeup</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/10/16/Apache%20Jackrabbit%20RMI%20RCE%20%E5%88%86%E6%9E%90%E5%8F%8A%E5%88%A9%E7%94%A8/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">CVE-2023-37895 Apache Jackrabbit RMI RCE 分析及利用</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>