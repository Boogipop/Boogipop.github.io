<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>记一次基于H1VE的动态靶场搭建 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="记一次基于H1VE的动态靶场搭建 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://example.com/2023/03/02/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%9F%BA%E4%BA%8EH1ve%E7%9A%84%E5%8A%A8%E6%80%81%E9%9D%B6%E5%9C%BA%E6%90%AD%E5%BB%BA/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-03-02T10:24:48.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/Development/">Development</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>March</span>
            <span>2,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">记一次基于H1VE的动态靶场搭建</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>关于动态靶场的问题也是搞得十分困扰啊，由于各种python的不兼容问题，导致2022年8月前的教程和一些模板都受到了影响，并且没有做处理，导致前期不是很顺利，不过好在最后还是柳暗花明了（虽然与BUG共存了）但能RUN起来就是好东西<br>参考：<a target="_blank" rel="noopener" href="https://5ime.cn/h1ve.html">https://5ime.cn/h1ve.html</a></p>
<h1 id="1、下载H1ve"><a href="#1、下载H1ve" class="headerlink" title="1、下载H1ve"></a>1、下载H1ve</h1><p><code>git clone [https://github.com/D0g3-Lab/H1ve.git](https://github.com/D0g3-Lab/H1ve.git)</code><br>下载完后可以看到以下目录结构：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674034126648-5fa6da78-e144-440d-8799-cf1196ce1890.png#averageHue=%23070604&clientId=u9073a1c9-fd41-4&from=paste&height=105&id=uc9b7b14a&name=image.png&originHeight=131&originWidth=1521&originalType=binary&ratio=1&rotation=0&showTitle=false&size=21824&status=done&style=none&taskId=u1c123f61-1d38-4103-a105-d3bf1e14dd3&title=&width=1216.8" alt="image.png"><br>有3个yml文件,我们选择<code>single.yml</code>即可，single-nginx是加了一层反向代理的容器</p>
<h1 id="2、搭建-坑1）"><a href="#2、搭建-坑1）" class="headerlink" title="2、搭建(*坑1）"></a>2、搭建(*坑1）</h1><p>在官网上给的是直接docker-compose up即可，可实际上不行，会报一层<code>namerror</code>的错误，貌似是啥bug，但是不影响运行，实际上假如你按着README走是出不来的，他会永远卡在这一步的报错：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674034761675-bad4cfe3-d75e-4edb-a6ee-a3bb322f6826.png#averageHue=%23080604&clientId=u73eec8d4-74d7-4&from=paste&height=615&id=ucff7169e&name=image.png&originHeight=769&originWidth=1562&originalType=binary&ratio=1&rotation=0&showTitle=false&size=103496&status=done&style=none&taskId=u6d57df8f-ff63-42f9-a958-0b7ac6c5cff&title=&width=1249.6" alt="image.png"><br>你需要<code>docker-compose -f single.yml up -d</code></p>
<ul>
<li>-d：后台搭建</li>
</ul>
<p>假如不后台搭建，前台会一直卡在这，这是一个小坑点，然后搭建完后docker结构如下：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674034865608-2583903f-8c48-405a-8317-c42f3d608f54.png#averageHue=%2315120f&clientId=u73eec8d4-74d7-4&from=paste&height=116&id=u59cc12f5&name=image.png&originHeight=145&originWidth=1699&originalType=binary&ratio=1&rotation=0&showTitle=false&size=27672&status=done&style=none&taskId=u1da167db-d9e8-4477-b808-14e1c10a466&title=&width=1359.2" alt="image.png"><br>其中frpc和frps是用来穿透docker容器的：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674034906475-48e22062-7e61-4c80-8d0d-98026f6c1bea.png#averageHue=%23100e0c&clientId=u73eec8d4-74d7-4&from=paste&height=224&id=u551bd107&name=image.png&originHeight=280&originWidth=752&originalType=binary&ratio=1&rotation=0&showTitle=false&size=28919&status=done&style=none&taskId=u14e2c5e7-bd29-4470-8927-31608e65530&title=&width=601.6" alt="image.png"><br><code>docker network inspect h1ve_frp_containers</code>:<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674034947097-34c68c66-3d54-4d9b-a333-8dfbe127ebd0.png#averageHue=%23060403&clientId=u73eec8d4-74d7-4&from=paste&height=300&id=ucaaceae0&name=image.png&originHeight=375&originWidth=1103&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33045&status=done&style=none&taskId=u566686c8-ebe8-48b1-b4a9-d45d0b14d42&title=&width=882.4" alt="image.png"><br>frp的服务端和ctfd绑定在一起，方便穿透，之后我们题目容器也是创建在这个网络中的，这里是介绍一下整个架构<br>一些常用指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f xxx up -d #后台搭建</span><br><span class="line">docker-compose -f xxx stop #停止搭建的所有容器</span><br></pre></td></tr></table></figure>

<h1 id="3、出题-Web-——-大坑"><a href="#3、出题-Web-——-大坑" class="headerlink" title="3、出题(Web)——*大坑"></a>3、出题(Web)——*大坑</h1><p>到了这里你看到了官网炫酷的样子，你以为一切都尘埃落定，出题只是分分钟的事情，那就特错大错啦！<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674035301649-26148c10-011e-424f-a0a0-06ca9ce8862b.png#averageHue=%23e1c49f&clientId=u73eec8d4-74d7-4&from=paste&height=722&id=u462b4832&name=image.png&originHeight=903&originWidth=1817&originalType=binary&ratio=1&rotation=0&showTitle=false&size=61119&status=done&style=none&taskId=ub91afe99-a881-4d56-83f8-066e0eac084&title=&width=1453.6" alt="image.png"><br>不出意外的话进入这个界面一开始全部都是NONE.点UPDATE也不好使，这也是我觉得最操蛋的一个地方<br>应该是python搭建的导致请求过快，然后后端没接受到，所以这里需要手动burp抓包，然后放包给他改了，我就是直接一个无语<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674035382744-65293b29-fced-499e-8224-66f5f21776be.png#averageHue=%23fefdfd&clientId=u73eec8d4-74d7-4&from=paste&height=477&id=u72824805&name=image.png&originHeight=596&originWidth=1224&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33615&status=done&style=none&taskId=u577ed4a6-6e1e-49b7-82be-c3c4f58d144&title=&width=979.2" alt="image.png"></p>
<ul>
<li><p>Docker Flag Prefix：flag前缀</p>
</li>
<li><p>Docker APIs URL：&#x2F;var&#x2F;run&#x2F;docker.sock是docker daemon监听的套接字socket（ip+port），</p>
<blockquote>
<p>docker daemon 是<strong>docker架构中一个常驻在后台的系统进程</strong>，功能是：接收处理docker client发送的请求。 该守护进程在后台启动一个server，server负载接受docker client发送的请求；接受请求后，server通过路由与分发调度，找到相应的handler来执行请求。</p>
</blockquote>
</li>
<li><p>MAX contaniner count：最大开启的容器数</p>
</li>
<li><p>Max Renewal Times ：容器持续时间</p>
</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674035484883-5a2743c1-bd50-4c41-9a1d-72f6f34c6073.png#averageHue=%23fefdfd&clientId=u73eec8d4-74d7-4&from=paste&height=714&id=u8eee12f4&name=image.png&originHeight=892&originWidth=1383&originalType=binary&ratio=1&rotation=0&showTitle=false&size=54669&status=done&style=none&taskId=u67e80dc0-4b57-484c-9d68-f84727c5330&title=&width=1106.4" alt="image.png"><br>这一部分把DirectIP改为你VPS的地址，上面的是假如你有域名就可以填<br>mini port和max port指的是开放的最小和最大端口，下面的config对着填就好，是frpc.ini的配置内容，在linux中也可以查看到：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674035563240-bcad03d0-bffd-4c2f-b780-5c18b49fc9be.png#averageHue=%23060403&clientId=u73eec8d4-74d7-4&from=paste&height=206&id=u800a7458&name=image.png&originHeight=257&originWidth=776&originalType=binary&ratio=1&rotation=0&showTitle=false&size=19152&status=done&style=none&taskId=uda70e425-b0d8-4676-9c39-c110c891764&title=&width=620.8" alt="image.png"><br>将这些配置好后就是出题目了，出题需要编写Dockerfile和docker-compose.yml，题目目录结构如下（参考5ime师傅)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">test # 题目存放文件夹必须小写英文</span><br><span class="line">├─ Dockerfile</span><br><span class="line">├─ docker-compose.yml</span><br><span class="line">├─ files</span><br><span class="line">│    ├─ index.php </span><br><span class="line">│    └─ start.sh</span><br><span class="line">└─ flag</span><br></pre></td></tr></table></figure>
<h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM php:7.3-apache</span><br><span class="line">COPY files /var/www/html</span><br><span class="line">RUN chmod 755 /var/www/html &amp;&amp; \</span><br><span class="line">    chown root:root /var/www/html &amp;&amp; \</span><br><span class="line">    chmod +x /var/www/html/start.sh</span><br><span class="line">CMD /var/www/html/start.sh</span><br><span class="line">EXPOSE 80 #对外暴露的端口</span><br></pre></td></tr></table></figure>

<h2 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;2&#x27;</span><br><span class="line">services:</span><br><span class="line">  service: </span><br><span class="line">    # build 该置顶目录下的dockerfile</span><br><span class="line">    build: .</span><br><span class="line">    # image 指定build Dockerfile生成镜像的名称</span><br><span class="line">    image: test</span><br><span class="line">    ports:</span><br><span class="line">      - 9999:80</span><br><span class="line">    volumes:</span><br><span class="line">        # 挂载的 Flag</span><br><span class="line">        - &quot;$PWD/flag:/flag&quot;</span><br><span class="line">    tty: true</span><br><span class="line">    networks:</span><br><span class="line">      - net</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">    # 配置docker network</span><br><span class="line">    net: </span><br><span class="line">      external: </span><br><span class="line">         name: h1ve_frp_containers</span><br></pre></td></tr></table></figure>
<p>这里的flag有点讲究，我们在搭建的时候在当前文件夹准备了一个flag，内容无所谓，只要前缀和大括号包裹起来就行，然后在启动动态容器的时候，他会把容器内的flag进行替换，达到动态flag的效果<br>然后就是ports的问题，前面的9999可以随便改，但是绝对不能去掉，去掉了的话开启的容器端口就和frp映射的对应不上了(BUG)</p>
<h2 id="files-x2F-start-sh"><a href="#files-x2F-start-sh" class="headerlink" title="files&#x2F;start.sh"></a>files&#x2F;start.sh</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">v=`cat /flag`</span><br><span class="line">cat /var/www/html/index.php | sed -i &quot;s/flag&#123;test_flag&#125;/$v/&quot; /var/www/html/index.php # 用于正则匹配flag并替换</span><br><span class="line"></span><br><span class="line">apache2-foreground</span><br></pre></td></tr></table></figure>
<p>这是启动容器后需要做的事情</p>
<h2 id="files-x2F-index-php"><a href="#files-x2F-index-php" class="headerlink" title="files&#x2F;index.php"></a>files&#x2F;index.php</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class="line">    &lt;title&gt;测试题目&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">flag&#123;test_flag&#125;&lt;!--这里会被start.sh替换成动态flag--&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h2 id="flag"><a href="#flag" class="headerlink" title="flag"></a>flag</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HnuSec&#123;f4af4a4fg485a6w4f89a489zv&#125;</span><br></pre></td></tr></table></figure>

<h2 id="放入题目文件夹"><a href="#放入题目文件夹" class="headerlink" title="放入题目文件夹"></a>放入题目文件夹</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674035901463-33e98ca6-3157-4a11-be2e-30e3976eae6e.png#averageHue=%230d0b09&clientId=u73eec8d4-74d7-4&from=paste&height=61&id=u0f29d1a2&name=image.png&originHeight=76&originWidth=766&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7998&status=done&style=none&taskId=uf8f581cb-41f2-4da1-9f35-fb70678616e&title=&width=612.8" alt="image.png"><br>我们题目需要放在source目录下（相对路径）<br>在上面的docker-compose.yml文件中可以看到volumes是挂载了我们当前所在目录，和容器内同步了，因此在外边改就能改到里面，这很方便，我们需要把题目放在source目录里，比如里面的test&#x2F;JavaMaster_final<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674035976305-6d1e25b4-3ff5-414a-9355-a7281d26c92a.png#averageHue=%2314100d&clientId=u73eec8d4-74d7-4&from=paste&height=55&id=ucbf56c5f&name=image.png&originHeight=69&originWidth=771&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10503&status=done&style=none&taskId=u190a15a0-a7f7-4feb-8286-5de74d81972&title=&width=616.8" alt="image.png"><br>这样我们在部署题目的时候只需要填一个文件夹<code>test/JavaMaster_final</code>即可完成部署<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674037965150-0729ca42-5753-4c50-8cca-def71f1abf80.png#averageHue=%23fefefd&clientId=uaf2623d5-70e0-4&from=paste&height=726&id=uce76a35c&name=image.png&originHeight=907&originWidth=1042&originalType=binary&ratio=1&rotation=0&showTitle=false&size=46967&status=done&style=none&taskId=uf02c6553-8d14-4921-ab3c-83144299355&title=&width=833.6" alt="image.png"><br>题目配置如上即可，FPR PORT是需要暴露的容器端口，tomcat就是8080，一般都是80</p>
<h1 id="4、复杂环境出题经验"><a href="#4、复杂环境出题经验" class="headerlink" title="4、复杂环境出题经验"></a>4、复杂环境出题经验</h1><p>就拿这次招新赛的<code>WonderfulのSQL</code>来看，一个由javaweb搭建的有JDBC的项目，实际上考的也就是双写绕过的注入，只不过我想练一下自己的部署能力<br>在这就有很多坑点啊</p>
<h2 id="Dockerfile的编写"><a href="#Dockerfile的编写" class="headerlink" title="Dockerfile的编写"></a>Dockerfile的编写</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">FROM java8-tomcat-8-mysql:1</span><br><span class="line">ENV MYPATH /opt/tomcat/webapps/ROOT</span><br><span class="line">ENV JAVA_OPTS=&quot;-Xmx512m&quot;</span><br><span class="line">RUN rm -r $MYPATH</span><br><span class="line">RUN mkdir -p $MYPATH</span><br><span class="line">EXPOSE 8080</span><br><span class="line">WORKDIR $MYPATH</span><br><span class="line">ADD ./MavenDemo/  $MYPATH</span><br><span class="line">ADD ./wait-for-it.sh /</span><br><span class="line">ADD ./start.sh  /</span><br><span class="line">ADD ./flag /</span><br><span class="line">ADD ./wonderful.sql /</span><br><span class="line">RUN chmod +x /start.sh</span><br><span class="line">RUN chmod +x /wait-for-it.sh</span><br><span class="line">CMD [&quot;/start.sh&quot;]</span><br></pre></td></tr></table></figure>
<h2 id="start-sh"><a href="#start-sh" class="headerlink" title="start.sh"></a>start.sh</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">set -ex</span><br><span class="line">cd /</span><br><span class="line">./wait-for-it.sh -t 0 mysql:3306 -- echo &quot;mysql is up&quot;</span><br><span class="line">v=`cat /flag`</span><br><span class="line">mysql -uroot -pjiayou357753 -h mysql -e &quot;create database wonderful&quot;</span><br><span class="line">mysql -uroot -pjiayou357753 -h mysql wonderful -e &quot;source /wonderful.sql&quot;</span><br><span class="line">mysql -uroot -pjiayou357753 -h mysql wonderful -e &quot;USE wonderful;INSERT INTO secret(name,value) values(&#x27;flag_here&#x27;,&#x27;$v&#x27;)&quot;</span><br><span class="line"></span><br><span class="line">catalina.sh run</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们需要捋一捋思路,在tomcat容器和mysql容器中，谁应该先搭建好呢？那肯定是mysql啊，所以假如mysql和tomcat同时搭建好的话,那肯定会出现一些问题<br>这次就遇到了sql初始化的问题，start.sh中准备的是对mysql初始化的工作，但是在我不用wait-for-it.sh 脚本的时候，tomcat执行mysql指令是不会等mysql容器初始化好再执行的，所以就导致失败</p>
<h2 id="docker-compose-yml-1"><a href="#docker-compose-yml-1" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;2&#x27;</span><br><span class="line">services:</span><br><span class="line">  service: </span><br><span class="line">    build: .</span><br><span class="line">    image: javasql:1</span><br><span class="line">    ports:</span><br><span class="line">      - 9999:8080</span><br><span class="line">    volumes:</span><br><span class="line">      - &quot;$PWD/flag:/flag&quot;</span><br><span class="line">    tty: true</span><br><span class="line">    restart: always</span><br><span class="line">    networks:</span><br><span class="line">      - net</span><br><span class="line">    depends_on:</span><br><span class="line">      - mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  mysql:</span><br><span class="line">    image: boogisql:1</span><br><span class="line">    restart: always</span><br><span class="line">    networks:</span><br><span class="line">      - net2</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">    net: </span><br><span class="line">      external: </span><br><span class="line">         name: h1ve_frp_containers</span><br><span class="line">    net2:</span><br><span class="line">      external:</span><br><span class="line">         name: h1ve_frp_containers</span><br></pre></td></tr></table></figure>
<p>其次就是docker-compose的编写，其中service 依赖了mysql容器，意味着需要等mysql创建好了，再创建tomcat容器，但这还不够，所以要加wait-for-it.sh去等待<br>然后就是docker网络的问题，这里由于mysql和tomcat容器需要互相能ping通，因此把他们都放入了容器网络中（在这里mysql就默认是主机名字了）</p>
<h2 id="Maven项目"><a href="#Maven项目" class="headerlink" title="Maven项目"></a>Maven项目</h2><p>对于部署java项目呢，maven打包一定也要把依赖打包进来哦，要不然是无效的</p>
<h2 id="flag-1"><a href="#flag-1" class="headerlink" title="flag"></a>flag</h2><p>flag内容和上面一样，大括号内的东西随便取就行了</p>
<h1 id="5、动态flag"><a href="#5、动态flag" class="headerlink" title="5、动态flag"></a>5、动态flag</h1><p>动态flag的问题就和一开始说了，在启动容器时会对容器挂载的flag进行替换，可以利用这一点进行操作，就可上述的Java项目一样，令<code>v=</code>cat &#x2F;flag&#96;&#96;，把v赋值flag，在进行后续操作</p>
<h2 id="flag格式"><a href="#flag格式" class="headerlink" title="flag格式"></a>flag格式</h2><p>在默认的条件下flag中的<code>-</code>是被去掉了的，想要加回去得修改一下模板文件：<br>在<code>/opt/H1ve/CTFd/plugins/ctfd-owl/docker_utils.py</code>中产生了flag：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674037794842-8d862f0a-8a28-4845-8887-828f4188d7f2.png#averageHue=%23090807&clientId=u5bcfffff-d73f-4&from=paste&height=198&id=u7b513963&name=image.png&originHeight=247&originWidth=949&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18544&status=done&style=none&taskId=u71fa3d99-d26e-490d-affc-26da654a43b&title=&width=759.2" alt="image.png"><br>这里flag原本是<code>flag=prefix+flag.replace(&quot;-&quot;,&quot;&quot;)</code>把中间的横杠去掉了，这里我去掉了replace，这就使得flag更加美观</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>大致就这么多啦，有问题会补上的</p>
<h1 id="bug集合"><a href="#bug集合" class="headerlink" title="bug集合"></a>bug集合</h1><h2 id="填坑按钮无效"><a href="#填坑按钮无效" class="headerlink" title="填坑按钮无效"></a>填坑按钮无效</h2><p>这是谷歌浏览器的问题，用Firefox和国内的！！！妈的气死我了,又发现火狐其实也不能解决，这是他架构的问题</p>
<h2 id="500错误"><a href="#500错误" class="headerlink" title="500错误"></a>500错误</h2><p>因为redis中max client在后端处理中没有清空，因此会导致达到最大值<br>解决方法指标不治本：把max client拉满<code>CONFIG SET max client 100000</code>，满了之后就重启H1ve容器</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/开发/" class="tag">#开发</a><a href="/tags/靶场搭建/" class="tag">#靶场搭建</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/03/02/SpringMVC/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">SpringMVC</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/03/02/Django/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">Django</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>