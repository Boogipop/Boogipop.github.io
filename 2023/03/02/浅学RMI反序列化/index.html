<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>浅学RMI反序列化 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="浅学RMI反序列化 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/03/02/%E6%B5%85%E5%AD%A6RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-03-02T09:36:14.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>March</span>
            <span>2,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">浅学RMI反序列化</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p>咕咕了好久，因为最近学的也比较杂，闲得蛋疼会去打Hackthebox，从明天（2.16)就准备把这个学一学了，再不学就太抽象了</p>
<h1 id="RMI概念介绍"><a href="#RMI概念介绍" class="headerlink" title="RMI概念介绍"></a>RMI概念介绍</h1><p>RMI全程Remote Method Invocation（远程方法对象），RMI有客户端和服务端，在JAVA<br>中客户端可以通过RMI调用服务端的方法，怎么想都很危险，流程图如下：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676472782873-176c53b6-0994-4034-acbe-ab52a8508e81.png#averageHue=%23f4f4f4&clientId=ubf28282c-ab67-4&from=paste&height=570&id=u7423aa51&name=image.png&originHeight=713&originWidth=1222&originalType=binary&ratio=1&rotation=0&showTitle=false&size=131881&status=done&style=none&taskId=u6807f6de-f104-4481-a17e-25d9c917ae5&title=&width=977.6" alt="image.png"><br>服务端注册了RMI后会在RMI Registry进行注册，之后客户端调用方法都是直接从注册中心取出即可<br>RMI分为三个主体部分：</p>
<ul>
<li>Client-客户端：客户端调用服务端的方法</li>
<li>Server-服务端：远程调用方法对象的提供者，也是代码真正执行的地方，执行结束会返回给客户端一个方法执行的结果</li>
<li>Registry-注册中心：其实本质就是一个map，相当于是字典一样，用于客户端查询要调用的方法的引用，在低版本的JDK中，Server与Registry是可以不在一台服务器上的，而在高版本的JDK中，Server与Registry只能在一台服务器上，否则无法注册成功</li>
</ul>
<h1 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h1><p>需要准备客户端和服务器</p>
<h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><p>需要准备3个java文件，方法接口，实现类，RMI服务端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IRemoteObj</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="comment">//sayhello就是客户端需要调用的方法，需要throw异常</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayhello</span><span class="params">(String key)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IRemoteObjImp</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">IRemoteObj</span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">IRemoteObjImp</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="comment">//UnicastRemoteObject.exportObject(this,0);如果不继承手动导出</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayhello</span><span class="params">(String key)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        String upkey=key.toUpperCase();</span><br><span class="line">        System.out.println(upkey);</span><br><span class="line">        <span class="keyword">return</span> upkey;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, AlreadyBoundException &#123;</span><br><span class="line">        IRemoteObj remoteObj=<span class="keyword">new</span> <span class="title class_">IRemoteObjImp</span>();</span><br><span class="line">        <span class="comment">//注册中心</span></span><br><span class="line">        Registry r= LocateRegistry.createRegistry(<span class="number">7788</span>);</span><br><span class="line">        <span class="comment">//绑定对象到注册中心</span></span><br><span class="line">        r.bind(<span class="string">&quot;remoteobj&quot;</span>,remoteObj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这边需要注意的就是接口继承Remote类，实现类继承Unicastxxx类</p>
<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IRemoteObj</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="comment">//sayhello就是客户端需要调用的方法，需要throw异常</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayhello</span><span class="params">(String key)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.NotBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Rem</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">oteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RmiClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, NotBoundException &#123;</span><br><span class="line">        Registry r= LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">7788</span>);</span><br><span class="line">        IRemoteObj remoteObj= (IRemoteObj) r.lookup(<span class="string">&quot;remoteobj&quot;</span>);</span><br><span class="line">        remoteObj.sayhello(<span class="string">&quot;helloworld&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>先运行服务端，再运行客户端：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676476731601-02d06699-773b-4969-8218-36ad99522393.png#averageHue=%23242624&clientId=ud3adebb7-6457-4&from=paste&height=108&id=uc541c424&name=image.png&originHeight=135&originWidth=984&originalType=binary&ratio=1&rotation=0&showTitle=false&size=199622&status=done&style=none&taskId=ub23ff097-f647-47ea-bc87-d01d8a120e7&title=&width=787.2" alt="image.png"><br>服务端输出了方法结果，这里留个小坑，客户端的Remote接口能不能去掉，去掉了也是不影响结果的</p>
<h1 id="Step1-创建远程服务对象"><a href="#Step1-创建远程服务对象" class="headerlink" title="Step1| 创建远程服务对象"></a>Step1| 创建远程服务对象</h1><p>这一步分析对应<code>IRemoteObj remoteObj=new IRemoteObjImp();</code>：<br>第一步当然是创建实现类对象，但是我们的实现类继承了UnicastRemoteObject对象<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676477583491-dd92eaab-d861-440c-9fe9-3b330a1898b9.png#averageHue=%232b2c28&clientId=ud3adebb7-6457-4&from=paste&height=402&id=u559fbd2e&name=image.png&originHeight=503&originWidth=1378&originalType=binary&ratio=1&rotation=0&showTitle=false&size=961788&status=done&style=none&taskId=ua6a4c07e-6cbe-4257-821d-9e48d00b537&title=&width=1102.4" alt="image.png"><br>因此进入了下一步，调用了<code>UnicastRemoteObject</code>构造方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676477631662-0b35ff16-e180-48b7-a436-7ab3e5376bab.png#averageHue=%232c2f29&clientId=ud3adebb7-6457-4&from=paste&height=329&id=u10e00986&name=image.png&originHeight=411&originWidth=1012&originalType=binary&ratio=1&rotation=0&showTitle=false&size=589517&status=done&style=none&taskId=u8c3d9343-3bca-4068-8940-2d7ff38e6af&title=&width=809.6" alt="image.png"><br>在构造方法里定义了初始化port，之后导出了我们的远程对象：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676477668649-e19d26e4-905a-47d9-b55f-08ac73cb0e06.png#averageHue=%232d2e2a&clientId=ud3adebb7-6457-4&from=paste&height=173&id=u7f2611e4&name=image.png&originHeight=216&originWidth=1071&originalType=binary&ratio=1&rotation=0&showTitle=false&size=324289&status=done&style=none&taskId=ufad54817-0d7a-4e5e-bbd8-da21bde2880&title=&width=856.8" alt="image.png"><br>假如我们的实现类不继承UnicastRemoteObject我们就需要手动调用<code>exportObject((Remote) this, port);</code>了，因此得继承一下<br>接着就跟进exportobject方法中，在exportObject中又调用了另一个<code>exportObject</code>，参数为<code>new UnicastServerRef</code>，这个就是封装RMI的一个入口<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676477859543-093edddf-6cb4-49fa-979b-f6ffba9c33ef.png#averageHue=%23262824&clientId=ud3adebb7-6457-4&from=paste&height=158&id=u79357f60&name=image.png&originHeight=197&originWidth=1184&originalType=binary&ratio=1&rotation=0&showTitle=false&size=321511&status=done&style=none&taskId=u452740c8-e1df-4896-afff-fd3d1769ae0&title=&width=947.2" alt="image.png"><br>我们跟进UnicastServerRef方法中，调用了父类的构造方法，参数为一个<code>LifeRef</code>，记住这个对象，这是步骤一的核心对象，之后的大部分其他对象都是LifeRef的一个封装<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676478448715-ab674e94-37bf-4c74-a3ff-cb75c9713d26.png#averageHue=%232e2f2b&clientId=ue383cb20-de67-4&from=paste&height=147&id=u81b6d0f9&name=image.png&originHeight=184&originWidth=1071&originalType=binary&ratio=1&rotation=0&showTitle=false&size=273293&status=done&style=none&taskId=u2623eee7-56a0-4961-a28e-7181448f2cc&title=&width=856.8" alt="image.png"><br>进入LiveRef构造方法中，进入另外一个构造方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676516544914-4bc7cca9-6933-42e7-ab64-b028cad1ed8e.png#averageHue=%232d2e29&clientId=u79b9c485-a700-4&from=paste&height=187&id=u25433d59&name=image.png&originHeight=234&originWidth=869&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=282929&status=done&style=none&taskId=u99a28bd5-c098-4954-abbd-b4bd1c120f8&title=&width=695.2" alt="image.png"><br>另外一个构造方法又调用了另一个构造方法（套娃呢？）,第一个构造方法传入的ObjID只起了一个标识作用，并没啥其他用处，注意<code>TCPEndpoint.getLocalEndpoint(port)</code>，这是真正包含了远程服务对象信息的一个类：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676516586758-66bbc6c6-376b-4626-a2ae-eb1138991a38.png#averageHue=%232a2c29&clientId=u79b9c485-a700-4&from=paste&height=597&id=u9d956192&name=image.png&originHeight=746&originWidth=1347&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1347329&status=done&style=none&taskId=u33528234-94d5-4d38-bb45-1d78257271c&title=&width=1077.6" alt="image.png"><br>跟进<code>TCPEndpoint.getLocalEndpoint(port)</code><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676516689666-945a5d49-4eaa-41cd-a9be-acccd5bafec7.png#averageHue=%232f302d&clientId=u79b9c485-a700-4&from=paste&height=116&id=u0314ba6e&name=image.png&originHeight=145&originWidth=997&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=200598&status=done&style=none&taskId=ua3796f4c-3a5b-4cba-99fc-7670e47f3ad&title=&width=797.6" alt="image.png"><br>继续跟进，可以发现一些有关网络请求的信息，host和port，这里port还未进行初始化，因此是默认值0：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676516836838-b30faa22-5cfc-4d2c-995d-2c900c586058.png#averageHue=%23292b29&clientId=u79b9c485-a700-4&from=paste&height=586&id=u01c8e584&name=image.png&originHeight=732&originWidth=1645&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1651943&status=done&style=none&taskId=u0836d63c-6958-41f7-8225-0b7f303cd8a&title=&width=1316" alt="image.png"><br>回到<code>LiveRef：this(objID, TCPEndpoint.getLocalEndpoint(port), true)</code>：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676516918864-ee1f4b4e-185b-4520-8887-7e4c8f57f927.png#averageHue=%232a2d27&clientId=u79b9c485-a700-4&from=paste&height=307&id=ub0a67360&name=image.png&originHeight=384&originWidth=1356&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=729069&status=done&style=none&taskId=u5afedb20-42d3-43f1-bee5-b26e76df6e8&title=&width=1084.8" alt="image.png"><br>接着往下走，对LiveRef的属性进行了赋值，其中ep就是endpoint<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676516954306-a0c69017-2c7c-4775-9581-e03a0d4a38d8.png#averageHue=%23292c29&clientId=u79b9c485-a700-4&from=paste&height=622&id=ud25d3ae4&name=image.png&originHeight=777&originWidth=1487&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1551535&status=done&style=none&taskId=u94b6e986-4e45-4c04-817a-2d507724e83&title=&width=1189.6" alt="image.png"><br>执行完过后就退回了最初的开始<code>UnicastServerRef：super(new LiveRef(port));</code>，调用父类的构造方法，传入我们上面创建好的LiveRef进行封装：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676517025559-4dac1e0f-5884-49ea-afda-daaf81dc353c.png#averageHue=%232a2c26&clientId=u79b9c485-a700-4&from=paste&height=132&id=u061c807c&name=image.png&originHeight=165&originWidth=1172&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=266727&status=done&style=none&taskId=uc143bb5e-8cad-4de4-8638-b6d76f7d0b3&title=&width=937.6" alt="image.png"><br>继续跟进，对ref属性进行赋值，赋值为上述LiveRef，在这里做了第一次封装<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676517057632-eee3de77-c50c-4e59-9448-1a54c3e5f348.png#averageHue=%232c332c&clientId=u79b9c485-a700-4&from=paste&height=612&id=u29382ebf&name=image.png&originHeight=765&originWidth=1381&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1447115&status=done&style=none&taskId=u58dd716a-f294-4e66-ba47-308603e1b41&title=&width=1104.8" alt="image.png"><br>回到最开始的<code>new UnicastServerRef</code>，继续跟进<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676517272340-fd21e0d6-cff1-4ef7-a849-986446083587.png#averageHue=%23272825&clientId=u79b9c485-a700-4&from=paste&height=141&id=uf70eeb6c&name=image.png&originHeight=176&originWidth=1087&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=263842&status=done&style=none&taskId=ud9fac2a0-14c5-4fe2-8d9e-6e890fde648&title=&width=869.6" alt="image.png"><br>可以发现sref实际上就是LiveRef的封装(编号不一样是因为不在一次调试阶段，随后继续导出：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676517354267-e18f2199-3c55-467e-82c6-3ae954ab7b17.png#averageHue=%232a2c2a&clientId=u79b9c485-a700-4&from=paste&height=689&id=u275a4623&name=image.png&originHeight=861&originWidth=1458&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1656988&status=done&style=none&taskId=u61b85501-7bc5-4143-b45a-c80673a57e6&title=&width=1166.4" alt="image.png"><br>跟进<code>sref.exportObject</code>，进入了<code>Util.createProxy</code>，这里的getClientRef就是获取一个LiveRef封装：</p>
<blockquote>
<p>客户端通过stub获取远程对象，为什么服务端会出现客户端的stub呢？是因为服务端需要先将stub注册到注册中心，之后客户端直接从stub获取即可，可以参考概念介绍中的流程图来分析</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676520696033-ec470ef5-9e45-4067-b1f1-06c77dc75c1f.png#averageHue=%232b2d28&clientId=u79b9c485-a700-4&from=paste&height=311&id=ufd9a8834&name=image.png&originHeight=389&originWidth=1219&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=677833&status=done&style=none&taskId=u15b6d0e6-340d-4830-ae59-6db1ec2628b&title=&width=975.2" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676520728255-8f61c15b-fa8b-4797-8b24-96dd1d0700f2.png#averageHue=%2333332d&clientId=u79b9c485-a700-4&from=paste&height=190&id=ub8e3e06b&name=image.png&originHeight=238&originWidth=736&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=258734&status=done&style=none&taskId=uc8883224-6f05-4413-9f8d-6787730303f&title=&width=588.8" alt="image.png"><br>跟进createProxy，进入了一层判断，前两个条件都为false，关键就在于<code>stubClassExists(remoteClass)</code>是否为真，假如为真就不进去了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676520928050-27b0681b-b55e-40fe-8747-c8082509b3f0.png#averageHue=%23262724&clientId=u79b9c485-a700-4&from=paste&height=161&id=uc7dd5d60&name=image.png&originHeight=201&originWidth=1204&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=331585&status=done&style=none&taskId=u222aaa81-5fed-494e-87b8-55dac7889e9&title=&width=963.2" alt="image.png"><br>这里的stubClassExists实际上就是判断类名是否加了个<code>_stub</code>后缀，有就返回true，当然这里肯定是没有的，因为是我们自定义的，在jdk的registry包中有自带_stub后缀的类，这里用不上所以不细讲：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676521045579-b7c7a5b2-3850-4937-999c-263fb3e49e52.png#averageHue=%232b2b27&clientId=u79b9c485-a700-4&from=paste&height=414&id=u86ed8232&name=image.png&originHeight=517&originWidth=1779&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1299688&status=done&style=none&taskId=uf006ad69-0bed-4307-98db-039c7541aff&title=&width=1423.2" alt="image.png"><br>在接下来就是标准的创建动态代理的过程：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676521137186-b71705cf-272d-4b17-bef8-4ed7bee15ced.png#averageHue=%232b2d29&clientId=u79b9c485-a700-4&from=paste&height=326&id=uedc85e15&name=image.png&originHeight=408&originWidth=1293&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=745860&status=done&style=none&taskId=u4a70b833-7eb4-484e-b8bf-709493d744b&title=&width=1034.4" alt="image.png"><br>这里的ClientRef还是LiveRef的一层封装:<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676521193364-deece023-e9f5-4370-be7a-51da4b41a6ad.png#averageHue=%232b2c2a&clientId=u79b9c485-a700-4&from=paste&height=712&id=u07f6ca80&name=image.png&originHeight=890&originWidth=1484&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1777340&status=done&style=none&taskId=u54be9bb4-d91b-4e01-89ff-522ba7517d0&title=&width=1187.2" alt="image.png"><br>创建完stub后就回到了<code>stub = Util.createProxy(implClass, getClientRef(), forceStubUse);</code> ，继续往下走，又创建了Target对象，这里的target对象实际上就是把上面的LifeRef和Stub什么的一并封装：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676521265459-4524b435-ed94-41ff-83c2-8c6c7614420b.png#averageHue=%23282926&clientId=u79b9c485-a700-4&from=paste&height=129&id=u93a00216&name=image.png&originHeight=161&originWidth=1165&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=258791&status=done&style=none&taskId=uc1fd2697-0287-444e-9b17-0c1881ef77f&title=&width=932" alt="image.png"><br>跟进构造方法，对属性stub和disp进行赋值，这两个属性也是LiveRef的封装：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676521310931-9e44c1fe-ca19-42e0-a992-92947e79e3f2.png#averageHue=%232b2c2a&clientId=u79b9c485-a700-4&from=paste&height=682&id=u00389b4f&name=image.png&originHeight=852&originWidth=1311&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1608860&status=done&style=none&taskId=u5c784062-875f-40ac-a680-906628b190a&title=&width=1048.8" alt="image.png"><br>之后进入了LiveRef的exportObject方法，我们跟进：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676521416656-eb03c6c0-137e-43e9-9131-e5ae72b7ff63.png#averageHue=%232b2e2b&clientId=u79b9c485-a700-4&from=paste&height=561&id=u2b45e16f&name=image.png&originHeight=701&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1814839&status=done&style=none&taskId=uffff2d13-ee69-48cd-8789-7e3a496b766&title=&width=1536" alt="image.png"><br>接着进入TcpEndpoint的exportobject方法中导出对象：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676521451749-c9d2d95d-31f2-4d64-8983-70af862cd650.png#averageHue=%23292b28&clientId=u79b9c485-a700-4&from=paste&height=654&id=u26cf8530&name=image.png&originHeight=818&originWidth=1841&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2043808&status=done&style=none&taskId=ucc89c41d-e46b-46e1-a185-485bb45939b&title=&width=1472.8" alt="image.png"><br>TcpEndponit是又一个transport属性的，继续调用了transport的exportobject方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676521503664-d2db2b53-c7c9-4156-a507-b1f64769ae25.png#averageHue=%232a2e29&clientId=u79b9c485-a700-4&from=paste&height=703&id=u1012fc0c&name=image.png&originHeight=879&originWidth=1807&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2136190&status=done&style=none&taskId=u3c66e288-8e33-44f0-b6e4-b5fcfd6d01a&title=&width=1445.6" alt="image.png"><br>跟进transport.exportObject，进入了Listen方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676521539006-2a9b92b6-2dd0-426e-96ea-3f0670a37fb0.png#averageHue=%23282927&clientId=u79b9c485-a700-4&from=paste&height=578&id=uafeb0d7d&name=image.png&originHeight=722&originWidth=1872&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1820037&status=done&style=none&taskId=u1b7cb825-3b70-4ac0-8feb-5e221d970bc&title=&width=1497.6" alt="image.png"><br>在里面创建了一个新的Socket：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676522356559-bedecf0b-7397-4445-b95f-f50b5c4c6e39.png#averageHue=%232a2a27&clientId=u79b9c485-a700-4&from=paste&height=180&id=uc05e1053&name=image.png&originHeight=225&originWidth=1230&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=380793&status=done&style=none&taskId=u9c18837e-aca8-4ab3-aa48-5aaa7c70703&title=&width=984" alt="image.png"><br>跟进这个方法瞅瞅，发现在里面终于对port进行了一波初始化：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676522388460-dae2f29e-7c93-4f12-b2f3-8fa77da6486e.png#averageHue=%23292a29&clientId=u79b9c485-a700-4&from=paste&height=405&id=u4e0ab65f&name=image.png&originHeight=506&originWidth=1341&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=915758&status=done&style=none&taskId=u3916ec25-af71-4b5f-ad64-856f2dc006b&title=&width=1072.8" alt="image.png"><br>之后就执行完毕退出来了，然后创建了一个多线程的操作，逻辑在AcceptLoop中：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676522444493-f6a12cbd-265d-4bb3-bb18-071e5668f010.png#averageHue=%232c2c28&clientId=u79b9c485-a700-4&from=paste&height=168&id=u33fb1be8&name=image.png&originHeight=210&originWidth=1229&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=372830&status=done&style=none&taskId=u0033d537-dc2d-464f-8019-77754572bbe&title=&width=983.2" alt="image.png"><br>跟进里面的run方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676522464699-f41366c9-91fd-45ca-b353-8bea37ffde34.png#averageHue=%232a2b27&clientId=u79b9c485-a700-4&from=paste&height=444&id=u996500ac&name=image.png&originHeight=555&originWidth=1240&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=950817&status=done&style=none&taskId=u8dcc2bfc-bc8c-4753-9c79-8e764099b70&title=&width=992" alt="image.png"><br>逻辑在<code>executeAcceptLoop()</code>，就不继续跟进了，然后多线程创建完毕就退出Listen继续往下走了：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676522607081-94cc6ae0-6c73-4136-9189-42d8c15caa50.png#averageHue=%232a2b27&clientId=u79b9c485-a700-4&from=paste&height=274&id=u17908628&name=image.png&originHeight=343&originWidth=1268&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=575865&status=done&style=none&taskId=u3d9bd7ee-f25f-49cd-bc4e-09d0982a372&title=&width=1014.4" alt="image.png"><br>跟进父类的exportobject，在里面保存了我们的Target到一个Map中：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676522877023-7c42fca2-e3d1-490f-aa3c-a076feab0c91.png#averageHue=%232d2e29&clientId=u79b9c485-a700-4&from=paste&height=178&id=ubff4f15f&name=image.png&originHeight=222&originWidth=1197&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=380310&status=done&style=none&taskId=u51eb7202-e915-4293-a54a-e0c04f8ac4e&title=&width=957.6" alt="image.png"><br>跟进<code>putTarget</code>方法中，进入ObjectTable类，最后将target放入objtable属性中:<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676522930085-9fa0fa85-db2f-4b08-821e-626f2f5ec836.png#averageHue=%23282925&clientId=u79b9c485-a700-4&from=paste&height=291&id=u16801286&name=image.png&originHeight=364&originWidth=1418&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=714114&status=done&style=none&taskId=ubb0db065-7221-4ae3-9a33-aa5395cba9f&title=&width=1134.4" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676522963015-7876fd2c-0fed-49d7-8778-909963f3d5e3.png#averageHue=%2333322d&clientId=u79b9c485-a700-4&from=paste&height=158&id=u406f2610&name=image.png&originHeight=198&originWidth=773&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=231030&status=done&style=none&taskId=ueec5e8ba-6402-484c-a07a-0d7d8f49b66&title=&width=618.4" alt="image.png"><br>到这里第一步流程基本就结束了</p>
<h1 id="Step2-创建注册中心-绑定"><a href="#Step2-创建注册中心-绑定" class="headerlink" title="Step2| 创建注册中心+绑定"></a>Step2| 创建注册中心+绑定</h1><p>写到这里的时候去打VNCTF了，成绩不错有点感动，继续学习<br>到这里就是创建注册中心的过程，我们继续分析<br>第一步直接进入<code>createRegistry</code>方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676797150657-48875a10-ac84-4d08-a8df-a3f34be5dbc1.png#averageHue=%232d2e2a&clientId=ub2d226bf-3fd4-4&from=paste&height=116&id=u35e87175&name=image.png&originHeight=145&originWidth=1223&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=282391&status=done&style=none&taskId=uc8812ede-05be-4a4e-8660-f331ef611e6&title=&width=978.4" alt="image.png"><br>经过一系列的初始化步骤后进入RegistryImpl的构造方法，由于我们port不是默认的1099端口，因此直接过了if到else：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676797329908-447aaa53-783a-4142-ba24-f898aeb29293.png#averageHue=%232a2c2a&clientId=ub2d226bf-3fd4-4&from=paste&height=693&id=uacab2cd1&name=image.png&originHeight=866&originWidth=1416&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1635469&status=done&style=none&taskId=uef0cd87a-9ff7-4fd2-abde-44ea20675cd&title=&width=1132.8" alt="image.png"><br>首先创建一个LiveRef再塞进UnicastServerRef里，这个过程和第一步骤是很相似的，进入setup方法中：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676797481121-38b42333-00db-4d9d-9976-4dd70eb468ee.png#averageHue=%232a2c28&clientId=ub2d226bf-3fd4-4&from=paste&height=651&id=u83340723&name=image.png&originHeight=814&originWidth=1289&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1419242&status=done&style=none&taskId=uc96b31ad-9124-4bcc-88f7-ea5b6a2bfad&title=&width=1031.2" alt="image.png"><br>调用了UnicastServerRef的exportObject方法，这一步其实在第一步也发生过,跟进：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676797684239-91c91459-95a6-467a-b3d3-2f458f8f3a16.png#averageHue=%232b2c28&clientId=ub2d226bf-3fd4-4&from=paste&height=394&id=u5a87b11e&name=image.png&originHeight=493&originWidth=1338&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=916294&status=done&style=none&taskId=u0181d19f-4a90-45a1-b8ec-5e950ec645e&title=&width=1070.4" alt="image.png"><br>同样也是先初始化一个stub，跟进createProxy看看：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676797712575-1d5a0cda-255c-4f20-b43e-5ac7f73138fa.png#averageHue=%232b2d2a&clientId=ub2d226bf-3fd4-4&from=paste&height=699&id=ub44ceb98&name=image.png&originHeight=874&originWidth=1371&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1641835&status=done&style=none&taskId=u14f3dfe7-d4e6-4392-97c5-1a3c7cb7a11&title=&width=1096.8" alt="image.png"><br>在step1中也进入了这里，但是没过if判断，但是这次remoteObject为RegistryImpl类，而我们也说了存在<code>RegistryImpl_stub</code>这个类，因此这次我们进入了If判断：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676797826584-fb74b7c8-49d9-4768-9632-732741565a57.png#averageHue=%23292a29&clientId=ub2d226bf-3fd4-4&from=paste&height=501&id=ud0c40965&name=image.png&originHeight=626&originWidth=1266&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1117860&status=done&style=none&taskId=u6f5598b0-3b90-48da-a5f2-9abb372f8a5&title=&width=1012.8" alt="image.png"><br>这里ClientRef也是liveref的封装，继续跟进：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676797861895-fc08bcd4-c0a1-4dc3-93a8-7b2f404d5ce4.png#averageHue=%232b2d2b&clientId=ub2d226bf-3fd4-4&from=paste&height=718&id=u9d1a315a&name=image.png&originHeight=898&originWidth=1317&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1637905&status=done&style=none&taskId=u2b01b219-e17f-4723-9ff3-560d5e8b52b&title=&width=1053.6" alt="image.png"><br>这里就是通过forName反射获取ReigistryImpl类，然后执行完毕后跳出方法回到CreateProxy继续往下执行：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676797958403-194b1ef7-9633-44fc-9ae4-21d1a8ca89a4.png#averageHue=%23292b2a&clientId=ub2d226bf-3fd4-4&from=paste&height=441&id=u5e4278b1&name=image.png&originHeight=551&originWidth=1388&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1054398&status=done&style=none&taskId=u9934084d-5269-412f-b4b7-d3adac26c39&title=&width=1110.4" alt="image.png"><br>在这里设置了Skeleton(骨架)，从一开始的流程图我们知道，RMI是一个对称分布的结构，客户端有stub，服务端就对应有Skeleton，客户端通过stub请求远程方法，服务端就通过Skeleton去调用方法，然后通过Skeleton获取结果，最后传给客户端Stub，客户端就从Stub获取结果，因此继续跟进setSkeleton方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676800503675-400e286c-8892-462c-92c4-33de54397f9c.png#averageHue=%23292b28&clientId=ub2d226bf-3fd4-4&from=paste&height=547&id=u61670d79&name=image.png&originHeight=684&originWidth=1350&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1270888&status=done&style=none&taskId=u9eb76651-77ec-43fe-bbf4-d8a6205ad1c&title=&width=1080" alt="image.png"> 在这里进入<code>createSkeleton</code>：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676800738693-e0c2ba75-d530-4ede-9457-165028e2862d.png#averageHue=%232c2e2c&clientId=ub2d226bf-3fd4-4&from=paste&height=730&id=uf0c65232&name=image.png&originHeight=912&originWidth=1356&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1714851&status=done&style=none&taskId=ub6327e78-d186-4b9c-8872-4b133d545dd&title=&width=1084.8" alt="image.png"><br>反射获取了Skeleton，和上面的CreateStub其实很像的，之后退回<code>setSkeleton</code>，继续往下执行，创建了Target：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676800797040-b9068011-0779-4b3b-980f-618c13e37b32.png#averageHue=%23272825&clientId=ub2d226bf-3fd4-4&from=paste&height=133&id=ubf13d59e&name=image.png&originHeight=166&originWidth=963&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=228510&status=done&style=none&taskId=u976f5975-7846-4e45-8361-1baa7b824a2&title=&width=770.4" alt="image.png"><br>这一步大部分就和Step1是完全一致的了，进入构造方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676800820654-f926b40c-ac65-4e9b-83b4-dc89b9a0b09a.png#averageHue=%232d2e2a&clientId=ub2d226bf-3fd4-4&from=paste&height=231&id=u87576768&name=image.png&originHeight=289&originWidth=1317&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=561593&status=done&style=none&taskId=ua2b21906-645b-4df0-84a9-4a64eada0a5&title=&width=1053.6" alt="image.png"><br>也是进行一系列的赋值，唯一的不同之处就是disp之中这次skel有了值：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676800884690-32ae6865-5ddb-4920-a110-018f89a3ef80.png#averageHue=%232b2d2b&clientId=ub2d226bf-3fd4-4&from=paste&height=722&id=u6c08f179&name=image.png&originHeight=902&originWidth=1405&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1755888&status=done&style=none&taskId=u429e13c0-9dc6-4724-a713-55f2d5a7858&title=&width=1124" alt="image.png"><br>接着进入了liveref的exportobject方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676800961535-a902ae40-adde-400d-baa8-f3d12b32a3e8.png#averageHue=%232a2e2a&clientId=ub2d226bf-3fd4-4&from=paste&height=422&id=u3c4e8ac9&name=image.png&originHeight=528&originWidth=1367&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=974925&status=done&style=none&taskId=u8e32fd29-9979-4230-a848-9603f69150f&title=&width=1093.6" alt="image.png"><br>步骤和step1一样，先进入ep.exportobject，再进入transport.exportobject，最后到listen方法，listen方法里面就不分析了也和step1是一样的：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676801028321-8aa3522c-ad1f-46e5-b1fd-70dc18576eff.png#averageHue=%2331342e&clientId=ub2d226bf-3fd4-4&from=paste&height=139&id=uacc6bb2d&name=image.png&originHeight=174&originWidth=866&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=218649&status=done&style=none&taskId=ub95c6651-64b0-49ec-b57b-69322672933&title=&width=692.8" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676801032542-e1f36996-2f68-48aa-8f49-17853f8bb6b5.png#averageHue=%2330342e&clientId=ub2d226bf-3fd4-4&from=paste&height=122&id=ucd3a87c3&name=image.png&originHeight=152&originWidth=961&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=215687&status=done&style=none&taskId=u33f3f5d9-88b3-4cd2-9186-3af7781959d&title=&width=768.8" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676801038239-758df9a6-1102-4754-917c-df97b72c670e.png#averageHue=%232b2b28&clientId=ub2d226bf-3fd4-4&from=paste&height=194&id=u27e6faf3&name=image.png&originHeight=242&originWidth=1335&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=437165&status=done&style=none&taskId=u66e0376b-fdd3-4eea-9187-eccd5eac65d&title=&width=1068" alt="image.png"><br>最后基本就结束了，step2和step1的差别就体现在skeleton的创建上，然后就分析分析bind绑定嘛，其实绑定很简单没什么步骤：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676801167287-d2b7ac27-d8dc-427f-aaeb-2e1618e19ef1.png#averageHue=%232b2d2b&clientId=ub2d226bf-3fd4-4&from=paste&height=646&id=uafecd77b&name=image.png&originHeight=808&originWidth=1387&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1536269&status=done&style=none&taskId=u38b5693d-c945-448e-a1b2-4a06b377aa0&title=&width=1109.6" alt="image.png"><br>获取name后就放进bindings属性里，这里的bindings是一个hashtable，然后就没了。。</p>
<h1 id="Step3-客户端请求注册中心-客户端"><a href="#Step3-客户端请求注册中心-客户端" class="headerlink" title="Step3| 客户端请求注册中心-客户端"></a>Step3| 客户端请求注册中心-客户端</h1><p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676820407393-a5612cdc-02aa-4a28-9969-205c1605da3f.png#averageHue=%23272824&clientId=uac0e4576-bbbd-4&from=paste&height=156&id=u3a2e267a&name=image.png&originHeight=195&originWidth=1267&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=339798&status=done&style=none&taskId=u5ed6db7d-ad44-45c7-9957-1cc7f6369c3&title=&width=1013.6" alt="image.png"><br>NEXT<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676820421847-c4ed9835-d6fe-4187-b840-52a55e26b13e.png#averageHue=%232b2c28&clientId=uac0e4576-bbbd-4&from=paste&height=274&id=uc08708a4&name=image.png&originHeight=342&originWidth=1299&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=647130&status=done&style=none&taskId=ub0819398-8046-4c57-97f3-7a45ebbfdbd&title=&width=1039.2" alt="image.png"><br>NEXT，还是createproxy:<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676820449327-c2813339-c0ba-4884-8fcd-5a8f0691da6e.png#averageHue=%232b2c28&clientId=uac0e4576-bbbd-4&from=paste&height=322&id=u31b7f244&name=image.png&originHeight=403&originWidth=1359&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=765854&status=done&style=none&taskId=ufc0716e6-44f0-4196-87f7-fa32bbcdf1d&title=&width=1087.2" alt="image.png"><br>然后第一步就结束了QWQ，重点在调用lookup方法，调试进入的第一步就到了一个奇怪的地方：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676820521814-85187b61-8744-4d32-8393-dc9b4b49c524.png#averageHue=%232b2c28&clientId=uac0e4576-bbbd-4&from=paste&height=249&id=u99dc8361&name=image.png&originHeight=311&originWidth=1192&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=534759&status=done&style=none&taskId=u1d0da3dc-5bba-4543-b694-83ef426dbc0&title=&width=953.6" alt="image.png"><br>可以看一下调用栈：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676820570066-ccf19a90-9589-4613-96b8-735891fb25b2.png#averageHue=%232e3030&clientId=uac0e4576-bbbd-4&from=paste&height=111&id=u368a2e25&name=image.png&originHeight=139&originWidth=653&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=125673&status=done&style=none&taskId=u80820b46-ab77-403f-9648-db0b9afef21&title=&width=522.4" alt="image.png"><br>由于Regsitry_Stub是class文件无法调试所以跳过了，因此我们直接看看class反编译文件的内容：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676820603527-4f8e396d-bbf7-48b6-bf4b-83b44b4fb2f2.png#averageHue=%232a2c28&clientId=uac0e4576-bbbd-4&from=paste&height=442&id=u834b2de1&name=image.png&originHeight=553&originWidth=1325&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1011939&status=done&style=none&taskId=u4f10b703-c93a-4c9f-b6ac-b198620b142&title=&width=1060" alt="image.png"></p>
<h2 id="客户端-注册中心Attack-——被攻击点一"><a href="#客户端-注册中心Attack-——被攻击点一" class="headerlink" title="客户端(注册中心Attack)——被攻击点一"></a>客户端(注册中心Attack)——被攻击点一</h2><p>那我们就嗯读，先获取了一个输出流，获得服务端序列化结果，之后在后面调用readObject反序列化，这里一看就有漏洞啊：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676820949693-b8255a0d-d961-4e20-9ec6-9ee53a74c693.png#averageHue=%232c2c27&clientId=uac0e4576-bbbd-4&from=paste&height=332&id=u11c196da&name=image.png&originHeight=415&originWidth=969&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=574615&status=done&style=none&taskId=u1936f524-dc33-46ba-94e3-6ff147d4cf6&title=&width=775.2" alt="image.png"></p>
<h2 id="客户端-注册中心Attack-——被攻击点二"><a href="#客户端-注册中心Attack-——被攻击点二" class="headerlink" title="客户端(注册中心Attack)——被攻击点二"></a>客户端(注册中心Attack)——被攻击点二</h2><p>假如服务端返回的结果是恶意的，那么客户端就Rce了，这是第一个攻击客户端的地方，除了这地方还有别的地方吗？肯定是有的，看看上面是不是调用了一个<code>super.ref.invoke(var2);</code>，这里的ref是UnicastRef,我们跟进去：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676821045658-ccb38f5e-ae5f-43d3-b0bf-75e18591394a.png#averageHue=%232c302a&clientId=uac0e4576-bbbd-4&from=paste&height=493&id=u754b1dac&name=image.png&originHeight=616&originWidth=1434&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1305600&status=done&style=none&taskId=u32273271-ba29-4031-acb2-9739b31e3b1&title=&width=1147.2" alt="image.png"><br>到了UnicastRef里，在里面调用了<code>call.executeCall();</code>，这里才是处理逻辑的主要部分，继续跟进去：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676821103948-98bce528-eca5-4a52-8536-8ef7c18ad48f.png#averageHue=%23292924&clientId=uac0e4576-bbbd-4&from=paste&height=184&id=u0dcb3298&name=image.png&originHeight=230&originWidth=1150&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=370251&status=done&style=none&taskId=u6f080e6e-3a3b-489f-982b-e5028a3b7d0&title=&width=920" alt="image.png"><br>在末尾的异常处理中调用了<code>in.readObject();</code>，这里本来是想将异常结果反序列化读出来的，但是设计者没考虑安全问题，因此这里也可以被攻击</p>
<h2 id="客户端-注册中心Attack-——被攻击点三-六"><a href="#客户端-注册中心Attack-——被攻击点三-六" class="headerlink" title="客户端(注册中心Attack)——被攻击点三-六"></a>客户端(注册中心Attack)——被攻击点三-六</h2><p>那么除了这个地方还有没有其他地方呢，那么就再往上看看，我们这个Demo中调用的是lookup，还有其他方法可以<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676821282908-5fa907b4-2d04-4414-adf2-655908c6c8c5.png#averageHue=%23323430&clientId=uac0e4576-bbbd-4&from=paste&height=194&id=u2711554c&name=image.png&originHeight=243&originWidth=761&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=291491&status=done&style=none&taskId=u88c694e9-90d3-408b-8c8e-bde9015a9ba&title=&width=608.8" alt="image.png"><br>这里有很多其他处理远程对象的方法<code>lookup list rebind unbind bind</code>，我们分析一下这些方法里有什么共性：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676821324489-c5a60b8d-3057-4a0d-8a44-821f177a5584.png#averageHue=%232b2c28&clientId=uac0e4576-bbbd-4&from=paste&height=434&id=u3e92e65d&name=image.png&originHeight=542&originWidth=1262&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=977649&status=done&style=none&taskId=u497fcab9-7f10-49d7-b869-9d83b7a1627&title=&width=1009.6" alt="image.png"><br>list也调用了invoke，因此可以被攻击！<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676821368982-c5f26486-aa39-46e6-92a4-4283ab5d327d.png#averageHue=%232a2b27&clientId=uac0e4576-bbbd-4&from=paste&height=366&id=uf144334c&name=image.png&originHeight=457&originWidth=1285&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=803797&status=done&style=none&taskId=u3d28395f-1bbe-4c6b-af6b-df1ba978f2d&title=&width=1028" alt="image.png"><br>rebind同理<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676821383227-ad753255-6cab-4f31-b46f-90bd86e4eee0.png#averageHue=%232b2b28&clientId=uac0e4576-bbbd-4&from=paste&height=398&id=u3c3f6896&name=image.png&originHeight=498&originWidth=1333&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=921547&status=done&style=none&taskId=u2bfd9ec5-6915-4911-85f6-2e0796d3931&title=&width=1066.4" alt="image.png"><br>unbind同理<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676821444609-e8c9c68e-1a88-4d60-896b-8a3c3af2d759.png#averageHue=%232b2c28&clientId=uac0e4576-bbbd-4&from=paste&height=425&id=u0c23e2ec&name=image.png&originHeight=531&originWidth=1306&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=955919&status=done&style=none&taskId=u496d326d-4187-4e59-b36a-d3deddedd7d&title=&width=1044.8" alt="image.png"><br>bind同理</p>
<h1 id="Step4-客户端请求服务端-客户端"><a href="#Step4-客户端请求服务端-客户端" class="headerlink" title="Step4| 客户端请求服务端-客户端"></a>Step4| 客户端请求服务端-客户端</h1><h2 id="客户端-服务端Attack-被攻击点"><a href="#客户端-服务端Attack-被攻击点" class="headerlink" title="客户端(服务端Attack)被攻击点"></a>客户端(服务端Attack)被攻击点</h2><p>先跟着调试看看，由于获取的remoteobject是动态代理类，因此会进入代理的invoke方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676823995450-841e4b22-f3a6-4a05-8d60-321a745c7ce5.png#averageHue=%232a2c2a&clientId=uac0e4576-bbbd-4&from=paste&height=585&id=u31bf1556&name=image.png&originHeight=731&originWidth=1609&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1548819&status=done&style=none&taskId=ub528a46f-20b1-434b-b30a-4c588447dea&title=&width=1287.2" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676824001338-5ca1053a-c70d-46e6-a0bd-65f5417dc0dc.png#averageHue=%232b2d29&clientId=uac0e4576-bbbd-4&from=paste&height=370&id=u81f28411&name=image.png&originHeight=462&originWidth=1375&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=893352&status=done&style=none&taskId=u409590f6-4926-409e-8b6a-991b0d5f514&title=&width=1100" alt="image.png"><br>然后在invoke方法中有<code>invokeRemoteMethod(proxy, method, args)</code>，看名字就知道是方法调用：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676824050996-f909e403-9866-4f0c-9143-7b72fe692ab3.png#averageHue=%232b2d2b&clientId=uac0e4576-bbbd-4&from=paste&height=488&id=uc1587e3b&name=image.png&originHeight=610&originWidth=1374&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1145848&status=done&style=none&taskId=ud7e898eb-d640-421c-8626-4aff8c8b3b8&title=&width=1099.2" alt="image.png"><br>继续跟进该方法，在里面调用了个<code>ref.invoke</code>：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676824162051-ad1e9c22-d643-4251-a273-80f53ac352b4.png#averageHue=%232b2c28&clientId=uac0e4576-bbbd-4&from=paste&height=141&id=ua9e0ef2c&name=image.png&originHeight=176&originWidth=1261&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=321495&status=done&style=none&taskId=u7f53b592-21a9-4f24-9dc3-ef3d6cf7089&title=&width=1008.8" alt="image.png"><br>继续跟进该方法，可以看到调用了个<code>marshalValue</code>，跟进该方法，这是判断参数类型的：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676824245522-17a9327f-bc0f-4a78-b652-583fb012f218.png#averageHue=%232a2c29&clientId=uac0e4576-bbbd-4&from=paste&height=678&id=u1b258c61&name=image.png&originHeight=847&originWidth=1375&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1602876&status=done&style=none&taskId=u90e5c39d-34e5-4b7c-a5f7-6062cf9be9e&title=&width=1100" alt="image.png"><br>由于类型为String，不是<code>type.isPrimitive()</code>原始类型，而是引用类型，因此进入else，调用writeObject<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676824370488-d5472656-d042-43fc-a2de-d122d12fc98b.png#averageHue=%232a2b26&clientId=uac0e4576-bbbd-4&from=paste&height=142&id=u7df73617&name=image.png&originHeight=178&originWidth=1136&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=273316&status=done&style=none&taskId=udf5ce54c-494d-436d-969c-1e63ffbd1f3&title=&width=908.8" alt="image.png"><br>然后出来<code>marshalValue</code>后又调用了step3里的<code>call.executeCall()</code>这里的攻击手法和上面一样<img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676824430671-f06e26ca-c673-4580-b215-1ee5355254c1.png#averageHue=%23272826&clientId=uac0e4576-bbbd-4&from=paste&height=76&id=uc8c5d98c&name=image.png&originHeight=95&originWidth=891&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=118547&status=done&style=none&taskId=ube37bb4d-140c-4f33-a232-449ce1d0544&title=&width=712.8" alt="image.png"><br>然后判断返回值是否为空，这里我们为空，假如不为空，会对结果进行<code>unmarshalValue</code>：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676824494345-385161a0-5d2e-4b78-b25e-abd67c7e555a.png#averageHue=%232a2b27&clientId=uac0e4576-bbbd-4&from=paste&height=353&id=ube8a3180&name=image.png&originHeight=441&originWidth=1297&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=776448&status=done&style=none&taskId=ud45177ac-aa4b-49a7-ade8-86893719afc&title=&width=1037.6" alt="image.png"><br>跟进<code>unmarshalValue</code>：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676824515421-35f7ab8b-b437-4b19-961a-8afb3b59926f.png#averageHue=%232b2c28&clientId=uac0e4576-bbbd-4&from=paste&height=453&id=u15ae4d41&name=image.png&originHeight=566&originWidth=1269&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1035645&status=done&style=none&taskId=uaf229c27-e03d-4c84-a5b5-3a1afc7da0e&title=&width=1015.2" alt="image.png"><br>也是判断结果类型，如果不是原始类型就反序列化<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676824526869-f74992ae-fe3c-4226-9bde-2af761806b60.png#averageHue=%232e2c25&clientId=uac0e4576-bbbd-4&from=paste&height=77&id=u76267756&name=image.png&originHeight=96&originWidth=462&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=67192&status=done&style=none&taskId=uf30e73b8-36f7-4ee9-874c-10b7735c506&title=&width=369.6" alt="image.png"><br>这里就存在反序列化危险了，这里就是服务端攻击客户端了</p>
<h1 id="Step5-客户端请求服务端-注册中心"><a href="#Step5-客户端请求服务端-注册中心" class="headerlink" title="Step5| 客户端请求服务端-注册中心"></a>Step5| 客户端请求服务端-注册中心</h1><h2 id="注册中心-服务端-被攻击点-By-Client"><a href="#注册中心-服务端-被攻击点-By-Client" class="headerlink" title="注册中心(服务端)被攻击点(By Client)"></a>注册中心(服务端)被攻击点(By Client)</h2><p>下断点在哪有点讲究，回顾一下当时服务端创建注册中心的时候的流程吧，首先就是<code>createRegistry</code>：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676826941482-69ae9dc4-a373-4ee7-8bc9-fe70f0fa46c5.png#averageHue=%23333330&clientId=uac0e4576-bbbd-4&from=paste&height=112&id=u415d8b3d&name=image.png&originHeight=140&originWidth=872&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=181004&status=done&style=none&taskId=u574a9acd-4253-46db-9cb1-b39e4ca3257&title=&width=697.6" alt="image.png"><br>在进入<code>RegistryImpl</code>：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676826964774-ba3082b8-86f4-4fd8-8e25-9e245f09a88d.png#averageHue=%232a2c28&clientId=uac0e4576-bbbd-4&from=paste&height=535&id=u44188ad8&name=image.png&originHeight=669&originWidth=1482&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1357174&status=done&style=none&taskId=u20ca0fd8-c024-4aba-be79-a5180884a75&title=&width=1185.6" alt="image.png"><br>然后进入setup：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676826976338-e28782d4-1852-4296-bef4-230d55db2dd7.png#averageHue=%232c2c28&clientId=uac0e4576-bbbd-4&from=paste&height=227&id=u46b99e3b&name=image.png&originHeight=284&originWidth=1093&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=437561&status=done&style=none&taskId=u2128243f-a942-411d-8fdc-b1732caa787&title=&width=874.4" alt="image.png"><br>最后一路调用exportobject到listen监听：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676827004771-5450823f-a2ee-4cca-a15e-e4f66aa90f4e.png#averageHue=%2334332d&clientId=uac0e4576-bbbd-4&from=paste&height=138&id=u24722596&name=image.png&originHeight=173&originWidth=790&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=203300&status=done&style=none&taskId=u3a1a9a85-d037-4f0e-8a58-68325692ccb&title=&width=632" alt="image.png"><br>这里listen的逻辑我们也分析过了，是开过了一个线程，我们再看看：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676827499620-f3874853-3134-41d4-83fc-5ae61065a227.png#averageHue=%232e2e2a&clientId=uac0e4576-bbbd-4&from=paste&height=178&id=u5a6aa0d9&name=image.png&originHeight=223&originWidth=955&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=321611&status=done&style=none&taskId=u47de6fab-6aab-4d8b-861b-0f3e53f9cdf&title=&width=764" alt="image.png"><br>跟进：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676827513908-7bf4b198-552e-463d-910d-77bc2e2a6979.png#averageHue=%23323430&clientId=uac0e4576-bbbd-4&from=paste&height=218&id=ua9f767ce&name=image.png&originHeight=272&originWidth=745&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=295916&status=done&style=none&taskId=u4962711b-2fa8-49b3-8d60-bae3b3bffb8&title=&width=596" alt="image.png"><br>跟进：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676827535677-c43c1c6e-317e-4b8e-9cca-f6205720cf0b.png#averageHue=%2330302c&clientId=uac0e4576-bbbd-4&from=paste&height=158&id=ue99795e5&name=image.png&originHeight=198&originWidth=758&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=233439&status=done&style=none&taskId=ua86be008-9469-4b59-ad83-02f1cfdc0ca&title=&width=606.4" alt="image.png"><br>这里又开了一个线程池，跟进到ConnectionHandler的run方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676827576957-4c9946c3-adef-44c8-97b3-5f19c742c043.png#averageHue=%2334302a&clientId=uac0e4576-bbbd-4&from=paste&height=85&id=u36c93e2a&name=image.png&originHeight=106&originWidth=837&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=130178&status=done&style=none&taskId=u1f5bae7d-65af-4862-b32c-0e4690928c9&title=&width=669.6" alt="image.png"><br>到handlemessage这，继续跟：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676827617574-4d153333-9ffc-481c-ae82-a6d2e7f508d3.png#averageHue=%232e2d26&clientId=uac0e4576-bbbd-4&from=paste&height=87&id=u06b3bdfb&name=image.png&originHeight=109&originWidth=745&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=120459&status=done&style=none&taskId=ua4b8f210-1710-419a-b653-8b3df8d3555&title=&width=596" alt="image.png"><br>继续跟servicecall：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676827629470-1ecd0af6-f054-455c-ae03-8fcde7cf2715.png#averageHue=%2332322d&clientId=uac0e4576-bbbd-4&from=paste&height=93&id=u66ee33b1&name=image.png&originHeight=116&originWidth=896&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=162207&status=done&style=none&taskId=u42e6d456-504c-4ed3-8680-744eaf21a33&title=&width=716.8" alt="image.png"><br>这里就把target取出来了，也就是在这下断点即可，下完断点客户端调用方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676827679652-38a7449d-5259-425a-a70e-45f23009ce09.png#averageHue=%23292b29&clientId=uac0e4576-bbbd-4&from=paste&height=590&id=ubb2db960&name=image.png&originHeight=737&originWidth=1425&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1417857&status=done&style=none&taskId=u1e228ddf-3b1e-4da0-9818-f4214426749&title=&width=1140" alt="image.png"><br>可以看到跟到了这一步，也就是分析正确，那么我们继续调试：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676827799536-c4610636-5481-4d10-afe3-6075596651bb.png#averageHue=%232c2c28&clientId=uac0e4576-bbbd-4&from=paste&height=226&id=u5ea54d05&name=image.png&originHeight=282&originWidth=1388&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=559156&status=done&style=none&taskId=u697dad3f-7566-4428-8ecf-53da83b552f&title=&width=1110.4" alt="image.png"><br>获取dispatcher分发器，然后在下面调用了<code>disp.dispatch</code>：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676827980966-5c5ad489-d962-4a54-9e51-ef75d2f5ecbf.png#averageHue=%23282a27&clientId=uac0e4576-bbbd-4&from=paste&height=359&id=u842685a5&name=image.png&originHeight=449&originWidth=1454&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=903086&status=done&style=none&taskId=ufa7279f8-328b-4420-9a44-67dd84f91e6&title=&width=1163.2" alt="image.png"><br>小tips，点红框图表直接到下一个断点，可以动态加断点，跟进：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676828026965-79358733-62c0-4a07-8504-8a28c07df066.png#averageHue=%232a2b27&clientId=uac0e4576-bbbd-4&from=paste&height=162&id=u1a408d07&name=image.png&originHeight=203&originWidth=1299&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=378713&status=done&style=none&taskId=ub46d9ff6-0e91-49f4-8c7a-33ac870fde9&title=&width=1039.2" alt="image.png"><br>skel不为空因此到了olddispatch：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676828072197-c983aa43-744a-4da5-83b0-3c583c594c1c.png#averageHue=%232a2b29&clientId=uac0e4576-bbbd-4&from=paste&height=630&id=ub9cfffa1&name=image.png&originHeight=788&originWidth=1621&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1730223&status=done&style=none&taskId=ue48dcb7c-f2a9-4c9a-86b3-8693a9dad1c&title=&width=1296.8" alt="image.png"><br>最后也是调用了skel的dispatch方法，下一步就进入了<code>registryimpl_skel.class</code>的dispatch方法中，这也是漏洞所在<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676828260837-731955fc-8c18-4d15-8bce-346babf1bfee.png#averageHue=%232c2c27&clientId=uac0e4576-bbbd-4&from=paste&height=341&id=u1a781c6a&name=image.png&originHeight=426&originWidth=1240&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=746749&status=done&style=none&taskId=u3c77460f-b91b-43a7-8d83-793e29a2dea&title=&width=992" alt="image.png"><br>case2直接readObject了，这里是反序列化客户端序列化参数，然后这里case对应情况如下</p>
<ul>
<li>bind : 0</li>
<li>list : 1</li>
<li>lookup : 2</li>
<li>rebind : 3</li>
<li>unbind : 4</li>
</ul>
<p>到这里也就是说假如客户端传入的参数为恶意Object，那么就GG咯</p>
<h1 id="Step6-客户端请求服务端-服务端（服务端被攻击点）"><a href="#Step6-客户端请求服务端-服务端（服务端被攻击点）" class="headerlink" title="Step6| 客户端请求服务端-服务端（服务端被攻击点）"></a>Step6| 客户端请求服务端-服务端（服务端被攻击点）</h1><p> 回到Step5的olddispatch那一段，	继续往下走可以发现也调用了UnmarhalValue方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676853282350-6bb8cca8-6d1e-4c67-8c3e-0ff5f22ba7c5.png#averageHue=%23292b28&clientId=u90b3ac11-e3bc-4&from=paste&height=664&id=u9f921120&name=image.png&originHeight=830&originWidth=1522&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1716984&status=done&style=none&taskId=uc29bbb24-610e-4c4a-a909-922507462ad&title=&width=1217.6" alt="image.png"><br>进到了unmarshalvalue方法后就是判断参数类型是否为基本类型，demo传的是string，假如传入一个Object同样GG</p>
<h1 id="Step7-客户端请求服务端-dgc"><a href="#Step7-客户端请求服务端-dgc" class="headerlink" title="Step7| 客户端请求服务端-dgc"></a>Step7| 客户端请求服务端-dgc</h1><p>DGC就是RMI里垃圾回收机制，具体介绍如下：</p>
<blockquote>
<p>分布式垃圾回收，又称 DGC，RMI 使用 DGC 来做垃圾回收，因为跨虚拟机的情况下要做垃圾回收没办法使用原有的机制。我们使用的远程对象只有在客户端和服务端都不受引用时才会结束生命周期。</p>
<p>而既然 RMI 依赖于 DGC 做垃圾回收，那么在 RMI 服务中必然会有 DGC 层，在 yso 中攻击 DGC 层对应的是 JRMPClient，在攻击 RMI Registry 小节中提到了 skel 和 stub 对应的 Registry 的服务端和客户端，同样的，DGC 层中也会有 skel 和 stub 对应的代码，也就是 DGCImpl_Skel 和 DGCImpl_Stub，我们可以直接从此处分析，避免冗长的 debug。</p>
</blockquote>
<p>这东西呢，比较不好说，DGC就是用来回收远程对象的，他在RMI反序列化有什么作用呢？<br>它在bypassJEP290有作用，具体的JEP290是什么，我现在还不是很想去写，大概就到这，接下里就看看DGC的创建和风险点：<br>在之前Listen方法后的一系列export之后会进入puttarget方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676869089526-3c595f0a-79b0-4f9e-879d-254317894395.png#averageHue=%23292c29&clientId=u379e4357-053a-4&from=paste&height=556&id=ub4214bc5&name=image.png&originHeight=695&originWidth=1379&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1298977&status=done&style=none&taskId=uabd1f8b6-13a7-40ba-8b75-0575cd8ee86&title=&width=1103.2" alt="image.png"><br>在这里调用了DGCImpl的静态变量，也就完成了DGCImpl的初始化，因此我们跟进DGCImpl去看看：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676869213226-55ff814d-3b54-4b13-8f3c-f212349dc688.png#averageHue=%232c2f2b&clientId=u379e4357-053a-4&from=paste&height=493&id=uaea7ed79&name=image.png&originHeight=616&originWidth=1912&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1657453&status=done&style=none&taskId=u22c1973d-56bc-4942-b0ab-282aba508cb&title=&width=1529.6" alt="image.png"><br>这里面有一些dirty和clean方法，但是我们退回puttarget，可以看到target中创建的stub其实是<code>DGCImpl_stub</code>类，因此调用的是它里面的dirty和clean：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676869280779-11b3cdcb-0d45-41e2-979d-1a71049519c5.png#averageHue=%232c2f2c&clientId=u379e4357-053a-4&from=paste&height=674&id=u574142ed&name=image.png&originHeight=842&originWidth=1878&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2261041&status=done&style=none&taskId=u4229ddff-fdc9-4eeb-920e-cc45ffc4ef0&title=&width=1502.4" alt="image.png"><br>因此进入<code>DGCImpl_stub</code>：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1676869344152-fd4ca2d4-be08-4db8-b7ef-cc9dd62affbe.png#averageHue=%232b2c29&clientId=u379e4357-053a-4&from=paste&height=499&id=u7403d992&name=image.png&originHeight=624&originWidth=1447&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1230665&status=done&style=none&taskId=ueae2a460-14c3-407b-82c5-90971906885&title=&width=1157.6" alt="image.png"><br>dirty方法中有readObject反序列化，因此这里也是风险点,到这就算结束了，小结一下</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/CTF/" class="tag">#CTF</a><a href="/tags/Java/" class="tag">#Java</a><a href="/tags/RMI/" class="tag">#RMI</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/03/02/PyYAML%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">PyYaml反序列化</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/03/02/%E4%BB%8ERMI%E5%88%B0JNDI%E6%B3%A8%E5%85%A5/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">从RMI到JNDI注入</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>