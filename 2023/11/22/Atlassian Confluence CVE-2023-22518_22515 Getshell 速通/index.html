<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>Atlassian Confluence CVE-2023-22518_22515 Getshell 速通 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="Atlassian Confluence CVE-2023-22518_22515 Getshell 速通 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://example.com/2023/11/22/Atlassian%20Confluence%20CVE-2023-22518_22515%20Getshell%20%E9%80%9F%E9%80%9A/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2023-11-22T04:20:36.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>November</span>
            <span>22,</span>
            <span>2023</span>
        </div>
        

        <h2 class="title">Atlassian Confluence CVE-2023-22518_22515 Getshell 速通</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="前言-amp-amp-参考"><a href="#前言-amp-amp-参考" class="headerlink" title="前言&amp;&amp;参考"></a>前言&amp;&amp;参考</h1><p>文章首发奇安信攻防社区</p>
<p>前阵子爆出来的评分10.0的Confluence未授权漏洞可谓是比较震撼的，但其实漏洞原理不算复杂，利用的是XframeWork2的getter特性。具体分析可以参考我的往期文章<br><a target="_blank" rel="noopener" href="https://boogipop.com/2023/10/16/Atlassian%20Confluence%20CVE-2023-22515%20%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA/">Atlassian Confluence CVE-2023-22515 深入浅出 - Boogiepop Doesn’t Laugh</a><br>然后有一些外国佬发了一些不全的验证性质的POC，没有EXP<br><a target="_blank" rel="noopener" href="https://github.com/davidfortytwo/CVE-2023-22518/blob/main/CVE-2023-22518.py">https://github.com/davidfortytwo/CVE-2023-22518/blob/main/CVE-2023-22518.py</a><br>我就浅浅的分析一下。</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>但只需要给出漏洞的路由，我们就可以进一步去分析，这个POC中给出的路由是<br><code>/json/setup-restore.action</code><br>我们直接到structs.xml文件中去寻找相关的路由<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699015359254-4c040b57-de31-41fd-911c-19dc23c81173.png#averageHue=%2353575e&clientId=u44fd329a-c62d-4&from=paste&height=499&id=u65d8e0b5&originHeight=499&originWidth=1277&originalType=binary&ratio=1&rotation=0&showTitle=false&size=656605&status=done&style=none&taskId=uac83b952-577c-4d71-8ae9-56fd1214c7f&title=&width=1277" alt="image.png"><br>这乍一看就发现了一个Action，进去看看逻辑<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699015392969-b07ffa8e-7f2b-4310-9c3c-f7da2d4b27e9.png#averageHue=%2342464d&clientId=u44fd329a-c62d-4&from=paste&height=1028&id=u56b01540&originHeight=1028&originWidth=1464&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1240125&status=done&style=none&taskId=u8f00994d-e99b-495f-ab57-928afc5ff5c&title=&width=1464" alt="image.png"><br>这个接口没有进行鉴权，并且我们可以触发validate方法，他会获取请求体中上传的File，然后带入<code>getExportDescriptor</code>方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699015500112-59708237-47c2-4bf7-ba3d-1a04beeeee22.png#averageHue=%23565a62&clientId=u44fd329a-c62d-4&from=paste&height=117&id=uedea1392&originHeight=117&originWidth=1173&originalType=binary&ratio=1&rotation=0&showTitle=false&size=149585&status=done&style=none&taskId=u4313aba4-59a1-41f1-9094-9494837f4c2&title=&width=1173" alt="image.png"><br>在这里可以看到参数名是Zip，不难想到让我们上传一个zip文件。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699015527979-e09c24e4-e2dd-4a8c-8f53-04b9a2a331c4.png#averageHue=%234f545c&clientId=u44fd329a-c62d-4&from=paste&height=234&id=u0d715ccf&originHeight=234&originWidth=1209&originalType=binary&ratio=1&rotation=0&showTitle=false&size=339484&status=done&style=none&taskId=u179d05a5-a8a1-4942-a6ed-326b4a47dea&title=&width=1209" alt="image.png"><br>随后创建一个解压类unzipper<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699015561629-413bf421-3785-44ba-bdb5-b96f8d9db5e5.png#averageHue=%234a4e55&clientId=u44fd329a-c62d-4&from=paste&height=303&id=ud2b19af8&originHeight=303&originWidth=1461&originalType=binary&ratio=1&rotation=0&showTitle=false&size=462302&status=done&style=none&taskId=u7b2ef545-d13e-4c6e-bab3-735472ad56b&title=&width=1461" alt="image.png"><br>进行解压操作<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699015568521-5bfe3965-f070-4d09-8068-fa738ca3edf6.png#averageHue=%23575b62&clientId=u44fd329a-c62d-4&from=paste&height=231&id=u31e1a58b&originHeight=231&originWidth=1086&originalType=binary&ratio=1&rotation=0&showTitle=false&size=250791&status=done&style=none&taskId=ue1a81faa-b369-41c6-825a-f9981ec9d40&title=&width=1086" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699015604339-7463be61-5282-4779-8444-eb0a00aaf257.png#averageHue=%2351555d&clientId=u44fd329a-c62d-4&from=paste&height=367&id=u615d6819&originHeight=367&originWidth=870&originalType=binary&ratio=1&rotation=0&showTitle=false&size=341867&status=done&style=none&taskId=u25b87bcc-5adb-4d07-bbcf-49673e931a6&title=&width=870" alt="image.png"><br>进入saveEntry看看<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699015623952-142d2082-0ed0-4c3f-80fe-6a7dc2138ea0.png#averageHue=%233f4349&clientId=u44fd329a-c62d-4&from=paste&height=932&id=u943ff337&originHeight=932&originWidth=1472&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1074846&status=done&style=none&taskId=ue0488572-b9bc-4424-ac97-69ba3e386e9&title=&width=1472" alt="image.png"><br>一开始我以为是zipslip，所以有了下面一个失败的尝试</p>
<h1 id="调试流程分析"><a href="#调试流程分析" class="headerlink" title="调试流程分析"></a>调试流程分析</h1><p><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699016323342-93159924-7cc0-4c93-83c5-4ba3a8b9d282.png#averageHue=%23ecebeb&clientId=u44fd329a-c62d-4&from=paste&height=376&id=ud0f7b703&originHeight=376&originWidth=984&originalType=binary&ratio=1&rotation=0&showTitle=false&size=48865&status=done&style=none&taskId=u941507a4-fff4-4953-a9aa-457a9861113&title=&width=984" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699016328450-831fe85d-b382-4207-84e0-885ac0ea4cde.png#averageHue=%23f0efef&clientId=u44fd329a-c62d-4&from=paste&height=276&id=ue2fa43eb&originHeight=276&originWidth=886&originalType=binary&ratio=1&rotation=0&showTitle=false&size=32211&status=done&style=none&taskId=u82634128-2607-4313-aad3-1c41587b669&title=&width=886" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699016332231-79ef1340-a8c3-45bd-9bc8-7fa31f49e586.png#averageHue=%23494e55&clientId=u44fd329a-c62d-4&from=paste&height=885&id=u637da3c1&originHeight=885&originWidth=1950&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1466523&status=done&style=none&taskId=ua5df2c47-6154-4e9a-83de-050edb8ac92&title=&width=1950" alt="image.png"><br>进入我们的断点了已经，这里有个细节，就是我们需要给header加一个<br><code>X-Atlassian-Token=no-check</code><br>往前看堆栈<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699016490033-ace72eae-c555-4e45-97e4-78be4c8fcdc6.png#averageHue=%23495057&clientId=u44fd329a-c62d-4&from=paste&height=651&id=u270b6075&originHeight=814&originWidth=1807&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1399117&status=done&style=none&taskId=u6fedfcee-b57b-4bbb-8c1a-39cbbb31547&title=&width=1445.6" alt="image.png"><br>有一个isProtected属性，是由methodRequiresProtection方法赋值的<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699016534475-f58a58d8-efd8-405c-aea7-23f2566805dd.png#averageHue=%234a4e55&clientId=u44fd329a-c62d-4&from=paste&height=271&id=u6b0af785&originHeight=339&originWidth=1471&originalType=binary&ratio=1&rotation=0&showTitle=false&size=482747&status=done&style=none&taskId=ub70b6ed6-58f9-4e95-9f84-12f528ec1e0&title=&width=1176.8" alt="image.png"><br>isOverrideHeaderPresent方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699016542509-c9de64ed-5869-4c44-8117-a9dc8523876d.png#averageHue=%234a4e54&clientId=u44fd329a-c62d-4&from=paste&height=220&id=u4c5205a9&originHeight=275&originWidth=1406&originalType=binary&ratio=1&rotation=0&showTitle=false&size=380307&status=done&style=none&taskId=u90fa4223-4803-4a5e-bc19-1c159fffac6&title=&width=1124.8" alt="image.png"><br>这样isProtected属性就为false了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699016558865-bf0b3b33-da6b-47d8-9c75-bbd21829bf63.png#averageHue=%23363a40&clientId=u44fd329a-c62d-4&from=paste&height=81&id=u27cf7624&originHeight=101&originWidth=553&originalType=binary&ratio=1&rotation=0&showTitle=false&size=40104&status=done&style=none&taskId=u7233e89e-cd66-4f45-9ee8-ff5f4c0e39b&title=&width=442.4" alt="image.png"><br>因此我们才有接下来的调用哦。那我们继续看解压流程<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699016613262-231193ba-5e35-4a05-8ee1-144029499505.png#averageHue=%23464b52&clientId=u44fd329a-c62d-4&from=paste&height=604&id=u73caafb7&originHeight=755&originWidth=1862&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1312897&status=done&style=none&taskId=u16569a88-b296-4e1d-81c9-e50a6f027b3&title=&width=1489.6" alt="image.png"><br>在这里会创建一个缓存文件夹，存放zip的位置<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699016620519-b98183d2-3e4d-43fa-b9f5-12642e04c0ca.png#averageHue=%23fcfbfb&clientId=u44fd329a-c62d-4&from=paste&height=169&id=ud8629f87&originHeight=211&originWidth=1102&originalType=binary&ratio=1&rotation=0&showTitle=false&size=17170&status=done&style=none&taskId=ud1aaced6-e1aa-475d-8293-d7f5714a61a&title=&width=881.6" alt="image.png"><br>确实是有这东西，继续往下看<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699016644008-a4fd95ac-4215-4039-b250-f1c08825e726.png#averageHue=%23494c54&clientId=u44fd329a-c62d-4&from=paste&height=478&id=ue037cb28&originHeight=597&originWidth=1445&originalType=binary&ratio=1&rotation=0&showTitle=false&size=798957&status=done&style=none&taskId=ub5f2dfdf-27d6-4b5b-a94c-a5094da092d&title=&width=1156" alt="image.png"><br>这里会读取zip文件里有没有exportDescriptor.properties这个文件<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699016691270-5d5f6133-10e8-4115-9c60-e61fc4e728e0.png#averageHue=%23464950&clientId=u44fd329a-c62d-4&from=paste&height=536&id=u1d82178e&originHeight=670&originWidth=1643&originalType=binary&ratio=1&rotation=0&showTitle=false&size=968505&status=done&style=none&taskId=u035c5ef9-1b80-46ab-9c22-2707ce2b858&title=&width=1314.4" alt="image.png"><br>这里我的zip文件并没有他，因此就寄掉了，我们加上这个文件再来一遍<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699016800264-2d45dedd-f45a-4a34-b16c-21b9fde0609e.png#averageHue=%23484d56&clientId=u44fd329a-c62d-4&from=paste&height=554&id=uebd901ae&originHeight=692&originWidth=1506&originalType=binary&ratio=1&rotation=0&showTitle=false&size=970395&status=done&style=none&taskId=u445ab54e-2cee-453c-8e68-72a1e5d8b36&title=&width=1204.8" alt="image.png"><br>很好这次是成功获取咯。<br>然后经过多次尝试，properties有几个必要的属性</p>
<ul>
<li>exportType</li>
<li>createdByBuildNumber</li>
<li>buildNumber</li>
</ul>
<p>其中我们要让exportType&#x3D;ALL，这样才可以进入接下来的execute流程<br>并且这个zip需要一个entities.xml，而且这个entities.xml需要一定的配置，到这里我就去网上搜了一下这个文件，然后才知道，哦，原来这就是confluence的备份文件zip<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699085881734-5f06cfb1-5d5f-4eea-8d3a-e07013eb15bb.png#averageHue=%23fefdfd&clientId=ub7807db3-edcb-4&from=paste&height=243&id=u9ed218ed&originHeight=304&originWidth=1286&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=36864&status=done&style=none&taskId=u2a027549-41e5-45c5-ae11-1acf80e2e63&title=&width=1028.8" alt="image.png"><br>然后这个也就是数据恢复接口未授权访问。恍然大悟的我发现哪里来的那么多操作，直接自己本地准备个备份文件，然后给目标上传复原，管理员密码就是自己的了。<br>对于这个路由为什么是未授权的，其实就是stucts.xml配置错误问题了<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699069291315-11ab6665-3c9e-4762-a60e-65233125a2fa.png#averageHue=%23595c63&clientId=u44fd329a-c62d-4&from=paste&height=230&id=u17cf9d81&originHeight=288&originWidth=1308&originalType=binary&ratio=1&rotation=0&showTitle=false&size=322098&status=done&style=none&taskId=u3f3744df-ce04-4546-94ec-6e8359cce9a&title=&width=1046.4" alt="image.png"><br><code>/json</code>路由继承了admin路由，导致不需要鉴权也可以访问管理员权限的接口<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699069658630-72bf0fda-f810-493c-a7f3-1684e11c80a0.png#averageHue=%23fbfafa&clientId=u44fd329a-c62d-4&from=paste&height=517&id=u75808119&originHeight=646&originWidth=1558&originalType=binary&ratio=1&rotation=0&showTitle=false&size=60121&status=done&style=none&taskId=u6d4693fa-6fd1-411c-a874-ec146aad385&title=&width=1246.4" alt="image.png"><br>我们直接post界面请求就可以进入该界面了。</p>
<h1 id="正确的Getshell方法"><a href="#正确的Getshell方法" class="headerlink" title="正确的Getshell方法"></a>正确的Getshell方法</h1><p>这里我准备2个confluence，一个搭建在我的虚拟机里，一个搭建在本地</p>
<blockquote>
<p>虚拟机管理员用户密码为<br>kino&#x2F;kino123<br>本机管理员用户密码为<br>admin&#x2F;admin</p>
</blockquote>
<p>我们现在需要做的事利用本机的confluence获取一份备份文件，鉴于严谨，这边选择把版本对应起来，都是8.5.1<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699085651947-f7d80058-a5af-4a3e-920a-3160ac73dd68.png#averageHue=%23f4d988&clientId=ub7807db3-edcb-4&from=paste&height=143&id=u3b642ec6&originHeight=179&originWidth=228&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=7856&status=done&style=none&taskId=u6c30bee5-fffd-46aa-b15b-3dd021cba84&title=&width=182.4" alt="image.png"><br>在官网备份有2种备份文件，第一种就是设置里面-&gt;备份与恢复-&gt;导出站点<br>他得到的文件是restore打头的<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699085690706-2d21313d-90b4-4fed-8219-e6335d511b3a.png#averageHue=%2321201f&clientId=ub7807db3-edcb-4&from=paste&height=501&id=ucf018819&originHeight=626&originWidth=1536&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=101378&status=done&style=none&taskId=ufea011f2-d946-45ef-9533-0f7fe6014cc&title=&width=1228.8" alt="image.png"><br>其中exportType为site，我们无法通过上述调试说的判断，我们需要让exportType为ALL，因此我们选用另一个导出方案<br><code>/json/backup.action</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699087814157-4c93dc2b-abf1-4551-8e4f-2ae91c5c9772.png#averageHue=%2321201f&clientId=u7611e4a1-2174-4&from=paste&height=501&id=udbe32b36&originHeight=626&originWidth=1536&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=104462&status=done&style=none&taskId=ub17b3055-5afc-4455-afe4-2f992dbcedf&title=&width=1228.8" alt="image.png"></p>
<p>这个备份文件中主要内容是在entities.xml里，我们可以粗略的看看</p>
<p><img src="C:\Users\22927\AppData\Roaming\Typora\typora-user-images\image-20231104170441133.png" alt="image-20231104170441133">、</p>
<p>你会发现其实密码用户名也是在里面的，之前想过jsp文件会不会，仔细想想肯定不会啊- -</p>
<p>这样导出的就是all了，之后我们进行覆盖。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699087839628-c0b7ce03-2d31-44f7-a3f5-6a3d1fa9d95c.png#averageHue=%23fbfafa&clientId=u7611e4a1-2174-4&from=paste&height=440&id=ud384aacb&originHeight=550&originWidth=1259&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=44721&status=done&style=none&taskId=uffdc2cc4-7993-4ed7-8276-fc576de2077&title=&width=1007.2" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699087870964-c2e60b1e-508f-4c09-9fde-5e613b514805.png#averageHue=%23f9f9f9&clientId=u7611e4a1-2174-4&from=paste&height=219&id=uef74651f&originHeight=274&originWidth=1152&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=12846&status=done&style=none&taskId=u1d8b3ae9-5a1a-4449-885f-e079485369c&title=&width=921.6" alt="image.png"><br>然后等待一会儿，就可以发现用户名密码和空间内容被我们覆盖<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699087893318-0d41acaf-851a-4b9f-a2ea-774753833cf2.png#averageHue=%23efcb93&clientId=u7611e4a1-2174-4&from=paste&height=511&id=ua7fc70dd&originHeight=639&originWidth=2596&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=131583&status=done&style=none&taskId=ua3431794-85b3-41d2-b52a-9bbcc139c62&title=&width=2076.8" alt="image.png"><br>^^，然后就是rce的问题</p>
<h2 id="后台插件RCE"><a href="#后台插件RCE" class="headerlink" title="后台插件RCE"></a>后台插件RCE</h2><p><a target="_blank" rel="noopener" href="https://github.com/AIex-3/confluence-hack/tree/main">https://github.com/AIex-3/confluence-hack/tree/main</a><br>后台提供了插件功能<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699087938551-d7410751-05dc-4005-9efc-9256bd301a82.png#averageHue=%23fdfdfd&clientId=u7611e4a1-2174-4&from=paste&height=249&id=u4769816a&originHeight=311&originWidth=1471&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=22367&status=done&style=none&taskId=udfba00dc-e5be-4115-a377-0b1b4ef28d2&title=&width=1176.8" alt="image.png"><br>我们可以上传自定义插件，github上有人做了一个恶意插件<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699088025326-c09fee8c-2efe-49f7-b803-32e3d1736a4b.png#averageHue=%23fbf9f9&clientId=u7611e4a1-2174-4&from=paste&height=267&id=ua9d23818&originHeight=334&originWidth=1278&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=28844&status=done&style=none&taskId=u4e5b122b-a856-4dff-b536-17160a8cd8c&title=&width=1022.4" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699088047479-2d44688d-76c2-4af5-905c-35a378b5d9f9.png#averageHue=%231c1c1c&clientId=u7611e4a1-2174-4&from=paste&height=1045&id=u4c9105d5&originHeight=1306&originWidth=2013&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=25255&status=done&style=none&taskId=u04414f69-b94b-4446-b73f-f501686aa1e&title=&width=1610.4" alt="image.png"><br>成功rce咯~CVE-2023-22515也是这样后台RCE的，但这个毕竟不是完整的TTY，假如服务不出网，我们还是需要修改一下插件的，最好能哥斯拉连接这样子。不过理论应该是可以的，只需要修改下逻辑- -</p>
<h1 id="失败的Getshell尝试"><a href="#失败的Getshell尝试" class="headerlink" title="失败的Getshell尝试"></a>失败的Getshell尝试</h1><p>再说说失败的getshell方式吧，一开始我是逆向分析的，而不是正向分析的，因为当时不知道confluence有备份文件这东西，所以就自己手动构造了一下zip包，也是希望这个失败的思路可以给大家一点思路，个人觉得还是比较有趣的。这里就说一下我逆向的思路<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699071428378-93fae9f7-95a4-4e93-8338-a1ebfaf898bf.png#averageHue=%23f9f8f6&clientId=u44fd329a-c62d-4&from=paste&height=409&id=u301de0c8&originHeight=511&originWidth=488&originalType=binary&ratio=1&rotation=0&showTitle=false&size=52852&status=done&style=none&taskId=u62d4df30-a19a-491d-85fe-197a31f570e&title=&width=390.4" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699071432700-6e877471-03b2-4a37-89b5-c2594e01d1d5.png#averageHue=%23f8f8f6&clientId=u44fd329a-c62d-4&from=paste&height=409&id=uf6f2f751&originHeight=511&originWidth=488&originalType=binary&ratio=1&rotation=0&showTitle=false&size=51195&status=done&style=none&taskId=ua87a24ca-78ef-4671-be6b-065dca26bbc&title=&width=390.4" alt="image.png"><br>我准备了一个zipslip的压缩包，由于上面说到了这个zip需要entities.xml和properties属性文件，然后xml就是随便给了一个大标签，是没有任何内容的，紧接着就进入断点判断了。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699071496042-56120aea-c920-4ee9-9ba0-cdab415fc486.png#averageHue=%23555b63&clientId=u44fd329a-c62d-4&from=paste&height=272&id=u2a647856&originHeight=340&originWidth=1096&originalType=binary&ratio=1&rotation=0&showTitle=false&size=388607&status=done&style=none&taskId=ue928d8bb-3dec-476b-af84-5b05191e64b&title=&width=876.8" alt="image.png"><br>获取到了属性文件properties就会进入doRestore方法去进行恢复<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699071525601-714c1a1d-9831-4bf0-b806-eeedf35e44bf.png#averageHue=%235c606a&clientId=u44fd329a-c62d-4&from=paste&height=292&id=u14baddeb&originHeight=365&originWidth=1477&originalType=binary&ratio=1&rotation=0&showTitle=false&size=531488&status=done&style=none&taskId=u1fcb3501-a780-4791-a321-888b1fa1144&title=&width=1181.6" alt="image.png"><br>这个isSynchronous就是我们get传入的参数，我们要让他为true才可以进入task.run<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699071628330-01855eaf-d2c5-4c4d-9614-e789c53723c4.png#averageHue=%233a434e&clientId=u44fd329a-c62d-4&from=paste&height=173&id=ude6ec3f3&originHeight=216&originWidth=1901&originalType=binary&ratio=1&rotation=0&showTitle=false&size=319711&status=done&style=none&taskId=u648f140f-70f6-460d-9662-3781907b9e1&title=&width=1520.8" alt="image.png"><br>这个context是一个DefalutImportContext对象，所以之后task.run运行的逻辑应该在里面<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699071690336-8ab8a341-03ca-401a-bcba-2f29514a9137.png#averageHue=%23494d56&clientId=u44fd329a-c62d-4&from=paste&height=731&id=ua8c065c7&originHeight=914&originWidth=1645&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1449233&status=done&style=none&taskId=u96bbc65f-67a2-43b3-b6e3-f6b90649724&title=&width=1316" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699071697955-ffe215e5-6584-4870-b8f9-24d5afba8881.png#averageHue=%23575c64&clientId=u44fd329a-c62d-4&from=paste&height=266&id=u368ff2f7&originHeight=333&originWidth=1126&originalType=binary&ratio=1&rotation=0&showTitle=false&size=381340&status=done&style=none&taskId=ub6d7c15a-330b-43e3-8d71-9571b7c1dcd&title=&width=900.8" alt="image.png"><br>进入了doImport方法，然后有个preImport进行解压处理。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699071710972-62ce76a1-0860-4b72-9316-4f76aa50c63d.png#averageHue=%23646873&clientId=u44fd329a-c62d-4&from=paste&height=138&id=u051e45f0&originHeight=172&originWidth=917&originalType=binary&ratio=1&rotation=0&showTitle=false&size=147976&status=done&style=none&taskId=u9912161e-1c58-43ec-a03b-7bca844baf9&title=&width=733.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699071724601-3eac47f5-5cff-4600-aae5-5ae031d68cc2.png#averageHue=%23595e6b&clientId=u44fd329a-c62d-4&from=paste&height=238&id=u5bceda9e&originHeight=298&originWidth=1116&originalType=binary&ratio=1&rotation=0&showTitle=false&size=420161&status=done&style=none&taskId=u0fb6415b-da54-4ad5-93ee-2995c05cd8a&title=&width=892.8" alt="image.png"><br>最后自然就到了unzip方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699071739832-35a543cf-bcbc-4a6f-8843-98aac3eaba02.png#averageHue=%23575b62&clientId=u44fd329a-c62d-4&from=paste&height=273&id=u0ce2afdf&originHeight=341&originWidth=799&originalType=binary&ratio=1&rotation=0&showTitle=false&size=266926&status=done&style=none&taskId=ua27de9bf-c2f5-41f5-aea2-41e3253ddf3&title=&width=639.2" alt="image.png"><br>我以为在SaveEntity这里可以进行zipslip操作的。QWQ<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1699071782886-2b85f9d8-7db8-4581-8d6b-05d1fc39d7ab.png#averageHue=%23545960&clientId=u44fd329a-c62d-4&from=paste&height=210&id=u4bd5ab14&originHeight=262&originWidth=1854&originalType=binary&ratio=1&rotation=0&showTitle=false&size=428931&status=done&style=none&taskId=u28c9d702-b187-44a5-90c5-7d58cae932f&title=&width=1483.2" alt="image.png"><br>结果有一层判断isChildOf，导致我们的zipslip失败呜呜呜呜</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>总得来说这漏洞是一个自爆式百分百损失的漏洞，你假如想用，那么就拿不到服务器那边原来的数据，而我们打Confluence的站一般都是去看他的文库数据，而不是获取这个站点的shell，这是一种比较极端的利用方式，不太建议使用，除非已知文库没啥东西，就是想要这个shell。</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/Java/" class="tag">#Java</a><a href="/tags/CVE/" class="tag">#CVE</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2023/12/01/TPCTF%202023%20Web%20Writeup/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">TPCTF 2023 Web Writeup</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2023/11/19/%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97%20Netty_WebFlux%20%E5%86%85%E5%AD%98%E9%A9%AC/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">内存马系列 Netty/WebFlux 型内存马</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>