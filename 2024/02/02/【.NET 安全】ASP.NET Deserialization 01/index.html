<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>【.NET 安全】ASP.NET Deserialization 01 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="【.NET 安全】ASP.NET Deserialization 01 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2024/02/02/%E3%80%90.NET%20%E5%AE%89%E5%85%A8%E3%80%91ASP.NET%20Deserialization%2001/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2024-02-02T08:10:30.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>February</span>
            <span>2,</span>
            <span>2024</span>
        </div>
        

        <h2 class="title">【.NET 安全】ASP.NET Deserialization 01</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p><a target="_blank" rel="noopener" href="https://github.com/Y4er/dotnet-deserialization/blob/main/XmlSerializer.md">https://github.com/Y4er/dotnet-deserialization/</a><br>一代人一代人传下来的文献。学。</p>
<h1 id="01-环境搭建"><a href="#01-环境搭建" class="headerlink" title="01-环境搭建"></a>01-环境搭建</h1><p>搭建牢记于心，一开始以为很简单，但是对刚入手一门语言的人菜鸡还是太勉强了，花了也有2小时去研究一下包管理、lib添加以及一系列的兼容问题 all in one，就不写了。<br>笔者使用的编译器是Rider，被JB全家桶磨平了，用JB只有一次和无数次。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706793770864-3488d8f1-b9df-4252-b686-c605bdb16711.png#averageHue=%23514334&clientId=u8a4e437d-fec5-4&from=paste&height=864&id=ud852ae5b&originHeight=1080&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=215622&status=done&style=none&taskId=u35361008-be18-4e30-87a6-474e38290ed&title=&width=1536" alt="image.png"><br>个人感觉挺不错的，体验感不错。比Visual studio美观（</p>
<h1 id="02-基础序列化与反序列化"><a href="#02-基础序列化与反序列化" class="headerlink" title="02-基础序列化与反序列化"></a>02-基础序列化与反序列化</h1><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DonNET_Deserialization</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NormalSerialize</span></span><br><span class="line">&#123;</span><br><span class="line">     [<span class="meta">Serializable</span>]</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Myclass</span></span><br><span class="line">     &#123;</span><br><span class="line">          <span class="keyword">public</span> <span class="built_in">int</span> n1;</span><br><span class="line">          [<span class="meta">NonSerialized</span>] <span class="keyword">public</span> <span class="built_in">int</span> n2;</span><br><span class="line">          <span class="keyword">public</span> String str;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">     &#123;</span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">BinaryFormatterSerialize</span>(<span class="params"><span class="built_in">string</span> file, <span class="built_in">object</span> o</span>)</span></span><br><span class="line">          &#123;</span><br><span class="line">               BinaryFormatter binaryFormatter = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">               FileStream fileStream = <span class="keyword">new</span> FileStream(file, FileMode.Create, FileAccess.Write, FileShare.None);</span><br><span class="line">               binaryFormatter.Serialize(fileStream, o);</span><br><span class="line">               fileStream.Close();</span><br><span class="line">               Console.WriteLine(<span class="string">$&quot;serialize object <span class="subst">&#123;o&#125;</span> to file <span class="subst">&#123;file&#125;</span>.&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">object</span> <span class="title">BinaryFormatterDeserialFromFile</span>(<span class="params"><span class="built_in">string</span> file</span>)</span></span><br><span class="line">          &#123;</span><br><span class="line">               IFormatter formatter = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">               Stream stream = <span class="keyword">new</span> FileStream(file, FileMode.Open, FileAccess.Read, FileShare.Read);</span><br><span class="line">               <span class="built_in">object</span> o = formatter.Deserialize(stream);</span><br><span class="line">               stream.Close();</span><br><span class="line">               <span class="keyword">return</span> o;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">          &#123;</span><br><span class="line">               <span class="keyword">try</span></span><br><span class="line">               &#123;</span><br><span class="line">                    Myclass myObject = <span class="keyword">new</span> Myclass();</span><br><span class="line">                    myObject.n1 = <span class="number">1</span>;</span><br><span class="line">                    myObject.n2 = <span class="number">2</span>;</span><br><span class="line">                    myObject.str = <span class="string">&quot;Boogipop&quot;</span>;</span><br><span class="line"></span><br><span class="line">                    BinaryFormatterSerialize(<span class="string">&quot;1.bin&quot;</span>, myObject);</span><br><span class="line">                    Myclass myObject1 = (Myclass)BinaryFormatterDeserialFromFile(<span class="string">&quot;1.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    Console.WriteLine(<span class="string">$&quot;n1:<span class="subst">&#123;myObject1.n1&#125;</span>&quot;</span>);</span><br><span class="line">                    Console.WriteLine(<span class="string">$&quot;NonSerialized n2:<span class="subst">&#123;myObject1.n2&#125;</span>&quot;</span>);</span><br><span class="line">                    Console.WriteLine(<span class="string">$&quot;str:<span class="subst">&#123;myObject1.str&#125;</span>&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">catch</span> (Exception e)</span><br><span class="line">               &#123;</span><br><span class="line">                    Console.WriteLine(e.Message);</span><br><span class="line">               &#125;</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706791325169-cc3d578e-67de-4358-a391-436e585628ac.png#averageHue=%2398b2b1&clientId=u0a6437ef-2317-4&from=paste&height=276&id=u890a340e&originHeight=345&originWidth=1344&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=45679&status=done&style=none&taskId=u3f140ab7-8e0b-4de0-9b47-ebabd74042f&title=&width=1075.2" alt="image.png"><br>运行结果如上，这里我们需要加上<code>Serializable</code>注解，并且可以发现添加了<code>NonSerialized</code>注解的字段并没有参与序列化，因此反序列化输出时它的值为0<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706791391396-e9ab7686-d8dd-45a5-ab4f-e9e0613498bc.png#averageHue=%235c616c&clientId=u0a6437ef-2317-4&from=paste&height=236&id=u920593a1&originHeight=295&originWidth=919&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=428435&status=done&style=none&taskId=u6a729739-1198-4356-8d7b-b5f5e71c351&title=&width=735.2" alt="image.png"><br>它的序列化文件格式如上</p>
<h1 id="03-Formatters"><a href="#03-Formatters" class="headerlink" title="03-Formatters"></a>03-Formatters</h1><p>Formatter就是你需要进行什么样子的序列化和反序列化，在DOTNET中，Formatter大概分为以下几类</p>
<ul>
<li>BinaryFormatter 二进制流序列化</li>
<li>SoapFormatter soap格式的序列化</li>
<li>LosFormatter 一般用于序列化存储视图流状态</li>
<li>ObjectStateFormatter 一般用于序列化和反序列化状态对象图</li>
<li>XmlSerializer</li>
<li>JsonSerializer</li>
<li>等等其他……..</li>
</ul>
<p>其中XmlSerializer和JsonSerializer咱们在不久后的将来还会见到的XD。本文主要讲一些基础内容知识。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706795247340-065a65bf-f55a-4894-aa6e-afada931287d.png#averageHue=%23242322&clientId=u8a4e437d-fec5-4&from=paste&height=529&id=u7d8fb640&originHeight=661&originWidth=1692&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=142664&status=done&style=none&taskId=ub7d75e89-6ab4-44ae-a15b-aa29b22b3ae&title=&width=1353.6" alt="image.png"><br>其中Formatters都像BinaryFormatter一样实现了2个类<code>IFormatter、IRemotingFormatter</code><br>其中IRemotiongFormatter主要提供RPC服务，它也实现IFormatter接口<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706795326271-1a7dd706-5595-46ef-8f7d-9501228655fb.png#averageHue=%231f1e1e&clientId=u8a4e437d-fec5-4&from=paste&height=342&id=uc0d259c0&originHeight=428&originWidth=1232&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=84478&status=done&style=none&taskId=u0e794aa4-237d-48d1-829a-546644662c8&title=&width=985.6" alt="image.png"><br>因此我们只需要关注IFormatter即可。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"></span><br><span class="line"><span class="meta">#nullable disable</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">System.Runtime.Serialization</span></span><br><span class="line">&#123;</span><br><span class="line">  [<span class="meta">ComVisible(true)</span>]</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IFormatter</span></span><br><span class="line">  &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="built_in">object</span> <span class="title">Deserialize</span>(<span class="params">Stream serializationStream</span>)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Serialize</span>(<span class="params">Stream serializationStream, <span class="built_in">object</span> graph</span>)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ISurrogateSelector SurrogateSelector &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    SerializationBinder Binder &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    StreamingContext Context &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>IFormatter类的定义如上，他有三个属性</p>
<ul>
<li>ISurrogateSelector</li>
<li>SerializationBinder</li>
<li>StreamingContext</li>
</ul>
<p>这里引用Y4er师傅的介绍。</p>
<table>
<thead>
<tr>
<th>类 字段名</th>
<th>含义用途</th>
</tr>
</thead>
<tbody><tr>
<td>ISurrogateSelector SurrogateSelector</td>
<td>序列化代理选择器 接管formatter的序列化或反序列化处理</td>
</tr>
<tr>
<td>SerializationBinder Binder</td>
<td>用于控制在序列化和反序列化期间使用的实际类型</td>
</tr>
<tr>
<td>StreamingContext Context</td>
<td>序列化流上下文 其中states字段包含了序列化的来源和目的地</td>
</tr>
</tbody></table>
<p>其中我们需要重点注意的就是ISurrogateSelector，代理选择器。</p>
<h1 id="04-序列化和反序列化生命周期"><a href="#04-序列化和反序列化生命周期" class="headerlink" title="04-序列化和反序列化生命周期"></a>04-序列化和反序列化生命周期</h1><p>这里还是以BinaryFormatter为例子，介绍一下DOTNET反序列化和序列化的生命周期。上面介绍了IFormatter的三个属性，而这三个属性具体含义和例子是这样的</p>
<blockquote>
<p>1.首先确定formatter是否有代理选择器，如果有则检查代理选择器要处理的对象类型是否和给定的对象类型一致，如果一致，代理选择器会调用ISerializable.GetObjectData()<br>2.如果没有代理选择器，或者代理选择器不处理该对象类型，则检查对象是否有[Serializable]特性。如果不能序列化则抛出异常<br>3.检查该对象是否实现ISerializable接口，如果实现就调用其GetObjectData方法<br>4.如果没实现ISerializable接口就使用默认的序列化策略，序列化所以没标记[NonSerialized]的字段</p>
</blockquote>
<p>用流程图表示就是下面这样<br><img src="https://github.com/Y4er/dotnet-deserialization/raw/main/dotnet-serialize-101.assets/image-20210420105228965.png#from=url&id=CyYJp&originHeight=575&originWidth=853&originalType=binary&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&title="><br>并且序列化和反序列化有以下四个回调事件</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>调用关联的方法时</th>
<th>典型用法</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.runtime.serialization.ondeserializingattribute">OnDeserializingAttribute</a></td>
<td>反序列化之前</td>
<td>初始化可选字段的默认值。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.runtime.serialization.ondeserializedattribute">OnDeserializedAttribute</a></td>
<td>反序列化之后</td>
<td>根据其他字段的内容修改可选字段值。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.runtime.serialization.onserializingattribute">OnSerializingAttribute</a></td>
<td>序列化之前</td>
<td>准备序列化。 例如，创建可选数据结构。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/dotnet/api/system.runtime.serialization.onserializedattribute">OnSerializedAttribute</a></td>
<td>序列化之后</td>
<td>记录序列化事件。</td>
</tr>
</tbody></table>
<h2 id="04-1-代理器模式"><a href="#04-1-代理器模式" class="headerlink" title="04.1-代理器模式"></a>04.1-代理器模式</h2><p>和魔术方法一样，他们是以注解的形式写在方法上的。现在准备以下代码做测试</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"><span class="keyword">using</span> System.Security.Permissions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">NormalSerialize</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyObject</span> : <span class="title">ISerializable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> str &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyObject</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//实现了ISerializable接口的类必须包含有序列化构造函数，否则会出错。</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">MyObject</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;MyObject(SerializationInfo info, StreamingContext context)&quot;</span>);</span><br><span class="line">            str = info.GetString(<span class="string">&quot;str&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">SecurityPermission(SecurityAction.LinkDemand, Flags = SecurityPermissionFlag.SerializationFormatter)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GetObjectData</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;GetObjectData of MyObject.class&quot;</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;str&quot;</span>, str, <span class="keyword">typeof</span>(<span class="built_in">string</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">OnDeserializing</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">TestOnDeserializing</span>(<span class="params">StreamingContext sc</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;TestOnDeserializing&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="meta">OnDeserialized</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">TestOnDeserialized</span>(<span class="params">StreamingContext sc</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;TestOnDeserialized&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="meta">OnSerializing</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">TestOnSerializing</span>(<span class="params">StreamingContext sc</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;TestOnSerializing&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="meta">OnSerialized</span>]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">TestOnSerialized</span>(<span class="params">StreamingContext sc</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;TestOnSerialized&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">MySerializationSurrogate</span> : <span class="title">ISerializationSurrogate</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetObjectData</span>(<span class="params"><span class="built_in">object</span> obj, SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;GetObjectData of ISerializationSurrogate&quot;</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;str&quot;</span>, ((MyObject)obj).str);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">object</span> <span class="title">SetObjectData</span>(<span class="params"><span class="built_in">object</span> obj, SerializationInfo info, StreamingContext context, ISurrogateSelector selector</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;SetObjectData of ISerializationSurrogate&quot;</span>);</span><br><span class="line">            MyObject m = <span class="keyword">new</span> MyObject();</span><br><span class="line">            m.str = (<span class="built_in">string</span>)info.GetValue(<span class="string">&quot;str&quot;</span>, <span class="keyword">typeof</span>(<span class="built_in">string</span>));</span><br><span class="line">            <span class="keyword">return</span> m;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                MyObject myObject = <span class="keyword">new</span> MyObject();</span><br><span class="line">                myObject.str = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">using</span> (MemoryStream memoryStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 构建formatter</span></span><br><span class="line">                    BinaryFormatter binaryFormatter = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 设置序列化代理选择器</span></span><br><span class="line">                    SurrogateSelector ss = <span class="keyword">new</span> SurrogateSelector();</span><br><span class="line">                    ss.AddSurrogate(<span class="keyword">typeof</span>(MyObject), binaryFormatter.Context, <span class="keyword">new</span> MySerializationSurrogate());</span><br><span class="line">                    <span class="comment">// 赋值给formatter 这里是否设置代理选择器决定了序列化的生命周期</span></span><br><span class="line">                    binaryFormatter.SurrogateSelector = ss;</span><br><span class="line">                    <span class="comment">// 序列化</span></span><br><span class="line">                    binaryFormatter.Serialize(memoryStream, myObject);</span><br><span class="line">                    <span class="comment">// 重置stream</span></span><br><span class="line">                    memoryStream.Position = <span class="number">0</span>;</span><br><span class="line">                    myObject = <span class="literal">null</span>;</span><br><span class="line">                    <span class="comment">// 反序列化</span></span><br><span class="line">                    myObject = (MyObject)binaryFormatter.Deserialize(memoryStream);</span><br><span class="line">                    Console.WriteLine(myObject.str);    <span class="comment">// hello</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(e.StackTrace);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这里首先准备了一个MyObject类，实现了<code>ISerializable</code>接口，并且准备了一个代理器<code>MySerializationSurrogate</code>，并且在序列化的时候指定了代理器，因此我们的流程应该是</p>
<ul>
<li>OnDeserializing方法（序列化开始）</li>
<li>代理器的GetObjectData，获取属性</li>
<li>OnSerialized方法（序列化结束）</li>
<li>OnDeserializing（反序列化开始）</li>
<li>代理器的SetObjectData，设置属性</li>
<li>OnDeserialized（反序列化结束）</li>
</ul>
<h2 id="04-2-非代理器-amp-amp-ISerializable模式"><a href="#04-2-非代理器-amp-amp-ISerializable模式" class="headerlink" title="04.2-非代理器&amp;&amp;ISerializable模式"></a>04.2-非代理器&amp;&amp;ISerializable模式</h2><p>这一次我们删除代理器设置。将<code>binaryFormatter.SurrogateSelector = ss;</code>注释<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706859064464-b8699051-fafc-43e1-9fa1-7395c70c8468.png#averageHue=%2327272a&clientId=u24bb64fd-a864-4&from=paste&height=200&id=u16dc031e&originHeight=250&originWidth=1633&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=40920&status=done&style=none&taskId=ufc446096-7975-4d87-a03a-33ddc6f2fd7&title=&width=1306.4" alt="image.png"><br>结果如上，顺序变成了</p>
<ul>
<li>OnSerializing（序列化开始）</li>
<li>由于实现了ISerializable接口，因此会调用本身的GetObjectData方法</li>
<li>OnSerialized（序列化结束）</li>
<li>OnDeserializing（反序列化开始）</li>
<li>类的实例化。<code>protected MyObject(SerializationInfo info, StreamingContext context)</code>，在反序列化时由于实现了ISerializable接口，因此会调用构造方法，这个也是必须要加的，假如不加的话会报错</li>
<li>OnDeserialized（反序列化结束）</li>
</ul>
<h2 id="04-3-纯注解模式"><a href="#04-3-纯注解模式" class="headerlink" title="04.3-纯注解模式"></a>04.3-纯注解模式</h2><p>当我们不继承ISerializable接口后，我们会发现他的流程变得更加简单了。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706859271554-e502df69-41c6-40d4-860e-983328403d33.png#averageHue=%2327282b&clientId=u24bb64fd-a864-4&from=paste&height=162&id=u75cc66b8&originHeight=202&originWidth=690&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=20607&status=done&style=none&taskId=u12a6d3a3-57de-4146-ab0e-43cc8726664&title=&width=552" alt="image.png"><br>它不会调用GetObjectData也不会实例化对象。单纯只执行我们上面说的基本四个生命周期。</p>
<h2 id="04-4-SerializationInfo"><a href="#04-4-SerializationInfo" class="headerlink" title="04.4-SerializationInfo"></a>04.4-SerializationInfo</h2><p>在上述流程中我们经常会见到SerializationInfo这个类，那么这个类有什么用呢？<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706859444532-7ac6597c-b75e-4294-90a7-542850ed5830.png#averageHue=%23201f1f&clientId=u24bb64fd-a864-4&from=paste&height=427&id=u13e3e3d7&originHeight=534&originWidth=1221&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=69283&status=done&style=none&taskId=u2b311f5b-4297-46ba-b2fb-3a2615510e0&title=&width=976.8" alt="image.png"><br>首先它的成员变量就是我们序列化对象的成员属性、类型、数量和名称。其次他给定了我们获取和修改成员属性的方法。这一点在上述的GetObjectData也看到了。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706859530129-9dae7c28-929e-4dea-8a18-1759e4a26d78.png#averageHue=%23222221&clientId=u24bb64fd-a864-4&from=paste&height=387&id=ub6abd1a9&originHeight=484&originWidth=1084&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=60561&status=done&style=none&taskId=u81bf7f93-400d-4340-827c-1cf45f25371&title=&width=867.2" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706859542566-a0717a4a-bda2-4438-a946-6ac685c0e4f2.png#averageHue=%23222221&clientId=u24bb64fd-a864-4&from=paste&height=387&id=u5f50bdb0&originHeight=484&originWidth=1084&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=60561&status=done&style=none&taskId=uc0a10716-5573-4728-8872-7bc37c57a88&title=&width=867.2" alt="image.png"></p>
<h1 id="05-Dotnet的命令执行"><a href="#05-Dotnet的命令执行" class="headerlink" title="05-Dotnet的命令执行"></a>05-Dotnet的命令执行</h1><p>在ASP.NET CORE里，命令执行的方式比较严格。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DonNET_Deserialization</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> start = Process.Start(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c calc&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> process = <span class="keyword">new</span> Process();</span><br><span class="line">        process.StartInfo.FileName = <span class="string">&quot;cmd.exe&quot;</span>;</span><br><span class="line">        process.StartInfo.Arguments = <span class="string">&quot;/c calc&quot;</span>;</span><br><span class="line">        process.Start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在csharp中调用系统命令必须指定你的filename和argument，而不是单单输入一个calc那么简单。假如我们需要获取命令执行的回显可以这样</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DonNET_Deserialization</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> process = <span class="keyword">new</span> Process();</span><br><span class="line">        process.StartInfo.FileName = <span class="string">&quot;cmd.exe&quot;</span>;</span><br><span class="line">        process.StartInfo.Arguments = <span class="string">&quot;/c whoami&quot;</span>;</span><br><span class="line">        process.StartInfo.RedirectStandardOutput = <span class="literal">true</span>;</span><br><span class="line">        process.StartInfo.UseShellExecute = <span class="literal">false</span>;</span><br><span class="line">        process.Start();</span><br><span class="line">        <span class="keyword">var</span> processStandardOutput = process.StandardOutput.ReadToEnd();</span><br><span class="line">        Console.WriteLine(processStandardOutput);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706860241509-ba906e41-cb7a-473f-8b8b-18c9b425bf56.png#averageHue=%234365b6&clientId=u24bb64fd-a864-4&from=paste&height=180&id=u72792d6a&originHeight=225&originWidth=1319&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=26815&status=done&style=none&taskId=ub846a75e-1fcb-442a-9c1e-810f9498bde&title=&width=1055.2" alt="image.png"><br>其中RedirectStandardOutput和UseShellExecute需要注意一下</p>
<blockquote>
<ul>
<li>RedirectStandardOutput：<ul>
<li>当设置为 true 时，表示重定向标准输出流，即将进程的标准输出流（通常是在控制台窗口中显示的信息）连接到 Process.StandardOutput 流中，以便你的程序可以读取进程的输出。</li>
</ul>
</li>
<li>UseShellExecute：<ul>
<li>当设置为 false 时，表示不使用操作系统的 shell 启动进程。相反，它允许你直接启动可执行文件，命令行等，而不需要借助 shell。</li>
</ul>
</li>
</ul>
</blockquote>
<h1 id="06-ObjectDataProvider"><a href="#06-ObjectDataProvider" class="headerlink" title="06-ObjectDataProvider"></a>06-ObjectDataProvider</h1><p>先介绍一下这个类，他是我们gadgets其中的一环，我们需要了解一下他为什么可以命令执行。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DonNET_Deserialization</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> objectDataProvider = <span class="keyword">new</span> ObjectDataProvider();</span><br><span class="line">        objectDataProvider.MethodName = <span class="string">&quot;Start&quot;</span>;</span><br><span class="line">        objectDataProvider.MethodParameters.Add(<span class="string">&quot;cmd.exe&quot;</span>);</span><br><span class="line">        objectDataProvider.MethodParameters.Add(<span class="string">&quot;/c calc&quot;</span>);</span><br><span class="line">        objectDataProvider.ObjectInstance = <span class="keyword">new</span> Process();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706860821769-a3da5948-3e88-4b6f-ae59-49819d55bf02.png#averageHue=%23656464&clientId=u24bb64fd-a864-4&from=paste&height=634&id=u47f0b2d7&originHeight=792&originWidth=1467&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=127158&status=done&style=none&taskId=uf5d03aaa-09b0-4c43-8aac-c44ee79981e&title=&width=1173.6" alt="image.png"><br>运行上述实例后就是可以命令执行。流程如下。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">object</span> ObjectInstance</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">get</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>._instanceProvider == <span class="literal">null</span> ? <span class="keyword">this</span>._objectInstance : (<span class="built_in">object</span>) <span class="keyword">this</span>._instanceProvider;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">set</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>._mode == ObjectDataProvider.SourceMode.FromType)</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(System.Windows.SR.Get(<span class="string">&quot;ObjectDataProviderCanHaveOnlyOneSource&quot;</span>));</span><br><span class="line">        <span class="keyword">this</span>._mode = <span class="keyword">value</span> == <span class="literal">null</span> ? ObjectDataProvider.SourceMode.NoSource : ObjectDataProvider.SourceMode.FromInstance;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.ObjectInstance == <span class="keyword">value</span>)</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">value</span> != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">this</span>._constructorParameters.SetReadOnly(<span class="literal">true</span>);</span><br><span class="line">          <span class="keyword">this</span>._constructorParameters.ClearInternal();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="keyword">this</span>._constructorParameters.SetReadOnly(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">value</span> = <span class="keyword">this</span>.TryInstanceProvider(<span class="keyword">value</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.SetObjectInstance(<span class="keyword">value</span>) || <span class="keyword">this</span>.IsRefreshDeferred)</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.Refresh();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在Objectdataprovideer的属性ObjectInstance的Setter方法存在一个Refresh刷新<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706860917913-f8a2d766-71f0-4ee9-a564-9a413be0789a.png#averageHue=%23272625&clientId=u24bb64fd-a864-4&from=paste&height=542&id=u5e9f49af&originHeight=678&originWidth=1546&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=159384&status=done&style=none&taskId=u368de91c-aaed-4089-a87a-cd7327a2bd0&title=&width=1236.8" alt="image.png"><br>然后会调用Queryworkr方法<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706860949582-34709fa1-3d43-496c-8884-ac390ad4dc9f.png#averageHue=%23272625&clientId=u24bb64fd-a864-4&from=paste&height=542&id=u24893a98&originHeight=678&originWidth=1546&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=159384&status=done&style=none&taskId=u098f7346-389e-41ab-9f65-5fbcb77179e&title=&width=1236.8" alt="image.png"><br>然后会调用InvokeMethodOnInstance方法<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706860995115-84538f1a-b483-4e33-b1e1-d33dfbc27548.png#averageHue=%2322211f&clientId=u24bb64fd-a864-4&from=paste&height=258&id=u0f4c1c15&originHeight=322&originWidth=1472&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=68672&status=done&style=none&taskId=u88b916d7-64e7-4094-81d7-c05e406ce3f&title=&width=1177.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706861021543-72900696-9fcc-4f1e-94e3-5a3ac50bb1ec.png#averageHue=%23282624&clientId=u24bb64fd-a864-4&from=paste&height=558&id=u9cbe8e46&originHeight=698&originWidth=1550&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=178933&status=done&style=none&taskId=uc47c2c39-3be3-453d-a096-b8f80bdca88&title=&width=1240" alt="image.png"><br>最后执行了命令。也就是核心是该类的setter方法。</p>
<h1 id="07-小结"><a href="#07-小结" class="headerlink" title="07-小结"></a>07-小结</h1><p><img src="https://cdn.nlark.com/yuque/0/2024/jpeg/32634994/1706861254644-53223bdd-d9bc-4673-80cf-a726c012bf33.jpeg#averageHue=%23a3a3a3&clientId=u24bb64fd-a864-4&from=paste&height=332&id=uf669a064&originHeight=640&originWidth=640&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=59539&status=done&style=none&taskId=u8053dc5c-d933-4e2b-b8b0-bd3a81f9730&title=&width=332" alt="fe7659a5153950a5dcc050d2b80892d3.jpg"></p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/反序列化/" class="tag">#反序列化</a><a href="/tags/NET/" class="tag">#.NET</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2024/02/05/2024%20N1CTF%20Junior%20Web%20Writeup/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">2024 N1CTF Junior Web Writeup</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2024/01/29/RealWorld%20CTF%206th%20%E6%AD%A3%E8%B5%9B_%E4%BD%93%E9%AA%8C%E8%B5%9B%20%E9%83%A8%E5%88%86%20Web%20Writeup/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">RealWorld CTF 6th 正赛/体验赛 部分 Web Writeup</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>